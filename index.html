<!-- =========================
  ONE ãƒ¬ã‚¸ã‚¢ãƒ—ãƒªï¼ˆç„¡æ–™ç‰ˆï¼‰å®Œå…¨ãƒ•ãƒ«ï¼šPART1ï¼ˆå·®ã—æ›¿ãˆç‰ˆï¼‰
  å½¹å‰²ï¼šHTMLéª¨æ ¼ / CSS / å…±é€šå®šç¾© / å…±é€šUI / ãƒ¡ã‚¤ãƒ³ç”»é¢UI / æœ€ä½é™JS
  ä¿å­˜KEYï¼šONE_FREE_FULL_V1
  åæ˜ ï¼šä¸Šéƒ¨ãƒãƒ¼ï¼ˆONEï½œã‚¢ãƒ³ãƒ†ãƒŠï½œã‚­ãƒƒãƒãƒ³/ãƒ›ãƒ¼ãƒ«ï½œä¿å­˜ï¼‰/ æ·±ç·‘ / é»„ç·‘ãƒœã‚¿ãƒ³
        ã‚¢ãƒ³ãƒ†ãƒŠæ ãªã—ï¼†å¤§ãã‚ / ãƒ’ãƒ³ãƒˆæ–‡å­—ã®ã¿ç™½ / åŒæœŸãƒ”ãƒ«éè¡¨ç¤º
        ä¸‹æ®µã¯ãƒ¡ã‚¤ãƒ³ã®ã¿ãƒ»1åˆ—ï¼ˆå¸­ç§»å‹•ï½œæœ¬æ—¥ã®å£²ä¸Šï½œè¨­å®šï¼‰/ åˆç®—åˆ†å‰²æ±ºå®šã¯å»ƒæ­¢
        å¸­ã‚«ãƒ¼ãƒ‰çŠ¶æ…‹åˆ¥è‰²ï¼ˆç©ºå¸­è–„ã‚ãƒ»äºˆç´„æ˜ã‚‹ã„ç´ºãƒ»æ¥åº—ã¯ç¾çŠ¶è‰²ï¼‰
========================= -->
<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <!-- ãƒ€ãƒ–ãƒ«ã‚¿ãƒƒãƒ—æ‹¡å¤§ã‚’æ®ºã•ãªã„ãŸã‚ user-scalable ã¯ç¦æ­¢ã—ãªã„ -->
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>ONE FREE</title>

  <style>
    :root{
      --bg:#0b0f14;
      --panel:#121a23;     /* æ¥åº—ä¸­ã‚«ãƒ¼ãƒ‰ã®â€œä»Šã®è‰²â€ã¨ã—ã¦ç¶­æŒ */
      --panel2:#0f1620;
      --text:#e9f1ff;
      --muted:#9fb0c7;
      --line:#233244;

      /* NEW THEME */
      --headerBg:#0b2a1b;  /* æ·±ã„ç·‘ï¼ˆä¸Šéƒ¨ãƒãƒ¼ï¼‰ */
      --lime:#7edc62;      /* é»„ç·‘ï¼ˆã‚­ãƒƒãƒãƒ³/ä¿å­˜ï¼‰ */
      --limeText:#ffffff;

      --danger:#ff6b6b;
      --ok:#3ddc97;

      --headerH:56px;
      --bottomH:64px;      /* ä¸‹æ®µ1åˆ—ã«çµ±ä¸€ */
      --radius:14px;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family:-apple-system,BlinkMacSystemFont,"Hiragino Sans","Noto Sans JP",system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      background:var(--bg);
      color:var(--text);
      overflow-x:hidden; /* æ¨ªã‚¹ãƒ¯ã‚¤ãƒ—ã§ç”»é¢ãŒå‹•ãã®ã‚’å°é– */
      -webkit-font-smoothing:antialiased;
      text-rendering:optimizeLegibility;
      touch-action:pan-y; /* æ¨ªæ–¹å‘ã‚’æŠ‘ãˆã‚‹ */
    }

    /* ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤ºä¸­ï¼šèƒŒæ™¯å›ºå®š */
    body.modalLock{
      position:fixed;
      width:100%;
      overflow:hidden;
    }

    .app{
      min-height:100%;
      padding-top:calc(var(--headerH) + env(safe-area-inset-top));
      padding-bottom:calc(var(--bottomH) + env(safe-area-inset-bottom));
    }

    /* ===== Header ===== */
    .topbar{
      position:fixed;
      left:0; right:0; top:0;
      padding-top:env(safe-area-inset-top);
      height:calc(var(--headerH) + env(safe-area-inset-top));
      background:var(--headerBg);
      border-bottom:1px solid rgba(255,255,255,0.08);
      z-index:50;
      display:flex;
      align-items:flex-end;
    }
    .topbarInner{
      height:var(--headerH);
      width:100%;
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:0 12px 6px; /* ä¸‹ä½™ç™½ã‚’å°‘ã—è©°ã‚ã‚‹ */
      gap:10px;
    }

    .leftGroup{
      display:flex;
      align-items:center;
      gap:10px;
      min-width:0;
    }
    .brand{
      font-weight:800;
      letter-spacing:0.5px;
      font-size:18px;
      white-space:nowrap;
    }

    /* ã‚¢ãƒ³ãƒ†ãƒŠï¼ˆæ ãªã—ãƒ»å°‘ã—å¤§ãã‚ãƒ»âŒé‡ã­ï¼‰ */
    .antennaWrap{
      position:relative;
      width:40px;
      height:40px;
      display:flex;
      align-items:center;
      justify-content:center;
      border:none;
      background:transparent;
      border-radius:12px;
      touch-action:manipulation;
    }
    .antennaIcon{
      font-size:22px; /* ä¸€å›ã‚Šå¤§ãã */
      line-height:1;
    }
    .antennaX{
      position:absolute;
      top:6px;
      right:6px;
      font-size:14px;
      line-height:1;
      color:var(--danger);
      display:none;
      font-weight:900;
      text-shadow:0 1px 0 rgba(0,0,0,0.35);
    }
    .antennaWrap.off .antennaX{ display:block; }

    .centerGroup{
      flex:1;
      display:flex;
      justify-content:center; /* ã‚­ãƒƒãƒãƒ³/ãƒ›ãƒ¼ãƒ«ã‚’ä¸­å¤®ã¸ */
      min-width:0;
    }
    .rightGroup{
      display:flex;
      justify-content:flex-end;
      min-width:0;
    }

    .btn{
      border:1px solid rgba(255,255,255,0.14);
      background:rgba(0,0,0,0.18);
      color:var(--text);
      border-radius:12px;
      padding:10px 12px;
      font-size:14px;
      line-height:1;
      min-height:40px;
      user-select:none;
      -webkit-user-select:none;
      touch-action:manipulation;
    }

    /* ã‚­ãƒƒãƒãƒ³/ä¿å­˜ï¼šé»„ç·‘ã§å¡—ã‚Šæ½°ã— */
    .btn.lime{
      background:var(--lime);
      border-color:rgba(0,0,0,0.15);
      color:var(--limeText);
      font-weight:900;
    }

    /* ===== Screens ===== */
    .screen{
      display:none;
      padding:12px;
      max-width:900px;
      margin:0 auto;
    }
    .screen.active{ display:block; }

    /* ===== Main (Hint) ===== */
    .hintText{
      color:#ffffff;       /* æ–‡å­—ã®ã¿ç™½ */
      font-size:14px;
      font-weight:700;
      opacity:0.92;
      padding:2px 2px;
    }

    /* ===== Main (Seat Grid) ===== */
    .seatGrid{
      display:grid;
      grid-template-columns:repeat(3, minmax(0, 1fr));
      gap:10px;
    }
    .seatCard{
      border:1px solid rgba(255,255,255,0.10);
      background:var(--panel); /* æ¥åº—ä¸­ï¼ˆä»Šã®è‰²ï¼‰ */
      border-radius:var(--radius);
      padding:10px;
      min-height:100px;
      display:flex;
      flex-direction:column;
      justify-content:space-between;
      gap:6px;
      touch-action:manipulation;
    }
    .seatNo{
      font-size:22px;
      font-weight:900;
      letter-spacing:0.5px;
    }
    .seatMeta{
      color:rgba(255,255,255,0.86);
      font-size:12px;
      display:flex;
      flex-direction:column;
      gap:2px;
    }
    .seatMoney{
      font-size:16px;
      font-weight:800;
      margin-top:4px;
    }

    /* çŠ¶æ…‹åˆ¥è‰²ï¼ˆç™½æ–‡å­—ãŒèª­ã‚ã‚‹æ¿ƒã•ï¼‰ */
    .seatCard.empty{
      background:rgba(255,255,255,0.06); /* ç©ºå¸­ï¼šä»Šã‚ˆã‚Šè–„ã„è‰² */
      color:#fff;
    }
    .seatCard.reserve{
      background:#1b3f86; /* äºˆç´„ï¼šæ˜ã‚‹ã„ç´º */
      color:#fff;
    }
    .seatCard.in{
      background:var(--panel); /* æ¥åº—ï¼šç¾çŠ¶è‰² */
      color:#fff;
    }

    /* ===== Bottom Bar (Main only) ===== */
    .bottomBar{
      position:fixed;
      left:0; right:0;
      bottom:0;
      padding-bottom:env(safe-area-inset-bottom);
      height:calc(var(--bottomH) + env(safe-area-inset-bottom));
      background:rgba(18,26,35,0.95);
      border-top:1px solid rgba(255,255,255,0.10);
      z-index:45;
      display:flex;
      align-items:center;
    }
    .bottomBarInner{
      width:100%;
      max-width:900px;
      margin:0 auto;
      padding:0 12px;
      display:grid;
      grid-template-columns:1fr 1fr 1fr;
      gap:10px;
      align-items:center;
      height:var(--bottomH);
    }
    .bottomBtn{
      border-radius:14px;
      min-height:46px;
      padding:12px 10px;
      font-weight:900;
      font-size:14px;
      border:1px solid rgba(255,255,255,0.14);
      background:rgba(0,0,0,0.18);
      color:var(--text);
      touch-action:manipulation;
    }
    .bottomBtn.move{
      /* å¸­ç§»å‹•ï¼šå°‘ã—ã ã‘ç›®ç«‹ãŸã›ã‚‹ï¼ˆè–„ã‚é»„ç·‘ï¼‰ */
      background:rgba(126,220,98,0.18);
      border-color:rgba(126,220,98,0.55);
    }

    /* ===== Modal ===== */
    .backdrop{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,0.55);
      z-index:80;
      display:none;
      align-items:center;          /* ä¸­å¤®è¡¨ç¤º */
      justify-content:center;      /* ä¸­å¤®è¡¨ç¤º */
      padding:12px;
      padding-bottom:calc(12px + env(safe-area-inset-bottom));
    }
    .backdrop.show{ display:flex; }

    .modal{
      width:min(560px, 100%);
      background:var(--panel);
      border:1px solid rgba(255,255,255,0.12);
      border-radius:18px;
      overflow:hidden;
    }
    .modalHead{
      padding:14px 14px 10px;
      border-bottom:1px solid rgba(255,255,255,0.10);
      font-weight:900;
      display:flex;
      align-items:center;
      gap:10px;
    }
    .modalHead .modalSeat{
      font-size:16px;
      font-weight:900;
    }
    .modalHead .modalSeatNo{
      font-size:16px;
      font-weight:900;
      opacity:0.95;
    }

    .modalBody{
      padding:14px;
      color:var(--text);
      font-size:14px;
      line-height:1.6;
    }
    .modalActions{
      padding:12px 14px 14px;
      display:flex;
      flex-direction:column; /* æŠ¼ã—ã‚„ã™ã */
      gap:12px;
      justify-content:flex-end;
    }
    .modalActions .btn{
      width:100%;
      min-height:48px;
      font-size:16px;
      font-weight:900;
    }

    /* ===== Toast ===== */
    .toast{
      position:fixed;
      left:50%;
      transform:translateX(-50%);
      bottom:calc(var(--bottomH) + 18px + env(safe-area-inset-bottom));
      background:rgba(0,0,0,0.78);
      border:1px solid rgba(255,255,255,0.12);
      color:#fff;
      padding:10px 12px;
      border-radius:999px;
      font-size:13px;
      z-index:90;
      display:none;
      max-width:min(90vw, 720px);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .toast.show{ display:block; }

    /* iPhone SEãªã©å°ã•ã„ç”»é¢èª¿æ•´ */
    @media (max-width: 360px){
      .seatNo{ font-size:20px; }
      .btn{ padding:9px 10px; }
      .antennaIcon{ font-size:21px; }
      .bottomBtn{ font-size:13px; }
    }
  </style>
</head>

<body>
  <!-- ===== Fixed Header ===== -->
  <header class="topbar" id="topbar">
    <div class="topbarInner">
      <!-- å·¦ï¼šONEï¼‹ã‚¢ãƒ³ãƒ†ãƒŠ -->
      <div class="leftGroup">
        <div class="brand">ONE</div>
        <button class="antennaWrap" id="btnAntenna" aria-label="åŒæœŸçŠ¶æ…‹">
          <span class="antennaIcon">ğŸ“¶</span>
          <span class="antennaX">âŒ</span>
        </button>
      </div>

      <!-- ä¸­å¤®ï¼šã‚­ãƒƒãƒãƒ³/ãƒ›ãƒ¼ãƒ«/ãƒ¡ã‚¤ãƒ³ï¼ˆç¬¬2ãƒœã‚¿ãƒ³ï¼‰ -->
      <div class="centerGroup">
        <button class="btn lime" id="navSecond">ã‚­ãƒƒãƒãƒ³</button>
      </div>

      <!-- å³ï¼šä¿å­˜ -->
      <div class="rightGroup">
        <button class="btn lime" id="btnSave">ä¿å­˜</button>
      </div>
    </div>
  </header>

  <!-- ===== App Screens ===== -->
  <main class="app">
    <!-- PART1ï¼šãƒ¡ã‚¤ãƒ³ -->
    <section class="screen active" id="scrMain">
      <div class="hintText" id="mainHint">ç©ºå¸­ã‚’ã‚¿ãƒƒãƒ—ã§ æ¥åº— / äºˆç´„ ã‚’åˆ‡æ›¿</div>
      <div style="height:10px"></div>

      <div class="seatGrid" id="seatGrid"></div>
    </section>

    <!-- ä»¥é™ã®ç”»é¢ã¯ PART3ã€œPART8 ã§ä¸­èº«ã‚’å®Ÿè£… -->
    <section class="screen" id="scrKitchen"><div class="hintText">ã‚­ãƒƒãƒãƒ³ï¼ˆPART3ã§å®Ÿè£…ï¼‰</div></section>
    <section class="screen" id="scrSales"><div class="hintText">å£²ä¸Šï¼ˆPART4ã§å®Ÿè£…ï¼‰</div></section>
    <section class="screen" id="scrFix"><div class="hintText">è¨‚æ­£ä¼ç¥¨ï¼ˆPART5ã§å®Ÿè£…ï¼‰</div></section>
    <section class="screen" id="scrSeatSetup"><div class="hintText">å¸­ç™»éŒ²ï¼ˆPART6ã§å®Ÿè£…ï¼‰</div></section>
    <section class="screen" id="scrSettings"><div class="hintText">è¨­å®šãƒ»ãƒ˜ãƒ«ãƒ—ï¼ˆPART8ã§å®Ÿè£…ï¼‰</div></section>
    <section class="screen" id="scrMenuSetup"><div class="hintText">ãƒ¡ãƒ‹ãƒ¥ãƒ¼ç™»éŒ²ï¼ˆPART8-Aã§å®Ÿè£…ï¼‰</div></section>
  </main>

  <!-- ===== Bottom Bar (Main only) ===== -->
  <div class="bottomBar" id="bottomBar">
    <div class="bottomBarInner">
      <button class="bottomBtn move" id="modeMove">å¸­ç§»å‹•</button>
      <button class="bottomBtn" id="goTodaySales">æœ¬æ—¥ã®å£²ä¸Š</button>
      <button class="bottomBtn" id="goSettings">è¨­å®š</button>
    </div>
  </div>

  <!-- ===== Modals ===== -->
  <div class="backdrop" id="modalBackdrop" role="dialog" aria-modal="true">
    <div class="modal">
      <div class="modalHead" id="modalTitle"></div>
      <div class="modalBody" id="modalBody"></div>
      <div class="modalActions" id="modalActions"></div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    /* =========================
      Common / State (PART1)
    ========================= */

    const KEY = "ONE_FREE_FULL_V1";
    const $ = (id)=> document.getElementById(id);

    function nowTs(){ return Date.now(); }

    function yen(n){
      const x = Number(n||0);
      return "Â¥" + x.toLocaleString("ja-JP");
    }

    function toast(msg, ms=1800){
      const t = $("toast");
      t.textContent = msg;
      t.classList.add("show");
      clearTimeout(toast._tm);
      toast._tm = setTimeout(()=> t.classList.remove("show"), ms);
    }

    // ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆèƒŒæ™¯å›ºå®šï¼‰
    function lockBody(){
      const y = window.scrollY;
      document.body.dataset.scrollY = String(y);
      document.body.classList.add("modalLock");
      document.body.style.top = `-${y}px`;
    }
    function unlockBody(){
      const y = Number(document.body.dataset.scrollY || "0");
      document.body.classList.remove("modalLock");
      document.body.style.top = "";
      window.scrollTo(0, y);
    }

    function openModal(titleHtml, bodyHtml, actions){
      $("modalTitle").innerHTML = titleHtml || "";
      $("modalBody").innerHTML = bodyHtml || "";
      const box = $("modalActions");
      box.innerHTML = "";
      (actions||[]).forEach(a=>{
        const b = document.createElement("button");
        b.className = "btn" + (a.primary ? " lime" : "");
        b.textContent = a.label;
        b.onclick = ()=> a.onClick && a.onClick();
        box.appendChild(b);
      });
      $("modalBackdrop").classList.add("show");
      lockBody();
    }
    function closeModal(){
      $("modalBackdrop").classList.remove("show");
      unlockBody();
    }

    $("modalBackdrop").addEventListener("click", (e)=>{
      if(e.target === $("modalBackdrop")) closeModal();
    });

    // ç”»é¢é·ç§»ï¼ˆPART1ã¯æœ€ä½é™ï¼‰
    const screens = ["scrMain","scrKitchen","scrSales","scrFix","scrSeatSetup","scrSettings","scrMenuSetup"];
    function showScreen(id){
      screens.forEach(s=> $(s).classList.toggle("active", s===id));

      // ç¬¬2ãƒœã‚¿ãƒ³æ–‡è¨€ï¼ˆæœ€æ–°ãƒ«ãƒ¼ãƒ«ï¼‰
      if(id==="scrMain"){
        $("navSecond").textContent = "ã‚­ãƒƒãƒãƒ³";
      }else if(id==="scrKitchen"){
        $("navSecond").textContent = "ãƒ›ãƒ¼ãƒ«";
      }else{
        $("navSecond").textContent = "ãƒ¡ã‚¤ãƒ³";
      }

      // ä¸‹æ®µã¯ãƒ¡ã‚¤ãƒ³ã®ã¿è¡¨ç¤º
      const onMain = (id==="scrMain");
      $("bottomBar").style.display = onMain ? "flex" : "none";
    }

    // åŒæœŸè¡¨ç¤ºï¼ˆPART7ã§æœ¬å®Ÿè£…ï¼‰
    const state = {
      syncOk: true,
      seats: [],
      mode: null, // "move" | null
    };

    function setSync(ok){
      state.syncOk = !!ok;
      $("btnAntenna").classList.toggle("off", !ok);
    }

    // ãƒ€ãƒŸãƒ¼å¸­ï¼ˆPART6å®Ÿè£…ã§ç½®æ›ï¼‰
    function seedSeatsIfEmpty(){
      if(state.seats.length) return;
      state.seats = [
        {id:"A", name:"", status:"empty", people:0, total:0, bills:0},
        {id:"B", name:"", status:"empty", people:0, total:0, bills:0},
        {id:"C", name:"", status:"empty", people:0, total:0, bills:0},
        {id:"D", name:"ç”°ä¸­", status:"in", people:2, total:4800, bills:1},
        {id:"E", name:"", status:"empty", people:0, total:0, bills:0},
        {id:"F", name:"ä½è—¤", status:"reserve", people:3, total:0, bills:0},
      ];
    }

    function renderSeats(){
      const grid = $("seatGrid");
      grid.innerHTML = "";
      state.seats.forEach(seat=>{
        const card = document.createElement("div");
        card.className = "seatCard " + (seat.status==="empty" ? "empty" : seat.status==="reserve" ? "reserve" : "in");
        card.dataset.seatId = seat.id;

        const top = document.createElement("div");
        const no = document.createElement("div");
        no.className = "seatNo";
        no.textContent = seat.id;

        const meta = document.createElement("div");
        meta.className = "seatMeta";

        if(seat.status==="reserve"){
          meta.innerHTML = `<div>äºˆç´„</div><div>${seat.people||0}å</div>`;
        }else if(seat.status==="in"){
          const bills = seat.bills && seat.bills>1 ? `åˆ¥ä¼šè¨ˆ${seat.bills}ä»¶` : "";
          meta.innerHTML = `<div>${seat.name||""}</div><div>${seat.people||0}å ${bills}</div>`;
        }else{
          meta.innerHTML = `<div>ç©ºå¸­</div>`;
        }

        top.appendChild(no);
        top.appendChild(meta);

        const money = document.createElement("div");
        money.className = "seatMoney";
        money.textContent = seat.status==="in" ? yen(seat.total) : "";

        card.appendChild(top);
        card.appendChild(money);

        card.onclick = ()=> onSeatTap(seat.id);
        grid.appendChild(card);
      });
    }

    // ç©ºå¸­ã‚¿ãƒƒãƒ—ï¼ˆè¦‹ãŸç›®ã ã‘æ•´å‚™ï¼šã‚¿ã‚¤ãƒˆãƒ«ã«ç©ºå¸­ï½œå¸­ç•ªå·ã€æ–‡è¨€å‰Šé™¤ã€ãƒœã‚¿ãƒ³æŠ¼ã—ã‚„ã™ãï¼‰
    function onSeatTap(seatId){
      const seat = state.seats.find(s=> s.id===seatId);
      if(!seat) return;

      if(state.mode){
        toast("å¸­ç§»å‹•ï¼ˆPART2ã§æœ¬å®Ÿè£…ï¼‰");
        return;
      }

      if(seat.status==="empty"){
        openModal(
          `<span class="modalSeat">ç©ºå¸­</span>ï½œ<span class="modalSeatNo">${seatId}</span>`,
          ``,
          [
            {label:"æ¥åº—", primary:true, onClick:()=>{ closeModal(); /* æ¥åº—å‹•ç·šã¯å¾Œã§ä¿®æ­£ */ seat.status="in"; seat.people=1; seat.name=""; seat.total=0; seat.bills=1; renderSeats(); }},
            {label:"äºˆç´„", onClick:()=>{ closeModal(); /* äºˆç´„å‹•ç·šã¯å¾Œã§ä¿®æ­£ */ seat.status="reserve"; seat.people=1; renderSeats(); }},
            {label:"æˆ»ã‚‹", onClick:()=> closeModal()},
          ]
        );
      }else if(seat.status==="reserve"){
        toast(`å¸­ ${seatId}ï¼ˆäºˆç´„ï¼‰`);
      }else{
        toast(`å¸­ ${seatId}ï¼ˆä½¿ç”¨ä¸­ï¼‰`);
      }
    }

    // ä¸‹æ®µï¼šå¸­ç§»å‹•ã®ã¿ï¼ˆè©³ç´°ã¯PART2ã§ï¼‰
    function setMode(m){
      state.mode = m;
      $("modeMove").classList.toggle("on", m==="move");
    }
    $("modeMove").onclick = ()=> setMode(state.mode==="move" ? null : "move");

    // ãƒ˜ãƒƒãƒ€ãƒ¼ç¬¬2ãƒœã‚¿ãƒ³ï¼ˆãƒ¡ã‚¤ãƒ³<->ã‚­ãƒƒãƒãƒ³/ãã®ä»–ã¯ãƒ¡ã‚¤ãƒ³ã¸ï¼‰
    $("navSecond").onclick = ()=>{
      const current = screens.find(s=> $(s).classList.contains("active")) || "scrMain";
      if(current==="scrMain"){
        showScreen("scrKitchen");
      }else if(current==="scrKitchen"){
        showScreen("scrMain");
      }else{
        showScreen("scrMain");
      }
    };

    // æœ¬æ—¥ã®å£²ä¸Š / è¨­å®šï¼ˆé·ç§»ã®ã¿ã€‚ä¸­èº«ã¯å¾Œã§å®Ÿè£…ï¼‰
    $("goTodaySales").onclick = ()=> showScreen("scrSales");
    $("goSettings").onclick = ()=> showScreen("scrSettings");

    // ã‚¢ãƒ³ãƒ†ãƒŠï¼ˆPART7ã§æœ¬å®Ÿè£…ã€‚ã“ã“ã¯UIã ã‘ï¼‰
    $("btnAntenna").onclick = ()=>{
      if(state.syncOk){
        openModal("åŒæœŸ", "åŒæœŸã•ã‚Œã¦ã„ã¾ã™", [
          {label:"æˆ»ã‚‹", onClick:()=> closeModal()}
        ]);
      }else{
        openModal("åŒæœŸ", "åŒæœŸã•ã‚Œã¦ã„ã¾ã›ã‚“<br>é›»æ³¢çŠ¶æ³ã‚„ä¸€æ™‚çš„ãªä¸å…·åˆã®å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™<br>ä¿å­˜ã‚’è¡Œã†ã¨å†åŒæœŸã‚’è©¦ã¿ã¾ã™", [
          {label:"åŒæœŸé–‹å§‹", primary:true, onClick:()=>{ closeModal(); toast("åŒæœŸé–‹å§‹ï¼ˆPART7ã§å®Ÿè£…ï¼‰"); }},
          {label:"æˆ»ã‚‹", onClick:()=> closeModal()},
        ]);
      }
    };

    // ä¿å­˜ï¼ˆPART7ã§æœ¬å®Ÿè£…ã€‚ã“ã“ã¯UIã ã‘ï¼‰
    $("btnSave").onclick = ()=>{
      openModal(
        "ä¿å­˜",
        "æ³¨æ–‡ãƒ»ä¼šè¨ˆãƒ»å¸­æƒ…å ±ã¯ç«¯æœ«é–“ã§è‡ªå‹•åŒæœŸã•ã‚Œã¾ã™ï¼ˆé›»æ³¢çŠ¶æ³ãŒè‰¯å¥½ãªå ´åˆï¼‰<br><br>å–¶æ¥­çµ‚äº†æ™‚ãƒ»é€€å‹¤æ™‚ã«ã¯å¿…ãšä¿å­˜ã‚’è¡Œã£ã¦ãã ã•ã„",
        [
          {label:"ç¢ºå®šä¿å­˜", primary:true, onClick:()=>{ closeModal(); toast("ä¿å­˜ï¼ˆPART7ã§å®Ÿè£…ï¼‰"); }},
          {label:"æˆ»ã‚‹", onClick:()=> closeModal()},
        ]
      );
    };

    // èµ·å‹•
    (function init(){
      seedSeatsIfEmpty();
      setSync(true);
      renderSeats();
      showScreen("scrMain");
    })();

    /* =========================
      ã“ã“ã‹ã‚‰å…ˆã¯ PART2 ã§ç¶šã
    ========================= */
/* =========================
  PART2ï¼šå¸­æ“ä½œï¼ˆå¸­ç§»å‹•ã®ã¿ï½œæœ€æ–°ç¢ºå®šï¼‰
  å½¹å‰²ï¼šå¸­ç§»å‹•UIï¼ˆå…¥åŠ›ï¼‰/ äº¤æ›ç§»å‹• / åˆæµ / ã‚¹ãƒ©ã‚¤ãƒ‰ç¢ºå®š
  æ–¹é‡ï¼šäººãŒå…¥åŠ›â†’ç¢ºèªâ†’ã‚¹ãƒ©ã‚¤ãƒ‰ã§ç¢ºå®šï¼ˆå‹æ‰‹ã«å‹•ã‹ãªã„ï¼‰
========================= */

/* ===== PART2: CSS injectï¼ˆã‚¹ãƒ©ã‚¤ãƒ‰ç¢ºå®šUIãªã©ï¼‰ ===== */
(function injectPart2Css(){
  const css = `
    .moveBox{ display:flex; flex-direction:column; gap:10px; }
    .moveRow{ display:flex; gap:10px; align-items:center; justify-content:center; }
    .moveInput{
      width:110px;
      padding:12px 12px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,0.14);
      background:rgba(0,0,0,0.18);
      color:var(--text);
      font-size:16px;
      font-weight:900;
      text-align:center;
      outline:none;
    }
    .moveArrow{ font-weight:900; opacity:0.9; }

    .moveBtnRow{ display:flex; gap:10px; }
    .moveBtnRow .btn{ flex:1; min-height:48px; font-size:16px; font-weight:900; }

    .slideBox{
      border:1px solid rgba(255,255,255,0.14);
      border-radius:14px;
      padding:12px;
      background:rgba(255,255,255,0.04);
    }
    .slideLabel{ font-size:13px; color:rgba(255,255,255,0.85); margin-bottom:8px; }
    .slideRange{
      width:100%;
      height:42px;
      -webkit-appearance:none;
      appearance:none;
      border-radius:999px;
      background:rgba(0,0,0,0.18);
      border:1px solid rgba(255,255,255,0.14);
      outline:none;
    }
    .slideRange::-webkit-slider-thumb{
      -webkit-appearance:none;
      appearance:none;
      width:52px;
      height:36px;
      border-radius:14px;
      background:rgba(126,220,98,0.95);
      border:1px solid rgba(0,0,0,0.15);
    }
    .miniNote{ font-size:12px; color:rgba(255,255,255,0.75); line-height:1.5; }
  `;
  const st = document.createElement("style");
  st.textContent = css;
  document.head.appendChild(st);
})();

/* ===== Helpers ===== */
function seatById(id){
  return state.seats.find(s=> String(s.id)===String(id));
}
function seatIds(){
  return state.seats.map(s=> String(s.id));
}
function normalizeSeatId(x){
  return String(x||"").trim();
}
function isValidSeatId(x){
  const id = normalizeSeatId(x);
  if(!id) return false;
  return seatIds().includes(id);
}
function clone(obj){
  return JSON.parse(JSON.stringify(obj));
}

/* ===== åˆæµè¡¨ç¤ºï¼ˆãƒ‡ãƒ¼ã‚¿ã¯è¶³ã•ãªã„ï¼‰ =====
  - Bã«ã€ŒmergedFromã€é…åˆ—ã‚’æŒãŸã›ã‚‹ï¼ˆè¡¨ç¤ºã¯PART1å´ã§å¾Œã§åæ˜ ï¼‰
  - Aã‚’ç©ºå¸­ã«ã™ã‚‹
*/
function markMerged(toSeat, fromSeatId){
  if(!toSeat.mergedFrom) toSeat.mergedFrom = [];
  // é‡è¤‡é˜²æ­¢
  if(!toSeat.mergedFrom.includes(fromSeatId)) toSeat.mergedFrom.push(fromSeatId);
}

/* ===== äº¤æ›ç§»å‹•ï¼šA â‡” Bï¼ˆidã¯ç¶­æŒï¼‰ ===== */
function doSwapMove(fromId, toId){
  const a = seatById(fromId);
  const b = seatById(toId);
  if(!a || !b) return;

  const aCopy = clone(a);
  const bCopy = clone(b);

  // idã ã‘ã¯å›ºå®šï¼ˆå¸­ç•ªå·ã®ç®±ã¯ä¿æŒï¼‰
  const keepA = a.id;
  const keepB = b.id;

  Object.assign(a, bCopy); a.id = keepA;
  Object.assign(b, aCopy); b.id = keepB;

  toast(`${fromId} â‡” ${toId} ã§äº¤æ›ã—ã¾ã—ãŸ`);
  renderSeats(); // è¡¨ç¤ºæ›´æ–°ï¼ˆè©³ç´°è¡¨ç¤ºã¯PART1ã§å¾Œã§å¼·åŒ–ï¼‰
}

/* ===== åˆæµï¼šA ãŒ B ã«ç§»å‹•ï¼ˆãƒ‡ãƒ¼ã‚¿ã¯è¶³ã•ãªã„ï¼‰ =====
  - A ã‚’ç©ºå¸­åŒ–
  - B ã¯ status in ã®ã¾ã¾ï¼ˆBã®ä¸­ã« A ãŒæ¥ãŸå°ã¨ã—ã¦ mergedFrom ã‚’è¿½åŠ ï¼‰
*/
function doMergeInto(fromId, toId){
  const from = seatById(fromId);
  const to = seatById(toId);
  if(!from || !to) return;

  // Bå´ã«ã€ŒAãŒæ¥ãŸã€å°ã ã‘æ®‹ã™ï¼ˆãƒ‡ãƒ¼ã‚¿åŠ ç®—ã¯ã—ãªã„ï¼‰
  markMerged(to, fromId);

  // to ãŒç©ºå¸­ãªã‚‰ã€Œç©ºå¸­ã®ã¾ã¾åˆæµã€ã¯æ„å‘³ãŒè–„ã„ã®ã§ã€æœ€ä½é™ in æ‰±ã„ã«ã™ã‚‹ï¼ˆæ­¢ã‚ãªã„ï¼‰
  if(to.status==="empty"){
    to.status = "in";
    // people/name/total/bills ã¯è¶³ã•ãªã„ï¼ˆãƒ«ãƒ¼ãƒ«ï¼‰
  }

  // A ã‚’ç©ºå¸­ã«
  from.status = "empty";
  from.people = 0;
  from.total  = 0;
  from.bills  = 0;
  from.name   = "";
  delete from._mergeBackup;

  toast(`${fromId} â†’ ${toId} ã«åˆæµã—ã¾ã—ãŸ`);
  renderSeats();
}

/* ===== ã‚¹ãƒ©ã‚¤ãƒ‰ç¢ºå®šãƒ¢ãƒ¼ãƒ€ãƒ« ===== */
function openSlideConfirm(title, messageHtml, onConfirm){
  openModal(
    title,
    `
      <div class="miniNote">${messageHtml}</div>
      <div style="height:12px"></div>
      <div class="slideBox">
        <div class="slideLabel">å³ã¾ã§ã‚¹ãƒ©ã‚¤ãƒ‰ã§ç¢ºå®š</div>
        <input class="slideRange" id="slideConfirm" type="range" min="0" max="100" value="0" />
      </div>
    `,
    [
      {label:"æˆ»ã‚‹", onClick:()=> closeModal()},
    ]
  );

  // ã‚¹ãƒ©ã‚¤ãƒ‰ã®ç¢ºå®šåˆ¤å®š
  setTimeout(()=>{
    const r = document.getElementById("slideConfirm");
    if(!r) return;

    const reset = ()=> { r.value = 0; };

    r.addEventListener("change", ()=>{
      const v = Number(r.value||0);
      if(v >= 98){
        closeModal();
        onConfirm && onConfirm();
      }else{
        reset();
      }
    });

    // æŒ‡ã‚’é›¢ã—ãŸæ™‚ã«æˆ»ã™ï¼ˆæœªå®Œäº†ãªã‚‰ï¼‰
    r.addEventListener("touchend", ()=>{
      const v = Number(r.value||0);
      if(v < 98) reset();
    });
    r.addEventListener("mouseup", ()=>{
      const v = Number(r.value||0);
      if(v < 98) reset();
    });
  },0);
}

/* ===== å¸­ç§»å‹•UIï¼ˆå…¥åŠ›ç”»é¢ï¼‰ ===== */
function openSeatMoveUI(){
  // datalistï¼ˆå€™è£œï¼‰
  const opts = seatIds().map(id=> `<option value="${id}"></option>`).join("");

  openModal(
    "å¸­ç§»å‹•",
    `
      <div class="moveBox">
        <div class="miniNote">ã©ã®å¸­ã‚’ã€ã©ã“ã«ç§»å‹•ã—ã¾ã™ã‹ï¼Ÿ</div>

        <datalist id="seatIdList">${opts}</datalist>

        <div class="moveRow">
          <input class="moveInput" id="moveFrom" list="seatIdList" placeholder="å…ƒ" />
          <div class="moveArrow">â†’</div>
          <input class="moveInput" id="moveTo" list="seatIdList" placeholder="å…ˆ" />
        </div>

        <div class="moveBtnRow">
          <button class="btn lime" id="btnDoSwap">ç§»å‹•</button>
          <button class="btn" id="btnDoMerge">åˆæµ</button>
        </div>

        <div style="text-align:center;">
          <button class="btn" id="btnMoveBack" style="min-width:160px;">æˆ»ã‚‹</button>
        </div>
      </div>
    `,
    [] // ã“ã“ã¯å†…å´ãƒœã‚¿ãƒ³ã§åˆ¶å¾¡
  );

  setTimeout(()=>{
    const $from = document.getElementById("moveFrom");
    const $to   = document.getElementById("moveTo");
    const $swap = document.getElementById("btnDoSwap");
    const $merge= document.getElementById("btnDoMerge");
    const $back = document.getElementById("btnMoveBack");

    const getIds = ()=> ({
      fromId: normalizeSeatId($from.value),
      toId: normalizeSeatId($to.value),
    });

    const validate = ()=>{
      const {fromId,toId} = getIds();
      if(!isValidSeatId(fromId) || !isValidSeatId(toId)){
        toast("å¸­ç•ªå·ã‚’æ­£ã—ãå…¥åŠ›ã—ã¦ãã ã•ã„");
        return null;
      }
      if(fromId===toId){
        toast("åˆ¥ã®å¸­ç•ªå·ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
        return null;
      }
      return {fromId,toId};
    };

    $swap.onclick = ()=>{
      const ids = validate();
      if(!ids) return;

      openSlideConfirm(
        "ç¢ºèª",
        `${ids.fromId} â‡” ${ids.toId} ã‚’äº¤æ›ã—ã¾ã™ã‹ï¼Ÿ`,
        ()=> doSwapMove(ids.fromId, ids.toId)
      );
    };

    $merge.onclick = ()=>{
      const ids = validate();
      if(!ids) return;

      openSlideConfirm(
        "ç¢ºèª",
        `${ids.fromId} ã‚’ ${ids.toId} ã«åˆæµã—ã¾ã™ã‹ï¼Ÿ<br>ï¼ˆãƒ‡ãƒ¼ã‚¿ã¯è¶³ã—ã¾ã›ã‚“ï¼‰`,
        ()=> doMergeInto(ids.fromId, ids.toId)
      );
    };

    $back.onclick = ()=> closeModal();
  },0);
}

/* ===== ä¸‹æ®µï¼šå¸­ç§»å‹•ãƒœã‚¿ãƒ³ã®æŒ™å‹•ã‚’PART2ã§ä¸Šæ›¸ã =====
   - ã„ã¾ã®PART1ã¯ã€ŒmodeMoveã€ã‚’æ®‹ã—ã¦ã„ã‚‹ã®ã§ã€
     ã“ã“ã§ã€Œå¸­ç§»å‹•UIã‚’é–‹ãã€ã«çµ±ä¸€ã™ã‚‹ã€‚
*/
$("modeMove").onclick = ()=>{
  openSeatMoveUI();
};

/* ===== åˆå›åæ˜  ===== */
renderSeats();

/* =========================
  ã“ã“ã‹ã‚‰å…ˆã¯ PART3 ã§ç¶šã
========================= */
/* =========================
  PART3ï¼šã‚­ãƒƒãƒãƒ³ï¼ˆå·®ã—æ›¿ãˆç‰ˆï½œPART1æ–°ãƒ‡ã‚¶ã‚¤ãƒ³å¯¾å¿œï¼‰
  å½¹å‰²ï¼šæœªèª¿ç†ä¸€è¦§ / åŒä¸€ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã¾ã¨ã‚ / ã‚¹ãƒ©ã‚¤ãƒ‰å®Œäº† / æä¾›æ¸ˆæŠ˜ã‚ŠãŸãŸã¿
  æ–¹é‡ï¼šä½œã‚‹ã“ã¨ã ã‘ã«é›†ä¸­ãƒ»æ¶ˆã•ãªã„ãƒ»æˆ»ã›ã‚‹ãƒ»åŒæœŸçŠ¶æ…‹ã§åˆ¤æ–­ã—ãªã„
========================= */

/* ===== UIå·®ã—æ›¿ãˆï¼ˆPART1ã®ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ã‚’å®Ÿä½“ã«ç½®æ›ï¼‰ */
(function buildKitchenUI(){
  const scr = $("scrKitchen");
  scr.innerHTML = `
    <div class="kHint">æœªèª¿ç†ãŒä¸Šã«è¡¨ç¤ºã•ã‚Œã¾ã™</div>

    <div class="kTools">
      <div class="kToolsLabel">è¡¨ç¤º</div>
      <button class="btn" id="kFilterFood">æ–™ç†</button>
      <button class="btn" id="kFilterDrink">ãƒ‰ãƒªãƒ³ã‚¯</button>
      <button class="btn" id="kToggleDone">æä¾›æ¸ˆã‚’è¡¨ç¤º</button>
    </div>

    <div id="kList"></div>

    <div id="kDoneWrap" style="display:none; margin-top:14px">
      <div class="kHint">æä¾›æ¸ˆ</div>
      <div style="height:8px"></div>
      <div id="kDoneList"></div>
    </div>
  `;
})();

/* ===== PART3 State ===== */
state.kitchen = state.kitchen || {
  showDone: false,
  showFood: true,
  showDrink: true,
  items: []
};

/* ãƒ‡ãƒ¢ï¼ˆå¾Œã§PART1ã®æ³¨æ–‡ã‚¤ãƒ™ãƒ³ãƒˆã‹ã‚‰ç”Ÿæˆã™ã‚‹ï¼‰ */
(function seedKitchenIfEmpty(){
  if(state.kitchen.items.length) return;

  const base = nowTs();
  state.kitchen.items = [
    {kid:"k1", ts: base-40*60*1000, seatId:"D", name:"å”æšã’", qty:1, cat:"food",  status:"todo"},
    {kid:"k2", ts: base-30*60*1000, seatId:"A", name:"å”æšã’", qty:1, cat:"food",  status:"todo"},
    {kid:"k3", ts: base-25*60*1000, seatId:"B", name:"å”æšã’", qty:2, cat:"food",  status:"todo"},
    {kid:"k4", ts: base-20*60*1000, seatId:"C", name:"ç”Ÿãƒ“ãƒ¼ãƒ«", qty:1, cat:"drink", status:"todo"},
  ];
})();

/* ===== CSSï¼ˆã‚­ãƒƒãƒãƒ³å°‚ç”¨ï½œPART1ã®æ–°ãƒ‡ã‚¶ã‚¤ãƒ³ã«åˆã‚ã›ã‚‹ï¼‰ ===== */
(function injectPart3Css(){
  const css = `
    .kHint{
      color:#fff;
      font-size:14px;
      font-weight:800;
      opacity:0.92;
      margin-bottom:10px;
    }
    .kTools{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
      margin-bottom:10px;
    }
    .kToolsLabel{
      font-size:12px;
      font-weight:900;
      color:rgba(255,255,255,0.78);
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,0.14);
      background:rgba(0,0,0,0.18);
    }

    /* PART1å´ã« .btn.primary ãŒç„¡ã„ã®ã§ã€ã“ã“ã§å®šç¾© */
    .btn.primary{
      background:rgba(126,220,98,0.18);
      border-color:rgba(126,220,98,0.55);
      color:var(--text);
      font-weight:900;
    }

    .kRow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:10px;
      border:1px solid rgba(255,255,255,0.12);
      border-radius:14px;
      background:rgba(255,255,255,0.04);
      margin-bottom:10px;
    }
    .kLeft{
      min-width:0;
      display:flex;
      align-items:center;
      gap:10px;
      flex:1;
    }
    .kTime{ font-weight:900; width:56px; }
    .kSeat{ font-weight:900; width:32px; }
    .kName{
      min-width:0;
      font-weight:800;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    .kQty{
      font-weight:900;
      color:rgba(255,255,255,0.70);
      margin-left:6px;
    }

    /* ã¶ã‚‰ä¸‹ã’è¡¨ç¤º */
    .kChild{
      margin-left:18px;
      position:relative;
    }
    .kChild::before{
      content:"";
      position:absolute;
      left:-10px;
      top:0;
      bottom:0;
      width:2px;
      background:rgba(126,220,98,0.40); /* é»„ç·‘å¯„ã› */
      border-radius:99px;
    }
    .kChild .kRow{
      background:rgba(126,220,98,0.10);
    }

    /* ã‚¹ãƒ©ã‚¤ãƒ‰ï¼ˆçŸ­ã‚ï¼šç”»é¢å¹…ã®ç´„1/4ï¼‰ */
    .kSlide{
      width:25vw;
      max-width:160px;
      min-width:110px;
      display:flex;
      align-items:center;
      gap:8px;
      justify-content:flex-end;
    }
    .kRange{
      width:100%;
      accent-color: var(--lime, #7edc62);
    }
    .kDoneBadge{
      font-size:12px;
      color:var(--ok);
      font-weight:900;
      white-space:nowrap;
    }
  `;
  const st = document.createElement("style");
  st.textContent = css;
  document.head.appendChild(st);
})();

/* ===== Helpers ===== */
function hhmm(ts){
  const d = new Date(ts);
  return `${pad2(d.getHours())}:${pad2(d.getMinutes())}`;
}

function passCategory(item){
  if(item.cat==="food" && !state.kitchen.showFood) return false;
  if(item.cat==="drink" && !state.kitchen.showDrink) return false;
  return true;
}

/* åŒä¸€ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã¾ã¨ã‚ï¼šè¦ªï¼æœ€å¤ã€å­ï¼æ™‚é–“é †ã«ã¶ã‚‰ä¸‹ã’ */
function buildKitchenGroups(list){
  const map = new Map();
  list.forEach(it=>{
    const key = `${it.name}__${it.cat}`;
    if(!map.has(key)) map.set(key, []);
    map.get(key).push(it);
  });

  const groups = [];
  map.forEach(arr=>{
    arr.sort((a,b)=> a.ts-b.ts);
    groups.push(arr);
  });

  groups.sort((ga,gb)=> ga[0].ts - gb[0].ts);
  return groups;
}

/* ===== Render ===== */
function renderKitchen(){
  const todo = state.kitchen.items
    .filter(it=> it.status==="todo")
    .filter(passCategory);

  const done = state.kitchen.items
    .filter(it=> it.status==="done")
    .filter(passCategory);

  const listBox = $("kList");
  const doneWrap = $("kDoneWrap");
  const doneBox = $("kDoneList");

  listBox.innerHTML = "";
  doneBox.innerHTML = "";

  // æœªèª¿ç†ï¼ˆã‚°ãƒ«ãƒ¼ãƒ—è¡¨ç¤ºï¼‰
  const groups = buildKitchenGroups(todo);
  if(groups.length===0){
    listBox.innerHTML = `<div class="kHint" style="opacity:0.75">æœªèª¿ç†ã¯ã‚ã‚Šã¾ã›ã‚“</div>`;
  }else{
    groups.forEach(arr=>{
      listBox.appendChild(kRowEl(arr[0], false));
      arr.slice(1).forEach(ch=>{
        const wrap = document.createElement("div");
        wrap.className = "kChild";
        wrap.appendChild(kRowEl(ch, false));
        listBox.appendChild(wrap);
      });
    });
  }

  // æä¾›æ¸ˆï¼ˆæŠ˜ã‚ŠãŸãŸã¿ï¼‰
  doneWrap.style.display = state.kitchen.showDone ? "block" : "none";
  if(state.kitchen.showDone){
    const groupsD = buildKitchenGroups(done);
    if(groupsD.length===0){
      doneBox.innerHTML = `<div class="kHint" style="opacity:0.75">æä¾›æ¸ˆã¯ã‚ã‚Šã¾ã›ã‚“</div>`;
    }else{
      groupsD.forEach(arr=>{
        doneBox.appendChild(kRowEl(arr[0], true));
        arr.slice(1).forEach(ch=>{
          const wrap = document.createElement("div");
          wrap.className = "kChild";
          wrap.appendChild(kRowEl(ch, true));
          doneBox.appendChild(wrap);
        });
      });
    }
  }
}

function kRowEl(item, isDone){
  const row = document.createElement("div");
  row.className = "kRow";

  const qtyText = (Number(item.qty||0) >= 2) ? `Ã—${item.qty}` : "";
  row.innerHTML = `
    <div class="kLeft">
      <div class="kTime">${hhmm(item.ts)}</div>
      <div class="kSeat">${item.seatId}</div>
      <div class="kName">${item.name}<span class="kQty">${qtyText}</span></div>
    </div>
    <div class="kSlide">
      ${isDone ? `<span class="kDoneBadge">å®Œäº†</span>` : ``}
      <input class="kRange" type="range" min="0" max="100" value="0" aria-label="ã‚¹ãƒ©ã‚¤ãƒ‰ã§åˆ‡æ›¿" />
    </div>
  `;

  const range = row.querySelector(".kRange");
  const TH = 88;

  const reset = ()=> { range.value = 0; };

  range.addEventListener("change", ()=>{
    const v = Number(range.value||0);
    if(v >= TH){
      item.status = isDone ? "todo" : "done";
      reset();
      renderKitchen();
    }else{
      reset();
    }
  });

  range.addEventListener("touchend", ()=>{
    const v = Number(range.value||0);
    if(v < TH) reset();
  });
  range.addEventListener("mouseup", ()=>{
    const v = Number(range.value||0);
    if(v < TH) reset();
  });

  return row;
}

/* ===== Buttons ===== */
$("kToggleDone").onclick = ()=>{
  state.kitchen.showDone = !state.kitchen.showDone;
  $("kToggleDone").textContent = state.kitchen.showDone ? "æä¾›æ¸ˆã‚’éš ã™" : "æä¾›æ¸ˆã‚’è¡¨ç¤º";
  renderKitchen();
};

$("kFilterFood").onclick = ()=>{
  state.kitchen.showFood = !state.kitchen.showFood;
  $("kFilterFood").classList.toggle("primary", state.kitchen.showFood);
  renderKitchen();
};
$("kFilterDrink").onclick = ()=>{
  state.kitchen.showDrink = !state.kitchen.showDrink;
  $("kFilterDrink").classList.toggle("primary", state.kitchen.showDrink);
  renderKitchen();
};

// åˆæœŸï¼ˆä¸¡æ–¹ONï¼‰
$("kFilterFood").classList.add("primary");
$("kFilterDrink").classList.add("primary");

/* ===== showScreenæ‹¡å¼µï¼šã‚­ãƒƒãƒãƒ³è¡¨ç¤ºæ™‚ã«æç”» ===== */
(function hookShowScreenForKitchen(){
  if(showScreen._kHooked) return;
  const _show = showScreen;
  showScreen = function(id){
    _show(id);
    if(id==="scrKitchen") renderKitchen();
  };
  showScreen._kHooked = true;
})();

/* åˆå›æç”» */
renderKitchen();

/* =========================
  ã“ã“ã‹ã‚‰å…ˆã¯ PART4 ã§ç¶šã
========================= */
/* =========================
  PART4ï¼šå£²ä¸Šï¼ˆæœ¬æ—¥ï¼æœˆï¼å¹´ï½œå…¥å£ã§è¡¨ç¤ºåˆ‡æ›¿å¯¾å¿œï¼‰
  å½¹å‰²ï¼šè¡¨ç¤ºã®ã¿ï¼ˆç·¨é›†ä¸å¯ï¼‰ï¼å®‰å¿ƒç¢ºèª
  æ–¹é‡ï¼šè»½ããƒ»ä¸å®‰ã‚’ç…½ã‚‰ãªã„ãƒ»ä¿®æ­£ã¯PART5ã¸åˆ†é›¢
========================= */

/* ===== UIå·®ã—æ›¿ãˆï¼ˆãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ç½®æ›ï¼‰ ===== */
(function buildSalesUI(){
  const scr = $("scrSales");
  scr.innerHTML = `
    <div class="sHint">å£²ä¸Šï¼ˆè¡¨ç¤ºã®ã¿ï¼‰</div>

    <div class="sTabs" id="salesTabs">
      <button class="btn primary" id="tabToday">æœ¬æ—¥</button>
      <button class="btn" id="tabMonth">æœˆ</button>
      <button class="btn" id="tabYear">å¹´</button>
    </div>

    <div id="salesToday"></div>
    <div id="salesMonth" style="display:none"></div>
    <div id="salesYear" style="display:none"></div>
  `;
})();

/* ===== CSSï¼ˆå£²ä¸Šå°‚ç”¨ï½œPART1æ–°ãƒ‡ã‚¶ã‚¤ãƒ³ã«åˆã‚ã›ã‚‹ï¼‰ ===== */
(function injectPart4Css(){
  const css = `
    /* PART1å´ã« .btn.primary ãŒç„¡ã„æƒ³å®šã§ã‚‚å‹•ãã‚ˆã†ã«å®šç¾© */
    .btn.primary{
      background:rgba(126,220,98,0.18);
      border-color:rgba(126,220,98,0.55);
      color:var(--text);
      font-weight:900;
    }

    .sHint{
      color:#fff;
      font-size:14px;
      font-weight:900;
      opacity:0.92;
      margin-bottom:10px;
    }
    .sTabs{
      display:flex;
      gap:8px;
      margin-bottom:10px;
      flex-wrap:wrap;
    }

    .sCard{
      border:1px solid rgba(255,255,255,0.12);
      background:rgba(255,255,255,0.04);
      border-radius:14px;
      padding:10px;
      margin-bottom:10px;
    }
    .sSumLine{
      font-weight:900;
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      align-items:center;
    }
    .sSub{
      font-size:12px;
      color:rgba(255,255,255,0.72);
      font-weight:800;
    }

    .sRow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:10px;
      border:1px solid rgba(255,255,255,0.12);
      border-radius:14px;
      background:rgba(255,255,255,0.04);
      margin-bottom:10px;
      touch-action:manipulation;
    }
    .sLeft{
      min-width:0;
      display:flex;
      align-items:center;
      gap:10px;
      flex:1;
    }
    .sTime{ font-weight:900; width:56px; }
    .sSeat{ font-weight:900; width:32px; }
    .sName{
      min-width:0;
      font-weight:800;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    .sRight{
      display:flex;
      align-items:center;
      gap:10px;
      justify-content:flex-end;
      white-space:nowrap;
      font-weight:900;
    }
  `;
  const st = document.createElement("style");
  st.textContent = css;
  document.head.appendChild(st);
})();

/* ===== PART4 State ===== */
state.sales = state.sales || {
  list: [],
  tab: "today",
  entry: "full" // "todayOnly"ï¼ˆãƒ¡ã‚¤ãƒ³ã‹ã‚‰ï¼‰ / "full"ï¼ˆè¨­å®šãªã©ã‹ã‚‰ï¼‰
};

/* ===== Demo Seed ===== */
(function seedSalesIfEmpty(){
  if(state.sales.list.length) return;

  const now = new Date();
  const mk = (h,m,seat,name,pay,amt)=>{
    const d = new Date(now.getFullYear(), now.getMonth(), now.getDate(), h, m);
    return {
      saleId: "s"+Math.random().toString(36).slice(2),
      ts: d.getTime(),
      seatId: seat,
      name: name||"",
      pay,
      amount: amt,
      receipt: true,
      items: [
        {name:"ç”Ÿãƒ“ãƒ¼ãƒ«", qty:2, price:600, tax:10},
        {name:"å”æšã’", qty:1, price:800, tax:10},
      ]
    };
  };

  state.sales.list.push(
    mk(12,35,"D","ç”°ä¸­","ã‚«ãƒ¼ãƒ‰",4800),
    mk(13,10,"A","","ç¾é‡‘",1800),
    mk(14,05,"B","ä½è—¤","QR",2200),
  );
})();

/* ===== Helpers ===== */
function sameDay(a,b){
  return a.getFullYear()===b.getFullYear()
      && a.getMonth()===b.getMonth()
      && a.getDate()===b.getDate();
}

/* ===== Aggregation (è»½é‡) ===== */
function aggToday(){
  const today = new Date();
  const rows = state.sales.list.filter(s=> sameDay(new Date(s.ts), today));
  const sum = rows.reduce((a,b)=> a+b.amount, 0);
  const cnt = rows.length;
  const pay = rows.reduce((o,s)=> (o[s.pay]=(o[s.pay]||0)+1, o), {});
  return { rows, sum, cnt, pay };
}
function aggMonth(){
  const d = new Date();
  const y=d.getFullYear(), m=d.getMonth();
  const rows = state.sales.list.filter(s=>{
    const x=new Date(s.ts);
    return x.getFullYear()===y && x.getMonth()===m;
  });
  const sum = rows.reduce((a,b)=> a+b.amount, 0);
  return { sum, cnt: rows.length };
}
function aggYear(){
  const y=new Date().getFullYear();
  const rows = state.sales.list.filter(s=> new Date(s.ts).getFullYear()===y);
  const sum = rows.reduce((a,b)=> a+b.amount, 0);
  return { sum, cnt: rows.length };
}

/* ===== Render ===== */
function renderSales(){
  // å…¥å£ã«ã‚ˆã‚‹ã‚¿ãƒ–è¡¨ç¤ºåˆ‡æ›¿
  const tabs = $("salesTabs");
  const todayOnly = (state.sales.entry === "todayOnly");
  tabs.style.display = todayOnly ? "none" : "flex";

  // todayOnly ã®æ™‚ã¯å¼·åˆ¶ã§æœ¬æ—¥
  if(todayOnly) state.sales.tab = "today";

  const t = $("salesToday");
  const m = $("salesMonth");
  const y = $("salesYear");

  t.style.display = state.sales.tab==="today" ? "block":"none";
  m.style.display = state.sales.tab==="month" ? "block":"none";
  y.style.display = state.sales.tab==="year"  ? "block":"none";

  if(state.sales.tab==="today") renderToday();
  if(state.sales.tab==="month") renderMonth();
  if(state.sales.tab==="year")  renderYear();
}

function renderToday(){
  const box = $("salesToday");
  const a = aggToday();
  const payTxt = ["ç¾é‡‘","ã‚«ãƒ¼ãƒ‰","QR"].map(k=>`${k} ${a.pay[k]||0}`).join(" / ");

  box.innerHTML = `
    <div class="sCard">
      <div class="sSumLine">
        <div>åˆè¨ˆ ${yen(a.sum)}</div>
        <div class="sSub">ä¼šè¨ˆ ${a.cnt}ä»¶</div>
        <div class="sSub">${payTxt}</div>
      </div>
    </div>
    <div id="todayList"></div>
  `;

  const list = box.querySelector("#todayList");
  if(a.rows.length===0){
    list.innerHTML = `<div class="sHint" style="opacity:0.75">æœ¬æ—¥ã®ä¼šè¨ˆã¯ã‚ã‚Šã¾ã›ã‚“</div>`;
    return;
  }

  a.rows
    .sort((x,y)=> x.ts - y.ts)
    .forEach(s=>{
      const d=new Date(s.ts);
      const row=document.createElement("div");
      row.className="sRow";
      row.innerHTML=`
        <div class="sLeft">
          <div class="sTime">${pad2(d.getHours())}:${pad2(d.getMinutes())}</div>
          <div class="sSeat">${s.seatId}</div>
          <div class="sName">${s.name||""}</div>
        </div>
        <div class="sRight">
          <div>${s.pay}</div>
          <div>${yen(s.amount)}</div>
        </div>
      `;
      row.onclick=()=> openSaleDetail(s);
      list.appendChild(row);
    });
}

function renderMonth(){
  const box = $("salesMonth");
  const a = aggMonth();
  box.innerHTML = `
    <div class="sCard">
      <div class="sSumLine">
        <div>æœˆåˆè¨ˆ ${yen(a.sum)}</div>
        <div class="sSub">ä¼šè¨ˆ ${a.cnt}ä»¶</div>
      </div>
    </div>
    <div class="sHint" style="opacity:0.75">æ—¥åˆ¥å†…è¨³ã¯ç„¡æ–™ç‰ˆã§ã¯è¡¨ç¤ºã—ã¾ã›ã‚“</div>
  `;
}

function renderYear(){
  const box = $("salesYear");
  const a = aggYear();
  box.innerHTML = `
    <div class="sCard">
      <div class="sSumLine">
        <div>å¹´åˆè¨ˆ ${yen(a.sum)}</div>
        <div class="sSub">ä¼šè¨ˆ ${a.cnt}ä»¶</div>
      </div>
    </div>
    <div class="sHint" style="opacity:0.75">æœˆåˆ¥å†…è¨³ã¯ç„¡æ–™ç‰ˆã§ã¯è¡¨ç¤ºã—ã¾ã›ã‚“</div>
  `;
}

/* ===== Detail (ä¿®æ­£ã¯PART5ã¸) ===== */
function openSaleDetail(s){
  const items = s.items.map(it=>`${it.name} Ã—${it.qty}`).join("<br>");
  openModal(
    "ä¼šè¨ˆè©³ç´°",
    `
      <div class="miniNote">
        <div>å¸­ï¼š${s.seatId}</div>
        <div>æ”¯æ‰•ï¼š${s.pay}</div>
        <div>é›»å­ãƒ¬ã‚·ãƒ¼ãƒˆï¼š${s.receipt?"é€ä¿¡æ¸ˆ":"æœªé€ä¿¡"}</div>
        <div style="margin-top:10px">${items}</div>
        <div style="margin-top:10px;font-weight:900">${yen(s.amount)}</div>
      </div>
    `,
    [
      {label:"ä¿®æ­£", primary:true, onClick:()=>{ closeModal(); state.sales.entry="full"; showScreen("scrFix"); }},
      {label:"æˆ»ã‚‹", onClick:()=> closeModal()},
    ]
  );
}

/* ===== Tabs ===== */
$("tabToday").onclick=()=>{
  state.sales.tab="today";
  $("tabToday").classList.add("primary");
  $("tabMonth").classList.remove("primary");
  $("tabYear").classList.remove("primary");
  renderSales();
};
$("tabMonth").onclick=()=>{
  state.sales.tab="month";
  $("tabMonth").classList.add("primary");
  $("tabToday").classList.remove("primary");
  $("tabYear").classList.remove("primary");
  renderSales();
};
$("tabYear").onclick=()=>{
  state.sales.tab="year";
  $("tabYear").classList.add("primary");
  $("tabToday").classList.remove("primary");
  $("tabMonth").classList.remove("primary");
  renderSales();
};

/* ===== showScreenæ‹¡å¼µ ===== */
(function hookShowScreenForSales(){
  if(showScreen._sHooked) return;
  const _show = showScreen;
  showScreen = function(id){
    _show(id);
    if(id==="scrSales") renderSales();
  };
  showScreen._sHooked = true;
})();

/* åˆæœŸæç”» */
renderSales();

/* =========================
  ã“ã“ã‹ã‚‰å…ˆã¯ PART5 ã§ç¶šã
========================= */
/* =========================
  PART5ï¼šå£²ä¸Šç®¡ç†ãƒ»è¨‚æ­£ä¼ç¥¨
  å½¹å‰²ï¼šä¼šè¨ˆç¢ºå®šå¾Œã®ä¿®æ­£ï¼ˆå·®åˆ†ã‚¤ãƒ™ãƒ³ãƒˆã®ã¿ï¼‰
  æ–¹é‡ï¼šæ¶ˆã•ãªã„ï¼ä¸Šæ›¸ãã—ãªã„ï¼å±¥æ­´ã‚’æ®‹ã™
========================= */

/* ===== UIå·®ã—æ›¿ãˆï¼ˆãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ç½®æ›ï¼‰ ===== */
(function buildFixUI(){
  const scr = $("scrFix");
  scr.innerHTML = `
    <div class="fHint">è¨‚æ­£ä¼ç¥¨ï¼ˆä¼šè¨ˆç¢ºå®šå¾Œï¼‰</div>
    <div id="fixBody"></div>
  `;
})();

/* ===== CSSï¼ˆPART5å°‚ç”¨ï½œbtn.primaryæœªå®šç¾©ã§ã‚‚å´©ã‚Œãªã„ï¼‰ ===== */
(function injectPart5Css(){
  const css = `
    .btn.primary{
      background:rgba(126,220,98,0.18);
      border-color:rgba(126,220,98,0.55);
      color:var(--text);
      font-weight:900;
    }
    .fHint{
      color:#fff;
      font-size:14px;
      font-weight:900;
      opacity:0.92;
      margin-bottom:10px;
    }
    .fCard{
      border:1px solid rgba(255,255,255,0.12);
      background:rgba(255,255,255,0.04);
      border-radius:14px;
      padding:10px;
      margin-bottom:10px;
    }
    .fTitle{
      font-weight:900;
      margin-bottom:6px;
      opacity:0.92;
    }
    .fRow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:10px;
      border:1px solid rgba(255,255,255,0.12);
      border-radius:14px;
      background:rgba(255,255,255,0.04);
      margin-bottom:10px;
      touch-action:manipulation;
    }
    .fLeft{
      min-width:0;
      display:flex;
      flex-direction:column;
      gap:2px;
      flex:1;
    }
    .fName{
      font-weight:900;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    .fSub{
      font-size:12px;
      color:rgba(255,255,255,0.72);
      font-weight:800;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    .fRight{
      white-space:nowrap;
      font-weight:900;
      opacity:0.95;
    }
    .fLine{
      height:1px;
      background:rgba(255,255,255,0.10);
      margin:10px 0;
    }
  `;
  const st = document.createElement("style");
  st.textContent = css;
  document.head.appendChild(st);
})();

/* ===== PART5 State ===== */
state.fix = state.fix || {
  target: null
};

/* ===== Entry from PART4ï¼ˆopenSaleDetailã‚’ãƒ•ãƒƒã‚¯ã—ã¦å¯¾è±¡ä¿æŒï¼‰ ===== */
(function hookFixEntry(){
  if(openSaleDetail._fixHooked) return;
  const _open = openSaleDetail;
  openSaleDetail = function(sale){
    state.fix.target = sale;   // å¯¾è±¡ã‚’ä¿æŒï¼ˆä¿®æ­£ãƒœã‚¿ãƒ³ã§ scrFix ã«è¡Œãï¼‰
    _open(sale);
  };
  openSaleDetail._fixHooked = true;
})();

/* ===== Helpers ===== */
function fmtTs(ts){
  const d = new Date(ts);
  return `${pad2(d.getHours())}:${pad2(d.getMinutes())}`;
}
function clamp(n, min, max){
  n = Number(n||0);
  if(Number.isNaN(n)) n = min;
  return Math.max(min, Math.min(max, n));
}

/* æœ€çµ‚åˆè¨ˆï¼ˆå…ƒä¼ç¥¨ï¼‹è¨‚æ­£å·®åˆ†ï¼‰â€»ã„ã¾ã¯ã€Œå•†å“å·®åˆ†ï¼ˆâˆ’ï¼‰ã€ã®ã¿ */
function calcFinalAmount(s){
  const base = Number(s.amount||0);
  const minus = (s.corrections||[]).reduce((a,c)=>{
    const qty = Number(c.qty||0);
    const unit = Number(c.unit||0); // unit ã‚’æŒã£ã¦ã„ã‚Œã°æ­£ç¢º
    return a + (unit>0 ? unit*qty : 0);
  }, 0);

  // unitæœªä¿æŒã®ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹å ´åˆã¯å…ƒåˆè¨ˆã‚’å„ªå…ˆï¼ˆâ€»å¾Œã§ä¼šè¨ˆè¨ˆç®—ã‚’æœ¬å®Ÿè£…ã—ãŸã‚‰å·®ã—æ›¿ãˆï¼‰
  if((s.corrections||[]).some(c=> !c.unit)) return base;

  return Math.max(0, base - minus);
}

/* ===== Render ===== */
function renderFix(){
  const box = $("fixBody");
  const s = state.fix.target;

  if(!s){
    box.innerHTML = `<div class="fCard">ä¿®æ­£å¯¾è±¡ãŒã‚ã‚Šã¾ã›ã‚“</div>`;
    return;
  }

  // å…ƒæ˜ç´°
  const baseItems = (s.items||[]).map(it=>{
    const unit = (Number(it.price||0) * Number(it.qty||0)); // ä»®ï¼ˆç¨ç‡è¨ˆç®—ã¯å¾Œã§ï¼‰
    return `
      <div class="fRow">
        <div class="fLeft">
          <div class="fName">${it.name}</div>
          <div class="fSub">Ã—${it.qty}</div>
        </div>
        <div class="fRight">${yen(unit)}</div>
      </div>
    `;
  }).join("");

  // è¨‚æ­£å±¥æ­´ï¼ˆæ–°ã—ã„é †ï¼‰
  const corr = (s.corrections||[])
    .slice()
    .sort((a,b)=> (b.ts||0)-(a.ts||0))
    .map(c=>{
      const when = c.ts ? fmtTs(c.ts) : "";
      const whoWhy = `${when} ${c.who||""}ï¼${c.why||""}`.trim();
      const unit = Number(c.unit||0);
      const amt = unit>0 ? yen(unit * Number(c.qty||0)) : "";
      return `
        <div class="fRow">
          <div class="fLeft">
            <div class="fName">${c.name}</div>
            <div class="fSub">âˆ’${c.qty}ã€€${whoWhy}</div>
          </div>
          <div class="fRight">${amt}</div>
        </div>
      `;
    }).join("");

  const finalAmount = calcFinalAmount(s);

  box.innerHTML = `
    <div class="fCard">
      <div class="fTitle">å…ƒä¼ç¥¨</div>
      <div class="fSub">å¸­ï¼š${s.seatId}</div>
      <div class="fSub">æ”¯æ‰•ï¼š${s.pay}</div>
      <div class="fSub">å…ƒåˆè¨ˆï¼š${yen(s.amount)}</div>
    </div>

    <div class="fCard">
      <div class="fTitle">æ˜ç´°</div>
      ${baseItems || `<div class="fSub">æ˜ç´°ãŒã‚ã‚Šã¾ã›ã‚“</div>`}
      ${corr ? `<div class="fLine"></div><div class="fTitle">è¨‚æ­£å±¥æ­´</div>${corr}` : ``}
      <div class="fLine"></div>
      <div style="font-weight:900">${yen(finalAmount)}</div>
    </div>

    <button class="btn primary" id="btnAddFix">è¨‚æ­£ä¼ç¥¨ã‚’è¿½åŠ </button>
  `;
}

/* ===== Add Correction ===== */
function openAddFix(){
  const s = state.fix.target;
  if(!s) return;

  const opts = (s.items||[]).map((it,idx)=>`
    <option value="${idx}">${it.name}</option>
  `).join("");

  openModal(
    "è¨‚æ­£è¿½åŠ ",
    `
      <div style="margin-bottom:6px">è¨‚æ­£è€…åï¼ˆå¿…é ˆï¼‰</div>
      <input id="fixWho" class="btn" style="width:100%; text-align:left" placeholder="åå‰" />

      <div style="margin-top:10px;margin-bottom:6px">ç†ç”±ï¼ˆå¿…é ˆï¼‰</div>
      <select id="fixWhy" class="btn" style="width:100%">
        <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
        <option>æœªæä¾›</option>
        <option>æ”¯æ‰•ã„æ–¹æ³•ãƒŸã‚¹</option>
        <option>äºŒé‡ä¼šè¨ˆ</option>
        <option>è¿”é‡‘å¯¾å¿œ</option>
        <option>ãã®ä»–</option>
      </select>

      <div style="margin-top:10px;margin-bottom:6px">å•†å“</div>
      <select id="fixItem" class="btn" style="width:100%">
        ${opts}
      </select>

      <div style="margin-top:10px;margin-bottom:6px">æ•°é‡ï¼ˆæ¸›ã‚‰ã™ï¼‰</div>
      <input id="fixQty" type="number" class="btn" min="1" value="1" style="width:100%" />
    `,
    [
      {label:"æˆ»ã‚‹", onClick:()=> closeModal()},
      {label:"ç¢ºèªã¸", primary:true, onClick:()=>{
        const who = $("fixWho").value.trim();
        const why = $("fixWhy").value;
        const idx = Number($("fixItem").value);
        const it = (s.items||[])[idx];
        if(!it){ toast("å•†å“ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“"); return; }

        const maxQty = Math.max(1, Number(it.qty||1));
        const qty = clamp($("fixQty").value, 1, maxQty);

        if(!who || !why){
          toast("è¨‚æ­£è€…åã¨ç†ç”±ã¯å¿…é ˆã§ã™");
          return;
        }

        // ç¢ºèªï¼ˆä»•æ§˜ï¼šè¿½åŠ å‰ã«ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ«ï¼‰
        closeModal();
        openModal(
          "ç¢ºèª",
          "è¨‚æ­£ä¼ç¥¨ã‚’è¿½åŠ ã—ã¾ã™ã‹ï¼Ÿ",
          [
            {label:"è¿½åŠ ã™ã‚‹", primary:true, onClick:()=>{
              // unitï¼ˆä»®ï¼‰ã‚’ä¿æŒï¼šå¾Œã§ç¨è¨ˆç®—ã‚’æœ¬å®Ÿè£…ã—ãŸã‚‰å·®ã—æ›¿ãˆå¯èƒ½
              const unit = Number(it.price||0);

              s.corrections = s.corrections || [];
              s.corrections.push({
                name: it.name,
                qty,
                unit, // 1å€‹ã‚ãŸã‚Šé‡‘é¡ï¼ˆä»®ï¼‰
                who,
                why,
                ts: nowTs()
              });

              closeModal();
              toast("è¨‚æ­£ä¼ç¥¨ã‚’è¿½åŠ ã—ã¾ã—ãŸ");
              renderFix();
            }},
            {label:"æˆ»ã‚‹", onClick:()=>{ closeModal(); openAddFix(); }},
          ]
        );
      }},
    ]
  );
}

/* ===== Button Hook ===== */
(function hookFixBtn(){
  if(hookFixBtn._done) return;
  document.addEventListener("click",(e)=>{
    if(e.target && e.target.id==="btnAddFix"){
      openAddFix();
    }
  });
  hookFixBtn._done = true;
})();

/* ===== showScreenæ‹¡å¼µ ===== */
(function hookShowScreenForFix(){
  if(showScreen._fHooked) return;
  const _show = showScreen;
  showScreen = function(id){
    _show(id);
    if(id==="scrFix") renderFix();
  };
  showScreen._fHooked = true;
})();

/* åˆæœŸæç”» */
renderFix();

/* =========================
  ã“ã“ã‹ã‚‰å…ˆã¯ PART6 ã§ç¶šã
========================= */
/* =========================
  PART6ï¼šå¸­ç™»éŒ²ãƒ»åˆæœŸè¨­å®šï¼ˆæœ€å¤§ç€å¸­äººæ•° å®Œå…¨å»ƒæ­¢ï½œæœ€æ–°ç¢ºå®šï¼‰
  å½¹å‰²ï¼šåç§° â†’ ç®±ã®æ•° â†’ é–‹å§‹å¸­ç•ªå· â†’ ä¿å­˜ â†’ ä½œæˆæ¸ˆã¿åç§°ç®¡ç†
  æ–¹é‡ï¼šåˆ¶é™ã—ãªã„ï¼ç¾å ´åˆ¤æ–­å„ªå…ˆï¼æ­¢ã‚ãªã„ï¼å‰Šé™¤ã¯ã‚¹ãƒ©ã‚¤ãƒ‰ã§èª¤æ“ä½œé˜²æ­¢
========================= */

/* ===== UIå·®ã—æ›¿ãˆï¼ˆãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ç½®æ›ï¼‰ ===== */
(function buildSeatSetupUI(){
  const scr = $("scrSeatSetup");
  scr.innerHTML = `
    <div class="pill" style="margin-bottom:10px">å¸­ç™»éŒ²</div>

    <!-- â‘  åç§° -->
    <div class="pill" style="margin-bottom:8px">â‘  åç§°</div>
    <div id="ssNameGrid" class="seatGrid" style="margin-bottom:8px"></div>
    <button class="btn primary" id="ssNameCommit" style="width:100%; margin-bottom:14px">æ±ºå®š</button>

    <!-- â‘¡ ç·å¸­æ•°ï¼ç·å“æ•° -->
    <div class="pill" style="margin-bottom:8px">â‘¡ ç·å¸­æ•°ï¼ç·å“æ•°ï¼ˆç®±ã®æ•°ï¼‰</div>
    <div style="display:flex; gap:10px; align-items:center; margin-bottom:14px">
      <button class="btn" id="ssCntMinus">â—€ï¸</button>
      <div class="pill" id="ssCntVal" style="font-weight:900; min-width:60px; justify-content:center">0</div>
      <button class="btn" id="ssCntPlus">â–¶ï¸</button>
    </div>

    <!-- â‘¢ å¸­ç•ªå· -->
    <div class="pill" style="margin-bottom:8px">â‘¢ å¸­ç•ªå·ï¼ˆè‡ªå‹•ã§æ¬¡ãŒå…¥ã‚Šã¾ã™ï¼‰</div>
    <input class="btn" id="ssStartLabel" placeholder="é–‹å§‹æ–‡å­—ï¼ˆä¾‹ï¼šA / 1 / ã‚ / ã‚¢ï¼‰" style="width:100%; text-align:left; margin-bottom:6px" />
    <div class="pill" style="margin-bottom:14px; color:var(--muted)">
      å…¥åŠ›ãŒ1æ–‡å­—ã®ã¿ã®å ´åˆã¯è‡ªå‹•ã§é€£ç•ªã«ãªã‚Šã¾ã™
    </div>

    <!-- âŒ â‘£ æœ€å¤§ç€å¸­äººæ•°ï¼šè¡¨ç¤ºã—ãªã„ï¼ˆæ¦‚å¿µã”ã¨æŒãŸãªã„ï¼‰ -->

    <!-- â‘¤ ä¿å­˜ -->
    <button class="btn primary" id="ssSave" style="width:100%; padding:14px 12px; font-weight:900; margin-bottom:14px">ä¿å­˜</button>

    <!-- â‘¥ ä½œã£ãŸå¸­ï¼ˆåç§°ã”ã¨ï¼‰â€»ä¿å­˜ã®ä¸‹ï¼åç§°ãƒœãƒƒã‚¯ã‚¹ã®ã¿3åˆ— -->
    <div class="pill" style="margin-bottom:8px">ä½œã£ãŸå¸­</div>
    <div id="ssGroups" class="seatGrid"></div>
  `;
})();

/* ===== PART6 State ===== */
state.seatSetup = state.seatSetup || {
  baseNames: ["ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼","ãƒ†ãƒ¼ãƒ–ãƒ«","åº§æ•·","å€‹å®¤","ç«‹ã¡","ãã®ä»–"],
  customNames: [],          // ã€Œãã®ä»–ã€ã§è¿½åŠ ã—ãŸåç§°ï¼ˆè¡¨ç¤ºã¯ã€Œãã®ä»–ã€ã®å‰ï¼‰
  selectedName: null,       // ã‚¿ãƒƒãƒ—ã§ãƒã‚¤ãƒ©ã‚¤ãƒˆï¼ˆå†ã‚¿ãƒƒãƒ—ã§è§£é™¤ï¼‰
  committedName: null,      // æ±ºå®šã•ã‚ŒãŸåç§°ï¼ˆä¿å­˜å¯¾è±¡ï¼‰
  count: 0,                 // ç®±ã®æ•°ï¼ˆåˆæœŸã¯0ã€åç§°æ±ºå®šã§åˆæœŸå€¤ã‚’å…¥ã‚Œã‚‹ï¼‰
  groups: [],               // {gid, name, seatIds:[], createdTs}
};

/* ===== Helpers ===== */
function isSingleChar(str){ return (str||"").length === 1; }

function nextLabelOneChar(ch){
  // æ•°å­—
  if(ch >= "0" && ch <= "9"){
    const n = Number(ch);
    if(Number.isFinite(n)) return String(n+1);
  }
  // è‹±å­—
  if(ch >= "a" && ch <= "z"){
    if(ch === "z") return "a";
    return String.fromCharCode(ch.charCodeAt(0)+1);
  }
  if(ch >= "A" && ch <= "Z"){
    if(ch === "Z") return "A";
    return String.fromCharCode(ch.charCodeAt(0)+1);
  }
  // ã²ã‚‰ãŒãªãƒ»ã‚«ã‚¿ã‚«ãƒŠï¼ˆç°¡æ˜“ãƒ†ãƒ¼ãƒ–ãƒ«ï¼‰
  const hira = "ã‚ã„ã†ãˆãŠã‹ããã‘ã“ã•ã—ã™ã›ããŸã¡ã¤ã¦ã¨ãªã«ã¬ã­ã®ã¯ã²ãµã¸ã»ã¾ã¿ã‚€ã‚ã‚‚ã‚„ã‚†ã‚ˆã‚‰ã‚Šã‚‹ã‚Œã‚ã‚ã‚’ã‚“";
  const kata = "ã‚¢ã‚¤ã‚¦ã‚¨ã‚ªã‚«ã‚­ã‚¯ã‚±ã‚³ã‚µã‚·ã‚¹ã‚»ã‚½ã‚¿ãƒãƒ„ãƒ†ãƒˆãƒŠãƒ‹ãƒŒãƒãƒãƒãƒ’ãƒ•ãƒ˜ãƒ›ãƒãƒŸãƒ ãƒ¡ãƒ¢ãƒ¤ãƒ¦ãƒ¨ãƒ©ãƒªãƒ«ãƒ¬ãƒ­ãƒ¯ãƒ²ãƒ³";
  const hi = hira.indexOf(ch);
  if(hi !== -1) return hira[(hi+1) % hira.length];
  const ka = kata.indexOf(ch);
  if(ka !== -1) return kata[(ka+1) % kata.length];
  return null; // å¯¾è±¡å¤–
}

function buildSeatIds(start, count){
  const ids = [];
  const s = (start||"").trim();
  if(!s || count<=0) return ids;

  if(isSingleChar(s)){
    let cur = s;
    for(let i=0;i<count;i++){
      ids.push(cur);
      const nx = nextLabelOneChar(cur);
      if(!nx) break;
      cur = nx;
    }
    return ids;
  }else{
    // è‡ªå‹•å…¥åŠ›ã—ãªã„ï¼š1å¸­ã ã‘ä½œã‚‹ï¼ˆæ­¢ã‚ãªã„ãŒäº‹æ•…ã‚‚é˜²ãï¼‰
    return [s];
  }
}

function ensureSeatExists(id){
  if(state.seats.some(s=> s.id===id)) return;
  state.seats.push({id, name:"", status:"empty", people:0, total:0, bills:0});
}

function allNameButtons(){
  // customNames ã¯ã€Œãã®ä»–ã€ã®å‰ã«å‡ºã™
  const arr = [];
  const othersIdx = state.seatSetup.baseNames.indexOf("ãã®ä»–");
  state.seatSetup.baseNames.forEach((n,i)=>{
    if(i===othersIdx){
      state.seatSetup.customNames.forEach(c=> arr.push(c));
    }
    arr.push(n);
  });
  return arr;
}

function applyDefaultCountByName(name){
  // åˆæœŸå€¤ãƒ«ãƒ¼ãƒ«
  // ãƒ†ãƒ¼ãƒ–ãƒ«ï¼åº§æ•·ï¼å€‹å®¤ â†’ 4ã€ãã‚Œä»¥å¤–ï¼ˆã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ï¼ç«‹ã¡ï¼ãã®ä»–ç³»ï¼‰â†’ 1
  const v = (name==="ãƒ†ãƒ¼ãƒ–ãƒ«" || name==="åº§æ•·" || name==="å€‹å®¤") ? 4 : 1;
  state.seatSetup.count = v;
  $("ssCntVal").textContent = String(v);
}

/* ===== Name UI ===== */
function renderNameGrid(){
  const grid = $("ssNameGrid");
  grid.innerHTML = "";
  const names = allNameButtons();

  names.forEach(n=>{
    const b = document.createElement("button");
    b.className = "seatCard";
    b.style.minHeight = "56px";
    b.style.alignItems = "center";
    b.style.justifyContent = "center";
    b.style.fontWeight = "900";
    b.textContent = n;

    const on = (state.seatSetup.selectedName === n);
    if(on){
      b.style.outline = "2px solid rgba(122,167,255,0.9)";
      b.style.background = "rgba(122,167,255,0.14)";
    }

    b.onclick = ()=>{
      state.seatSetup.selectedName = (state.seatSetup.selectedName===n) ? null : n;
      renderNameGrid();
    };

    grid.appendChild(b);
  });
}

$("ssNameCommit").onclick = ()=>{
  const pick = state.seatSetup.selectedName;
  if(!pick){
    toast("åç§°ã‚’é¸æŠã—ã¦ãã ã•ã„");
    return;
  }

  // ã€Œãã®ä»–ã€ã‚’æŠ¼ã—ã¦æ±ºå®š â†’ æ–°è¦åç§°å…¥åŠ›
  if(pick==="ãã®ä»–"){
    openModal(
      "åç§°è¿½åŠ ï¼ˆãã®ä»–ï¼‰",
      `
        <div style="margin-bottom:6px">åç§°</div>
        <input id="ssNewName" class="btn" style="width:100%; text-align:left" placeholder="ä¾‹ï¼šä¸­åº­ãƒ†ãƒ©ã‚¹A1" />
      `,
      [
        {label:"è¿½åŠ ", primary:true, onClick:()=>{
          const v = ($("ssNewName").value||"").trim();
          if(!v){ toast("åç§°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"); return; }
          if(allNameButtons().includes(v)){ toast("åŒã˜åç§°ãŒã‚ã‚Šã¾ã™"); return; }

          state.seatSetup.customNames.push(v);
          state.seatSetup.selectedName = v;
          state.seatSetup.committedName = v;

          closeModal();
          renderNameGrid();
          applyDefaultCountByName(v); // customã‚‚1æ‰±ã„
          toast("åç§°ã‚’è¿½åŠ ã—ã¾ã—ãŸ");
        }},
        {label:"æˆ»ã‚‹", onClick:()=> closeModal()},
      ]
    );
    return;
  }

  state.seatSetup.committedName = pick;
  applyDefaultCountByName(pick);
  toast(`åç§°ï¼š${pick}`);
};

/* ===== Count UI ===== */
$("ssCntMinus").onclick = ()=>{
  // ä¸‹é™ã¯ 1ï¼ˆç®±ã®æ•°ï¼‰
  state.seatSetup.count = Math.max(1, Number(state.seatSetup.count||0) - 1);
  $("ssCntVal").textContent = String(state.seatSetup.count);
};
$("ssCntPlus").onclick = ()=>{
  state.seatSetup.count = Number(state.seatSetup.count||0) + 1;
  // 0ã®ã¾ã¾åŠ ç®—ã•ã‚ŒãŸå ´åˆã‚‚ã‚ã‚‹ã®ã§1ä»¥ä¸Šã¯æ‹…ä¿
  if(state.seatSetup.count < 1) state.seatSetup.count = 1;
  $("ssCntVal").textContent = String(state.seatSetup.count);
};

/* ===== Save ===== */
$("ssSave").onclick = ()=>{
  const name = state.seatSetup.committedName;
  const cnt = Number(state.seatSetup.count||0);
  const start = ($("ssStartLabel").value||"").trim();

  if(!name){ toast("åç§°ã‚’æ±ºå®šã—ã¦ãã ã•ã„"); return; }
  if(cnt < 1){ toast("ç®±ã®æ•°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"); return; }
  if(!start){ toast("é–‹å§‹æ–‡å­—ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"); return; }

  const seatIds = buildSeatIds(start, cnt);
  if(seatIds.length===0){ toast("å¸­ç•ªå·ã‚’ä½œã‚Œã¾ã›ã‚“ã§ã—ãŸ"); return; }

  // é‡è¤‡ã¯ä½œã‚‰ãªã„ï¼ˆæ­¢ã‚ãªã„ãŒäº‹æ•…ã‚’é˜²ãï¼‰
  const unique = [];
  seatIds.forEach(id=>{
    if(state.seats.some(s=> s.id===id)) return;
    unique.push(id);
    ensureSeatExists(id);
  });

  const gid = "g" + Math.random().toString(36).slice(2);
  state.seatSetup.groups.push({
    gid,
    name,
    seatIds: unique,
    createdTs: nowTs()
  });

  // å³åæ˜ ï¼ˆãƒ¡ã‚¤ãƒ³ï¼‰
  renderSeatsWithHighlight();
  renderGroups();

  // äºŒé‡ç™»éŒ²é˜²æ­¢ï¼šå•†å“ç™»éŒ²ã¨åŒã˜æ€æƒ³ã§å…¥åŠ›ã‚’æˆ»ã™
  $("ssStartLabel").value = "";

  toast("å¸­ã‚’ä½œæˆã—ã¾ã—ãŸ");
};

/* ===== Groups Renderï¼ˆä¿å­˜ã®ä¸‹ï¼šåç§°ãƒœãƒƒã‚¯ã‚¹ã®ã¿3åˆ—ï¼‰ ===== */
function uniqueGroupNames(){
  const names = [];
  const seen = new Set();
  state.seatSetup.groups.forEach(g=>{
    if(seen.has(g.name)) return;
    seen.add(g.name);
    names.push(g.name);
  });
  return names;
}

function renderGroups(){
  const box = $("ssGroups");
  box.innerHTML = "";

  const names = uniqueGroupNames();
  if(names.length===0){
    box.innerHTML = `<div class="pill" style="grid-column:1 / -1">ã¾ã ä½œæˆã•ã‚Œã¦ã„ã¾ã›ã‚“</div>`;
    return;
  }

  names.forEach(name=>{
    const b = document.createElement("button");
    b.className = "seatCard";
    b.style.minHeight = "56px";
    b.style.display = "flex";
    b.style.alignItems = "center";
    b.style.justifyContent = "center";
    b.style.fontWeight = "900";
    b.textContent = name;
    b.onclick = ()=> openGroupEditor(name);
    box.appendChild(b);
  });
}

/* ===== Group Editorï¼ˆåç§°ã‚¿ãƒƒãƒ—ã§ï¼šæˆ»ã‚‹ãƒ»åç§°å¤‰æ›´ãƒ»å‰Šé™¤ ï¼‹ å¸­ä¸€è¦§ï¼‰ ===== */
function groupSeatIdsByName(name){
  return state.seatSetup.groups
    .filter(g=> g.name===name)
    .flatMap(g=> g.seatIds);
}

function openGroupEditor(name){
  openModal(
    "åç§°",
    `
      <div class="pill" style="margin-bottom:10px">${name}</div>

      <div style="display:flex; gap:10px; margin-bottom:10px">
        <button class="btn" id="geBack">æˆ»ã‚‹</button>
        <button class="btn primary" id="geRename">åç§°å¤‰æ›´</button>
        <button class="btn" id="geDelete">å‰Šé™¤</button>
      </div>

      <div class="pill" style="margin-bottom:8px">å¸­ä¸€è¦§</div>
      <div id="geSeats"></div>
    `,
    [
      {label:"é–‰ã˜ã‚‹", onClick:()=> closeModal()}
    ]
  );

  setTimeout(()=>{
    $("geBack").onclick = ()=> closeModal();

    $("geRename").onclick = ()=>{
      openModal(
        "åç§°å¤‰æ›´",
        `
          <div style="margin-bottom:6px">æ–°ã—ã„åç§°</div>
          <input id="geNewName" class="btn" style="width:100%; text-align:left" value="${name}" />
        `,
        [
          {label:"å¤‰æ›´", primary:true, onClick:()=>{
            const v = ($("geNewName").value||"").trim();
            if(!v){ toast("åç§°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"); return; }
            const exists = uniqueGroupNames().includes(v);
            if(exists && v!==name){ toast("åŒã˜åç§°ãŒã‚ã‚Šã¾ã™"); return; }

            // groupsæ›´æ–°
            state.seatSetup.groups.forEach(g=>{
              if(g.name===name) g.name = v;
            });

            // customNameså†…ã‚‚æ›´æ–°ï¼ˆè©²å½“ã™ã‚‹å ´åˆï¼‰
            state.seatSetup.customNames = state.seatSetup.customNames.map(x=> x===name ? v : x);

            closeModal();
            renderNameGrid();
            renderGroups();
            toast("åç§°ã‚’å¤‰æ›´ã—ã¾ã—ãŸ");
          }},
          {label:"æˆ»ã‚‹", onClick:()=> closeModal()},
        ]
      );
    };

    $("geDelete").onclick = ()=>{
      // ç¢ºèªç”»é¢ï¼šæˆ»ã‚‹ï¼‹å‰Šé™¤ã‚¹ãƒ©ã‚¤ãƒ‰ï¼ˆåç§°ã¨åç§°å†…ã®å…¨å¸­å‰Šé™¤ï¼‰
      openModal(
        "å‰Šé™¤ç¢ºèª",
        `
          <div class="pill" style="margin-bottom:8px; color:var(--danger)">ã“ã®åç§°ã¨åç§°å†…ã®å…¨å¸­ã‚’å‰Šé™¤ã—ã¾ã™</div>
          <div class="pill" style="margin-bottom:10px">ä½¿ç”¨ä¸­ï¼æœªä¼šè¨ˆã®å¸­ãŒã‚ã‚‹å ´åˆã¯å‰Šé™¤ã§ãã¾ã›ã‚“</div>
          <input id="geDelSlide" class="kRange" type="range" min="0" max="100" value="0"/>
        `,
        [
          {label:"æˆ»ã‚‹", onClick:()=> closeModal()}
        ]
      );

      setTimeout(()=>{
        const slide = $("geDelSlide");
        slide.onchange = ()=>{
          if(Number(slide.value||0) < 88){ slide.value = 0; return; }

          const ids = groupSeatIdsByName(name);
          // ä½¿ç”¨ä¸­ãƒã‚§ãƒƒã‚¯ï¼ˆemptyä»¥å¤–ã¯ãƒ–ãƒ­ãƒƒã‚¯ï¼‰
          const blocked = ids.some(id=>{
            const seat = state.seats.find(s=> s.id===id);
            return seat && seat.status !== "empty";
          });
          if(blocked){
            slide.value = 0;
            toast("ä½¿ç”¨ä¸­ã®å¸­ãŒã‚ã‚‹ãŸã‚å‰Šé™¤ã§ãã¾ã›ã‚“");
            return;
          }

          // seatsã‹ã‚‰å‰Šé™¤
          ids.forEach(id=>{
            state.seats = state.seats.filter(s=> s.id!==id);
          });

          // groupså‰Šé™¤
          state.seatSetup.groups = state.seatSetup.groups.filter(g=> g.name!==name);

          // customNamesã‹ã‚‰ã‚‚å‰Šé™¤ï¼ˆè©²å½“ã™ã‚‹å ´åˆï¼‰
          state.seatSetup.customNames = state.seatSetup.customNames.filter(x=> x!==name);

          closeModal(); // ç¢ºèª
          closeModal(); // ç·¨é›†
          renderSeatsWithHighlight();
          renderGroups();
          renderNameGrid();
          toast("å‰Šé™¤ã—ã¾ã—ãŸ");
        };
      },0);
    };

    // å¸­ä¸€è¦§ï¼ˆç•ªå·å¤‰æ›´ãƒœã‚¿ãƒ³ï¼‹å‰Šé™¤ã‚¹ãƒ©ã‚¤ãƒ‰ï½œå€‹åˆ¥å‰Šé™¤ã¯ç¢ºèªãªã—ï¼‰
    const list = $("geSeats");
    const ids = groupSeatIdsByName(name);

    if(ids.length===0){
      list.innerHTML = `<div class="pill">å¸­ãŒã‚ã‚Šã¾ã›ã‚“</div>`;
      return;
    }

    list.innerHTML = "";
    ids.forEach(id=>{
      const seat = state.seats.find(s=> s.id===id);
      const inUse = seat && seat.status !== "empty";

      const row = document.createElement("div");
      row.className = "kRow";
      row.innerHTML = `
        <div class="kLeft">
          <div class="kSeat">${id}</div>
          <div class="kName" style="color:${inUse ? "var(--danger)" : "var(--text)"}">
            ${inUse ? "ä½¿ç”¨ä¸­ã®ãŸã‚å‰Šé™¤ä¸å¯" : ""}
          </div>
        </div>
        <div class="kSlide" style="flex-direction:column; align-items:flex-end; gap:6px">
          <button class="btn" data-rename-seat="${id}">ç•ªå·å¤‰æ›´</button>
          <input class="kRange" data-del-seat="${id}" type="range" min="0" max="100" value="0" ${inUse ? "disabled" : ""}/>
        </div>
      `;
      list.appendChild(row);
    });

    // ç•ªå·å¤‰æ›´
    list.querySelectorAll("[data-rename-seat]").forEach(btn=>{
      btn.onclick = ()=>{
        const oldId = btn.getAttribute("data-rename-seat");
        openModal(
          "å¸­ç•ªå·å¤‰æ›´",
          `
            <div style="margin-bottom:6px">ç¾åœ¨ï¼š${oldId}</div>
            <div style="margin-bottom:6px">æ–°ã—ã„å¸­ç•ªå·</div>
            <input id="geSeatNewId" class="btn" style="width:100%; text-align:left" placeholder="ä¾‹ï¼šA / 1 / ã‚" />
          `,
          [
            {label:"å¤‰æ›´", primary:true, onClick:()=>{
              const newId = ($("geSeatNewId").value||"").trim();
              if(!newId){ toast("å¸­ç•ªå·ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"); return; }
              if(state.seats.some(s=> s.id===newId)){ toast("åŒã˜å¸­ç•ªå·ãŒã‚ã‚Šã¾ã™"); return; }

              const seat = state.seats.find(s=> s.id===oldId);
              if(seat) seat.id = newId;

              state.seatSetup.groups.forEach(g=>{
                if(g.name===name){
                  g.seatIds = g.seatIds.map(x=> x===oldId ? newId : x);
                }
              });

              closeModal();
              renderSeatsWithHighlight();
              // ç·¨é›†ç”»é¢ã‚’é–‰ã˜ãšã«åæ˜ ï¼ˆä½¿ã„ã‚„ã™ã•å„ªå…ˆï¼‰
              list.querySelectorAll(".kSeat").forEach(el=>{
                if(el.textContent===oldId) el.textContent = newId;
              });
              toast("å¸­ç•ªå·ã‚’å¤‰æ›´ã—ã¾ã—ãŸ");
            }},
            {label:"æˆ»ã‚‹", onClick:()=> closeModal()},
          ]
        );
      };
    });

    // å€‹åˆ¥å‰Šé™¤ï¼ˆã‚¹ãƒ©ã‚¤ãƒ‰ç¢ºå®šãƒ»ç¢ºèªãªã—ï¼‰
    list.querySelectorAll("[data-del-seat]").forEach(sl=>{
      sl.onchange = ()=>{
        if(sl.disabled) return;
        if(Number(sl.value||0) < 88){ sl.value = 0; return; }

        const id = sl.getAttribute("data-del-seat");
        const seat = state.seats.find(s=> s.id===id);
        if(seat && seat.status !== "empty"){
          sl.value = 0;
          toast("ä½¿ç”¨ä¸­ã®ãŸã‚å‰Šé™¤ã§ãã¾ã›ã‚“");
          return;
        }

        state.seats = state.seats.filter(s=> s.id!==id);
        state.seatSetup.groups.forEach(g=>{
          if(g.name===name) g.seatIds = g.seatIds.filter(x=> x!==id);
        });
        // ç©ºã«ãªã£ãŸã‚°ãƒ«ãƒ¼ãƒ—ã¯å‰Šé™¤
        state.seatSetup.groups = state.seatSetup.groups.filter(g=> !(g.name===name && g.seatIds.length===0));

        // è¡Œã‚’æ¶ˆã—ã¦åæ˜ 
        sl.closest(".kRow")?.remove();

        renderSeatsWithHighlight();
        renderGroups();
        toast("å‰Šé™¤ã—ã¾ã—ãŸ");
      };
    });

  },0);
}

/* ===== showScreenæ‹¡å¼µ ===== */
(function hookShowScreenForSeatSetup(){
  if(showScreen._ssHooked) return;
  const _show = showScreen;
  showScreen = function(id){
    _show(id);
    if(id==="scrSeatSetup"){
      renderNameGrid();
      renderGroups();
    }
  };
  showScreen._ssHooked = true;
})();

/* åˆæœŸæç”» */
renderNameGrid();
renderGroups();

/* =========================
  ã“ã“ã‹ã‚‰å…ˆã¯ PART7 ã§ç¶šã
========================= */
/* =========================
  PART7ï¼šåŒæœŸãƒ»ç«¯æœ«ç®¡ç†ãƒ»ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ï¼ˆä¿å­˜ï¼‰
  å½¹å‰²ï¼šğŸ“¶/ğŸ“¶âŒè¡¨ç¤ºãƒ»æœªåŒæœŸã‚¤ãƒ™ãƒ³ãƒˆã‚­ãƒ¥ãƒ¼ãƒ»ä¿å­˜ã§å†é€ãƒ»10åˆ†ãŠãé™ã‹ãªè©¦è¡Œãƒ»ç«¯æœ«3å°åˆ¶é™
  æ–¹é‡ï¼šå‹æ‰‹ã«åŒæœŸã—ãªã„ï¼ç¾å ´ã‚’æ­¢ã‚ãªã„ï¼æ¶ˆã•ãªã„ï¼å·®åˆ†ã‚¤ãƒ™ãƒ³ãƒˆã§æ•´åˆ
  â˜…ä¿®æ­£ï¼šãƒ¡ã‚¤ãƒ³ã®ã€ŒåŒæœŸçŠ¶æ…‹ï¼šã€œã€ãƒ†ã‚­ã‚¹ãƒˆã¯å¸¸ã«éè¡¨ç¤ºï¼ˆã‚¢ã‚¤ã‚³ãƒ³ã®ã¿ï¼‰
========================= */

/* ===== Storage helpers ===== */
function loadStore(){
  try{
    const raw = localStorage.getItem(KEY);
    if(!raw) return null;
    return JSON.parse(raw);
  }catch(e){
    return null;
  }
}
function saveStore(obj){
  localStorage.setItem(KEY, JSON.stringify(obj));
}

/* ===== UI: Sync text OFF (ç¢ºå®š) ===== */
function hideSyncText(){
  // ãƒ¡ã‚¤ãƒ³ã®ã€ŒåŒæœŸçŠ¶æ…‹ï¼šã€œã€ã¯å‡ºã•ãªã„ï¼ˆã‚¢ã‚¤ã‚³ãƒ³ã®ã¿ï¼‰
  const pill = $("syncPill");
  if(pill) pill.style.display = "none";
}

/* ===== Device ID / Device limit (FREE: 3) ===== */
function getDeviceId(){
  const k = KEY + "_DEVICE_ID";
  let id = localStorage.getItem(k);
  if(!id){
    id = "dev_" + Math.random().toString(36).slice(2);
    localStorage.setItem(k, id);
  }
  return id;
}

state.sync = state.sync || {
  deviceId: getDeviceId(),
  devices: [],           // ç«¯æœ«IDä¸€è¦§
  pending: [],           // æœªåŒæœŸã‚¤ãƒ™ãƒ³ãƒˆ
  lastTryTs: 0,
  maxDevicesFree: 3,
  canSync: true
};

function ensureDeviceRegistered(){
  const st = loadStore() || {};
  st.devices = Array.isArray(st.devices) ? st.devices : [];

  if(!st.devices.includes(state.sync.deviceId)){
    st.devices.push(state.sync.deviceId);
  }

  state.sync.devices = st.devices.slice();
  saveStore(st);

  // 3å°åˆ¶é™ï¼ˆè¶…éã—ã¦ã‚‚ãƒ­ãƒ¼ã‚«ãƒ«æ“ä½œã¯å¯èƒ½ãƒ»åŒæœŸã ã‘ä¸å¯ï¼‰
  state.sync.canSync = (state.sync.devices.length <= state.sync.maxDevicesFree);
  return state.sync.canSync;
}

/* ===== Sync icon update ===== */
function setSync(ok){
  // â˜…ãƒ†ã‚­ã‚¹ãƒˆã¯å¸¸ã«éš ã™
  hideSyncText();

  state.syncOk = !!ok;

  // ã‚¢ãƒ³ãƒ†ãƒŠã®âŒã ã‘ã§è¡¨ç¾
  $("btnAntenna").classList.toggle("off", !ok);

  // æ–‡å­—ãƒ©ãƒ™ãƒ«ã¯æ›´æ–°ã—ãªã„ï¼ˆå‡ºã•ãªã„ï¼‰
  // const lbl = $("syncLabel"); if(lbl) lbl.textContent = ok ? "åŒæœŸã•ã‚Œã¦ã„ã¾ã™" : "åŒæœŸã•ã‚Œã¦ã„ã¾ã›ã‚“";
}

/* ===== Persist app state ===== */
function persistAll(){
  const st = loadStore() || {};
  st.devices = state.sync.devices.slice();
  st.seats = state.seats;
  st.seatSetup = state.seatSetup;
  st.kitchen = state.kitchen;
  st.sales = state.sales;
  st.fix = state.fix;
  st.pending = state.sync.pending;
  st.updatedTs = nowTs();
  saveStore(st);
}

function restoreAll(){
  const st = loadStore();
  if(!st) return;

  if(Array.isArray(st.seats)) state.seats = st.seats;
  if(st.seatSetup) state.seatSetup = st.seatSetup;
  if(st.kitchen) state.kitchen = st.kitchen;
  if(st.sales) state.sales = st.sales;
  if(st.fix) state.fix = st.fix;

  state.sync.devices = Array.isArray(st.devices) ? st.devices : [];
  state.sync.pending = Array.isArray(st.pending) ? st.pending : [];

  // åŒæœŸçŠ¶æ…‹ï¼ˆpendingãŒç„¡ã„ï¼OKï¼‰
  setSync(state.sync.pending.length === 0);
}

/* ===== Event queue (å·®åˆ†ã‚¤ãƒ™ãƒ³ãƒˆ) ===== */
function emitEvent(type, payload){
  const ev = {
    id: "ev_" + Math.random().toString(36).slice(2),
    type,
    ts: nowTs(),
    deviceId: state.sync.deviceId,
    payload: payload || {}
  };
  state.sync.pending.push(ev);

  // æœªåŒæœŸãŒã‚ã‚‹ï¼ğŸ“¶âŒ
  setSync(false);
  persistAll();

  // å–¶æ¥­ä¸­ï¼šé™ã‹ã«1å›ã ã‘è©¦ã™ï¼ˆé€£æ‰“é˜²æ­¢ã‚ã‚Šï¼‰
  trySyncOnceSilent();
}

/* ===== Sync attempt (ç–‘ä¼¼) ===== */
function canActuallySync(){
  // ç«¯æœ«3å°åˆ¶é™
  if(!ensureDeviceRegistered()){
    return false;
  }
  // é€šä¿¡ç’°å¢ƒï¼ˆç–‘ä¼¼ï¼‰ï¼šã‚ªãƒ³ãƒ©ã‚¤ãƒ³ã ã‘æˆåŠŸæ‰±ã„
  if(typeof navigator !== "undefined" && navigator.onLine === false){
    return false;
  }
  return true;
}

function trySyncOnceSilent(){
  // é€šå¸¸æ“ä½œã§ã®åŒæœŸã¯ã€Œ1å›ã ã‘è»½ãã€è©¦ã™ï¼ˆå¤±æ•—ã—ã¦ã‚‚é€šçŸ¥ãªã—ï¼‰
  if(state.sync.pending.length === 0) return;

  const now = nowTs();
  // é€£æ‰“é˜²æ­¢ï¼šç›´è¿‘10ç§’ä»¥å†…ã¯è©¦ã•ãªã„
  if(now - state.sync.lastTryTs < 10_000) return;
  state.sync.lastTryTs = now;

  if(!canActuallySync()){
    // ğŸ“¶âŒã®ã¾ã¾ï¼ˆé™ã‹ï¼‰
    return;
  }

  // æˆåŠŸæ‰±ã„ï¼špendingã‚’ã‚¯ãƒªã‚¢
  state.sync.pending = [];
  setSync(true);
  persistAll();
}

function manualSync(){
  // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã€ŒåŒæœŸé–‹å§‹ã€ã‚’æŠ¼ã—ãŸæ™‚ã ã‘ã€ã¾ã¨ã‚ã¦å†é€
  if(state.sync.pending.length === 0){
    setSync(true);
    toast("åŒæœŸã•ã‚Œã¦ã„ã¾ã™");
    return;
  }

  // 3å°åˆ¶é™ã®èª¬æ˜
  if(!ensureDeviceRegistered()){
    openModal(
      "åŒæœŸ",
      "ç„¡æ–™ç‰ˆã§ã¯åŒæœŸã§ãã‚‹ç«¯æœ«ã¯3å°ã¾ã§ã§ã™<br>æœ‰æ–™ç‰ˆã§ã¯åˆ©ç”¨å¯èƒ½ãªç«¯æœ«æ•°ãŒå¢—ãˆã¾ã™",
      [{label:"æˆ»ã‚‹", onClick:()=> closeModal()}]
    );
    return;
  }

  if(!canActuallySync()){
    toast("åŒæœŸã§ãã¾ã›ã‚“ã§ã—ãŸï¼ˆé›»æ³¢çŠ¶æ³ã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼‰");
    setSync(false);
    persistAll();
    return;
  }

  // æˆåŠŸ
  state.sync.pending = [];
  setSync(true);
  persistAll();
  toast("åŒæœŸã—ã¾ã—ãŸ");
}

/* ===== Auto silent trial (ç¢ºå®šï¼šæœªåŒæœŸãŒã‚ã‚‹æ™‚ã®ã¿ 10åˆ†ãŠãã«1å›) ===== */
(function startAutoTrial(){
  if(startAutoTrial._started) return;
  startAutoTrial._started = true;

  setInterval(()=>{
    if(state.sync.pending.length === 0) return;
    // é™ã‹ã«1å›ã ã‘è©¦è¡Œï¼ˆé€šçŸ¥ãªã—ï¼‰
    trySyncOnceSilent();
  }, 10 * 60 * 1000);
})();

/* ===== Save (ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—) ===== */
function openSaveModal(){
  openModal(
    "ä¿å­˜",
    "æ³¨æ–‡ãƒ»ä¼šè¨ˆãƒ»å¸­æƒ…å ±ã¯ç«¯æœ«é–“ã§è‡ªå‹•åŒæœŸã•ã‚Œã¾ã™ï¼ˆé›»æ³¢çŠ¶æ³ãŒè‰¯å¥½ãªå ´åˆï¼‰<br><br>âš ï¸ å–¶æ¥­çµ‚äº†æ™‚ãƒ»é€€å‹¤æ™‚ã«ã¯å¿…ãšä¿å­˜ã‚’è¡Œã£ã¦ãã ã•ã„",
    [
      {label:"ç¢ºå®šä¿å­˜", primary:true, onClick:()=>{
        closeModal();
        performSave();
      }},
      {label:"æˆ»ã‚‹", onClick:()=> closeModal()},
    ]
  );
}

function performSave(){
  // 1) ç«¯æœ«å†…ãƒ‡ãƒ¼ã‚¿ã‚’ç¢ºå®šä¿å­˜
  ensureDeviceRegistered();
  persistAll();

  // 2) æœªåŒæœŸã‚¤ãƒ™ãƒ³ãƒˆãŒã‚ã‚Œã°ã€Œæ˜ç¤ºçš„åŒæœŸã€ã‚’è©¦ã¿ã‚‹ï¼ˆä¿å­˜ï¼å†åŒæœŸï¼‰
  if(state.sync.pending.length){
    manualSync();
  }else{
    setSync(true);
    toast("ä¿å­˜ã—ã¾ã—ãŸ");
  }
}

/* ===== Antenna tap behavior (ç¢ºå®šä»•æ§˜) ===== */
function openSyncModal(){
  // ãƒ†ã‚­ã‚¹ãƒˆã¯å¸¸ã«éš ã™
  hideSyncText();

  if(state.sync.pending.length === 0 && state.sync.canSync !== false){
    openModal("åŒæœŸ", "åŒæœŸã•ã‚Œã¦ã„ã¾ã™", [
      {label:"æˆ»ã‚‹", onClick:()=> closeModal()}
    ]);
    return;
  }

  // ç«¯æœ«åˆ¶é™ã«å¼•ã£ã‹ã‹ã£ã¦ã„ã‚‹å ´åˆ
  if(state.sync.canSync === false){
    openModal(
      "åŒæœŸ",
      "ç„¡æ–™ç‰ˆã§ã¯åŒæœŸã§ãã‚‹ç«¯æœ«ã¯3å°ã¾ã§ã§ã™<br>æœ‰æ–™ç‰ˆã§ã¯åˆ©ç”¨å¯èƒ½ãªç«¯æœ«æ•°ãŒå¢—ãˆã¾ã™",
      [
        {label:"æˆ»ã‚‹", onClick:()=> closeModal()}
      ]
    );
    return;
  }

  openModal(
    "åŒæœŸ",
    "åŒæœŸã•ã‚Œã¦ã„ã¾ã›ã‚“<br>é›»æ³¢çŠ¶æ³ã‚„ä¸€æ™‚çš„ãªä¸å…·åˆã®å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™<br>ä¿å­˜ã‚’è¡Œã†ã¨å†åŒæœŸã‚’è©¦ã¿ã¾ã™",
    [
      {label:"åŒæœŸé–‹å§‹", primary:true, onClick:()=>{
        closeModal();
        manualSync();
      }},
      {label:"æˆ»ã‚‹", onClick:()=> closeModal()},
    ]
  );
}

/* ===== Hook header buttons (ä¸Šæ›¸ã) ===== */
(function hookHeaderButtonsPart7(){
  // ä¿å­˜ãƒœã‚¿ãƒ³ï¼šPART1ã®ä»®å‡¦ç†ã‚’ä¸Šæ›¸ã
  $("btnSave").onclick = ()=> openSaveModal();

  // ã‚¢ãƒ³ãƒ†ãƒŠï¼šPART1ã®ä»®å‡¦ç†ã‚’ä¸Šæ›¸ã
  $("btnAntenna").onclick = ()=> openSyncModal();
})();

/* ===== Patch operations to emit events (å·®åˆ†) ===== */
(function patchOps(){
  // å¸­ç§»å‹•
  if(typeof doSeatMove === "function" && !doSeatMove._patched){
    const _m = doSeatMove;
    doSeatMove = function(fromId, toId){
      _m(fromId, toId);
      emitEvent("seat_move", {fromId, toId});
    };
    doSeatMove._patched = true;
  }

  // ä¼šè¨ˆåˆç®—
  if(typeof doMerge === "function" && !doMerge._patched){
    const _g = doMerge;
    doMerge = function(seat, pickedBills){
      _g(seat, pickedBills);
      emitEvent("bill_merge", {seatId: seat.id, pickedBills});
    };
    doMerge._patched = true;
  }

  // ä¼šè¨ˆåˆ†å‰²
  if(typeof doSplit === "function" && !doSplit._patched){
    const _s = doSplit;
    doSplit = function(seat){
      _s(seat);
      emitEvent("bill_split", {seatId: seat.id});
    };
    doSplit._patched = true;
  }

  // å¸­ç™»éŒ² ä¿å­˜ï¼ˆPART6ã®onclickã‚’ãƒ©ãƒƒãƒ—ï¼‰
  if($("ssSave") && !$("ssSave")._patched){
    const old = $("ssSave").onclick;
    $("ssSave").onclick = ()=>{
      old && old();
      emitEvent("seat_setup_save", {ts: nowTs()});
    };
    $("ssSave")._patched = true;
  }
})();

/* ===== Boot (restore + device register) ===== */
(function bootPart7(){
  // ã¾ãšUIï¼šåŒæœŸãƒ†ã‚­ã‚¹ãƒˆOFF
  hideSyncText();

  ensureDeviceRegistered();
  restoreAll();

  // pendingãŒã‚ã‚Œã°ğŸ“¶âŒ
  if(state.sync.pending.length){
    setSync(false);
  }else{
    setSync(true);
  }

  // ç«¯æœ«åˆ¶é™ã®çŠ¶æ…‹ã‚’åæ˜ 
  ensureDeviceRegistered();
  // å¿µã®ãŸã‚ã‚‚ã†ä¸€å›ï¼šæ–‡å­—ã¯å‡ºã•ãªã„
  hideSyncText();
})();

/* =========================
  ã“ã“ã‹ã‚‰å…ˆã¯ PART8 ã§ç¶šã
========================= */
/* =========================
  PART8ï¼šè¨­å®šãƒ»ãƒ˜ãƒ«ãƒ—ãƒ»æœ‰æ–™å°ç·š ï¼‹ ãƒ¡ãƒ‹ãƒ¥ãƒ¼ç™»éŒ²
  å½¹å‰²ï¼šå–¶æ¥­ä¸­ã¯åŸºæœ¬è§¦ã‚‰ãªã„é ˜åŸŸï¼è‡ªå·±è§£æ±ºï¼å•ã„åˆã‚ã›ï¼æœ‰æ–™æ¡ˆå†…ï¼ˆæ§ãˆã‚ï¼‰
        ï¼‹ ãƒ¡ãƒ‹ãƒ¥ãƒ¼ç™»éŒ²ï¼ˆæ–™ç†/ãƒ‰ãƒªãƒ³ã‚¯â†’ã‚¸ãƒ£ãƒ³ãƒ«â†’å•†å“ç™»éŒ²ï¼‰
  é‡è¦ï¼šã“ã“ã§HTMLã‚’é–‰ã˜ã¦8åˆ†å‰²å®Œæˆ
========================= */

/* =========================================================
   A) è¨­å®šï¼ˆscrSettingsï¼‰
========================================================= */
(function buildSettingsUI(){
  const scr = $("scrSettings");
  scr.innerHTML = `
    <div class="pill" style="margin-bottom:10px">è¨­å®š</div>

    <button class="btn" id="goHelp" style="width:100%; margin-bottom:10px">ãƒ˜ãƒ«ãƒ— / Q&A</button>
    <button class="btn" id="goContact" style="width:100%; margin-bottom:10px">ãŠå•åˆã›</button>
    <button class="btn" id="goTerms" style="width:100%; margin-bottom:10px">åˆ©ç”¨æ¡ä»¶ãƒ»æ³¨æ„äº‹é …</button>

    <div style="height:10px"></div>

    <div class="pill" style="margin-bottom:8px">ç„¡æ–™ç‰ˆã«ã¤ã„ã¦</div>
    <div class="pill" style="color:var(--muted); margin-bottom:10px">
      ãƒ»åˆ©ç”¨å¯èƒ½ç«¯æœ«ï¼šæœ€å¤§3å°<br>
      ãƒ»ãƒ‡ãƒ¼ã‚¿ã®å¾©æ—§ã€ä¿è¨¼ãªã—<br>
      ãƒ»ã‚µãƒãƒ¼ãƒˆã¯é™å®šçš„
    </div>

    <div class="pill" style="margin-bottom:8px">æœ‰æ–™ç‰ˆã®ã”æ¡ˆå†…</div>
    <div class="pill" style="color:var(--muted); margin-bottom:10px">
      ãƒ»åˆ©ç”¨ç«¯æœ«æ•°ã®æ‹¡å¼µ<br>
      ãƒ»ãƒ‡ãƒ¼ã‚¿ã®å®‰å…¨ãªä¿å­˜<br>
      ãƒ»ã‚µãƒãƒ¼ãƒˆå¯¾å¿œ<br>
      ãƒ»ç¨ç†å£«ã€ä¼šè¨ˆã‚½ãƒ•ãƒˆå‘ã‘ãƒ‡ãƒ¼ã‚¿å‡ºåŠ›<br>
      ãƒ»å£²ä¸Šåˆ†æã€ã‚°ãƒ©ãƒ•è¡¨ç¤º<br>
      ãƒ»AIã«ã‚ˆã‚‹æ–™ç†ãƒ»ãƒ¡ãƒ‹ãƒ¥ãƒ¼ææ¡ˆ<br>
      ãƒ»å°†æ¥è¿½åŠ ã•ã‚Œã‚‹æ–°æ©Ÿèƒ½
    </div>

    <div class="pill" style="margin-bottom:8px">ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±</div>
    <div class="pill" style="color:var(--muted)">
      ONE<br>
      Versionï¼šFREE 0.1.0<br>
      æ›´æ–°æ—¥ï¼š2026/02/10<br>
      ç¾åœ¨ã¯ç„¡æ–™ç‰ˆã§ã™
    </div>
  `;
})();

/* =========================================================
   B) ãƒ˜ãƒ«ãƒ— / Q&Aï¼ˆãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤ºï¼‰
========================================================= */
const QA_LIST = [
  {q:"ä¼šè¨ˆåˆç®—ã¯ã©ã†ã‚„ã£ã¦è¡Œã„ã¾ã™ã‹ï¼Ÿ", a:"åŒã˜å¸­å†…ã«ã‚ã‚‹è¤‡æ•°ã®ä¼šè¨ˆã‚’ã€ä¼šè¨ˆåˆç®—ãƒœã‚¿ãƒ³ã§ã¾ã¨ã‚ã¾ã™ã€‚åˆ¥ã®å¸­åŒå£«ã‚’ç›´æ¥åˆç®—ã™ã‚‹ã“ã¨ã¯ã§ãã¾ã›ã‚“ã€‚åˆ¥å¸­ã‚’ã¾ã¨ã‚ãŸã„å ´åˆã¯ã€å…ˆã«å¸­ç§»å‹•ã§åŒã˜å¸­ã«é›†ã‚ã¦ãã ã•ã„ã€‚"},
  {q:"åˆ¥ã®å¸­åŒå£«ã‚’ç›´æ¥åˆç®—ã§ããªã„ã®ã¯ãªãœã§ã™ã‹ï¼Ÿ", a:"æ“ä½œãƒŸã‚¹ã‚„ä¼šè¨ˆäº‹æ•…ã‚’é˜²ããŸã‚ã§ã™ã€‚ONEã§ã¯ã€Œå¸­ï¼ä¼šè¨ˆã®ç®±ã€ã¨ã—ã¦ç®¡ç†ã—ã¦ã„ã‚‹ãŸã‚ã€åˆç®—ã¯å¿…ãšåŒä¸€å¸­å†…ã§è¡Œã†è¨­è¨ˆã«ãªã£ã¦ã„ã¾ã™ã€‚"},
  {q:"å¸­ç§»å‹•ã¨ä¼šè¨ˆåˆç®—ã®é•ã„ã¯ä½•ã§ã™ã‹ï¼Ÿ", a:"å¸­ç§»å‹•ã¯ã€ç‰©ç†çš„ã«ãŠå®¢ã•ã¾ãŒå¸­ã‚’ç§»ã£ãŸæ™‚ã®æ“ä½œã§ã™ã€‚ä¼šè¨ˆåˆç®—ã¯ã€åŒã˜å¸­ã®ä¸­ã«ã‚ã‚‹ä¼šè¨ˆã‚’ã¾ã¨ã‚ã‚‹æ“ä½œã§ã™ã€‚ç›®çš„ãŒé•ã†ãŸã‚ã€æ“ä½œã‚‚åˆ†ã‹ã‚Œã¦ã„ã¾ã™ã€‚"},
  {q:"ä¼šè¨ˆåˆ†å‰²ã¯ã„ã¤ã§ãã¾ã™ã‹ï¼Ÿ", a:"åŒä¸€å¸­å†…ã§ã€åˆç®—ã•ã‚Œã¦ã„ã‚‹ä¼šè¨ˆã‚’å…ƒã«æˆ»ã—ãŸã„æ™‚ã«è¡Œã„ã¾ã™ã€‚ãªãŠã€åˆç®—å¾Œã«è¿½åŠ ã•ã‚ŒãŸæ³¨æ–‡ã¯åˆ†å‰²ã§ãã¾ã›ã‚“ã€‚"},
  {q:"å•†å“ãŒæ¥ãªã‹ã£ãŸå ´åˆã®ä¿®æ­£æ–¹æ³•ã¯ï¼Ÿ", a:"ä¼šè¨ˆç¢ºå®šå‰ã§ã‚ã‚Œã°ã€æ³¨æ–‡ç”»é¢ã‹ã‚‰è©²å½“å•†å“ã‚’å–æ¶ˆã—ã¦ãã ã•ã„ã€‚å–æ¶ˆã¯ã€Œâˆ’æ³¨æ–‡ã€ã¨ã—ã¦å±¥æ­´ã«æ®‹ã‚Šã¾ã™ã€‚"},
  {q:"æ³¨æ–‡æ•°ã‚’é–“é•ãˆãŸæ™‚ã¯ã©ã†ãªã‚Šã¾ã™ã‹ï¼Ÿ", a:"æ³¨æ–‡ç”»é¢ã®ã€Œæ³¨æ–‡å±¥æ­´ã€ã‚’ã‚¿ãƒƒãƒ—ã™ã‚‹ã“ã¨ã§ä¿®æ­£ã§ãã¾ã™ã€‚æ³¨æ–‡å¾Œã§ã‚‚å–æ¶ˆãŒå¯èƒ½ã§ã€0ä»¥ä¸‹ã«ã¯ãªã‚Šã¾ã›ã‚“ã€‚ä¿®æ­£å†…å®¹ã¯å±¥æ­´ã¨ã—ã¦æ®‹ã‚Šã¾ã™ã€‚"},
  {q:"ã‚­ãƒƒãƒãƒ³ç”»é¢ã®ä¸¦ã³é †ã¯ã©ã†ãªã£ã¦ã„ã¾ã™ã‹ï¼Ÿ", a:"æœªèª¿ç†ã®å•†å“ãŒä¸Šã«è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚åŒã˜å•†å“ãŒã‚ã‚‹å ´åˆã¯ã€ã¾ã¨ã‚ã¦è¡¨ç¤ºã•ã‚Œã‚‹ãŸã‚ã€ã¾ã¨ã‚ã¦èª¿ç†ã—ã‚„ã™ããªã£ã¦ã„ã¾ã™ã€‚"},
  {q:"èª¿ç†å®Œäº†ã¯ã©ã†ã‚„ã£ã¦è¡Œã„ã¾ã™ã‹ï¼Ÿ", a:"è©²å½“å•†å“ã®ã‚¹ãƒ©ã‚¤ãƒ‰æ“ä½œã§èª¿ç†å®Œäº†ã¨ãªã‚Šã¾ã™ã€‚ã‚¿ãƒƒãƒ—ã ã‘ã§ã¯å®Œäº†ã—ãªã„ãŸã‚ã€èª¤æ“ä½œã‚’é˜²ã’ã¾ã™ã€‚"},
  {q:"æ³¨æ–‡å–æ¶ˆã¯ã‚­ãƒƒãƒãƒ³ã«ã©ã†è¡¨ç¤ºã•ã‚Œã¾ã™ã‹ï¼Ÿ", a:"å–æ¶ˆã•ã‚ŒãŸæ³¨æ–‡ã¯ã€ã‚­ãƒƒãƒãƒ³ç”»é¢ã‹ã‚‰è‡ªå‹•çš„ã«é™¤å¤–ã•ã‚Œã¾ã™ã€‚ã™ã§ã«æä¾›æ¸ˆã¿ã®å•†å“ã«ã¯å½±éŸ¿ã—ã¾ã›ã‚“ã€‚"},
  {q:"é›»æ³¢ãŒãªã„å ´æ‰€ã§ã‚‚ä½¿ãˆã¾ã™ã‹ï¼Ÿ", a:"ä½¿ãˆã¾ã™ã€‚æ³¨æ–‡ãƒ»ä¼šè¨ˆãƒ»å¸­æ“ä½œã¯ç«¯æœ«å†…ã«ä¿å­˜ã•ã‚Œã¾ã™ã€‚ãŸã ã—ã€ç«¯æœ«é–“ã§ã®ãƒ‡ãƒ¼ã‚¿å…±æœ‰ã¯è¡Œã‚ã‚Œãªã„ãŸã‚ã€é€šä¿¡ç’°å¢ƒãŒæ•´ã£ã¦ã„ã‚‹å ´æ‰€ã§ã®åˆ©ç”¨ã‚’æ¨å¥¨ã—ã¾ã™ã€‚"},
  {q:"åŒæœŸãƒãƒ¼ã‚¯âŒãŒå‡ºãŸæ™‚ã¯ã©ã†ã™ã‚Œã°ã„ã„ã§ã™ã‹ï¼Ÿ", a:"é›»æ³¢çŠ¶æ³ã‚„ä¸€æ™‚çš„ãªä¸å…·åˆã«ã‚ˆã‚Šã€åŒæœŸã§ãã¦ã„ãªã„çŠ¶æ…‹ã§ã™ã€‚é›»æ³¢ã®è‰¯ã„å ´æ‰€ã§åŒæœŸã‚’è¡Œã£ã¦ãã ã•ã„ã€‚çŠ¶æ³ã«ã‚ˆã£ã¦ã¯ã€è‡ªå‹•çš„ã«å†åŒæœŸã•ã‚Œã‚‹å ´åˆã‚‚ã‚ã‚Šã¾ã™ã€‚"},
  {q:"è¤‡æ•°ç«¯æœ«ã§åŒæ™‚ã«ä½¿ãˆã¾ã™ã‹ï¼Ÿ", a:"ç„¡æ–™ç‰ˆã§ã¯æœ€å¤§3å°ã¾ã§ä½¿ç”¨ã§ãã¾ã™ã€‚æ³¨æ–‡ç¢ºå®šã‚„ä¼šè¨ˆç¢ºå®šãªã©ã€æ±ºå®šã‚’ä¼´ã†æ“ä½œã”ã¨ã«ç«¯æœ«é–“ã§åŒæœŸã•ã‚Œã¾ã™ã€‚"},
  {q:"ãƒ‡ãƒ¼ã‚¿ã¯ã©ã“ã«ä¿å­˜ã•ã‚Œã¦ã„ã¾ã™ã‹ï¼Ÿ", a:"ã™ã¹ã¦ä½¿ç”¨ã—ã¦ã„ã‚‹ç«¯æœ«å†…ã«ä¿å­˜ã•ã‚Œã¾ã™ã€‚ç«¯æœ«ã®æ•…éšœãƒ»ç´›å¤±ãƒ»ä¸å…·åˆã«å‚™ãˆã€å£²ä¸Šç®¡ç†ã‹ã‚‰å®šæœŸçš„ã«ãƒ‡ãƒ¼ã‚¿ã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’è¡Œã£ã¦ãã ã•ã„ã€‚"},
  {q:"æ©Ÿç¨®å¤‰æ›´ã—ãŸå ´åˆã¯ã©ã†ãªã‚Šã¾ã™ã‹ï¼Ÿ", a:"ç«¯æœ«å†…ã®ãƒ‡ãƒ¼ã‚¿ã¯è‡ªå‹•ã§ã¯å¼•ãç¶™ãŒã‚Œã¾ã›ã‚“ã€‚äº‹å‰ã«ä¿å­˜ã‚„ãƒ‡ãƒ¼ã‚¿é€ä¿¡ã‚’è¡Œã£ã¦ãã ã•ã„ã€‚"},
  {q:"å–¶æ¥­çµ‚äº†æ™‚ã«å¿…ãšè¡Œã†ã“ã¨ã¯ï¼Ÿ", a:"ä¿å­˜æ“ä½œã‚’è¡Œã„ã€å¿…è¦ã«å¿œã˜ã¦å£²ä¸Šãƒ‡ãƒ¼ã‚¿ã‚’ãƒ¡ãƒ¼ãƒ«ãªã©ã§é€ä¿¡ã—ã¦ãã ã•ã„ã€‚ãƒ‡ãƒ¼ã‚¿ä¿å…¨ã®ãŸã‚ã«é‡è¦ã§ã™ã€‚"},
];

function openHelp(){
  const body = QA_LIST.map(x=>`
    <div class="pill" style="margin-bottom:6px; font-weight:900">Qï¼š${x.q}</div>
    <div class="pill" style="margin-bottom:12px; color:var(--muted)">Aï¼š${x.a}</div>
  `).join("");

  openModal("ãƒ˜ãƒ«ãƒ— / Q&A", body, [{label:"æˆ»ã‚‹", onClick:()=> closeModal()}]);
}

/* =========================================================
   C) ãŠå•åˆã›ï¼ˆãƒ¢ãƒ¼ãƒ€ãƒ«ï¼‰
========================================================= */
function openContact(){
  openModal(
    "ãŠå•åˆã›",
    `
      <div class="pill" style="margin-bottom:10px">
        ONEã«é–¢ã™ã‚‹ã”è³ªå•ãƒ»ä¸å…·åˆã®ã”é€£çµ¡ã¯ä¸‹è¨˜ã‚ˆã‚ŠãŠé¡˜ã„ã„ãŸã—ã¾ã™ã€‚
      </div>
      <div class="pill" style="color:var(--muted); margin-bottom:10px">
        ã”é€£çµ¡ã®éš›ã¯<br>
        ãƒ»åº—èˆ—å<br>
        ãƒ»ä½¿ç”¨ç«¯æœ«<br>
        ãƒ»ç™ºç”Ÿã—ãŸçŠ¶æ³<br>
        ã‚’è¨˜è¼‰ã„ãŸã ãã¨ã‚¹ãƒ ãƒ¼ã‚ºã§ã™ã€‚
      </div>
      <div class="pill">ãƒ»ãƒ¡ãƒ¼ãƒ«ã§å•ã„åˆã‚ã›ï¼ˆä»»æ„ï¼‰</div>
      <div class="pill">ãƒ»LINEã§å•ã„åˆã‚ã›ï¼ˆä»»æ„ï¼‰</div>
    `,
    [{label:"æˆ»ã‚‹", onClick:()=> closeModal()}]
  );
}

/* =========================================================
   D) åˆ©ç”¨æ¡ä»¶ãƒ»æ³¨æ„äº‹é …ï¼ˆå›ºå®šæ–‡è¨€ï¼‰
========================================================= */
function openTerms(){
  openModal(
    "åˆ©ç”¨æ¡ä»¶ãƒ»æ³¨æ„äº‹é …",
    `
      <div class="pill" style="margin-bottom:10px">
        ãƒ»ãƒ‡ãƒ¼ã‚¿ã¯ç«¯æœ«å†…ã«ä¿å­˜ã•ã‚Œã¾ã™<br>
        ãƒ»ç„¡æ–™ç‰ˆã§ã¯ãƒ‡ãƒ¼ã‚¿ã®å¾©æ—§ãƒ»ä¿è¨¼ã¯è¡Œã„ã¾ã›ã‚“<br>
        ãƒ»å–¶æ¥­çµ‚äº†æ™‚ã«ã¯ä¿å­˜ã‚’è¡Œã£ã¦ãã ã•ã„<br>
        ãƒ»ãƒ‡ãƒ¼ã‚¿ç®¡ç†ã¯åˆ©ç”¨è€…ã®è²¬ä»»ã§è¡Œã£ã¦ãã ã•ã„
      </div>
      <div class="pill" style="color:var(--muted)">
        â€» åˆå›èµ·å‹•ç”»é¢ã¨åŒä¸€å†…å®¹ï¼ˆæ–‡è¨€å›ºå®šï¼‰
      </div>
    `,
    [{label:"æˆ»ã‚‹", onClick:()=> closeModal()}]
  );
}

/* =========================================================
   E) ãƒ¡ãƒ‹ãƒ¥ãƒ¼ç™»éŒ²ï¼ˆscrMenuï¼‰
   ä»•æ§˜ï¼šã‚«ãƒ†ã‚´ãƒªãƒ¼ï¼ˆæ–™ç†/ãƒ‰ãƒªãƒ³ã‚¯ï¼‰â†’æ±ºå®šâ†’ã‚¸ãƒ£ãƒ³ãƒ«3åˆ—ï¼‹è¿½åŠ â†’ã‚¸ãƒ£ãƒ³ãƒ«æ±ºå®š/å‰Šé™¤â†’å•†å“ç™»éŒ²â†’ä¸€è¦§ç·¨é›†
========================================================= */
(function buildMenuUI(){
  const scr = $("scrMenu");
  scr.innerHTML = `
    <div class="pill" style="margin-bottom:10px">ãƒ¡ãƒ‹ãƒ¥ãƒ¼ç™»éŒ²</div>

    <!-- ã‚«ãƒ†ã‚´ãƒªãƒ¼ï¼šæ–™ç†/ãƒ‰ãƒªãƒ³ã‚¯ï¼ˆæ³¨æ–‡ã«ã¯å‡ºã•ãªã„ãƒ»ã‚­ãƒƒãƒãƒ³ã«åæ˜ ï¼‰ -->
    <div class="pill" style="margin-bottom:8px">ã‚«ãƒ†ã‚´ãƒªãƒ¼</div>
    <div style="display:flex; gap:10px; margin-bottom:8px">
      <div class="seatCard" id="catFood" style="flex:1; min-height:56px; display:flex; align-items:center; justify-content:center; font-weight:900">æ–™ç†</div>
      <div class="seatCard" id="catDrink" style="flex:1; min-height:56px; display:flex; align-items:center; justify-content:center; font-weight:900">ãƒ‰ãƒªãƒ³ã‚¯</div>
    </div>
    <button class="btn primary" id="catCommit" style="width:100%; margin-bottom:10px">æ±ºå®š</button>

    <div class="pill" style="color:var(--muted); margin-bottom:14px">
      ã‚«ãƒ†ã‚´ãƒªãƒ¼ï¼ˆæ–™ç†/ãƒ‰ãƒªãƒ³ã‚¯ï¼‰ã¯ã‚­ãƒƒãƒãƒ³ã®ã€Œæ–™ç†/ãƒ‰ãƒªãƒ³ã‚¯ã€è¡¨ç¤ºã«åæ˜ ã—ã¾ã™ï¼ˆæ³¨æ–‡ã«ã¯å‡ºã—ã¾ã›ã‚“ï¼‰ã€‚
    </div>

    <!-- ã‚¸ãƒ£ãƒ³ãƒ« -->
    <div id="genreArea" style="display:none">
      <div class="pill" style="margin-bottom:8px">ã‚¸ãƒ£ãƒ³ãƒ«</div>
      <div id="genreGrid" class="seatGrid" style="margin-bottom:8px"></div>
      <div style="display:flex; gap:10px; margin-bottom:14px">
        <button class="btn primary" id="genreDecide" style="flex:1">æ±ºå®š</button>
        <button class="btn" id="genreDelete" style="flex:1">å‰Šé™¤</button>
      </div>
    </div>

    <!-- å•†å“ç™»éŒ² -->
    <div id="itemArea" style="display:none">
      <div class="pill" style="margin-bottom:8px">ç™»éŒ²</div>

      <input id="itemName" class="btn" placeholder="å•†å“å" style="width:100%; text-align:left; margin-bottom:8px" />
      <input id="itemPrice" class="btn" placeholder="é‡‘é¡ï¼ˆæ•°å­—ï¼‰" inputmode="numeric" style="width:100%; text-align:left; margin-bottom:8px" />

      <div style="display:flex; gap:10px; margin-bottom:10px">
        <button class="btn" id="tax8" style="flex:1">8%</button>
        <button class="btn" id="tax10" style="flex:1">10%</button>
      </div>

      <button class="btn primary" id="itemAdd" style="width:100%; margin-bottom:14px">ç™»éŒ²</button>

      <div class="pill" style="margin-bottom:8px">ä½œã£ãŸå•†å“</div>
      <div id="itemList"></div>
    </div>
  `;
})();

/* ===== Menu state ===== */
state.menu = state.menu || {
  cat: null,             // "food" | "drink"
  genres: { food: [], drink: [] },  // ã‚¸ãƒ£ãƒ³ãƒ«ä¸€è¦§
  selectedGenre: null,
  tax: null,             // 8 or 10
  items: []              // {id, cat, genre, name, price, tax}
};

function setCardHL(el, on){
  el.style.outline = on ? "2px solid rgba(122,167,255,0.9)" : "";
  el.style.background = on ? "rgba(122,167,255,0.14)" : "";
}

function renderGenres(){
  const grid = $("genreGrid");
  grid.innerHTML = "";

  const list = state.menu.genres[state.menu.cat] || [];
  // æœ€å¾Œã«ã€Œã‚¸ãƒ£ãƒ³ãƒ«è¿½åŠ ã€
  const final = list.concat(["ï¼‹ ã‚¸ãƒ£ãƒ³ãƒ«è¿½åŠ "]);

  final.forEach(g=>{
    const c = document.createElement("div");
    c.className = "seatCard";
    c.style.minHeight="56px";
    c.style.display="flex";
    c.style.alignItems="center";
    c.style.justifyContent="center";
    c.style.fontWeight="900";
    c.textContent = g;

    const isAdd = (g==="ï¼‹ ã‚¸ãƒ£ãƒ³ãƒ«è¿½åŠ ");
    const on = (!isAdd && state.menu.selectedGenre===g);
    if(on) setCardHL(c,true);

    c.onclick = ()=>{
      if(isAdd){
        openModal(
          "ã‚¸ãƒ£ãƒ³ãƒ«è¿½åŠ ",
          `<input id="newGenre" class="btn" style="width:100%; text-align:left" placeholder="ã‚¸ãƒ£ãƒ³ãƒ«å" />`,
          [
            {label:"è¿½åŠ ", primary:true, onClick:()=>{
              const v = ($("newGenre").value||"").trim();
              if(!v){ toast("ã‚¸ãƒ£ãƒ³ãƒ«åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"); return; }
              const arr = state.menu.genres[state.menu.cat];
              if(arr.includes(v)){ toast("åŒã˜ã‚¸ãƒ£ãƒ³ãƒ«ãŒã‚ã‚Šã¾ã™"); return; }

              // ä½œã£ãŸã‚¸ãƒ£ãƒ³ãƒ«ã¯è¿½åŠ ãƒœãƒƒã‚¯ã‚¹ã®å‰ã«å…¥ã‚‹
              arr.push(v);
              state.menu.selectedGenre = v;

              closeModal();
              renderGenres();
            }},
            {label:"æˆ»ã‚‹", onClick:()=> closeModal()},
          ]
        );
        return;
      }

      state.menu.selectedGenre = (state.menu.selectedGenre===g) ? null : g;
      renderGenres();
    };

    grid.appendChild(c);
  });
}

function renderItems(){
  const box = $("itemList");
  box.innerHTML = "";

  const list = state.menu.items.filter(it=> it.cat===state.menu.cat && it.genre===state.menu.selectedGenre);

  if(list.length===0){
    box.innerHTML = `<div class="pill">ã¾ã ã‚ã‚Šã¾ã›ã‚“</div>`;
    return;
  }

  list.forEach(it=>{
    const row = document.createElement("div");
    row.className = "kRow";
    row.innerHTML = `
      <div class="kLeft">
        <div class="kName">${it.name}</div>
      </div>
      <div class="kSlide" style="gap:10px">
        <div style="font-weight:900">${yen(it.price)}</div>
        <div class="pill">${it.tax}%</div>
        <button class="btn" data-edit="${it.id}">ç·¨é›†</button>
      </div>
    `;
    box.appendChild(row);
  });

  box.querySelectorAll("[data-edit]").forEach(btn=>{
    btn.onclick = ()=>{
      const id = btn.getAttribute("data-edit");
      const it = state.menu.items.find(x=> x.id===id);
      if(!it) return;

      openModal(
        "ç·¨é›†",
        `
          <div class="pill" style="margin-bottom:8px">ã‚¸ãƒ£ãƒ³ãƒ«</div>
          <div class="pill" style="margin-bottom:8px">${it.genre}</div>

          <div style="margin-bottom:6px">å•†å“å</div>
          <input id="eName" class="btn" style="width:100%; text-align:left" value="${it.name}" />

          <div style="margin-top:10px;margin-bottom:6px">é‡‘é¡</div>
          <input id="ePrice" class="btn" style="width:100%; text-align:left" inputmode="numeric" value="${it.price}" />

          <div style="margin-top:10px;margin-bottom:6px">ç¨ç‡</div>
          <div style="display:flex; gap:10px">
            <button class="btn" id="e8" style="flex:1">8%</button>
            <button class="btn" id="e10" style="flex:1">10%</button>
          </div>
        `,
        [
          {label:"ä¿å­˜", primary:true, onClick:()=>{
            const nm = ($("eName").value||"").trim();
            const pr = Number(($("ePrice").value||"").trim());
            if(!nm || !Number.isFinite(pr) || pr<=0 || !(it.tax===8 || it.tax===10)){
              toast("æœªè¨˜å…¥ãŒã‚ã‚Šã¾ã™");
              return;
            }
            it.name = nm;
            it.price = pr;
            closeModal();
            renderItems();
            toast("æ›´æ–°ã—ã¾ã—ãŸ");
          }},
          {label:"æˆ»ã‚‹", onClick:()=> closeModal()},
        ]
      );

      // ç¨ç‡é¸æŠ
      setTimeout(()=>{
        const h = (v)=>{
          it.tax = v;
          $("e8").classList.toggle("primary", v===8);
          $("e10").classList.toggle("primary", v===10);
        };
        $("e8").onclick = ()=> h(8);
        $("e10").onclick = ()=> h(10);
        h(it.tax||10);
      },0);
    };
  });
}

/* ===== Menu interactions ===== */
(function hookMenu(){
  const food = $("catFood");
  const drink = $("catDrink");

  function pickCat(cat){
    state.menu.cat = cat;
    setCardHL(food, cat==="food");
    setCardHL(drink, cat==="drink");
  }

  food.onclick = ()=> pickCat("food");
  drink.onclick = ()=> pickCat("drink");

  $("catCommit").onclick = ()=>{
    if(!state.menu.cat){ toast("ã‚«ãƒ†ã‚´ãƒªãƒ¼ã‚’é¸æŠã—ã¦ãã ã•ã„"); return; }
    $("genreArea").style.display = "block";
    state.menu.selectedGenre = null;
    renderGenres();
  };

  $("genreDelete").onclick = ()=>{
    const g = state.menu.selectedGenre;
    if(!g){ toast("ã‚¸ãƒ£ãƒ³ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„"); return; }

    openModal(
      "å‰Šé™¤ç¢ºèª",
      "ã‚¸ãƒ£ãƒ³ãƒ«å†…ã®å•†å“ãŒå‰Šé™¤ã•ã‚Œã¾ã™",
      [
        {label:"æˆ»ã‚‹", onClick:()=> closeModal()},
        {label:"å‰Šé™¤ã‚¹ãƒ©ã‚¤ãƒ‰ã¸", primary:true, onClick:()=>{
          closeModal();
          openModal(
            "å‰Šé™¤",
            `
              <div class="pill" style="margin-bottom:10px; color:var(--danger)">
                ã‚¸ãƒ£ãƒ³ãƒ«ã€Œ${g}ã€ã¨ã‚¸ãƒ£ãƒ³ãƒ«å†…å•†å“ã‚’å‰Šé™¤ã—ã¾ã™
              </div>
              <input id="gDelSlide" class="kRange" type="range" min="0" max="100" value="0" />
            `,
            [{label:"æˆ»ã‚‹", onClick:()=> closeModal()}]
          );
          setTimeout(()=>{
            $("gDelSlide").onchange = ()=>{
              if(Number($("gDelSlide").value||0) < 88){ $("gDelSlide").value=0; return; }

              // ã‚¸ãƒ£ãƒ³ãƒ«å‰Šé™¤ï¼‹å•†å“å‰Šé™¤
              state.menu.items = state.menu.items.filter(it=> !(it.cat===state.menu.cat && it.genre===g));
              state.menu.genres[state.menu.cat] = state.menu.genres[state.menu.cat].filter(x=> x!==g);
              state.menu.selectedGenre = null;

              closeModal();
              renderGenres();
              $("itemArea").style.display = "none";
              toast("å‰Šé™¤ã—ã¾ã—ãŸ");
            };
          },0);
        }},
      ]
    );
  };

  $("genreDecide").onclick = ()=>{
    const g = state.menu.selectedGenre;
    if(!g){ toast("ã‚¸ãƒ£ãƒ³ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„"); return; }
    $("itemArea").style.display = "block";

    // ç¨ç‡åˆæœŸ
    const setTax = (v)=>{
      state.menu.tax = v;
      $("tax8").classList.toggle("primary", v===8);
      $("tax10").classList.toggle("primary", v===10);
    };
    $("tax8").onclick = ()=> setTax(8);
    $("tax10").onclick = ()=> setTax(10);
    setTax(10);

    renderItems();
  };

  $("itemAdd").onclick = ()=>{
    const g = state.menu.selectedGenre;
    const nm = ($("itemName").value||"").trim();
    const pr = Number(($("itemPrice").value||"").trim());
    const tx = state.menu.tax;

    if(!g || !nm || !Number.isFinite(pr) || pr<=0 || !(tx===8 || tx===10)){
      toast("æœªè¨˜å…¥ãŒã‚ã‚Šã¾ã™");
      return;
    }

    state.menu.items.push({
      id: "m_" + Math.random().toString(36).slice(2),
      cat: state.menu.cat,
      genre: g,
      name: nm,
      price: pr,
      tax: tx
    });

    // äºŒé‡ç™»éŒ²é˜²æ­¢ï¼šå…¥åŠ›æ¬„ã‚’ç©ºç™½ã«æˆ»ã™
    $("itemName").value = "";
    $("itemPrice").value = "";

    renderItems();
    toast("ç™»éŒ²ã—ã¾ã—ãŸ");
  };
})();

/* =========================================================
   F) è¨­å®šãƒœã‚¿ãƒ³å†…å°ç·š
========================================================= */
$("goHelp").onclick = ()=> openHelp();
$("goContact").onclick = ()=> openContact();
$("goTerms").onclick = ()=> openTerms();

/* ===== showScreenæ‹¡å¼µï¼ˆè¨­å®šãƒ»ãƒ¡ãƒ‹ãƒ¥ãƒ¼ï¼‰ ===== */
(function hookShowScreenPart8(){
  if(showScreen._p8Hooked) return;
  const _show = showScreen;
  showScreen = function(id){
    _show(id);
    if(id==="scrMenu"){
      // åˆæœŸè¡¨ç¤º
      state.menu.cat = null;
      state.menu.selectedGenre = null;
      $("genreArea").style.display = "none";
      $("itemArea").style.display = "none";
      setCardHL($("catFood"), false);
      setCardHL($("catDrink"), false);
    }
  };
  showScreen._p8Hooked = true;
})();

/* ===== èµ·å‹•ç›´å¾Œï¼šå¿…è¦ãªã‚‰åˆå›ç”»é¢ ===== */
(function openFirst(){
  // æ—¢ã«DOMæ§‹ç¯‰æ¸ˆã¿ãªã®ã§å³è¡¨ç¤ºã§ã‚‚OK
  // åˆæœŸã¯ãƒ¡ã‚¤ãƒ³ã¸
  showScreen("scrMain");
  renderSeatsWithHighlight();
})();

/* =========================
  ã“ã“ã¾ã§ã§ 8åˆ†å‰² å®Œæˆ
========================= */
</script>
</body>
</html>