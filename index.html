<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>ONE</title>
<style>
  :root{
    --bg:#0b0d10;
    --card:#151a21;
    --card2:#0f1319;
    --txt:#e8eef8;
    --muted:#9aa7bd;
    --line:#273245;
    --good:#2DBE60;
    --warn:#ffb020;
    --bad:#ff4d4d;
    --accent:#4aa3ff;
    --shadow: 0 10px 30px rgba(0,0,0,.35);
    --r:16px;
  }
  *{box-sizing:border-box}
  body{
    margin:0;
    background:linear-gradient(180deg,#0b0d10,#07090c);
    color:var(--txt);
    font-family:-apple-system,BlinkMacSystemFont,"Hiragino Sans","Noto Sans JP",system-ui,Segoe UI,Roboto,sans-serif;
  }
  a{color:var(--accent)}
  header{
    position:sticky; top:0; z-index:20;
    background:rgba(11,13,16,.88);
    backdrop-filter: blur(10px);
    border-bottom:1px solid rgba(39,50,69,.65);
    padding:12px 12px 10px;
  }
  .toprow{
    display:flex; align-items:center; justify-content:space-between; gap:10px;
  }
  .brand{
    font-weight:800; letter-spacing:.08em;
    display:flex; align-items:center; gap:10px;
  }
  .badge{
    font-size:12px; color:#0b0d10; background:var(--good);
    padding:3px 8px; border-radius:999px; font-weight:800;
  }
  .sub{
    margin-top:6px;
    display:flex; gap:8px; flex-wrap:wrap; align-items:center;
    color:var(--muted); font-size:12px;
  }
  .pill{
    border:1px solid rgba(39,50,69,.85);
    background:rgba(21,26,33,.6);
    padding:6px 10px; border-radius:999px; cursor:pointer;
    user-select:none;
  }
  .pill.active{border-color:rgba(74,163,255,.9); box-shadow: 0 0 0 2px rgba(74,163,255,.15) inset}
  main{padding:12px 12px 86px; max-width:980px; margin:0 auto}
  .row{display:flex; gap:10px; flex-wrap:wrap}
  .card{
    background:linear-gradient(180deg,rgba(21,26,33,.95),rgba(15,19,25,.9));
    border:1px solid rgba(39,50,69,.75);
    border-radius:var(--r);
    padding:12px;
    box-shadow:var(--shadow);
  }
  .card.tight{padding:10px}
  .card h2,.card h3{margin:0 0 10px}
  .muted{color:var(--muted)}
  .btn{
    width:100%;
    border:none;
    padding:12px 12px;
    border-radius:14px;
    font-weight:800;
    color:#0b0d10;
    background:var(--accent);
    cursor:pointer;
  }
  .btn:active{transform: translateY(1px)}
  .btn.ghost{
    background:transparent;
    color:var(--txt);
    border:1px solid rgba(39,50,69,.9);
  }
  .btn.good{background:var(--good)}
  .btn.warn{background:var(--warn)}
  .btn.bad{background:var(--bad); color:#fff}
  .btn.small{padding:9px 10px; font-size:14px}
  .btn.inline{width:auto}
  .grid3{display:grid; grid-template-columns: repeat(3, 1fr); gap:10px}
  @media (max-width:860px){ .grid3{grid-template-columns: repeat(2,1fr)} }
  @media (max-width:560px){ .grid3{grid-template-columns: repeat(3,1fr)} }
  .seatCard{
    border-radius:18px;
    padding:12px;
    border:1px solid rgba(39,50,69,.85);
    background:radial-gradient(120% 120% at 10% 0%, rgba(74,163,255,.16), rgba(21,26,33,.95));
    cursor:pointer;
    min-height:112px;
    display:flex; flex-direction:column; gap:6px;
    position:relative;
  }
  .seatCard .no{font-size:20px; font-weight:900}
  .seatCard .name{font-size:13px; color:var(--muted); white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
  .seatCard .meta{font-size:12px; color:var(--muted); display:flex; justify-content:space-between; gap:8px}
  .seatCard .yen{font-size:16px; font-weight:900}
  .seatCard.selected{outline:2px solid rgba(74,163,255,.85)}
  .dot{
    width:10px; height:10px; border-radius:99px; display:inline-block; vertical-align:middle; margin-right:6px;
    border:1px solid rgba(255,255,255,.25);
  }
  .kpi{
    display:grid; grid-template-columns: repeat(3,1fr); gap:10px;
  }
  @media (max-width:720px){ .kpi{grid-template-columns:1fr} }
  .kpi .big{font-size:22px; font-weight:900}
  .kpi .lbl{font-size:12px; color:var(--muted)}
  input,select,textarea{
    width:100%;
    padding:12px 12px;
    border-radius:14px;
    border:1px solid rgba(39,50,69,.95);
    background:rgba(11,13,16,.6);
    color:var(--txt);
    outline:none;
  }
  textarea{min-height:120px}
  .formRow{display:grid; grid-template-columns: 1fr 1fr; gap:10px}
  @media (max-width:640px){ .formRow{grid-template-columns:1fr} }
  .list{
    display:flex; flex-direction:column; gap:8px;
  }
  .item{
    border:1px solid rgba(39,50,69,.8);
    border-radius:14px;
    padding:10px;
    background:rgba(15,19,25,.75);
    display:flex; gap:10px; align-items:center; justify-content:space-between;
  }
  .item .left{display:flex; flex-direction:column; gap:2px; min-width:0}
  .item .title{font-weight:800; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
  .item .subtxt{font-size:12px; color:var(--muted)}
  .item .right{display:flex; gap:8px; align-items:center; flex-shrink:0}
  .qty{display:flex; gap:6px; align-items:center}
  .qty button{width:34px; height:34px; border-radius:10px}
  .tabs{
    position:fixed; left:0; right:0; bottom:0; z-index:30;
    background:rgba(11,13,16,.92);
    border-top:1px solid rgba(39,50,69,.8);
    display:flex; gap:6px;
    padding:10px 10px calc(10px + env(safe-area-inset-bottom));
  }
  .tab{
    flex:1;
    border:1px solid rgba(39,50,69,.8);
    border-radius:14px;
    padding:10px 8px;
    text-align:center;
    color:var(--muted);
    background:rgba(21,26,33,.55);
    font-weight:800;
    cursor:pointer;
    user-select:none;
  }
  .tab.active{color:var(--txt); border-color: rgba(74,163,255,.9)}
  .hidden{display:none!important}
  .hr{height:1px; background:rgba(39,50,69,.7); margin:12px 0}
  .notice{
    border:1px solid rgba(255,176,32,.55);
    background:rgba(255,176,32,.10);
    padding:10px; border-radius:14px; color:#ffd79a;
    font-size:13px;
  }
  .danger{
    border:1px solid rgba(255,77,77,.55);
    background:rgba(255,77,77,.10);
    padding:10px; border-radius:14px; color:#ffb0b0;
    font-size:13px;
  }
  .ok{
    border:1px solid rgba(45,190,96,.55);
    background:rgba(45,190,96,.10);
    padding:10px; border-radius:14px; color:#bff4d3;
    font-size:13px;
  }
  /* slider confirm */
  .sliderWrap{
    border:1px solid rgba(39,50,69,.9);
    border-radius:18px;
    padding:10px;
    background:rgba(15,19,25,.7);
  }
  .sliderRow{display:flex; align-items:center; gap:10px}
  .sliderRow input[type="range"]{width:100%}
  .rangeLbl{font-size:12px; color:var(--muted)}
</style>
</head>

<body>
<header>
  <div class="toprow">
    <div class="brand">
      <span>ONE</span>
      <span class="badge">FREE</span>
    </div>
    <button class="btn small inline ghost" onclick="openBackup()">ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—</button>
  </div>
  <div class="sub">
    <span class="pill" id="pillOffline">ã‚ªãƒ•ãƒ©ã‚¤ãƒ³OKï¼ˆç«¯æœ«å†…ä¿å­˜ï¼‰</span>
    <span class="pill" onclick="toast('ãƒ’ãƒ³ãƒˆï¼šä¼šè¨ˆç¢ºå®šã¯ã‚¹ãƒ©ã‚¤ãƒ‰ã§èª¤æ“ä½œé˜²æ­¢')">ãƒ’ãƒ³ãƒˆ</span>
    <span class="pill" onclick="openRescue()">æ•‘æ¸ˆï¼ˆå¾©å…ƒï¼‰</span>
  </div>
</header>

<main>

  <!-- HOME / SEATS -->
  <section id="view_home">
    <div class="row">
      <div class="card" style="flex:2; min-width:280px">
        <h2>å¸­</h2>
        <div class="muted" style="font-size:12px; margin-bottom:10px">
          ãƒ»ã‚¿ãƒƒãƒ—ï¼šæ³¨æ–‡ã¸ã€€/ã€€é•·æŠ¼ã—ï¼šå¸­ç§»å‹•ï¼ˆå…¥æ›¿ï¼‰ã€€/ã€€è¤‡æ•°é¸æŠï¼šåˆç®—ãƒ»ã¾ã¨ã‚æ“ä½œ
        </div>
        <div class="grid3" id="seatGrid"></div>

        <div class="hr"></div>

        <div class="row">
          <button class="btn good" style="flex:1; min-width:180px" onclick="nav('seat')">ï¼‹ å¸­ç™»éŒ²</button>
          <button class="btn" style="flex:1; min-width:180px" onclick="nav('menu')">ãƒ¡ãƒ‹ãƒ¥ãƒ¼ç™»éŒ²</button>
          <button class="btn ghost" style="flex:1; min-width:180px" onclick="nav('sales')">å£²ä¸Š</button>
        </div>

        <div class="hr"></div>

        <div class="row">
          <button class="btn warn" style="flex:1; min-width:180px" onclick="mergeSelected()">é¸æŠå¸­ã‚’åˆç®—ï¼ˆã¾ã¨ã‚ï¼‰</button>
          <button class="btn ghost" style="flex:1; min-width:180px" onclick="clearSelection()">é¸æŠè§£é™¤</button>
        </div>

        <div class="notice" style="margin-top:10px">
          âœ… **ä¼šè¨ˆã®åˆç®—ï¼åˆ†ã‘ã‚‹** ã¯ã€Œä¼šè¨ˆç”»é¢ã€ã§ã§ãã¾ã™ã€‚<br/>
          âœ… èª¤ã£ã¦ã¾ã¨ã‚ã¦ã‚‚ **æ•‘æ¸ˆï¼ˆå¾©å…ƒï¼‰** ã§ãã¾ã™ã€‚
        </div>
      </div>

      <div class="card" style="flex:1; min-width:260px">
        <h3>ä»Šæ—¥ã®çŠ¶æ³</h3>
        <div class="kpi">
          <div class="card tight" style="box-shadow:none">
            <div class="lbl">å–¶æ¥­ä¸­ åˆè¨ˆ</div>
            <div class="big" id="kpi_open_total">Â¥0</div>
          </div>
          <div class="card tight" style="box-shadow:none">
            <div class="lbl">ä»Šæ—¥ å£²ä¸Šï¼ˆç¢ºå®šï¼‰</div>
            <div class="big" id="kpi_today_sales">Â¥0</div>
          </div>
          <div class="card tight" style="box-shadow:none">
            <div class="lbl">ç€å¸­æ•°</div>
            <div class="big" id="kpi_open_seats">0</div>
          </div>
        </div>

        <div class="hr"></div>

        <div class="ok">
          ç«¯æœ«å†…ã«è‡ªå‹•ä¿å­˜ã—ã¾ã™ï¼ˆã‚ªãƒ•ãƒ©ã‚¤ãƒ³ã§ã‚‚å‹•ä½œï¼‰ã€‚<br/>
          å¿µã®ãŸã‚ã€å®šæœŸçš„ã« **ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ï¼ˆJSONï¼‰** ã‚’å–ã£ã¦ãã ã•ã„ã€‚
        </div>

        <div class="hr"></div>

        <button class="btn bad" onclick="factoryReset()">âš ï¸ å…¨ãƒ‡ãƒ¼ã‚¿åˆæœŸåŒ–ï¼ˆæœ€çµ‚æ‰‹æ®µï¼‰</button>
      </div>
    </div>
  </section>

  <!-- SEAT REGISTER -->
  <section id="view_seat" class="hidden">
    <div class="card">
      <h2>å¸­ç™»éŒ²</h2>
      <div class="formRow">
        <div>
          <label class="muted">å¸­ç•ªå·ï¼ˆä¾‹ï¼šA1 / 1 / 10ï¼‰</label>
          <input id="in_seat_no" placeholder="ä¾‹ï¼šA1" />
        </div>
        <div>
          <label class="muted">å¸­åï¼ˆä»»æ„ï¼šä¾‹ï¼šã‚«ã‚¦ãƒ³ã‚¿ãƒ¼å³ï¼‰</label>
          <input id="in_seat_name" placeholder="ä»»æ„" />
        </div>
      </div>

      <div class="formRow" style="margin-top:10px">
        <div>
          <label class="muted">è‰²ï¼ˆå¸­ã‚°ãƒ«ãƒ¼ãƒ—ï¼‰</label>
          <select id="in_seat_color">
            <option value="#4aa3ff">é’</option>
            <option value="#2DBE60">ç·‘</option>
            <option value="#ffb020">æ©™</option>
            <option value="#ff4d4d">èµ¤</option>
            <option value="#b07cff">ç´«</option>
            <option value="#8aa0b6">ç°</option>
          </select>
        </div>
        <div>
          <label class="muted">äººæ•°ï¼ˆåˆæœŸï¼‰</label>
          <input id="in_seat_people" type="number" placeholder="ç©ºæ¬„OKï¼ˆãƒ†ãƒ³ã‚­ãƒ¼å…¥åŠ›ï¼‰" />
        </div>
      </div>

      <div class="row" style="margin-top:12px">
        <button class="btn good" style="flex:1; min-width:180px" onclick="addSeat()">ä¿å­˜</button>
        <button class="btn ghost" style="flex:1; min-width:180px" onclick="nav('home')">æˆ»ã‚‹</button>
      </div>

      <div class="hr"></div>

      <h3>ç™»éŒ²æ¸ˆã¿</h3>
      <div class="list" id="seatManageList"></div>
    </div>
  </section>

  <!-- ORDER -->
  <section id="view_order" class="hidden">
    <div class="card">
      <h2 id="order_title">æ³¨æ–‡</h2>
      <div class="muted" id="order_sub" style="font-size:12px; margin-bottom:10px"></div>

      <div class="card tight" style="box-shadow:none; margin-bottom:10px">
        <div class="formRow">
          <div>
            <label class="muted">äººæ•°ï¼ˆå¤‰æ›´ï¼‰</label>
            <input id="in_people_now" type="number" placeholder="ä¾‹ï¼š3" />
          </div>
          <div>
            <label class="muted">ï¼‹å·®åˆ†ï¼ˆè‡ªå‹•è¡¨ç¤ºï¼‰</label>
            <input id="out_people_diff" disabled />
          </div>
        </div>
        <div class="row" style="margin-top:10px">
          <button class="btn small good" style="flex:1; min-width:160px" onclick="applyPeople()">äººæ•°æ›´æ–°</button>
          <button class="btn small ghost" style="flex:1; min-width:160px" onclick="nav('home')">å¸­ä¸€è¦§ã¸</button>
        </div>
      </div>

      <div class="hr"></div>

      <h3>è¿½åŠ ï¼ˆæ‰‹å…¥åŠ›ï¼‰</h3>
      <div class="formRow">
        <div>
          <input id="in_item_name" placeholder="å•†å“å" />
        </div>
        <div>
          <input id="in_item_price" type="number" placeholder="é‡‘é¡" />
        </div>
      </div>
      <div class="formRow" style="margin-top:10px">
        <div>
          <select id="in_item_tax">
            <option value="10">ç¨10%</option>
            <option value="8">ç¨8%</option>
          </select>
        </div>
        <div>
          <select id="in_item_genre"></select>
        </div>
      </div>
      <div class="row" style="margin-top:10px">
        <button class="btn" style="flex:1; min-width:180px" onclick="addOrderItem()">è¿½åŠ </button>
        <button class="btn ghost" style="flex:1; min-width:180px" onclick="openMenuPicker()">ç™»éŒ²ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‹ã‚‰è¿½åŠ </button>
      </div>

      <div class="hr"></div>

      <h3>æ³¨æ–‡ä¸€è¦§ï¼ˆç¾åœ¨ã®ä¼šè¨ˆï¼‰</h3>
      <div class="list" id="order_list"></div>

      <div class="hr"></div>

      <div class="row">
        <button class="btn warn" style="flex:1; min-width:180px" onclick="navCheckout()">ä¼šè¨ˆã¸</button>
        <button class="btn ghost" style="flex:1; min-width:180px" onclick="nav('home')">æˆ»ã‚‹</button>
      </div>
    </div>
  </section>

  <!-- CHECKOUT -->
  <section id="view_checkout" class="hidden">
    <div class="card">
      <h2 id="checkout_title">ä¼šè¨ˆ</h2>
      <div class="muted" id="checkout_sub" style="font-size:12px; margin-bottom:10px"></div>

      <div class="card tight" style="box-shadow:none">
        <div class="row" style="align-items:center">
          <div style="flex:1">
            <div class="muted" style="font-size:12px">åˆè¨ˆ</div>
            <div style="font-size:26px; font-weight:900" id="checkout_total">Â¥0</div>
          </div>
          <button class="btn small ghost inline" onclick="splitCheck()">ä¼šè¨ˆã‚’åˆ†ã‘ã‚‹</button>
          <button class="btn small warn inline" onclick="mergeChecksInSeat()">ä¼šè¨ˆã‚’åˆç®—</button>
        </div>
        <div class="muted" style="font-size:12px; margin-top:8px">
          â€»ã€Œåˆ†ã‘ã‚‹ã€ã¯æ•‘æ¸ˆç”¨ã€‚èª¤ã£ã¦ã¾ã¨ã‚ã¦ã‚‚å¾©å…ƒã§ãã¾ã™ã€‚
        </div>
      </div>

      <div class="hr"></div>

      <h3>ä¼šè¨ˆï¼ˆã“ã®å¸­ã®ä¼šè¨ˆä¸€è¦§ï¼‰</h3>
      <div class="list" id="check_list"></div>

      <div class="hr"></div>

      <h3>ç¢ºå®šï¼ˆã‚¹ãƒ©ã‚¤ãƒ‰ï¼‰</h3>
      <div class="sliderWrap">
        <div class="rangeLbl">å³ç«¯ã¾ã§ã‚¹ãƒ©ã‚¤ãƒ‰ã™ã‚‹ã¨ä¼šè¨ˆç¢ºå®šï¼ˆèª¤æ“ä½œé˜²æ­¢ï¼‰</div>
        <div class="sliderRow">
          <input id="range_confirm" type="range" min="0" max="100" value="0" />
          <button class="btn small good inline" onclick="confirmCheckout()">ç¢ºå®š</button>
        </div>
      </div>

      <div class="hr"></div>

      <div class="row">
        <button class="btn ghost" style="flex:1; min-width:180px" onclick="nav('order')">æ³¨æ–‡ã«æˆ»ã‚‹</button>
        <button class="btn ghost" style="flex:1; min-width:180px" onclick="nav('home')">å¸­ä¸€è¦§ã¸</button>
      </div>
    </div>
  </section>

  <!-- MENU REGISTER -->
  <section id="view_menu" class="hidden">
    <div class="card">
      <h2>ãƒ¡ãƒ‹ãƒ¥ãƒ¼ç™»éŒ²ï¼ˆç„¡æ–™ç‰ˆï¼‰</h2>
      <div class="notice">
        ğŸ“· ã‚«ãƒ¡ãƒ©ã¯ã€Œå†™çœŸã‚’é¸ã¶ã€ã¾ã§ã¯ç„¡æ–™ã€‚<br/>
        å†™çœŸã‹ã‚‰è‡ªå‹•æŠ½å‡ºï¼ˆAIï¼‰ã¯ **Pro** ã«å›ã™æƒ³å®šï¼ˆèª¤èªè­˜å¯¾ç­–ãƒ»ç¢ºèªUIè¾¼ã¿ã§ä½œã‚‹ãŸã‚ï¼‰ã€‚
      </div>

      <div class="row" style="margin-top:10px">
        <button class="btn ghost" style="flex:1; min-width:180px" onclick="pickPhoto()">ğŸ“· å†™çœŸã‚’é¸ã¶</button>
        <input id="photo_input" type="file" accept="image/*" class="hidden" />
        <button class="btn ghost" style="flex:1; min-width:180px" onclick="nav('home')">æˆ»ã‚‹</button>
      </div>

      <div class="hr"></div>

      <h3>æ‰‹å…¥åŠ›ã§è¿½åŠ </h3>
      <div class="formRow">
        <div><input id="m_name" placeholder="å•†å“å" /></div>
        <div><input id="m_price" type="number" placeholder="ä¾¡æ ¼" /></div>
      </div>
      <div class="formRow" style="margin-top:10px">
        <div>
          <select id="m_tax">
            <option value="10">ç¨10%</option>
            <option value="8">ç¨8%</option>
          </select>
        </div>
        <div><input id="m_genre" placeholder="ã‚¸ãƒ£ãƒ³ãƒ«ï¼ˆä¾‹ï¼šãƒ‰ãƒªãƒ³ã‚¯/æšã’ç‰©ï¼‰" /></div>
      </div>
      <div class="row" style="margin-top:10px">
        <button class="btn" style="flex:1; min-width:180px" onclick="addMenuItem()">ç™»éŒ²</button>
      </div>

      <div class="hr"></div>

      <h3>ç™»éŒ²ãƒ¡ãƒ‹ãƒ¥ãƒ¼</h3>
      <div class="list" id="menu_list"></div>
    </div>
  </section>

  <!-- SALES -->
  <section id="view_sales" class="hidden">
    <div class="card">
      <h2>å£²ä¸Š</h2>
      <div class="muted" style="font-size:12px; margin-bottom:10px">
        â€»ç„¡æ–™ç‰ˆã¯ã€Œé›†è¨ˆã¨ç¢ºèªã€ã¾ã§ã€‚ç¨å‹™å¯¾å¿œã®æœ¬æ ¼å‡ºåŠ›ã‚„è¤‡æ•°ç«¯æœ«å…±æœ‰ãªã©ã¯å¾Œã§æ‹¡å¼µã€‚
      </div>

      <div class="kpi">
        <div class="card tight" style="box-shadow:none">
          <div class="lbl">ä»Šæ—¥ å£²ä¸Š</div>
          <div class="big" id="sales_today">Â¥0</div>
        </div>
        <div class="card tight" style="box-shadow:none">
          <div class="lbl">ä»Šæœˆ å£²ä¸Š</div>
          <div class="big" id="sales_month">Â¥0</div>
        </div>
        <div class="card tight" style="box-shadow:none">
          <div class="lbl">ä»Šå¹´ å£²ä¸Š</div>
          <div class="big" id="sales_year">Â¥0</div>
        </div>
      </div>

      <div class="hr"></div>

      <h3>ä¼šè¨ˆå±¥æ­´ï¼ˆç¢ºå®šæ¸ˆã¿ï¼‰</h3>
      <div class="list" id="sales_list"></div>

      <div class="hr"></div>

      <button class="btn ghost" onclick="nav('home')">æˆ»ã‚‹</button>
    </div>
  </section>

  <!-- BACKUP -->
  <section id="view_backup" class="hidden">
    <div class="card">
      <h2>ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ï¼ˆJSONï¼‰</h2>
      <div class="notice">
        ç«¯æœ«ãŒå£Šã‚ŒãŸæ™‚ã«å¾©å…ƒã§ãã‚‹ã‚ˆã†ã«ã€ãŸã¾ã«ä¿å­˜ã—ã¦ã­ã€‚<br/>
        ãƒ»**ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰**ï¼šãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦ä¿å­˜<br/>
        ãƒ»**å¾©å…ƒ**ï¼šJSONã‚’è²¼ã‚Šä»˜ã‘ã¦å¾©å…ƒ
      </div>

      <div class="row" style="margin-top:10px">
        <button class="btn good" style="flex:1; min-width:180px" onclick="downloadBackup()">JSONã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
        <button class="btn ghost" style="flex:1; min-width:180px" onclick="nav('home')">æˆ»ã‚‹</button>
      </div>

      <div class="hr"></div>

      <h3>å¾©å…ƒï¼ˆè²¼ã‚Šä»˜ã‘ï¼‰</h3>
      <textarea id="backup_text" placeholder="ã“ã“ã«JSONã‚’è²¼ã‚Šä»˜ã‘ â†’ å¾©å…ƒ"></textarea>
      <div class="row" style="margin-top:10px">
        <button class="btn warn" style="flex:1; min-width:180px" onclick="restoreFromText()">å¾©å…ƒã™ã‚‹</button>
      </div>

      <div class="danger" style="margin-top:10px">
        å¾©å…ƒã™ã‚‹ã¨ã€ä»Šã®ãƒ‡ãƒ¼ã‚¿ã¯ä¸Šæ›¸ãã•ã‚Œã¾ã™ï¼ˆæˆ»ã›ã¾ã›ã‚“ï¼‰ã€‚
      </div>
    </div>
  </section>

  <!-- RESCUE -->
  <section id="view_rescue" class="hidden">
    <div class="card">
      <h2>æ•‘æ¸ˆï¼ˆå¾©å…ƒï¼‰</h2>
      <div class="notice">
        ã€Œä¼šè¨ˆã‚’åˆç®—ã—ã¦ã—ã¾ã£ãŸã€ã€Œå¸­ã‚’é–“é•ãˆã¦å…¥æ›¿ãˆãŸã€ãªã©ã®æ™‚ã®æ•‘æ¸ˆã§ã™ã€‚<br/>
        ç›´è¿‘ã®çŠ¶æ…‹ã«æˆ»ã›ã¾ã™ï¼ˆæœ€å¤§20å›ï¼‰ã€‚
      </div>

      <div class="row" style="margin-top:10px">
        <button class="btn warn" style="flex:1; min-width:180px" onclick="undo()">ã²ã¨ã¤æˆ»ã™</button>
        <button class="btn ghost" style="flex:1; min-width:180px" onclick="nav('home')">æˆ»ã‚‹</button>
      </div>

      <div class="hr"></div>

      <div class="muted" id="undo_info"></div>
    </div>
  </section>

</main>

<!-- Bottom Tabs -->
<div class="tabs">
  <div class="tab" id="tab_home" onclick="nav('home')">å¸­</div>
  <div class="tab" id="tab_seat" onclick="nav('seat')">å¸­ç™»éŒ²</div>
  <div class="tab" id="tab_menu" onclick="nav('menu')">ãƒ¡ãƒ‹ãƒ¥ãƒ¼</div>
  <div class="tab" id="tab_sales" onclick="nav('sales')">å£²ä¸Š</div>
</div>

<script>
/** =========================
 *  ONE FREE - Single HTML
 *  - localStorage persistence
 *  - seats, orders, checks (split/merge), rescue undo
 *  - sales history + simple month/year sums
 *  ========================= */

const LS_KEY = "ONE_FREE_STATE_V1";

const state = {
  version: 1,
  seats: [],       // [{id, no, name, color, peopleDefault, peopleNow, startedAt, checks:[{id, items:[] }], activeCheckId}]
  menu: [],        // [{id, name, price, tax, genre}]
  sales: [],       // [{id, at, seatNo, seatName, total, items:[...]}]
  ui: { selectedSeatIds: [], currentSeatId: null },
  undoStack: []    // snapshots (stringified)
};

// ---------- Utils ----------
function nowISO(){ return new Date().toISOString(); }
function yen(n){ return "Â¥" + (Math.round(n)||0).toLocaleString("ja-JP"); }
function safeText(s){ return (s ?? "").toString(); }
function uid(){ return Math.random().toString(36).slice(2) + Date.now().toString(36); }
function bySeatOrder(a,b){ return seatSortKey(a.no) < seatSortKey(b.no) ? -1 : 1; }
function seatSortKey(no){
  const s = (no||"").toString().trim();
  // "A10" => ["A",10], "10" => ["",10]
  const m = s.match(/^([A-Za-zã-ã‚“ã‚¡-ãƒ¶ä¸€-é¾ ]+)?\s*(\d+)?/);
  const head = (m && m[1]) ? m[1].toUpperCase() : "";
  const num = (m && m[2]) ? parseInt(m[2],10) : 0;
  return head.padEnd(8," ") + num.toString().padStart(6,"0") + "|" + s;
}
function toast(msg){
  const el = document.createElement("div");
  el.textContent = msg;
  el.style.position="fixed";
  el.style.left="50%";
  el.style.bottom="88px";
  el.style.transform="translateX(-50%)";
  el.style.background="rgba(0,0,0,.8)";
  el.style.color="#fff";
  el.style.padding="10px 12px";
  el.style.borderRadius="12px";
  el.style.border="1px solid rgba(255,255,255,.15)";
  el.style.zIndex="9999";
  el.style.maxWidth="92vw";
  document.body.appendChild(el);
  setTimeout(()=>{ el.remove(); }, 1700);
}
function pushUndo(label){
  // keep last 20
  const snap = JSON.stringify({label, at: nowISO(), data: exportState()});
  state.undoStack.unshift(snap);
  if(state.undoStack.length>20) state.undoStack.pop();
  save();
  renderUndoInfo();
}
function undo(){
  if(state.undoStack.length===0){ toast("æˆ»ã›ã‚‹å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“"); return; }
  const snap = JSON.parse(state.undoStack.shift());
  importState(snap.data);
  toast("å¾©å…ƒã—ã¾ã—ãŸï¼š " + (snap.label||""));
  save();
  renderAll();
  renderUndoInfo();
}
function renderUndoInfo(){
  const el = document.getElementById("undo_info");
  if(!el) return;
  el.textContent = "å±¥æ­´æ•°ï¼š " + state.undoStack.length;
}

// ---------- Persistence ----------
function exportState(){
  // exclude undo? keep it
  return {
    version: state.version,
    seats: state.seats,
    menu: state.menu,
    sales: state.sales,
    ui: state.ui,
    undoStack: state.undoStack
  };
}
function importState(obj){
  state.version = obj.version || 1;
  state.seats = Array.isArray(obj.seats) ? obj.seats : [];
  state.menu  = Array.isArray(obj.menu) ? obj.menu : [];
  state.sales = Array.isArray(obj.sales) ? obj.sales : [];
  state.ui    = obj.ui || { selectedSeatIds: [], currentSeatId: null };
  state.undoStack = Array.isArray(obj.undoStack) ? obj.undoStack : [];
}
function save(){
  localStorage.setItem(LS_KEY, JSON.stringify(exportState()));
}
function load(){
  const raw = localStorage.getItem(LS_KEY);
  if(!raw){
    // initial seed
    state.menu = [
      {id:uid(), name:"ç”Ÿãƒ“ãƒ¼ãƒ«", price:700, tax:10, genre:"ãƒ‰ãƒªãƒ³ã‚¯"},
      {id:uid(), name:"ç„¼ãé³¥", price:200, tax:10, genre:"æ–™ç†"},
      {id:uid(), name:"æè±†", price:350, tax:10, genre:"ãŠé€šã—"},
    ];
    save();
    return;
  }
  try{
    importState(JSON.parse(raw));
  }catch(e){
    console.warn(e);
    toast("ä¿å­˜ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã€‚åˆæœŸåŒ–ã—ã¾ã™");
    localStorage.removeItem(LS_KEY);
  }
}

// ---------- Navigation ----------
const views = ["home","seat","order","checkout","menu","sales","backup","rescue"];
function nav(name){
  // update tab active (home/seat/menu/sales only)
  document.getElementById("tab_home").classList.toggle("active", name==="home");
  document.getElementById("tab_seat").classList.toggle("active", name==="seat");
  document.getElementById("tab_menu").classList.toggle("active", name==="menu");
  document.getElementById("tab_sales").classList.toggle("active", name==="sales");

  views.forEach(v=>{
    const el = document.getElementById("view_"+v);
    if(el) el.classList.toggle("hidden", v!==name);
  });

  if(name==="home"){ renderHome(); }
  if(name==="seat"){ renderSeatManage(); }
  if(name==="order"){ renderOrder(); }
  if(name==="checkout"){ renderCheckout(); }
  if(name==="menu"){ renderMenu(); }
  if(name==="sales"){ renderSales(); }
  if(name==="backup"){ /* nothing */ }
  if(name==="rescue"){ renderUndoInfo(); }
}
function openBackup(){ nav("backup"); }
function openRescue(){ nav("rescue"); }

// ---------- Seats ----------
function addSeat(){
  const no = safeText(document.getElementById("in_seat_no").value).trim();
  const name = safeText(document.getElementById("in_seat_name").value).trim();
  const color = document.getElementById("in_seat_color").value || "#4aa3ff";
  const peopleRaw = safeText(document.getElementById("in_seat_people").value).trim();
  const people = peopleRaw==="" ? null : Math.max(0, parseInt(peopleRaw,10)||0);
  if(!no){ toast("å¸­ç•ªå·ã‚’å…¥ã‚Œã¦ãã ã•ã„"); return; }

  // duplicate check by no
  const exists = state.seats.some(s=> (s.no||"").toString().trim().toUpperCase() === no.toUpperCase());
  if(exists){ toast("åŒã˜å¸­ç•ªå·ãŒã™ã§ã«ã‚ã‚Šã¾ã™"); return; }

  pushUndo("å¸­è¿½åŠ ");
  const seatId = uid();
  const checkId = uid();
  state.seats.push({
    id: seatId,
    no, name,
    color,
    peopleDefault: people,
    peopleNow: people,
    startedAt: nowISO(),
    checks: [{ id: checkId, items: [] }], // default single check
    activeCheckId: checkId
  });
  state.seats.sort(bySeatOrder);
  save();
  document.getElementById("in_seat_no").value="";
  document.getElementById("in_seat_name").value="";
  document.getElementById("in_seat_people").value="";
  renderAll();
  nav("home");
}
function removeSeat(id){
  const seat = state.seats.find(s=>s.id===id);
  if(!seat) return;
  if(!confirm(`å¸­ã€Œ${seat.no}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\nï¼ˆæ³¨æ–‡ã‚‚æ¶ˆãˆã¾ã™ï¼‰`)) return;
  pushUndo("å¸­å‰Šé™¤");
  state.seats = state.seats.filter(s=>s.id!==id);
  state.ui.selectedSeatIds = state.ui.selectedSeatIds.filter(x=>x!==id);
  if(state.ui.currentSeatId===id) state.ui.currentSeatId=null;
  save();
  renderAll();
}
function selectSeatToggle(id){
  const sel = state.ui.selectedSeatIds;
  const i = sel.indexOf(id);
  if(i>=0) sel.splice(i,1); else sel.push(id);
  save();
  renderHome();
}
function clearSelection(){
  state.ui.selectedSeatIds = [];
  save();
  renderHome();
  toast("é¸æŠè§£é™¤");
}
function openSeat(id){
  state.ui.currentSeatId = id;
  save();
  nav("order");
}
function seatTotalOpen(seat){
  // total of all checks
  return (seat.checks||[]).reduce((sum,c)=> sum + checkTotal(c), 0);
}
function checkTotal(check){
  const items = check.items || [];
  return items.reduce((sum,it)=> sum + (it.price||0) * (it.qty||1), 0);
}
function getCurrentSeat(){
  return state.seats.find(s=>s.id===state.ui.currentSeatId);
}
function getActiveCheck(seat){
  if(!seat) return null;
  let c = (seat.checks||[]).find(x=>x.id===seat.activeCheckId);
  if(!c){
    // fallback
    if(!seat.checks) seat.checks=[];
    if(seat.checks.length===0){ seat.checks.push({id:uid(), items:[]}); }
    seat.activeCheckId = seat.checks[0].id;
    c = seat.checks[0];
  }
  return c;
}

// Long press seat swap (simple): first long press selects "move mode" seat; second tap swaps
let moveMode = { fromId:null, timer:null };
function seatLongPressStart(id){
  moveMode.timer = setTimeout(()=>{
    moveMode.fromId = id;
    toast("å¸­ç§»å‹•ãƒ¢ãƒ¼ãƒ‰ï¼šç§»å‹•å…ˆã®å¸­ã‚’ã‚¿ãƒƒãƒ—");
  }, 450);
}
function seatLongPressEnd(){
  if(moveMode.timer) clearTimeout(moveMode.timer);
  moveMode.timer=null;
}
function seatTap(id){
  // if move mode active
  if(moveMode.fromId && moveMode.fromId!==id){
    pushUndo("å¸­å…¥æ›¿");
    const a = state.seats.find(s=>s.id===moveMode.fromId);
    const b = state.seats.find(s=>s.id===id);
    if(a && b){
      // swap "no/name/color/peopleDefault" only? or whole seat?
      // In actual ops, you'd move the whole status by swapping seat numbers.
      // We'll swap seat numbers + labels, keeping orders with the "physical table" swap.
      const tmp = { no:a.no, name:a.name, color:a.color, peopleDefault:a.peopleDefault };
      a.no=b.no; a.name=b.name; a.color=b.color; a.peopleDefault=b.peopleDefault;
      b.no=tmp.no; b.name=tmp.name; b.color=tmp.color; b.peopleDefault=tmp.peopleDefault;
      state.seats.sort(bySeatOrder);
      save();
      renderAll();
      toast("å…¥æ›¿ã—ã¾ã—ãŸ");
    }
    moveMode.fromId=null;
    return;
  }
  if(moveMode.fromId && moveMode.fromId===id){
    moveMode.fromId=null;
    toast("å¸­ç§»å‹•ãƒ¢ãƒ¼ãƒ‰è§£é™¤");
    return;
  }
  // normal: if selection mode has items -> toggle selection, else open seat
  if(state.ui.selectedSeatIds.length>0){
    selectSeatToggle(id);
  }else{
    openSeat(id);
  }
}

// Merge selected seats (åˆç®—ã§ã¾ã¨ã‚)
function mergeSelected(){
  const ids = [...state.ui.selectedSeatIds];
  if(ids.length<2){ toast("2å¸­ä»¥ä¸Šé¸æŠã—ã¦ãã ã•ã„"); return; }

  // Create a new "virtual merged seat" by moving checks into first seat and marking others as empty (or remove)
  const base = state.seats.find(s=>s.id===ids[0]);
  if(!base){ toast("å¯¾è±¡ãŒã‚ã‚Šã¾ã›ã‚“"); return; }

  if(!confirm("é¸æŠã—ãŸå¸­ã‚’åˆç®—ï¼ˆã¾ã¨ã‚ï¼‰ã—ã¾ã™ã‹ï¼Ÿ\nâ€»èª¤æ“ä½œã§ã‚‚æ•‘æ¸ˆï¼ˆå¾©å…ƒï¼‰ã§ãã¾ã™")) return;
  pushUndo("è¤‡æ•°å¸­åˆç®—");

  const others = ids.slice(1).map(id=>state.seats.find(s=>s.id===id)).filter(Boolean);
  others.forEach(s=>{
    // move all checks into base (as separate checks)
    (s.checks||[]).forEach(ch=>{
      base.checks.push({ id: uid(), items: JSON.parse(JSON.stringify(ch.items||[])) });
    });
    // clear seat
    s.checks = [{ id: uid(), items: [] }];
    s.activeCheckId = s.checks[0].id;
    s.startedAt = nowISO();
    s.peopleNow = s.peopleDefault ?? null;
  });

  // set base active to first check
  if(base.checks.length>0) base.activeCheckId = base.checks[0].id;

  state.ui.selectedSeatIds = [];
  save();
  renderAll();
  toast("åˆç®—ã—ã¾ã—ãŸï¼ˆä¼šè¨ˆç”»é¢ã§åˆ†ã‘ç›´ã—å¯èƒ½ï¼‰");
}

// ---------- Order ----------
function renderOrder(){
  const seat = getCurrentSeat();
  if(!seat){ nav("home"); return; }
  const dot = `<span class="dot" style="background:${seat.color}"></span>`;
  document.getElementById("order_title").innerHTML = `${dot}${escapeHtml(seat.no)} <span class="muted" style="font-weight:700">${escapeHtml(seat.name||"")}</span>`;
  const started = new Date(seat.startedAt);
  const activeCheck = getActiveCheck(seat);
  document.getElementById("order_sub").textContent =
    `ç€å¸­ï¼š${started.toLocaleString("ja-JP")} ï¼ ä¼šè¨ˆæ•°ï¼š${(seat.checks||[]).length} ï¼ ç¾åœ¨ã®ä¼šè¨ˆï¼š${(seat.checks||[]).findIndex(c=>c.id===seat.activeCheckId)+1}`;

  // people
  const now = seat.peopleNow ?? "";
  document.getElementById("in_people_now").value = now==="" ? "" : now;
  const diff = peopleDiffText(seat);
  document.getElementById("out_people_diff").value = diff;

  // genres in select
  refreshGenreSelect();

  // list items of active check
  const list = document.getElementById("order_list");
  list.innerHTML = "";
  const items = (activeCheck?.items || []);
  if(items.length===0){
    list.innerHTML = `<div class="muted">ã¾ã æ³¨æ–‡ãŒã‚ã‚Šã¾ã›ã‚“</div>`;
  }else{
    items.forEach((it, idx)=>{
      const el = document.createElement("div");
      el.className = "item";
      el.innerHTML = `
        <div class="left">
          <div class="title">${escapeHtml(it.name)}</div>
          <div class="subtxt">${escapeHtml(it.genre||"")} / ç¨${it.tax||10}% / ${yen(it.price||0)}</div>
        </div>
        <div class="right">
          <div class="qty">
            <button class="btn small inline ghost" onclick="chgQty(${idx},-1)">ï¼</button>
            <div style="min-width:26px; text-align:center; font-weight:900">${it.qty||1}</div>
            <button class="btn small inline ghost" onclick="chgQty(${idx},+1)">ï¼‹</button>
          </div>
          <button class="btn small inline bad" onclick="delItem(${idx})">å‰Šé™¤</button>
        </div>
      `;
      list.appendChild(el);
    });
  }
}
function peopleDiffText(seat){
  const d = seat.peopleDefault;
  const n = seat.peopleNow;
  if(d==null || d==="" || isNaN(d) || n==null || n==="" || isNaN(n)) return "";
  const diff = (parseInt(n,10)||0) - (parseInt(d,10)||0);
  if(diff===0) return "";
  const sign = diff>0 ? "+" : "";
  return sign + diff + "å";
}
function applyPeople(){
  const seat = getCurrentSeat();
  if(!seat) return;
  pushUndo("äººæ•°å¤‰æ›´");
  const raw = safeText(document.getElementById("in_people_now").value).trim();
  seat.peopleNow = raw==="" ? null : Math.max(0, parseInt(raw,10)||0);
  save();
  renderOrder();
  renderHome();
  toast("äººæ•°ã‚’æ›´æ–°ã—ã¾ã—ãŸ");
}
function addOrderItem(){
  const seat = getCurrentSeat();
  if(!seat) return;
  const check = getActiveCheck(seat);
  const name = safeText(document.getElementById("in_item_name").value).trim();
  const price = parseInt(safeText(document.getElementById("in_item_price").value).trim(),10);
  const tax = parseInt(document.getElementById("in_item_tax").value,10) || 10;
  const genre = document.getElementById("in_item_genre").value || "";
  if(!name){ toast("å•†å“åã‚’å…¥ã‚Œã¦ãã ã•ã„"); return; }
  if(!price || price<=0){ toast("é‡‘é¡ã‚’å…¥ã‚Œã¦ãã ã•ã„"); return; }

  pushUndo("æ³¨æ–‡è¿½åŠ ");
  check.items.push({ id: uid(), name, price, tax, genre, qty: 1 });
  save();
  document.getElementById("in_item_name").value="";
  document.getElementById("in_item_price").value="";
  renderOrder();
  renderHome();
}
function delItem(idx){
  const seat = getCurrentSeat();
  if(!seat) return;
  const check = getActiveCheck(seat);
  pushUndo("æ³¨æ–‡å‰Šé™¤");
  check.items.splice(idx,1);
  save();
  renderOrder();
  renderHome();
}
function chgQty(idx, delta){
  const seat = getCurrentSeat();
  if(!seat) return;
  const check = getActiveCheck(seat);
  const it = check.items[idx];
  if(!it) return;
  pushUndo("æ•°é‡å¤‰æ›´");
  const n = (it.qty||1) + delta;
  it.qty = Math.max(1, n);
  save();
  renderOrder();
  renderHome();
}

// ---------- Checkout ----------
function navCheckout(){
  nav("checkout");
}
function renderCheckout(){
  const seat = getCurrentSeat();
  if(!seat){ nav("home"); return; }

  const dot = `<span class="dot" style="background:${seat.color}"></span>`;
  document.getElementById("checkout_title").innerHTML = `${dot}${escapeHtml(seat.no)} <span class="muted" style="font-weight:700">${escapeHtml(seat.name||"")}</span>`;
  document.getElementById("checkout_sub").textContent =
    `ä¼šè¨ˆæ•°ï¼š${(seat.checks||[]).length}ï¼ˆã‚¿ãƒƒãƒ—ã§åˆ‡æ›¿ï¼‰ï¼ã€Œåˆ†ã‘ã‚‹ã€ã¯æ•‘æ¸ˆç”¨`;

  const totalAll = seatTotalOpen(seat);
  document.getElementById("checkout_total").textContent = yen(totalAll);

  // list checks
  const list = document.getElementById("check_list");
  list.innerHTML = "";
  (seat.checks||[]).forEach((ch, i)=>{
    const active = ch.id===seat.activeCheckId;
    const el = document.createElement("div");
    el.className = "item";
    el.style.cursor="pointer";
    el.onclick = ()=>{ seat.activeCheckId = ch.id; save(); renderCheckout(); renderOrder(); };
    el.innerHTML = `
      <div class="left">
        <div class="title">ä¼šè¨ˆ ${i+1} ${active ? "ï¼ˆé¸æŠä¸­ï¼‰" : ""}</div>
        <div class="subtxt">æ˜ç´°ï¼š${(ch.items||[]).length}ä»¶</div>
      </div>
      <div class="right">
        <div style="font-weight:900">${yen(checkTotal(ch))}</div>
        <button class="btn small inline ghost" onclick="event.stopPropagation(); openSplitEditor('${ch.id}')">æ˜ç´°</button>
      </div>
    `;
    list.appendChild(el);
  });

  document.getElementById("range_confirm").value = 0;
}

function openSplitEditor(checkId){
  // show quick details + move items to another check
  const seat = getCurrentSeat();
  if(!seat) return;
  const ch = (seat.checks||[]).find(x=>x.id===checkId);
  if(!ch){ toast("ä¼šè¨ˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"); return; }

  // build simple prompt-like modal using confirm? We'll do minimal UI via textarea prompt
  // Instead, navigate to order and set active check
  seat.activeCheckId = checkId;
  save();
  nav("order");
  toast("ä¼šè¨ˆã‚’åˆ‡æ›¿ãˆã¾ã—ãŸï¼ˆæ³¨æ–‡ä¸€è¦§ãŒã“ã®ä¼šè¨ˆã«ãªã‚Šã¾ã™ï¼‰");
}

function splitCheck(){
  const seat = getCurrentSeat();
  if(!seat) return;
  // create new check and keep current items in current check; allow moving items by switching active check and adding there
  if(!confirm("ä¼šè¨ˆã‚’åˆ†ã‘ã¾ã™ã‹ï¼Ÿ\næ–°ã—ã„ä¼šè¨ˆï¼ˆç©ºï¼‰ã‚’è¿½åŠ ã—ã¾ã™ã€‚\nâ€»ç§»ã—ãŸã„å•†å“ã¯ã€ä¼šè¨ˆã‚’åˆ‡æ›¿ãˆã¦è¿½åŠ /ç§»å‹•ã—ã¾ã™ï¼ˆæ•‘æ¸ˆã‚ã‚Šï¼‰")) return;
  pushUndo("ä¼šè¨ˆã‚’åˆ†ã‘ã‚‹");
  const newId = uid();
  seat.checks.push({ id: newId, items: [] });
  seat.activeCheckId = newId;
  save();
  renderCheckout();
  toast("æ–°ã—ã„ä¼šè¨ˆã‚’ä½œæˆã—ã¾ã—ãŸï¼ˆä¼šè¨ˆåˆ‡æ›¿ã§åˆ†ã‘ã¾ã™ï¼‰");
}

function mergeChecksInSeat(){
  const seat = getCurrentSeat();
  if(!seat) return;
  if((seat.checks||[]).length<=1){ toast("ä¼šè¨ˆãŒ1ã¤ãªã®ã§åˆç®—ä¸è¦"); return; }
  if(!confirm("ã“ã®å¸­ã®ä¼šè¨ˆã‚’ã™ã¹ã¦åˆç®—ã—ã¾ã™ã‹ï¼Ÿ\nâ€»èª¤æ“ä½œã§ã‚‚æ•‘æ¸ˆï¼ˆå¾©å…ƒï¼‰ã§ãã¾ã™")) return;
  pushUndo("ä¼šè¨ˆã‚’åˆç®—");
  const allItems = seat.checks.flatMap(c=> (c.items||[]).map(x=>JSON.parse(JSON.stringify(x))));
  const mergedId = uid();
  seat.checks = [{ id: mergedId, items: allItems }];
  seat.activeCheckId = mergedId;
  save();
  renderCheckout();
  renderOrder();
  toast("åˆç®—ã—ã¾ã—ãŸ");
}

function confirmCheckout(){
  const seat = getCurrentSeat();
  if(!seat) return;

  const range = parseInt(document.getElementById("range_confirm").value,10) || 0;
  if(range < 95){
    toast("ã‚¹ãƒ©ã‚¤ãƒ‰ãŒè¶³ã‚Šã¾ã›ã‚“ï¼ˆå³ç«¯ã¾ã§ï¼‰");
    return;
  }
  const total = seatTotalOpen(seat);
  if(total<=0){
    if(!confirm("åˆè¨ˆãŒ0å††ã§ã™ã€‚ä¼šè¨ˆç¢ºå®šã—ã¾ã™ã‹ï¼Ÿ")) return;
  }

  pushUndo("ä¼šè¨ˆç¢ºå®š");

  // record sale
  const itemsAll = seat.checks.flatMap(c=> (c.items||[]).map(it=>({...it})));
  state.sales.unshift({
    id: uid(),
    at: nowISO(),
    seatNo: seat.no,
    seatName: seat.name,
    total,
    items: itemsAll
  });

  // clear seat (auto empty)
  seat.checks = [{ id: uid(), items: [] }];
  seat.activeCheckId = seat.checks[0].id;
  seat.startedAt = nowISO();
  seat.peopleNow = seat.peopleDefault ?? null;

  save();
  renderAll();
  nav("home");
  toast("ä¼šè¨ˆç¢ºå®šã—ã¾ã—ãŸ");
}

// ---------- Menu ----------
function refreshGenreSelect(){
  const sel = document.getElementById("in_item_genre");
  if(!sel) return;
  const genres = Array.from(new Set(state.menu.map(m=>m.genre).filter(Boolean)));
  const fallback = ["æ–™ç†","ãƒ‰ãƒªãƒ³ã‚¯","ãŠé€šã—","ãƒ‡ã‚¶ãƒ¼ãƒˆ"];
  const list = (genres.length? genres : fallback);
  sel.innerHTML = list.map(g=>`<option value="${escapeAttr(g)}">${escapeHtml(g)}</option>`).join("");
}
function renderMenu(){
  const list = document.getElementById("menu_list");
  list.innerHTML = "";
  if(state.menu.length===0){
    list.innerHTML = `<div class="muted">ã¾ã ç™»éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</div>`;
  }else{
    state.menu.forEach(m=>{
      const el = document.createElement("div");
      el.className = "item";
      el.innerHTML = `
        <div class="left">
          <div class="title">${escapeHtml(m.name)}</div>
          <div class="subtxt">${escapeHtml(m.genre||"")} / ç¨${m.tax||10}% / ${yen(m.price||0)}</div>
        </div>
        <div class="right">
          <button class="btn small inline ghost" onclick="useMenuItem('${m.id}')">è¿½åŠ </button>
          <button class="btn small inline bad" onclick="delMenuItem('${m.id}')">å‰Šé™¤</button>
        </div>
      `;
      list.appendChild(el);
    });
  }
}
function addMenuItem(){
  const name = safeText(document.getElementById("m_name").value).trim();
  const price = parseInt(safeText(document.getElementById("m_price").value).trim(),10);
  const tax = parseInt(document.getElementById("m_tax").value,10)||10;
  const genre = safeText(document.getElementById("m_genre").value).trim() || "æ–™ç†";
  if(!name){ toast("å•†å“åã‚’å…¥ã‚Œã¦ãã ã•ã„"); return; }
  if(!price || price<=0){ toast("ä¾¡æ ¼ã‚’å…¥ã‚Œã¦ãã ã•ã„"); return; }

  pushUndo("ãƒ¡ãƒ‹ãƒ¥ãƒ¼ç™»éŒ²");
  state.menu.unshift({ id: uid(), name, price, tax, genre });
  save();
  document.getElementById("m_name").value="";
  document.getElementById("m_price").value="";
  document.getElementById("m_genre").value="";
  renderMenu();
  refreshGenreSelect();
  toast("ãƒ¡ãƒ‹ãƒ¥ãƒ¼ç™»éŒ²ã—ã¾ã—ãŸ");
}
function delMenuItem(id){
  const m = state.menu.find(x=>x.id===id);
  if(!m) return;
  if(!confirm(`ã€Œ${m.name}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) return;
  pushUndo("ãƒ¡ãƒ‹ãƒ¥ãƒ¼å‰Šé™¤");
  state.menu = state.menu.filter(x=>x.id!==id);
  save();
  renderMenu();
  refreshGenreSelect();
}
function useMenuItem(id){
  const seat = getCurrentSeat();
  if(!seat){
    toast("å…ˆã«å¸­ã‚’é¸ã‚“ã§ãã ã•ã„ï¼ˆå¸­â†’æ³¨æ–‡ï¼‰");
    return;
  }
  const m = state.menu.find(x=>x.id===id);
  if(!m) return;
  pushUndo("ç™»éŒ²ãƒ¡ãƒ‹ãƒ¥ãƒ¼è¿½åŠ ");
  const ch = getActiveCheck(seat);
  ch.items.push({ id: uid(), name:m.name, price:m.price, tax:m.tax, genre:m.genre, qty:1 });
  save();
  renderOrder();
  renderHome();
  toast("è¿½åŠ ã—ã¾ã—ãŸ");
}
function openMenuPicker(){
  // shortcut: go to menu, then you can "è¿½åŠ "
  nav("menu");
  toast("ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‹ã‚‰ã€Œè¿½åŠ ã€ã‚’æŠ¼ã™ã¨ã€ç¾åœ¨ã®å¸­ã®æ³¨æ–‡ã«å…¥ã‚Šã¾ã™");
}

// photo picker (free: just open picker)
function pickPhoto(){
  const input = document.getElementById("photo_input");
  input.onchange = ()=>{
    if(input.files && input.files[0]){
      toast("å†™çœŸã‚’é¸ã³ã¾ã—ãŸï¼ˆç„¡æ–™ç‰ˆã¯æ‰‹å…¥åŠ›è£œåŠ©ã¾ã§ï¼‰");
    }
  };
  input.click();
}

// ---------- Sales ----------
function isSameDay(a,b){
  return a.getFullYear()===b.getFullYear() && a.getMonth()===b.getMonth() && a.getDate()===b.getDate();
}
function renderSales(){
  const today = new Date();
  const sumToday = state.sales.filter(s=>isSameDay(new Date(s.at), today)).reduce((x,s)=>x+(s.total||0),0);
  const sumMonth = state.sales.filter(s=>{
    const d=new Date(s.at); return d.getFullYear()===today.getFullYear() && d.getMonth()===today.getMonth();
  }).reduce((x,s)=>x+(s.total||0),0);
  const sumYear = state.sales.filter(s=>{
    const d=new Date(s.at); return d.getFullYear()===today.getFullYear();
  }).reduce((x,s)=>x+(s.total||0),0);

  document.getElementById("sales_today").textContent = yen(sumToday);
  document.getElementById("sales_month").textContent = yen(sumMonth);
  document.getElementById("sales_year").textContent = yen(sumYear);

  const list = document.getElementById("sales_list");
  list.innerHTML = "";
  if(state.sales.length===0){
    list.innerHTML = `<div class="muted">ã¾ã ä¼šè¨ˆç¢ºå®šãŒã‚ã‚Šã¾ã›ã‚“</div>`;
    return;
  }
  state.sales.slice(0,80).forEach(s=>{
    const d = new Date(s.at);
    const el = document.createElement("div");
    el.className = "item";
    el.innerHTML = `
      <div class="left">
        <div class="title">${escapeHtml(s.seatNo)} ${escapeHtml(s.seatName||"")}</div>
        <div class="subtxt">${d.toLocaleString("ja-JP")} / æ˜ç´° ${s.items?.length||0}ä»¶</div>
      </div>
      <div class="right">
        <div style="font-weight:900">${yen(s.total||0)}</div>
        <button class="btn small inline ghost" onclick="showSaleDetail('${s.id}')">è©³ç´°</button>
      </div>
    `;
    list.appendChild(el);
  });
}
function showSaleDetail(id){
  const s = state.sales.find(x=>x.id===id);
  if(!s) return;
  const lines = (s.items||[]).map(it=>`${it.name} x${it.qty||1} ${yen((it.price||0)*(it.qty||1))}`).join("\n");
  alert(`ã€ä¼šè¨ˆè©³ç´°ã€‘\nå¸­ï¼š${s.seatNo} ${s.seatName||""}\nåˆè¨ˆï¼š${yen(s.total||0)}\n\n${lines}`);
}

// ---------- Home render ----------
function renderHome(){
  const grid = document.getElementById("seatGrid");
  grid.innerHTML = "";

  const seats = [...state.seats].sort(bySeatOrder);
  seats.forEach(seat=>{
    const div = document.createElement("div");
    div.className = "seatCard";
    const selected = state.ui.selectedSeatIds.includes(seat.id);
    if(selected) div.classList.add("selected");

    const peopleDiff = peopleDiffText(seat);
    const diffHtml = peopleDiff ? `<span style="color:${peopleDiff.startsWith('+')? 'var(--bad)' : 'var(--warn)'}; font-weight:900">${escapeHtml(peopleDiff)}</span>` : "";
    const peopleNow = (seat.peopleNow==null || seat.peopleNow==="") ? "" : `${seat.peopleNow}å`;

    div.innerHTML = `
      <div class="no"><span class="dot" style="background:${seat.color}"></span>${escapeHtml(seat.no)}</div>
      <div class="name">${escapeHtml(seat.name||"")}</div>
      <div class="meta">
        <div>${peopleNow} ${diffHtml}</div>
        <div class="yen">${yen(seatTotalOpen(seat))}</div>
      </div>
    `;

    div.onmousedown = ()=>seatLongPressStart(seat.id);
    div.onmouseup = ()=>seatLongPressEnd();
    div.ontouchstart = ()=>seatLongPressStart(seat.id);
    div.ontouchend = ()=>seatLongPressEnd();

    div.onclick = ()=>{
      // if no selection yet: tap opens; if selection exists: toggles selection
      if(state.ui.selectedSeatIds.length===0 && !moveMode.fromId){
        // single tap => open order
        seatTap(seat.id);
      }else{
        // selection toggle OR move mode tap
        seatTap(seat.id);
      }
    };

    // double tap to select quickly
    div.ondblclick = ()=>{ selectSeatToggle(seat.id); };

    grid.appendChild(div);
  });

  // KPI
  const openTotal = state.seats.reduce((sum,s)=>sum+seatTotalOpen(s),0);
  const openSeats = state.seats.length;
  const today = new Date();
  const todaySales = state.sales.filter(s=>isSameDay(new Date(s.at), today)).reduce((x,s)=>x+(s.total||0),0);

  document.getElementById("kpi_open_total").textContent = yen(openTotal);
  document.getElementById("kpi_today_sales").textContent = yen(todaySales);
  document.getElementById("kpi_open_seats").textContent = openSeats;

  document.getElementById("pillOffline").classList.add("active");
}

// ---------- Seat manage ----------
function renderSeatManage(){
  const list = document.getElementById("seatManageList");
  list.innerHTML = "";
  const seats = [...state.seats].sort(bySeatOrder);
  if(seats.length===0){
    list.innerHTML = `<div class="muted">ã¾ã å¸­ãŒã‚ã‚Šã¾ã›ã‚“ã€‚å¸­ç•ªå·ã‚’å…¥ã‚Œã¦ä¿å­˜ã—ã¦ãã ã•ã„ã€‚</div>`;
    return;
  }
  seats.forEach(seat=>{
    const el = document.createElement("div");
    el.className = "item";
    el.innerHTML = `
      <div class="left">
        <div class="title"><span class="dot" style="background:${seat.color}"></span>${escapeHtml(seat.no)} ${escapeHtml(seat.name||"")}</div>
        <div class="subtxt">äººæ•°åˆæœŸï¼š${seat.peopleDefault==null? "ï¼ˆæœªè¨­å®šï¼‰" : seat.peopleDefault+"å"} ï¼ ç¾åœ¨ï¼š${seat.peopleNow==null? "ï¼ˆæœªè¨­å®šï¼‰" : seat.peopleNow+"å"}</div>
      </div>
      <div class="right">
        <button class="btn small inline ghost" onclick="editSeat('${seat.id}')">ç·¨é›†</button>
        <button class="btn small inline bad" onclick="removeSeat('${seat.id}')">å‰Šé™¤</button>
      </div>
    `;
    list.appendChild(el);
  });
}
function editSeat(id){
  const seat = state.seats.find(s=>s.id===id);
  if(!seat) return;
  const no = prompt("å¸­ç•ªå·", seat.no);
  if(no===null) return;
  const name = prompt("å¸­åï¼ˆä»»æ„ï¼‰", seat.name||"");
  if(name===null) return;
  const people = prompt("äººæ•°ï¼ˆåˆæœŸ/ç©ºæ¬„å¯ï¼‰", seat.peopleDefault==null? "" : seat.peopleDefault);
  if(people===null) return;

  pushUndo("å¸­ç·¨é›†");
  seat.no = safeText(no).trim() || seat.no;
  seat.name = safeText(name).trim();
  const p = safeText(people).trim();
  seat.peopleDefault = p==="" ? null : Math.max(0, parseInt(p,10)||0);
  // if peopleNow not set, follow default
  if(seat.peopleNow==null) seat.peopleNow = seat.peopleDefault;
  state.seats.sort(bySeatOrder);
  save();
  renderAll();
  toast("å¸­ã‚’ç·¨é›†ã—ã¾ã—ãŸ");
}

// ---------- Backup ----------
function downloadBackup(){
  const data = exportState();
  const blob = new Blob([JSON.stringify(data,null,2)], {type:"application/json"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "ONE_backup_" + new Date().toISOString().slice(0,10) + ".json";
  a.click();
  URL.revokeObjectURL(a.href);
  toast("ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸ");
}
function restoreFromText(){
  const txt = safeText(document.getElementById("backup_text").value).trim();
  if(!txt){ toast("JSONã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„"); return; }
  if(!confirm("å¾©å…ƒã—ã¾ã™ã‹ï¼Ÿä»Šã®ãƒ‡ãƒ¼ã‚¿ã¯ä¸Šæ›¸ãã•ã‚Œã¾ã™")) return;
  try{
    const obj = JSON.parse(txt);
    importState(obj);
    save();
    renderAll();
    nav("home");
    toast("å¾©å…ƒã—ã¾ã—ãŸ");
  }catch(e){
    toast("JSONã®å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“");
  }
}

// ---------- Reset ----------
function factoryReset(){
  if(!confirm("æœ¬å½“ã«å…¨ãƒ‡ãƒ¼ã‚¿ã‚’åˆæœŸåŒ–ã—ã¾ã™ã‹ï¼Ÿ\nï¼ˆæˆ»ã›ã¾ã›ã‚“ï¼‰")) return;
  localStorage.removeItem(LS_KEY);
  location.reload();
}

// ---------- Render all ----------
function renderAll(){
  refreshGenreSelect();
  renderHome();
  renderSeatManage();
  // order/checkout are rendered when open
  // sales is rendered when open
  renderUndoInfo();
}
function escapeHtml(s){
  return safeText(s).replace(/[&<>"']/g, c=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[c]));
}
function escapeAttr(s){ return escapeHtml(s); }

// ---------- Start ----------
load();
renderAll();
nav("home");
</script>
</body>
</html>
