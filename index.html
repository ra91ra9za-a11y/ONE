<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>ONE（無料版）</title>
  <style>
    /* =========================
      1) 横ズレ防止（全ページ）
      - 横スクロール禁止
      - iOSのズーム暴発抑制
    ========================= */
    html, body{
      width:100%;
      height:100%;
      overflow-x:hidden;
      overscroll-behavior-x:none;
      touch-action: pan-y;
    }
    body{
      margin:0;
      font-family: -apple-system, BlinkMacSystemFont, "Hiragino Kaku Gothic ProN", "Noto Sans JP", sans-serif;
      -webkit-text-size-adjust:100%;
      text-size-adjust:100%;
      background: #0f1720; /* 飲食店向きの落ち着いた濃色 */
      color:#eaf0f6;
    }

    :root{
      --bg:#0f1720;
      --panel:#131e2a;
      --panel2:#0f1a25;
      --card:#182638;
      --card2:#1a2a3f;
      --line:rgba(255,255,255,.10);
      --muted:rgba(234,240,246,.72);
      --muted2:rgba(234,240,246,.55);
      --accent:#2dbE60; /* 基本アクセント */
      --accent2:#8fe35a; /* 黄緑（スライダー） */
      --warn:#ff5757;
      --amber:#ffbf3c;
      --shadow: 0 8px 24px rgba(0,0,0,.35);
      --radius:14px;
      --radius2:18px;
      --tap: rgba(255,255,255,.08);
    }

    /* 文字・入力の見やすさ（小さすぎ問題対策） */
    html{ font-size:18px; }
    *{ box-sizing:border-box; }
    button, input, select{ font: inherit; }
    input[type="text"], input[type="number"], select{
      width:100%;
      background: rgba(255,255,255,.06);
      color:#eaf0f6;
      border:1px solid var(--line);
      border-radius:12px;
      padding:12px 12px;
      outline:none;
    }
    input::placeholder{ color: rgba(234,240,246,.45); }

    /* 数字欄（10） */
    .numField{
      width: 88px;              /* 広すぎ修正 */
      text-align:center;
      font-size:1.12rem;        /* 数字は少し大きく */
      padding:10px 10px;
    }

    /* ボタン */
    button{
      background: rgba(255,255,255,.08);
      color:#eaf0f6;
      border:1px solid var(--line);
      border-radius:14px;
      padding:14px 14px;
      min-height: 50px;
      cursor:pointer;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }
    button:active{ background: rgba(255,255,255,.12); }
    .btnPrimary{
      background: rgba(45,190,96,.16);
      border-color: rgba(45,190,96,.45);
    }
    .btnPrimary:active{ background: rgba(45,190,96,.22); }
    .btnDanger{
      background: rgba(255,87,87,.12);
      border-color: rgba(255,87,87,.45);
    }
    .btnGhost{
      background: transparent;
    }
    .btnSmall{
      min-height: 42px;
      padding:10px 12px;
      border-radius:12px;
      font-size:.95rem;
    }
    .btnRow{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
    }
    .btnRow > button{ flex:1; }

    /* 上部固定ヘッダー */
    .topbar{
      position: sticky;
      top:0;
      z-index:50;
      padding: 10px 12px calc(10px + env(safe-area-inset-top));
      background: linear-gradient(180deg, rgba(15,23,32,.96), rgba(15,23,32,.86));
      backdrop-filter: blur(10px);
      border-bottom: 1px solid var(--line);
    }
    .topbarInner{
      display:grid;
      grid-template-columns: 1fr auto 1fr;
      align-items:center;
      gap:10px;
    }
    .brandBtn{
      justify-self:start;
      display:inline-flex;
      align-items:center;
      gap:10px;
      padding:10px 12px;
      min-height:44px;
      border-radius:14px;
    }
    .brandDot{
      width:10px; height:10px; border-radius:99px;
      background: var(--accent);
      box-shadow: 0 0 0 6px rgba(45,190,96,.18);
    }
    .topCenter{
      justify-self:center;
      display:flex;
      gap:8px;
      align-items:center;
    }
    .topRight{
      justify-self:end;
      display:flex;
      gap:8px;
      align-items:center;
    }

    /* メイン：席表示 */
    .content{
      padding: 12px 12px 140px; /* 下部固定のぶん余白 */
      max-width: 920px;
      margin: 0 auto;
    }
    .gridSeats{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap:10px;
    }
    @media (max-width: 420px){
      .gridSeats{ grid-template-columns: repeat(3, 1fr); }
    }
    .seatCard{
      background: linear-gradient(180deg, rgba(24,38,56,.92), rgba(20,32,48,.92));
      border:1px solid var(--line);
      border-radius: 16px;
      padding: 10px 10px;
      box-shadow: var(--shadow);
      min-height: 92px; /* 13: 巨大化防止 */
      display:flex;
      flex-direction:column;
      gap:6px;
      overflow:hidden; /* 13: 省略 */
    }
    .seatTop{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
    }
    .seatLabel{
      font-weight: 800;
      font-size: 1.12rem;
      letter-spacing: .02em;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width: 60%;
    }
    .seatStatus{
      font-size:.88rem;
      color: var(--muted);
      white-space:nowrap;
    }
    .seatMeta{
      font-size:.88rem;
      color: var(--muted);
      display:flex;
      gap:8px;
      align-items:center;
      flex-wrap:wrap;
      min-height: 18px;
    }
    .seatMoney{
      margin-top:auto;
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap:8px;
    }
    .yen{
      font-weight: 900;
      font-size: 1.15rem;
      white-space:nowrap;
    }
    .tagMini{
      font-size:.8rem;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid var(--line);
      color: var(--muted);
      background: rgba(255,255,255,.04);
      white-space:nowrap;
    }
    .seatCard.active{
      outline: 2px solid rgba(45,190,96,.55);
    }
    .seatCard.reserve{
      outline: 2px solid rgba(255,191,60,.55);
    }
    .seatCard.merged{
      outline: 2px dashed rgba(234,240,246,.30);
      opacity:.78;
    }

    /* 下部固定：操作エリア（17,18） */
    .bottomDock{
      position: fixed;
      left:0; right:0; bottom:0;
      z-index: 60;
      padding: 10px 12px calc(10px + env(safe-area-inset-bottom));
      background: linear-gradient(180deg, rgba(15,23,32,.55), rgba(15,23,32,.94));
      border-top: 1px solid var(--line);
      backdrop-filter: blur(10px);
    }
    .dockWrap{
      max-width: 920px;
      margin: 0 auto;
      display:flex;
      flex-direction:column;
      gap:10px;
    }

    .opsBox{
      border:1px solid var(--line);
      border-radius: 16px;
      padding: 10px;
      background: rgba(19,30,42,.75);
    }
    .opsRow{
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap:10px;
    }
    .opsBtn{
      min-height: 54px;
      font-size: 1.05rem;
      font-weight: 800;
    }
    .opsBtn .twoLine{
      display:flex;
      flex-direction:column;
      line-height: 1.05;
      gap:2px;
      align-items:center;
    }
    .opsBtn.same{
      background: rgba(255,255,255,.06);
    }
    .opsBtn.same.selected{
      background: rgba(45,190,96,.16);
      border-color: rgba(45,190,96,.45);
    }
    .opsBtn.decide{
      background: rgba(45,190,96,.22);
      border-color: rgba(45,190,96,.55);
    }

    .bottomRow2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    .bottomRow2 button{
      min-height: 52px;
      font-weight: 800;
    }

    /* 設定：カード一覧 */
    .cardGrid2{
      display:grid;
      grid-template-columns: repeat(2, 1fr);
      gap:10px;
    }
    .menuCard{
      background: rgba(24,38,56,.86);
      border: 1px solid var(--line);
      border-radius: 16px;
      padding: 14px;
      box-shadow: var(--shadow);
      min-height: 72px;
      display:flex;
      align-items:center;
      justify-content:center;
      text-align:center;
      font-weight: 900;
      letter-spacing:.02em;
    }
    .menuCard:active{ background: rgba(255,255,255,.10); }

    /* 注文：固定ヘッダー（8） */
    .orderHeaderFixed{
      position: sticky;
      top: 64px; /* topbarの下 */
      z-index: 45;
      background: rgba(15,23,32,.92);
      border-bottom: 1px solid var(--line);
      padding: 10px 12px;
      margin: 0 -12px 12px;
      backdrop-filter: blur(10px);
    }
    .orderHeaderRow{
      display:flex;
      justify-content:space-between;
      gap:10px;
      align-items:center;
    }
    .orderHeaderTitle{
      font-weight: 900;
      font-size: 1.05rem;
      color:#eaf0f6;
      display:flex;
      gap:8px;
      align-items:center;
    }
    .orderHeaderTitle .badge{
      font-size:.82rem;
      padding: 4px 9px;
      border-radius:999px;
      border:1px solid rgba(45,190,96,.45);
      background: rgba(45,190,96,.14);
    }

    /* 注文：ジャンル一覧 / 商品（24: 3列） */
    .genreGrid{
      display:grid;
      grid-template-columns: repeat(2, 1fr);
      gap:10px;
    }
    .genreBtn{
      min-height: 56px;
      font-weight: 900;
      background: rgba(255,255,255,.06);
    }
    .itemsGrid{
      display:grid;
      grid-template-columns: repeat(3, 1fr); /* 24 */
      gap:10px;
    }
    .itemBtn{
      min-height: 66px;
      font-weight: 900;
      padding: 12px 10px;
    }
    .itemBtn small{
      display:block;
      margin-top:6px;
      color: var(--muted);
      font-weight:700;
      font-size:.86rem;
    }

    /* 注文履歴 */
    .listBox{
      margin-top: 12px;
      border:1px solid var(--line);
      border-radius: 16px;
      background: rgba(19,30,42,.60);
      overflow:hidden;
    }
    .listBox .listHead{
      padding: 10px 12px;
      border-bottom:1px solid var(--line);
      color: var(--muted);
      font-weight:900;
      font-size:.92rem;
      display:flex;
      justify-content:space-between;
      align-items:center;
    }
    .listRow{
      display:grid;
      grid-template-columns: 1fr auto auto;
      gap:10px;
      align-items:center;
      padding: 10px 12px;
      border-bottom:1px solid rgba(255,255,255,.06);
    }
    .listRow:last-child{ border-bottom:none; }
    .listName{
      font-weight:900;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    .listMeta{
      color: var(--muted);
      font-weight:800;
      white-space:nowrap;
    }
    .listBtn{
      min-height: 40px;
      padding: 8px 10px;
      border-radius: 12px;
      font-size:.92rem;
      font-weight:900;
    }

    /* 会計：支払い方法（15） */
    .payBtns{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap:10px;
    }
    .payBtn{
      min-height: 54px;
      font-weight: 900;
    }
    .payBtn.selected{
      background: rgba(45,190,96,.18);
      border-color: rgba(45,190,96,.55);
    }

    /* モーダル（2,3） */
    .modalRoot{
      position: fixed;
      inset:0;
      z-index: 200;
      display:none;
      align-items:center;
      justify-content:center;
      padding: 16px;
      background: rgba(0,0,0,.55);
      backdrop-filter: blur(4px);
    }
    .modalRoot.show{ display:flex; }
    .modal{
      width: min(520px, 100%);
      background: linear-gradient(180deg, rgba(24,38,56,.98), rgba(19,30,42,.98));
      border:1px solid var(--line);
      border-radius: 18px;
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .modalHead{
      padding: 14px 14px 10px;
      border-bottom: 1px solid var(--line);
    }
    .modalTitle{
      font-weight: 900;
      font-size: 1.05rem;
    }
    .modalSub{
      margin-top: 6px;
      color: var(--muted);
      font-weight: 700;
      font-size:.92rem;
      line-height:1.35;
    }
    .modalBody{
      padding: 12px 14px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .modalFoot{
      padding: 12px 14px 14px;
      border-top:1px solid var(--line);
      display:flex;
      gap:10px;
    }
    .modalFoot button{ flex:1; }

    /* 人数ステッパー（2） */
    .stepper{
      display:flex;
      align-items:center;
      gap:10px;
      justify-content:center;
      padding: 8px 0;
    }
    .stepBtn{
      width: 54px;
      min-height: 54px;
      font-size: 1.25rem;
      font-weight: 900;
      border-radius: 16px;
    }
    .stepNum{
      width: 96px;
      text-align:center;
      font-weight: 900;
      font-size: 1.25rem;
      padding: 12px 0;
      border-radius: 16px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.06);
    }

    /* キッチン */
    .kTabs{
      display:flex;
      gap:10px;
      margin-top: 10px;
    }
    .kTabs button{
      flex:1;
      min-height: 48px;
      font-weight: 900;
    }
    .kTabs button.selected{
      background: rgba(45,190,96,.18);
      border-color: rgba(45,190,96,.55);
    }

    .kList{
      display:flex;
      flex-direction:column;
      gap:8px;
      margin-top: 12px;
    }
    .kCard{
      position: relative;
      background: rgba(24,38,56,.88);
      border:1px solid var(--line);
      border-radius: 16px;
      padding: 10px 12px;
      display:grid;
      grid-template-columns: 1fr auto;
      gap:10px;
      align-items:center;
      overflow:hidden;
    }
    .kCard::before{
      content:"";
      position:absolute;
      left:0; top:0; bottom:0;
      width: 6px;
      background: rgba(45,190,96,.65);
    }
    .kCard.promoted::before{ background: rgba(255,191,60,.75); } /* 昇格色 */
    .kCard.overdue .kName{ color: var(--warn); } /* 15分赤 */
    .kName{
      font-weight: 950;
      font-size: 1.10rem; /* 料理名大きめ */
      line-height:1.2;
    }
    .kMeta{
      margin-top: 6px;
      color: var(--muted);
      font-weight: 800;
      font-size:.92rem;
      display:flex;
      gap:14px;
      flex-wrap:wrap;
    }
    .kQty{
      font-weight: 950;
      font-size: 1.12rem; /* 個数少し大きく */
      margin-left: 10px;   /* 右に離して見やすく */
      color:#eaf0f6;
    }
    .kSubLine{
      margin-top: 8px;
      padding-left: 10px;
      border-left: 2px dashed rgba(255,255,255,.12);
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .kSubItem{
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
      padding: 6px 8px;
      border-radius: 12px;
      background: rgba(255,255,255,.04);
      border:1px solid rgba(255,255,255,.08);
    }
    .kSubLeft{
      display:flex;
      align-items:center;
      gap:10px;
      overflow:hidden;
      white-space:nowrap;
      text-overflow:ellipsis;
    }
    .kTime{
      font-weight:900;
      color: var(--muted);
    }
    .kSeat{
      font-weight: 950;
      color: rgba(234,240,246,.92);
    }

    /* 完了スライダー（短く・太く・黄緑） */
    .slider{
      width: 140px;               /* 半分くらい短く */
      height: 42px;
      border-radius: 999px;
      background: rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.16);
      position: relative;
      overflow:hidden;
      justify-self:end;
    }
    .sliderTrack{
      position:absolute; inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      color: rgba(234,240,246,.55);
      font-weight: 900;
      font-size:.9rem;
      pointer-events:none;
    }
    .sliderKnob{
      position:absolute;
      left: 2px;
      top: 2px;
      width: 38px;
      height: 38px;
      border-radius: 999px;
      background: rgba(143,227,90,.92); /* 黄緑 */
      box-shadow: 0 8px 18px rgba(0,0,0,.35);
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight: 950;
      color:#0b121a;
      user-select:none;
      touch-action: pan-x;
    }

    /* セクション表示 */
    .view{ display:none; }
    .view.show{ display:block; }

    .muted{ color: var(--muted); }
    .muted2{ color: var(--muted2); }

    .warnText{
      color: var(--warn);
      font-weight: 950;
    }

    /* 小物 */
    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 8px 10px;
      border-radius: 999px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.04);
      font-weight: 900;
      color: var(--muted);
      font-size:.9rem;
    }
    .hr{ height:1px; background: rgba(255,255,255,.08); margin: 10px 0; }

    /* iOS ダブルタップズーム抑制（完全ではないが軽減） */
    button, .seatCard, .menuCard, .genreBtn, .itemBtn{
      touch-action: manipulation;
    }
  </style>
</head>

<body>
  <!-- =========================
    TOP BAR
  ========================= -->
  <div class="topbar" id="topbar">
    <div class="topbarInner">
      <button class="brandBtn btnGhost" id="brandBtn" title="無料/有料の入口">
        <span class="brandDot"></span>
        <span style="font-weight:950; letter-spacing:.02em;">ONE</span>
      </button>

      <div class="topCenter" id="topCenter">
        <button class="btnSmall" id="kitchenBtn">キッチン</button>
      </div>

      <div class="topRight" id="topRight">
        <button class="btnSmall" id="backupBtn">バックアップ</button>
      </div>
    </div>
  </div>

  <!-- =========================
    CONTENT
  ========================= -->
  <div class="content">

    <!-- MAIN VIEW -->
    <section class="view show" id="viewMain">
      <div class="muted" style="font-weight:900; margin: 4px 0 10px;">
        席（空席タップ → 来店 / 予約）
      </div>
      <div class="gridSeats" id="seatGrid"></div>
      <div style="height:12px;"></div>
      <div class="muted2" style="font-size:.92rem;">
        ※ 下の「席移動 / 合計合算 / 合計分割」を押すと選択状態になります（再タップで解除）→「決定」で実行。
      </div>
    </section>

    <!-- SETTINGS VIEW -->
    <section class="view" id="viewSettings">
      <div class="muted" style="font-weight:950; margin: 6px 0 12px;">
        設定
      </div>
      <div class="cardGrid2">
        <div class="menuCard" data-go="seatRegister">席登録</div>
        <div class="menuCard" data-go="menuRegister">メニュー登録</div>
        <div class="menuCard" data-go="sales">売上</div>
        <div class="menuCard" data-go="storeInfo">店舗情報</div>
        <div class="menuCard" data-go="contact">お問合せ</div>
        <div class="menuCard" data-go="recipe" style="opacity:.55;">料理提案（有料準備中）</div>
      </div>
      <div style="height:14px;"></div>
      <div class="muted2" style="font-size:.92rem;">
        ※ 料理提案（ライト）は有料版に入れる予定（現在準備中）
      </div>
    </section>

    <!-- SEAT REGISTER VIEW -->
    <section class="view" id="viewSeatRegister">
      <div class="muted" style="font-weight:950; margin: 6px 0 12px;">
        席登録
      </div>

      <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
        <span class="pill">手順：名称 → 総席/総卓 → 席番号 → 最大人数</span>
        <button class="btnSmall btnDanger" id="resetSeatReg">削除（入力を初期化）</button>
      </div>

      <div class="hr"></div>

      <!-- 名称選択 -->
      <div class="muted" style="font-weight:900; margin-bottom:8px;">名称</div>
      <div class="btnRow">
        <button class="btnSmall" data-seatType="counter">カウンター</button>
        <button class="btnSmall" data-seatType="stand">立ち</button>
        <button class="btnSmall" data-seatType="table">テーブル</button>
      </div>
      <div class="btnRow" style="margin-top:8px;">
        <button class="btnSmall" data-seatType="zashiki">座敷</button>
        <button class="btnSmall" data-seatType="room">個室</button>
        <button class="btnSmall" data-seatType="other">その他</button>
      </div>

      <div id="otherNameWrap" style="display:none; margin-top:10px;">
        <div class="muted" style="font-weight:900; margin-bottom:8px;">その他の名称（例：中庭テラス）</div>
        <input id="otherName" type="text" placeholder="例：中庭テラス" />
        <div class="muted2" style="font-size:.9rem; margin-top:6px;">
          ※ 入力した名称は次回以降、名称一覧として使えます（無料版では簡易保存）
        </div>
      </div>

      <div class="hr"></div>

      <!-- 総数 -->
      <div class="muted" style="font-weight:900; margin-bottom:8px;" id="countLabel">総席数 / 総卓数</div>
      <div style="display:flex; gap:10px; align-items:center;">
        <button class="stepBtn" id="countDec">◀︎</button>
        <div class="stepNum" id="countNum">0</div>
        <button class="stepBtn" id="countInc">▶︎</button>
      </div>

      <div class="hr"></div>

      <!-- 席番号入力 -->
      <div class="muted" style="font-weight:900; margin-bottom:8px;">席番号（自動で次が入ります）</div>
      <div class="muted2" style="font-size:.92rem; margin-bottom:10px;">
        例：1 → 2 / A → B / C1 → C2（アルファベットは大文字）
      </div>
      <div id="seatInputs"></div>

      <div class="hr"></div>

      <!-- 最大着席人数 -->
      <div class="muted" style="font-weight:900; margin-bottom:8px;">最大着席人数（席ごと）</div>
      <div id="capInputs"></div>

      <div style="height:12px;"></div>
      <div class="btnRow">
        <button class="btnPrimary" id="saveSeats">保存</button>
        <button id="backMainFromSeatReg">戻る</button>
      </div>

      <div class="hr"></div>

      <!-- 作った席一覧（下部に表示・タップで編集は次フェーズ簡易） -->
      <div class="muted" style="font-weight:950; margin: 6px 0 10px;">作った席</div>
      <div class="gridSeats" id="seatPreviewGrid"></div>
      <div class="muted2" style="font-size:.9rem; margin-top:8px;">
        ※ 無料版は「席の個別編集」は簡易対応（次フェーズで強化）
      </div>
    </section>

    <!-- MENU REGISTER VIEW -->
    <section class="view" id="viewMenuRegister">
      <div class="muted" style="font-weight:950; margin: 6px 0 12px;">
        メニュー登録
      </div>

      <div class="muted2" style="font-size:.92rem;">
        カテゴリー（料理/ドリンク）はキッチンの「料理/ドリンク」表示に反映します（注文には出しません）。
      </div>
      <div style="height:10px;"></div>

      <div class="btnRow">
        <button class="btnSmall btnPrimary" id="photoBtn">写真撮影</button>
        <button class="btnSmall btnDanger" id="photoClearBtn">写真を消す</button>
      </div>
      <div class="warnText" style="margin-top:8px;">
        誤認識前提になります（無料版）
      </div>
      <div class="muted2" style="font-size:.9rem; margin-top:6px;">
        ※ 写真からの自動読み取り（OCR）は改善中（19: 未完成項目）
      </div>

      <div class="hr"></div>

      <div class="muted" style="font-weight:900; margin-bottom:8px;">手動登録</div>
      <div class="btnRow">
        <select id="mCategory">
          <option value="food">料理</option>
          <option value="drink">ドリンク</option>
        </select>
        <input id="mGenre" type="text" placeholder="ジャンル（例：揚げ物）" />
      </div>
      <div style="height:10px;"></div>
      <input id="mName" type="text" placeholder="商品名（重複不可）" />
      <div style="height:10px;"></div>
      <div style="display:flex; gap:10px; align-items:center;">
        <input id="mPrice" class="numField" type="number" inputmode="numeric" placeholder="金額" />
        <select id="mTax" style="width:160px;">
          <option value="10">10%</option>
          <option value="8">8%</option>
        </select>
        <button class="btnPrimary" id="mAdd">登録</button>
      </div>

      <div class="hr"></div>

      <div class="muted" style="font-weight:950; margin: 6px 0 10px;">登録済み（あいうえお順）</div>
      <div id="menuList"></div>

      <div style="height:12px;"></div>
      <button id="backMainFromMenuReg">戻る</button>

      <!-- hidden file input for photo -->
      <input id="photoInput" type="file" accept="image/*" capture="environment" style="display:none;" />
    </section>

    <!-- ORDER VIEW -->
    <section class="view" id="viewOrder">
      <div class="orderHeaderFixed" id="orderHeaderFixed">
        <div class="orderHeaderRow">
          <div class="orderHeaderTitle">
            <span class="badge" id="orderSeatBadge">席</span>
            <span id="orderSeatText">注文</span>
          </div>
          <button class="btnSmall" id="orderToMain">メイン</button>
        </div>
      </div>

      <div id="orderStageGenres">
        <div class="muted" style="font-weight:950; margin-bottom:10px;">ジャンル</div>
        <div class="genreGrid" id="genreGrid"></div>
      </div>

      <div id="orderStageItems" style="display:none;">
        <div class="itemsGrid" id="itemsGrid"></div>
      </div>

      <div class="listBox" id="orderListBox">
        <div class="listHead">
          <span>注文履歴</span>
          <span class="muted2" id="orderSum">合計 ¥0</span>
        </div>
        <div id="orderList"></div>
      </div>

      <div style="height:12px;"></div>
      <div class="btnRow">
        <button class="btnPrimary" id="goCheckout">会計へ</button>
        <button id="backToGenres">ジャンルへ</button>
      </div>
    </section>

    <!-- CHECKOUT VIEW -->
    <section class="view" id="viewCheckout">
      <div class="muted" style="font-weight:950; margin: 6px 0 12px;">
        会計
      </div>

      <div class="seatCard" style="min-height:auto;">
        <div class="seatTop">
          <div class="seatLabel" id="coSeatLabel">席</div>
          <div class="seatStatus" id="coPeople">人数</div>
        </div>
        <div class="yen" style="font-size:1.45rem;" id="coTotal">合計 ¥0</div>
      </div>

      <div style="height:12px;"></div>

      <div class="muted" style="font-weight:900; margin-bottom:8px;">支払い方法</div>
      <div class="payBtns">
        <button class="payBtn" data-pay="cash">現金</button>
        <button class="payBtn" data-pay="card">カード</button>
        <button class="payBtn" data-pay="qr">QR/電子決済</button>
      </div>

      <div style="height:12px;"></div>
      <div class="btnRow">
        <button class="btnSmall" id="warikanBtn">割り勘</button>
        <button class="btnPrimary" id="confirmCheckout">会計確定</button>
      </div>

      <div class="listBox" style="margin-top:12px;">
        <div class="listHead">
          <span>注文一覧（修正）</span>
          <span class="muted2">0個にすると消えます</span>
        </div>
        <div id="checkoutOrderList"></div>
      </div>

      <div style="height:12px;"></div>
      <button id="checkoutToMain">メイン</button>
    </section>

    <!-- KITCHEN VIEW -->
    <section class="view" id="viewKitchen">
      <div class="muted" style="font-weight:950; margin: 6px 0 6px;">
        <span id="kTitle">ホール</span>
      </div>

      <div class="btnRow">
        <button class="btnSmall" id="kRefresh">更新</button>
        <button class="btnSmall btnPrimary" id="kHall">ホール</button>
      </div>

      <div class="kTabs">
        <button class="selected" id="kFoodTab">料理</button>
        <button id="kDrinkTab">ドリンク</button>
      </div>

      <div class="kList" id="kList"></div>
      <div class="muted2" style="font-size:.9rem; margin-top:10px;">
        ※ 料理：同じ料理は下にぶら下げ（昇格した側のみ色） / ドリンク：まとめない
      </div>
    </section>

    <!-- SALES VIEW -->
    <section class="view" id="viewSales">
      <div class="muted" style="font-weight:950; margin: 6px 0 12px;">
        売上
      </div>
      <div class="btnRow">
        <button class="btnPrimary" id="goMonthSales">月売上</button>
        <button class="btnPrimary" id="goYearSales">年売上</button>
        <button class="btnPrimary" id="goSalesManage">売上管理</button>
      </div>
      <div style="height:12px;"></div>
      <button id="salesToMain">メイン</button>
    </section>

    <section class="view" id="viewMonthSales">
      <div class="muted" style="font-weight:950; margin: 6px 0 12px;">月売上</div>
      <div class="btnRow">
        <button class="btnSmall" id="monthToYear">年売上</button>
        <button class="btnSmall" id="monthToManage">売上管理</button>
      </div>
      <div class="hr"></div>
      <div id="monthSalesBox" class="muted2"></div>
      <div style="height:12px;"></div>
      <button id="monthToMain">メイン</button>
    </section>

    <section class="view" id="viewYearSales">
      <div class="muted" style="font-weight:950; margin: 6px 0 12px;">年売上</div>
      <div class="btnRow">
        <button class="btnSmall" id="yearToMonth">月売上</button>
        <button class="btnSmall" id="yearToManage">売上管理</button>
      </div>
      <div class="hr"></div>
      <div id="yearSalesBox" class="muted2"></div>
      <div style="height:12px;"></div>
      <button id="yearToMain">メイン</button>
    </section>

    <section class="view" id="viewSalesManage">
      <div class="muted" style="font-weight:950; margin: 6px 0 12px;">売上管理</div>
      <div class="btnRow">
        <button class="btnSmall" id="manageToMonth">月売上</button>
        <button class="btnSmall" id="manageToYear">年売上</button>
      </div>
      <div class="hr"></div>
      <div class="btnRow">
        <button class="btnPrimary" id="exportCsv">CSVファイル（日本語）を出力</button>
        <button class="btnDanger" id="clearSales">売上を全削除（危険）</button>
      </div>
      <div class="hr"></div>
      <div id="salesLog" class="muted2"></div>
      <div style="height:12px;"></div>
      <button id="manageToMain">メイン</button>
    </section>

    <!-- STORE INFO / CONTACT (簡易) -->
    <section class="view" id="viewStoreInfo">
      <div class="muted" style="font-weight:950; margin: 6px 0 12px;">店舗情報</div>
      <div class="muted2">
        無料版：保存は簡易（ローカル）<br>
        有料版：電子レシートに「店舗名・連絡先・住所」を自動反映予定
      </div>
      <div class="hr"></div>
      <input id="stName" type="text" placeholder="店舗名" />
      <div style="height:10px;"></div>
      <input id="stPhone" type="text" placeholder="連絡先（電話）" />
      <div style="height:10px;"></div>
      <input id="stAddr" type="text" placeholder="住所" />
      <div style="height:12px;"></div>
      <div class="btnRow">
        <button class="btnPrimary" id="saveStoreInfo">保存</button>
        <button id="storeToMain">メイン</button>
      </div>
    </section>

    <section class="view" id="viewContact">
      <div class="muted" style="font-weight:950; margin: 6px 0 12px;">お問合せ</div>
      <div class="muted2">
        無料版：画面サンプルです（送信は実装準備中）
      </div>
      <div class="hr"></div>
      <input type="text" placeholder="件名" />
      <div style="height:10px;"></div>
      <input type="text" placeholder="内容（簡易）" />
      <div style="height:12px;"></div>
      <button id="contactToMain">メイン</button>
    </section>

    <!-- RECIPE placeholder -->
    <section class="view" id="viewRecipe">
      <div class="muted" style="font-weight:950; margin: 6px 0 12px;">料理提案（有料準備中）</div>
      <div class="muted2">この機能は有料版に入れる予定（ライト版）。</div>
      <div style="height:12px;"></div>
      <button id="recipeToMain">メイン</button>
    </section>

  </div>

  <!-- =========================
    BOTTOM DOCK (17,18)
  ========================= -->
  <div class="bottomDock" id="bottomDock">
    <div class="dockWrap">

      <div class="opsBox">
        <div class="opsRow">
          <button class="opsBtn same" data-op="move">
            <div class="twoLine"><span>席移動</span></div>
          </button>
          <button class="opsBtn same" data-op="merge">
            <div class="twoLine"><span>合計</span><span>合算</span></div>
          </button>
          <button class="opsBtn same" data-op="split">
            <div class="twoLine"><span>合計</span><span>分割</span></div>
          </button>
          <button class="opsBtn decide" id="opDecide">決定</button>
        </div>
      </div>

      <div class="bottomRow2">
        <button id="todaySalesBtn">本日の売上</button>
        <button id="settingsBtn">設定</button>
      </div>

    </div>
  </div>

  <!-- =========================
    MODAL ROOT (2,3)
  ========================= -->
  <div class="modalRoot" id="modalRoot">
    <div class="modal">
      <div class="modalHead">
        <div class="modalTitle" id="mTitle">タイトル</div>
        <div class="modalSub" id="mSub"></div>
      </div>
      <div class="modalBody" id="mBody"></div>
      <div class="modalFoot" id="mFoot"></div>
    </div>
  </div>

<script>
/* =========================
  保存データ（ローカル）
========================= */
const KEY = "ONE_FREE_V1";
const nowTs = ()=> Date.now();
const pad2 = (n)=> String(n).padStart(2,"0");
const fmtTime = (ts)=>{
  const d = new Date(ts);
  return `${pad2(d.getHours())}:${pad2(d.getMinutes())}`;
};
const yen = (n)=> `¥${(n||0).toLocaleString("ja-JP")}`;
const jaSort = (a,b)=> (a||"").localeCompare((b||""), "ja", { sensitivity:"base" });

const defaultState = {
  seats: [],          // {id,label,typeName,cap,status,party:{people,name,phone},openedAt,orders:[], mergedInto:null}
  menu: [],           // {id,category(food/drink), genre, name, price, tax}
  sales: [],          // {id, ts, amount, pay, seatLabel, items:[{name,qty,price}]}
  store: { name:"", phone:"", addr:"" },
  ui: {
    view:"main",
    selectedSeatIds: [],
    opSelected: null,
    orderSeatId: null,
    orderGenre: null,
    kitchenTab: "food",
    pay: "cash"
  },
  kitchenDone: {} // key -> true
};

let state = load();

/* =========================
  Load/Save
========================= */
function load(){
  try{
    const raw = localStorage.getItem(KEY);
    if(!raw) return structuredClone(defaultState);
    const s = JSON.parse(raw);
    // マージ
    return {
      ...structuredClone(defaultState),
      ...s,
      ui: { ...structuredClone(defaultState.ui), ...(s.ui||{}) },
      store: { ...structuredClone(defaultState.store), ...(s.store||{}) },
      kitchenDone: s.kitchenDone || {}
    };
  }catch(e){
    return structuredClone(defaultState);
  }
}
function save(){
  localStorage.setItem(KEY, JSON.stringify(state));
}

/* =========================
  Views
========================= */
const views = {
  main: document.getElementById("viewMain"),
  settings: document.getElementById("viewSettings"),
  seatRegister: document.getElementById("viewSeatRegister"),
  menuRegister: document.getElementById("viewMenuRegister"),
  order: document.getElementById("viewOrder"),
  checkout: document.getElementById("viewCheckout"),
  kitchen: document.getElementById("viewKitchen"),
  sales: document.getElementById("viewSales"),
  month: document.getElementById("viewMonthSales"),
  year: document.getElementById("viewYearSales"),
  manage: document.getElementById("viewSalesManage"),
  storeInfo: document.getElementById("viewStoreInfo"),
  contact: document.getElementById("viewContact"),
  recipe: document.getElementById("viewRecipe"),
};
function go(viewKey){
  Object.values(views).forEach(v=> v.classList.remove("show"));
  views[viewKey].classList.add("show");
  state.ui.view = viewKey;
  save();
  // viewごとの初期化
  if(viewKey==="main") renderMain();
  if(viewKey==="settings") renderSettings();
  if(viewKey==="seatRegister") renderSeatRegisterPreview();
  if(viewKey==="menuRegister") renderMenuList();
  if(viewKey==="order") renderOrder();
  if(viewKey==="checkout") renderCheckout();
  if(viewKey==="kitchen") renderKitchen();
  if(viewKey==="sales") renderSales();
  if(viewKey==="month") renderMonthSales();
  if(viewKey==="year") renderYearSales();
  if(viewKey==="manage") renderSalesManage();
  if(viewKey==="storeInfo") renderStoreInfo();
}

/* =========================
  Modal (3: 背景固定)
========================= */
const modalRoot = document.getElementById("modalRoot");
const mTitle = document.getElementById("mTitle");
const mSub = document.getElementById("mSub");
const mBody = document.getElementById("mBody");
const mFoot = document.getElementById("mFoot");

function lockBg(lock){
  if(lock){
    document.documentElement.style.overflow = "hidden";
    document.body.style.overflow = "hidden";
  }else{
    document.documentElement.style.overflow = "";
    document.body.style.overflow = "";
  }
}

function openModal({title, sub="", bodyHtml="", yesText="OK", noText="", onYes=null, onNo=null, yesClass="btnPrimary", noClass=""}){
  mTitle.textContent = title || "";
  mSub.textContent = sub || "";
  mBody.innerHTML = bodyHtml || "";
  mFoot.innerHTML = "";

  if(noText){
    const bNo = document.createElement("button");
    bNo.textContent = noText;
    bNo.className = noClass || "";
    bNo.onclick = ()=>{
      closeModal();
      if(onNo) onNo();
    };
    mFoot.appendChild(bNo);
  }

  const bYes = document.createElement("button");
  bYes.textContent = yesText;
  bYes.className = yesClass || "";
  bYes.onclick = ()=>{
    if(onYes) onYes();
    else closeModal();
  };
  mFoot.appendChild(bYes);

  modalRoot.classList.add("show");
  lockBg(true);
}
function closeModal(){
  modalRoot.classList.remove("show");
  lockBg(false);
}

/* =========================
  Main: Seats
========================= */
const seatGrid = document.getElementById("seatGrid");

function seatTotal(seat){
  // merged seat: show 0 in merged card; main card includes sum of itself + merged-in seats
  const ids = [seat.id, ...state.seats.filter(s=> s.mergedInto===seat.id).map(s=> s.id)];
  let sum = 0;
  for(const sid of ids){
    const s = state.seats.find(x=> x.id===sid);
    if(!s) continue;
    for(const o of (s.orders||[])) sum += (o.price||0) * (o.qty||1);
  }
  return sum;
}

function seatDisplayLabel(seat){
  // 14: other name reflect (typeName stored)
  const typeName = seat.typeName || "";
  const label = seat.label || "";
  return label;
}

function renderMain(){
  // ensure selected seats kept; remove any deleted
  state.ui.selectedSeatIds = state.ui.selectedSeatIds.filter(id=> state.seats.some(s=> s.id===id));
  save();

  seatGrid.innerHTML = "";
  const sorted = [...state.seats].sort((a,b)=> {
    // seat label sort: numbers then alpha? use locale with numeric
    return (a.label||"").localeCompare((b.label||""), "ja", { numeric:true, sensitivity:"base" });
  });

  for(const seat of sorted){
    const card = document.createElement("div");
    card.className = "seatCard";
    const isSelected = state.ui.selectedSeatIds.includes(seat.id);
    if(isSelected) card.classList.add("active");

    if(seat.status==="reserve") card.classList.add("reserve");
    if(seat.mergedInto) card.classList.add("merged");

    const label = seatDisplayLabel(seat);
    const statusTxt = seat.mergedInto
      ? `合算 → ${state.seats.find(s=> s.id===seat.mergedInto)?.label || ""}`
      : seat.status==="empty" ? "空席"
      : seat.status==="reserve" ? "予約"
      : "着席";

    const people = seat.party?.people ? `${seat.party.people}名` : "";
    const opened = seat.openedAt ? fmtTime(seat.openedAt) : "";
    const name = seat.party?.name ? seat.party.name : "";

    const total = seat.mergedInto ? 0 : seatTotal(seat);

    // 13: undefinedを出さない、長い名前は省略
    const metaParts = [];
    if(people) metaParts.push(people);
    if(name) metaParts.push(name);
    if(opened) metaParts.push(opened);

    const mergedTag = seat.mergedInto ? `<span class="tagMini">合算</span>` : "";

    card.innerHTML = `
      <div class="seatTop">
        <div class="seatLabel" title="${label}">${label}</div>
        <div class="seatStatus">${statusTxt}</div>
      </div>
      <div class="seatMeta">${metaParts.map(x=>`<span>${escapeHtml(x)}</span>`).join("")}</div>
      <div class="seatMoney">
        <div class="yen">${yen(total)}</div>
        ${mergedTag}
      </div>
    `;

    card.onclick = ()=>{
      // 18: op selected -> selecting seats; normal -> open seat action / order
      if(state.ui.opSelected){
        toggleSeatSelect(seat.id);
        return;
      }
      // merged seat cards should not be opened for order
      if(seat.mergedInto){
        openModal({ title:"合算中の席です", sub:"合算の元の席を操作してください", yesText:"OK" });
        return;
      }
      onSeatTap(seat);
    };

    seatGrid.appendChild(card);
  }

  renderOpsButtons();
}

function toggleSeatSelect(id){
  const idx = state.ui.selectedSeatIds.indexOf(id);
  if(idx>=0) state.ui.selectedSeatIds.splice(idx,1);
  else state.ui.selectedSeatIds.push(id);
  save();
  renderMain();
}

/* =========================
  Seat tap flow (来店/予約)
========================= */
function onSeatTap(seat){
  if(seat.status==="empty"){
    openChooseArriveReserve(seat);
  }else if(seat.status==="reserve"){
    openReserveAction(seat);
  }else{
    // active -> open order
    openOrderForSeat(seat.id);
  }
}

function openChooseArriveReserve(seat){
  openModal({
    title:`席（${seat.label}）`,
    sub:"空席です。どれを選びますか？",
    bodyHtml: `
      <div class="btnRow">
        <button class="btnPrimary" id="chooseArrive">来店</button>
        <button class="btnPrimary" id="chooseReserve">予約</button>
      </div>
    `,
    yesText:"閉じる",
    noText:"",
    onYes: ()=> closeModal()
  });

  setTimeout(()=>{
    document.getElementById("chooseArrive").onclick = ()=> {
      closeModal();
      openPartyInput(seat, "arrive");
    };
    document.getElementById("chooseReserve").onclick = ()=> {
      closeModal();
      openPartyInput(seat, "reserve");
    };
  },0);
}

/* 2: 人数はステッパー / 3: モーダル中背景固定はopenModalで対応 */
function openPartyInput(seat, mode){
  const title = mode==="arrive" ? "来店入力" : "予約入力";
  const sub = mode==="arrive" ? "決定で注文ページへ移動します" : "決定でメインへ戻り、席が予約表示になります";

  const bodyHtml = `
    <div class="muted2">人数</div>
    <div class="stepper">
      <button class="stepBtn" id="piDec">◀︎</button>
      <div class="stepNum" id="piNum">1</div>
      <button class="stepBtn" id="piInc">▶︎</button>
    </div>

    <div class="muted2">名前（任意）</div>
    <input id="piName" type="text" placeholder="例：田中" />

    ${mode==="reserve" ? `
      <div class="muted2">電話番号（任意）</div>
      <input id="piPhone" type="text" placeholder="例：090-xxxx-xxxx" />
    ` : ``}
  `;

  openModal({
    title:`${title}（${seat.label}）`,
    sub,
    bodyHtml,
    yesText:"決定",
    noText:"戻る",
    onNo: ()=> { /* 戻る */ },
    onYes: ()=>{
      const people = parseInt(document.getElementById("piNum").textContent||"0",10);
      const name = (document.getElementById("piName").value||"").trim();
      const phone = mode==="reserve" ? (document.getElementById("piPhone").value||"").trim() : "";

      if(!people){
        openModal({ title:"人数を入力してください", sub:"", yesText:"OK" });
        return;
      }

      if(mode==="arrive"){
        seat.status="active";
        seat.party = { people, name, phone:"" };
        seat.openedAt = nowTs();
        seat.orders = seat.orders || [];
        seat.mergedInto = null;
        save();
        closeModal();
        // 決定で注文へ（仕様）
        openOrderForSeat(seat.id);
      }else{
        seat.status="reserve";
        seat.party = { people, name, phone };
        seat.openedAt = nowTs();
        seat.orders = seat.orders || [];
        seat.mergedInto = null;
        save();
        closeModal();
        renderMain();
        go("main");
      }
    }
  });

  setTimeout(()=>{
    let n = 1;
    const render = ()=> document.getElementById("piNum").textContent = String(n);
    render();
    document.getElementById("piDec").onclick = ()=> { n = Math.max(1, n-1); render(); };
    document.getElementById("piInc").onclick = ()=> { n = Math.min(99, n+1); render(); };
  },0);
}

function openReserveAction(seat){
  openModal({
    title:`予約（${seat.label}）`,
    sub:"どれを選びますか？",
    bodyHtml: `
      <div class="btnRow">
        <button class="btnPrimary" id="rvArrive">来店</button>
        <button class="btnDanger" id="rvCancel">キャンセル</button>
      </div>
    `,
    yesText:"戻る",
    onYes: ()=> closeModal()
  });

  setTimeout(()=>{
    document.getElementById("rvArrive").onclick = ()=>{
      closeModal();
      // 予約→来店：決定で注文へ
      openPartyInput(seat, "arrive");
      // arrive input will set status active
    };
    document.getElementById("rvCancel").onclick = ()=>{
      seat.status="empty";
      seat.party=null;
      seat.openedAt=null;
      seat.orders=[];
      seat.mergedInto=null;
      save();
      closeModal();
      renderMain();
    };
  },0);
}

/* =========================
  Ops (18)
========================= */
const opButtons = Array.from(document.querySelectorAll(".opsBtn.same"));
const opDecide = document.getElementById("opDecide");

function renderOpsButtons(){
  const selected = state.ui.opSelected;
  opButtons.forEach(b=>{
    const op = b.dataset.op;
    b.classList.toggle("selected", selected===op);
  });
}
opButtons.forEach(b=>{
  b.onclick = ()=>{
    const op = b.dataset.op;
    // toggle
    state.ui.opSelected = (state.ui.opSelected===op) ? null : op;
    // when toggling off, clear seat selections
    if(!state.ui.opSelected) state.ui.selectedSeatIds = [];
    save();
    renderMain();
  };
});

opDecide.onclick = ()=>{
  const op = state.ui.opSelected;
  if(!op){
    openModal({ title:"操作を選んでください", sub:"席移動 / 合計合算 / 合計分割 のどれかを選択します", yesText:"OK" });
    return;
  }
  const ids = state.ui.selectedSeatIds;
  if(ids.length===0){
    openModal({ title:"席を選択してください", sub:"操作したい席をタップして選びます（再タップで解除）", yesText:"OK" });
    return;
  }

  if(op==="merge"){
    if(ids.length<2){
      openModal({ title:"合計合算", sub:"2席以上を選択してください", yesText:"OK" });
      return;
    }
    // base seat: labelが若い方（仕様）
    const seats = ids.map(id=> state.seats.find(s=> s.id===id)).filter(Boolean);
    seats.sort((a,b)=> (a.label||"").localeCompare((b.label||""), "ja", { numeric:true, sensitivity:"base" }));
    const base = seats[0];
    const others = seats.slice(1);

    openModal({
      title:"合計合算しますか？",
      sub:`「${base.label}」に合算します（他の席は「合算」表示になります）`,
      yesText:"決定",
      noText:"戻る",
      onYes: ()=>{
        for(const s of others){
          // only allow merge if not already merged and not empty? allow any
          s.mergedInto = base.id;
        }
        save();
        closeModal();
        // clear op selection
        state.ui.opSelected = null;
        state.ui.selectedSeatIds = [];
        save();
        renderMain();
      }
    });

  }else if(op==="split"){
    // 救済用：合算解除（合算→元に戻す）
    const seats = ids.map(id=> state.seats.find(s=> s.id===id)).filter(Boolean);
    // split means: selected seats that are mergedInto something -> detach; also if base selected, detach all merged into it?
    openModal({
      title:"合計分割しますか？",
      sub:"誤操作の救済用です（合算状態を解除します）",
      yesText:"決定",
      noText:"戻る",
      onYes: ()=>{
        const selectedSet = new Set(ids);
        // 1) selected merged seats -> detach
        for(const s of seats){
          if(s.mergedInto) s.mergedInto = null;
        }
        // 2) if selected includes a base seat, detach all merged into it
        for(const s of seats){
          const baseId = s.id;
          if(selectedSet.has(baseId)){
            state.seats.forEach(x=>{
              if(x.mergedInto===baseId) x.mergedInto = null;
            });
          }
        }
        save();
        closeModal();
        state.ui.opSelected = null;
        state.ui.selectedSeatIds = [];
        save();
        renderMain();
      }
    });

  }else if(op==="move"){
    // seat move: simplest – move party+orders from first selected to second selected (two seats)
    if(ids.length!==2){
      openModal({ title:"席移動", sub:"移動元と移動先の2席を選択してください", yesText:"OK" });
      return;
    }
    const a = state.seats.find(s=> s.id===ids[0]);
    const b = state.seats.find(s=> s.id===ids[1]);
    if(!a || !b) return;

    openModal({
      title:"席移動しますか？",
      sub:`「${a.label}」→「${b.label}」へ移動します`,
      yesText:"決定",
      noText:"戻る",
      onYes: ()=>{
        // move only if a has active/reserve
        const tmp = { status:a.status, party:a.party, openedAt:a.openedAt, orders:(a.orders||[]), mergedInto:a.mergedInto };
        a.status="empty"; a.party=null; a.openedAt=null; a.orders=[]; a.mergedInto=null;

        b.status = tmp.status;
        b.party = tmp.party;
        b.openedAt = tmp.openedAt;
        // keep b existing orders? choose: add
        b.orders = (b.orders||[]).concat(tmp.orders||[]);
        b.mergedInto = null; // avoid weird
        save();
        closeModal();
        state.ui.opSelected = null;
        state.ui.selectedSeatIds = [];
        save();
        renderMain();
      }
    });
  }
};

/* =========================
  Settings navigation
========================= */
document.getElementById("settingsBtn").onclick = ()=> go("settings");
document.getElementById("todaySalesBtn").onclick = ()=> {
  go("sales");
};
document.getElementById("kitchenBtn").onclick = ()=> go("kitchen");
document.getElementById("backupBtn").onclick = ()=>{
  openModal({
    title:"バックアップ（無料版）",
    sub:"無料版は簡易バックアップです（端末内保存）。有料版で複数端末共有/メール送信を強化予定。",
    yesText:"OK"
  });
};
document.getElementById("brandBtn").onclick = ()=>{
  openModal({
    title:"ONE（無料/有料）",
    sub:"現在、有料版は準備中です。無料版をお使いください。",
    yesText:"OK"
  });
};

document.querySelectorAll(".menuCard").forEach(el=>{
  el.addEventListener("click", ()=>{
    const goKey = el.getAttribute("data-go");
    if(goKey==="recipe"){
      go("recipe");
    }else{
      go(goKey);
    }
  });
});

/* =========================
  Seat Register logic (仕様)
========================= */
const otherNameWrap = document.getElementById("otherNameWrap");
const otherName = document.getElementById("otherName");
const countNum = document.getElementById("countNum");
const countLabel = document.getElementById("countLabel");
const seatInputs = document.getElementById("seatInputs");
const capInputs = document.getElementById("capInputs");
const resetSeatReg = document.getElementById("resetSeatReg");
const saveSeatsBtn = document.getElementById("saveSeats");

let sr = {
  type: null,
  typeName: "",
  count: 0,
  labels: [],
  caps: [],
  otherNameHistory: [] // 簡易
};

function typeToName(t){
  const map = {
    counter:"カウンター",
    stand:"立ち",
    table:"テーブル",
    zashiki:"座敷",
    room:"個室",
    other:"その他"
  };
  return map[t] || "";
}

document.querySelectorAll("[data-seatType]").forEach(btn=>{
  btn.onclick = ()=>{
    sr.type = btn.dataset.seatType;
    let name = typeToName(sr.type);
    if(sr.type==="other"){
      otherNameWrap.style.display = "block";
      name = (otherName.value||"").trim() || "その他";
    }else{
      otherNameWrap.style.display = "none";
    }
    sr.typeName = name;
    // default caps (仕様)
    sr.defaultCap = (sr.type==="counter" || sr.type==="stand") ? 1 : 4;

    countLabel.textContent = (sr.type==="counter" || sr.type==="stand") ? "総席数" : "総卓数";
    renderSeatInputs();
    renderCapInputs();
  };
});

otherName.addEventListener("input", ()=>{
  if(sr.type==="other"){
    sr.typeName = (otherName.value||"").trim() || "その他";
  }
});

document.getElementById("countDec").onclick = ()=> {
  sr.count = Math.max(0, sr.count-1);
  countNum.textContent = String(sr.count);
  renderSeatInputs();
  renderCapInputs();
};
document.getElementById("countInc").onclick = ()=> {
  sr.count = Math.min(99, sr.count+1);
  countNum.textContent = String(sr.count);
  renderSeatInputs();
  renderCapInputs();
};

resetSeatReg.onclick = ()=>{
  // 「全削除」→「削除（入力を初期化）」に変更（仕様）
  sr.type = null;
  sr.typeName = "";
  sr.count = 0;
  sr.labels = [];
  sr.caps = [];
  otherName.value = "";
  otherNameWrap.style.display = "none";
  countNum.textContent = "0";
  countLabel.textContent = "総席数 / 総卓数";
  renderSeatInputs();
  renderCapInputs();
  openModal({ title:"初期化しました", sub:"この画面の入力を初期状態に戻しました", yesText:"OK" });
};

function guessNextLabel(prev){
  // A -> B, C1 -> C2, 1 -> 2, etc.
  if(!prev) return "";
  prev = String(prev).trim();
  if(!prev) return "";
  // force uppercase letters
  prev = prev.toUpperCase();

  // Match ending number
  const m = prev.match(/^(.*?)(\d+)$/);
  if(m){
    const head = m[1];
    const num = parseInt(m[2],10);
    return head + String(num+1);
  }
  // Single letter
  if(prev.length===1 && prev>="A" && prev<="Z"){
    const c = prev.charCodeAt(0);
    if(c<90) return String.fromCharCode(c+1);
    return "A";
  }
  // If ends with letter and no digit -> try advance last char if letter
  const last = prev.slice(-1);
  if(last>="A" && last<="Z"){
    const c = last.charCodeAt(0);
    const next = (c<90) ? String.fromCharCode(c+1) : "A";
    return prev.slice(0,-1)+next;
  }
  // fallback
  return prev + "_2";
}

function renderSeatInputs(){
  seatInputs.innerHTML = "";
  const count = sr.count || 0;
  // ensure arrays length
  while(sr.labels.length < count) sr.labels.push("");
  sr.labels = sr.labels.slice(0,count);

  for(let i=0;i<count;i++){
    const wrap = document.createElement("div");
    wrap.style.marginBottom = "10px";
    const nextHint = (i>0) ? guessNextLabel(sr.labels[i-1] || sr.labels[i] || "") : "";
    // autofill if empty and we have prev
    if(!sr.labels[i] && i>0){
      const auto = guessNextLabel(sr.labels[i-1]);
      if(auto) sr.labels[i] = auto;
    }
    wrap.innerHTML = `
      <div class="muted2" style="margin-bottom:6px; font-weight:900;">${i+1}席（卓）目</div>
      <input type="text" value="${escapeHtml(sr.labels[i]||"")}" data-idx="${i}" placeholder="${i===0 ? "例：1 / A / C1" : (nextHint ? `例：${nextHint}` : "例：2")}" />
    `;
    const input = wrap.querySelector("input");
    input.oninput = (e)=>{
      // uppercase
      let v = (e.target.value||"").toUpperCase().trim();
      sr.labels[i] = v;
      // auto-fill next if empty
      if(i<count-1 && !sr.labels[i+1]){
        const auto = guessNextLabel(v);
        if(auto){
          sr.labels[i+1] = auto;
          renderSeatInputs();
        }
      }
    };
    seatInputs.appendChild(wrap);
  }
}

function renderCapInputs(){
  capInputs.innerHTML = "";
  const count = sr.count || 0;
  while(sr.caps.length < count) sr.caps.push(sr.defaultCap || 4);
  sr.caps = sr.caps.slice(0,count);

  for(let i=0;i<count;i++){
    const row = document.createElement("div");
    row.style.marginBottom = "10px";
    row.innerHTML = `
      <div class="muted2" style="margin-bottom:6px; font-weight:900;">${(sr.labels[i]||`${i+1}`)} の最大人数</div>
      <div style="display:flex; gap:10px; align-items:center;">
        <button class="stepBtn" data-dec="${i}">◀︎</button>
        <div class="stepNum" id="capNum_${i}">${sr.caps[i]||1}</div>
        <button class="stepBtn" data-inc="${i}">▶︎</button>
      </div>
    `;
    capInputs.appendChild(row);

    row.querySelector(`[data-dec="${i}"]`).onclick = ()=>{
      sr.caps[i] = Math.max(1, (sr.caps[i]||1)-1);
      document.getElementById(`capNum_${i}`).textContent = String(sr.caps[i]);
    };
    row.querySelector(`[data-inc="${i}"]`).onclick = ()=>{
      sr.caps[i] = Math.min(99, (sr.caps[i]||1)+1);
      document.getElementById(`capNum_${i}`).textContent = String(sr.caps[i]);
    };
  }
}

saveSeatsBtn.onclick = ()=>{
  if(!sr.type){
    openModal({ title:"名称を選んでください", sub:"カウンター / 立ち / テーブル / 座敷 / 個室 / その他", yesText:"OK" });
    return;
  }
  if(sr.type==="other"){
    const nm = (otherName.value||"").trim();
    if(!nm){
      openModal({ title:"その他の名称を入力してください", sub:"例：中庭テラス", yesText:"OK" });
      return;
    }
    sr.typeName = nm; // 14
  }

  if(!sr.count){
    openModal({ title:"総席数 / 総卓数を入力してください", sub:"◀︎ / ▶︎ で数を調整できます", yesText:"OK" });
    return;
  }

  // validate labels
  const labels = sr.labels.map(x=> (x||"").toUpperCase().trim());
  for(let i=0;i<labels.length;i++){
    if(!labels[i]){
      openModal({ title:"席番号を入力してください", sub:`${i+1}席（卓）目が空です`, yesText:"OK" });
      return;
    }
  }

  // 既存席番号の重複確認（仕様追加）
  const existingLabels = new Set(state.seats.map(s=> (s.label||"").toUpperCase()));
  const dup = labels.find(l => existingLabels.has(l));
  if(dup){
    openModal({
      title:"同じ席（卓）番号がありますが登録しますか？",
      sub:`「${dup}」が既に存在します`,
      yesText:"○（登録する）",
      noText:"✖︎（戻る）",
      onYes: ()=>{
        closeModal();
        doSaveSeats(labels);
      },
      onNo: ()=> { /* 戻る */ }
    });
    return;
  }

  doSaveSeats(labels);
};

function doSaveSeats(labels){
  // create seats
  for(let i=0;i<labels.length;i++){
    const seat = {
      id: "S"+nowTs()+ "_" + i + "_" + Math.random().toString(16).slice(2),
      label: labels[i],
      type: sr.type,
      typeName: sr.typeName, // 14
      cap: sr.caps[i] || (sr.defaultCap||4),
      status: "empty",
      party: null,
      openedAt: null,
      orders: [],
      mergedInto: null
    };
    state.seats.push(seat);
  }
  save();
  openModal({ title:"保存しました", sub:"メインに反映しました", yesText:"OK", onYes: ()=>{ closeModal(); go("main"); }});
}

document.getElementById("backMainFromSeatReg").onclick = ()=> go("settings");

function renderSeatRegisterPreview(){
  const grid = document.getElementById("seatPreviewGrid");
  grid.innerHTML = "";
  const sorted = [...state.seats].sort((a,b)=> (a.label||"").localeCompare((b.label||""), "ja", { numeric:true, sensitivity:"base" }));
  for(const s of sorted){
    const card = document.createElement("div");
    card.className="seatCard";
    const meta = `${s.typeName||""} / 最大${s.cap||0}名`;
    card.innerHTML = `
      <div class="seatTop">
        <div class="seatLabel">${escapeHtml(s.label||"")}</div>
        <div class="seatStatus">${s.status==="empty" ? "空席" : (s.status==="reserve"?"予約":"着席")}</div>
      </div>
      <div class="seatMeta"><span>${escapeHtml(meta)}</span></div>
      <div class="seatMoney"><div class="tagMini">タップで簡易確認</div></div>
    `;
    card.onclick = ()=>{
      // 12: 席削除（未会計の注文がなければ即削除）
      const hasUnpaid = (s.orders||[]).length>0;
      const sub = hasUnpaid
        ? "未会計の注文があるため、無料版ではここから削除できません（会計後に削除してください）"
        : "未会計の注文がないため、この席を削除できます";

      openModal({
        title:`席（${s.label}）`,
        sub,
        bodyHtml: `
          <div class="muted2">名称：${escapeHtml(s.typeName||"")}</div>
          <div class="muted2">最大人数：${escapeHtml(String(s.cap||0))}</div>
          <div class="hr"></div>
          ${hasUnpaid ? `<div class="warnText">未会計の注文があります</div>` : `<div class="muted2">削除できます</div>`}
        `,
        yesText: hasUnpaid ? "OK" : "削除",
        noText: "戻る",
        yesClass: hasUnpaid ? "btnPrimary" : "btnDanger",
        onYes: ()=>{
          if(hasUnpaid){ closeModal(); return; }
          // delete
          state.seats = state.seats.filter(x=> x.id!==s.id);
          // detach merges pointing to deleted
          state.seats.forEach(x=>{
            if(x.mergedInto===s.id) x.mergedInto = null;
          });
          save();
          closeModal();
          renderSeatRegisterPreview();
          renderMain();
        }
      });
    };
    grid.appendChild(card);
  }
}

/* =========================
  Menu Register (20,21,22,23)
========================= */
const photoInput = document.getElementById("photoInput");
document.getElementById("photoBtn").onclick = ()=> photoInput.click();
document.getElementById("photoClearBtn").onclick = ()=>{
  photoInput.value = "";
  openModal({ title:"写真を消しました", sub:"", yesText:"OK" });
};

// 19未完成：写真読み取りは雰囲気だけ（赤字注意は入ってる）
photoInput.addEventListener("change", ()=>{
  if(!photoInput.files || !photoInput.files[0]) return;
  openModal({
    title:"写真を受け取りました",
    sub:"無料版は誤認識が起きやすいです（改善中）",
    bodyHtml:`<div class="warnText">誤認識前提になります（無料版）</div>
             <div class="muted2">今は「手動登録」で確実に登録してください。</div>`,
    yesText:"OK"
  });
});

document.getElementById("mAdd").onclick = ()=>{
  const category = document.getElementById("mCategory").value;
  const genre = (document.getElementById("mGenre").value||"").trim();
  const name = (document.getElementById("mName").value||"").trim();
  const price = parseInt(document.getElementById("mPrice").value||"0",10);
  const tax = parseInt(document.getElementById("mTax").value||"10",10);

  if(!genre || !name || !price){
    openModal({ title:"未入力があります", sub:"ジャンル・商品名・金額を入力してください", yesText:"OK" });
    return;
  }

  // 22: 同名は金額違っても登録不可
  const dup = state.menu.find(m=> (m.name||"").trim()===name);
  if(dup){
    openModal({
      title:"同じ料理（ドリンク）があります",
      sub:"名前を変えるか、既存の料理（ドリンク）を編集してください。",
      yesText:"OK"
    });
    return;
  }

  state.menu.push({
    id: "M"+nowTs()+"_"+Math.random().toString(16).slice(2),
    category,
    genre,
    name,
    price,
    tax
  });
  save();
  document.getElementById("mName").value = "";
  document.getElementById("mPrice").value = "";
  renderMenuList();
};

function renderMenuList(){
  const box = document.getElementById("menuList");
  box.innerHTML = "";

  // 23: あいうえお順（商品名）
  const sorted = [...state.menu].sort((a,b)=> jaSort(a.name,b.name));

  // group by genre
  const byGenre = {};
  for(const m of sorted){
    const g = m.genre || "その他";
    byGenre[g] = byGenre[g] || [];
    byGenre[g].push(m);
  }

  const genres = Object.keys(byGenre).sort(jaSort);

  for(const g of genres){
    const wrap = document.createElement("div");
    wrap.className = "listBox";
    wrap.innerHTML = `<div class="listHead">
      <span>${escapeHtml(g)}</span>
      <span class="muted2">${byGenre[g].length}件</span>
    </div>`;
    const body = document.createElement("div");

    for(const m of byGenre[g]){
      const row = document.createElement("div");
      row.className = "listRow";
      row.innerHTML = `
        <div class="listName">${escapeHtml(m.name)}</div>
        <div class="listMeta">${yen(m.price)} / ${m.tax}%</div>
        <button class="listBtn btnDanger">削除</button>
      `;
      row.querySelector("button").onclick = ()=>{
        state.menu = state.menu.filter(x=> x.id!==m.id);
        save();
        renderMenuList();
      };
      body.appendChild(row);
    }
    wrap.appendChild(body);
    box.appendChild(wrap);
  }
}

document.getElementById("backMainFromMenuReg").onclick = ()=> go("settings");

/* =========================
  Order
========================= */
function openOrderForSeat(seatId){
  state.ui.orderSeatId = seatId;
  state.ui.orderGenre = null;
  save();
  go("order");
}

document.getElementById("orderToMain").onclick = ()=> go("main");
document.getElementById("backToGenres").onclick = ()=>{
  state.ui.orderGenre = null;
  save();
  renderOrder();
};

function renderOrder(){
  const seat = state.seats.find(s=> s.id===state.ui.orderSeatId);
  if(!seat){
    go("main");
    return;
  }

  // 7: 見出しが会計→注文（ここは注文画面）
  document.getElementById("orderSeatBadge").textContent = "注文";
  document.getElementById("orderSeatText").textContent = `席 ${seat.label}`;

  // show genres only
  const stageGenres = document.getElementById("orderStageGenres");
  const stageItems = document.getElementById("orderStageItems");
  const genreGrid = document.getElementById("genreGrid");
  const itemsGrid = document.getElementById("itemsGrid");

  const genre = state.ui.orderGenre;

  // menu grouped by genre (注文はカテゴリー反映しない仕様)
  const items = [...state.menu].sort((a,b)=> jaSort(a.name,b.name)); // 23
  const genres = [...new Set(items.map(x=> x.genre||"その他"))].sort(jaSort);

  genreGrid.innerHTML = "";
  for(const g of genres){
    const btn = document.createElement("button");
    btn.className = "genreBtn";
    btn.textContent = g;
    btn.onclick = ()=>{
      state.ui.orderGenre = g;
      save();
      renderOrder();
    };
    genreGrid.appendChild(btn);
  }

  if(!genre){
    stageGenres.style.display = "block";
    stageItems.style.display = "none";
  }else{
    stageGenres.style.display = "none";
    stageItems.style.display = "block";

    // 8: 商品（ジャンル）戻るを固定表示＝orderHeaderFixed内の表示で代用
    const headerTitle = document.querySelector(".orderHeaderTitle");
    headerTitle.innerHTML = `<span class="badge">商品（${escapeHtml(genre)}）</span><span style="font-weight:950;">戻る</span>`;

    itemsGrid.innerHTML = "";
    const inGenre = items.filter(x=> (x.genre||"その他")===genre);

    for(const m of inGenre){
      const btn = document.createElement("button");
      btn.className = "itemBtn";
      btn.innerHTML = `${escapeHtml(m.name)}<small>${yen(m.price)}</small>`;
      btn.onclick = ()=> openQtyModal(seat, m);
      itemsGrid.appendChild(btn);
    }
  }

  renderOrderList(seat);
}

function renderOrderList(seat){
  const box = document.getElementById("orderList");
  const sumEl = document.getElementById("orderSum");
  box.innerHTML = "";

  const orders = seat.orders || [];
  const sum = orders.reduce((s,o)=> s + (o.price||0)*(o.qty||1), 0);
  sumEl.textContent = `合計 ${yen(sum)}`;

  for(const o of orders){
    const row = document.createElement("div");
    row.className = "listRow";
    row.innerHTML = `
      <div class="listName">${escapeHtml(o.name)}</div>
      <div class="listMeta">${o.qty}個 / ${yen(o.price)}</div>
      <button class="listBtn btnSmall">修正</button>
    `;
    row.querySelector("button").onclick = ()=> openQtyModal(seat, o, true);
    box.appendChild(row);
  }
}

function openQtyModal(seat, item, isEdit=false){
  // 仕様：商品選択後の個数入力は画面中央（モーダル）で行う
  let qty = isEdit ? (item.qty||1) : 1;

  openModal({
    title: isEdit ? "注文修正" : "個数選択",
    sub: isEdit ? "0個にすると一覧から消えます" : "◀︎ / ▶︎ で個数を調整します",
    bodyHtml: `
      <div style="font-weight:950;">${escapeHtml(item.name)}　<span class="muted2">${yen(item.price||0)}</span></div>
      <div class="stepper">
        <button class="stepBtn" id="qDec">◀︎</button>
        <div class="stepNum" id="qNum">${qty}</div>
        <button class="stepBtn" id="qInc">▶︎</button>
      </div>
    `,
    yesText:"決定",
    noText:"戻る",
    onYes: ()=>{
      const n = qty;
      if(isEdit){
        if(n<=0){
          seat.orders = (seat.orders||[]).filter(x=> x!==item);
        }else{
          item.qty = n;
        }
      }else{
        // add new order entry with timestamp (for kitchen)
        seat.orders = seat.orders || [];
        seat.orders.push({
          name: item.name,
          price: item.price,
          tax: item.tax,
          qty: n,
          category: item.category, // for kitchen filter
          ts: nowTs()
        });
      }
      save();
      closeModal();
      renderOrder();
    }
  });

  setTimeout(()=>{
    const render = ()=> document.getElementById("qNum").textContent = String(qty);
    document.getElementById("qDec").onclick = ()=> { qty = Math.max(0, qty-1); render(); };
    document.getElementById("qInc").onclick = ()=> { qty = Math.min(99, qty+1); render(); };
  },0);
}

document.getElementById("goCheckout").onclick = ()=>{
  go("checkout");
};

/* =========================
  Checkout (15,16)
========================= */
document.querySelectorAll(".payBtn").forEach(btn=>{
  btn.onclick = ()=>{
    state.ui.pay = btn.dataset.pay;
    save();
    renderCheckoutPay();
  };
});

function renderCheckoutPay(){
  document.querySelectorAll(".payBtn").forEach(btn=>{
    btn.classList.toggle("selected", btn.dataset.pay===state.ui.pay);
  });
}

function renderCheckout(){
  const seat = state.seats.find(s=> s.id===state.ui.orderSeatId);
  if(!seat){
    go("main"); return;
  }
  // 15: 会計画面に行くたびに支払い方法は現金に戻す
  state.ui.pay = "cash";
  save();

  const total = seatTotal(seat);
  document.getElementById("coSeatLabel").textContent = `席 ${seat.label}`;
  document.getElementById("coPeople").textContent = seat.party?.people ? `${seat.party.people}名` : "";
  document.getElementById("coTotal").textContent = `合計 ${yen(total)}`;

  renderCheckoutPay();

  // order list for edit
  const box = document.getElementById("checkoutOrderList");
  box.innerHTML = "";
  for(const o of (seat.orders||[])){
    const row = document.createElement("div");
    row.className = "listRow";
    row.innerHTML = `
      <div class="listName">${escapeHtml(o.name)}</div>
      <div class="listMeta">${o.qty}個 / ${yen(o.price)}</div>
      <button class="listBtn btnSmall">修正</button>
    `;
    row.querySelector("button").onclick = ()=> openQtyModal(seat, o, true);
    box.appendChild(row);
  }
}

document.getElementById("checkoutToMain").onclick = ()=> go("main");
document.getElementById("warikanBtn").onclick = ()=>{
  openModal({ title:"割り勘（無料版）", sub:"無料版では簡易表示のみです（次フェーズで強化）", yesText:"OK" });
};

document.getElementById("confirmCheckout").onclick = ()=>{
  const seat = state.seats.find(s=> s.id===state.ui.orderSeatId);
  if(!seat) return;

  const total = seatTotal(seat);
  if(total<=0){
    openModal({ title:"合計が0円です", sub:"注文がありません", yesText:"OK" });
    return;
  }

  // 16: 電子レシート：席番号・人数は記載しない（内部保持のみ）
  openModal({
    title:"電子レシートはいりますか？",
    sub:"無料版は「送る」は有料版案内になります",
    yesText:"○ 送る",
    noText:"✖︎ いらない",
    onYes: ()=>{
      // 無料版：案内
      closeModal();
      openModal({
        title:"有料版のサービスです",
        sub:"無料版では電子レシート送信は使えません。準備ができ次第、有料版で提供します。",
        yesText:"OK",
        onYes: ()=> closeModal()
      });
    },
    onNo: ()=>{
      // 会計終了：売上記録→席を空席へ
      // ただし合算がある場合：base seatなら合算分もまとめてクリア、merged席も空席へ
      finalizeCheckout(seat);
      closeModal();
      go("main");
    }
  });
};

function finalizeCheckout(baseSeat){
  const baseId = baseSeat.id;
  const related = [baseSeat, ...state.seats.filter(s=> s.mergedInto===baseId)];
  const allItems = [];
  let amount = 0;

  for(const s of related){
    for(const o of (s.orders||[])){
      amount += (o.price||0)*(o.qty||1);
      allItems.push({ name:o.name, qty:o.qty, price:o.price });
    }
  }

  // sales record
  state.sales.push({
    id: "SA"+nowTs()+"_"+Math.random().toString(16).slice(2),
    ts: nowTs(),
    amount,
    pay: state.ui.pay,
    seatLabel: baseSeat.label,
    items: allItems
  });

  // clear seats
  for(const s of related){
    s.orders = [];
    s.status = "empty";
    s.party = null;
    s.openedAt = null;
    s.mergedInto = null;
  }
  save();
}

/* =========================
  Kitchen (25-27)
========================= */
document.getElementById("kRefresh").onclick = ()=> renderKitchen();
document.getElementById("kHall").onclick = ()=> go("main");

document.getElementById("kFoodTab").onclick = ()=>{
  state.ui.kitchenTab = "food";
  save();
  renderKitchen();
};
document.getElementById("kDrinkTab").onclick = ()=>{
  state.ui.kitchenTab = "drink";
  save();
  renderKitchen();
};

function kitchenKey(order){
  return `${order.seatId}|${order.ts}|${order.name}`;
}

function collectKitchenOrders(){
  const list = [];
  for(const seat of state.seats){
    if(seat.mergedInto) continue; // merged seat is not operated
    for(const o of (seat.orders||[])){
      list.push({
        seatId: seat.id,
        seatLabel: seat.label,
        name: o.name,
        qty: o.qty||1,
        ts: o.ts || seat.openedAt || nowTs(),
        category: o.category || "food"
      });
    }
  }
  return list;
}

function renderKitchen(){
  // tab buttons
  document.getElementById("kFoodTab").classList.toggle("selected", state.ui.kitchenTab==="food");
  document.getElementById("kDrinkTab").classList.toggle("selected", state.ui.kitchenTab==="drink");

  const tab = state.ui.kitchenTab;
  const kList = document.getElementById("kList");
  kList.innerHTML = "";

  const all = collectKitchenOrders().filter(o=> tab==="food" ? o.category==="food" : o.category==="drink");
  // remove done
  const remain = all.filter(o=> !state.kitchenDone[kitchenKey(o)]);

  if(tab==="drink"){
    // 27: ドリンクはまとめない（時間順：古い上、新しい下）
    remain.sort((a,b)=> a.ts-b.ts);
    for(const o of remain){
      kList.appendChild(renderKitchenCardSingle(o, false));
    }
    return;
  }

  // 25: 料理は「同名は下にぶら下げ」、表示優先：料理名 → 時間 → 席番号
  // group by name
  const byName = {};
  for(const o of remain){
    byName[o.name] = byName[o.name] || [];
    byName[o.name].push(o);
  }
  const names = Object.keys(byName).sort(jaSort);

  // Build cards: each name group sorted by time then seat
  // But display is NOT merged into one qty; keep separate lines.
  for(const nm of names){
    const group = byName[nm].sort((a,b)=> (a.ts-b.ts) || (a.seatLabel||"").localeCompare((b.seatLabel||""), "ja", {numeric:true, sensitivity:"base"}));
    // promote logic: if more than 1, first is base, others are sub lines; "promoted color" on the promoted one only
    const base = group[0];
    const subs = group.slice(1);

    const isPromoted = subs.length>0; // "上に昇格した文字は色"
    const card = renderKitchenCardGroup(base, subs, isPromoted);
    kList.appendChild(card);
  }
}

function renderKitchenCardSingle(o, promoted){
  const card = document.createElement("div");
  card.className = "kCard" + (promoted ? " promoted" : "");
  const overdue = (nowTs() - o.ts) >= 15*60*1000;
  if(overdue) card.classList.add("overdue");

  const left = document.createElement("div");
  left.innerHTML = `
    <div class="kName">${escapeHtml(o.name)} <span class="kQty">${escapeHtml(String(o.qty))}個</span></div>
    <div class="kMeta">
      <span class="kSeat">${escapeHtml(o.seatLabel)}</span>
      <span class="kTime">${escapeHtml(fmtTime(o.ts))}</span>
    </div>
  `;

  const slider = makeSlider(()=>{
    // done
    state.kitchenDone[kitchenKey(o)] = true;
    save();
    renderKitchen();
  });

  card.appendChild(left);
  card.appendChild(slider);

  return card;
}

function renderKitchenCardGroup(base, subs, promoted){
  const card = document.createElement("div");
  card.className = "kCard" + (promoted ? " promoted" : "");
  const overdue = (nowTs() - base.ts) >= 15*60*1000;
  if(overdue) card.classList.add("overdue");

  const left = document.createElement("div");
  left.innerHTML = `
    <div class="kName">${escapeHtml(base.name)} <span class="kQty">${escapeHtml(String(base.qty))}個</span></div>
    <div class="kMeta">
      <span class="kSeat">${escapeHtml(base.seatLabel)}</span>
      <span class="kTime">${escapeHtml(fmtTime(base.ts))}</span>
    </div>
  `;

  // subs as separate lines (not merged)
  if(subs.length){
    const subWrap = document.createElement("div");
    subWrap.className = "kSubLine";
    for(const s of subs){
      const sub = document.createElement("div");
      sub.className = "kSubItem";
      const overdueSub = (nowTs() - s.ts) >= 15*60*1000;
      sub.innerHTML = `
        <div class="kSubLeft">
          <span class="kSeat">${escapeHtml(s.seatLabel)}</span>
          <span class="kTime">${escapeHtml(fmtTime(s.ts))}</span>
          <span class="kQty">${escapeHtml(String(s.qty))}個</span>
        </div>
      `;
      if(overdueSub){
        sub.style.borderColor = "rgba(255,87,87,.35)";
        sub.style.background = "rgba(255,87,87,.08)";
      }
      left.appendChild(subWrap);
      subWrap.appendChild(sub);
    }
  }

  // slider should complete ONLY the base row (your example)
  const slider = makeSlider(()=>{
    state.kitchenDone[kitchenKey(base)] = true;
    save();
    renderKitchen();
  });

  card.appendChild(left);
  card.appendChild(slider);

  return card;
}

function makeSlider(onDone){
  const slider = document.createElement("div");
  slider.className = "slider";
  slider.innerHTML = `
    <div class="sliderTrack">完了</div>
    <div class="sliderKnob">▶</div>
  `;
  const knob = slider.querySelector(".sliderKnob");
  let dragging=false, startX=0, startLeft=0;

  const maxLeft = ()=> slider.clientWidth - knob.clientWidth - 4;

  function setLeft(px){
    px = Math.max(2, Math.min(px, maxLeft()+2));
    knob.style.left = px+"px";
  }

  function doneCheck(){
    const left = parseFloat(knob.style.left || "2");
    if(left >= maxLeft()){
      onDone();
    }else{
      setLeft(2);
    }
  }

  const onDown = (e)=>{
    dragging=true;
    startX = (e.touches? e.touches[0].clientX : e.clientX);
    startLeft = parseFloat(knob.style.left || "2");
  };
  const onMove = (e)=>{
    if(!dragging) return;
    const x = (e.touches? e.touches[0].clientX : e.clientX);
    const dx = x - startX;
    setLeft(startLeft + dx);
    e.preventDefault?.();
  };
  const onUp = ()=>{
    if(!dragging) return;
    dragging=false;
    doneCheck();
  };

  knob.addEventListener("mousedown", onDown);
  window.addEventListener("mousemove", onMove);
  window.addEventListener("mouseup", onUp);

  knob.addEventListener("touchstart", onDown, {passive:false});
  window.addEventListener("touchmove", onMove, {passive:false});
  window.addEventListener("touchend", onUp);

  // tap on slider -> do nothing (誤タップ防止で間を開ける: slider自体は操作しない)
  return slider;
}

/* =========================
  Sales (21)
========================= */
function renderSales(){ /* just view */ }

function renderMonthSales(){
  const box = document.getElementById("monthSalesBox");
  const now = new Date();
  const ym = `${now.getFullYear()}-${pad2(now.getMonth()+1)}`;
  const inMonth = state.sales.filter(s=>{
    const d = new Date(s.ts);
    const y = d.getFullYear();
    const m = pad2(d.getMonth()+1);
    return `${y}-${m}`===ym;
  });
  const sum = inMonth.reduce((a,b)=> a + (b.amount||0), 0);
  box.innerHTML = `<div>今月（${ym}）合計：<span style="font-weight:950; font-size:1.2rem;">${yen(sum)}</span></div>
                   <div style="margin-top:8px;">件数：${inMonth.length}件</div>`;
}

function renderYearSales(){
  const box = document.getElementById("yearSalesBox");
  const now = new Date();
  const y = now.getFullYear();
  const inYear = state.sales.filter(s=> new Date(s.ts).getFullYear()===y);
  const sum = inYear.reduce((a,b)=> a + (b.amount||0), 0);
  box.innerHTML = `<div>今年（${y}）合計：<span style="font-weight:950; font-size:1.2rem;">${yen(sum)}</span></div>
                   <div style="margin-top:8px;">件数：${inYear.length}件</div>`;
}

function renderSalesManage(){
  const log = document.getElementById("salesLog");
  if(!state.sales.length){
    log.innerHTML = "売上データはまだありません。";
    return;
  }
  const sorted = [...state.sales].sort((a,b)=> b.ts-a.ts);
  log.innerHTML = sorted.slice(0,40).map(s=>{
    const t = new Date(s.ts);
    const d = `${t.getFullYear()}/${pad2(t.getMonth()+1)}/${pad2(t.getDate())} ${pad2(t.getHours())}:${pad2(t.getMinutes())}`;
    const pay = s.pay==="cash"?"現金":(s.pay==="card"?"カード":"QR/電子決済");
    return `<div style="padding:10px 0; border-bottom:1px solid rgba(255,255,255,.06);">
      <div style="font-weight:950;">${d}　${yen(s.amount)}　(${pay})</div>
      <div class="muted2">※ 席番号・人数はレシートに記載しない（内部保持のみ）</div>
    </div>`;
  }).join("");
}

document.getElementById("goMonthSales").onclick = ()=> go("month");
document.getElementById("goYearSales").onclick = ()=> go("year");
document.getElementById("goSalesManage").onclick = ()=> go("manage");
document.getElementById("salesToMain").onclick = ()=> go("main");

document.getElementById("monthToMain").onclick = ()=> go("main");
document.getElementById("yearToMain").onclick = ()=> go("main");
document.getElementById("manageToMain").onclick = ()=> go("main");

document.getElementById("monthToYear").onclick = ()=> go("year");
document.getElementById("monthToManage").onclick = ()=> go("manage");
document.getElementById("yearToMonth").onclick = ()=> go("month");
document.getElementById("yearToManage").onclick = ()=> go("manage");
document.getElementById("manageToMonth").onclick = ()=> go("month");
document.getElementById("manageToYear").onclick = ()=> go("year");

document.getElementById("exportCsv").onclick = ()=>{
  // 21: 日本語CSV
  const rows = [];
  rows.push(["日時","金額","支払い方法","明細"].join(","));
  for(const s of state.sales){
    const d = new Date(s.ts);
    const dt = `${d.getFullYear()}/${pad2(d.getMonth()+1)}/${pad2(d.getDate())} ${pad2(d.getHours())}:${pad2(d.getMinutes())}`;
    const pay = s.pay==="cash"?"現金":(s.pay==="card"?"カード":"QR/電子決済");
    const detail = (s.items||[]).map(it=> `${it.name}x${it.qty}`).join(" / ");
    rows.push([dt, String(s.amount||0), pay, `"${detail.replace(/"/g,'""')}"`].join(","));
  }
  const blob = new Blob([rows.join("\n")], {type:"text/csv;charset=utf-8"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "売上.csv";
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
};

document.getElementById("clearSales").onclick = ()=>{
  openModal({
    title:"売上を全削除しますか？",
    sub:"元に戻せません（危険）",
    yesText:"削除",
    noText:"戻る",
    yesClass:"btnDanger",
    onYes: ()=>{
      state.sales = [];
      save();
      closeModal();
      renderSalesManage();
    }
  });
};

/* =========================
  Store Info
========================= */
function renderStoreInfo(){
  document.getElementById("stName").value = state.store.name || "";
  document.getElementById("stPhone").value = state.store.phone || "";
  document.getElementById("stAddr").value = state.store.addr || "";
}
document.getElementById("saveStoreInfo").onclick = ()=>{
  state.store.name = (document.getElementById("stName").value||"").trim();
  state.store.phone = (document.getElementById("stPhone").value||"").trim();
  state.store.addr = (document.getElementById("stAddr").value||"").trim();
  save();
  openModal({ title:"保存しました", sub:"有料版の電子レシートで自動表示予定です", yesText:"OK" });
};
document.getElementById("storeToMain").onclick = ()=> go("main");

/* =========================
  Contact/Recipe
========================= */
document.getElementById("contactToMain").onclick = ()=> go("main");
document.getElementById("recipeToMain").onclick = ()=> go("main");

/* =========================
  Settings -> Main
========================= */
document.getElementById("backMainFromSeatReg").onclick = ()=> go("settings");

/* =========================
  Main top buttons
========================= */
document.getElementById("kitchenBtn").onclick = ()=> go("kitchen");

/* =========================
  Helper
========================= */
function escapeHtml(s){
  return String(s||"")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#39;");
}

/* =========================
  Boot
========================= */
(function init(){
  // If no seats, add a small hint
  if(!state.seats.length){
    // nothing
  }
  // ensure ui view valid
  const v = state.ui.view;
  if(views[v]) go(v);
  else go("main");

  // bottom settings button already wired
  renderMain();
})();
</script>
</body>
</html>