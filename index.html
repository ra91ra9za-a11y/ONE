<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>ONEï¼ˆç„¡æ–™ç‰ˆï¼‰</title>

  <style>
    /* =========================
      1) æ¨ªã‚ºãƒ¬é˜²æ­¢ï¼ˆå…¨ãƒšãƒ¼ã‚¸ï¼‰
    ========================= */
    html, body{
      width:100%;
      height:100%;
      overflow-x:hidden;
      overscroll-behavior-x:none;
      touch-action: pan-y;
    }
    body{
      margin:0;
      font-family: -apple-system, BlinkMacSystemFont, "Hiragino Kaku Gothic ProN", "Noto Sans JP", sans-serif;
      -webkit-text-size-adjust:100%;
      text-size-adjust:100%;
      background: #0f1720;
      color:#eaf0f6;
    }

    :root{
      --bg:#0f1720;
      --panel:#131e2a;
      --panel2:#0f1a25;
      --card:#182638;
      --card2:#1a2a3f;
      --line:rgba(255,255,255,.10);
      --muted:rgba(234,240,246,.72);
      --muted2:rgba(234,240,246,.55);
      --accent:#2dbE60;
      --accent2:#8fe35a; /* é»„ç·‘ï¼ˆã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ï¼‰ */
      --warn:#ff5757;
      --amber:#ffbf3c;
      --shadow: 0 8px 24px rgba(0,0,0,.35);
      --radius:14px;
      --radius2:18px;
      --tap: rgba(255,255,255,.08);
    }

    html{ font-size:18px; }
    *{ box-sizing:border-box; }
    button, input, select{ font: inherit; }

    input[type="text"], input[type="number"], select{
      width:100%;
      background: rgba(255,255,255,.06);
      color:#eaf0f6;
      border:1px solid var(--line);
      border-radius:12px;
      padding:12px 12px;
      outline:none;
    }
    input::placeholder{ color: rgba(234,240,246,.45); }

    .numField{
      width: 88px;
      text-align:center;
      font-size:1.12rem;
      padding:10px 10px;
    }

    button{
      background: rgba(255,255,255,.08);
      color:#eaf0f6;
      border:1px solid var(--line);
      border-radius:14px;
      padding:14px 14px;
      min-height: 50px;
      cursor:pointer;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }
    button:active{ background: rgba(255,255,255,.12); }
    .btnPrimary{ background: rgba(45,190,96,.16); border-color: rgba(45,190,96,.45); }
    .btnPrimary:active{ background: rgba(45,190,96,.22); }
    .btnDanger{ background: rgba(255,87,87,.12); border-color: rgba(255,87,87,.45); }
    .btnGhost{ background: transparent; }
    .btnSmall{ min-height: 42px; padding:10px 12px; border-radius:12px; font-size:.95rem; }
    .btnRow{ display:flex; gap:10px; flex-wrap:wrap; }
    .btnRow > button{ flex:1; }

    /* =========================
      3) ä¸Šéƒ¨å›ºå®šãƒ˜ãƒƒãƒ€ãƒ¼
    ========================= */
    .topbar{
      position: sticky;
      top:0;
      z-index:50;
      padding: 6px 10px calc(6px + env(safe-area-inset-top));
      background: linear-gradient(180deg, rgba(15,23,32,.96), rgba(15,23,32,.86));
      backdrop-filter: blur(10px);
      border-bottom: 1px solid var(--line);
    }
    .topbarInner{
      display:grid;
      grid-template-columns: 1fr auto 1fr;
      align-items:center;
      gap:8px;
    }
    .brandBtn{
      justify-self:start;
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 10px;
      min-height:40px;
      border-radius:14px;
    }
    .brandDot{
      width:10px; height:10px; border-radius:99px;
      background: var(--accent);
      box-shadow: 0 0 0 6px rgba(45,190,96,.18);
    }
    .topCenter{
      justify-self:center;
      display:flex;
      gap:8px;
      align-items:center;
    }
    .topRight{
      justify-self:end;
      display:flex;
      gap:6px;
      align-items:center;
      flex-wrap:nowrap;
    }

    /* âœ…ä¿®æ­£ï¼šå³ä¸Šãƒœã‚¿ãƒ³ãŒè¦‹åˆ‡ã‚Œãªã„ */
    #backupBtn, #kitchenBtn, #topMainBtn{
      padding: 8px 10px;
      min-height:40px;
      white-space:nowrap;
      font-size:.86rem;
    }
    #topMainBtn{ display:none; }

    .netIcon{
      width:38px;
      min-height:38px;
      display:flex;
      align-items:center;
      justify-content:center;
      border-radius:14px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.06);
      font-size: 1.00rem;
      flex: 0 0 auto;
    }

    /* =========================
      CONTENT
    ========================= */
    .content{
      padding: 12px 12px 140px;
      max-width: 920px;
      margin: 0 auto;
    }
    .gridSeats{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap:10px;
    }
    @media (max-width: 420px){
      .gridSeats{ grid-template-columns: repeat(3, 1fr); }
    }

    .seatCard{
      background: linear-gradient(180deg, rgba(24,38,56,.92), rgba(20,32,48,.92));
      border:1px solid var(--line);
      border-radius: 16px;
      padding: 10px 10px;
      box-shadow: var(--shadow);
      min-height: 92px;
      display:flex;
      flex-direction:column;
      gap:6px;
      overflow:hidden;
    }
    .seatTop{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
    }
    .seatLabel{
      font-weight: 800;
      font-size: 1.12rem;
      letter-spacing: .02em;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width: 60%;
    }
    .seatStatus{
      font-size:.88rem;
      color: var(--muted);
      white-space:nowrap;
    }
    .seatMeta{
      font-size:.88rem;
      color: var(--muted);
      display:flex;
      gap:8px;
      align-items:center;
      flex-wrap:wrap;
      min-height: 18px;
    }
    .seatMoney{
      margin-top:auto;
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap:8px;
    }
    .yen{
      font-weight: 900;
      font-size: 1.15rem;
      white-space:nowrap;
    }
    .tagMini{
      font-size:.8rem;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid var(--line);
      color: var(--muted);
      background: rgba(255,255,255,.04);
      white-space:nowrap;
    }
    .seatCard.active{ outline: 2px solid rgba(45,190,96,.55); }
    .seatCard.reserve{ outline: 2px solid rgba(255,191,60,.55); }
    .seatCard.merged{ outline: 2px dashed rgba(234,240,246,.30); opacity:.78; }

    /* =========================
      bottomDockï¼šãƒ¡ã‚¤ãƒ³ã®ã¿è¡¨ç¤º
    ========================= */
    .bottomDock{
      position: fixed;
      left:0; right:0; bottom:0;
      z-index: 60;
      padding: 8px 10px calc(8px + env(safe-area-inset-bottom));
      background: linear-gradient(180deg, rgba(15,23,32,.55), rgba(15,23,32,.94));
      border-top: 1px solid var(--line);
      backdrop-filter: blur(10px);
      display:none;
    }
    .bottomDock.show{ display:block; }

    .dockWrap{
      max-width: 920px;
      margin: 0 auto;
      display:flex;
      flex-direction:column;
      gap:8px;
    }

    .opsBox{
      border: 1px solid rgba(255,255,255,.30);
      border-radius: 18px;
      padding: 10px;
      background: rgba(255,255,255,.14);
      box-shadow: 0 10px 24px rgba(0,0,0,.35);
    }

    .opsRow{
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap:8px;
    }
    .opsBtn{
      min-height: 48px;
      font-size: 1.02rem;
      font-weight: 800;
      padding: 10px 10px;
    }
    .opsBtn .twoLine{
      display:flex;
      flex-direction:column;
      line-height: 1.05;
      gap:2px;
      align-items:center;
    }
    .opsBtn.same{ background: rgba(255,255,255,.06); }
    .opsBtn.same.selected{
      background: rgba(45,190,96,.16);
      border-color: rgba(45,190,96,.45);
    }
    .opsBtn.decide{
      background: rgba(45,190,96,.22);
      border-color: rgba(45,190,96,.55);
    }
    .bottomRow2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:8px;
    }
    .bottomRow2 button{
      min-height: 48px;
      font-weight: 800;
    }

    /* SETTINGS cards */
    .cardGrid2{
      display:grid;
      grid-template-columns: repeat(2, 1fr);
      gap:10px;
    }
    .menuCard{
      background: rgba(24,38,56,.86);
      border: 1px solid var(--line);
      border-radius: 16px;
      padding: 14px;
      box-shadow: var(--shadow);
      min-height: 72px;
      display:flex;
      align-items:center;
      justify-content:center;
      text-align:center;
      font-weight: 900;
      letter-spacing:.02em;
    }
    .menuCard:active{ background: rgba(255,255,255,.10); }

    /* order header */
    .orderHeaderFixed{
      position: sticky;
      top: 56px;
      z-index: 45;
      background: rgba(15,23,32,.92);
      border-bottom: 1px solid var(--line);
      padding: 10px 12px;
      margin: 0 -12px 12px;
      backdrop-filter: blur(10px);
    }
    .orderHeaderRow{
      display:flex;
      justify-content:space-between;
      gap:10px;
      align-items:center;
    }
    .orderHeaderTitle{
      font-weight: 900;
      font-size: 1.05rem;
      color:#eaf0f6;
      display:flex;
      gap:8px;
      align-items:center;
      flex-wrap:wrap;
    }
    .orderHeaderTitle .badge{
      font-size:.82rem;
      padding: 4px 9px;
      border-radius:999px;
      border:1px solid rgba(45,190,96,.45);
      background: rgba(45,190,96,.14);
    }

    /* order grids */
    .genreGrid{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap:10px;
    }
    .genreBtn{
      min-height: 56px;
      font-weight: 900;
      background: rgba(255,255,255,.06);
      padding: 10px 10px;
      white-space: normal;
      line-height: 1.15;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .itemsGrid{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap:10px;
    }
    .itemBtn{
      min-height: 66px;
      font-weight: 900;
      padding: 12px 10px;
    }
    .itemBtn small{
      display:block;
      margin-top:6px;
      color: var(--muted);
      font-weight:700;
      font-size:.86rem;
    }

    /* list box */
    .listBox{
      margin-top: 12px;
      border:1px solid var(--line);
      border-radius: 16px;
      background: rgba(19,30,42,.60);
      overflow:hidden;
    }
    .listBox .listHead{
      padding: 10px 12px;
      border-bottom:1px solid var(--line);
      color: var(--muted);
      font-weight:900;
      font-size:.92rem;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
    }
    .listRow{
      display:grid;
      grid-template-columns: 1fr auto auto;
      gap:10px;
      align-items:center;
      padding: 10px 12px;
      border-bottom:1px solid rgba(255,255,255,.06);
    }
    .listRow:last-child{ border-bottom:none; }
    .listName{
      font-weight:900;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    .listMeta{
      color: var(--muted);
      font-weight:800;
      white-space:nowrap;
    }
    .listBtn{
      min-height: 40px;
      padding: 8px 10px;
      border-radius: 12px;
      font-size:.92rem;
      font-weight:900;
    }

    /* pay */
    .payBtns{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap:10px;
    }
    .payBtn{ min-height: 54px; font-weight: 900; }
    .payBtn.selected{
      background: rgba(45,190,96,.18);
      border-color: rgba(45,190,96,.55);
    }

    /* modal */
    .modalRoot{
      position: fixed;
      inset:0;
      z-index: 200;
      display:none;
      align-items:center;
      justify-content:center;
      padding: 16px;
      background: rgba(0,0,0,.55);
      backdrop-filter: blur(4px);
    }
    .modalRoot.show{ display:flex; }
    .modal{
      width: min(520px, 100%);
      background: linear-gradient(180deg, rgba(24,38,56,.98), rgba(19,30,42,.98));
      border:1px solid var(--line);
      border-radius: 18px;
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .modalHead{ padding: 14px 14px 10px; border-bottom: 1px solid var(--line); }
    .modalTitle{ font-weight: 900; font-size: 1.05rem; }
    .modalSub{ margin-top: 6px; color: var(--muted); font-weight: 700; font-size:.92rem; line-height:1.35; }
    .modalBody{ padding: 12px 14px; display:flex; flex-direction:column; gap:10px; }
    .modalFoot{ padding: 12px 14px 14px; border-top:1px solid var(--line); display:flex; gap:10px; }
    .modalFoot button{ flex:1; }

    .stepper{
      display:flex; align-items:center; gap:10px; justify-content:center; padding: 8px 0;
    }
    .stepBtn{
      width: 54px; min-height: 54px;
      font-size: 1.25rem; font-weight: 900;
      border-radius: 16px;
    }
    .stepNum{
      width: 96px; text-align:center;
      font-weight: 900; font-size: 1.25rem;
      padding: 12px 0;
      border-radius: 16px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.06);
    }

    /* kitchen */
    .kTabs{ display:flex; gap:10px; margin-top: 10px; }
    .kTabs button{ flex:1; min-height: 48px; font-weight: 900; }
    .kTabs button.selected{ background: rgba(45,190,96,.18); border-color: rgba(45,190,96,.55); }

    .kList{ display:flex; flex-direction:column; gap:8px; margin-top: 12px; }

    .kCard{
      position: relative;
      background: rgba(24,38,56,.88);
      border:1px solid var(--line);
      border-radius: 16px;
      padding: 10px 12px;
      display:grid;
      grid-template-columns: 1fr auto;
      gap:10px;
      align-items:center;
      overflow:hidden;
    }
    .kCard::before{
      content:"";
      position:absolute;
      left:0; top:0; bottom:0;
      width: 6px;
      background: rgba(45,190,96,.65);
    }
    .kCard.promoted::before{ background: rgba(255,191,60,.75); }
    .kCard.overdue .kName{ color: var(--warn); }

    .kName{ font-weight: 950; font-size: 1.10rem; line-height:1.2; }
    .kMeta{
      margin-top: 6px;
      color: var(--muted);
      font-weight: 800;
      font-size:.92rem;
      display:flex;
      gap:14px;
      flex-wrap:wrap;
    }
    .kQty{
      font-weight: 950;
      font-size: 1.12rem;
      margin-left: 10px;
      color:#eaf0f6;
    }

    .kSubLine{
      margin-top: 8px;
      padding-left: 10px;
      border-left: 2px dashed rgba(255,255,255,.12);
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .kSubItem{
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
      padding: 6px 8px;
      border-radius: 12px;
      background: rgba(255,255,255,.04);
      border:1px solid rgba(255,255,255,.08);
    }
    .kSubLeft{
      display:flex;
      align-items:center;
      gap:10px;
      overflow:hidden;
      white-space:nowrap;
      text-overflow:ellipsis;
    }
    .kTime{ font-weight:900; color: var(--muted); }
    .kSeat{ font-weight: 950; color: rgba(234,240,246,.92); }

    /* ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ */
    .slider{
      width: 140px;
      height: 42px;
      border-radius: 999px;
      background: rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.16);
      position: relative;
      overflow:hidden;
      justify-self:end;
    }
    .slider.short{ width: 110px; }
    .slider.shift{ justify-self:end; margin-right: 6px; }

    .sliderTrack{
      position:absolute; inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      color: rgba(234,240,246,.55);
      font-weight: 900;
      font-size:.9rem;
      pointer-events:none;
    }
    .sliderKnob{
      position:absolute;
      left: 2px;
      top: 2px;
      width: 38px;
      height: 38px;
      border-radius: 999px;
      background: rgba(143,227,90,.92);
      box-shadow: 0 8px 18px rgba(0,0,0,.35);
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight: 950;
      color:#0b121a;
      user-select:none;
      touch-action: pan-x;
    }

    .view{ display:none; }
    .view.show{ display:block; }

    .muted{ color: var(--muted); }
    .muted2{ color: var(--muted2); }
    .warnText{ color: var(--warn); font-weight: 950; }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 8px 10px;
      border-radius: 999px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.04);
      font-weight: 900;
      color: var(--muted);
      font-size:.9rem;
    }
    .hr{ height:1px; background: rgba(255,255,255,.08); margin: 10px 0; }

    button, .seatCard, .menuCard, .genreBtn, .itemBtn{ touch-action: manipulation; }

    /* å¸­ç™»éŒ²ã®è¦‹å‡ºã—ã‚’è¦‹ã‚„ã™ã */
    .srHead{ color: rgba(234,240,246,.92); font-weight: 950; }

    /* ===== æœ¬æ—¥ã®å£²ä¸Šï¼ˆè¨‚æ­£ä¼ç¥¨æ–¹å¼å¯¾å¿œï¼‰ ===== */
    .saleRow{
      padding: 10px 12px;
      border-bottom: 1px solid rgba(255,255,255,.06);
    }
    .saleRow:last-child{ border-bottom:none; }
    .saleTop{
      display:flex;
      justify-content:space-between;
      gap:10px;
      align-items:flex-start;
    }
    .saleTitle{
      font-weight: 950;
      line-height:1.25;
    }
    .saleMeta{
      margin-top:6px;
      color: var(--muted);
      font-weight: 800;
      font-size:.92rem;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
    }
    .saleBtns{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    .saleBtns button{ min-height: 42px; padding: 10px 12px; }

    .tagFix{
      display:inline-flex;
      align-items:center;
      gap:6px;
      font-size:.82rem;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid rgba(255,191,60,.45);
      background: rgba(255,191,60,.10);
      color: rgba(255,240,200,.92);
      font-weight: 900;
    }
  </style>
</head>

<body>
  <!-- ========================= TOP BAR ========================= -->
  <div class="topbar" id="topbar">
    <div class="topbarInner">
      <button class="brandBtn btnGhost" id="brandBtn" title="ç„¡æ–™/æœ‰æ–™ã®å…¥å£">
        <span class="brandDot"></span>
        <span style="font-weight:950; letter-spacing:.02em;">ONE</span>
      </button>

      <div class="topCenter" id="topCenter">
        <button class="btnSmall" id="kitchenBtn">ã‚­ãƒƒãƒãƒ³</button>
      </div>

      <div class="topRight" id="topRight">
        <div class="netIcon" id="netIcon" title="ã‚ªãƒ³ãƒ©ã‚¤ãƒ³çŠ¶æ…‹">ğŸ“¶</div>
        <button class="btnSmall" id="topMainBtn">ãƒ¡ã‚¤ãƒ³</button>
        <!-- âœ…â‘ æ–‡è¨€å¤‰æ›´ -->
        <button class="btnSmall" id="backupBtn">ä¿å­˜</button>
      </div>
    </div>
  </div>

  <!-- ========================= CONTENT ========================= -->
  <div class="content">

    <!-- MAIN VIEW -->
    <section class="view show" id="viewMain">
      <div class="muted" style="font-weight:900; margin: 4px 0 10px;">
        å¸­ï¼ˆç©ºå¸­ã‚¿ãƒƒãƒ— â†’ æ¥åº— / äºˆç´„ï¼‰
      </div>
      <div class="gridSeats" id="seatGrid"></div>
      <div style="height:12px;"></div>
      <div class="muted2" style="font-size:.92rem;">
        â€» ä¸‹ã®ã€Œå¸­ç§»å‹• / åˆè¨ˆåˆç®— / åˆè¨ˆåˆ†å‰²ã€ã‚’æŠ¼ã™ã¨é¸æŠçŠ¶æ…‹ã«ãªã‚Šã¾ã™ï¼ˆå†ã‚¿ãƒƒãƒ—ã§è§£é™¤ï¼‰â†’ã€Œæ±ºå®šã€ã§å®Ÿè¡Œã€‚
      </div>
    </section>

    <!-- SETTINGS VIEW -->
    <section class="view" id="viewSettings">
      <div class="muted" style="font-weight:950; margin: 6px 0 12px;">è¨­å®š</div>
      <div class="cardGrid2">
        <div class="menuCard" data-go="seatRegister">å¸­ç™»éŒ²</div>
        <div class="menuCard" data-go="menuRegister">ãƒ¡ãƒ‹ãƒ¥ãƒ¼ç™»éŒ²</div>
        <div class="menuCard" data-go="sales">å£²ä¸Š</div>
        <div class="menuCard" data-go="storeInfo">åº—èˆ—æƒ…å ±</div>
        <div class="menuCard" data-go="contact">ãŠå•åˆã›</div>
        <div class="menuCard" data-go="recipe" style="opacity:.55;">æ–™ç†ææ¡ˆï¼ˆæœ‰æ–™æº–å‚™ä¸­ï¼‰</div>
      </div>
      <div style="height:14px;"></div>
      <div class="muted2" style="font-size:.92rem;">â€» æ–™ç†ææ¡ˆï¼ˆãƒ©ã‚¤ãƒˆï¼‰ã¯æœ‰æ–™ç‰ˆã«å…¥ã‚Œã‚‹äºˆå®šï¼ˆç¾åœ¨æº–å‚™ä¸­ï¼‰</div>
    </section>

    <!-- SEAT REGISTER VIEW -->
    <section class="view" id="viewSeatRegister">
      <div class="srHead" style="margin: 6px 0 12px;">å¸­ç™»éŒ²</div>

      <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
        <span class="pill" style="border:none; background:transparent; padding:0; color:rgba(234,240,246,.72);">
          æ‰‹é †ï¼šåç§° â†’ ç·å¸­/ç·å“ â†’ å¸­ç•ªå· â†’ æœ€å¤§äººæ•°
        </span>
      </div>

      <div style="height:10px;"></div>

      <div class="btnRow">
        <button class="btnSmall btnDanger" id="resetSeatReg">å…¥åŠ›ã‚’å–æ¶ˆ</button>
        <button class="btnSmall btnDanger" id="initAllSeatsBtn">å…¨å¸­ãƒ‡ãƒ¼ã‚¿ã®åˆæœŸåŒ–</button>
      </div>

      <div class="hr"></div>

      <!-- âœ…â‘¡â‘¢ åç§°é¸æŠï¼šå‹•çš„ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚° -->
      <div class="srHead" style="margin-bottom:8px;">åç§°</div>
      <div id="seatTypeButtons"></div>

      <div id="otherNameWrap" style="display:none; margin-top:10px;">
        <div class="srHead" style="margin-bottom:8px;">ãã®ä»–ã®åç§°ï¼ˆä¾‹ï¼šä¸­åº­ãƒ†ãƒ©ã‚¹ï¼‰</div>
        <input id="otherName" type="text" placeholder="ä¾‹ï¼šä¸­åº­ãƒ†ãƒ©ã‚¹" />
        <div class="muted2" style="font-size:.9rem; margin-top:6px;">â€» å…¥åŠ›ã—ãŸåç§°ã¯æ¬¡å›ä»¥é™ã€åç§°ä¸€è¦§ã¨ã—ã¦ä½¿ãˆã¾ã™ï¼ˆç„¡æ–™ç‰ˆã§ã¯ç°¡æ˜“ä¿å­˜ï¼‰</div>
      </div>

      <!-- âœ…â‘¡ æ±ºå®šãƒœã‚¿ãƒ³ã¯åç§°ã‚°ãƒ«ãƒ¼ãƒ—æœ€ä¸‹éƒ¨å›ºå®š -->
      <div class="btnRow" style="margin-top:10px;">
        <button class="btnPrimary" id="seatTypeConfirmBtn">æ±ºå®š</button>
      </div>

      <div class="hr"></div>

      <!-- ç·æ•° -->
      <div class="srHead" style="margin-bottom:8px;" id="countLabel">ç·å¸­æ•° / ç·å“æ•°</div>
      <div style="display:flex; gap:10px; align-items:center;">
        <button class="stepBtn" id="countDec">â—€ï¸</button>
        <div class="stepNum" id="countNum">0</div>
        <button class="stepBtn" id="countInc">â–¶ï¸</button>
      </div>

      <div class="hr"></div>

      <!-- å¸­ç•ªå·å…¥åŠ› -->
      <div class="srHead" style="margin-bottom:8px;">å¸­ç•ªå·ï¼ˆè‡ªå‹•ã§æ¬¡ãŒå…¥ã‚Šã¾ã™ï¼‰</div>
      <div class="muted2" style="font-size:.92rem; margin-bottom:10px;">ä¾‹ï¼š1 â†’ 2 / A â†’ B / C1 â†’ C2ï¼ˆã‚¢ãƒ«ãƒ•ã‚¡ãƒ™ãƒƒãƒˆã¯å¤§æ–‡å­—ï¼‰</div>
      <div id="seatInputs"></div>

      <div class="hr"></div>

      <!-- æœ€å¤§ç€å¸­äººæ•° -->
      <div class="srHead" style="margin-bottom:8px;">æœ€å¤§ç€å¸­äººæ•°ï¼ˆå¸­ã”ã¨ï¼‰</div>
      <div id="capInputs"></div>

      <div style="height:12px;"></div>
      <div class="btnRow">
        <button class="btnPrimary" id="saveSeats">ä¿å­˜</button>
      </div>

      <div class="hr"></div>

      <!-- ä½œã£ãŸå¸­ã‚’åç§°ã”ã¨ã«ã¾ã¨ã‚ã‚‹ -->
      <div class="srHead" style="margin: 6px 0 10px;">ä½œã£ãŸå¸­ï¼ˆåç§°ã”ã¨ï¼‰</div>
      <div id="seatPreviewGrouped"></div>

      <div class="muted2" style="font-size:.9rem; margin-top:8px;">â€» ç„¡æ–™ç‰ˆã¯ã€Œå¸­ã®å€‹åˆ¥ç·¨é›†ã€ã¯ç°¡æ˜“å¯¾å¿œï¼ˆæ¬¡ãƒ•ã‚§ãƒ¼ã‚ºã§å¼·åŒ–ï¼‰</div>
    </section>

    <!-- MENU REGISTER VIEW -->
    <section class="view" id="viewMenuRegister">
      <div class="muted" style="font-weight:950; margin: 6px 0 12px;">ãƒ¡ãƒ‹ãƒ¥ãƒ¼ç™»éŒ²</div>

      <div class="btnRow">
        <button class="btnSmall btnDanger" id="initMenuBtn">ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãƒ‡ãƒ¼ã‚¿ã®åˆæœŸåŒ–</button>
      </div>

      <div class="muted2" style="font-size:.92rem; margin-top:10px;">
        ã‚«ãƒ†ã‚´ãƒªãƒ¼ï¼ˆæ–™ç†/ãƒ‰ãƒªãƒ³ã‚¯ï¼‰ã¯ã‚­ãƒƒãƒãƒ³ã®ã€Œæ–™ç†/ãƒ‰ãƒªãƒ³ã‚¯ã€è¡¨ç¤ºã«åæ˜ ã—ã¾ã™ï¼ˆæ³¨æ–‡ã«ã¯å‡ºã—ã¾ã›ã‚“ï¼‰ã€‚
      </div>

      <div style="height:10px;"></div>

      <div class="btnRow">
        <button class="btnSmall btnPrimary" id="photoBtn">å†™çœŸæ’®å½±</button>
        <button class="btnSmall btnDanger" id="photoClearBtn">å†™çœŸã‚’æ¶ˆã™</button>
      </div>
      <div class="warnText" style="margin-top:8px;">èª¤èªè­˜å‰æã«ãªã‚Šã¾ã™ï¼ˆç„¡æ–™ç‰ˆï¼‰</div>
      <div class="muted2" style="font-size:.9rem; margin-top:6px;">â€» å†™çœŸã‹ã‚‰ã®è‡ªå‹•èª­ã¿å–ã‚Šï¼ˆOCRï¼‰ã¯æ”¹å–„ä¸­ï¼ˆæœªå®Œæˆï¼‰</div>

      <div class="hr"></div>

      <!-- ã‚¸ãƒ£ãƒ³ãƒ«é¸æŠï¼‹æ–°è¦è¿½åŠ ï¼ˆæœªé¸æŠã¯æœªåˆ†é¡ï¼‰ -->
      <div class="muted" style="font-weight:950; margin-bottom:10px;">ç™»éŒ²</div>

      <div class="btnRow">
        <select id="mCategory">
          <option value="food">æ–™ç†</option>
          <option value="drink">ãƒ‰ãƒªãƒ³ã‚¯</option>
        </select>

        <select id="mGenreSel">
          <option value="">ï¼ˆæœªé¸æŠâ†’æœªåˆ†é¡ï¼‰</option>
        </select>

        <button class="btnSmall" id="addGenreBtn">ï¼‹ã‚¸ãƒ£ãƒ³ãƒ«è¿½åŠ </button>
      </div>

      <div style="height:10px;"></div>

      <input id="mName" type="text" placeholder="å•†å“åï¼ˆé‡è¤‡ä¸å¯ï¼‰" />
      <div style="height:10px;"></div>

      <div style="display:flex; gap:10px; align-items:center;">
        <input id="mPrice" class="numField" type="number" inputmode="numeric" placeholder="é‡‘é¡" />
        <select id="mTax" style="width:160px;">
          <option value="10">10%</option>
          <option value="8">8%</option>
        </select>
        <button class="btnPrimary" id="mAdd">ç™»éŒ²</button>
      </div>

      <div class="hr"></div>

      <!-- é–²è¦§ãƒ»ä¿®æ­£ãƒ»å‰Šé™¤ -->
      <div class="muted" style="font-weight:950; margin: 6px 0 8px;">å•†å“ã®é–²è¦§ã¨ä¿®æ­£</div>

      <div class="btnRow">
        <select id="viewGenreSel"></select>
        <button class="btnPrimary btnSmall" id="viewGenreDecide">æ±ºå®š</button>
        <!-- âœ…ã‚¸ãƒ£ãƒ³ãƒ«å‰Šé™¤ãƒœã‚¿ãƒ³è¿½åŠ ï¼ˆPART2ã§å®Ÿè£…ï¼‰ -->
        <button class="btnDanger btnSmall" id="deleteGenreBtn">ã‚¸ãƒ£ãƒ³ãƒ«å‰Šé™¤</button>
      </div>

      <div id="menuList"></div>

      <div style="height:12px;"></div>

      <input id="photoInput" type="file" accept="image/*" capture="environment" style="display:none;" />
    </section>

    <!-- ORDER VIEW -->
    <section class="view" id="viewOrder">
      <div class="orderHeaderFixed" id="orderHeaderFixed">
        <div class="orderHeaderRow">
          <div class="orderHeaderTitle" id="orderHeaderTitle"></div>
        </div>
      </div>

      <div id="orderTopButtons" class="btnRow" style="margin-bottom:12px;">
        <button class="btnSmall" id="orderGoGenre">ã‚¸ãƒ£ãƒ³ãƒ«</button>
        <button class="btnSmall" id="orderGoMain">ãƒ¡ã‚¤ãƒ³</button>
        <button class="btnSmall btnPrimary" id="orderGoCheckout">ä¼šè¨ˆ</button>
      </div>

      <div class="btnRow" style="margin-bottom:12px;">
        <button class="btnSmall btnPrimary" id="orderCatFood">æ–™ç†</button>
        <button class="btnSmall" id="orderCatDrink">ãƒ‰ãƒªãƒ³ã‚¯</button>
      </div>

      <div id="orderStageGenres">
        <div class="muted" style="font-weight:950; margin-bottom:10px;">ã‚¸ãƒ£ãƒ³ãƒ«</div>
        <div class="genreGrid" id="genreGrid"></div>
      </div>

      <div id="orderStageItems" style="display:none;">
        <div class="itemsGrid" id="itemsGrid"></div>
      </div>

      <div class="listBox" id="orderListBox">
        <div class="listHead">
          <span>æ³¨æ–‡å±¥æ­´</span>
          <span class="muted2" id="orderSum">åˆè¨ˆ Â¥0</span>
        </div>
        <div id="orderList"></div>
      </div>
    </section>

    <!-- CHECKOUT VIEW -->
    <section class="view" id="viewCheckout">
      <div class="muted" style="font-weight:950; margin: 6px 0 12px;">ä¼šè¨ˆ</div>

      <div class="seatCard" style="min-height:auto;">
        <div class="seatTop">
          <div class="seatLabel" id="coSeatLabel">å¸­</div>
          <div class="seatStatus" id="coPeople">äººæ•°</div>
        </div>
        <div class="yen" style="font-size:1.45rem;" id="coTotal">åˆè¨ˆ Â¥0</div>
      </div>

      <div style="height:12px;"></div>

      <div class="muted" style="font-weight:900; margin-bottom:8px;">æ”¯æ‰•ã„æ–¹æ³•</div>
      <div class="payBtns">
        <button class="payBtn" data-pay="cash">ç¾é‡‘</button>
        <button class="payBtn" data-pay="card">ã‚«ãƒ¼ãƒ‰</button>
        <button class="payBtn" data-pay="qr">QR/é›»å­æ±ºæ¸ˆ</button>
      </div>

      <div style="height:12px;"></div>
      <div class="btnRow">
        <button class="btnSmall" id="warikanBtn">å‰²ã‚Šå‹˜</button>
        <button class="btnPrimary" id="confirmCheckout">ä¼šè¨ˆç¢ºå®š</button>
      </div>

      <div class="listBox" style="margin-top:12px;">
        <div class="listHead">
          <span>æ³¨æ–‡ä¸€è¦§ï¼ˆä¿®æ­£ï¼‰</span>
          <span class="muted2">0å€‹ã«ã™ã‚‹ã¨æ¶ˆãˆã¾ã™</span>
        </div>
        <div id="checkoutOrderList"></div>
      </div>
    </section>

    <!-- KITCHEN VIEW -->
    <section class="view" id="viewKitchen">
      <div class="muted" style="font-weight:950; margin: 6px 0 6px;">
        ã‚­ãƒƒãƒãƒ³
      </div>

      <div class="btnRow">
        <button class="btnSmall" id="kRefresh">æ›´æ–°</button>
        <button class="btnSmall btnPrimary" id="kFoodTab">æ–™ç†</button>
        <button class="btnSmall" id="kDrinkTab">ãƒ‰ãƒªãƒ³ã‚¯</button>
      </div>

      <div class="kList" id="kList"></div>

      <div class="muted2" style="font-size:.9rem; margin-top:10px;">
        â€» æ–™ç†ï¼šåŒã˜æ–™ç†ã¯ä¸‹ã«ã¶ã‚‰ä¸‹ã’ï¼ˆæ˜‡æ ¼ã—ãŸå´ã®ã¿è‰²ï¼‰ / ãƒ‰ãƒªãƒ³ã‚¯ï¼šã¾ã¨ã‚ãªã„
      </div>
    </section>

    <!-- SALES VIEW -->
    <section class="view" id="viewSales">
      <div class="muted" style="font-weight:950; margin: 6px 0 12px;">å£²ä¸Š</div>
      <div class="btnRow">
        <button class="btnPrimary" id="goTodaySales">æœ¬æ—¥ã®å£²ä¸Š</button>
        <button class="btnPrimary" id="goMonthSales">æœˆå£²ä¸Š</button>
        <button class="btnPrimary" id="goYearSales">å¹´å£²ä¸Š</button>
      </div>
      <div style="height:10px;"></div>
      <div class="btnRow">
        <button class="btnPrimary" id="goSalesManage">å£²ä¸Šç®¡ç†</button>
      </div>
    </section>

    <!-- TODAY SALES VIEW -->
    <section class="view" id="viewTodaySales">
      <div class="muted" style="font-weight:950; margin: 6px 0 12px;">æœ¬æ—¥ã®å£²ä¸Š</div>
      <div class="seatCard" style="min-height:auto;">
        <div class="seatTop">
          <div class="seatLabel">æœ¬æ—¥åˆè¨ˆ</div>
          <div class="seatStatus" id="todayCount">0ä»¶</div>
        </div>
        <div class="yen" style="font-size:1.45rem;" id="todayTotal">åˆè¨ˆ Â¥0</div>
      </div>

      <div class="listBox" id="todaySalesList"></div>
      <div style="height:12px;"></div>
      <button id="todayToSales">å£²ä¸Šã¸æˆ»ã‚‹</button>
    </section>

    <section class="view" id="viewMonthSales">
      <div class="muted" style="font-weight:950; margin: 6px 0 12px;">æœˆå£²ä¸Š</div>
      <div class="hr"></div>
      <div id="monthSalesBox" class="muted2"></div>
      <div style="height:12px;"></div>
      <button id="monthToSales">å£²ä¸Šã¸æˆ»ã‚‹</button>
    </section>

    <section class="view" id="viewYearSales">
      <div class="muted" style="font-weight:950; margin: 6px 0 12px;">å¹´å£²ä¸Š</div>
      <div class="hr"></div>
      <div id="yearSalesBox" class="muted2"></div>
      <div style="height:12px;"></div>
      <button id="yearToSales">å£²ä¸Šã¸æˆ»ã‚‹</button>
    </section>

    <section class="view" id="viewSalesManage">
      <div class="muted" style="font-weight:950; margin: 6px 0 12px;">å£²ä¸Šç®¡ç†</div>

      <div class="btnRow">
        <button class="btnPrimary" id="exportCsv">CSVå‡ºåŠ›ï¼ˆæ¨å¥¨ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆï¼‰</button>
        <button class="btnDanger" id="initSalesBtn">å£²ä¸Šãƒ‡ãƒ¼ã‚¿ã®åˆæœŸåŒ–</button>
      </div>

      <div class="hr"></div>
      <div id="salesLog" class="muted2"></div>
      <div style="height:12px;"></div>
      <button id="manageToSales">å£²ä¸Šã¸æˆ»ã‚‹</button>
    </section>

    <!-- STORE INFO / CONTACT -->
    <section class="view" id="viewStoreInfo">
      <div class="muted" style="font-weight:950; margin: 6px 0 12px;">åº—èˆ—æƒ…å ±</div>
      <div class="muted2">
        ç„¡æ–™ç‰ˆï¼šä¿å­˜ã¯ç°¡æ˜“ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ï¼‰<br>
        æœ‰æ–™ç‰ˆï¼šé›»å­ãƒ¬ã‚·ãƒ¼ãƒˆã«ã€Œåº—èˆ—åãƒ»é€£çµ¡å…ˆãƒ»ä½æ‰€ã€ã‚’è‡ªå‹•åæ˜ äºˆå®š
      </div>
      <div class="hr"></div>
      <input id="stName" type="text" placeholder="åº—èˆ—å" />
      <div style="height:10px;"></div>
      <input id="stPhone" type="text" placeholder="é€£çµ¡å…ˆï¼ˆé›»è©±ï¼‰" />
      <div style="height:10px;"></div>
      <input id="stAddr" type="text" placeholder="ä½æ‰€" />
      <div style="height:12px;"></div>
      <div class="btnRow">
        <button class="btnPrimary" id="saveStoreInfo">ä¿å­˜</button>
      </div>
    </section>

    <section class="view" id="viewContact">
      <div class="muted" style="font-weight:950; margin: 6px 0 12px;">ãŠå•åˆã›</div>
      <div class="muted2">ç„¡æ–™ç‰ˆï¼šç”»é¢ã‚µãƒ³ãƒ—ãƒ«ã§ã™ï¼ˆé€ä¿¡ã¯å®Ÿè£…æº–å‚™ä¸­ï¼‰</div>
      <div class="hr"></div>
      <input type="text" placeholder="ä»¶å" />
      <div style="height:10px;"></div>
      <input type="text" placeholder="å†…å®¹ï¼ˆç°¡æ˜“ï¼‰" />
    </section>

    <section class="view" id="viewRecipe">
      <div class="muted" style="font-weight:950; margin: 6px 0 12px;">æ–™ç†ææ¡ˆï¼ˆæœ‰æ–™æº–å‚™ä¸­ï¼‰</div>
      <div class="muted2">ã“ã®æ©Ÿèƒ½ã¯æœ‰æ–™ç‰ˆã«å…¥ã‚Œã‚‹äºˆå®šï¼ˆãƒ©ã‚¤ãƒˆç‰ˆï¼‰ã€‚</div>
    </section>

  </div>

  <!-- =========================
    BOTTOM DOCKï¼ˆãƒ¡ã‚¤ãƒ³ã®ã¿ï¼‰
  ========================= -->
  <div class="bottomDock" id="bottomDock">
    <div class="dockWrap">
      <div class="opsBox">
        <div class="opsRow">
          <button class="opsBtn same" data-op="move"><div class="twoLine"><span>å¸­ç§»å‹•</span></div></button>
          <button class="opsBtn same" data-op="merge"><div class="twoLine"><span>åˆè¨ˆ</span><span>åˆç®—</span></div></button>
          <button class="opsBtn same" data-op="split"><div class="twoLine"><span>åˆè¨ˆ</span><span>åˆ†å‰²</span></div></button>
          <button class="opsBtn decide" id="opDecide">æ±ºå®š</button>
        </div>
      </div>
      <div class="bottomRow2">
        <button id="todaySalesBtn">æœ¬æ—¥ã®å£²ä¸Š</button>
        <button id="settingsBtn">è¨­å®š</button>
      </div>
    </div>
  </div>

  <!-- ========================= MODAL ROOT ========================= -->
  <div class="modalRoot" id="modalRoot">
    <div class="modal">
      <div class="modalHead">
        <div class="modalTitle" id="mTitle">ã‚¿ã‚¤ãƒˆãƒ«</div>
        <div class="modalSub" id="mSub"></div>
      </div>
      <div class="modalBody" id="mBody"></div>
      <div class="modalFoot" id="mFoot"></div>
    </div>
  </div>

<script>
/* =========================
  ä¿å­˜ãƒ‡ãƒ¼ã‚¿ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ï¼‰
========================= */
const KEY = "ONE_FREE_V2";
const nowTs = ()=> Date.now();
const pad2 = (n)=> String(n).padStart(2,"0");
const fmtTime = (ts)=>{
  const d = new Date(ts);
  if(!isFinite(d.getTime())) return "??:??";
  return `${pad2(d.getHours())}:${pad2(d.getMinutes())}`;
};
const yen = (n)=> `Â¥${(n||0).toLocaleString("ja-JP")}`;
const jaSort = (a,b)=> (a||"").localeCompare((b||""), "ja", { sensitivity:"base" });

function normalizeKey(s){
  return String(s||"").trim().normalize("NFKC").toUpperCase();
}

const defaultState = {
  seats: [],
  menu: [],
  genres: { food: [], drink: [] },
  sales: [],
  salesFix: [],
  store: { name:"", phone:"", addr:"" },
  ui: {
    view:"main",
    selectedSeatIds: [],
    opSelected: null,
    orderSeatId: null,
    orderGenre: null,
    orderCat: "food",
    kitchenTab: "food",
    pay: "cash",
    menuViewGenre: ""
  },
  kitchenDone: {},
  /* âœ…â‘¢ åç§°ãƒã‚¹ã‚¿ï¼ˆè¿½åŠ åˆ†ã‚’ä¿å­˜ï¼‰ */
  seatTypeCustom: []
};

let state = load();

function load(){
  try{
    const raw = localStorage.getItem(KEY);
    if(!raw) return structuredClone(defaultState);
    const s = JSON.parse(raw);

    const merged = {
      ...structuredClone(defaultState),
      ...s,
      ui: { ...structuredClone(defaultState.ui), ...(s.ui||{}) },
      store: { ...structuredClone(defaultState.store), ...(s.store||{}) },
      kitchenDone: s.kitchenDone || {},
      genres: { ...structuredClone(defaultState.genres), ...(s.genres||{}) },
      salesFix: s.salesFix || [],
      seatTypeCustom: Array.isArray(s.seatTypeCustom) ? s.seatTypeCustom : []
    };

    return merged;
  }catch(e){
    return structuredClone(defaultState);
  }
}
function save(){ localStorage.setItem(KEY, JSON.stringify(state)); }

/* ========================= Views ========================= */
const views = {
  main: document.getElementById("viewMain"),
  settings: document.getElementById("viewSettings"),
  seatRegister: document.getElementById("viewSeatRegister"),
  menuRegister: document.getElementById("viewMenuRegister"),
  order: document.getElementById("viewOrder"),
  checkout: document.getElementById("viewCheckout"),
  kitchen: document.getElementById("viewKitchen"),
  sales: document.getElementById("viewSales"),
  todaySales: document.getElementById("viewTodaySales"),
  month: document.getElementById("viewMonthSales"),
  year: document.getElementById("viewYearSales"),
  manage: document.getElementById("viewSalesManage"),
  storeInfo: document.getElementById("viewStoreInfo"),
  contact: document.getElementById("viewContact"),
  recipe: document.getElementById("viewRecipe"),
};

const bottomDock = document.getElementById("bottomDock");
const kitchenBtn = document.getElementById("kitchenBtn");
const topMainBtn = document.getElementById("topMainBtn");

/* bottomDockã¯ãƒ¡ã‚¤ãƒ³ã®ã¿ */
function syncDock(){
  const isMain = state.ui.view==="main";
  bottomDock.classList.toggle("show", isMain);
}

/* topbarä¸­å¤®ãƒœã‚¿ãƒ³ã¯ã€ã‚­ãƒƒãƒãƒ³ç”»é¢ã§ã¯ã€Œãƒ›ãƒ¼ãƒ«ã€ */
function syncTopCenter(){
  if(state.ui.view==="kitchen"){
    kitchenBtn.textContent = "ãƒ›ãƒ¼ãƒ«";
  }else{
    kitchenBtn.textContent = "ã‚­ãƒƒãƒãƒ³";
  }
}

/* å…¨ç”»é¢ãƒˆãƒƒãƒ—ãƒãƒ¼å³å´ã«ã€Œãƒ¡ã‚¤ãƒ³ã€ãƒœã‚¿ãƒ³ï¼ˆãƒ¡ã‚¤ãƒ³ç”»é¢ã§ã¯éè¡¨ç¤ºï¼‰ */
function syncTopMainBtn(){
  const isMain = state.ui.view==="main";
  topMainBtn.style.display = isMain ? "none" : "inline-flex";
}

/* ã‚ªãƒ³ãƒ©ã‚¤ãƒ³çŠ¶æ…‹ */
const netIcon = document.getElementById("netIcon");
function syncNetIcon(){
  const on = navigator.onLine;
  netIcon.textContent = on ? "ğŸ“¶" : "ğŸ“¶âŒ";
  netIcon.title = on ? "ã‚ªãƒ³ãƒ©ã‚¤ãƒ³" : "ã‚ªãƒ•ãƒ©ã‚¤ãƒ³";
}
window.addEventListener("online", syncNetIcon);
window.addEventListener("offline", syncNetIcon);

function go(viewKey){
  Object.values(views).forEach(v=> v.classList.remove("show"));
  views[viewKey].classList.add("show");
  state.ui.view = viewKey;
  save();

  syncDock();
  syncTopCenter();
  syncTopMainBtn();

  if(viewKey==="main") renderMain();
  if(viewKey==="seatRegister") renderSeatRegisterPreview();
  if(viewKey==="menuRegister") renderMenuRegister();
  if(viewKey==="order") renderOrder();
  if(viewKey==="checkout") renderCheckout();
  if(viewKey==="kitchen") renderKitchen();
  if(viewKey==="sales") renderSales();
  if(viewKey==="todaySales") renderTodaySales();
  if(viewKey==="month") renderMonthSales();
  if(viewKey==="year") renderYearSales();
  if(viewKey==="manage") renderSalesManage();
  if(viewKey==="storeInfo") renderStoreInfo();
}

/* ========================= Modal ========================= */
const modalRoot = document.getElementById("modalRoot");
const mTitle = document.getElementById("mTitle");
const mSub = document.getElementById("mSub");
const mBody = document.getElementById("mBody");
const mFoot = document.getElementById("mFoot");

function lockBg(lock){
  if(lock){
    document.documentElement.style.overflow = "hidden";
    document.body.style.overflow = "hidden";
  }else{
    document.documentElement.style.overflow = "";
    document.body.style.overflow = "";
  }
}
function openModal({title, sub="", bodyHtml="", yesText="OK", noText="", onYes=null, onNo=null, yesClass="btnPrimary", noClass=""}){
  mTitle.textContent = title || "";
  mSub.textContent = sub || "";
  mBody.innerHTML = bodyHtml || "";
  mFoot.innerHTML = "";

  if(noText){
    const bNo = document.createElement("button");
    bNo.textContent = noText;
    bNo.className = noClass || "";
    bNo.onclick = ()=>{
      closeModal();
      if(onNo) onNo();
    };
    mFoot.appendChild(bNo);
  }

  const bYes = document.createElement("button");
  bYes.textContent = yesText;
  bYes.className = yesClass || "";
  bYes.onclick = ()=>{
    if(onYes) onYes();
    else closeModal();
  };
  mFoot.appendChild(bYes);

  modalRoot.classList.add("show");
  lockBg(true);
}
function closeModal(){
  modalRoot.classList.remove("show");
  lockBg(false);
}

/* ========================= Helper ========================= */
function escapeHtml(s){
  return String(s||"")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#39;");
}

/* ========================= Main: Seats ========================= */
const seatGrid = document.getElementById("seatGrid");

function seatTotal(seat){
  const ids = [seat.id, ...state.seats.filter(s=> s.mergedInto===seat.id).map(s=> s.id)];
  let sum = 0;
  for(const sid of ids){
    const s = state.seats.find(x=> x.id===sid);
    if(!s) continue;
    for(const o of (s.orders||[])) sum += (o.price||0) * (o.qty||1);
  }
  return sum;
}

function renderMain(){
  state.ui.selectedSeatIds = state.ui.selectedSeatIds.filter(id=> state.seats.some(s=> s.id===id));
  save();

  seatGrid.innerHTML = "";
  const sorted = [...state.seats].sort((a,b)=> {
    return (a.label||"").localeCompare((b.label||""), "ja", { numeric:true, sensitivity:"base" });
  });

  for(const seat of sorted){
    const card = document.createElement("div");
    card.className = "seatCard";
    const isSelected = state.ui.selectedSeatIds.includes(seat.id);
    if(isSelected) card.classList.add("active");
    if(seat.status==="reserve") card.classList.add("reserve");
    if(seat.mergedInto) card.classList.add("merged");

    const label = seat.label || "";
    const statusTxt = seat.mergedInto
      ? `åˆç®— â†’ ${state.seats.find(s=> s.id===seat.mergedInto)?.label || ""}`
      : seat.status==="empty" ? "ç©ºå¸­"
      : seat.status==="reserve" ? "äºˆç´„"
      : "ç€å¸­";

    const people = seat.party?.people ? `${seat.party.people}å` : "";
    const opened = seat.openedAt ? fmtTime(seat.openedAt) : "";
    const name = seat.party?.name ? seat.party.name : "";
    const total = seat.mergedInto ? 0 : seatTotal(seat);

    const metaParts = [];
    if(people) metaParts.push(people);
    if(name) metaParts.push(name);
    if(opened) metaParts.push(opened);

    const mergedTag = seat.mergedInto ? `<span class="tagMini">åˆç®—</span>` : "";

    card.innerHTML = `
      <div class="seatTop">
        <div class="seatLabel" title="${escapeHtml(label)}">${escapeHtml(label)}</div>
        <div class="seatStatus">${escapeHtml(statusTxt)}</div>
      </div>
      <div class="seatMeta">${metaParts.map(x=>`<span>${escapeHtml(x)}</span>`).join("")}</div>
      <div class="seatMoney">
        <div class="yen">${yen(total)}</div>
        ${mergedTag}
      </div>
    `;

    card.onclick = ()=>{
      if(state.ui.opSelected){
        toggleSeatSelect(seat.id);
        return;
      }
      if(seat.mergedInto){
        openModal({ title:"åˆç®—ä¸­ã®å¸­ã§ã™", sub:"åˆç®—ã®å…ƒã®å¸­ã‚’æ“ä½œã—ã¦ãã ã•ã„", yesText:"OK" });
        return;
      }
      onSeatTap(seat);
    };

    seatGrid.appendChild(card);
  }

  renderOpsButtons();
}

function toggleSeatSelect(id){
  const idx = state.ui.selectedSeatIds.indexOf(id);
  if(idx>=0) state.ui.selectedSeatIds.splice(idx,1);
  else state.ui.selectedSeatIds.push(id);
  save();
  renderMain();
}

/* ========================= Seat tap flow ========================= */
function onSeatTap(seat){
  if(seat.status==="empty") openChooseArriveReserve(seat);
  else if(seat.status==="reserve") openReserveAction(seat);
  else openOrderForSeat(seat.id);
}

function openChooseArriveReserve(seat){
  openModal({
    title:`å¸­ï¼ˆ${seat.label}ï¼‰`,
    sub:"ç©ºå¸­ã§ã™ã€‚ã©ã‚Œã‚’é¸ã³ã¾ã™ã‹ï¼Ÿ",
    bodyHtml: `
      <div class="btnRow">
        <button class="btnPrimary" id="chooseArrive">æ¥åº—</button>
        <button class="btnPrimary" id="chooseReserve">äºˆç´„</button>
      </div>
    `,
    yesText:"é–‰ã˜ã‚‹",
    onYes: ()=> closeModal()
  });

  setTimeout(()=>{
    document.getElementById("chooseArrive").onclick = ()=> { closeModal(); openPartyInput(seat, "arrive"); };
    document.getElementById("chooseReserve").onclick = ()=> { closeModal(); openPartyInput(seat, "reserve"); };
  },0);
}

function openPartyInput(seat, mode){
  const title = mode==="arrive" ? "æ¥åº—å…¥åŠ›" : "äºˆç´„å…¥åŠ›";
  const sub = mode==="arrive" ? "æ±ºå®šã§æ³¨æ–‡ãƒšãƒ¼ã‚¸ã¸ç§»å‹•ã—ã¾ã™" : "æ±ºå®šã§ãƒ¡ã‚¤ãƒ³ã¸æˆ»ã‚Šã€å¸­ãŒäºˆç´„è¡¨ç¤ºã«ãªã‚Šã¾ã™";

  const bodyHtml = `
    <div class="muted2">äººæ•°</div>
    <div class="stepper">
      <button class="stepBtn" id="piDec">â—€ï¸</button>
      <div class="stepNum" id="piNum">1</div>
      <button class="stepBtn" id="piInc">â–¶ï¸</button>
    </div>

    <div class="muted2">åå‰ï¼ˆä»»æ„ï¼‰</div>
    <input id="piName" type="text" placeholder="ä¾‹ï¼šç”°ä¸­" />

    ${mode==="reserve" ? `
      <div class="muted2">é›»è©±ç•ªå·ï¼ˆä»»æ„ï¼‰</div>
      <input id="piPhone" type="text" placeholder="ä¾‹ï¼š090-xxxx-xxxx" />
    ` : ``}
  `;

  openModal({
    title:`${title}ï¼ˆ${seat.label}ï¼‰`,
    sub,
    bodyHtml,
    yesText:"æ±ºå®š",
    noText:"æˆ»ã‚‹",
    onYes: ()=>{
      const people = parseInt(document.getElementById("piNum").textContent||"0",10);
      const name = (document.getElementById("piName").value||"").trim();
      const phone = mode==="reserve" ? (document.getElementById("piPhone").value||"").trim() : "";

      if(!people){
        openModal({ title:"äººæ•°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„", sub:"", yesText:"OK" });
        return;
      }

      if(mode==="arrive"){
        seat.status="active";
        seat.party = { people, name, phone:"" };
        seat.openedAt = nowTs();
        seat.orders = seat.orders || [];
        seat.mergedInto = null;
        save();
        closeModal();
        openOrderForSeat(seat.id);
      }else{
        seat.status="reserve";
        seat.party = { people, name, phone };
        seat.openedAt = nowTs();
        seat.orders = seat.orders || [];
        seat.mergedInto = null;
        save();
        closeModal();
        renderMain();
        go("main");
      }
    }
  });

  setTimeout(()=>{
    let n = 1;
    const render = ()=> document.getElementById("piNum").textContent = String(n);
    render();
    document.getElementById("piDec").onclick = ()=> { n = Math.max(1, n-1); render(); };
    document.getElementById("piInc").onclick = ()=> { n = Math.min(99, n+1); render(); };
  },0);
}

/* 7ï¼šäºˆç´„å¸­ã‚¿ãƒƒãƒ—æ™‚ã«äºˆç´„è€…æƒ…å ±ã‚’è¡¨ç¤º */
function openReserveAction(seat){
  const p = seat.party || {};
  const info = `
    <div class="muted2" style="font-weight:900; margin-bottom:8px;">äºˆç´„è€…æƒ…å ±</div>
    <div class="muted2">åå‰ï¼š${escapeHtml(p.name||"æœªå…¥åŠ›")}</div>
    <div class="muted2">é€£çµ¡å…ˆï¼š${escapeHtml(p.phone||"æœªå…¥åŠ›")}</div>
    <div class="muted2">æ™‚é–“ï¼š${seat.openedAt ? escapeHtml(fmtTime(seat.openedAt)) : "æœªå…¥åŠ›"}</div>
    <div class="hr"></div>
  `;

  openModal({
    title:`äºˆç´„ï¼ˆ${seat.label}ï¼‰`,
    sub:"ã©ã‚Œã‚’é¸ã³ã¾ã™ã‹ï¼Ÿ",
    bodyHtml: `
      ${info}
      <div class="btnRow">
        <button class="btnPrimary" id="rvArrive">æ¥åº—</button>
        <button class="btnDanger" id="rvCancel">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      </div>
    `,
    yesText:"æˆ»ã‚‹",
    onYes: ()=> closeModal()
  });

  setTimeout(()=>{
    document.getElementById("rvArrive").onclick = ()=>{ closeModal(); openPartyInput(seat, "arrive"); };
    document.getElementById("rvCancel").onclick = ()=>{
      seat.status="empty"; seat.party=null; seat.openedAt=null; seat.orders=[]; seat.mergedInto=null;
      save(); closeModal(); renderMain();
    };
  },0);
}

/* ========================= Ops ========================= */
const opButtons = Array.from(document.querySelectorAll(".opsBtn.same"));
const opDecide = document.getElementById("opDecide");

function renderOpsButtons(){
  const selected = state.ui.opSelected;
  opButtons.forEach(b=> b.classList.toggle("selected", selected===b.dataset.op));
}
opButtons.forEach(b=>{
  b.onclick = ()=>{
    const op = b.dataset.op;
    state.ui.opSelected = (state.ui.opSelected===op) ? null : op;
    if(!state.ui.opSelected) state.ui.selectedSeatIds = [];
    save();
    renderMain();
  };
});

/* ğŸ”¥å¸­ç§»å‹•ãƒ«ãƒ¼ãƒ«ä¿®æ­£ï¼š
   åˆç®—ä¸­ã®å¸­ï¼ˆmergedIntoãŒã‚ã‚‹å¸­ï¼‰ã¯ã€åˆ†å‰²ã—ã¦ã‹ã‚‰ã§ãªã„ã¨ç§»å‹•ä¸å¯ */
opDecide.onclick = ()=>{
  const op = state.ui.opSelected;
  if(!op){
    openModal({ title:"æ“ä½œã‚’é¸ã‚“ã§ãã ã•ã„", sub:"å¸­ç§»å‹• / åˆè¨ˆåˆç®— / åˆè¨ˆåˆ†å‰² ã®ã©ã‚Œã‹ã‚’é¸æŠã—ã¾ã™", yesText:"OK" });
    return;
  }
  const ids = state.ui.selectedSeatIds;
  if(ids.length===0){
    openModal({ title:"å¸­ã‚’é¸æŠã—ã¦ãã ã•ã„", sub:"æ“ä½œã—ãŸã„å¸­ã‚’ã‚¿ãƒƒãƒ—ã—ã¦é¸ã³ã¾ã™ï¼ˆå†ã‚¿ãƒƒãƒ—ã§è§£é™¤ï¼‰", yesText:"OK" });
    return;
  }

  const selectedSeats = ids.map(id=> state.seats.find(s=> s.id===id)).filter(Boolean);

  if(op==="move"){
    if(selectedSeats.some(s=> s.mergedInto)){
      openModal({
        title:"å¸­ç§»å‹•ã§ãã¾ã›ã‚“",
        sub:"åˆç®—ä¸­ã®å¸­ã¯ã€Œåˆè¨ˆåˆ†å‰²ã€ã§è§£é™¤ã—ã¦ã‹ã‚‰å¸­ç§»å‹•ã—ã¦ãã ã•ã„",
        yesText:"OK"
      });
      return;
    }
  }

  if(op==="merge"){
    if(ids.length<2){
      openModal({ title:"åˆè¨ˆåˆç®—", sub:"2å¸­ä»¥ä¸Šã‚’é¸æŠã—ã¦ãã ã•ã„", yesText:"OK" });
      return;
    }
    const seats = selectedSeats;
    seats.sort((a,b)=> (a.label||"").localeCompare((b.label||""), "ja", { numeric:true, sensitivity:"base" }));
    const base = seats[0];
    const others = seats.slice(1);

    openModal({
      title:"åˆè¨ˆåˆç®—ã—ã¾ã™ã‹ï¼Ÿ",
      sub:`ã€Œ${base.label}ã€ã«åˆç®—ã—ã¾ã™ï¼ˆä»–ã®å¸­ã¯ã€Œåˆç®—ã€è¡¨ç¤ºã«ãªã‚Šã¾ã™ï¼‰`,
      yesText:"æ±ºå®š",
      noText:"æˆ»ã‚‹",
      onYes: ()=>{
        for(const s of others){ s.mergedInto = base.id; }
        save();
        closeModal();
        state.ui.opSelected = null;
        state.ui.selectedSeatIds = [];
        save();
        renderMain();
      }
    });

  }else if(op==="split"){
    const seats = selectedSeats;
    openModal({
      title:"åˆè¨ˆåˆ†å‰²ã—ã¾ã™ã‹ï¼Ÿ",
      sub:"èª¤æ“ä½œã®æ•‘æ¸ˆç”¨ã§ã™ï¼ˆåˆç®—çŠ¶æ…‹ã‚’è§£é™¤ã—ã¾ã™ï¼‰",
      yesText:"æ±ºå®š",
      noText:"æˆ»ã‚‹",
      onYes: ()=>{
        const selectedSet = new Set(ids);
        for(const s of seats){ if(s.mergedInto) s.mergedInto = null; }
        for(const s of seats){
          const baseId = s.id;
          if(selectedSet.has(baseId)){
            state.seats.forEach(x=>{ if(x.mergedInto===baseId) x.mergedInto = null; });
          }
        }
        save();
        closeModal();
        state.ui.opSelected = null;
        state.ui.selectedSeatIds = [];
        save();
        renderMain();
      }
    });

  }else if(op==="move"){
    if(ids.length!==2){
      openModal({ title:"å¸­ç§»å‹•", sub:"ç§»å‹•å…ƒã¨ç§»å‹•å…ˆã®2å¸­ã‚’é¸æŠã—ã¦ãã ã•ã„", yesText:"OK" });
      return;
    }
    const a = state.seats.find(s=> s.id===ids[0]);
    const b = state.seats.find(s=> s.id===ids[1]);
    if(!a || !b) return;

    openModal({
      title:"å¸­ç§»å‹•ã—ã¾ã™ã‹ï¼Ÿ",
      sub:`ã€Œ${a.label}ã€â‡„ã€Œ${b.label}ã€ã®ãƒ‡ãƒ¼ã‚¿ã‚’å…¥ã‚Œæ›¿ãˆã¾ã™ï¼ˆä¸Šæ›¸ããªã—ï¼‰`,
      yesText:"æ±ºå®š",
      noText:"æˆ»ã‚‹",
      onYes: ()=>{
        const tmp = {
          status:a.status, party:a.party, openedAt:a.openedAt, orders:(a.orders||[]), mergedInto:a.mergedInto
        };
        a.status = b.status;
        a.party = b.party;
        a.openedAt = b.openedAt;
        a.orders = (b.orders||[]);
        a.mergedInto = b.mergedInto;

        b.status = tmp.status;
        b.party = tmp.party;
        b.openedAt = tmp.openedAt;
        b.orders = tmp.orders;
        b.mergedInto = tmp.mergedInto;

        save();
        closeModal();
        state.ui.opSelected = null;
        state.ui.selectedSeatIds = [];
        save();
        renderMain();
      }
    });
  }
};

/* ========================= Navigation ========================= */
document.getElementById("settingsBtn").onclick = ()=> go("settings");
document.getElementById("todaySalesBtn").onclick = ()=> go("todaySales");

document.getElementById("backupBtn").onclick = ()=>{
  openModal({
    title:"ä¿å­˜ï¼ˆç„¡æ–™ç‰ˆï¼‰",
    sub:"ç„¡æ–™ç‰ˆã¯ç°¡æ˜“ä¿å­˜ã§ã™ï¼ˆç«¯æœ«å†…ä¿å­˜ï¼‰ã€‚æœ‰æ–™ç‰ˆã§è¤‡æ•°ç«¯æœ«å…±æœ‰/ãƒ¡ãƒ¼ãƒ«é€ä¿¡ã‚’å¼·åŒ–äºˆå®šã€‚",
    yesText:"OK"
  });
};
document.getElementById("brandBtn").onclick = ()=>{
  openModal({
    title:"ONEï¼ˆç„¡æ–™/æœ‰æ–™ï¼‰",
    sub:"ç¾åœ¨ã€æœ‰æ–™ç‰ˆã¯æº–å‚™ä¸­ã§ã™ã€‚ç„¡æ–™ç‰ˆã‚’ãŠä½¿ã„ãã ã•ã„ã€‚",
    yesText:"OK"
  });
};
kitchenBtn.onclick = ()=>{
  if(state.ui.view==="kitchen") go("main");
  else go("kitchen");
};

topMainBtn.onclick = ()=> go("main");

document.querySelectorAll(".menuCard").forEach(el=>{
  el.addEventListener("click", ()=>{
    const goKey = el.getAttribute("data-go");
    if(goKey==="recipe") go("recipe");
    else go(goKey);
  });
});

/* ========================= Seat Register logic
  âœ…â‘¡ï¼šä»®é¸æŠ tmp â†’ æ±ºå®šã§ç¢ºå®š
  âœ…â‘¢ï¼šãã®ä»–åç§°ã‚’ä¿å­˜ã—ã€ãƒœã‚¿ãƒ³ã¨ã—ã¦å¢—ãˆã‚‹
========================= */
const seatTypeButtons = document.getElementById("seatTypeButtons");
const seatTypeConfirmBtn = document.getElementById("seatTypeConfirmBtn");
const otherNameWrap = document.getElementById("otherNameWrap");
const otherName = document.getElementById("otherName");
const countNum = document.getElementById("countNum");
const countLabel = document.getElementById("countLabel");
const seatInputs = document.getElementById("seatInputs");
const capInputs = document.getElementById("capInputs");
const resetSeatReg = document.getElementById("resetSeatReg");
const saveSeatsBtn = document.getElementById("saveSeats");

let sr = {
  // âœ…ç¢ºå®šå€¤ï¼ˆä¿å­˜ã«ä½¿ã†ï¼‰
  type: null,
  typeName: "",
  // âœ…ä»®é¸æŠï¼ˆç·‘è¡¨ç¤ºç”¨ï¼‰
  tmpType: null,
  tmpTypeName: "",
  count: 0,
  labels: [],
  caps: [],
  defaultCap: 4
};

function typeToName(t){
  const map = { counter:"ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼", stand:"ç«‹ã¡", table:"ãƒ†ãƒ¼ãƒ–ãƒ«", zashiki:"åº§æ•·", room:"å€‹å®¤", other:"ãã®ä»–" };
  return map[t] || "";
}

function ensureSeatTypeCustom(){
  if(!Array.isArray(state.seatTypeCustom)) state.seatTypeCustom = [];
  // trim & é‡è¤‡æ’é™¤ï¼ˆè»½ãæ•´ãˆã‚‹ï¼‰
  state.seatTypeCustom = [...new Set(state.seatTypeCustom.map(x=> (x||"").trim()).filter(Boolean))];
}

/* åç§°ãƒœã‚¿ãƒ³UIæç”»ï¼š
  ãƒ»æ—¢å®šï¼ˆã‚«ã‚¦ãƒ³ã‚¿ãƒ¼/ç«‹ã¡/ãƒ†ãƒ¼ãƒ–ãƒ«/åº§æ•·/å€‹å®¤ï¼‰
  ãƒ»è¿½åŠ ã•ã‚ŒãŸã€Œãã®ä»–åç§°ã€ã¯ã€Œãã®ä»–ã€ãƒœã‚¿ãƒ³ã®å‰ã«å¢—ãˆã‚‹
  ãƒ»æ±ºå®šãƒœã‚¿ãƒ³ã¯HTMLã§æœ€ä¸‹éƒ¨å›ºå®š
*/
function renderSeatTypeButtons(){
  ensureSeatTypeCustom();

  const preset = [
    { type:"counter", label:"ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼" },
    { type:"stand",   label:"ç«‹ã¡" },
    { type:"table",   label:"ãƒ†ãƒ¼ãƒ–ãƒ«" },
    { type:"zashiki", label:"åº§æ•·" },
    { type:"room",    label:"å€‹å®¤" },
  ];

  const custom = (state.seatTypeCustom||[]).map(nm=> ({ type:"other", label:nm, custom:true }));

  // ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆï¼š2æ®µã£ã½ãè¦‹ãˆã‚‹ã‚ˆã†ã« btnRow ã‚’è¤‡æ•°ä¸¦ã¹ã‚‹
  const all = [...preset, ...custom];

  let html = "";
  for(let i=0;i<all.length;i+=3){
    const chunk = all.slice(i,i+3);
    html += `<div class="btnRow" style="margin-top:${i===0?0:8}px;">` + chunk.map(it=>{
      const active =
        (sr.tmpType===it.type) &&
        (it.type!=="other" || sr.tmpTypeName===it.label);
      return `<button class="btnSmall ${active ? "btnPrimary":""}" data-seatType="${escapeHtml(it.type)}" data-seatName="${escapeHtml(it.label)}">${escapeHtml(it.label)}</button>`;
    }).join("") + `</div>`;
  }

  // ã€Œãã®ä»–ã€ãƒœã‚¿ãƒ³ã¯å¿…ãšæœ€å¾Œï¼ˆæ±ºå®šã®ç›´å‰ï¼‰
  const otherActive = (sr.tmpType==="other" && (!sr.tmpTypeName || sr.tmpTypeName==="ãã®ä»–"));
  html += `
    <div class="btnRow" style="margin-top:8px;">
      <button class="btnSmall ${otherActive ? "btnPrimary":""}" data-seatType="other" data-seatName="ãã®ä»–">ãã®ä»–</button>
    </div>
  `;

  seatTypeButtons.innerHTML = html;

  seatTypeButtons.querySelectorAll("[data-seatType]").forEach(btn=>{
    btn.onclick = ()=>{
      const t = btn.dataset.seatType;
      const nm = btn.dataset.seatName || "";

      // âœ…ä»®é¸æŠã ã‘æ›´æ–°ï¼ˆç¢ºå®šã¯ã—ãªã„ï¼‰
      sr.tmpType = t;
      if(t==="other"){
        // è¿½åŠ åç§°ãƒœã‚¿ãƒ³ã®å ´åˆã¯ nm ãŒã€Œä¸­åº­ãƒ†ãƒ©ã‚¹ã€ç­‰ã«ãªã‚‹
        if(nm && nm!=="ãã®ä»–"){
          sr.tmpTypeName = nm;
          otherNameWrap.style.display = "none";
        }else{
          sr.tmpTypeName = "ãã®ä»–";
          otherNameWrap.style.display = "block";
        }
      }else{
        sr.tmpTypeName = nm || typeToName(t);
        otherNameWrap.style.display = "none";
      }

      renderSeatTypeButtons();
    };
  });
}

/* ãã®ä»–å…¥åŠ›ã®åæ˜ ï¼ˆä»®é¸æŠä¸­ã®ã¿ï¼‰ */
otherName.addEventListener("input", ()=>{
  if(sr.tmpType==="other"){
    const v = (otherName.value||"").trim();
    sr.tmpTypeName = v || "ãã®ä»–";
  }
});

/* âœ…â‘¡ æ±ºå®šã§ç¢ºå®š */
seatTypeConfirmBtn.onclick = ()=>{
  if(!sr.tmpType){
    openModal({ title:"åç§°ã‚’é¸ã‚“ã§ãã ã•ã„", sub:"åç§°ã‚’ã‚¿ãƒƒãƒ—ã—ã¦ç·‘ã«ã—ã€æœ€å¾Œã«ã€Œæ±ºå®šã€ã§ç¢ºå®šã—ã¾ã™", yesText:"OK" });
    return;
  }

  if(sr.tmpType==="other"){
    // customé¸æŠï¼ˆãƒœã‚¿ãƒ³ï¼‰ã®å ´åˆ sr.tmpTypeName ã¯ãã®ã¾ã¾å…¥ã£ã¦ã‚‹
    let name = (sr.tmpTypeName||"").trim();

    // ã€Œãã®ä»–ã€ãƒœã‚¿ãƒ³ã§å…¥åŠ›ãŒå¿…è¦ãªå ´åˆ
    if(!name || name==="ãã®ä»–"){
      const nm = (otherName.value||"").trim();
      if(!nm){
        openModal({ title:"ãã®ä»–ã®åç§°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„", sub:"ä¾‹ï¼šä¸­åº­ãƒ†ãƒ©ã‚¹", yesText:"OK" });
        return;
      }
      name = nm;
      sr.tmpTypeName = name;
    }

    // âœ…â‘¢ ä¿å­˜ã—ã¦å¢—ã‚„ã™
    ensureSeatTypeCustom();
    if(!state.seatTypeCustom.includes(name)){
      state.seatTypeCustom.push(name);
      save();
    }

    sr.type = "other";
    sr.typeName = name;

    // å…¥åŠ›æ¬„ã¯ç¢ºå®šå¾Œã¯ç•³ã‚€ï¼ˆå¿…è¦ãªã‚‰æ®‹ã™é‹ç”¨ã§ã‚‚OKï¼‰
    otherNameWrap.style.display = "none";

  }else{
    sr.type = sr.tmpType;
    sr.typeName = sr.tmpTypeName || typeToName(sr.tmpType);
    otherNameWrap.style.display = "none";
  }

  // cap/ç·æ•°ãƒ©ãƒ™ãƒ«ï¼ˆç¢ºå®šå€¤ã§æ±ºã‚ã‚‹ï¼‰
  sr.defaultCap = (sr.type==="counter" || sr.type==="stand") ? 1 : 4;
  countLabel.textContent = (sr.type==="counter" || sr.type==="stand") ? "ç·å¸­æ•°" : "ç·å“æ•°";

  renderSeatTypeButtons();
  renderSeatInputs();
  renderCapInputs();
};

document.getElementById("countDec").onclick = ()=> {
  sr.count = Math.max(0, sr.count-1);
  countNum.textContent = String(sr.count);
  renderSeatInputs();
  renderCapInputs();
};
document.getElementById("countInc").onclick = ()=> {
  sr.count = Math.min(99, sr.count+1);
  countNum.textContent = String(sr.count);
  renderSeatInputs();
  renderCapInputs();
};

resetSeatReg.onclick = ()=>{
  sr.type = null; sr.typeName = "";
  sr.tmpType = null; sr.tmpTypeName = "";
  sr.count = 0; sr.labels = []; sr.caps = [];
  otherName.value = ""; otherNameWrap.style.display = "none";
  countNum.textContent = "0"; countLabel.textContent = "ç·å¸­æ•° / ç·å“æ•°";
  renderSeatTypeButtons();
  renderSeatInputs(); renderCapInputs();
  openModal({ title:"å…¥åŠ›ã‚’å–ã‚Šæ¶ˆã—ã¾ã—ãŸ", sub:"ã“ã®ç”»é¢ã®å…¥åŠ›ã‚’åˆæœŸçŠ¶æ…‹ã«æˆ»ã—ã¾ã—ãŸ", yesText:"OK" });
};

/* âœ…â‘£ nextLabelæ”¹å–„ï¼ˆ_2äº‹æ•…ãªã—ï¼‰ */
function normalizeLabel(s){
  return (s||"")
    .toString()
    .trim()
    .replace(/ã€€/g," ")
    .replace(/\s+/g," ");
}
function incAlpha(alpha){
  let carry = 1;
  const arr = alpha.split("").map(c=> c.charCodeAt(0)-65);
  for(let i=arr.length-1;i>=0;i--){
    const v = arr[i] + carry;
    if(v>=26){ arr[i]=0; carry=1; }
    else { arr[i]=v; carry=0; break; }
  }
  if(carry) arr.unshift(0);
  return arr.map(v=> String.fromCharCode(65+v)).join("");
}
function incHira(h){
  const base = "ã‚ã„ã†ãˆãŠã‹ããã‘ã“ã•ã—ã™ã›ããŸã¡ã¤ã¦ã¨ãªã«ã¬ã­ã®ã¯ã²ãµã¸ã»ã¾ã¿ã‚€ã‚ã‚‚ã‚„ã‚†ã‚ˆã‚‰ã‚Šã‚‹ã‚Œã‚ã‚ã‚’ã‚“";
  if(h.length===1){
    const i = base.indexOf(h);
    if(i>=0 && i<base.length-1) return base[i+1];
    if(i===base.length-1) return "ã‚2";
  }
  const last = h.slice(-1);
  const head = h.slice(0,-1);
  const i = base.indexOf(last);
  if(i>=0 && i<base.length-1) return head + base[i+1];
  if(i===base.length-1) return h + "2";
  return h + "2";
}
function guessNextLabel(prev){
  const s = normalizeLabel(prev);
  if(!s) return "";

  // æ•°å­—ã®ã¿
  if(/^\d+$/.test(s)){
    return String(parseInt(s,10)+1);
  }

  // è‹±å­—ã®ã¿ï¼ˆA, Z, AAâ€¦ï¼‰
  if(/^[A-Za-z]+$/.test(s)){
    return incAlpha(s.toUpperCase());
  }

  // ã²ã‚‰ãŒãªã®ã¿
  if(/^[ã-ã‚“]+$/.test(s)){
    return incHira(s);
  }

  // æœ«å°¾æ•°å­—ãŒã‚ã‚Œã° +1
  const m = s.match(/^(.*?)(\d+)$/);
  if(m){
    const head = m[1];
    const n = parseInt(m[2],10)+1;
    return head + String(n);
  }

  // ãã®ä»–ã¯æœ«å°¾ã« 2
  return s + "2";
}

function renderSeatInputs(){
  seatInputs.innerHTML = "";
  const count = sr.count || 0;
  while(sr.labels.length < count) sr.labels.push("");
  sr.labels = sr.labels.slice(0,count);

  for(let i=0;i<count;i++){
    const wrap = document.createElement("div");
    wrap.style.marginBottom = "10px";

    if(!sr.labels[i] && i>0){
      const auto = guessNextLabel(sr.labels[i-1]);
      if(auto) sr.labels[i] = auto;
    }

    const nextHint = (i>0) ? guessNextLabel(sr.labels[i-1] || sr.labels[i] || "") : "";

    wrap.innerHTML = `
      <div class="muted2" style="margin-bottom:6px; font-weight:900;">${i+1}å¸­ï¼ˆå“ï¼‰ç›®</div>
      <input type="text" value="${escapeHtml(sr.labels[i]||"")}" data-idx="${i}"
        placeholder="${i===0 ? "ä¾‹ï¼š1 / A / C1" : (nextHint ? `ä¾‹ï¼š${escapeHtml(nextHint)}` : "ä¾‹ï¼š2")}" />
    `;
    const input = wrap.querySelector("input");
    input.oninput = (e)=>{
      let v = (e.target.value||"").toUpperCase().trim();
      sr.labels[i] = v;

      if(i<count-1 && !sr.labels[i+1]){
        const auto = guessNextLabel(v);
        if(auto){
          sr.labels[i+1] = auto;
          renderSeatInputs();
        }
      }
    };
    seatInputs.appendChild(wrap);
  }
}

function renderCapInputs(){
  capInputs.innerHTML = "";
  const count = sr.count || 0;
  while(sr.caps.length < count) sr.caps.push(sr.defaultCap || 4);
  sr.caps = sr.caps.slice(0,count);

  for(let i=0;i<count;i++){
    const row = document.createElement("div");
    row.style.marginBottom = "10px";
    row.innerHTML = `
      <div class="muted2" style="margin-bottom:6px; font-weight:900;">${escapeHtml(sr.labels[i]||`${i+1}`)} ã®æœ€å¤§äººæ•°</div>
      <div style="display:flex; gap:10px; align-items:center;">
        <button class="stepBtn" data-dec="${i}">â—€ï¸</button>
        <div class="stepNum" id="capNum_${i}">${sr.caps[i]||1}</div>
        <button class="stepBtn" data-inc="${i}">â–¶ï¸</button>
      </div>
    `;
    capInputs.appendChild(row);

    row.querySelector(`[data-dec="${i}"]`).onclick = ()=>{
      sr.caps[i] = Math.max(1, (sr.caps[i]||1)-1);
      document.getElementById(`capNum_${i}`).textContent = String(sr.caps[i]);
    };
    row.querySelector(`[data-inc="${i}"]`).onclick = ()=>{
      sr.caps[i] = Math.min(99, (sr.caps[i]||1)+1);
      document.getElementById(`capNum_${i}`).textContent = String(sr.caps[i]);
    };
  }
}

saveSeatsBtn.onclick = ()=>{
  if(!sr.type){
    openModal({ title:"åç§°ã‚’é¸ã‚“ã§ãã ã•ã„", sub:"åç§°ã‚’ç·‘ã«ã—ãŸå¾Œã€å¿…ãšã€Œæ±ºå®šã€ã§ç¢ºå®šã—ã¦ãã ã•ã„", yesText:"OK" });
    return;
  }
  if(sr.type==="other"){
    const nm = (sr.typeName||"").trim();
    if(!nm){
      openModal({ title:"ãã®ä»–ã®åç§°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„", sub:"ä¾‹ï¼šä¸­åº­ãƒ†ãƒ©ã‚¹", yesText:"OK" });
      return;
    }
  }
  if(!sr.count){
    openModal({ title:"ç·å¸­æ•° / ç·å“æ•°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„", sub:"â—€ï¸ / â–¶ï¸ ã§æ•°ã‚’èª¿æ•´ã§ãã¾ã™", yesText:"OK" });
    return;
  }

  const labels = sr.labels.map(x=> (x||"").toUpperCase().trim());
  for(let i=0;i<labels.length;i++){
    if(!labels[i]){
      openModal({ title:"å¸­ç•ªå·ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„", sub:`${i+1}å¸­ï¼ˆå“ï¼‰ç›®ãŒç©ºã§ã™`, yesText:"OK" });
      return;
    }
  }

  const existingLabels = new Set(state.seats.map(s=> (s.label||"").toUpperCase()));
  const dup = labels.find(l => existingLabels.has(l));
  if(dup){
    openModal({
      title:"åŒã˜å¸­ï¼ˆå“ï¼‰ç•ªå·ãŒã‚ã‚Šã¾ã™ãŒç™»éŒ²ã—ã¾ã™ã‹ï¼Ÿ",
      sub:`ã€Œ${dup}ã€ãŒæ—¢ã«å­˜åœ¨ã—ã¾ã™`,
      yesText:"â—‹ï¼ˆç™»éŒ²ã™ã‚‹ï¼‰",
      noText:"âœ–ï¸ï¼ˆæˆ»ã‚‹ï¼‰",
      onYes: ()=>{ closeModal(); doSaveSeats(labels); }
    });
    return;
  }

  doSaveSeats(labels);
};

function doSaveSeats(labels){
  for(let i=0;i<labels.length;i++){
    state.seats.push({
      id: "S"+nowTs()+ "_" + i + "_" + Math.random().toString(16).slice(2),
      label: labels[i],
      type: sr.type,
      typeName: sr.typeName,
      cap: sr.caps[i] || (sr.defaultCap||4),
      status: "empty",
      party: null,
      openedAt: null,
      orders: [],
      mergedInto: null
    });
  }
  save();
  openModal({ title:"ä¿å­˜ã—ã¾ã—ãŸ", sub:"ãƒ¡ã‚¤ãƒ³ã«åæ˜ ã—ã¾ã—ãŸ", yesText:"OK", onYes: ()=>{ closeModal(); go("main"); }});
}

/* å…¨å¸­ãƒ‡ãƒ¼ã‚¿ã®åˆæœŸåŒ–ï¼ˆæœªä¼šè¨ˆãŒã‚ã‚‹ã¨ä¸å¯ï¼‰ */
document.getElementById("initAllSeatsBtn").onclick = ()=>{
  const hasUnpaid = state.seats.some(s=> (s.orders||[]).length>0 || s.status==="active" || s.status==="reserve" || s.mergedInto);
  if(hasUnpaid){
    openModal({
      title:"åˆæœŸåŒ–ã§ãã¾ã›ã‚“",
      sub:"æœªä¼šè¨ˆã®å¸­ãŒã‚ã‚Šã¾ã™ã€‚å…¨å¸­ãŒä¼šè¨ˆæ¸ˆã¿ã«ãªã‚‰ãªã„ã¨åˆæœŸåŒ–ã§ãã¾ã›ã‚“ã€‚",
      yesText:"OK"
    });
    return;
  }

  openModal({
    title:"å…¨å¸­ãƒ‡ãƒ¼ã‚¿ã®åˆæœŸåŒ–",
    sub:"å¸­ãƒ‡ãƒ¼ã‚¿ã‚’åˆæœŸåŒ–ã™ã‚‹ã¨å…ƒã«æˆ»ã›ã¾ã›ã‚“ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ",
    yesText:"æ¬¡ã¸",
    noText:"æˆ»ã‚‹",
    onYes: ()=>{
      closeModal();
      openDangerSlideModal({
        title:"å…¨å¸­ãƒ‡ãƒ¼ã‚¿ã‚’åˆæœŸåŒ–ã—ã¾ã™",
        sub:"ã‚¹ãƒ©ã‚¤ãƒ‰ã™ã‚‹ã¨å…¨å¸­ãƒ‡ãƒ¼ã‚¿ã‚’åˆæœŸåŒ–ã—ã¾ã™ï¼ˆå…ƒã«æˆ»ã›ã¾ã›ã‚“ï¼‰",
        onDone: ()=>{
          state.seats = [];
          save();
          closeModal();
          renderSeatRegisterPreview();
          renderMain();
          openModal({ title:"åˆæœŸåŒ–ã—ã¾ã—ãŸ", sub:"å…¨å¸­ãƒ‡ãƒ¼ã‚¿ã‚’åˆæœŸåŒ–ã—ã¾ã—ãŸ", yesText:"OK" });
        }
      });
    }
  });
};

/* ========================= ã“ã“ã‹ã‚‰å…ˆã¯ PART2 ã§ç¶šã ========================= */
/* =========================
  Danger Slide Modalï¼ˆåˆæœŸåŒ–ãªã©ã®æœ€çµ‚ç¢ºèªï¼‰
========================= */
function openDangerSlideModal({ title, sub="", onDone }){
  const uid = "ds_"+Math.random().toString(16).slice(2);
  openModal({
    title,
    sub,
    bodyHtml: `
      <div class="muted2" style="font-weight:900;">â€» å³ã¸ã‚¹ãƒ©ã‚¤ãƒ‰ã—ã¦å®Ÿè¡Œ</div>
      <div style="height:10px;"></div>
      <div class="slider shift" id="${uid}">
        <div class="sliderTrack">ã‚¹ãƒ©ã‚¤ãƒ‰ã§å®Ÿè¡Œ</div>
        <div class="sliderKnob">â–¶ï¸</div>
      </div>
    `,
    yesText:"é–‰ã˜ã‚‹",
    onYes: ()=> closeModal()
  });

  setTimeout(()=>{
    const root = document.getElementById(uid);
    if(!root) return;
    const knob = root.querySelector(".sliderKnob");
    const maxX = ()=> (root.clientWidth - knob.clientWidth - 4);
    let startX = 0;
    let baseLeft = 2;
    let dragging = false;

    const setLeft = (x)=>{
      const m = maxX();
      const clamped = Math.max(2, Math.min(2 + m, x));
      knob.style.left = clamped + "px";
      if(clamped >= 2 + m - 2){
        // done
        dragging = false;
        if(onDone) onDone();
      }
    };

    const onDown = (e)=>{
      dragging = true;
      const p = (e.touches && e.touches[0]) ? e.touches[0] : e;
      startX = p.clientX;
      baseLeft = parseFloat(getComputedStyle(knob).left) || 2;
      e.preventDefault?.();
    };
    const onMove = (e)=>{
      if(!dragging) return;
      const p = (e.touches && e.touches[0]) ? e.touches[0] : e;
      const dx = p.clientX - startX;
      setLeft(baseLeft + dx);
      e.preventDefault?.();
    };
    const onUp = ()=>{
      if(!dragging) return;
      dragging = false;
      // æˆ»ã™ï¼ˆæœªå®Œäº†ãªã‚‰ï¼‰
      knob.style.transition = "left .18s ease";
      knob.style.left = "2px";
      setTimeout(()=> knob.style.transition="", 200);
    };

    knob.addEventListener("mousedown", onDown);
    knob.addEventListener("touchstart", onDown, {passive:false});
    window.addEventListener("mousemove", onMove, {passive:false});
    window.addEventListener("touchmove", onMove, {passive:false});
    window.addEventListener("mouseup", onUp);
    window.addEventListener("touchend", onUp);
  },0);
}

/* =========================
  Menu Register
========================= */
const mCategory = document.getElementById("mCategory");
const mGenreSel = document.getElementById("mGenreSel");
const addGenreBtn = document.getElementById("addGenreBtn");
const deleteGenreBtn = document.getElementById("deleteGenreBtn");
const mName = document.getElementById("mName");
const mPrice = document.getElementById("mPrice");
const mTax = document.getElementById("mTax");
const mAdd = document.getElementById("mAdd");

const viewGenreSel = document.getElementById("viewGenreSel");
const viewGenreDecide = document.getElementById("viewGenreDecide");
const menuList = document.getElementById("menuList");

function uniqGenres(arr){
  return [...new Set((arr||[]).map(x=> String(x||"").trim()).filter(Boolean))];
}

function ensureGenres(){
  if(!state.genres) state.genres = { food:[], drink:[] };
  state.genres.food = uniqGenres(state.genres.food);
  state.genres.drink = uniqGenres(state.genres.drink);
}

function fillGenreSelects(){
  ensureGenres();
  const cat = mCategory.value || "food";
  const list = ["", ...state.genres[cat]];
  mGenreSel.innerHTML = list.map(g=> `<option value="${escapeHtml(g)}">${g?escapeHtml(g):"ï¼ˆæœªé¸æŠâ†’æœªåˆ†é¡ï¼‰"}</option>`).join("");

  // é–²è¦§å´ï¼šå…¨ã‚¸ãƒ£ãƒ³ãƒ«ï¼‹æœªåˆ†é¡
  const all = ["__ALL__", "", ...uniqGenres([...(state.genres.food||[]), ...(state.genres.drink||[])])];
  viewGenreSel.innerHTML = all.map(g=>{
    const label = g==="__ALL__" ? "ï¼ˆå…¨ã¦ï¼‰" : (g==="" ? "ï¼ˆæœªåˆ†é¡ï¼‰" : g);
    return `<option value="${escapeHtml(g)}">${escapeHtml(label)}</option>`;
  }).join("");

  // ä»¥å‰ã®é¸æŠã‚’å¾©å…ƒ
  if(state.ui.menuViewGenre){
    viewGenreSel.value = state.ui.menuViewGenre;
  }else{
    viewGenreSel.value = "__ALL__";
  }
}

function renderMenuRegister(){
  ensureGenres();
  fillGenreSelects();
  renderMenuList();
}

function renderMenuList(){
  const g = viewGenreSel.value || "__ALL__";
  const list = (state.menu||[]).slice();

  const filtered = (g==="__ALL__")
    ? list
    : (g==="" ? list.filter(x=> !x.genre) : list.filter(x=> x.genre===g));

  if(filtered.length===0){
    menuList.innerHTML = `<div class="muted2" style="margin-top:10px;">å•†å“ãŒã‚ã‚Šã¾ã›ã‚“</div>`;
    return;
  }

  // è¡¨ç¤ºï¼šå•†å“å / ä¾¡æ ¼(ç¨) / ä¿®æ­£
  menuList.innerHTML = `
    <div class="listBox">
      <div class="listHead">
        <span>å•†å“</span>
        <span class="muted2">${g==="__ALL__" ? "å…¨ã¦" : (g==="" ? "æœªåˆ†é¡" : escapeHtml(g))}</span>
      </div>
      <div id="menuRows"></div>
    </div>
  `;
  const rows = document.getElementById("menuRows");

  filtered
    .sort((a,b)=> jaSort(a.genre||"", b.genre||"") || jaSort(a.name||"", b.name||""))
    .forEach(item=>{
      const row = document.createElement("div");
      row.className = "listRow";
      row.innerHTML = `
        <div>
          <div class="listName">${escapeHtml(item.name||"")}</div>
          <div class="listMeta">${yen(item.price||0)}ï¼ˆ${escapeHtml(String(item.tax||10))}%ï¼‰ / ${escapeHtml(item.cat==="drink" ? "ãƒ‰ãƒªãƒ³ã‚¯":"æ–™ç†")} / ${escapeHtml(item.genre||"æœªåˆ†é¡")}</div>
        </div>
        <div class="listMeta"> </div>
        <button class="listBtn btnSmall" data-edit="${escapeHtml(item.id)}">ä¿®æ­£</button>
      `;
      rows.appendChild(row);

      row.querySelector("[data-edit]").onclick = ()=>{
        const body = `
          <div class="muted2">å•†å“å</div>
          <input id="edName" type="text" value="${escapeHtml(item.name||"")}" />
          <div class="muted2">é‡‘é¡</div>
          <input id="edPrice" type="number" inputmode="numeric" value="${escapeHtml(String(item.price||0))}" />
          <div class="muted2">ç¨ç‡</div>
          <select id="edTax">
            <option value="10" ${String(item.tax)==="10"?"selected":""}>10%</option>
            <option value="8" ${String(item.tax)==="8"?"selected":""}>8%</option>
          </select>
          <div class="muted2">ã‚«ãƒ†ã‚´ãƒªãƒ¼</div>
          <select id="edCat">
            <option value="food" ${item.cat==="food"?"selected":""}>æ–™ç†</option>
            <option value="drink" ${item.cat==="drink"?"selected":""}>ãƒ‰ãƒªãƒ³ã‚¯</option>
          </select>
          <div class="muted2">ã‚¸ãƒ£ãƒ³ãƒ«</div>
          <input id="edGenre" type="text" placeholder="æœªåˆ†é¡ãªã‚‰ç©º" value="${escapeHtml(item.genre||"")}" />
        `;
        openModal({
          title:"ä¿®æ­£",
          sub:"å•†å“åã¯é‡è¤‡ä¸å¯ã§ã™",
          bodyHtml: body,
          yesText:"ä¿å­˜",
          noText:"å‰Šé™¤",
          onNo: ()=>{
            // å‰Šé™¤
            state.menu = (state.menu||[]).filter(x=> x.id!==item.id);
            save();
            closeModal();
            renderMenuRegister();
          },
          onYes: ()=>{
            const newName = (document.getElementById("edName").value||"").trim();
            const newPrice = parseInt(document.getElementById("edPrice").value||"0",10) || 0;
            const newTax = parseInt(document.getElementById("edTax").value||"10",10) || 10;
            const newCat = document.getElementById("edCat").value || "food";
            const newGenre = (document.getElementById("edGenre").value||"").trim();

            if(!newName){
              openModal({ title:"å•†å“åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„", sub:"", yesText:"OK" });
              return;
            }
            const nk = normalizeKey(newName);
            const dup = (state.menu||[]).some(x=> x.id!==item.id && normalizeKey(x.name)===nk);
            if(dup){
              openModal({ title:"åŒã˜å•†å“åãŒã‚ã‚Šã¾ã™", sub:"å•†å“åã¯é‡è¤‡ä¸å¯ã§ã™", yesText:"OK" });
              return;
            }

            item.name = newName;
            item.price = newPrice;
            item.tax = newTax;
            item.cat = newCat;
            item.genre = newGenre;

            // ã‚¸ãƒ£ãƒ³ãƒ«ã‚’è‡ªå‹•ã§ãƒã‚¹ã‚¿ã«è¿½åŠ ï¼ˆæ‰‹æ‰“ã¡æƒ³å®šï¼‰
            ensureGenres();
            if(newGenre){
              if(!state.genres[newCat].includes(newGenre)){
                state.genres[newCat].push(newGenre);
              }
            }
            save();
            closeModal();
            renderMenuRegister();
          }
        });
      };
    });
}

addGenreBtn.onclick = ()=>{
  openModal({
    title:"ã‚¸ãƒ£ãƒ³ãƒ«è¿½åŠ ",
    sub:"ä¾‹ï¼šç„¼ãç‰© / ã‚µãƒ¯ãƒ¼ / æ—¥æœ¬é…’ ãªã©",
    bodyHtml:`<input id="gNew" type="text" placeholder="ã‚¸ãƒ£ãƒ³ãƒ«å" />`,
    yesText:"è¿½åŠ ",
    noText:"æˆ»ã‚‹",
    onYes: ()=>{
      const name = (document.getElementById("gNew").value||"").trim();
      if(!name){
        openModal({ title:"ã‚¸ãƒ£ãƒ³ãƒ«åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„", sub:"", yesText:"OK" });
        return;
      }
      const cat = mCategory.value || "food";
      ensureGenres();
      if(!state.genres[cat].includes(name)) state.genres[cat].push(name);
      save();
      closeModal();
      renderMenuRegister();
    }
  });
};

deleteGenreBtn.onclick = ()=>{
  const g = viewGenreSel.value || "__ALL__";
  if(g==="__ALL__"){
    openModal({ title:"ã‚¸ãƒ£ãƒ³ãƒ«ã‚’é¸ã‚“ã§ãã ã•ã„", sub:"ï¼ˆå…¨ã¦ï¼‰ã§ã¯å‰Šé™¤ã§ãã¾ã›ã‚“", yesText:"OK" });
    return;
  }
  if(g===""){
    openModal({ title:"ï¼ˆæœªåˆ†é¡ï¼‰ã¯å‰Šé™¤ã§ãã¾ã›ã‚“", sub:"", yesText:"OK" });
    return;
  }
  openModal({
    title:"ã‚¸ãƒ£ãƒ³ãƒ«å‰Šé™¤",
    sub:`ã€Œ${g}ã€ã‚’å‰Šé™¤ã—ã¾ã™ï¼ˆå•†å“ã®ã‚¸ãƒ£ãƒ³ãƒ«ã¯æœªåˆ†é¡ã«ãªã‚Šã¾ã™ï¼‰`,
    yesText:"æ¬¡ã¸",
    noText:"æˆ»ã‚‹",
    onYes: ()=>{
      closeModal();
      openDangerSlideModal({
        title:`ã‚¸ãƒ£ãƒ³ãƒ«ã€Œ${g}ã€ã‚’å‰Šé™¤ã—ã¾ã™`,
        sub:"ã‚¹ãƒ©ã‚¤ãƒ‰ã§å‰Šé™¤ï¼ˆå•†å“ã¯æœªåˆ†é¡ã«ç§»å‹•ï¼‰",
        onDone: ()=>{
          ensureGenres();
          state.genres.food = state.genres.food.filter(x=> x!==g);
          state.genres.drink = state.genres.drink.filter(x=> x!==g);
          (state.menu||[]).forEach(it=>{ if(it.genre===g) it.genre=""; });
          state.ui.menuViewGenre = "__ALL__";
          save();
          closeModal();
          renderMenuRegister();
          openModal({ title:"å‰Šé™¤ã—ã¾ã—ãŸ", sub:"å•†å“ã¯æœªåˆ†é¡ã«ãªã‚Šã¾ã—ãŸ", yesText:"OK" });
        }
      });
    }
  });
};

viewGenreDecide.onclick = ()=>{
  state.ui.menuViewGenre = viewGenreSel.value || "__ALL__";
  save();
  renderMenuList();
};

mCategory.onchange = ()=> renderMenuRegister();

mAdd.onclick = ()=>{
  const cat = mCategory.value || "food";
  const genre = mGenreSel.value || "";
  const name = (mName.value||"").trim();
  const price = parseInt(mPrice.value||"0",10) || 0;
  const tax = parseInt(mTax.value||"10",10) || 10;

  if(!name){
    openModal({ title:"å•†å“åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„", sub:"", yesText:"OK" });
    return;
  }
  const nk = normalizeKey(name);
  if((state.menu||[]).some(x=> normalizeKey(x.name)===nk)){
    openModal({ title:"åŒã˜å•†å“åãŒã‚ã‚Šã¾ã™", sub:"å•†å“åã¯é‡è¤‡ä¸å¯ã§ã™", yesText:"OK" });
    return;
  }
  if(price<=0){
    openModal({ title:"é‡‘é¡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„", sub:"0å††ã¯ç™»éŒ²ã§ãã¾ã›ã‚“", yesText:"OK" });
    return;
  }

  state.menu.push({
    id: "M"+nowTs()+"_"+Math.random().toString(16).slice(2),
    cat, genre,
    name, price, tax
  });

  ensureGenres();
  if(genre && !state.genres[cat].includes(genre)) state.genres[cat].push(genre);

  // å…¥åŠ›ã‚¯ãƒªã‚¢ï¼ˆã‚¸ãƒ£ãƒ³ãƒ«ã¯ç¶­æŒï¼‰
  mName.value = "";
  mPrice.value = "";
  save();
  renderMenuRegister();
  openModal({ title:"ç™»éŒ²ã—ã¾ã—ãŸ", sub:"", yesText:"OK" });
};

document.getElementById("initMenuBtn").onclick = ()=>{
  openModal({
    title:"ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãƒ‡ãƒ¼ã‚¿ã®åˆæœŸåŒ–",
    sub:"ãƒ¡ãƒ‹ãƒ¥ãƒ¼/ã‚¸ãƒ£ãƒ³ãƒ«ã‚’åˆæœŸåŒ–ã™ã‚‹ã¨å…ƒã«æˆ»ã›ã¾ã›ã‚“ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ",
    yesText:"æ¬¡ã¸",
    noText:"æˆ»ã‚‹",
    onYes: ()=>{
      closeModal();
      openDangerSlideModal({
        title:"ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’åˆæœŸåŒ–ã—ã¾ã™",
        sub:"ã‚¹ãƒ©ã‚¤ãƒ‰ã™ã‚‹ã¨ãƒ¡ãƒ‹ãƒ¥ãƒ¼/ã‚¸ãƒ£ãƒ³ãƒ«ã‚’åˆæœŸåŒ–ã—ã¾ã™ï¼ˆå…ƒã«æˆ»ã›ã¾ã›ã‚“ï¼‰",
        onDone: ()=>{
          state.menu = [];
          state.genres = { food:[], drink:[] };
          save();
          closeModal();
          renderMenuRegister();
          openModal({ title:"åˆæœŸåŒ–ã—ã¾ã—ãŸ", sub:"ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’åˆæœŸåŒ–ã—ã¾ã—ãŸ", yesText:"OK" });
        }
      });
    }
  });
};

/* å†™çœŸï¼ˆç„¡æ–™ç‰ˆï¼šOCRæœªå®Œæˆã®ãŸã‚ãƒ€ãƒŸãƒ¼ï¼‰ */
document.getElementById("photoBtn").onclick = ()=> document.getElementById("photoInput").click();
document.getElementById("photoClearBtn").onclick = ()=>{
  openModal({ title:"å†™çœŸã‚’æ¶ˆã—ã¾ã—ãŸ", sub:"ï¼ˆç„¡æ–™ç‰ˆï¼šç°¡æ˜“ï¼‰", yesText:"OK" });
};
document.getElementById("photoInput").addEventListener("change", (e)=>{
  const f = e.target.files && e.target.files[0];
  if(!f){
    openModal({ title:"å†™çœŸãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“", sub:"", yesText:"OK" });
    return;
  }
  openModal({
    title:"å†™çœŸã‚’å—ã‘å–ã‚Šã¾ã—ãŸ",
    sub:"ç„¡æ–™ç‰ˆã®OCRã¯æœªå®Œæˆã§ã™ï¼ˆèª¤èªè­˜å‰æï¼‰ã€‚æœ‰æ–™ç‰ˆã§å¼·åŒ–äºˆå®šã€‚",
    yesText:"OK",
    onYes: ()=> closeModal()
  });
});

/* =========================
  Order / Checkout
========================= */
const orderHeaderTitle = document.getElementById("orderHeaderTitle");
const genreGrid = document.getElementById("genreGrid");
const itemsGrid = document.getElementById("itemsGrid");
const orderList = document.getElementById("orderList");
const orderSum = document.getElementById("orderSum");
const orderStageGenres = document.getElementById("orderStageGenres");
const orderStageItems = document.getElementById("orderStageItems");

document.getElementById("orderGoGenre").onclick = ()=> {
  state.ui.orderGenre = null;
  save();
  renderOrder();
};
document.getElementById("orderGoMain").onclick = ()=> go("main");
document.getElementById("orderGoCheckout").onclick = ()=> go("checkout");

document.getElementById("orderCatFood").onclick = ()=>{
  state.ui.orderCat = "food";
  state.ui.orderGenre = null;
  save(); renderOrder();
};
document.getElementById("orderCatDrink").onclick = ()=>{
  state.ui.orderCat = "drink";
  state.ui.orderGenre = null;
  save(); renderOrder();
};

function openOrderForSeat(seatId){
  state.ui.orderSeatId = seatId;
  state.ui.orderCat = state.ui.orderCat || "food";
  state.ui.orderGenre = null;
  save();
  go("order");
}

function seatById(id){ return state.seats.find(s=> s.id===id); }

function seatOrderTotal(seat){
  let sum = 0;
  (seat.orders||[]).forEach(o=> sum += (o.price||0) * (o.qty||1));
  return sum;
}

function renderOrder(){
  const seat = seatById(state.ui.orderSeatId);
  if(!seat){
    go("main"); return;
  }

  const p = seat.party || {};
  const people = p.people ? `${p.people}å` : "";
  orderHeaderTitle.innerHTML = `æ³¨æ–‡ <span class="badge">${escapeHtml(seat.label||"")}${people?` / ${escapeHtml(people)}`:""}</span>`;

  // ã‚«ãƒ†ã‚´ãƒªé¸æŠè¦‹ãŸç›®
  document.getElementById("orderCatFood").classList.toggle("btnPrimary", state.ui.orderCat==="food");
  document.getElementById("orderCatDrink").classList.toggle("btnPrimary", state.ui.orderCat==="drink");

  // ã‚¸ãƒ£ãƒ³ãƒ«ä¸€è¦§
  const cat = state.ui.orderCat || "food";
  const genres = uniqGenres((state.menu||[]).filter(x=> x.cat===cat).map(x=> x.genre||"")).sort(jaSort);
  const genreList = ["", ...genres]; // ""=æœªåˆ†é¡

  genreGrid.innerHTML = "";
  genreList.forEach(g=>{
    const b = document.createElement("button");
    b.className = "genreBtn";
    b.textContent = g ? g : "æœªåˆ†é¡";
    b.onclick = ()=>{
      state.ui.orderGenre = g; // ""ã‚‚ã‚ã‚Š
      save();
      renderOrder();
    };
    genreGrid.appendChild(b);
  });

  // å•†å“ä¸€è¦§
  const g = state.ui.orderGenre;
  if(g===null || g===undefined){
    orderStageGenres.style.display = "";
    orderStageItems.style.display = "none";
    itemsGrid.innerHTML = "";
  }else{
    orderStageGenres.style.display = "none";
    orderStageItems.style.display = "";
    const items = (state.menu||[])
      .filter(x=> x.cat===cat)
      .filter(x=> (x.genre||"") === (g||""))
      .sort((a,b)=> jaSort(a.name||"", b.name||""));

    itemsGrid.innerHTML = "";
    items.forEach(it=>{
      const b = document.createElement("button");
      b.className = "itemBtn";
      b.innerHTML = `${escapeHtml(it.name||"")}<small>${yen(it.price||0)}</small>`;
      b.onclick = ()=>{
        const seat = seatById(state.ui.orderSeatId);
        if(!seat) return;
        seat.orders = seat.orders || [];
        // åŒä¸€å•†å“ã¯ã¾ã¨ã‚ã‚‹
        const found = seat.orders.find(o=> o.mid===it.id);
        if(found){
          found.qty = (found.qty||1) + 1;
        }else{
          seat.orders.push({
            id: "O"+nowTs()+"_"+Math.random().toString(16).slice(2),
            mid: it.id,
            name: it.name,
            price: it.price,
            tax: it.tax,
            cat: it.cat,
            genre: it.genre||"",
            qty: 1,
            addedAt: nowTs()
          });
        }
        save();
        renderOrder();
      };
      itemsGrid.appendChild(b);
    });
  }

  // æ³¨æ–‡å±¥æ­´
  const list = (seat.orders||[]).slice().sort((a,b)=> (b.addedAt||0)-(a.addedAt||0));
  orderList.innerHTML = "";
  let sum = 0;

  list.forEach(o=>{
    const line = (o.price||0)*(o.qty||1);
    sum += line;
    const row = document.createElement("div");
    row.className = "listRow";
    row.innerHTML = `
      <div class="listName">${escapeHtml(o.name||"")}</div>
      <div class="listMeta">${o.qty||1} Ã— ${yen(o.price||0)}</div>
      <button class="listBtn btnSmall btnDanger">âˆ’</button>
    `;
    row.querySelector("button").onclick = ()=>{
      o.qty = (o.qty||1) - 1;
      if(o.qty<=0){
        seat.orders = seat.orders.filter(x=> x!==o);
      }
      save();
      renderOrder();
    };
    orderList.appendChild(row);
  });

  orderSum.textContent = `åˆè¨ˆ ${yen(sum)}`;
}

/* =========================
  Checkout
========================= */
const coSeatLabel = document.getElementById("coSeatLabel");
const coPeople = document.getElementById("coPeople");
const coTotal = document.getElementById("coTotal");
const checkoutOrderList = document.getElementById("checkoutOrderList");
const payBtns = Array.from(document.querySelectorAll(".payBtn"));

payBtns.forEach(b=>{
  b.onclick = ()=>{
    state.ui.pay = b.dataset.pay || "cash";
    save();
    renderCheckout();
  };
});

document.getElementById("warikanBtn").onclick = ()=>{
  const seat = seatById(state.ui.orderSeatId);
  if(!seat) return;
  const total = seatOrderTotalWithMerged(seat);
  openModal({
    title:"å‰²ã‚Šå‹˜",
    sub:"äººæ•°ã‚’å…¥åŠ›ã™ã‚‹ã¨ 1äººã‚ãŸã‚Šã‚’è¡¨ç¤ºã—ã¾ã™ï¼ˆç›®å®‰ï¼‰",
    bodyHtml:`<input id="wkN" type="number" inputmode="numeric" placeholder="äººæ•°" />`,
    yesText:"è¨ˆç®—",
    noText:"æˆ»ã‚‹",
    onYes: ()=>{
      const n = parseInt(document.getElementById("wkN").value||"0",10);
      if(!n || n<=0){
        openModal({ title:"äººæ•°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„", sub:"", yesText:"OK" });
        return;
      }
      const per = Math.ceil(total / n);
      closeModal();
      openModal({ title:"å‰²ã‚Šå‹˜ï¼ˆç›®å®‰ï¼‰", sub:`åˆè¨ˆ ${yen(total)} / ${n}äºº â†’ 1äºº ${yen(per)}`, yesText:"OK" });
    }
  });
};

function mergedSeatIds(baseId){
  return [baseId, ...state.seats.filter(s=> s.mergedInto===baseId).map(s=> s.id)];
}
function seatOrderTotalWithMerged(baseSeat){
  const ids = mergedSeatIds(baseSeat.id);
  let sum = 0;
  ids.forEach(id=>{
    const s = seatById(id);
    if(!s) return;
    (s.orders||[]).forEach(o=> sum += (o.price||0)*(o.qty||1));
  });
  return sum;
}
function mergedOrders(baseSeat){
  const ids = mergedSeatIds(baseSeat.id);
  const all = [];
  ids.forEach(id=>{
    const s = seatById(id);
    if(!s) return;
    (s.orders||[]).forEach(o=> all.push({ seatLabel:s.label, ...o }));
  });
  return all;
}

function renderCheckout(){
  const seat = seatById(state.ui.orderSeatId);
  if(!seat){ go("main"); return; }

  const p = seat.party || {};
  coSeatLabel.textContent = seat.label || "å¸­";
  coPeople.textContent = p.people ? `${p.people}å` : "äººæ•°";
  const total = seatOrderTotalWithMerged(seat);
  coTotal.textContent = `åˆè¨ˆ ${yen(total)}`;

  // æ”¯æ‰•ã„ãƒœã‚¿ãƒ³ã®é¸æŠ
  payBtns.forEach(b=> b.classList.toggle("selected", (b.dataset.pay||"")===state.ui.pay));

  // æ³¨æ–‡ä¸€è¦§ï¼ˆä¿®æ­£ï¼‰
  const all = mergedOrders(seat)
    .sort((a,b)=> (b.addedAt||0)-(a.addedAt||0));

  checkoutOrderList.innerHTML = "";
  if(all.length===0){
    checkoutOrderList.innerHTML = `<div class="saleRow"><div class="muted2">æ³¨æ–‡ãŒã‚ã‚Šã¾ã›ã‚“</div></div>`;
    return;
  }

  all.forEach(o=>{
    const row = document.createElement("div");
    row.className = "listRow";
    row.innerHTML = `
      <div class="listName">${escapeHtml(o.name||"")}</div>
      <div class="listMeta">${o.qty||1} Ã— ${yen(o.price||0)}</div>
      <button class="listBtn btnSmall">ä¿®æ­£</button>
    `;
    row.querySelector("button").onclick = ()=>{
      // å¯¾è±¡ã®å¸­ã‚’è¦‹ã¤ã‘ã¦ qty ã‚’å¤‰æ›´
      openModal({
        title:"æ•°é‡ä¿®æ­£",
        sub:`${o.seatLabel} / ${o.name}`,
        bodyHtml: `
          <div class="stepper">
            <button class="stepBtn" id="qDec">â—€ï¸</button>
            <div class="stepNum" id="qNum">${o.qty||1}</div>
            <button class="stepBtn" id="qInc">â–¶ï¸</button>
          </div>
          <div class="muted2">â€» 0 ã«ã™ã‚‹ã¨å‰Šé™¤</div>
        `,
        yesText:"ä¿å­˜",
        noText:"æˆ»ã‚‹",
        onYes: ()=>{
          // åæ˜ 
          const n = parseInt(document.getElementById("qNum").textContent||"0",10);
          const targetSeat = state.seats.find(s=> s.label===o.seatLabel);
          if(targetSeat){
            const target = (targetSeat.orders||[]).find(x=> x.id===o.id);
            if(target){
              if(n<=0) targetSeat.orders = targetSeat.orders.filter(x=> x!==target);
              else target.qty = n;
              save();
              closeModal();
              renderCheckout();
            }
          }else{
            closeModal();
          }
        }
      });
      setTimeout(()=>{
        let n = o.qty||1;
        const r = ()=> document.getElementById("qNum").textContent = String(n);
        document.getElementById("qDec").onclick = ()=>{ n = Math.max(0, n-1); r(); };
        document.getElementById("qInc").onclick = ()=>{ n = Math.min(99, n+1); r(); };
      },0);
    };
    checkoutOrderList.appendChild(row);
  });
}

document.getElementById("confirmCheckout").onclick = ()=>{
  const base = seatById(state.ui.orderSeatId);
  if(!base){ go("main"); return; }

  const total = seatOrderTotalWithMerged(base);
  if(total<=0){
    openModal({ title:"æ³¨æ–‡ãŒã‚ã‚Šã¾ã›ã‚“", sub:"ä¼šè¨ˆã§ãã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“", yesText:"OK" });
    return;
  }

  openModal({
    title:"ä¼šè¨ˆç¢ºå®šã—ã¾ã™ã‹ï¼Ÿ",
    sub:"ç¢ºå®šã™ã‚‹ã¨å¸­ã¯è‡ªå‹•ã§ç©ºå¸­ã«ãªã‚Šã¾ã™ï¼ˆè¨‚æ­£ã¯æœ¬æ—¥ã®å£²ä¸Šã‹ã‚‰ï¼‰",
    yesText:"æ¬¡ã¸",
    noText:"æˆ»ã‚‹",
    onYes: ()=>{
      closeModal();
      openDangerSlideModal({
        title:"ä¼šè¨ˆç¢ºå®š",
        sub:"ã‚¹ãƒ©ã‚¤ãƒ‰ã™ã‚‹ã¨ä¼šè¨ˆã‚’ç¢ºå®šã—ã€å¸­ãŒç©ºå¸­ã«ãªã‚Šã¾ã™",
        onDone: ()=>{
          const seatLabel = base.label || "";
          const sale = {
            id: "SALE_"+nowTs()+"_"+Math.random().toString(16).slice(2),
            ts: nowTs(),
            seatLabel,
            pay: state.ui.pay || "cash",
            total
          };
          state.sales.push(sale);

          // å¯¾è±¡å¸­ï¼ˆåˆç®—å«ã‚€ï¼‰ã‚’ã‚¯ãƒªã‚¢
          const ids = mergedSeatIds(base.id);
          ids.forEach(id=>{
            const s = seatById(id);
            if(!s) return;
            s.status = "empty";
            s.party = null;
            s.openedAt = null;
            s.orders = [];
            s.mergedInto = null;
          });

          // ä»–å¸­ãŒ base ã«åˆç®—ã•ã‚Œã¦ã„ãŸå ´åˆã‚‚è§£é™¤æ¸ˆã¿ã«ãªã‚‹
          state.ui.pay = "cash";
          state.ui.opSelected = null;
          state.ui.selectedSeatIds = [];
          save();
          closeModal();
          go("main");
        }
      });
    }
  });
};

/* =========================
  Kitchen
========================= */
const kList = document.getElementById("kList");
document.getElementById("kRefresh").onclick = ()=> renderKitchen();
document.getElementById("kFoodTab").onclick = ()=>{ state.ui.kitchenTab="food"; save(); renderKitchen(); };
document.getElementById("kDrinkTab").onclick = ()=>{ state.ui.kitchenTab="drink"; save(); renderKitchen(); };

function renderKitchen(){
  const tab = state.ui.kitchenTab || "food";
  document.getElementById("kFoodTab").classList.toggle("selected", tab==="food");
  document.getElementById("kDrinkTab").classList.toggle("selected", tab==="drink");

  // å…¨æ³¨æ–‡ã‚’é›†ã‚ã‚‹ï¼ˆåˆç®—å¸­ã‚‚å«ã‚€ï¼å„å¸­ã®ordersã‚’ãã®ã¾ã¾ï¼‰
  const entries = [];
  state.seats.forEach(seat=>{
    if(seat.status!=="active") return;
    (seat.orders||[]).forEach(o=>{
      if(o.cat!==tab) return;
      entries.push({
        seatId: seat.id,
        seatLabel: seat.label,
        ts: o.addedAt || seat.openedAt || nowTs(),
        name: o.name,
        qty: o.qty||1
      });
    });
  });

  kList.innerHTML = "";
  if(entries.length===0){
    kList.innerHTML = `<div class="muted2" style="margin-top:10px;">æ³¨æ–‡ãŒã‚ã‚Šã¾ã›ã‚“</div>`;
    return;
  }

  if(tab==="drink"){
    // ãƒ‰ãƒªãƒ³ã‚¯ï¼šã¾ã¨ã‚ãªã„
    entries.sort((a,b)=> a.ts-b.ts);
    entries.forEach(e=>{
      const card = document.createElement("div");
      card.className = "kCard";
      card.innerHTML = `
        <div>
          <div class="kName">${escapeHtml(e.name)}</div>
          <div class="kMeta">
            <span class="kTime">${escapeHtml(fmtTime(e.ts))}</span>
            <span class="kSeat">${escapeHtml(e.seatLabel||"")}</span>
          </div>
        </div>
        <div class="kQty">${e.qty}</div>
      `;
      kList.appendChild(card);
    });
    return;
  }

  // æ–™ç†ï¼šåŒã˜æ–™ç†ã‚’ã¾ã¨ã‚ã‚‹ï¼ˆã¶ã‚‰ä¸‹ã’ï¼‰
  const map = new Map();
  entries.forEach(e=>{
    const key = normalizeKey(e.name);
    if(!map.has(key)) map.set(key, { name:e.name, total:0, items:[] });
    const g = map.get(key);
    g.total += (e.qty||1);
    g.items.push(e);
  });

  const groups = [...map.values()].sort((a,b)=> (a.items[0]?.ts||0) - (b.items[0]?.ts||0));

  groups.forEach(g=>{
    const firstTs = Math.min(...g.items.map(x=> x.ts||nowTs()));
    const overdue = (nowTs() - firstTs) > (20*60*1000); // 20åˆ†è¶…ãˆ
    const card = document.createElement("div");
    card.className = "kCard" + (overdue ? " overdue":"");
    card.innerHTML = `
      <div>
        <div class="kName">${escapeHtml(g.name)}</div>
        <div class="kMeta">
          <span class="kTime">${escapeHtml(fmtTime(firstTs))}</span>
          <span>åˆè¨ˆ ${g.total}</span>
        </div>
        <div class="kSubLine">
          ${g.items.sort((a,b)=> a.ts-b.ts).map(it=>`
            <div class="kSubItem">
              <div class="kSubLeft">
                <span class="kTime">${escapeHtml(fmtTime(it.ts))}</span>
                <span class="kSeat">${escapeHtml(it.seatLabel||"")}</span>
              </div>
              <div class="kQty">${it.qty}</div>
            </div>
          `).join("")}
        </div>
      </div>
      <div class="kQty">${g.total}</div>
    `;
    kList.appendChild(card);
  });
}
/* =========================
  Sales
========================= */
document.getElementById("goTodaySales").onclick = ()=> go("todaySales");
document.getElementById("goMonthSales").onclick = ()=> go("month");
document.getElementById("goYearSales").onclick = ()=> go("year");
document.getElementById("goSalesManage").onclick = ()=> go("manage");

document.getElementById("todayToSales").onclick = ()=> go("sales");
document.getElementById("monthToSales").onclick = ()=> go("sales");
document.getElementById("yearToSales").onclick = ()=> go("sales");
document.getElementById("manageToSales").onclick = ()=> go("sales");

function renderSales(){}

/* æœ¬æ—¥ã®å£²ä¸Šï¼ˆè¨‚æ­£ä¼ç¥¨æ–¹å¼ï¼šå‰Šé™¤ã§ã¯ãªãè¨‚æ­£ä¼ç¥¨è¿½åŠ ï¼‰ */
function todayKey(ts){
  const d = new Date(ts);
  return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
}

function renderTodaySales(){
  const listBox = document.getElementById("todaySalesList");
  const today = todayKey(nowTs());

  const sales = state.sales.filter(x=> todayKey(x.ts)===today);
  const fixes = state.salesFix.filter(x=> todayKey(x.ts)===today);

  const merged = [...sales, ...fixes].sort((a,b)=> b.ts-a.ts);

  let total = 0;
  for(const s of merged) total += (s.total||0);

  document.getElementById("todayTotal").textContent = `åˆè¨ˆ ${yen(total)}`;
  document.getElementById("todayCount").textContent = `${merged.length}ä»¶`;

  listBox.innerHTML = `
    <div class="listHead">
      <span>ä¼ç¥¨ä¸€è¦§</span>
      <span class="muted2">${today}</span>
    </div>
  `;

  if(merged.length===0){
    listBox.innerHTML += `<div class="saleRow"><div class="muted2">æœ¬æ—¥ã®å£²ä¸Šã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“</div></div>`;
    return;
  }

  merged.forEach(s=>{
    const isFix = (s.kind==="fix");
    const row = document.createElement("div");
    row.className = "saleRow";
    row.innerHTML = `
      <div class="saleTop">
        <div>
          <div class="saleTitle">
            ${escapeHtml(fmtTime(s.ts))} / ${escapeHtml(s.seatLabel||"")}
            ${isFix ? `<span class="tagFix">è¨‚æ­£</span>` : ``}
          </div>
          <div class="saleMeta">
            <span>æ”¯æ‰•ï¼š${escapeHtml(s.pay||"")}</span>
            <span>é‡‘é¡ï¼š${yen(s.total||0)}</span>
          </div>
        </div>
        <div class="saleBtns">
          ${isFix ? "" : `<button class="btnSmall btnDanger" data-fix="${escapeHtml(s.id)}">è¨‚æ­£</button>`}
        </div>
      </div>
    `;
    listBox.appendChild(row);

    const fixBtn = row.querySelector("[data-fix]");
    if(fixBtn){
      fixBtn.onclick = ()=>{
        openModal({
          title:"è¨‚æ­£ä¼ç¥¨ã‚’ä½œæˆã—ã¾ã™ã‹ï¼Ÿ",
          sub:"å‰Šé™¤ã§ã¯ãªãã€Œè¨‚æ­£ä¼ç¥¨ã€ã‚’è¿½åŠ ã—ã¦å¸³å°»ã‚’åˆã‚ã›ã¾ã™ï¼ˆç¨å‹™å‘ã‘ï¼‰",
          yesText:"ä½œæˆ",
          noText:"æˆ»ã‚‹",
          onYes: ()=>{
            const fix = {
              id: "FIX_"+nowTs()+"_"+Math.random().toString(16).slice(2),
              kind:"fix",
              ts: nowTs(),
              seatLabel: s.seatLabel,
              pay: s.pay,
              total: -(s.total||0),
              targetSaleId: s.id
            };
            state.salesFix.push(fix);
            save();
            closeModal();
            renderTodaySales();
          }
        });
      };
    }
  });
}

/* æœˆå£²ä¸Š */
function renderMonthSales(){
  const box = document.getElementById("monthSalesBox");

  const map = {};
  const all = [...state.sales, ...state.salesFix];

  for(const s of all){
    const d = new Date(s.ts);
    const key = `${d.getFullYear()}-${pad2(d.getMonth()+1)}`;
    if(!map[key]) map[key]=0;
    map[key]+= (s.total||0);
  }

  const keys = Object.keys(map).sort().reverse();
  if(keys.length===0){
    box.innerHTML = "ã¾ã å£²ä¸ŠãŒã‚ã‚Šã¾ã›ã‚“";
    return;
  }

  box.innerHTML = keys.map(k=>`
    <div class="saleRow">
      <div class="saleTop">
        <div class="saleTitle">${escapeHtml(k)}</div>
        <div class="yen">${yen(map[k])}</div>
      </div>
    </div>
  `).join("");
}

/* å¹´å£²ä¸Š */
function renderYearSales(){
  const box = document.getElementById("yearSalesBox");

  const map = {};
  const all = [...state.sales, ...state.salesFix];

  for(const s of all){
    const d = new Date(s.ts);
    const key = `${d.getFullYear()}`;
    if(!map[key]) map[key]=0;
    map[key]+= (s.total||0);
  }

  const keys = Object.keys(map).sort().reverse();
  if(keys.length===0){
    box.innerHTML = "ã¾ã å£²ä¸ŠãŒã‚ã‚Šã¾ã›ã‚“";
    return;
  }

  box.innerHTML = keys.map(k=>`
    <div class="saleRow">
      <div class="saleTop">
        <div class="saleTitle">${escapeHtml(k)}å¹´</div>
        <div class="yen">${yen(map[k])}</div>
      </div>
    </div>
  `).join("");
}

/* å£²ä¸Šç®¡ç† */
const salesLog = document.getElementById("salesLog");

function renderSalesManage(){
  const cnt = state.sales.length + state.salesFix.length;
  salesLog.innerHTML = `
    å£²ä¸Šãƒ‡ãƒ¼ã‚¿ï¼š${cnt}ä»¶<br>
    CSVå‡ºåŠ›ã¯ã€Œæ¨å¥¨ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã€ã§å‡ºåŠ›ã—ã¾ã™ï¼ˆå¼¥ç”Ÿ/freee/ãƒãƒãƒ•ã‚©ã¯æœ‰æ–™ç‰ˆã§å®Œå…¨ä¸€è‡´å¯¾å¿œäºˆå®šï¼‰
  `;
}

/* CSVå‡ºåŠ›ï¼ˆæ¨å¥¨ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆï¼‰ */
document.getElementById("exportCsv").onclick = ()=>{
  if(state.sales.length===0 && state.salesFix.length===0){
    openModal({ title:"å£²ä¸ŠãŒã‚ã‚Šã¾ã›ã‚“", sub:"CSVå‡ºåŠ›ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“", yesText:"OK" });
    return;
  }

  const rows = [];
  rows.push(["æ—¥æ™‚","åŒºåˆ†","å¸­","æ”¯æ‰•æ–¹æ³•","é‡‘é¡"].join(","));

  const all = [...state.sales.map(x=>({...x, kind:"sale"})), ...state.salesFix.map(x=>({...x, kind:"fix"}))];
  all.sort((a,b)=> a.ts-b.ts);

  for(const s of all){
    const d = new Date(s.ts);
    const dt = `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())} ${pad2(d.getHours())}:${pad2(d.getMinutes())}`;
    rows.push([
      `"${dt}"`,
      `"${s.kind==="fix" ? "è¨‚æ­£" : "å£²ä¸Š"}"`,
      `"${(s.seatLabel||"")}"`,
      `"${(s.pay||"")}"`,
      String(s.total||0)
    ].join(","));
  }

  const csv = rows.join("\n");
  const blob = new Blob([csv], { type:"text/csv;charset=utf-8;" });
  const url = URL.createObjectURL(blob);

  const a = document.createElement("a");
  a.href = url;
  a.download = "ONE_sales.csv";
  a.click();
  URL.revokeObjectURL(url);

  openModal({ title:"CSVã‚’å‡ºåŠ›ã—ã¾ã—ãŸ", sub:"ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒ•ã‚©ãƒ«ãƒ€ã‚’ç¢ºèªã—ã¦ãã ã•ã„", yesText:"OK" });
};

/* å£²ä¸Šãƒ‡ãƒ¼ã‚¿åˆæœŸåŒ– */
document.getElementById("initSalesBtn").onclick = ()=>{
  openModal({
    title:"å£²ä¸Šãƒ‡ãƒ¼ã‚¿ã®åˆæœŸåŒ–",
    sub:"å£²ä¸Šãƒ‡ãƒ¼ã‚¿ã‚’åˆæœŸåŒ–ã™ã‚‹ã¨å…ƒã«æˆ»ã™ã“ã¨ã¯ã§ãã¾ã›ã‚“ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ",
    yesText:"åŒæ„ã™ã‚‹",
    noText:"æˆ»ã‚‹",
    onYes: ()=>{
      closeModal();
      openDangerSlideModal({
        title:"åˆæœŸåŒ–ã‚’å®Ÿè¡Œã—ã¾ã™",
        sub:"ã‚¹ãƒ©ã‚¤ãƒ‰ã™ã‚‹ã¨å£²ä¸Šãƒ‡ãƒ¼ã‚¿ã‚’åˆæœŸåŒ–ã—ã¾ã™ï¼ˆå…ƒã«æˆ»ã›ã¾ã›ã‚“ï¼‰",
        onDone: ()=>{
          state.sales = [];
          state.salesFix = [];
          save();
          closeModal();
          openModal({ title:"åˆæœŸåŒ–ã—ã¾ã—ãŸ", sub:"å£²ä¸Šãƒ‡ãƒ¼ã‚¿ã‚’åˆæœŸåŒ–ã—ã¾ã—ãŸ", yesText:"OK" });
        }
      });
    }
  });
};

/* =========================
  Store info
========================= */
document.getElementById("saveStoreInfo").onclick = ()=>{
  state.store.name = (document.getElementById("stName").value||"").trim();
  state.store.phone = (document.getElementById("stPhone").value||"").trim();
  state.store.addr = (document.getElementById("stAddr").value||"").trim();
  save();
  openModal({ title:"ä¿å­˜ã—ã¾ã—ãŸ", sub:"åº—èˆ—æƒ…å ±ã‚’ä¿å­˜ã—ã¾ã—ãŸ", yesText:"OK" });
};

function renderStoreInfo(){
  document.getElementById("stName").value = state.store.name || "";
  document.getElementById("stPhone").value = state.store.phone || "";
  document.getElementById("stAddr").value = state.store.addr || "";
}

/* =========================
  åˆæœŸãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
========================= */
syncNetIcon();
syncDock();
syncTopCenter();
syncTopMainBtn();

/* âœ…è¿½åŠ ï¼šåç§°ãƒœã‚¿ãƒ³åˆæœŸæç”» */
renderSeatTypeButtons();

renderSeatInputs();
renderCapInputs();
renderMenuRegister();
renderMain();
go(state.ui.view || "main");

</script>
</body>
</html>