<!-- =========================
  ONE レジアプリ（無料版）完全フル：PART1
  役割：HTML骨格 / CSS / 共通定義 / メイン画面UI / 最低限JS
  保存KEY：ONE_FREE_FULL_V1
========================= -->
<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>ONE（無料版）</title>
  <style>
    :root{
      --bg:#0b0f14;
      --panel:#121a24;
      --panel2:#0f1620;
      --line:#223042;
      --text:#e9f0ff;
      --muted:#a9b7cc;
      --accent:#4cc3ff;
      --danger:#ff5c7a;
      --ok:#58e38a;

      --topH:58px;
      --bottomH:78px;
      --radius:14px;
      --gap:10px;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      background:var(--bg);
      color:var(--text);
      font-family: -apple-system, BlinkMacSystemFont, "Hiragino Sans", "Noto Sans JP", "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      -webkit-font-smoothing:antialiased;
      text-rendering:optimizeLegibility;
      overflow-x:hidden;
    }

    /* ===== Fixed Top Bar ===== */
    .topbar{
      position:fixed;
      top:0; left:0; right:0;
      height:var(--topH);
      padding:10px 12px calc(10px + env(safe-area-inset-top)) 12px;
      display:flex;
      align-items:center;
      gap:10px;
      background:linear-gradient(180deg, rgba(18,26,36,.96), rgba(18,26,36,.72));
      border-bottom:1px solid var(--line);
      z-index:50;
      backdrop-filter: blur(10px);
    }
    .brand{
      font-weight:800;
      letter-spacing:.5px;
      font-size:18px;
      white-space:nowrap;
    }
    .topbar .spacer{ flex:1; }
    .btn{
      border:1px solid var(--line);
      background:var(--panel2);
      color:var(--text);
      padding:10px 12px;
      border-radius:12px;
      font-weight:700;
      font-size:14px;
      line-height:1;
      cursor:pointer;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }
    .btn:active{ transform: translateY(1px); }
    .btn.primary{ border-color: rgba(76,195,255,.55); box-shadow: 0 0 0 1px rgba(76,195,255,.18) inset; }
    .btn.ghost{ background:transparent; }
    .btn.small{ padding:8px 10px; font-size:13px; border-radius:11px; }

    /* ===== App Layout ===== */
    .app{
      padding-top: calc(var(--topH) + env(safe-area-inset-top));
      padding-bottom: calc(var(--bottomH) + env(safe-area-inset-bottom));
      min-height:100%;
    }

    .page{
      display:none;
      padding:12px;
    }
    .page.active{ display:block; }

    /* ===== Main Page ===== */
    .sectionTitle{
      font-size:14px;
      color:var(--muted);
      margin:10px 2px 8px 2px;
      font-weight:700;
    }

    .seatGrid{
      display:grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap:var(--gap);
    }

    .seatCard{
      background: var(--panel);
      border:1px solid var(--line);
      border-radius: var(--radius);
      padding:10px;
      min-height:108px;
      display:flex;
      flex-direction:column;
      gap:6px;
      position:relative;
      overflow:hidden;
    }

    .seatCard.selected{
      border-color: rgba(76,195,255,.9);
      box-shadow: 0 0 0 2px rgba(76,195,255,.22) inset;
    }

    .seatLabel{
      font-size:20px;
      font-weight:900;
      letter-spacing:.5px;
      line-height:1.05;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .seatName{
      font-size:13px;
      color:var(--muted);
      font-weight:700;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      min-height:16px;
    }

    .seatMeta{
      margin-top:auto;
      display:flex;
      flex-direction:column;
      gap:4px;
      font-size:12px;
      color:var(--muted);
      font-weight:700;
    }

    .metaRow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
      white-space:nowrap;
    }

    .yen{
      font-size:14px;
      color:var(--text);
      font-weight:900;
    }

    .badge{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:4px 8px;
      border-radius:999px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      font-size:12px;
      font-weight:800;
      color:var(--muted);
    }
    .badge.ok{ color:var(--ok); border-color: rgba(88,227,138,.35); }
    .badge.danger{ color:var(--danger); border-color: rgba(255,92,122,.35); }

    .hint{
      margin-top:10px;
      color:var(--muted);
      font-size:12px;
      font-weight:700;
      line-height:1.5;
    }

    /* ===== Fixed Bottom Bar ===== */
    .bottombar{
      position:fixed;
      left:0; right:0; bottom:0;
      height: calc(var(--bottomH) + env(safe-area-inset-bottom));
      padding:10px 10px calc(10px + env(safe-area-inset-bottom)) 10px;
      display:flex;
      gap:8px;
      align-items:center;
      justify-content:space-between;
      background:linear-gradient(0deg, rgba(18,26,36,.96), rgba(18,26,36,.60));
      border-top:1px solid var(--line);
      z-index:60;
      backdrop-filter: blur(10px);
    }
    .barGroup{
      display:flex;
      gap:8px;
      align-items:center;
      flex-wrap:nowrap;
      overflow:auto;
      -webkit-overflow-scrolling: touch;
      scrollbar-width:none;
    }
    .barGroup::-webkit-scrollbar{ display:none; }

    .barBtn{
      min-width:92px;
      padding:10px 10px;
      border-radius:14px;
      font-size:13px;
      font-weight:900;
      border:1px solid var(--line);
      background: var(--panel2);
      color:var(--text);
      cursor:pointer;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
      white-space:nowrap;
    }
    .barBtn.primary{
      border-color: rgba(76,195,255,.65);
      box-shadow: 0 0 0 1px rgba(76,195,255,.16) inset;
    }
    .barBtn.danger{
      border-color: rgba(255,92,122,.55);
      box-shadow: 0 0 0 1px rgba(255,92,122,.12) inset;
    }

    /* ===== Utilities ===== */
    .row{ display:flex; gap:8px; align-items:center; }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
  </style>
</head>

<body>
  <!-- ===== Top Bar ===== -->
  <div class="topbar">
    <div class="brand">ONE（無料版）</div>
    <div class="spacer"></div>
    <button class="btn small primary" id="goKitchen">キッチン</button>
    <button class="btn small" id="goBackup">バックアップ</button>
  </div>

  <div class="app" id="app">
    <!-- ===== PAGE: Main ===== -->
    <section class="page active" id="page-main">
      <div class="row" style="justify-content:space-between; gap:10px;">
        <div class="badge" id="selectedInfo">選択：0</div>
        <button class="btn small ghost" id="goSeatRegister">席登録</button>
      </div>

      <div class="sectionTitle">席（タップで選択 → 決定）</div>
      <div class="seatGrid" id="seatGrid"></div>

      <div class="hint">
        ・空席を選んで「決定」→ 来店（人数）へ<br>
        ・複数席を選んで「決定」→ まとめ席として来店へ（現場小ワザ対応）<br>
        ・ここは「動く見本（UI仕様書）」のメイン画面。ロジックはPART2以降で実装していく
      </div>
    </section>

    <!-- ===== ここから下に PART2〜のページやモーダルを追加していく ===== -->

    <script>
      /* =========================
        Common / State (PART1)
      ========================= */
      const STORAGE_KEY = "ONE_FREE_FULL_V1";

      const state = {
        page: "main",
        seats: [
          // 初期デモ（後で席登録で上書きされる）
          { id:"A1", name:"", status:"empty", since:null, total:0, people:0 },
          { id:"A2", name:"", status:"empty", since:null, total:0, people:0 },
          { id:"A3", name:"", status:"empty", since:null, total:0, people:0 },
          { id:"B1", name:"", status:"empty", since:null, total:0, people:0 },
          { id:"B2", name:"", status:"empty", since:null, total:0, people:0 },
          { id:"B3", name:"", status:"empty", since:null, total:0, people:0 },
        ],
        selectedSeatIds: []
      };

      function loadState(){
        try{
          const raw = localStorage.getItem(STORAGE_KEY);
          if(!raw) return;
          const data = JSON.parse(raw);
          if(data && typeof data === "object"){
            // 最低限の安全コピー
            if(Array.isArray(data.seats)) state.seats = data.seats;
            if(Array.isArray(data.selectedSeatIds)) state.selectedSeatIds = data.selectedSeatIds;
          }
        }catch(e){
          console.warn("loadState failed:", e);
        }
      }

      function saveState(){
        try{
          localStorage.setItem(STORAGE_KEY, JSON.stringify({
            seats: state.seats,
            selectedSeatIds: state.selectedSeatIds
          }));
        }catch(e){
          console.warn("saveState failed:", e);
        }
      }

      function pad2(n){ return String(n).padStart(2,"0"); }
      function fmtTime(ts){
        if(!ts) return "";
        const d = new Date(ts);
        return `${pad2(d.getHours())}:${pad2(d.getMinutes())}`;
      }
      function fmtYen(n){
        const x = Number(n||0);
        return x.toLocaleString("ja-JP");
      }

      // A1, A2... B1... / 数字だけ / 文字だけ をそれなりに並べる
      function seatSortKey(id){
        const s = String(id||"").trim();
        const m = s.match(/^([A-Za-z]+)?\s*(\d+)?$/);
        if(!m) return `Z_${s}`;
        const letters = (m[1]||"").toUpperCase();
        const num = m[2] ? Number(m[2]) : 0;
        return `${letters || "Z"}_${String(num).padStart(6,"0")}_${s}`;
      }

      function isSelected(id){
        return state.selectedSeatIds.includes(id);
      }

      function toggleSelect(id){
        const idx = state.selectedSeatIds.indexOf(id);
        if(idx >= 0) state.selectedSeatIds.splice(idx,1);
        else state.selectedSeatIds.push(id);
        updateSelectedInfo();
        renderMain();
        saveState();
      }

      function updateSelectedInfo(){
        const el = document.getElementById("selectedInfo");
        if(!el) return;
        el.textContent = `選択：${state.selectedSeatIds.length}`;
      }

      function renderMain(){
        const grid = document.getElementById("seatGrid");
        if(!grid) return;
        grid.innerHTML = "";

        const seats = [...state.seats].sort((a,b)=> seatSortKey(a.id).localeCompare(seatSortKey(b.id)));

        for(const seat of seats){
          const card = document.createElement("div");
          card.className = "seatCard" + (isSelected(seat.id) ? " selected" : "");
          card.onclick = ()=> toggleSelect(seat.id);

          const label = document.createElement("div");
          label.className = "seatLabel";
          label.textContent = seat.id || "(未設定)";

          const name = document.createElement("div");
          name.className = "seatName";
          name.textContent = (seat.name && String(seat.name).trim()) ? seat.name : "";

          const meta = document.createElement("div");
          meta.className = "seatMeta";

          const row1 = document.createElement("div");
          row1.className = "metaRow";
          const left1 = document.createElement("span");
          left1.textContent = seat.status === "reserved" ? "予約" : (seat.status === "seated" ? "着席" : "空席");
          const right1 = document.createElement("span");
          right1.textContent = seat.since ? fmtTime(seat.since) : "";
          row1.appendChild(left1);
          row1.appendChild(right1);

          const row2 = document.createElement("div");
          row2.className = "metaRow";
          const left2 = document.createElement("span");
          left2.textContent = seat.people ? `${seat.people}名` : "";
          const right2 = document.createElement("span");
          right2.className = "yen";
          right2.textContent = `¥${fmtYen(seat.total||0)}`;
          row2.appendChild(left2);
          row2.appendChild(right2);

          meta.appendChild(row1);
          meta.appendChild(row2);

          card.appendChild(label);
          card.appendChild(name);
          card.appendChild(meta);

          grid.appendChild(card);
        }
      }

      // PART2以降で実装する関数（PART1では“落ちない”ための仮置き）
      function go(pageName){
        // ページ切替はPART2以降で本実装
        console.log("go:", pageName);
        alert("この画面はPART2以降で実装します：" + pageName);
      }

      // ===== Top Buttons =====
      document.getElementById("goKitchen").onclick = ()=> go("kitchen");
      document.getElementById("goBackup").onclick = ()=> go("backup");
      document.getElementById("goSeatRegister").onclick = ()=> go("seatRegister");

      // ===== Init =====
      loadState();
      updateSelectedInfo();
      renderMain();
      saveState();
    </script>

    <!-- ===== Fixed Bottom Bar (Main global) ===== -->
    <div class="bottombar">
      <div class="barGroup">
        <button class="barBtn" id="btnSeatMove">席移動</button>
        <button class="barBtn" id="btnMergeTotal">合計合算</button>
        <button class="barBtn" id="btnSplitTotal">合計分割</button>
      </div>
      <div class="barGroup">
        <button class="barBtn primary" id="btnDecide">決定</button>
        <button class="barBtn" id="btnTodaySales">本日の売上</button>
        <button class="barBtn" id="btnSettings">設定</button>
      </div>
    </div>

    <script>
      // Bottom bar (仮置き → PART2以降で本実装)
      document.getElementById("btnSeatMove").onclick = ()=> alert("PART2以降：席移動");
      document.getElementById("btnMergeTotal").onclick = ()=> alert("PART4以降：合計合算");
      document.getElementById("btnSplitTotal").onclick = ()=> alert("PART4以降：合計分割");
      document.getElementById("btnDecide").onclick = ()=> alert("PART2以降：決定（来店/予約へ）");
      document.getElementById("btnTodaySales").onclick = ()=> go("todaySales");
      document.getElementById("btnSettings").onclick = ()=> go("settings");
    </script>

    <!-- =========================
      ここから先は PART2 で続く
    ========================= -->
<!-- =========================
  ONE レジアプリ（無料版）完全フル：PART2
  役割：画面遷移 / 席登録 / 来店・予約モーダル / 決定ボタン処理 / 背景スクロール固定
========================= -->

<style>
  /* ===== Modal (PART2) ===== */
  .modalBack{
    position:fixed;
    inset:0;
    background:rgba(0,0,0,.55);
    z-index:200;
    display:none;
    align-items:flex-end;
    padding:12px 12px calc(12px + env(safe-area-inset-bottom)) 12px;
  }
  .modalBack.show{ display:flex; }

  .modalSheet{
    width:100%;
    background:var(--panel);
    border:1px solid var(--line);
    border-radius:18px;
    overflow:hidden;
    box-shadow: 0 18px 60px rgba(0,0,0,.55);
  }
  .modalHead{
    padding:12px 12px 10px 12px;
    border-bottom:1px solid var(--line);
    display:flex;
    align-items:center;
    gap:10px;
  }
  .modalTitle{
    font-weight:900;
    font-size:16px;
    letter-spacing:.2px;
  }
  .modalBody{ padding:12px; }
  .modalFoot{
    padding:12px;
    border-top:1px solid var(--line);
    display:flex;
    gap:10px;
  }
  .seg{
    display:flex;
    gap:8px;
    padding:8px;
    background:rgba(255,255,255,.03);
    border:1px solid var(--line);
    border-radius:14px;
  }
  .seg button{
    flex:1;
    padding:10px 10px;
    border-radius:12px;
    border:1px solid transparent;
    background:transparent;
    color:var(--muted);
    font-weight:900;
    cursor:pointer;
  }
  .seg button.on{
    background:rgba(76,195,255,.12);
    border-color: rgba(76,195,255,.45);
    color:var(--text);
  }

  .field{
    margin-top:12px;
    border:1px solid var(--line);
    background:rgba(255,255,255,.02);
    border-radius:14px;
    padding:10px;
  }
  .fieldLabel{
    font-size:12px;
    color:var(--muted);
    font-weight:900;
    margin-bottom:8px;
  }
  .stepper{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
  }
  .stepperBtn{
    width:52px;
    height:44px;
    border-radius:14px;
    border:1px solid var(--line);
    background:var(--panel2);
    color:var(--text);
    font-weight:1000;
    font-size:18px;
    cursor:pointer;
  }
  .stepperVal{
    flex:1;
    height:44px;
    border-radius:14px;
    border:1px solid var(--line);
    background:rgba(0,0,0,.12);
    display:flex;
    align-items:center;
    justify-content:center;
    font-weight:1000;
    font-size:18px;
    letter-spacing:.5px;
  }

  .noteSmall{
    margin-top:8px;
    font-size:12px;
    color:var(--muted);
    font-weight:700;
    line-height:1.5;
  }

  /* ===== Pages (PART2) ===== */
  .pageHead{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
    margin-bottom:10px;
  }
  .pageTitle{
    font-size:16px;
    font-weight:1000;
  }
  .card{
    border:1px solid var(--line);
    background:var(--panel);
    border-radius:16px;
    padding:12px;
  }
  .grid2{
    display:grid;
    grid-template-columns: 1fr 1fr;
    gap:10px;
  }
  .input{
    width:100%;
    padding:12px 12px;
    border-radius:14px;
    border:1px solid var(--line);
    background: rgba(0,0,0,.12);
    color:var(--text);
    font-size:14px;
    font-weight:800;
    outline:none;
  }
  .select{
    width:100%;
    padding:12px 12px;
    border-radius:14px;
    border:1px solid var(--line);
    background: rgba(0,0,0,.12);
    color:var(--text);
    font-size:14px;
    font-weight:900;
    outline:none;
  }
  .list{
    margin-top:10px;
    display:flex;
    flex-direction:column;
    gap:8px;
  }
  .listRow{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
    padding:10px;
    border:1px solid var(--line);
    border-radius:14px;
    background:rgba(255,255,255,.02);
  }
  .listLeft{
    display:flex;
    flex-direction:column;
    gap:2px;
    min-width:0;
  }
  .listId{
    font-weight:1000;
    font-size:15px;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
  }
  .listName{
    font-size:12px;
    color:var(--muted);
    font-weight:800;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
    min-height:14px;
  }
</style>

<!-- ===== PAGE: Seat Register ===== -->
<section class="page" id="page-seatRegister">
  <div class="pageHead">
    <div class="pageTitle">席登録</div>
    <button class="btn small" id="seatRegisterToMain">メイン</button>
  </div>

  <div class="card">
    <div class="fieldLabel">席を追加</div>

    <div class="grid2">
      <div>
        <div class="fieldLabel">席番号（例：A1 / 1 / カウンター1）</div>
        <input class="input" id="srSeatId" placeholder="例：A1" autocomplete="off" />
      </div>
      <div>
        <div class="fieldLabel">区分</div>
        <select class="select" id="srType">
          <option value="counter">カウンター</option>
          <option value="table">テーブル</option>
          <option value="room">個室</option>
          <option value="other">その他</option>
        </select>
      </div>
    </div>

    <div style="margin-top:10px;">
      <div class="fieldLabel">表示名（空でもOK）</div>
      <input class="input" id="srSeatName" placeholder="例：中庭テラスA1（その他など）" autocomplete="off" />
      <div class="noteSmall">
        ・「その他」の場合も、入力した名称をそのまま席カードに反映（固定で「その他」にはしない）<br>
        ・この画面は現場で迷わないためにシンプルにしている
      </div>
    </div>

    <div class="row" style="margin-top:12px; justify-content:flex-end;">
      <button class="btn primary" id="srAdd">追加</button>
    </div>
  </div>

  <div class="sectionTitle" style="margin-top:12px;">登録済みの席</div>
  <div class="list" id="srList"></div>

  <div class="hint">
    ・未会計の注文がない席は削除できる（本ロジックはPART3以降で注文が入ってから厳密化）<br>
    ・今は「UI仕様書に合わせて動く」を最優先
  </div>
</section>

<!-- ===== Modal: Arrive / Reserve ===== -->
<div class="modalBack" id="modalBack">
  <div class="modalSheet" role="dialog" aria-modal="true">
    <div class="modalHead">
      <div class="modalTitle" id="modalTitle">来店 / 予約</div>
      <div class="spacer"></div>
      <button class="btn small" id="modalClose">閉じる</button>
    </div>

    <div class="modalBody">
      <div class="seg" id="modeSeg">
        <button id="modeArrive" class="on" type="button">来店</button>
        <button id="modeReserve" type="button">予約</button>
      </div>

      <div class="field">
        <div class="fieldLabel">対象の席</div>
        <div class="mono" id="modalSeats" style="font-weight:1000;"></div>
        <div class="noteSmall">※ 電子レシートには席番号・人数は記載しない（内部保持のみ）</div>
      </div>

      <div class="field">
        <div class="fieldLabel">人数（キーボードは出さない）</div>
        <div class="stepper">
          <button class="stepperBtn" id="pLeft" type="button">◀︎</button>
          <button class="stepperBtn" id="pDown" type="button">▼</button>
          <div class="stepperVal" id="peopleVal">1</div>
          <button class="stepperBtn" id="pUp" type="button">▲</button>
          <button class="stepperBtn" id="pRight" type="button">▶︎</button>
        </div>
        <div class="noteSmall">最小1名（必要なら後で変更）</div>
      </div>
    </div>

    <div class="modalFoot">
      <button class="btn" id="modalCancel" type="button">キャンセル</button>
      <button class="btn primary" id="modalOk" type="button">決定</button>
    </div>
  </div>
</div>

<script>
  /* =========================
    Navigation / Modal / Seat Register (PART2)
  ========================= */

  // ===== Page system: override PART1 placeholder =====
  const PAGES = {
    main: "page-main",
    seatRegister: "page-seatRegister",
    // order / kitchen / backup / settings / todaySales etc はPART3以降で追加
  };

  function showPage(name){
    const id = PAGES[name];
    const pages = document.querySelectorAll(".page");
    pages.forEach(p=> p.classList.remove("active"));
    if(id && document.getElementById(id)){
      document.getElementById(id).classList.add("active");
      state.page = name;
      saveState();
      // ページごとの描画
      if(name === "main") renderMain();
      if(name === "seatRegister") renderSeatRegister();
      return;
    }
    // 未実装ページは崩さずアラートだけ
    alert("この画面は次のPARTで実装します：" + name);
    // 画面は今のまま
  }

  // PART1で定義済みの go を上書き
  window.go = (pageName)=> showPage(pageName);

  // ===== Scroll lock for modal =====
  function lockBg(lock){
    if(lock){
      document.body.style.overflow = "hidden";
      document.body.style.touchAction = "none";
    }else{
      document.body.style.overflow = "";
      document.body.style.touchAction = "";
    }
  }

  // ===== Modal state =====
  const modal = {
    open:false,
    mode:"arrive", // arrive | reserve
    seatIds:[],
    people:1
  };

  function openArriveReserveModal(seatIds){
    modal.open = true;
    modal.mode = "arrive";
    modal.seatIds = [...seatIds];
    modal.people = Math.max(1, modal.people || 1);

    document.getElementById("modeArrive").classList.add("on");
    document.getElementById("modeReserve").classList.remove("on");
    document.getElementById("modalSeats").textContent = modal.seatIds.join(" , ");
    document.getElementById("peopleVal").textContent = String(modal.people);

    document.getElementById("modalBack").classList.add("show");
    lockBg(true);
  }

  function closeModal(){
    modal.open = false;
    document.getElementById("modalBack").classList.remove("show");
    lockBg(false);
  }

  // mode toggle
  document.getElementById("modeArrive").onclick = ()=>{
    modal.mode="arrive";
    document.getElementById("modeArrive").classList.add("on");
    document.getElementById("modeReserve").classList.remove("on");
  };
  document.getElementById("modeReserve").onclick = ()=>{
    modal.mode="reserve";
    document.getElementById("modeReserve").classList.add("on");
    document.getElementById("modeArrive").classList.remove("on");
  };

  // close
  document.getElementById("modalClose").onclick = closeModal;
  document.getElementById("modalCancel").onclick = closeModal;

  // people stepper (no keyboard)
  function setPeople(n){
    modal.people = Math.max(1, Math.min(99, n));
    document.getElementById("peopleVal").textContent = String(modal.people);
  }
  document.getElementById("pDown").onclick = ()=> setPeople(modal.people - 1);
  document.getElementById("pUp").onclick = ()=> setPeople(modal.people + 1);
  document.getElementById("pLeft").onclick = ()=> setPeople(modal.people - 1);
  document.getElementById("pRight").onclick = ()=> setPeople(modal.people + 1);

  // OK: apply arrive/reserve
  document.getElementById("modalOk").onclick = ()=>{
    const now = Date.now();
    const mode = modal.mode;
    for(const id of modal.seatIds){
      const seat = state.seats.find(s=> s.id === id);
      if(!seat) continue;
      seat.people = modal.people;
      seat.since = now;
      seat.status = (mode === "reserve") ? "reserved" : "seated";
      // total は注文で増える（PART3以降）
      seat.total = Number(seat.total||0);
    }
    // 決定したら選択解除
    state.selectedSeatIds = [];
    saveState();
    updateSelectedInfo();
    renderMain();
    closeModal();

    // 次の行動：注文へ（PART3で実装）
    // 今は迷わせず、未実装アラートだけ
    showPage("order");
  };

  // ===== Decide button (Main) =====
  function handleDecide(){
    const ids = [...state.selectedSeatIds];
    if(ids.length === 0){
      alert("席を選択してください");
      return;
    }

    const seats = ids.map(id=> state.seats.find(s=> s.id===id)).filter(Boolean);
    if(seats.length === 0){
      alert("席が見つかりません");
      return;
    }

    // 全部空席なら → 来店/予約
    const allEmpty = seats.every(s=> (s.status||"empty")==="empty");
    if(allEmpty){
      openArriveReserveModal(ids);
      return;
    }

    // それ以外（着席/予約が混ざる等）は、注文へ（PART3で整える）
    showPage("order");
  }

  // PART1で仮置きされているonclickを上書き
  document.getElementById("btnDecide").onclick = handleDecide;

  // ===== Seat Register navigation =====
  document.getElementById("goSeatRegister").onclick = ()=> showPage("seatRegister");
  document.getElementById("seatRegisterToMain").onclick = ()=> showPage("main");

  // Top buttons（未実装ページへ）
  document.getElementById("goKitchen").onclick = ()=> showPage("kitchen");
  document.getElementById("goBackup").onclick = ()=> showPage("backup");
  document.getElementById("btnTodaySales").onclick = ()=> showPage("todaySales");
  document.getElementById("btnSettings").onclick = ()=> showPage("settings");

  // ===== Seat Register logic =====
  function normalizeSeatId(s){
    return String(s||"").trim();
  }
  function normalizeSeatName(s){
    return String(s||"").trim();
  }

  function renderSeatRegister(){
    const box = document.getElementById("srList");
    if(!box) return;
    box.innerHTML = "";

    const seats = [...state.seats].sort((a,b)=> seatSortKey(a.id).localeCompare(seatSortKey(b.id)));
    for(const seat of seats){
      const row = document.createElement("div");
      row.className = "listRow";

      const left = document.createElement("div");
      left.className = "listLeft";

      const id = document.createElement("div");
      id.className = "listId";
      id.textContent = seat.id || "(未設定)";

      const nm = document.createElement("div");
      nm.className = "listName";
      nm.textContent = (seat.name && String(seat.name).trim()) ? seat.name : "";

      left.appendChild(id);
      left.appendChild(nm);

      const right = document.createElement("div");
      right.className = "row";

      const del = document.createElement("button");
      del.className = "btn small";
      del.textContent = "削除";
      del.onclick = ()=>{
        // 注文が無ければ即削除（本厳密化はPART3以降）
        // 今は total が 0 なら削除OKとする
        if(Number(seat.total||0) !== 0){
          alert("未会計の金額があるため削除できません（PART3以降で注文判定を厳密化）");
          return;
        }
        state.seats = state.seats.filter(s=> s.id !== seat.id);
        // 選択からも外す
        state.selectedSeatIds = state.selectedSeatIds.filter(x=> x !== seat.id);
        saveState();
        updateSelectedInfo();
        renderSeatRegister();
        renderMain();
      };

      right.appendChild(del);

      row.appendChild(left);
      row.appendChild(right);
      box.appendChild(row);
    }
  }

  document.getElementById("srAdd").onclick = ()=>{
    const id = normalizeSeatId(document.getElementById("srSeatId").value);
    const type = document.getElementById("srType").value;
    const name = normalizeSeatName(document.getElementById("srSeatName").value);

    if(!id){
      alert("席番号を入力してください");
      return;
    }
    const exists = state.seats.some(s=> String(s.id).trim() === id);
    if(exists){
      alert("同じ席番号が既にあります");
      return;
    }

    // typeは今は保持だけ（見た目反映は必要になったら）
    state.seats.push({
      id,
      name,
      type,
      status:"empty",
      since:null,
      total:0,
      people:0
    });

    document.getElementById("srSeatId").value = "";
    document.getElementById("srSeatName").value = "";
    document.getElementById("srSeatId").focus();

    saveState();
    renderSeatRegister();
    renderMain();
  };

  // ===== Bottom bar placeholder override (PART2 scope) =====
  document.getElementById("btnSeatMove").onclick = ()=> alert("PART2/後続：席移動は次の実装で追加（長押し移動もここで）");
  document.getElementById("btnMergeTotal").onclick = ()=> alert("PART4：合計合算");
  document.getElementById("btnSplitTotal").onclick = ()=> alert("PART4：合計分割");

  // ===== Init (PART2) =====
  // どのページを開くか（復元）
  if(state.page && PAGES[state.page]) showPage(state.page);
  else showPage("main");
</script>

<!-- =========================
  ここから先は PART3 で続く
========================= -->
<!-- =========================
  ONE レジアプリ（無料版）完全フル：PART3
  役割：注文ページ / メニュー登録（手入力の土台） / 注文→席合計反映
========================= -->

<style>
  /* ===== Order (PART3) ===== */
  .pill{
    display:inline-flex;
    align-items:center;
    gap:8px;
    padding:6px 10px;
    border-radius:999px;
    border:1px solid var(--line);
    background:rgba(255,255,255,.03);
    font-weight:1000;
    font-size:12px;
    color:var(--text);
    white-space:nowrap;
  }
  .pill.muted{ color:var(--muted); font-weight:900; }

  .menuGrid{
    display:grid;
    grid-template-columns: 1fr;
    gap:10px;
  }
  .menuCard{
    border:1px solid var(--line);
    background:var(--panel);
    border-radius:16px;
    padding:12px;
    display:flex;
    gap:10px;
    align-items:center;
    justify-content:space-between;
  }
  .menuLeft{
    min-width:0;
    display:flex;
    flex-direction:column;
    gap:4px;
  }
  .menuName{
    font-weight:1000;
    font-size:15px;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
  }
  .menuMeta{
    display:flex;
    gap:8px;
    align-items:center;
    flex-wrap:wrap;
    color:var(--muted);
    font-weight:900;
    font-size:12px;
  }
  .menuPrice{
    font-weight:1100;
    font-size:15px;
    white-space:nowrap;
  }

  .qtyBox{
    display:flex;
    align-items:center;
    gap:8px;
  }
  .qtyBtn{
    width:44px;
    height:40px;
    border-radius:14px;
    border:1px solid var(--line);
    background:var(--panel2);
    color:var(--text);
    font-weight:1100;
    font-size:18px;
    cursor:pointer;
  }
  .qtyVal{
    width:46px;
    height:40px;
    border-radius:14px;
    border:1px solid var(--line);
    background:rgba(0,0,0,.12);
    display:flex;
    align-items:center;
    justify-content:center;
    font-weight:1100;
  }

  .orderList{
    display:flex;
    flex-direction:column;
    gap:8px;
    margin-top:10px;
  }
  .orderRow{
    border:1px solid var(--line);
    background:rgba(255,255,255,.02);
    border-radius:16px;
    padding:10px;
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
  }
  .orderRow .left{
    min-width:0;
    display:flex;
    flex-direction:column;
    gap:2px;
  }
  .orderRow .t1{
    font-weight:1000;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
  }
  .orderRow .t2{
    font-size:12px;
    color:var(--muted);
    font-weight:900;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
  }

  .divider{
    height:1px;
    background:var(--line);
    margin:12px 0;
    opacity:.7;
  }
</style>

<!-- ===== PAGE: Order ===== -->
<section class="page" id="page-order">
  <div class="pageHead">
    <div class="pageTitle">注文</div>
    <button class="btn small" id="orderToMain">メイン</button>
  </div>

  <div class="row" style="flex-wrap:wrap; gap:8px;">
    <div class="pill muted">対象</div>
    <div class="pill" id="orderTargetPill">（未選択）</div>
    <div class="spacer"></div>
    <button class="btn small ghost" id="goMenuRegister">メニュー登録</button>
  </div>

  <div class="divider"></div>

  <div class="sectionTitle">メニュー（タップで追加）</div>
  <div class="menuGrid" id="menuGrid"></div>

  <div class="divider"></div>

  <div class="row" style="justify-content:space-between; gap:10px;">
    <div class="sectionTitle" style="margin:0;">現在の注文</div>
    <div class="pill" id="orderSumPill">¥0</div>
  </div>
  <div class="orderList" id="orderList"></div>

  <div class="hint">
    ・注文すると席カードの合計¥が更新される（無料版の動く見本として重要）<br>
    ・会計確定やキッチン送信は後続PARTで仕上げる
  </div>
</section>

<!-- ===== PAGE: Menu Register (manual base) ===== -->
<section class="page" id="page-menuRegister">
  <div class="pageHead">
    <div class="pageTitle">メニュー登録（手入力）</div>
    <button class="btn small" id="menuRegisterToMain">メイン</button>
  </div>

  <div class="card">
    <div class="fieldLabel">追加</div>

    <div style="margin-top:8px;">
      <div class="fieldLabel">ジャンル</div>
      <input class="input" id="mrGenre" placeholder="例：ドリンク / 焼き物 / 揚げ物" autocomplete="off" />
    </div>

    <div style="margin-top:10px;">
      <div class="fieldLabel">商品名</div>
      <input class="input" id="mrName" placeholder="例：生ビール" autocomplete="off" />
    </div>

    <div class="grid2" style="margin-top:10px;">
      <div>
        <div class="fieldLabel">価格</div>
        <input class="input" id="mrPrice" inputmode="numeric" placeholder="例：700" />
      </div>
      <div>
        <div class="fieldLabel">税率（8 or 10）</div>
        <input class="input" id="mrTax" inputmode="numeric" placeholder="10" />
      </div>
    </div>

    <div class="row" style="margin-top:12px; justify-content:flex-end;">
      <button class="btn primary" id="mrAdd">追加</button>
    </div>

    <div class="noteSmall">
      ・写真読み取り登録（カメラマーク）は後続PARTで実装する（仕様は確定済み）<br>
      ・無料版は「人が確認して登録する」を優先
    </div>
  </div>

  <div class="sectionTitle" style="margin-top:12px;">登録済みメニュー</div>
  <div class="list" id="mrList"></div>
</section>

<script>
  /* =========================
    Order / Menu (PART3)
  ========================= */

  // ===== Extend pages map =====
  PAGES.order = "page-order";
  PAGES.menuRegister = "page-menuRegister";

  // ===== Extend state safely =====
  if(!Array.isArray(state.menu)) state.menu = [];
  if(!Array.isArray(state.orders)) state.orders = [];
  if(!Array.isArray(state.activeSeatIds)) state.activeSeatIds = [];

  // save/load拡張（既存関数を上書きせず、保存物に不足があっても壊れない）
  const _saveState = saveState;
  window.saveState = function(){
    try{
      localStorage.setItem(STORAGE_KEY, JSON.stringify({
        seats: state.seats,
        selectedSeatIds: state.selectedSeatIds,
        page: state.page,
        menu: state.menu,
        orders: state.orders,
        activeSeatIds: state.activeSeatIds
      }));
    }catch(e){
      console.warn("saveState(part3) failed:", e);
    }
  };

  const _loadState = loadState;
  window.loadState = function(){
    try{
      const raw = localStorage.getItem(STORAGE_KEY);
      if(!raw) return;
      const data = JSON.parse(raw);
      if(data && typeof data === "object"){
        if(Array.isArray(data.seats)) state.seats = data.seats;
        if(Array.isArray(data.selectedSeatIds)) state.selectedSeatIds = data.selectedSeatIds;
        if(typeof data.page === "string") state.page = data.page;
        if(Array.isArray(data.menu)) state.menu = data.menu;
        if(Array.isArray(data.orders)) state.orders = data.orders;
        if(Array.isArray(data.activeSeatIds)) state.activeSeatIds = data.activeSeatIds;
      }
    }catch(e){
      console.warn("loadState(part3) failed:", e);
    }
  };

  // ===== Seed menu if empty =====
  function seedMenuIfNeeded(){
    if(state.menu.length > 0) return;
    state.menu = [
      { id:"m1", genre:"ドリンク", name:"生ビール", price:700, tax:10 },
      { id:"m2", genre:"焼き物", name:"焼き鳥", price:200, tax:10 },
      { id:"m3", genre:"揚げ物", name:"唐揚げ", price:580, tax:10 },
      { id:"m4", genre:"お通し", name:"枝豆", price:350, tax:10 },
    ];
  }

  function nextId(prefix){
    return prefix + "_" + Math.random().toString(36).slice(2,9);
  }

  // ===== Active seats resolution =====
  function resolveActiveSeatsForOrder(){
    // 優先：選択中（メインで決定押した直後）
    if(Array.isArray(state.selectedSeatIds) && state.selectedSeatIds.length > 0){
      state.activeSeatIds = [...state.selectedSeatIds];
      // 注文に入ったら選択解除（迷い防止）
      state.selectedSeatIds = [];
      updateSelectedInfo();
      saveState();
      return;
    }
    // 次：モーダルで使った席（PART2の modal はグローバルに残る）
    if(typeof modal === "object" && Array.isArray(modal.seatIds) && modal.seatIds.length > 0){
      state.activeSeatIds = [...modal.seatIds];
      saveState();
      return;
    }
    // 最後：直近activeがあればそれ
    if(Array.isArray(state.activeSeatIds) && state.activeSeatIds.length > 0) return;

    // それも無いならメインへ戻す
    alert("対象の席がありません。メインで席を選んで「決定」してください。");
    showPage("main");
  }

  function getActiveSeats(){
    const ids = (state.activeSeatIds||[]).filter(Boolean);
    return ids.map(id=> state.seats.find(s=> s.id===id)).filter(Boolean);
  }

  // ===== Orders / Totals =====
  function recalcSeatTotals(){
    // 席の合計は「未会計注文の合計」という扱いにする（PART4で会計確定へ）
    const sumBySeat = {};
    for(const o of state.orders){
      if(!o || !o.seatId) continue;
      const line = Number(o.price||0) * Number(o.qty||0);
      sumBySeat[o.seatId] = (sumBySeat[o.seatId]||0) + line;
    }
    for(const s of state.seats){
      s.total = Number(sumBySeat[s.id]||0);
    }
  }

  function addOrder(menuItem){
    const seats = getActiveSeats();
    if(seats.length === 0){
      alert("対象席がありません");
      return;
    }
    const now = Date.now();

    for(const seat of seats){
      state.orders.push({
        id: nextId("o"),
        seatId: seat.id,
        menuId: menuItem.id,
        name: menuItem.name,
        genre: menuItem.genre,
        price: Number(menuItem.price||0),
        tax: Number(menuItem.tax||10),
        qty: 1,
        ts: now
      });
    }

    recalcSeatTotals();
    saveState();
    renderMain();
    renderOrder();
  }

  function changeQty(orderId, delta){
    const o = state.orders.find(x=> x.id===orderId);
    if(!o) return;
    o.qty = Math.max(1, Math.min(99, Number(o.qty||1) + delta));
    recalcSeatTotals();
    saveState();
    renderMain();
    renderOrder();
  }

  function removeOrder(orderId){
    state.orders = state.orders.filter(x=> x.id !== orderId);
    recalcSeatTotals();
    saveState();
    renderMain();
    renderOrder();
  }

  // ===== Render: Order =====
  function renderOrder(){
    resolveActiveSeatsForOrder();
    seedMenuIfNeeded();

    const seats = getActiveSeats();
    const idsText = seats.map(s=> s.id).join(" , ");
    document.getElementById("orderTargetPill").textContent = idsText || "（未選択）";

    // menu list
    const menuGrid = document.getElementById("menuGrid");
    menuGrid.innerHTML = "";

    const menu = [...state.menu].sort((a,b)=>{
      const ga = String(a.genre||"");
      const gb = String(b.genre||"");
      if(ga !== gb) return ga.localeCompare(gb);
      return String(a.name||"").localeCompare(String(b.name||""));
    });

    for(const m of menu){
      const card = document.createElement("div");
      card.className = "menuCard";
      card.onclick = ()=> addOrder(m);

      const left = document.createElement("div");
      left.className = "menuLeft";

      const name = document.createElement("div");
      name.className = "menuName";
      name.textContent = m.name || "(名称未設定)";

      const meta = document.createElement("div");
      meta.className = "menuMeta";
      meta.innerHTML = `<span class="badge">${(m.genre||"未分類")}</span><span>${m.tax||10}%</span>`;

      left.appendChild(name);
      left.appendChild(meta);

      const right = document.createElement("div");
      right.className = "menuPrice";
      right.textContent = `¥${fmtYen(m.price||0)}`;

      card.appendChild(left);
      card.appendChild(right);

      menuGrid.appendChild(card);
    }

    // order list (active seats only)
    const activeSet = new Set((state.activeSeatIds||[]));
    const list = state.orders.filter(o=> activeSet.has(o.seatId));

    const orderList = document.getElementById("orderList");
    orderList.innerHTML = "";

    let sum = 0;
    for(const o of list){
      const line = Number(o.price||0) * Number(o.qty||0);
      sum += line;

      const row = document.createElement("div");
      row.className = "orderRow";

      const left = document.createElement("div");
      left.className = "left";

      const t1 = document.createElement("div");
      t1.className = "t1";
      t1.textContent = `${o.name} ×${o.qty}`;

      const t2 = document.createElement("div");
      t2.className = "t2";
      t2.textContent = `${o.seatId} / ${(o.genre||"未分類")} / ${o.tax||10}% / ¥${fmtYen(o.price||0)}`;

      left.appendChild(t1);
      left.appendChild(t2);

      const right = document.createElement("div");
      right.className = "qtyBox";

      const minus = document.createElement("button");
      minus.className = "qtyBtn";
      minus.textContent = "−";
      minus.onclick = (e)=>{ e.stopPropagation(); changeQty(o.id, -1); };

      const val = document.createElement("div");
      val.className = "qtyVal";
      val.textContent = String(o.qty||1);

      const plus = document.createElement("button");
      plus.className = "qtyBtn";
      plus.textContent = "＋";
      plus.onclick = (e)=>{ e.stopPropagation(); changeQty(o.id, +1); };

      const del = document.createElement("button");
      del.className = "btn small";
      del.textContent = "削除";
      del.onclick = (e)=>{ e.stopPropagation(); removeOrder(o.id); };

      right.appendChild(minus);
      right.appendChild(val);
      right.appendChild(plus);
      right.appendChild(del);

      row.appendChild(left);
      row.appendChild(right);

      orderList.appendChild(row);
    }

    document.getElementById("orderSumPill").textContent = `¥${fmtYen(sum)}`;
  }

  // ===== Render: Menu Register =====
  function renderMenuRegister(){
    const box = document.getElementById("mrList");
    box.innerHTML = "";

    const menu = [...state.menu].sort((a,b)=>{
      const ga = String(a.genre||"");
      const gb = String(b.genre||"");
      if(ga !== gb) return ga.localeCompare(gb);
      return String(a.name||"").localeCompare(String(b.name||""));
    });

    for(const m of menu){
      const row = document.createElement("div");
      row.className = "listRow";

      const left = document.createElement("div");
      left.className = "listLeft";

      const id = document.createElement("div");
      id.className = "listId";
      id.textContent = `${m.name}（¥${fmtYen(m.price||0)} / ${m.tax||10}%）`;

      const nm = document.createElement("div");
      nm.className = "listName";
      nm.textContent = `${m.genre||"未分類"} / id:${m.id}`;

      left.appendChild(id);
      left.appendChild(nm);

      const right = document.createElement("div");
      right.className = "row";

      const del = document.createElement("button");
      del.className = "btn small";
      del.textContent = "削除";
      del.onclick = ()=>{
        // メニュー削除：既存注文がある場合は残す（無料版は迷い防止で単純化）
        const used = state.orders.some(o=> o.menuId === m.id);
        if(used){
          alert("このメニューは注文に使われているため削除できません（後続PARTで拡張可）");
          return;
        }
        state.menu = state.menu.filter(x=> x.id !== m.id);
        saveState();
        renderMenuRegister();
        renderOrder();
      };

      right.appendChild(del);

      row.appendChild(left);
      row.appendChild(right);

      box.appendChild(row);
    }
  }

  // ===== Navigation buttons =====
  document.getElementById("orderToMain").onclick = ()=> showPage("main");
  document.getElementById("menuRegisterToMain").onclick = ()=> showPage("main");
  document.getElementById("goMenuRegister").onclick = ()=> showPage("menuRegister");

  // seat register page already has its own main button

  // ===== Add menu item =====
  document.getElementById("mrAdd").onclick = ()=>{
    const genre = String(document.getElementById("mrGenre").value||"").trim();
    const name  = String(document.getElementById("mrName").value||"").trim();
    const price = Number(String(document.getElementById("mrPrice").value||"").trim());
    const tax   = Number(String(document.getElementById("mrTax").value||"").trim() || "10");

    if(!name){
      alert("商品名を入力してください");
      return;
    }
    if(!Number.isFinite(price) || price <= 0){
      alert("価格を正しく入力してください");
      return;
    }
    if(!(tax===8 || tax===10)){
      alert("税率は 8 または 10 を入力してください");
      return;
    }

    state.menu.push({
      id: nextId("m"),
      genre: genre || "未分類",
      name,
      price,
      tax
    });

    document.getElementById("mrName").value = "";
    document.getElementById("mrPrice").value = "";
    document.getElementById("mrTax").value = "10";
    saveState();
    renderMenuRegister();
    renderOrder();
  };

  // ===== Enhance showPage hook (order/menu render) =====
  const _showPage = showPage;
  window.showPage = function(name){
    _showPage(name);
    if(name === "order") renderOrder();
    if(name === "menuRegister") renderMenuRegister();
  };

  // ===== Bottom bar: order / others =====
  // いまは「決定」はメイン専用にする（注文中は迷わせない）
  document.getElementById("btnDecide").onclick = ()=>{
    alert("注文中です。メインに戻って席を選び、決定してください。");
  };

  // ===== Init (PART3) =====
  loadState();
  seedMenuIfNeeded();
  recalcSeatTotals();
  saveState();
  renderMain();

  // もし現在ページがorder系なら描画
  if(state.page === "order") renderOrder();
  if(state.page === "menuRegister") renderMenuRegister();
</script>

<!-- =========================
  ここから先は PART4 で続く
========================= -->
<!-- =========================
  ONE レジアプリ（無料版）完全フル：PART4
  役割：会計ページ / 支払い方法（現金・カード・QR） / 合計合算・合計分割 / 会計確定
========================= -->

<style>
  /* ===== Checkout (PART4) ===== */
  .payRow{
    display:flex;
    gap:10px;
    align-items:center;
    justify-content:space-between;
    margin-top:10px;
  }
  .payBtn{
    flex:1;
    padding:12px 10px;
    border-radius:14px;
    border:1px solid var(--line);
    background:var(--panel2);
    color:var(--muted);
    font-weight:1100;
    cursor:pointer;
    user-select:none;
    -webkit-tap-highlight-color: transparent;
  }
  .payBtn.on{
    color:var(--text);
    border-color: rgba(76,195,255,.65);
    box-shadow: 0 0 0 1px rgba(76,195,255,.16) inset;
    background: rgba(76,195,255,.08);
  }

  .bigTotal{
    margin-top:10px;
    padding:14px;
    border-radius:16px;
    border:1px solid var(--line);
    background: rgba(255,255,255,.02);
    display:flex;
    align-items:flex-end;
    justify-content:space-between;
    gap:10px;
  }
  .bigTotal .label{
    color:var(--muted);
    font-weight:900;
    font-size:12px;
  }
  .bigTotal .val{
    font-weight:1200;
    font-size:24px;
    letter-spacing:.5px;
  }

  .miniList{
    margin-top:10px;
    display:flex;
    flex-direction:column;
    gap:8px;
  }
  .miniRow{
    border:1px solid var(--line);
    background: rgba(255,255,255,.02);
    border-radius:16px;
    padding:10px;
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
  }
  .miniRow .l{
    min-width:0;
    display:flex;
    flex-direction:column;
    gap:2px;
  }
  .miniRow .t1{
    font-weight:1000;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
  }
  .miniRow .t2{
    font-size:12px;
    color:var(--muted);
    font-weight:900;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
  }
</style>

<!-- ===== PAGE: Checkout ===== -->
<section class="page" id="page-checkout">
  <div class="pageHead">
    <div class="pageTitle">会計</div>
    <button class="btn small" id="checkoutToMain">メイン</button>
  </div>

  <div class="row" style="flex-wrap:wrap; gap:8px;">
    <div class="pill muted">対象</div>
    <div class="pill" id="checkoutTargetPill">（未選択）</div>
    <div class="pill muted" id="checkoutGroupPill" style="display:none;">合算</div>
  </div>

  <div class="bigTotal">
    <div>
      <div class="label">お会計</div>
      <div class="label" id="checkoutNote">（支払い方法を選択）</div>
    </div>
    <div class="val" id="checkoutTotalVal">¥0</div>
  </div>

  <div class="sectionTitle">支払い方法</div>
  <div class="payRow">
    <button class="payBtn on" id="payCash" type="button">現金</button>
    <button class="payBtn" id="payCard" type="button">カード</button>
    <button class="payBtn" id="payQR" type="button">QR</button>
  </div>

  <div class="sectionTitle" style="margin-top:12px;">明細（未会計）</div>
  <div class="miniList" id="checkoutList"></div>

  <div class="row" style="margin-top:12px; justify-content:flex-end;">
    <button class="btn danger" id="btnCheckoutFix" type="button">会計確定</button>
  </div>

  <div class="hint">
    ・会計確定で「未会計注文」を売上へ移動し、席は空席に戻る<br>
    ・合算後に追加された注文がある場合、分割はできない（仕様どおり）
  </div>
</section>

<script>
  /* =========================
    Checkout / Merge / Split (PART4)
  ========================= */

  // ===== Extend pages map =====
  PAGES.checkout = "page-checkout";

  // ===== Extend state =====
  if(!Array.isArray(state.sales)) state.sales = [];
  if(!Array.isArray(state.billGroups)) state.billGroups = [];
  if(!state.checkout) state.checkout = { payMethod:"cash" };

  // save/load さらに拡張（PART3の上書きsave/loadがあるので、そこを安全に上書き）
  window.saveState = function(){
    try{
      localStorage.setItem(STORAGE_KEY, JSON.stringify({
        seats: state.seats,
        selectedSeatIds: state.selectedSeatIds,
        page: state.page,
        menu: state.menu,
        orders: state.orders,
        activeSeatIds: state.activeSeatIds,
        sales: state.sales,
        billGroups: state.billGroups,
        checkout: state.checkout
      }));
    }catch(e){
      console.warn("saveState(part4) failed:", e);
    }
  };

  window.loadState = function(){
    try{
      const raw = localStorage.getItem(STORAGE_KEY);
      if(!raw) return;
      const data = JSON.parse(raw);
      if(data && typeof data === "object"){
        if(Array.isArray(data.seats)) state.seats = data.seats;
        if(Array.isArray(data.selectedSeatIds)) state.selectedSeatIds = data.selectedSeatIds;
        if(typeof data.page === "string") state.page = data.page;
        if(Array.isArray(data.menu)) state.menu = data.menu;
        if(Array.isArray(data.orders)) state.orders = data.orders;
        if(Array.isArray(data.activeSeatIds)) state.activeSeatIds = data.activeSeatIds;

        if(Array.isArray(data.sales)) state.sales = data.sales;
        if(Array.isArray(data.billGroups)) state.billGroups = data.billGroups;
        if(data.checkout && typeof data.checkout === "object") state.checkout = data.checkout;
      }
    }catch(e){
      console.warn("loadState(part4) failed:", e);
    }
  };

  function nowTs(){ return Date.now(); }
  function newId(prefix){ return prefix + "_" + Math.random().toString(36).slice(2,9); }

  // ===== Helper: find group by seat =====
  function findGroupBySeatId(seatId){
    return state.billGroups.find(g=> Array.isArray(g.seatIds) && g.seatIds.includes(seatId));
  }
  function findGroupById(groupId){
    return state.billGroups.find(g=> g.id === groupId);
  }

  // ===== Merge / Split rules =====
  function mergeSelectedSeats(){
    const ids = [...(state.selectedSeatIds||[])].filter(Boolean);
    if(ids.length < 2){
      alert("合計合算は2席以上を選択してください");
      return;
    }

    // すでにグループに入っている席が混ざってたら禁止（事故防止）
    const hasGroup = ids.some(id=> !!findGroupBySeatId(id));
    if(hasGroup){
      alert("すでに合算中の席が含まれています（分割してから合算してください）");
      return;
    }

    const mergedAt = nowTs();
    const groupId = newId("g");

    // 合算：現時点の未会計注文に groupId を付与
    for(const o of state.orders){
      if(ids.includes(o.seatId)){
        o.billGroupId = groupId;
      }
    }

    state.billGroups.push({
      id: groupId,
      seatIds: ids,
      mergedAt
    });

    // 合算の対象を active に固定
    state.activeSeatIds = ids;
    state.selectedSeatIds = [];
    updateSelectedInfo();

    // 合計更新
    recalcSeatTotals();
    saveState();
    renderMain();

    alert("合計合算しました");
  }

  function canSplitGroup(group){
    // 仕様：合算後に追加された注文は分割できない
    // → group.mergedAt より後に作成された、groupIdの注文が1つでもあれば分割NG
    const bad = state.orders.some(o => o.billGroupId === group.id && Number(o.ts||0) > Number(group.mergedAt||0));
    return !bad;
  }

  function splitSelectedSeatGroup(){
    const ids = [...(state.selectedSeatIds||[])].filter(Boolean);
    if(ids.length === 0){
      alert("分割したい席（合算中の席）を選択してください");
      return;
    }

    // 同一グループのみ対応（事故防止）
    const groups = ids.map(id=> findGroupBySeatId(id)).filter(Boolean);
    if(groups.length === 0){
      alert("この席は合算されていません");
      return;
    }
    const g0 = groups[0];
    const same = groups.every(g=> g.id === g0.id);
    if(!same){
      alert("別々の合算グループが混ざっています（1グループずつ分割してください）");
      return;
    }

    if(!canSplitGroup(g0)){
      alert("合算後に追加された注文があるため、分割できません（仕様）");
      return;
    }

    // 分割：groupId を外す（注文は元の seatId に残る）
    for(const o of state.orders){
      if(o.billGroupId === g0.id){
        delete o.billGroupId;
      }
    }

    // グループ削除
    state.billGroups = state.billGroups.filter(g=> g.id !== g0.id);

    // activeを戻す（選択中の席だけ残す、でも迷い防止で選択解除）
    state.activeSeatIds = [];
    state.selectedSeatIds = [];
    updateSelectedInfo();

    recalcSeatTotals();
    saveState();
    renderMain();

    alert("合計分割しました");
  }

  // ===== Checkout targeting =====
  function resolveCheckoutTargets(){
    // 1) activeSeatIds があればそれ
    let ids = (state.activeSeatIds||[]).filter(Boolean);

    // 2) 無ければ selectedSeatIds
    if(ids.length === 0) ids = (state.selectedSeatIds||[]).filter(Boolean);

    // 3) それも無いならダメ
    if(ids.length === 0){
      alert("対象の席がありません。メインで席を選択してください。");
      showPage("main");
      return [];
    }

    // 4) seated/reserved以外は除外（空席会計事故防止）
    const seats = ids.map(id=> state.seats.find(s=> s.id===id)).filter(Boolean);
    const okSeats = seats.filter(s=> (s.status==="seated" || s.status==="reserved"));
    if(okSeats.length === 0){
      alert("会計できる席がありません");
      showPage("main");
      return [];
    }

    // 合算グループがあれば、そのグループの席を採用（迷い防止）
    const g = findGroupBySeatId(okSeats[0].id);
    if(g){
      ids = [...g.seatIds];
      state.activeSeatIds = ids;
    }else{
      state.activeSeatIds = okSeats.map(s=> s.id);
    }

    // 選択は解除（会計中の迷い防止）
    state.selectedSeatIds = [];
    updateSelectedInfo();

    saveState();
    return state.activeSeatIds;
  }

  function checkoutOrdersForTargetSeatIds(seatIds){
    const set = new Set(seatIds);
    // 合算中なら groupId の注文のみを集める（同一グループを想定）
    const g = findGroupBySeatId(seatIds[0]);
    if(g){
      return state.orders.filter(o=> o.billGroupId === g.id);
    }
    // 通常：対象席の注文
    return state.orders.filter(o=> set.has(o.seatId) && !o.billGroupId);
  }

  function sumOrders(list){
    let sum = 0;
    for(const o of list){
      sum += Number(o.price||0) * Number(o.qty||0);
    }
    return sum;
  }

  // ===== Render Checkout =====
  function renderCheckout(){
    const ids = resolveCheckoutTargets();
    if(ids.length === 0) return;

    const seatsText = ids.join(" , ");
    document.getElementById("checkoutTargetPill").textContent = seatsText;

    const g = findGroupBySeatId(ids[0]);
    const gp = document.getElementById("checkoutGroupPill");
    if(g){
      gp.style.display = "";
      gp.textContent = "合算";
    }else{
      gp.style.display = "none";
    }

    // payment method
    const method = state.checkout.payMethod || "cash";
    setPayMethod(method);

    // orders
    const list = checkoutOrdersForTargetSeatIds(ids);
    const total = sumOrders(list);

    document.getElementById("checkoutTotalVal").textContent = `¥${fmtYen(total)}`;
    document.getElementById("checkoutNote").textContent = (g ? "合算会計" : "席会計");

    const box = document.getElementById("checkoutList");
    box.innerHTML = "";

    if(list.length === 0){
      const row = document.createElement("div");
      row.className = "miniRow";
      row.innerHTML = `<div class="l"><div class="t1">未会計の注文がありません</div><div class="t2">注文を追加してください</div></div>`;
      box.appendChild(row);
      return;
    }

    // group by name/price/tax
    const map = new Map();
    for(const o of list){
      const key = `${o.name}__${o.price}__${o.tax}`;
      const cur = map.get(key) || { name:o.name, price:o.price, tax:o.tax, qty:0 };
      cur.qty += Number(o.qty||0);
      map.set(key, cur);
    }

    for(const item of map.values()){
      const row = document.createElement("div");
      row.className = "miniRow";

      const left = document.createElement("div");
      left.className = "l";

      const t1 = document.createElement("div");
      t1.className = "t1";
      t1.textContent = `${item.name} ×${item.qty}`;

      const t2 = document.createElement("div");
      t2.className = "t2";
      t2.textContent = `${item.tax||10}% / ¥${fmtYen(item.price||0)}`;

      left.appendChild(t1);
      left.appendChild(t2);

      const right = document.createElement("div");
      right.className = "t1";
      right.textContent = `¥${fmtYen(Number(item.price||0) * Number(item.qty||0))}`;

      row.appendChild(left);
      row.appendChild(right);
      box.appendChild(row);
    }
  }

  // ===== Payment method buttons =====
  function setPayMethod(m){
    state.checkout.payMethod = m;
    const cash = document.getElementById("payCash");
    const card = document.getElementById("payCard");
    const qr   = document.getElementById("payQR");
    [cash,card,qr].forEach(x=> x.classList.remove("on"));
    if(m==="cash") cash.classList.add("on");
    if(m==="card") card.classList.add("on");
    if(m==="qr")   qr.classList.add("on");
    saveState();
  }

  document.getElementById("payCash").onclick = ()=> setPayMethod("cash");
  document.getElementById("payCard").onclick = ()=> setPayMethod("card");
  document.getElementById("payQR").onclick   = ()=> setPayMethod("qr");

  // ===== Fix checkout (settle) =====
  function settleCheckout(){
    const ids = resolveCheckoutTargets();
    if(ids.length === 0) return;

    const list = checkoutOrdersForTargetSeatIds(ids);
    const total = sumOrders(list);

    if(total <= 0){
      alert("未会計の注文がありません");
      return;
    }

    const method = state.checkout.payMethod || "cash";
    const methodLabel = (method==="cash" ? "現金" : method==="card" ? "カード" : "QR");

    if(!confirm(`会計確定します。\n対象：${ids.join(" , ")}\n支払い：${methodLabel}\n合計：¥${fmtYen(total)}`)){
      return;
    }

    const ts = nowTs();
    const g = findGroupBySeatId(ids[0]);
    const saleId = newId("s");

    // 売上レコード（訂正はPART6で拡張）
    state.sales.push({
      id: saleId,
      ts,
      method,
      methodLabel,
      seatIds: ids,
      groupId: g ? g.id : null,
      total,
      items: list.map(o=> ({
        name:o.name, genre:o.genre, price:o.price, tax:o.tax, qty:o.qty
      }))
    });

    // 注文を消す（未会計→売上へ移動したため）
    if(g){
      state.orders = state.orders.filter(o=> o.billGroupId !== g.id);
      state.billGroups = state.billGroups.filter(x=> x.id !== g.id);
    }else{
      const set = new Set(ids);
      state.orders = state.orders.filter(o=> !(set.has(o.seatId) && !o.billGroupId));
    }

    // 席を空席に戻す
    for(const id of ids){
      const seat = state.seats.find(s=> s.id===id);
      if(!seat) continue;
      seat.status = "empty";
      seat.since = null;
      seat.people = 0;
      seat.total = 0;
      seat.name = seat.name || ""; // 名前は維持（席の表示名）
    }

    // active/selected クリア
    state.activeSeatIds = [];
    state.selectedSeatIds = [];
    updateSelectedInfo();

    // 合計更新
    recalcSeatTotals();
    saveState();
    renderMain();

    alert("会計確定しました");
    showPage("main");
  }

  document.getElementById("btnCheckoutFix").onclick = settleCheckout;
  document.getElementById("checkoutToMain").onclick = ()=> showPage("main");

  // ===== Bottom bar integration =====
  // 合計合算：メインで複数席選択→押す
  document.getElementById("btnMergeTotal").onclick = mergeSelectedSeats;
  // 合計分割：合算中の席を選択→押す
  document.getElementById("btnSplitTotal").onclick = splitSelectedSeatGroup;

  // ===== どこから会計へ行くか（迷い防止） =====
  // 1) 注文画面に「会計」ボタンを追加（既存HTMLを壊さずDOM追加）
  (function injectCheckoutButtonIntoOrder(){
    const orderPage = document.getElementById("page-order");
    if(!orderPage) return;
    const head = orderPage.querySelector(".pageHead");
    if(!head) return;

    // すでに入ってたら二重追加しない
    if(document.getElementById("goCheckout")) return;

    const btn = document.createElement("button");
    btn.id = "goCheckout";
    btn.className = "btn small primary";
    btn.textContent = "会計";
    btn.onclick = ()=> showPage("checkout");

    // ヘッダ右側（メインの横）に差し込む
    head.appendChild(btn);
  })();

  // 2) メイン画面で「着席/予約の席を選択→決定」を押した場合、
  //    PART2では注文へ行くが、会計へは注文画面からのみ（迷い防止）
  //    （ここは仕様どおり：UIの導線を一本化）

  // ===== showPage hook enhance =====
  const __showPage4 = window.showPage;
  window.showPage = function(name){
    __showPage4(name);
    if(name === "checkout") renderCheckout();
  };

  // ===== Init (PART4) =====
  loadState();
  recalcSeatTotals();
  saveState();
  renderMain();
  if(state.page === "checkout") renderCheckout();
</script>

<!-- =========================
  ここから先は PART5 で続く
========================= -->
<!-- =========================
  ONE レジアプリ（無料版）完全フル：PART5
  役割：売上（本日／月／年／管理）画面＋一覧表示
========================= -->

<style>
  /* ===== Sales (PART5) ===== */
  .tabs{
    display:flex;
    gap:8px;
    margin-top:10px;
  }
  .tabBtn{
    flex:1;
    padding:10px 10px;
    border-radius:14px;
    border:1px solid var(--line);
    background:var(--panel2);
    color:var(--muted);
    font-weight:1100;
    cursor:pointer;
  }
  .tabBtn.on{
    color:var(--text);
    border-color: rgba(76,195,255,.65);
    box-shadow: 0 0 0 1px rgba(76,195,255,.16) inset;
    background: rgba(76,195,255,.08);
  }

  .salesSum{
    margin-top:10px;
    padding:14px;
    border-radius:16px;
    border:1px solid var(--line);
    background: rgba(255,255,255,.02);
    display:flex;
    align-items:flex-end;
    justify-content:space-between;
    gap:10px;
  }
  .salesSum .label{
    color:var(--muted);
    font-weight:900;
    font-size:12px;
  }
  .salesSum .val{
    font-weight:1200;
    font-size:24px;
    letter-spacing:.5px;
  }

  .saleCard{
    border:1px solid var(--line);
    background:var(--panel);
    border-radius:16px;
    padding:12px;
  }
  .saleHead{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
    margin-bottom:8px;
  }
  .saleTime{
    font-weight:1100;
    font-size:14px;
    white-space:nowrap;
  }
  .saleMethod{
    font-size:12px;
    font-weight:1100;
    color:var(--muted);
    white-space:nowrap;
  }
  .saleTotal{
    font-weight:1200;
    font-size:18px;
    white-space:nowrap;
  }
  .saleSub{
    display:flex;
    gap:8px;
    flex-wrap:wrap;
    align-items:center;
    color:var(--muted);
    font-weight:900;
    font-size:12px;
  }
  .saleItems{
    margin-top:10px;
    display:flex;
    flex-direction:column;
    gap:6px;
  }
  .saleItemRow{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
    padding:8px 10px;
    border-radius:14px;
    border:1px solid var(--line);
    background: rgba(255,255,255,.02);
  }
  .saleItemRow .l{
    min-width:0;
    display:flex;
    flex-direction:column;
    gap:2px;
  }
  .saleItemRow .t1{
    font-weight:1000;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
  }
  .saleItemRow .t2{
    font-size:12px;
    color:var(--muted);
    font-weight:900;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
  }
</style>

<!-- ===== PAGE: Today Sales ===== -->
<section class="page" id="page-todaySales">
  <div class="pageHead">
    <div class="pageTitle">本日の売上</div>
    <button class="btn small" id="todaySalesToMain">メイン</button>
  </div>

  <div class="tabs">
    <button class="tabBtn on" id="tabToday" type="button">本日</button>
    <button class="tabBtn" id="tabMonth" type="button">月</button>
    <button class="tabBtn" id="tabYear" type="button">年</button>
    <button class="tabBtn" id="tabManage" type="button">管理</button>
  </div>

  <div class="salesSum">
    <div>
      <div class="label" id="todaySalesLabel">本日合計</div>
      <div class="label" id="todaySalesCount">0件</div>
    </div>
    <div class="val" id="todaySalesSumVal">¥0</div>
  </div>

  <div class="sectionTitle">伝票一覧</div>
  <div class="list" id="todaySalesList"></div>

  <div class="hint">
    ・売上は削除しない（訂正伝票方式はPART6で実装）<br>
    ・電子レシートには席番号・人数は記載しない（内部保持のみ）
  </div>
</section>

<!-- ===== PAGE: Month Sales ===== -->
<section class="page" id="page-monthSales">
  <div class="pageHead">
    <div class="pageTitle">月の売上</div>
    <button class="btn small" id="monthSalesToMain">メイン</button>
  </div>

  <div class="tabs">
    <button class="tabBtn" id="tabToday2" type="button">本日</button>
    <button class="tabBtn on" id="tabMonth2" type="button">月</button>
    <button class="tabBtn" id="tabYear2" type="button">年</button>
    <button class="tabBtn" id="tabManage2" type="button">管理</button>
  </div>

  <div class="salesSum">
    <div>
      <div class="label" id="monthSalesLabel">今月合計</div>
      <div class="label" id="monthSalesCount">0件</div>
    </div>
    <div class="val" id="monthSalesSumVal">¥0</div>
  </div>

  <div class="sectionTitle">伝票一覧</div>
  <div class="list" id="monthSalesList"></div>
</section>

<!-- ===== PAGE: Year Sales ===== -->
<section class="page" id="page-yearSales">
  <div class="pageHead">
    <div class="pageTitle">年の売上</div>
    <button class="btn small" id="yearSalesToMain">メイン</button>
  </div>

  <div class="tabs">
    <button class="tabBtn" id="tabToday3" type="button">本日</button>
    <button class="tabBtn" id="tabMonth3" type="button">月</button>
    <button class="tabBtn on" id="tabYear3" type="button">年</button>
    <button class="tabBtn" id="tabManage3" type="button">管理</button>
  </div>

  <div class="salesSum">
    <div>
      <div class="label" id="yearSalesLabel">今年合計</div>
      <div class="label" id="yearSalesCount">0件</div>
    </div>
    <div class="val" id="yearSalesSumVal">¥0</div>
  </div>

  <div class="sectionTitle">伝票一覧</div>
  <div class="list" id="yearSalesList"></div>
</section>

<!-- ===== PAGE: Sales Manage ===== -->
<section class="page" id="page-salesManage">
  <div class="pageHead">
    <div class="pageTitle">売上管理</div>
    <button class="btn small" id="salesManageToMain">メイン</button>
  </div>

  <div class="tabs">
    <button class="tabBtn" id="tabToday4" type="button">本日</button>
    <button class="tabBtn" id="tabMonth4" type="button">月</button>
    <button class="tabBtn" id="tabYear4" type="button">年</button>
    <button class="tabBtn on" id="tabManage4" type="button">管理</button>
  </div>

  <div class="card" style="margin-top:10px;">
    <div class="fieldLabel">この画面の役割</div>
    <div class="noteSmall">
      ・無料版は「見る」「バックアップする」までを想定<br>
      ・CSV出力・訂正伝票の詳細・保管期間ポリシーは後続PARTで整える
    </div>
  </div>

  <div class="card" style="margin-top:10px;">
    <div class="fieldLabel">現在の売上データ</div>
    <div class="row" style="justify-content:space-between;">
      <div class="badge">件数</div>
      <div class="mono" id="manageSalesCount" style="font-weight:1000;"></div>
    </div>
    <div class="row" style="justify-content:space-between; margin-top:8px;">
      <div class="badge">合計</div>
      <div class="mono" id="manageSalesSum" style="font-weight:1000;"></div>
    </div>
  </div>
</section>

<script>
  /* =========================
    Sales render (PART5)
  ========================= */

  // ===== Extend pages map =====
  PAGES.todaySales = "page-todaySales";
  PAGES.monthSales = "page-monthSales";
  PAGES.yearSales  = "page-yearSales";
  PAGES.salesManage= "page-salesManage";

  // ===== Helpers =====
  function dkey(ts){
    const d = new Date(ts);
    return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
  }
  function mkey(ts){
    const d = new Date(ts);
    return `${d.getFullYear()}-${pad2(d.getMonth()+1)}`;
  }
  function ykey(ts){
    const d = new Date(ts);
    return `${d.getFullYear()}`;
  }
  function fmtHM(ts){
    const d = new Date(ts);
    return `${pad2(d.getHours())}:${pad2(d.getMinutes())}`;
  }

  function sumSales(list){
    let s = 0;
    for(const x of list) s += Number(x.total||0);
    return s;
  }

  function makeSaleDom(sale){
    const card = document.createElement("div");
    card.className = "saleCard";

    const head = document.createElement("div");
    head.className = "saleHead";

    const left = document.createElement("div");
    left.style.display = "flex";
    left.style.flexDirection = "column";
    left.style.gap = "4px";

    const t = document.createElement("div");
    t.className = "saleTime";
    t.textContent = fmtHM(sale.ts);

    const m = document.createElement("div");
    m.className = "saleMethod";
    m.textContent = `${sale.methodLabel || ""}`;

    left.appendChild(t);
    left.appendChild(m);

    const total = document.createElement("div");
    total.className = "saleTotal";
    total.textContent = `¥${fmtYen(sale.total||0)}`;

    head.appendChild(left);
    head.appendChild(total);

    const sub = document.createElement("div");
    sub.className = "saleSub";
    const seatText = (Array.isArray(sale.seatIds) && sale.seatIds.length) ? sale.seatIds.join(" , ") : "";
    sub.innerHTML = `<span class="badge">伝票</span><span>${dkey(sale.ts)}</span><span>${seatText}</span>`;

    card.appendChild(head);
    card.appendChild(sub);

    // items
    if(Array.isArray(sale.items) && sale.items.length){
      const items = document.createElement("div");
      items.className = "saleItems";

      for(const it of sale.items){
        const row = document.createElement("div");
        row.className = "saleItemRow";

        const l = document.createElement("div");
        l.className = "l";

        const t1 = document.createElement("div");
        t1.className = "t1";
        t1.textContent = `${it.name} ×${it.qty}`;

        const t2 = document.createElement("div");
        t2.className = "t2";
        t2.textContent = `${it.tax||10}% / ¥${fmtYen(it.price||0)} / ${(it.genre||"")}`;

        l.appendChild(t1);
        l.appendChild(t2);

        const r = document.createElement("div");
        r.className = "t1";
        r.textContent = `¥${fmtYen(Number(it.price||0) * Number(it.qty||0))}`;

        row.appendChild(l);
        row.appendChild(r);
        items.appendChild(row);
      }

      card.appendChild(items);
    }

    return card;
  }

  function renderSalesCommon(listElId, list, countElId, sumElId){
    const listEl = document.getElementById(listElId);
    listEl.innerHTML = "";

    const sorted = [...list].sort((a,b)=> Number(b.ts||0) - Number(a.ts||0));
    for(const s of sorted){
      listEl.appendChild(makeSaleDom(s));
    }

    document.getElementById(countElId).textContent = `${sorted.length}件`;
    document.getElementById(sumElId).textContent = `¥${fmtYen(sumSales(sorted))}`;

    if(sorted.length === 0){
      const row = document.createElement("div");
      row.className = "listRow";
      row.innerHTML = `<div class="listLeft"><div class="listId">売上がありません</div><div class="listName">会計確定するとここに表示されます</div></div>`;
      listEl.appendChild(row);
    }
  }

  function renderTodaySales(){
    const today = dkey(Date.now());
    const list = (state.sales||[]).filter(s=> dkey(s.ts) === today);
    renderSalesCommon("todaySalesList", list, "todaySalesCount", "todaySalesSumVal");
  }

  function renderMonthSales(){
    const now = Date.now();
    const mk = mkey(now);
    const list = (state.sales||[]).filter(s=> mkey(s.ts) === mk);
    renderSalesCommon("monthSalesList", list, "monthSalesCount", "monthSalesSumVal");
  }

  function renderYearSales(){
    const now = Date.now();
    const yk = ykey(now);
    const list = (state.sales||[]).filter(s=> ykey(s.ts) === yk);
    renderSalesCommon("yearSalesList", list, "yearSalesCount", "yearSalesSumVal");
  }

  function renderSalesManage(){
    const all = (state.sales||[]);
    document.getElementById("manageSalesCount").textContent = `${all.length}件`;
    document.getElementById("manageSalesSum").textContent = `¥${fmtYen(sumSales(all))}`;
  }

  // ===== Tabs navigation =====
  function goToday(){ showPage("todaySales"); }
  function goMonth(){ showPage("monthSales"); }
  function goYear(){ showPage("yearSales"); }
  function goManage(){ showPage("salesManage"); }

  // tabs (page1)
  document.getElementById("tabToday").onclick = goToday;
  document.getElementById("tabMonth").onclick = goMonth;
  document.getElementById("tabYear").onclick = goYear;
  document.getElementById("tabManage").onclick = goManage;

  // tabs (page2)
  document.getElementById("tabToday2").onclick = goToday;
  document.getElementById("tabMonth2").onclick = goMonth;
  document.getElementById("tabYear2").onclick = goYear;
  document.getElementById("tabManage2").onclick = goManage;

  // tabs (page3)
  document.getElementById("tabToday3").onclick = goToday;
  document.getElementById("tabMonth3").onclick = goMonth;
  document.getElementById("tabYear3").onclick = goYear;
  document.getElementById("tabManage3").onclick = goManage;

  // tabs (page4)
  document.getElementById("tabToday4").onclick = goToday;
  document.getElementById("tabMonth4").onclick = goMonth;
  document.getElementById("tabYear4").onclick = goYear;
  document.getElementById("tabManage4").onclick = goManage;

  // back buttons
  document.getElementById("todaySalesToMain").onclick = ()=> showPage("main");
  document.getElementById("monthSalesToMain").onclick = ()=> showPage("main");
  document.getElementById("yearSalesToMain").onclick = ()=> showPage("main");
  document.getElementById("salesManageToMain").onclick = ()=> showPage("main");

  // ===== showPage hook enhance =====
  const __showPage5 = window.showPage;
  window.showPage = function(name){
    __showPage5(name);
    if(name === "todaySales") renderTodaySales();
    if(name === "monthSales") renderMonthSales();
    if(name === "yearSales") renderYearSales();
    if(name === "salesManage") renderSalesManage();
  };

  // Bottom bar: 本日の売上 → todaySales
  document.getElementById("btnTodaySales").onclick = ()=> showPage("todaySales");

  // ===== Init (PART5) =====
  loadState();
  saveState();
  // もし現在ページが売上系なら描画
  if(state.page === "todaySales") renderTodaySales();
  if(state.page === "monthSales") renderMonthSales();
  if(state.page === "yearSales") renderYearSales();
  if(state.page === "salesManage") renderSalesManage();
</script>

<!-- =========================
  ここから先は PART6 で続く
========================= -->
<!-- =========================
  ONE レジアプリ（無料版）完全フル：PART6
  役割：訂正伝票方式（削除しない）/ 訂正理由（定型＋自由）/ 売上表示の訂正対応
========================= -->

<style>
  /* ===== Correction Modal (PART6) ===== */
  .corrNote{
    margin-top:8px;
    font-size:12px;
    color:var(--muted);
    font-weight:800;
    line-height:1.55;
  }
  .radioRow{
    display:flex;
    gap:8px;
    margin-top:10px;
  }
  .radioBtn{
    flex:1;
    padding:10px 10px;
    border-radius:14px;
    border:1px solid var(--line);
    background:var(--panel2);
    color:var(--muted);
    font-weight:1100;
    cursor:pointer;
  }
  .radioBtn.on{
    color:var(--text);
    border-color: rgba(76,195,255,.65);
    box-shadow: 0 0 0 1px rgba(76,195,255,.16) inset;
    background: rgba(76,195,255,.08);
  }
  .dangerText{ color:var(--danger); font-weight:1100; }

  /* manage list button */
  .miniBtn{
    padding:8px 10px;
    border-radius:12px;
    border:1px solid var(--line);
    background:var(--panel2);
    color:var(--text);
    font-weight:1000;
    cursor:pointer;
    white-space:nowrap;
  }
  .miniBtn.danger{
    border-color: rgba(255,92,122,.55);
    box-shadow: 0 0 0 1px rgba(255,92,122,.12) inset;
  }
</style>

<!-- ===== Modal: Correction ===== -->
<div class="modalBack" id="corrBack">
  <div class="modalSheet" role="dialog" aria-modal="true">
    <div class="modalHead">
      <div class="modalTitle">訂正（訂正伝票方式）</div>
      <div class="spacer"></div>
      <button class="btn small" id="corrClose">閉じる</button>
    </div>

    <div class="modalBody">
      <div class="field">
        <div class="fieldLabel">対象伝票</div>
        <div class="mono" id="corrTargetInfo" style="font-weight:1000;"></div>
        <div class="corrNote">
          ・売上は削除しない<br>
          ・訂正は「訂正伝票」を追加する（元伝票は残る）
        </div>
      </div>

      <div class="field">
        <div class="fieldLabel">訂正タイプ</div>
        <div class="radioRow">
          <button class="radioBtn on" id="corrTypeCancel" type="button">全取消（マイナス）</button>
          <button class="radioBtn" id="corrTypeDiff" type="button">差額入力</button>
        </div>
        <div class="corrNote">
          ・全取消：元伝票の金額をそのままマイナスで打ち消す<br>
          ・差額：増減だけを入力（例：-200 / +150）
        </div>
      </div>

      <div class="field" id="corrDiffBox" style="display:none;">
        <div class="fieldLabel">差額（円）</div>
        <input class="input" id="corrDiffAmount" inputmode="numeric" placeholder="例：-200" />
        <div class="corrNote">※ マイナスで返金、プラスで追加請求</div>
      </div>

      <div class="field">
        <div class="fieldLabel">訂正理由（定型）</div>
        <select class="select" id="corrReasonPreset">
          <option value="入力ミス">入力ミス</option>
          <option value="数量違い">数量違い</option>
          <option value="品切れ">品切れ</option>
          <option value="値引き">値引き</option>
          <option value="返金">返金</option>
          <option value="その他">その他</option>
        </select>

        <div style="margin-top:10px;">
          <div class="fieldLabel">理由（自由入力）</div>
          <input class="input" id="corrReasonText" placeholder="例：焼き鳥 1本キャンセル" autocomplete="off" />
        </div>
      </div>

      <div class="field">
        <div class="fieldLabel">注意</div>
        <div class="corrNote">
          <span class="dangerText">・この操作は取り消せない</span>（さらに訂正伝票で上書きする方式）<br>
          ・電子レシートには席番号・人数は記載しない（内部保持のみ）
        </div>
      </div>
    </div>

    <div class="modalFoot">
      <button class="btn" id="corrCancel" type="button">キャンセル</button>
      <button class="btn danger" id="corrOk" type="button">訂正伝票を追加</button>
    </div>
  </div>
</div>

<script>
  /* =========================
    Correction slip (PART6)
  ========================= */

  // ===== Correction modal state =====
  const corr = {
    open:false,
    type:"cancel", // cancel | diff
    saleId:null
  };

  function openCorrectionModal(saleId){
    const sale = (state.sales||[]).find(s=> s.id === saleId);
    if(!sale){
      alert("伝票が見つかりません");
      return;
    }
    corr.open = true;
    corr.saleId = saleId;
    corr.type = "cancel";

    // UI init
    document.getElementById("corrTypeCancel").classList.add("on");
    document.getElementById("corrTypeDiff").classList.remove("on");
    document.getElementById("corrDiffBox").style.display = "none";
    document.getElementById("corrDiffAmount").value = "";

    document.getElementById("corrReasonPreset").value = "入力ミス";
    document.getElementById("corrReasonText").value = "";

    const when = `${dkey(sale.ts)} ${pad2(new Date(sale.ts).getHours())}:${pad2(new Date(sale.ts).getMinutes())}`;
    const seats = Array.isArray(sale.seatIds) ? sale.seatIds.join(" , ") : "";
    document.getElementById("corrTargetInfo").textContent = `${when} / ${sale.methodLabel||""} / ¥${fmtYen(sale.total||0)} / ${seats}`;

    document.getElementById("corrBack").classList.add("show");
    // PART2の lockBg が使える前提
    if(typeof lockBg === "function") lockBg(true);
  }

  function closeCorrectionModal(){
    corr.open = false;
    corr.saleId = null;
    document.getElementById("corrBack").classList.remove("show");
    if(typeof lockBg === "function") lockBg(false);
  }

  document.getElementById("corrClose").onclick = closeCorrectionModal;
  document.getElementById("corrCancel").onclick = closeCorrectionModal;

  document.getElementById("corrTypeCancel").onclick = ()=>{
    corr.type = "cancel";
    document.getElementById("corrTypeCancel").classList.add("on");
    document.getElementById("corrTypeDiff").classList.remove("on");
    document.getElementById("corrDiffBox").style.display = "none";
  };
  document.getElementById("corrTypeDiff").onclick = ()=>{
    corr.type = "diff";
    document.getElementById("corrTypeDiff").classList.add("on");
    document.getElementById("corrTypeCancel").classList.remove("on");
    document.getElementById("corrDiffBox").style.display = "";
  };

  function makeCorrectionSale(original, deltaTotal, reasonPreset, reasonText){
    const ts = Date.now();
    const id = "c_" + Math.random().toString(36).slice(2,9);

    // items：cancelなら元をマイナス、diffなら明細は「差額調整」1行にする
    let items = [];
    if(corr.type === "cancel"){
      const src = Array.isArray(original.items) ? original.items : [];
      items = src.map(it=> ({
        name: it.name,
        genre: it.genre,
        price: it.price,
        tax: it.tax,
        qty: -Math.abs(Number(it.qty||0) || 0) // マイナス数量
      }));
    }else{
      items = [{
        name: "差額調整",
        genre: "訂正",
        price: Math.abs(Number(deltaTotal||0)),
        tax: 10,
        qty: (Number(deltaTotal||0) >= 0) ? 1 : -1
      }];
    }

    return {
      id,
      ts,
      method: original.method,
      methodLabel: original.methodLabel,
      seatIds: original.seatIds,
      groupId: original.groupId || null,
      total: Number(deltaTotal||0),
      items,
      // 訂正情報
      isCorrection: true,
      originalSaleId: original.id,
      reasonPreset: reasonPreset || "",
      reasonText: reasonText || ""
    };
  }

  document.getElementById("corrOk").onclick = ()=>{
    const original = (state.sales||[]).find(s=> s.id === corr.saleId);
    if(!original){
      alert("元伝票が見つかりません");
      return;
    }

    const reasonPreset = document.getElementById("corrReasonPreset").value || "";
    const reasonText = String(document.getElementById("corrReasonText").value||"").trim();

    let delta = 0;
    if(corr.type === "cancel"){
      delta = -Math.abs(Number(original.total||0));
    }else{
      const raw = String(document.getElementById("corrDiffAmount").value||"").trim();
      const n = Number(raw);
      if(!Number.isFinite(n) || n === 0){
        alert("差額を正しく入力してください（例：-200 / +150）");
        return;
      }
      delta = n;
    }

    const labelType = (corr.type === "cancel") ? "全取消（マイナス）" : "差額入力";
    if(!confirm(`訂正伝票を追加します。\nタイプ：${labelType}\n金額：¥${fmtYen(delta)}\n理由：${reasonPreset}${reasonText ? " / " + reasonText : ""}`)){
      return;
    }

    const corrSale = makeCorrectionSale(original, delta, reasonPreset, reasonText);
    state.sales.push(corrSale);

    saveState();
    closeCorrectionModal();

    // 売上画面を即更新
    if(typeof renderTodaySales === "function") renderTodaySales();
    if(typeof renderMonthSales === "function") renderMonthSales();
    if(typeof renderYearSales === "function") renderYearSales();
    if(typeof renderSalesManage === "function") renderSalesManage();

    alert("訂正伝票を追加しました");
  };

  /* ===== 売上表示を「訂正伝票対応」に上書き（PART5の描画がそのまま使えるように） ===== */

  // PART5の makeSaleDom を上書き（同名関数で更新）
  window.makeSaleDom = function(sale){
    const card = document.createElement("div");
    card.className = "saleCard";

    const head = document.createElement("div");
    head.className = "saleHead";

    const left = document.createElement("div");
    left.style.display = "flex";
    left.style.flexDirection = "column";
    left.style.gap = "4px";

    const t = document.createElement("div");
    t.className = "saleTime";
    t.textContent = `${pad2(new Date(sale.ts).getHours())}:${pad2(new Date(sale.ts).getMinutes())}`;

    const m = document.createElement("div");
    m.className = "saleMethod";
    m.textContent = `${sale.methodLabel || ""}`;

    left.appendChild(t);
    left.appendChild(m);

    const total = document.createElement("div");
    total.className = "saleTotal";
    const num = Number(sale.total||0);
    total.textContent = `${num < 0 ? "−" : ""}¥${fmtYen(Math.abs(num))}`;

    head.appendChild(left);
    head.appendChild(total);

    const sub = document.createElement("div");
    sub.className = "saleSub";

    const seatText = (Array.isArray(sale.seatIds) && sale.seatIds.length) ? sale.seatIds.join(" , ") : "";
    const badge = sale.isCorrection ? "訂正" : "伝票";
    const reason = sale.isCorrection ? `${sale.reasonPreset || ""}${sale.reasonText ? " / " + sale.reasonText : ""}` : "";

    sub.innerHTML = `<span class="badge ${sale.isCorrection ? "danger" : ""}">${badge}</span>
                     <span>${dkey(sale.ts)}</span>
                     <span>${seatText}</span>
                     ${reason ? `<span class="badge">${reason}</span>` : ""}`;

    card.appendChild(head);
    card.appendChild(sub);

    // items
    if(Array.isArray(sale.items) && sale.items.length){
      const items = document.createElement("div");
      items.className = "saleItems";

      for(const it of sale.items){
        const row = document.createElement("div");
        row.className = "saleItemRow";

        const l = document.createElement("div");
        l.className = "l";

        const qty = Number(it.qty||0);
        const t1 = document.createElement("div");
        t1.className = "t1";
        t1.textContent = `${it.name} ×${qty}`;

        const t2 = document.createElement("div");
        t2.className = "t2";
        t2.textContent = `${it.tax||10}% / ¥${fmtYen(it.price||0)} / ${(it.genre||"")}`;

        l.appendChild(t1);
        l.appendChild(t2);

        const r = document.createElement("div");
        r.className = "t1";
        const line = Number(it.price||0) * Number(it.qty||0);
        r.textContent = `${line < 0 ? "−" : ""}¥${fmtYen(Math.abs(line))}`;

        row.appendChild(l);
        row.appendChild(r);
        items.appendChild(row);
      }

      card.appendChild(items);
    }

    return card;
  };

  // PART5の renderSalesManage を上書きして「訂正」ボタンを出す
  window.renderSalesManage = function(){
    const all = (state.sales||[]);
    document.getElementById("manageSalesCount").textContent = `${all.length}件`;
    document.getElementById("manageSalesSum").textContent = `¥${fmtYen(all.reduce((a,s)=> a + Number(s.total||0), 0))}`;

    // 管理画面に「訂正」一覧を置く（既存DOMを壊さず下に追加）
    let area = document.getElementById("manageCorrArea");
    if(!area){
      area = document.createElement("div");
      area.id = "manageCorrArea";
      area.style.marginTop = "12px";
      const page = document.getElementById("page-salesManage");
      page.appendChild(area);
    }

    area.innerHTML = "";
    const title = document.createElement("div");
    title.className = "sectionTitle";
    title.textContent = "伝票（訂正を追加）";
    area.appendChild(title);

    const box = document.createElement("div");
    box.className = "list";
    area.appendChild(box);

    const sorted = [...all].sort((a,b)=> Number(b.ts||0) - Number(a.ts||0));
    for(const s of sorted){
      const row = document.createElement("div");
      row.className = "listRow";

      const left = document.createElement("div");
      left.className = "listLeft";

      const when = `${dkey(s.ts)} ${pad2(new Date(s.ts).getHours())}:${pad2(new Date(s.ts).getMinutes())}`;
      const line1 = document.createElement("div");
      line1.className = "listId";
      const num = Number(s.total||0);
      line1.textContent = `${s.isCorrection ? "【訂正】" : ""}${when} / ¥${fmtYen(num)}`;

      const line2 = document.createElement("div");
      line2.className = "listName";
      const seats = Array.isArray(s.seatIds) ? s.seatIds.join(" , ") : "";
      line2.textContent = `${s.methodLabel||""} / ${seats}${s.isCorrection ? ` / 元:${s.originalSaleId}` : ""}`;

      left.appendChild(line1);
      left.appendChild(line2);

      const right = document.createElement("div");
      right.className = "row";

      const btn = document.createElement("button");
      btn.className = "miniBtn danger";
      btn.textContent = "訂正";
      btn.onclick = ()=>{
        // 訂正伝票に対してさらに訂正を重ねるのは可能だが、
        // 迷い防止のため「元伝票（通常伝票）にだけ」訂正を付ける運用にする
        if(s.isCorrection){
          alert("訂正伝票に対する訂正は、さらに訂正伝票を追加する方式で可能です。\nただし迷い防止のため、まずは元伝票を訂正してください。");
          return;
        }
        openCorrectionModal(s.id);
      };

      right.appendChild(btn);

      row.appendChild(left);
      row.appendChild(right);
      box.appendChild(row);
    }

    if(sorted.length === 0){
      const row = document.createElement("div");
      row.className = "listRow";
      row.innerHTML = `<div class="listLeft"><div class="listId">売上がありません</div><div class="listName">会計確定すると管理できるようになります</div></div>`;
      box.appendChild(row);
    }
  };

  // showPageフック：売上管理に入ったら訂正ボタン付きで描画
  const __showPage6 = window.showPage;
  window.showPage = function(name){
    __showPage6(name);
    if(name === "salesManage" && typeof renderSalesManage === "function") renderSalesManage();
    if(name === "todaySales" && typeof renderTodaySales === "function") renderTodaySales();
    if(name === "monthSales" && typeof renderMonthSales === "function") renderMonthSales();
    if(name === "yearSales" && typeof renderYearSales === "function") renderYearSales();
  };

  // init
  loadState();
  saveState();
</script>

<!-- =========================
  ここから先は PART7 で続く
========================= -->
<!-- =========================
  ONE レジアプリ（無料版）完全フル：PART7
  役割：設定 / 店舗情報 / バックアップ / お問合せ / キッチン（仮）ページ
========================= -->

<style>
  /* ===== Settings / Info / Backup (PART7) ===== */
  .kv{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
    padding:10px;
    border:1px solid var(--line);
    border-radius:14px;
    background: rgba(255,255,255,.02);
  }
  .kv .k{
    color:var(--muted);
    font-weight:900;
    font-size:12px;
    white-space:nowrap;
  }
  .kv .v{
    font-weight:1000;
    text-align:right;
    min-width:0;
    overflow:hidden;
    text-overflow:ellipsis;
    white-space:nowrap;
  }

  .dangerBox{
    border:1px solid rgba(255,92,122,.45);
    background: rgba(255,92,122,.06);
    border-radius:16px;
    padding:12px;
  }

  .btnWide{
    width:100%;
    padding:12px 12px;
    border-radius:14px;
    border:1px solid var(--line);
    background: var(--panel2);
    color:var(--text);
    font-weight:1100;
    cursor:pointer;
  }
  .btnWide.primary{
    border-color: rgba(76,195,255,.65);
    box-shadow: 0 0 0 1px rgba(76,195,255,.16) inset;
    background: rgba(76,195,255,.08);
  }
  .btnWide.danger{
    border-color: rgba(255,92,122,.55);
    box-shadow: 0 0 0 1px rgba(255,92,122,.12) inset;
    background: rgba(255,92,122,.06);
  }

  .textarea{
    width:100%;
    min-height:140px;
    border-radius:14px;
    border:1px solid var(--line);
    background: rgba(0,0,0,.12);
    color:var(--text);
    padding:12px;
    font-size:12px;
    font-weight:800;
    line-height:1.55;
    outline:none;
  }

  .linkBtn{
    width:100%;
    text-decoration:none;
    display:block;
    text-align:center;
    padding:12px 12px;
    border-radius:14px;
    border:1px solid var(--line);
    background: var(--panel2);
    color:var(--text);
    font-weight:1100;
  }
</style>

<!-- ===== PAGE: Settings ===== -->
<section class="page" id="page-settings">
  <div class="pageHead">
    <div class="pageTitle">設定</div>
    <button class="btn small" id="settingsToMain">メイン</button>
  </div>

  <div class="card">
    <div class="fieldLabel">アプリ方針（確定）</div>
    <div class="noteSmall">
      ・提供済データの保持期間：<b>当日のみ</b><br>
      ・自動再試行中の表示：<b>表示しない（静か）</b><br>
      ・売上は削除しない：<b>訂正伝票方式</b><br>
      ・電子レシート：席番号・人数は<b>記載しない</b>（内部保持のみ）
    </div>
  </div>

  <div class="card" style="margin-top:10px;">
    <div class="fieldLabel">ナビ</div>
    <div class="row" style="margin-top:6px;">
      <button class="btnWide primary" id="goStoreInfo" type="button">店舗情報</button>
    </div>
    <div class="row" style="margin-top:8px;">
      <button class="btnWide" id="goContact" type="button">お問合せ</button>
    </div>
    <div class="row" style="margin-top:8px;">
      <button class="btnWide" id="goBackup2" type="button">バックアップ</button>
    </div>
  </div>

  <div class="dangerBox" style="margin-top:10px;">
    <div class="fieldLabel">危険操作</div>
    <div class="noteSmall">
      ・リセットは取り消せません<br>
      ・不安なら先にバックアップしてください
    </div>
    <div class="row" style="margin-top:10px;">
      <button class="btnWide danger" id="btnResetAll" type="button">全データをリセット</button>
    </div>
  </div>
</section>

<!-- ===== PAGE: Store Info ===== -->
<section class="page" id="page-storeInfo">
  <div class="pageHead">
    <div class="pageTitle">店舗情報</div>
    <button class="btn small" id="storeInfoToMain">メイン</button>
  </div>

  <div class="card">
    <div class="fieldLabel">基本情報</div>

    <div style="margin-top:8px;">
      <div class="fieldLabel">店舗名</div>
      <input class="input" id="siName" placeholder="例：居酒屋 ONE" autocomplete="off" />
    </div>

    <div style="margin-top:10px;">
      <div class="fieldLabel">電話</div>
      <input class="input" id="siTel" inputmode="tel" placeholder="例：090-xxxx-xxxx" autocomplete="off" />
    </div>

    <div style="margin-top:10px;">
      <div class="fieldLabel">メール（連絡用）</div>
      <input class="input" id="siEmail" inputmode="email" placeholder="例：example@domain.com" autocomplete="off" />
    </div>

    <div style="margin-top:10px;">
      <div class="fieldLabel">住所（任意）</div>
      <input class="input" id="siAddr" placeholder="例：広島市…" autocomplete="off" />
    </div>

    <div class="row" style="margin-top:12px; justify-content:flex-end;">
      <button class="btn primary" id="siSave" type="button">保存</button>
    </div>
  </div>

  <div class="card" style="margin-top:10px;">
    <div class="fieldLabel">確認</div>
    <div class="list" id="siPreview"></div>
  </div>
</section>

<!-- ===== PAGE: Backup ===== -->
<section class="page" id="page-backup">
  <div class="pageHead">
    <div class="pageTitle">バックアップ</div>
    <button class="btn small" id="backupToMain">メイン</button>
  </div>

  <div class="card">
    <div class="fieldLabel">書き出し（JSON）</div>
    <div class="noteSmall">
      ・端末外に保存することで、故障・機種変更に備える<br>
      ・この無料版は「まず守る」を優先
    </div>
    <div class="row" style="margin-top:10px;">
      <button class="btnWide primary" id="btnExportJson" type="button">JSONを書き出す（ダウンロード）</button>
    </div>

    <div style="margin-top:10px;">
      <div class="fieldLabel">内容（コピー用）</div>
      <textarea class="textarea" id="backupText" readonly></textarea>
      <div class="row" style="margin-top:8px;">
        <button class="btnWide" id="btnCopyBackup" type="button">コピー</button>
      </div>
    </div>
  </div>

  <div class="card" style="margin-top:10px;">
    <div class="fieldLabel">読み込み（JSON）</div>
    <div class="noteSmall">
      ・ファイルを選択して復元する<br>
      ・不正なJSONは読み込み拒否する
    </div>
    <div class="row" style="margin-top:10px;">
      <input type="file" id="importFile" accept="application/json,.json" class="input" />
    </div>
    <div class="row" style="margin-top:10px;">
      <button class="btnWide danger" id="btnImportJson" type="button">このJSONで上書き復元</button>
    </div>
  </div>
</section>

<!-- ===== PAGE: Contact ===== -->
<section class="page" id="page-contact">
  <div class="pageHead">
    <div class="pageTitle">お問合せ</div>
    <button class="btn small" id="contactToMain">メイン</button>
  </div>

  <div class="card">
    <div class="fieldLabel">連絡先</div>
    <div class="noteSmall">
      ・ここは運用上の「逃げ道」<br>
      ・無料版はまず問い合わせ導線だけ用意（中身はあとで差し替えOK）
    </div>

    <div class="row" style="margin-top:10px;">
      <a class="linkBtn" id="contactMailLink" href="mailto:" role="button">メールで問い合わせ（設定でメールを入れる）</a>
    </div>

    <div class="row" style="margin-top:10px;">
      <a class="linkBtn" id="contactLineLink" href="#" role="button">LINEで問い合わせ（後で設定）</a>
    </div>
  </div>

  <div class="card" style="margin-top:10px;">
    <div class="fieldLabel">現在の店舗情報</div>
    <div class="list" id="contactPreview"></div>
  </div>
</section>

<!-- ===== PAGE: Kitchen (placeholder) ===== -->
<section class="page" id="page-kitchen">
  <div class="pageHead">
    <div class="pageTitle">キッチン</div>
    <button class="btn small" id="kitchenToMain">ホール</button>
  </div>

  <div class="card">
    <div class="fieldLabel">この画面は後続PARTで仕上げる</div>
    <div class="noteSmall">
      ・今は「戻れる」「迷わない」導線を先に固める<br>
      ・注文のキッチン表示は必要になった順で実装する
    </div>
  </div>
</section>

<script>
  /* =========================
    Settings / StoreInfo / Backup / Contact / Kitchen (PART7)
  ========================= */

  // ===== Extend pages map =====
  PAGES.settings  = "page-settings";
  PAGES.storeInfo = "page-storeInfo";
  PAGES.backup    = "page-backup";
  PAGES.contact   = "page-contact";
  PAGES.kitchen   = "page-kitchen";

  // ===== Extend state =====
  if(!state.store) state.store = { name:"", tel:"", email:"", addr:"", lineUrl:"" };

  // save/load をさらに拡張（既存フィールド全部維持）
  window.saveState = function(){
    try{
      localStorage.setItem(STORAGE_KEY, JSON.stringify({
        seats: state.seats,
        selectedSeatIds: state.selectedSeatIds,
        page: state.page,
        menu: state.menu,
        orders: state.orders,
        activeSeatIds: state.activeSeatIds,
        sales: state.sales,
        billGroups: state.billGroups,
        checkout: state.checkout,
        store: state.store
      }));
    }catch(e){
      console.warn("saveState(part7) failed:", e);
    }
  };

  window.loadState = function(){
    try{
      const raw = localStorage.getItem(STORAGE_KEY);
      if(!raw) return;
      const data = JSON.parse(raw);
      if(data && typeof data === "object"){
        if(Array.isArray(data.seats)) state.seats = data.seats;
        if(Array.isArray(data.selectedSeatIds)) state.selectedSeatIds = data.selectedSeatIds;
        if(typeof data.page === "string") state.page = data.page;
        if(Array.isArray(data.menu)) state.menu = data.menu;
        if(Array.isArray(data.orders)) state.orders = data.orders;
        if(Array.isArray(data.activeSeatIds)) state.activeSeatIds = data.activeSeatIds;
        if(Array.isArray(data.sales)) state.sales = data.sales;
        if(Array.isArray(data.billGroups)) state.billGroups = data.billGroups;
        if(data.checkout && typeof data.checkout === "object") state.checkout = data.checkout;
        if(data.store && typeof data.store === "object") state.store = data.store;
      }
    }catch(e){
      console.warn("loadState(part7) failed:", e);
    }
  };

  // ===== Render helpers =====
  function renderStoreInfoPreview(){
    const box = document.getElementById("siPreview");
    if(!box) return;
    box.innerHTML = "";

    const s = state.store || {};
    const rows = [
      ["店舗名", s.name || ""],
      ["電話", s.tel || ""],
      ["メール", s.email || ""],
      ["住所", s.addr || ""],
    ];

    for(const [k,v] of rows){
      const row = document.createElement("div");
      row.className = "kv";
      row.innerHTML = `<div class="k">${k}</div><div class="v">${(v||"")}</div>`;
      box.appendChild(row);
    }
  }

  function renderContactPreview(){
    const box = document.getElementById("contactPreview");
    if(!box) return;
    box.innerHTML = "";

    const s = state.store || {};
    const rows = [
      ["店舗名", s.name || ""],
      ["電話", s.tel || ""],
      ["メール", s.email || ""],
    ];

    for(const [k,v] of rows){
      const row = document.createElement("div");
      row.className = "kv";
      row.innerHTML = `<div class="k">${k}</div><div class="v">${(v||"")}</div>`;
      box.appendChild(row);
    }

    // link更新
    const mail = document.getElementById("contactMailLink");
    if(mail){
      const addr = (s.email||"").trim();
      mail.href = addr ? `mailto:${addr}` : "mailto:";
      mail.textContent = addr ? "メールで問い合わせ" : "メールで問い合わせ（設定でメールを入れる）";
    }
    const line = document.getElementById("contactLineLink");
    if(line){
      const url = (s.lineUrl||"").trim();
      line.href = url || "#";
      line.textContent = url ? "LINEで問い合わせ" : "LINEで問い合わせ（後で設定）";
      line.onclick = (e)=>{
        if(!url){
          e.preventDefault();
          alert("LINEのURLは後で設定します（無料版は導線だけ先に用意）");
        }
      };
    }
  }

  function renderBackupText(){
    const ta = document.getElementById("backupText");
    if(!ta) return;
    try{
      const raw = localStorage.getItem(STORAGE_KEY) || "";
      ta.value = raw;
    }catch(e){
      ta.value = "";
    }
  }

  // ===== Navigation wiring =====
  document.getElementById("settingsToMain").onclick = ()=> showPage("main");
  document.getElementById("storeInfoToMain").onclick = ()=> showPage("main");
  document.getElementById("backupToMain").onclick = ()=> showPage("main");
  document.getElementById("contactToMain").onclick = ()=> showPage("main");
  document.getElementById("kitchenToMain").onclick = ()=> showPage("main");

  // existing buttons -> real pages
  document.getElementById("btnSettings").onclick = ()=> showPage("settings");
  document.getElementById("goBackup").onclick = ()=> showPage("backup");
  document.getElementById("goBackup2").onclick = ()=> showPage("backup");
  document.getElementById("goKitchen").onclick = ()=> showPage("kitchen");

  document.getElementById("goStoreInfo").onclick = ()=> showPage("storeInfo");
  document.getElementById("goContact").onclick = ()=> showPage("contact");

  // ===== Store info save =====
  document.getElementById("siSave").onclick = ()=>{
    const s = state.store || {};
    s.name  = String(document.getElementById("siName").value||"").trim();
    s.tel   = String(document.getElementById("siTel").value||"").trim();
    s.email = String(document.getElementById("siEmail").value||"").trim();
    s.addr  = String(document.getElementById("siAddr").value||"").trim();
    state.store = s;
    saveState();
    renderStoreInfoPreview();
    alert("保存しました");
  };

  // ===== Backup export/import =====
  function downloadText(filename, text){
    const blob = new Blob([text], {type:"application/json"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  document.getElementById("btnExportJson").onclick = ()=>{
    const raw = localStorage.getItem(STORAGE_KEY) || "";
    const stamp = new Date();
    const fn = `ONE_backup_${stamp.getFullYear()}${pad2(stamp.getMonth()+1)}${pad2(stamp.getDate())}_${pad2(stamp.getHours())}${pad2(stamp.getMinutes())}.json`;
    downloadText(fn, raw);
    renderBackupText();
    alert("JSONを書き出しました");
  };

  document.getElementById("btnCopyBackup").onclick = async ()=>{
    const ta = document.getElementById("backupText");
    const txt = ta.value || "";
    try{
      await navigator.clipboard.writeText(txt);
      alert("コピーしました");
    }catch(e){
      // iOSで失敗する場合があるのでフォールバック
      ta.focus();
      ta.select();
      document.execCommand("copy");
      alert("コピーしました（互換モード）");
    }
  };

  function isValidBackupJson(obj){
    // 最低限の構造確認（壊れたJSONで事故らない）
    return obj && typeof obj === "object"
      && Array.isArray(obj.seats)
      && Array.isArray(obj.menu || [])
      && Array.isArray(obj.orders || [])
      && Array.isArray(obj.sales || []);
  }

  document.getElementById("btnImportJson").onclick = async ()=>{
    const file = document.getElementById("importFile").files?.[0];
    if(!file){
      alert("JSONファイルを選択してください");
      return;
    }
    if(!confirm("このJSONで上書き復元します。現在のデータは失われます。")){
      return;
    }
    try{
      const text = await file.text();
      const obj = JSON.parse(text);
      if(!isValidBackupJson(obj)){
        alert("このJSONは形式が違います（読み込み不可）");
        return;
      }
      localStorage.setItem(STORAGE_KEY, JSON.stringify(obj));
      loadState();
      recalcSeatTotals();
      saveState();
      renderMain();
      renderBackupText();
      alert("復元しました");
      showPage("main");
    }catch(e){
      alert("読み込みに失敗しました（JSONが壊れている可能性があります）");
    }
  };

  // ===== Reset =====
  document.getElementById("btnResetAll").onclick = ()=>{
    if(!confirm("全データをリセットします。本当に実行しますか？")){
      return;
    }
    if(!confirm("最終確認：取り消せません。実行しますか？")){
      return;
    }
    localStorage.removeItem(STORAGE_KEY);
    // 初期化：最小の安全状態へ
    state.seats = state.seats || [];
    state.menu = [];
    state.orders = [];
    state.sales = [];
    state.billGroups = [];
    state.selectedSeatIds = [];
    state.activeSeatIds = [];
    state.checkout = { payMethod:"cash" };
    state.store = { name:"", tel:"", email:"", addr:"", lineUrl:"" };
    saveState();
    renderMain();
    alert("リセットしました");
    showPage("main");
  };

  // ===== showPage hook enhance =====
  const __showPage7 = window.showPage;
  window.showPage = function(name){
    __showPage7(name);
    if(name === "storeInfo"){
      document.getElementById("siName").value  = state.store?.name  || "";
      document.getElementById("siTel").value   = state.store?.tel   || "";
      document.getElementById("siEmail").value = state.store?.email || "";
      document.getElementById("siAddr").value  = state.store?.addr  || "";
      renderStoreInfoPreview();
    }
    if(name === "backup"){
      renderBackupText();
    }
    if(name === "contact"){
      renderContactPreview();
    }
  };

  // ===== Init (PART7) =====
  loadState();
  saveState();
</script>

<!-- =========================
  ここから先は PART8 で続く
========================= -->
<!-- =========================
  ONE レジアプリ（無料版）完全フル：PART8
  役割：初回起動画面（固定文言）/ 起動フロー / 注意事項（確定仕様）
========================= -->

<style>
  /* ===== First Launch Overlay (PART8) ===== */
  .firstBack{
    position:fixed;
    inset:0;
    background:rgba(0,0,0,.70);
    z-index:500;
    display:none;
    align-items:flex-end;
    padding:12px 12px calc(12px + env(safe-area-inset-bottom)) 12px;
  }
  .firstBack.show{ display:flex; }

  .firstSheet{
    width:100%;
    border-radius:18px;
    border:1px solid var(--line);
    background: linear-gradient(180deg, rgba(18,26,36,.98), rgba(18,26,36,.92));
    box-shadow: 0 18px 80px rgba(0,0,0,.65);
    overflow:hidden;
  }
  .firstHead{
    padding:14px 14px 10px 14px;
    border-bottom:1px solid var(--line);
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
  }
  .firstTitle{
    font-size:16px;
    font-weight:1000;
    letter-spacing:.2px;
  }
  .firstBody{
    padding:14px;
    max-height: 62vh;
    overflow:auto;
    -webkit-overflow-scrolling: touch;
  }
  .firstBody h3{
    margin:14px 0 8px 0;
    font-size:13px;
    color:var(--muted);
    font-weight:1000;
    letter-spacing:.2px;
  }
  .firstBody p, .firstBody li{
    margin:0;
    font-size:13px;
    line-height:1.65;
    color:var(--text);
    font-weight:750;
  }
  .firstBody ul{
    margin:8px 0 0 0;
    padding-left:18px;
  }
  .firstFoot{
    padding:12px 14px;
    border-top:1px solid var(--line);
    display:flex;
    gap:10px;
  }
  .firstFoot .btnWide{ flex:1; }
</style>

<!-- ===== First Launch Overlay ===== -->
<div class="firstBack" id="firstBack">
  <div class="firstSheet" role="dialog" aria-modal="true">
    <div class="firstHead">
      <div class="firstTitle">ONE（無料版） はじめに</div>
      <button class="btn small" id="firstClose">閉じる</button>
    </div>

    <div class="firstBody">
      <h3>このアプリの目的</h3>
      <p>
        ONEは「現場で迷わない」ことを最優先にした、シンプルなレジ見本（無料版）です。<br>
        まずは席・注文・会計・売上の基本動線を、最小の操作で回せるようにしています。
      </p>

      <h3>確定している仕様（重要）</h3>
      <ul>
        <li>売上は削除しません。訂正は <b>訂正伝票方式</b> です。</li>
        <li>訂正理由は <b>定型＋自由入力</b> です。</li>
        <li>自動再試行中の表示は <b>表示しません（静か）</b>。</li>
        <li>電子レシート（無料版は導線のみ）には <b>席番号・人数は記載しません</b>（内部保持のみ）。</li>
      </ul>

      <h3>データについて（無料版の方針）</h3>
      <ul>
        <li>このアプリは端末内（localStorage）に保存されます。</li>
        <li>提供済データの保持期間の考え方は <b>当日のみ</b> を基本にしています（無料版は「守る」を優先）。</li>
        <li>機種変更や故障に備えて、<b>バックアップ</b> を推奨します（設定→バックアップ）。</li>
      </ul>

      <h3>使い方（最短）</h3>
      <ul>
        <li>メインで席を選ぶ → <b>決定</b></li>
        <li>空席なら来店（人数）→ 注文へ</li>
        <li>注文 → 会計 → 会計確定 → 売上に反映</li>
      </ul>

      <h3>注意</h3>
      <ul>
        <li>無料版は「動く見本（UI仕様書）」です。現場運用は自己責任でお願いします。</li>
        <li>不安なときは、まず <b>バックアップ</b> を取ってください。</li>
      </ul>
    </div>

    <div class="firstFoot">
      <button class="btnWide" id="firstGoSettings" type="button">設定を見る</button>
      <button class="btnWide primary" id="firstAgree" type="button">同意して開始</button>
    </div>
  </div>
</div>

<script>
  /* =========================
    First launch flow (PART8)
  ========================= */

  const FIRST_FLAG_KEY = STORAGE_KEY + "__FIRST_OK";

  function isFirstDone(){
    try{
      return localStorage.getItem(FIRST_FLAG_KEY) === "1";
    }catch(e){
      return false;
    }
  }

  function openFirst(){
    const back = document.getElementById("firstBack");
    if(!back) return;
    back.classList.add("show");
    if(typeof lockBg === "function") lockBg(true);
  }

  function closeFirst(){
    const back = document.getElementById("firstBack");
    if(!back) return;
    back.classList.remove("show");
    if(typeof lockBg === "function") lockBg(false);
  }

  document.getElementById("firstClose").onclick = closeFirst;

  document.getElementById("firstGoSettings").onclick = ()=>{
    closeFirst();
    showPage("settings");
  };

  document.getElementById("firstAgree").onclick = ()=>{
    try{
      localStorage.setItem(FIRST_FLAG_KEY, "1");
    }catch(e){}
    closeFirst();
    showPage("main");
  };

  // ===== Boot: show first overlay only once =====
  (function bootFirst(){
    // 既に同意済みなら何もしない
    if(isFirstDone()) return;

    // ページが組み上がったら表示
    // （既にDOM構築済みなので即表示でもOK）
    openFirst();
  })();
</script>

<!-- =========================
  ここまでで 8分割 完成
========================= -->