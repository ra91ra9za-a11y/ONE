<!-- =========================
  ONE ãƒ¬ã‚¸ã‚¢ãƒ—ãƒªï¼ˆç„¡æ–™ç‰ˆï¼‰å®Œå…¨ãƒ•ãƒ«ï¼šPART1ï¼ˆæ§‹é€ å®‰å®šç‰ˆï¼šshowScreenä¸€æœ¬åŒ–ï¼‹ãƒ•ãƒƒã‚¯æ–¹å¼ï¼‰
  å½¹å‰²ï¼šHTMLéª¨æ ¼ / CSS / å…±é€šå®šç¾© / å…±é€šUI / ãƒ¡ã‚¤ãƒ³ç”»é¢UI / æœ€ä½é™JS
  ä¿å­˜KEYï¼šONE_FREE_FULL_V2
  â€»é‡è¦ï¼šPART1ã®æœ«å°¾ã« </body></html> ã‚’å…¥ã‚Œãªã„ï¼ˆPART8ã«ã‚ã‚‹ï¼‰
  â€»é‡è¦ï¼šPART1ã® <script> ã¯ã€Œã“ã“ã§ã¯é–‰ã˜ãªã„ã€ã€‚PART2ãŒ script ç¶šã
========================= -->
<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#174b2f" />
  <title>ONE FREE</title>

  <style>
    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, "Hiragino Sans", "Noto Sans JP", "Segoe UI", sans-serif;
      -webkit-font-smoothing: antialiased;
      text-rendering: optimizeLegibility;
      overflow-x:hidden;
      background: var(--pageBg);
      color: var(--ink);
      touch-action: pan-y;
      overscroll-behavior-y: contain;
      -webkit-text-size-adjust:100%;
    }
    button,input,select,textarea{ font:inherit; }
    button{ touch-action: manipulation; }
    a{ color: inherit; }

    body.modalLock{ position:fixed; width:100%; overflow:hidden; }

    /* iOSå…¥åŠ›ã‚ºãƒ¼ãƒ æŠ‘æ­¢ï¼ˆ16pxãƒ«ãƒ¼ãƒ«ï¼‰ */
    input, textarea, select{
      font-size:16px;
      -webkit-appearance:none;
      appearance:none;
      color:var(--ink);
    }

    :root{
      --sat: env(safe-area-inset-top);
      --sab: env(safe-area-inset-bottom);
      --sal: env(safe-area-inset-left);
      --sar: env(safe-area-inset-right);

      --ink:#173a27;
      --ink2:#1b4a31;
      --white:#ffffff;

      --pageBg:#eaf4df;     /* ã†ã£ã™ã‚‰è‹¥è‰ */
      --cardBg:#dff0c9;     /* å¸­ã‚«ãƒ¼ãƒ‰ */
      --cardBgOn:#86df63;   /* é¸æŠ */
      --reserveBg:#eaf4ff;  /* äºˆç´„ */

      --darkGreen:#174b2f;  /* æ¿ƒã„ç·‘ */
      --mossGreen:#3aa55b;  /* ãƒ¢ã‚¹ã‚°ãƒªãƒ¼ãƒ³ï¼ˆã‚¢ãƒ³ãƒ†ãƒŠèƒŒæ™¯ï¼‰ */
      --limeLine:#d9ff9a;   /* æ˜ã‚‹ã„é»„ç·‘ï¼ˆç™½å¯„ã‚Šï¼‰ */
      --topLine:#77d86b;    /* ä¸Šéƒ¨å¢ƒç•Œãƒ©ã‚¤ãƒ³ */

      --tanBg:#eadfcf;
      --tanFill:#e2d3bf;
      --tanLineLight:#f2eadf;
      --tanLineDark:#6b4b2c;
      --tanInk:#2f2217;

      --gap:8px;
      --topH:56px;
      --bottomH:76px;
      --radiusTop:16px;
      --radiusCard:16px;
    }

    .app{
      min-height:100dvh;
      padding-left: calc(10px + var(--sal));
      padding-right: calc(10px + var(--sar));
      padding-top: calc(var(--topH) + var(--sat));
      padding-bottom: calc(var(--bottomH) + var(--sab));
    }

    .screen{ display:none; padding:14px; max-width:980px; margin:0 auto; }
    .screen.active{ display:block; }

    /* =========================
      ä¸Šéƒ¨å›ºå®šï¼ˆãƒ˜ãƒƒãƒ€ãƒ¼ï¼‰
    ========================= */
    .topbar{
      position:fixed;
      top:0; left:0; right:0;
      z-index:50;
      height: calc(var(--topH) + var(--sat));
      padding-top: var(--sat);
      padding-left: calc(10px + var(--sal));
      padding-right: calc(10px + var(--sar));
      background: linear-gradient(90deg, #1a5636 0%, #14452b 50%, #1a5636 100%);
    }
    .topbar::after{
      content:"";
      position:absolute;
      left:0; right:0;
      bottom:0;
      height:2px;
      background: var(--topLine);
      opacity:.95;
    }
    .topbarInner{
      height: var(--topH);
      display:flex;
      align-items:center;
      gap:8px;
      padding:0 0 0 0;
    }

    .brandWrap{
      display:flex;
      align-items:center;
      gap:8px;
      min-width: 150px;
    }

    /* ğŸŸ¢ONEï¼ˆæ ä»˜ãï¼‰ */
    .brandBox{
      height:36px;
      width:92px;
      border-radius:12px;
      border:2px solid var(--limeLine);
      background: var(--darkGreen);
      display:flex;
      align-items:center;
      justify-content:center;
      color:#fff;
      font-weight:900;
      font-size:14px;
      letter-spacing:.5px;
      line-height:1;
      user-select:none;
      -webkit-user-select:none;
    }
    .brandBox .dot{ margin-right:6px; color:#58ff7a; }

    /* ã‚¢ãƒ³ãƒ†ãƒŠï¼ˆè§’ä¸¸å››è§’ãƒ»å›²ã„ç„¡ã—ï¼‰ */
    .antennaWrap{
      position:relative;
      width:34px;
      height:34px;
      border-radius:10px;
      background: var(--mossGreen);
      border:none;
      display:grid;
      place-items:center;
      padding:0;
      margin:0;
    }
    .antennaIcon{ display:none; } /* äº’æ›ç”¨ï¼ˆéè¡¨ç¤ºï¼‰ */
    .antennaSvg{ width:22px; height:22px; display:block; }
    .antennaSvg path{ fill:#fff; }
    .antennaX{
      position:absolute;
      top:3px; right:3px;
      font-size:14px;
      line-height:1;
      color:#c33b2e;
      font-weight:900;
      display:none;
      text-shadow:0 1px 0 rgba(255,255,255,0.25);
    }
    .antennaWrap.off .antennaX{ display:block; }

    .topCenter{
      flex:1;
      display:flex;
      justify-content:center;
    }

    /* ãƒ˜ãƒƒãƒ€ãƒ¼å†…ãƒœã‚¿ãƒ³ï¼ˆã‚­ãƒƒãƒãƒ³/ä¿å­˜ï¼‰ */
    .topBtn{
      height:30px;
      min-width:84px;
      border-radius:16px;
      border:2px solid var(--limeLine);
      background: var(--darkGreen);
      color:#fff;
      font-weight:400;
      font-size:15px;
      padding:2px 10px;
      display:flex;
      align-items:center;
      justify-content:center;
      line-height:1;
      user-select:none;
      -webkit-user-select:none;
    }
    .topBtn.wKitchen{ min-width:96px; }

    .topRight{
      min-width:96px;
      display:flex;
      justify-content:flex-end;
      gap:8px;
    }

    /* =========================
      ä¸­å¤®ï¼ˆå¸­ã‚«ãƒ¼ãƒ‰ï¼‰
    ========================= */
    .hintText{
      font-weight:800;
      color: var(--ink2);
      font-size:16px;
      line-height:1.2;
      user-select:none;
      -webkit-user-select:none;
      margin:6px 0 10px 0;
    }

    .seatGrid{
      display:grid;
      grid-template-columns:repeat(3, minmax(0, 1fr));
      gap: var(--gap);
      align-items:stretch;
    }

    .seatCard{
      position:relative;
      background: var(--cardBg);
      border-radius: var(--radiusCard);
      border:2px solid var(--darkGreen);
      box-shadow: inset 0 0 0 1px #ffffff;
      min-height:150px;
      padding:6px;
      color: var(--ink);
      overflow:hidden;
      touch-action: manipulation;
      user-select:none;
      -webkit-user-select:none;
    }
    .seatCard.reserve{ background: var(--reserveBg); }
    .seatCard.empty{ background: var(--cardBg); }
    .seatCard.in{ background: var(--cardBg); }

    .seatCard.isSelected{
      background: var(--cardBgOn) !important;
      color:#fff;
      box-shadow: inset 0 0 0 1px #ffffff, 0 0 0 2px var(--limeLine);
    }
    .seatCard.isSelected .seatDivider{ background:#000; opacity:.28; }
    .seatCard.isSelected .seatPeople,
    .seatCard.isSelected .seatName,
    .seatCard.isSelected .seatState,
    .seatCard.isSelected .seatSub,
    .seatCard.isSelected .seatBills,
    .seatCard.isSelected .seatPrice{ color:#fff; opacity:1; }

    .seatNo{
      position:absolute;
      left:6px; top:8px;
      font-size:32px;
      font-weight:900;
      line-height:1;
    }
    .seatPeople{
      position:absolute;
      right:6px; top:12px;
      font-size:15px;
      font-weight:800;
      line-height:1;
      opacity:.95;
      text-align:right;
    }

    .seatName{
      position:absolute;
      left:6px; top:50px;
      font-size:15px;
      font-weight:800;
      line-height:1.05;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      right:6px;
    }
    .seatState{
      position:absolute;
      left:6px; top:72px;
      font-size:15px;
      font-weight:800;
      line-height:1.05;
      opacity:.95;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      right:6px;
    }
    .seatSub{
      position:absolute;
      left:6px; top:94px;
      font-size:13px;
      font-weight:800;
      line-height:1.05;
      opacity:.75;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      right:6px;
    }
    .seatBills{
      position:absolute;
      left:6px; top:112px;
      font-size:13px;
      font-weight:800;
      line-height:1.05;
      opacity:.75;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      right:6px;
    }

    .seatDivider{
      position:absolute;
      left:6px; right:6px;
      bottom:32px;
      height:2px;
      background:#000;
      opacity:.35;
    }

    .seatPrice{
      position:absolute;
      left:6px; right:6px;
      bottom:8px;
      font-size:16px;
      font-weight:900;
      line-height:1.05;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      color: var(--ink);
    }

    /* =========================
      ä¸‹æ®µå›ºå®šï¼ˆ3é€£ãƒœã‚¿ãƒ³ï¼‰
    ========================= */
    .bottomBar{
      position:fixed;
      left:0; right:0; bottom:0;
      z-index:45;
      height: calc(var(--bottomH) + var(--sab));
      padding-bottom: var(--sab);
      padding-left: calc(10px + var(--sal));
      padding-right: calc(10px + var(--sar));
      background: var(--tanBg);
      display:flex;
      align-items:center;
    }
    .bottomInner{
      width:100%;
      max-width:980px;
      margin:0 auto;
      height: var(--bottomH);
      display:flex;
      align-items:center;
    }

    .navGroup{
      width:100%;
      display:flex;
      gap:0;
      border-radius:14px;
      overflow:hidden;
      border:2px solid var(--tanLineLight);
      box-shadow: inset 0 0 0 1px var(--tanLineDark);
      background: var(--tanFill);
    }
    .navSep{
      width:5px;
      background:
        linear-gradient(90deg,
          var(--tanLineLight) 0 1px,
          var(--tanLineDark) 1px 4px,
          var(--tanLineLight) 4px 5px
        );
      flex:0 0 5px;
    }
    .navBtn{
      flex:1;
      height:60px;
      background: var(--tanFill);
      color: var(--tanInk);
      border:none;
      padding:2px 6px;
      font-weight:900;
      font-size:18px;
      line-height:1.05;
      display:flex;
      align-items:center;
      justify-content:center;
      text-align:center;
      user-select:none;
      -webkit-user-select:none;
    }
    .navBtn.on{ background: var(--tanFill); color: var(--tanInk); } /* å…‰ã‚‰ã›ãªã„ */

    /* =========================
      æ—¢å­˜äº’æ›ï¼ˆPART2ä»¥é™ã® .btn ã‚’å£Šã•ãªã„ï¼‰
    ========================= */
    .btn{
      border-radius:18px;
      border:2px solid rgba(217,255,154,.85);
      background: rgba(23,75,47,.85);
      color:#fff;
      padding:10px 12px;
      font-weight:700;
      font-size:16px;
      min-height:44px;
      line-height:1.1;
    }
    .btn.full{ width:100%; }
    .btn.lime{
      background: rgba(23,75,47,.92);
      border-color: rgba(217,255,154,.9);
      color:#fff;
      font-weight:700;
    }
    .btn.ghost{
      background: transparent;
      border-color: transparent;
      color: var(--ink);
      padding:8px 10px;
      min-height:40px;
    }

    /* modal/toast ã¯æ—¢å­˜äº’æ›ï¼ˆè¦‹ãŸç›®ã ã‘æœ€å°ï¼‰ */
    .backdrop{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,0.42);
      z-index:80;
      display:none;
      align-items:center;
      justify-content:center;
      padding:12px;
      padding-top:calc(12px + var(--sat));
      padding-bottom:calc(12px + var(--sab));
    }
    .backdrop.show{ display:flex; }
    .modal{
      width:min(560px, 100%);
      background: #e6f2de;
      border-radius:18px;
      border:2px solid rgba(23,75,47,.35);
      overflow:hidden;
      max-height:calc(100vh - 24px - var(--sat) - var(--sab));
      display:flex;
      flex-direction:column;
    }
    .modalHead{
      padding:14px 14px 12px;
      border-bottom:2px solid rgba(0,0,0,0.08);
      font-weight:900;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex:0 0 auto;
      background:#ecf6e6;
    }
    .modalTitleL{ display:flex; align-items:center; gap:10px; min-width:0; }
    .modalSeatId{ font-weight:900; font-size:18px; white-space:nowrap; color:var(--darkGreen); }
    .modalTitleText{ font-size:18px; font-weight:900; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .modalBody{
      padding:14px;
      color:var(--ink);
      font-size:16px;
      font-weight:700;
      line-height:1.65;
      overflow:auto;
      -webkit-overflow-scrolling:touch;
      flex:1 1 auto;
      min-height:0;
      background:#e6f2de;
    }
    .modalActions{
      padding:12px 14px 14px;
      display:flex;
      gap:12px;
      justify-content:flex-end;
      flex-wrap:wrap;
      flex:0 0 auto;
      background:#ecf6e6;
    }
    .bigBtn{ min-height:52px; padding:12px 14px; font-weight:900; border-radius:18px; font-size:16px; }

    .toast{
      position:fixed;
      left:50%;
      transform:translateX(-50%);
      bottom:calc(var(--bottomH) + 18px + var(--sab));
      background: rgba(0,0,0,0.78);
      color:#fff;
      padding:10px 12px;
      border-radius:14px;
      font-weight:800;
      font-size:14px;
      z-index:90;
      display:none;
      max-width:min(90vw, 860px);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .toast.show{ display:block; }

    @media (max-width: 360px){
      .hintText{ font-size:15px; }
      .seatNo{ font-size:30px; }
      .seatPeople{ font-size:14px; }
      .navBtn{ font-size:17px; }
      .topBtn{ font-size:14px; }
    }
  </style>
</head>

<body>
  <!-- ===== Header ===== -->
  <header class="topbar" id="topbar">
    <div class="topbarInner">
      <div class="brandWrap">
        <div class="brandBox"><span class="dot">ğŸŸ¢</span>ONE</div>

        <button class="antennaWrap" id="btnAntenna" aria-label="åŒæœŸçŠ¶æ…‹">
          <svg class="antennaSvg" viewBox="0 0 24 24" aria-hidden="true">
            <path d="M3 20h2v-2H3v2zm4 0h2v-4H7v4zm4 0h2v-6h-2v6zm4 0h2v-8h-2v8zm4 0h2V4h-2v16z"/>
          </svg>
          <span class="antennaX">âŒ</span>
          <span class="antennaIcon">ğŸ“¶</span>
        </button>
      </div>

      <div class="topCenter">
        <button class="topBtn wKitchen" id="navSecond">ã‚­ãƒƒãƒãƒ³</button>
      </div>

      <div class="topRight">
        <button class="topBtn" id="btnSave">ä¿å­˜</button>
      </div>
    </div>
  </header>

  <!-- ===== App ===== -->
  <main class="app">
    <section class="screen active" id="scrMain">
      <div class="hintText" id="mainHint">ç©ºå¸­ã‚’ã‚¿ãƒƒãƒ—ã§ æ¥åº— / äºˆç´„ ã‚’åˆ‡æ›¿</div>
      <div class="seatGrid" id="seatGrid"></div>
    </section>

    <section class="screen" id="scrKitchen"><div class="pageDesc">ï¼ˆPART3ã§å®Ÿè£…ï¼‰</div></section>
    <section class="screen" id="scrSales"><div class="pageDesc">ï¼ˆPART4ã§å®Ÿè£…ï¼‰</div></section>
    <section class="screen" id="scrFix"><div class="pageDesc">ï¼ˆPART5ã§å®Ÿè£…ï¼‰</div></section>
    <section class="screen" id="scrSeatSetup"><div class="pageDesc">ï¼ˆPART6ã§å®Ÿè£…ï¼‰</div></section>
    <section class="screen" id="scrSettings"><div class="pageDesc">ï¼ˆå¾Œã§å˜ç‹¬ä¿®æ­£ï¼‰</div></section>
    <section class="screen" id="scrMenu"><div class="pageDesc">ï¼ˆPART8ã§å®Ÿè£…ï¼‰</div></section>
    <section class="screen" id="scrOrder"><div class="pageDesc">ï¼ˆPART2ã§å®Ÿè£…ï¼‰</div></section>

<section class="screen" id="scrCheckout">
  <div class="panel">
    <div style="font-weight:900; font-size:20px; margin-bottom:10px;">ä¼šè¨ˆ</div>

    <div class="pill" style="margin-bottom:10px;">
      åˆè¨ˆï¼š<span id="coTotal">Â¥0</span>
    </div>

    <!-- æ”¯æ‰•ã„æ–¹æ³• -->
    <div style="display:flex; gap:10px; margin:10px 0;">
      <button class="btn full" id="coPayCash">ç¾é‡‘</button>
      <button class="btn full" id="coPayCard">ã‚«ãƒ¼ãƒ‰</button>
      <button class="btn full" id="coPayQR">QR</button>
    </div>
    <div class="muted" style="font-weight:800; margin-bottom:12px;">
      é¸æŠä¸­ï¼š<span id="coPaySelected">æœªé¸æŠ</span>
    </div>

    <!-- å‰²ã‚Šå‹˜ -->
    <div class="panel" style="margin:12px 0;">
      <div style="font-weight:900; margin-bottom:8px;">å‰²ã‚Šå‹˜</div>
      <div style="display:flex; gap:10px; align-items:center;">
        <button class="btn" id="coSplitMinus">âˆ’</button>
        <div class="pill" style="flex:1;">
          <span id="coSplitN">1</span> äºº
          ï¼ 1äººã‚ãŸã‚Šï¼š<span id="coPer">Â¥0</span>
        </div>
        <button class="btn" id="coSplitPlus">ï¼‹</button>
      </div>
    </div>

    <!-- é›»å­ãƒ¬ã‚·ãƒ¼ãƒˆ -->
    <div class="panel" style="margin:12px 0;">
      <div style="font-weight:900; margin-bottom:8px;">é›»å­ãƒ¬ã‚·ãƒ¼ãƒˆ</div>
      <div class="muted" style="font-weight:800; margin-bottom:8px;">
        â€»å¸­ç•ªå·ãƒ»äººæ•°ã¯è¨˜è¼‰ã—ãªã„ï¼ˆå†…éƒ¨ç®¡ç†ã®ã¿ï¼‰
      </div>

      <button class="btn full"
        id="coSendReceipt"
        style="margin-top:10px;"
        disabled>
        é€ã‚‹ï¼ˆæœ‰æ–™ç‰ˆï¼‰
      </button>

      <div class="muted" style="font-weight:800; margin-top:6px;">
        ç„¡æ–™ç‰ˆã¯é€ä¿¡ã§ãã¾ã›ã‚“ï¼ˆæœ‰æ–™ç‰ˆã§è§£æ”¾ï¼‰
      </div>
    </div>

    <!-- ä¸‹éƒ¨ãƒœã‚¿ãƒ³ -->
    <div style="display:flex; gap:10px; margin-top:14px;">
      <button class="btn full" id="coBack">æˆ»ã‚‹</button>
      <button class="btn full lime" id="coConfirm">ä¼šè¨ˆç¢ºå®š</button>
    </div>
  </div>
</section>

</main>

  <!-- ===== Bottom (Main only) ===== -->
  <div class="bottomBar" id="bottomBar">
    <div class="bottomInner">
      <div class="navGroup">
        <button class="navBtn" id="goMove">å¸­ç§»å‹•</button>
        <div class="navSep"></div>
        <button class="navBtn" id="goTodaySales">æœ¬æ—¥ã®å£²ä¸Š</button>
        <div class="navSep"></div>
        <button class="navBtn" id="goSettings">è¨­å®š</button>
      </div>
    </div>
  </div>

  <!-- ===== Modal ===== -->
  <div class="backdrop" id="modalBackdrop" role="dialog" aria-modal="true">
    <div class="modal">
      <div class="modalHead">
        <div class="modalTitleL">
          <div class="modalSeatId" id="modalSeatId" style="display:none"></div>
          <div class="modalTitleText" id="modalTitle"> </div>
        </div>
        <button class="btn ghost" id="modalClose">é–‰ã˜ã‚‹</button>
      </div>
      <div class="modalBody" id="modalBody"> </div>
      <div class="modalActions" id="modalActions"></div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    /* =========================
      Common / State (PART1)
    ========================= */

    const KEY = "ONE_FREE_FULL_V2";
    const $ = (id)=> document.getElementById(id);

    function nowTs(){ return Date.now(); }
    function pad2(n){ return String(n).padStart(2,"0"); }
    function yen(n){
      const x = Number(n||0);
      return "Â¥" + x.toLocaleString("ja-JP");
    }

    function toast(msg, ms=1800){
      const t = $("toast");
      if(!t) return;
      t.textContent = msg;
      t.classList.add("show");
      clearTimeout(toast._tm);
      toast._tm = setTimeout(()=> t.classList.remove("show"), ms);
    }

    function lockBody(){
      const y = window.scrollY;
      document.body.dataset.scrollY = String(y);
      document.body.classList.add("modalLock");
      document.body.style.top = `-${y}px`;
    }
    function unlockBody(){
      const y = Number(document.body.dataset.scrollY || "0");
      document.body.classList.remove("modalLock");
      document.body.style.top = "";
      window.scrollTo(0, y);
    }

    (function modalKeyboardAssist(){
      const bd = $("modalBackdrop");
      document.addEventListener("focusin", (e)=>{
        if(!bd || !bd.classList.contains("show")) return;
        const t = e.target;
        if(t && (t.tagName==="INPUT" || t.tagName==="TEXTAREA" || t.tagName==="SELECT")){
          bd.classList.add("kbOpen");
        }
      });
      document.addEventListener("focusout", ()=>{
        const bd2 = $("modalBackdrop");
        if(!bd2 || !bd2.classList.contains("show")) return;
        setTimeout(()=> bd2.classList.remove("kbOpen"), 50);
      });
    })();

    function openModal(title, bodyHtml, actions, seatId=null){
      $("modalTitle").textContent = title || "";
      $("modalBody").innerHTML = bodyHtml || "";

      if(seatId){
        $("modalSeatId").style.display = "block";
        $("modalSeatId").textContent = seatId;
      }else{
        $("modalSeatId").style.display = "none";
        $("modalSeatId").textContent = "";
      }

      const box = $("modalActions");
      box.innerHTML = "";
      (actions||[]).forEach(a=>{
        const b = document.createElement("button");
        b.className = "btn bigBtn" + (a.lime ? " lime" : "");
        b.textContent = a.label;
        b.onclick = ()=> a.onClick && a.onClick();
        box.appendChild(b);
      });

      $("modalBackdrop").classList.add("show");
      lockBody();
    }
    function closeModal(){
      $("modalBackdrop").classList.remove("show");
      $("modalBackdrop").classList.remove("kbOpen");
      unlockBody();
    }

    $("modalClose").onclick = ()=> closeModal();
    $("modalBackdrop").addEventListener("click", (e)=>{
      if(e.target === $("modalBackdrop")) closeModal();
    });

    /* =========================
      Screen system (stable)
      - showScreen ä¸Šæ›¸ãç¦æ­¢ï¼ˆå„PARTã¯ãƒ•ãƒƒã‚¯ç™»éŒ²ã®ã¿ï¼‰
    ========================= */

const screens = ["scrMain","scrKitchen","scrSales","scrFix","scrSeatSetup","scrSettings","scrMenu","scrOrder","scrCheckout"];

    const SCREEN_HOOKS = Object.create(null);
    function registerScreenHook(id, fn){
      if(!id || typeof fn !== "function") return;
      SCREEN_HOOKS[id] = fn;
    }

    function showScreen(id){
      screens.forEach(s=>{
        const el = $(s);
        if(!el) return;
        el.classList.toggle("active", s===id);
      });

      if(id==="scrMain"){
        $("navSecond").textContent = "ã‚­ãƒƒãƒãƒ³";
      }else if(id==="scrKitchen"){
        $("navSecond").textContent = "ãƒ›ãƒ¼ãƒ«";
      }else{
        $("navSecond").textContent = "ãƒ¡ã‚¤ãƒ³";
      }

      $("bottomBar").style.display = (id==="scrMain") ? "flex" : "none";
      window.scrollTo(0,0);

      try{
        if(SCREEN_HOOKS[id]) SCREEN_HOOKS[id]();
      }catch(e){
        console.warn("screen hook error:", id, e);
        toast("ç”»é¢ã®è¡¨ç¤ºã§ã‚¨ãƒ©ãƒ¼ãŒå‡ºã¾ã—ãŸï¼ˆç¶šè¡Œã—ã¾ã™ï¼‰");
      }
    }

    const state = {
      syncOk: true,
      seats: [],
      order: { seatId:null, subId:null, catView:"all" },
      sales: null,
      kitchen: null,
      fix: null,
      seatSetup: null,
      sync: null,
     menu: { cat:null, selectedGenre:null },
    };

    function setSync(ok){
      state.syncOk = !!ok;
      $("btnAntenna").classList.toggle("off", !ok);
    }

    function seatById(id){ return state.seats.find(s=> s.id===id); }

    function ensureSub(seat, subId){
      seat.sub = seat.sub || {};
      if(!seat.sub[subId]){
        seat.sub[subId] = { seatId: subId, people:0, name:"", total:0, orders:[], reserve:null };
      }
      return seat.sub[subId];
    }

    function calcSeatTotal(seat){
      if(!seat.merged){
        return Number(seat.total||0);
      }
      const subs = Object.values(seat.sub||{});
      return subs.reduce((a,b)=> a + Number(b.total||0), 0);
    }

    function calcOrdersTotal(orders){
      return (orders||[]).reduce((sum, o)=> sum + (Number(o.price||0) * Number(o.qty||0)), 0);
    }

    function seedSeatsIfEmpty(){
      if(state.seats.length) return;

      state.seats = [
        {id:"A", status:"empty"},
        {id:"B", status:"empty"},
        {id:"C", status:"reserve", people:1, reserve:{time:"", name:"", tel:"", note:""}, total:0, bills:0},
        {id:"D", status:"in", people:3, name:"äº•ä¸Š", total:6100, bills:1},
        {id:"E", status:"in", people:2, name:"", total:7800, bills:2, merged:true, mergeLabel:"â¡ï¸A,B"},
        {id:"F", status:"empty"},
        {id:"1", status:"empty"},
        {id:"2", status:"empty"},
        {id:"3", status:"empty"},
      ].map(s=>{
        s.people = Number(s.people||0);
        s.name = s.name || "";
        s.total = Number(s.total||0);
        s.bills = Number(s.bills||0);
        s.merged = !!s.merged;
        s.mergeLabel = s.mergeLabel || "";
        s.sub = null;
        return s;
      });
    }

    /* =========================
      Seat normalize (stable)
      - å¸­ç™»éŒ²/å¾©å…ƒ/seed ã®å½¢ã‚†ã‚Œã‚’å¸å
    ========================= */
    function normalizeSeat(s){
      if(!s) s = {};
      s.id = String(s.id || "");
      s.status = s.status || "empty";
      s.people = Number(s.people||0);
      s.name = s.name || "";
      s.total = Number(s.total||0);
      s.bills = Number(s.bills||0);
      s.reserve = s.reserve || null;

      s.merged = !!s.merged;
      s.mergeLabel = s.mergeLabel || "";
      s.sub = s.sub || null;

      s.orders = Array.isArray(s.orders) ? s.orders : [];
      s.orderLog = Array.isArray(s.orderLog) ? s.orderLog : [];

      return s;
    }
    function normalizeAllSeats(){
      state.seats = (state.seats||[]).map(normalizeSeat);
    }

    function renderSeats(){
      const grid = $("seatGrid");
      grid.innerHTML = "";

      state.seats.forEach(seat=>{
        const card = document.createElement("div");
        card.className = "seatCard " + (seat.status==="reserve" ? "reserve" : seat.status==="in" ? "in" : "empty");
        card.dataset.seatId = seat.id;

        const seatLabel = seat.merged ? (seat.mergeLabel || seat.id) : seat.id;
        const people = (seat.status==="in" || seat.status==="reserve") ? Number(seat.people||0) : 0;

        const bills = Number(seat.bills||0);
        const billsLine = (seat.status==="in" && bills>=2) ? `åˆ¥ä¼šè¨ˆ${bills}ä»¶` : "";

        let nameLine = "";
        let stateLine = "";
        let subLine = "";

        if(seat.merged){
          nameLine = "åˆæµ";
          stateLine = seat.mergeLabel || "";
          subLine = "";
        }else if(seat.status==="in"){
          nameLine = seat.name || "";
          stateLine = "ä½¿ç”¨ä¸­";
          subLine = "";
        }else if(seat.status==="reserve"){
          nameLine = "äºˆç´„";
          stateLine = "";
          subLine = "";
        }else{
          nameLine = "ç©ºå¸­";
          stateLine = "";
          subLine = "";
        }

        const money = (seat.status==="in") ? yen(calcSeatTotal(seat)) : "";

        card.innerHTML = `
          <div class="seatNo">${seatLabel}</div>
          <div class="seatPeople">${(seat.status==="in"||seat.status==="reserve") ? `${people}å` : ""}</div>
          <div class="seatName">${nameLine || " "}</div>
          <div class="seatState">${stateLine || " "}</div>
          <div class="seatSub">${subLine || " "}</div>
          <div class="seatBills">${billsLine || " "}</div>
          <div class="seatDivider"></div>
          <div class="seatPrice">${money || " "}</div>
        `;

        card.onclick = ()=> onSeatTap(seat.id);
        grid.appendChild(card);
      });
    }

    /* PART2ã§ä¸Šæ›¸ãã•ã‚Œã‚‹å‰æã®ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ */
    function onSeatTap(seatId){
      toast("èª­ã¿è¾¼ã¿ä¸­â€¦");
    }

    $("navSecond").onclick = ()=>{
      const current = screens.find(s=> $(s).classList.contains("active")) || "scrMain";
      if(current==="scrMain"){
        showScreen("scrKitchen");
      }else if(current==="scrKitchen"){
        showScreen("scrMain");
      }else{
        showScreen("scrMain");
      }
    };

    $("goMove").onclick = ()=> openMoveHome();
    $("goTodaySales").onclick = ()=> { state._salesFromMain = true; showScreen("scrSales"); };
    $("goSettings").onclick = ()=> showScreen("scrSettings");

    function openMoveHome(){ toast("å¸­ç§»å‹•ï¼ˆPART2ã§å®Ÿè£…ï¼‰"); }

    (function init(){
      seedSeatsIfEmpty();
      normalizeAllSeats();   // â­è¿½åŠ ï¼šå½¢ã‚†ã‚Œå¸å
      setSync(true);
      renderSeats();
      showScreen("scrMain");
    })();

    /* =========================
      ã“ã“ã§ã¯é–‰ã˜ãªã„ã€‚PART2ã¸ç¶šã
    ========================= */
/* =========================
  PART2ï¼šæ³¨æ–‡ï¼ˆæœ¬æ¥ã®æ§‹æˆã«å¾©å…ƒï¼‰ï¼‹å¸­ã‚¿ãƒƒãƒ—å‹•ç·šï¼ˆç©ºå¸­/äºˆç´„/æ¥åº—/åˆæµï¼‰ï¼‹å¸­ç§»å‹•ï¼ˆå¾©æ´»ï¼‰
  ä»Šå›ã®ä¿®æ­£ç‚¹ï¼š
   - ã€Œä¼šè¨ˆç¢ºå®šãŒåå¿œã—ãªã„ã€ã‚’ä¿®æ­£ï¼ˆcoConfirm ã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’ç¢ºå®Ÿã«ãƒã‚¤ãƒ³ãƒ‰ï¼‰
========================= */


/* =========================================================
   0) è»½ã„ã‚ºãƒ¼ãƒ æŠ‘æ­¢ï¼ˆdblclickã®ã¿ï¼‰
========================================================= */
(function preventDoubleTapZoomSafe(){
  if(preventDoubleTapZoomSafe._done) return;
  preventDoubleTapZoomSafe._done = true;

  document.addEventListener("dblclick", function(e){
    const t = e.target;
    if(
      t && t.closest &&
      (
        t.closest("input,textarea,select,button,[contenteditable='true'],label") ||
        t.closest("#modalBackdrop,.modal,.modalCard,.sheet,.dialog,.overlay,.modalMask,[role='dialog']")
      )
    ){
      return;
    }
    if(e.cancelable) e.preventDefault();
  }, {passive:false});
})();


/* =========================================================
   1) æ³¨æ–‡UIï¼ˆIDè¡çªã—ãªã„ç‰ˆï¼‰
========================================================= */
(function buildOrderUI_v3(){
  if(buildOrderUI_v3._built) return;
  buildOrderUI_v3._built = true;

  const scr = $("scrOrder");
  scr.innerHTML = `
    <div style="display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:10px">
      <div style="font-weight:1000; font-size:22px">æ³¨æ–‡</div>
      <div style="font-weight:1000; opacity:.9" id="orderSeatLabel"></div>
      <button class="btn lime" id="orderGoPay">ä¼šè¨ˆ</button>
    </div>

    <div style="display:flex; gap:10px; margin-bottom:10px">
      <button class="btn" id="orderCatFood" style="flex:1">æ–™ç†</button>
      <button class="btn" id="orderCatDrink" style="flex:1">ãƒ‰ãƒªãƒ³ã‚¯</button>
      <button class="btn" id="orderBackMain" style="flex:1">æˆ»ã‚‹</button>
    </div>

    <div id="orderGenreWrap" style="display:none; margin-bottom:12px">
      <div class="seatGrid" id="orderGenreGrid"></div>
    </div>

    <div id="orderItemsWrap" style="display:none; margin-bottom:12px">
      <div style="display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:10px">
        <div style="font-weight:1000; font-size:20px" id="orderPickedGenre"></div>
        <button class="btn" id="orderItemsBack">æˆ»ã‚‹</button>
      </div>
      <div class="seatGrid" id="orderItemsGrid"></div>
    </div>

    <div style="margin-top:10px">
      <div style="font-weight:1000; margin-bottom:8px; font-size:20px">æ³¨æ–‡å±¥æ­´</div>
      <div id="orderHistory"></div>
    </div>
  `;
})();


/* =========================================================
   2) æ³¨æ–‡ãƒ‡ãƒ¼ã‚¿ï¼ˆè¶³ã™ã ã‘ï¼‰
========================================================= */
function getOrderBucket(seat, subId){
  if(seat.merged){
    const b = ensureSub(seat, subId);
    b.orders = b.orders || [];
    b.orderLog = b.orderLog || [];
    return b;
  }
  seat.orders = seat.orders || [];
  seat.orderLog = seat.orderLog || [];
  return seat;
}

function upsertOrderAgg(bucket, item, delta){
  let o = (bucket.orders||[]).find(x=> x.itemId===item.id);
  const d = Number(delta||0);

  if(!o){
    if(d <= 0) return;
    bucket.orders.push({ itemId:item.id, name:item.name, price:item.price, tax:item.tax, qty:d, cat:item.cat, genre:item.genre });
    return;
  }
  o.qty = Number(o.qty||0) + d;
  if(o.qty <= 0){
    bucket.orders = bucket.orders.filter(x=> x.itemId!==item.id);
  }
}

function pushOrderLog(bucket, item, delta, reason){
  bucket.orderLog = bucket.orderLog || [];
  bucket.orderLog.unshift({
    id: "ol_" + Math.random().toString(36).slice(2),
    ts: nowTs(),
    itemId: item.id,
    name: item.name,
    delta: Number(delta||0),
    reason: reason || "",
  });
}

function formatHM(ts){
  const d = new Date(ts);
  return `${pad2(d.getHours())}:${pad2(d.getMinutes())}`;
}


/* =========================================================
   3) æ³¨æ–‡çŠ¶æ…‹
========================================================= */
state.order = state.order || { seatId:null, subId:null, cat:null, genre:null };


/* =========================================================
   4) æ³¨æ–‡ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
========================================================= */
function setBtnHL(btn, on){
  btn.classList.toggle("lime", !!on);
}

function listGenresByCat(cat){
  return (state.menu?.genres?.[cat] || []).slice();
}

function listItemsBy(cat, genre){
  return (state.menu?.items || []).filter(it=> it.cat===cat && it.genre===genre);
}

function renderOrder_v3(){
  const seat = seatById(state.order.seatId);
  if(!seat){ showScreen("scrMain"); return; }

  const subId = state.order.subId || seat.id;
  $("orderSeatLabel").textContent = seat.merged ? `${seat.mergeLabel} / ${subId}` : `${seat.id}`;

  $("orderGoPay").onclick = ()=> openCheckout();

  $("orderBackMain").onclick = ()=>{
    state.order.cat = null;
    state.order.genre = null;
    showScreen("scrMain");
  };

  const foodBtn = $("orderCatFood");
  const drinkBtn = $("orderCatDrink");

  foodBtn.onclick = ()=> toggleCat("food");
  drinkBtn.onclick = ()=> toggleCat("drink");

  function toggleCat(cat){
    if(state.order.cat === cat){
      state.order.cat = null;
      state.order.genre = null;
      renderOrder_v3();
      return;
    }
    state.order.cat = cat;
    state.order.genre = null;
    renderOrder_v3();
  }

  setBtnHL(foodBtn, state.order.cat==="food");
  setBtnHL(drinkBtn, state.order.cat==="drink");

  const gw = $("orderGenreWrap");
  const gg = $("orderGenreGrid");
  const iw = $("orderItemsWrap");
  const ig = $("orderItemsGrid");

  gg.innerHTML = "";
  ig.innerHTML = "";

  if(!state.order.cat){
    gw.style.display = "none";
    iw.style.display = "none";
  }else{
    const genres = listGenresByCat(state.order.cat);
    gw.style.display = "block";
    iw.style.display = "none";

    if(genres.length===0){
      gg.innerHTML = `<div class="panel muted">ã‚¸ãƒ£ãƒ³ãƒ«ãŒã‚ã‚Šã¾ã›ã‚“ã€‚å…ˆã«ãƒ¡ãƒ‹ãƒ¥ãƒ¼ç™»éŒ²ã‚’ã—ã¦ãã ã•ã„ã€‚</div>`;
    }else{
      genres.forEach(g=>{
        const b = document.createElement("div");
        b.className = "seatCard";
        b.style.minHeight="66px";
        b.style.display="flex";
        b.style.alignItems="center";
        b.style.justifyContent="center";
        b.style.fontWeight="1000";
        b.style.fontSize="18px";
        b.textContent = g;
        b.onclick = ()=>{
          state.order.genre = g;
          renderOrder_v3();
        };
        gg.appendChild(b);
      });
    }
  }

  if(state.order.cat && state.order.genre){
    gw.style.display = "none";
    iw.style.display = "block";
    $("orderPickedGenre").textContent = state.order.genre;

    $("orderItemsBack").onclick = ()=>{
      state.order.genre = null;
      renderOrder_v3();
    };

    const items = listItemsBy(state.order.cat, state.order.genre);
    if(items.length===0){
      ig.innerHTML = `<div class="panel muted">ã“ã®ã‚¸ãƒ£ãƒ³ãƒ«ã«å•†å“ãŒã‚ã‚Šã¾ã›ã‚“</div>`;
    }else{
      items.forEach(it=>{
        const c = document.createElement("div");
        c.className = "seatCard";
        c.style.minHeight="96px";
        c.style.display="flex";
        c.style.flexDirection="column";
        c.style.justifyContent="space-between";
        c.innerHTML = `
          <div style="font-weight:1000; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; font-size:18px">${it.name}</div>
          <div style="opacity:.9; font-weight:1000; font-size:18px">${yen(it.price)}</div>
        `;
        c.onclick = ()=> openOrderDeltaModal_v3(seat, subId, it);
        ig.appendChild(c);
      });
    }
  }

  renderOrderHistory_v3(seat, subId);
}

function openOrderDeltaModal_v3(seat, subId, item){
  const bucket = getOrderBucket(seat, subId);
  let delta = 0;

  openModal(
    "æ³¨æ–‡",
    `
      <div style="font-weight:1000; font-size:20px; margin-bottom:10px">${item.name}</div>
      <div class="muted" style="margin-bottom:14px">${yen(item.price)} / ç¨${item.tax}%</div>

      <div style="display:flex; align-items:center; justify-content:center; gap:12px; margin-bottom:14px">
        <button class="btn" id="odMinus" style="min-width:72px">â—€ï¸</button>
        <div class="pill" id="odVal" style="min-width:120px">0</div>
        <button class="btn lime" id="odPlus" style="min-width:72px">â–¶ï¸</button>
      </div>

      <div class="muted">â€» è¿½åŠ ã™ã‚‹æ•°ã‚’é¸ã‚“ã§ãã ã•ã„ï¼ˆ0ãªã‚‰è¿½åŠ ãªã—ï¼‰</div>
    `,
    [
      {label:"æˆ»ã‚‹", lime:false, onClick:()=> closeModal()},
      {label:"æ±ºå®š", lime:true, onClick:()=>{
        if(delta===0){ closeModal(); return; }

        upsertOrderAgg(bucket, item, delta);
        pushOrderLog(bucket, item, delta, "è¿½åŠ ");

        seat.status = "in";
        seat.people = Math.max(1, Number(seat.people||1));
        seat.bills = 1;

        const sum = calcOrdersTotal(bucket.orders || []);
        if(seat.merged){
          bucket.total = sum;
          seat.total = calcSeatTotal(seat);
        }else{
          seat.total = sum;
        }

        if(typeof emitEvent==="function") emitEvent("order_delta", {seatId: seat.id, subId, itemId: item.id, delta});

        closeModal();
        renderSeats();
        renderOrder_v3();
      }},
    ],
    seat.id
  );

  setTimeout(()=>{
    const setVal = ()=> $("odVal").textContent = String(delta);

    $("odMinus").onclick = ()=>{
      if(delta<=0) return;
      delta -= 1;
      setVal();
    };
    $("odPlus").onclick = ()=>{
      delta += 1;
      setVal();
    };

    setVal();
  },0);
}

function renderOrderHistory_v3(seat, subId){
  const bucket = getOrderBucket(seat, subId);
  const box = $("orderHistory");
  box.innerHTML = "";

  const agg = (bucket.orders || []).slice().sort((a,b)=> (b.qty||0) - (a.qty||0));
  if(agg.length===0){
    box.innerHTML = `<div class="panel muted">ã¾ã ã‚ã‚Šã¾ã›ã‚“</div>`;
    return;
  }

  agg.forEach(a=>{
    const row = document.createElement("div");
    row.style.border = "none";
    row.style.borderRadius = "26px";
    row.style.padding = "12px";
    row.style.background = "var(--panel)";
    row.style.marginBottom = "10px";

    row.innerHTML = `
      <div style="display:flex; justify-content:space-between; gap:10px; align-items:center">
        <div style="min-width:0">
          <div style="font-weight:1000; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; font-size:18px">${a.name} Ã— ${a.qty}</div>
          <div class="muted" style="margin-top:4px; font-weight:1000; font-size:18px">${yen((Number(a.price||0) * Number(a.qty||0)))}</div>
        </div>
        <button class="btn" data-hfix="${a.itemId}">ä¿®æ­£</button>
      </div>
    `;
    box.appendChild(row);

    row.querySelector(`[data-hfix="${a.itemId}"]`).onclick = ()=>{
      openHistoryConfirm_v3(seat, subId, a.itemId);
    };
  });
}


/* =========================================================
   5) å±¥æ­´ â†’ ç¢ºèª â†’ ä¿®æ­£
========================================================= */
const ORDER_FIX_REASONS = ["æœªæä¾›","æ•°ãˆé–“é•ã„","æ³¨æ–‡å–ã‚Šé•ã„","æä¾›æ¸ˆã¿å–æ¶ˆ","ãã®ä»–"];

function openHistoryConfirm_v3(seat, subId, itemId){
  const bucket = getOrderBucket(seat, subId);
  const agg = (bucket.orders || []).find(x=> x.itemId===itemId);
  if(!agg) return;

  const logs = (bucket.orderLog || []).filter(l=> l.itemId===itemId).slice(0, 8);
  const lines = logs.map(l=>`
    <div style="display:flex; justify-content:space-between; gap:10px; padding:8px 0; border-bottom:1px solid rgba(0,0,0,0.08)">
      <div class="muted">${formatHM(l.ts)}</div>
      <div style="font-weight:1000">${l.name}</div>
      <div style="font-weight:1000">${l.delta>0?`+${l.delta}`:String(l.delta)}</div>
    </div>
  `).join("");

  openModal(
    "ä¿®æ­£ç¢ºèª",
    `
      <div style="font-weight:1000; font-size:18px; margin-bottom:8px">${agg.name} Ã— ${agg.qty}</div>
      <div class="muted" style="margin-bottom:10px">æ³¨æ–‡å±¥æ­´</div>
      <div>${lines || `<div class="panel muted">å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“</div>`}</div>
      <div style="height:10px"></div>
      <div style="font-weight:1000">ä¿®æ­£ã—ã¾ã™ã‹ï¼Ÿ</div>
    `,
    [
      {label:"æˆ»ã‚‹", lime:false, onClick:()=> closeModal()},
      {label:"ä¿®æ­£", lime:true, onClick:()=>{
        closeModal();
        openHistoryFix_v3(seat, subId, itemId);
      }},
    ],
    seat.id
  );
}

function openHistoryFix_v3(seat, subId, itemId){
  const bucket = getOrderBucket(seat, subId);
  const agg = (bucket.orders || []).find(x=> x.itemId===itemId);
  if(!agg) return;

  let delta = 0;

  openModal(
    "ä¿®æ­£",
    `
      <div style="font-weight:1000; font-size:20px; margin-bottom:8px">${agg.name}</div>
      <div class="muted" style="margin-bottom:12px">ç¾åœ¨ï¼š${agg.qty}</div>

      <div style="margin-bottom:8px; font-weight:1000">ç†ç”±ï¼ˆå¿…é ˆï¼‰</div>
      <select id="ofWhy" class="btn full" style="text-align:left">
        <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
        ${ORDER_FIX_REASONS.map(x=> `<option value="${x}">${x}</option>`).join("")}
      </select>

      <div style="margin-top:14px; font-weight:1000; margin-bottom:8px">å¤‰æ›´ï¼ˆå·®åˆ†ï¼‰</div>
      <div style="display:flex; align-items:center; justify-content:center; gap:12px; margin-bottom:10px">
        <button class="btn" id="ofMinus" style="min-width:72px">â—€ï¸</button>
        <div class="pill" id="ofVal" style="min-width:140px">0</div>
        <button class="btn lime" id="ofPlus" style="min-width:72px">â–¶ï¸</button>
      </div>

      <div class="muted">â€» åˆè¨ˆãŒ0æœªæº€ã«ã¯ã§ãã¾ã›ã‚“</div>
    `,
    [
      {label:"æˆ»ã‚‹", lime:false, onClick:()=> closeModal()},
      {label:"æ±ºå®š", lime:true, onClick:()=>{
        const reason = $("ofWhy").value || "";
        if(!reason){ toast("ç†ç”±ã‚’é¸æŠã—ã¦ãã ã•ã„"); return; }

        const after = Number(agg.qty||0) + Number(delta||0);
        if(after < 0){ toast("0æœªæº€ã«ã¯ã§ãã¾ã›ã‚“"); return; }

        const item = { id: agg.itemId, name: agg.name, price: agg.price, tax: agg.tax, cat: agg.cat, genre: agg.genre };
        upsertOrderAgg(bucket, item, delta);
        pushOrderLog(bucket, item, delta, reason);

        const sum = calcOrdersTotal(bucket.orders || []);
        if(seat.merged){
          bucket.total = sum;
          seat.total = calcSeatTotal(seat);
        }else{
          seat.total = sum;
        }

        if(typeof emitEvent==="function") emitEvent("order_fix", {seatId: seat.id, subId, itemId, delta, reason});

        closeModal();
        renderSeats();
        renderOrder_v3();
        toast("ä¿®æ­£ã—ã¾ã—ãŸ");
      }},
    ],
    seat.id
  );

  setTimeout(()=>{
    const setVal = ()=>{
      const s = delta>0 ? `+${delta}` : String(delta);
      $("ofVal").textContent = s;
    };

    $("ofMinus").onclick = ()=>{
      const cur = Number(agg.qty||0) + delta;
      if(cur <= 0) return;
      delta -= 1;
      setVal();
    };
    $("ofPlus").onclick = ()=>{
      delta += 1;
      setVal();
    };

    setVal();
  },0);
}


/* =========================================================
   6) å¸­ã‚¿ãƒƒãƒ—å‹•ç·š
========================================================= */
function openOrderFor_v3(seatId, subId){
  state.order.seatId = seatId;
  state.order.subId = subId || seatId;
  state.order.cat = null;
  state.order.genre = null;
  showScreen("scrOrder");
  renderOrder_v3();
}

function openEmptyAction_v3(seat){
  openModal(
    "ç©ºå¸­",
    `<div class="muted" style="margin-bottom:10px">æ¥åº— / äºˆç´„ ã‚’é¸æŠã—ã¦ãã ã•ã„</div>`,
    [
      {label:"æ¥åº—", lime:true, onClick:()=>{
        closeModal();
        seat.status = "in";
        seat.people = Math.max(1, Number(seat.people||1));
        seat.bills = 1;
        seat.name = seat.name || "";
        seat.total = Number(seat.total||0);
        seat.reserve = null;
        seat.merged = false;
        seat.mergeLabel = "";
        seat.sub = null;

        if(typeof emitEvent==="function") emitEvent("seat_in", {seatId: seat.id});
        renderSeats();
        openOrderFor_v3(seat.id, seat.id);
      }},
      {label:"äºˆç´„", lime:false, onClick:()=>{
        closeModal();
        openReserveInput_v3(seat);
      }},
      {label:"æˆ»ã‚‹", lime:false, onClick:()=> closeModal()},
    ],
    seat.id
  );
}

function openReserveInput_v3(seat){
  openModal(
    "äºˆç´„å…¥åŠ›",
    `
      <div style="margin-bottom:8px; font-weight:1000">æ¥åº—æ™‚é–“</div>
      <input id="rTime" class="btn full" style="text-align:left" placeholder="ä¾‹ï¼š18:30" inputmode="text" autocomplete="off" />

      <div style="margin-top:12px;margin-bottom:8px; font-weight:1000">åå‰</div>
      <input id="rName" class="btn full" style="text-align:left" placeholder="ä¾‹ï¼šä½è—¤" inputmode="text" autocomplete="off" />

      <div style="margin-top:12px;margin-bottom:8px; font-weight:1000">é€£çµ¡å…ˆ</div>
      <input id="rTel" class="btn full" style="text-align:left" placeholder="é›»è©± / ãƒ¡ãƒ¢" inputmode="text" autocomplete="off" />
    `,
    [
      {label:"ä¿å­˜", lime:true, onClick:()=>{
        const time = ($("rTime").value||"").trim();
        const name = ($("rName").value||"").trim();
        const tel  = ($("rTel").value||"").trim();

        if(!time || !name){ toast("æœªè¨˜å…¥ãŒã‚ã‚Šã¾ã™"); return; }

        seat.status = "reserve";
        seat.people = Math.max(1, Number(seat.people||1));
        seat.reserve = { time, name, tel, note:"" };
        seat.name = "";
        seat.total = 0;
        seat.bills = 0;

        if(typeof emitEvent==="function") emitEvent("reserve_set", {seatId: seat.id, time, name, tel});

        closeModal();
        renderSeats();
        toast("äºˆç´„ã‚’ä¿å­˜ã—ã¾ã—ãŸ");
      }},
      {label:"æˆ»ã‚‹", lime:false, onClick:()=> closeModal()},
    ],
    seat.id
  );
}

function openReserveAction_v3(seat){
  const r = seat.reserve || {};
  openModal(
    "äºˆç´„",
    `
      <div style="margin-bottom:6px; font-weight:1000">æ™‚é–“ï¼š${r.time||""}</div>
      <div style="margin-bottom:6px; font-weight:1000">åå‰ï¼š${r.name||""}</div>
      <div class="muted" style="font-weight:1000">é€£çµ¡å…ˆï¼š${r.tel||""}</div>
    `,
    [
      {label:"æ¥åº—", lime:true, onClick:()=>{
        closeModal();
        seat.status = "in";
        seat.name = r.name || "";
        seat.bills = 1;
        seat.total = Number(seat.total||0);
        seat.reserve = null;

        if(typeof emitEvent==="function") emitEvent("reserve_to_in", {seatId: seat.id});
        renderSeats();
        openOrderFor_v3(seat.id, seat.id);
      }},
      {label:"æˆ»ã‚‹", lime:false, onClick:()=> closeModal()},
    ],
    seat.id
  );
}

function openMergedPick_v3(seat){
  const subs = Object.values(seat.sub||{});
  if(subs.length<=1){
    openOrderFor_v3(seat.id, seat.id);
    return;
  }

  const buttons = subs.map(su=>({
    label: su.seatId,
    lime:true,
    onClick:()=>{
      closeModal();
      openOrderFor_v3(seat.id, su.seatId);
    }
  }));
  buttons.push({label:"æˆ»ã‚‹", lime:false, onClick:()=> closeModal()});

  openModal("ã©ã¡ã‚‰ã®æ³¨æ–‡ã€ä¼šè¨ˆã‚’ã—ã¾ã™ã‹ï¼Ÿ", `<div class="muted">å¸­ã‚’é¸æŠã—ã¦ãã ã•ã„</div>`, buttons, seat.id);
}

onSeatTap = function(seatId){
  const seat = seatById(seatId);
  if(!seat) return;

  if(seat.status==="empty"){ openEmptyAction_v3(seat); return; }
  if(seat.status==="reserve"){ openReserveAction_v3(seat); return; }

  if(seat.merged){ openMergedPick_v3(seat); return; }

  openOrderFor_v3(seat.id, seat.id);
};


/* =========================================================
   7) æ³¨æ–‡ç”»é¢ãƒ•ãƒƒã‚¯
========================================================= */
registerScreenHook("scrOrder", ()=>{
  try{ renderOrder_v3(); } catch(e){ console.warn(e); }
});


/* =========================
  Checkout (PART2)
  â€»ä»Šå›ï¼šä¼šè¨ˆç¢ºå®šãŒåŠ¹ã‹ãªã„å•é¡Œã ã‘ä¿®æ­£
========================= */

state.checkout = state.checkout || { method:null, splitN:1 };

function moneyText(n){
  return "Â¥" + Number(n||0).toLocaleString("ja-JP");
}

function getCheckoutTarget(){
  const seat = seatById(state.order.seatId);
  if(!seat) return null;

  let target = seat;
  if(seat.merged){
    const subId = state.order.subId || seat.id;
    target = ensureSub(seat, subId);
    target._parentSeat = seat;
  }
  return target;
}

function calcTargetTotal(target){
  return Number(target.total || 0);
}

function setPayBtnHL(){
  const m = state.checkout.method;
  const on = (id, flag)=> $(id)?.classList.toggle("lime", !!flag);

  on("coPayCash", m==="cash");
  on("coPayCard", m==="card");
  on("coPayQR",   m==="qr");

  $("coPaySelected").textContent =
    m==="cash" ? "ç¾é‡‘" : m==="card" ? "ã‚«ãƒ¼ãƒ‰" : m==="qr" ? "QR" : "æœªé¸æŠ";
}

function renderCheckout(){
  const target = getCheckoutTarget();
  if(!target){ toast("ä¼šè¨ˆå¯¾è±¡ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"); showScreen("scrMain"); return; }

  const total = calcTargetTotal(target);
  $("coTotal").textContent = moneyText(total);

  const n = Math.max(1, Number(state.checkout.splitN||1));
  state.checkout.splitN = n;
  $("coSplitN").textContent = String(n);
  $("coPer").textContent = moneyText(Math.ceil(total / n));

  setPayBtnHL();

  $("coSendReceipt").disabled = true;
}

function openCheckout(){
  showScreen("scrCheckout");
  setTimeout(()=>{
    try{ bindCheckoutOnce(); }catch(e){}
    try{ renderCheckout(); }catch(e){}
  }, 0);
}

function finalizeCheckout(){
  const target = getCheckoutTarget();
  if(!target){ toast("ä¼šè¨ˆå¯¾è±¡ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"); showScreen("scrMain"); return; }

  if(!state.checkout.method){
    toast("æ”¯æ‰•ã„æ–¹æ³•ã‚’é¸ã‚“ã§ãã ã•ã„");
    return;
  }

  const total = calcTargetTotal(target);
  const splitN = Math.max(1, Number(state.checkout.splitN||1));
  const method = state.checkout.method;

  state.sales = state.sales || [];
  state.sales.push({
    ts: nowTs(),
    type: "checkout",
    seatId: target.seatId || target.id || state.order.seatId,
    parentSeatId: (target._parentSeat && target._parentSeat.id) ? target._parentSeat.id : null,
    total,
    splitN,
    method,
    receiptEmail: ($("coEmail") && $("coEmail").value) ? $("coEmail").value.trim() : ""
  });

  if(target._parentSeat){
    const seat = target._parentSeat;
    seat.status = "empty";
    seat.people = 0;
    seat.name = "";
    seat.total = 0;
    seat.bills = 0;
    seat.merged = false;
    seat.mergeLabel = "";
    seat.sub = null;
    seat.reserve = null;
  }else{
    const seat = target;
    seat.status = "empty";
    seat.people = 0;
    seat.name = "";
    seat.total = 0;
    seat.bills = 0;
    seat.reserve = null;
  }

  state.checkout.method = null;
  state.checkout.splitN = 1;

  if(typeof persistAll === "function") persistAll();
  renderSeats();
  toast("ä¼šè¨ˆã‚’ç¢ºå®šã—ã¾ã—ãŸ");
  showScreen("scrMain");
}

/* ===== Checkout hook ===== */
registerScreenHook("scrCheckout", ()=>{
  try{ renderCheckout(); }catch(e){ console.warn(e); }
  try{ bindCheckoutOnce(); }catch(e){ console.warn(e); }
});

/* ===== ã“ã“ãŒä»Šå›ã®ä¿®æ­£ã®æœ¬ä½“ï¼šç¢ºå®Ÿã«ãƒã‚¤ãƒ³ãƒ‰ã™ã‚‹ ===== */
function bindCheckoutOnce(){

  // å€™è£œIDï¼ˆã©ã‚Œã‹å½“ãŸã‚Œã°OKï¼‰
  const pick = (ids)=> ids.map(id=> $(id)).find(el=> !!el);

  const payCash   = pick(["coPayCash"]);
  const payCard   = pick(["coPayCard"]);
  const payQR     = pick(["coPayQR"]);
  const splitMinus= pick(["coSplitMinus"]);
  const splitPlus = pick(["coSplitPlus"]);
  const backBtn   = pick(["coBack"]);
  const confirmBtn= pick(["coConfirm","coCommit","coFinalize","coDone"]); // â˜…ä¿é™º
  const sendBtn   = pick(["coSendReceipt"]);

  // DOMãŒã¾ã ç„¡ã„ï¼ˆæ—©ã™ãã‚‹ï¼‰å ´åˆã¯å°‘ã—å¾…ã£ã¦ãƒªãƒˆãƒ©ã‚¤
  if(!(payCash && payCard && payQR && splitMinus && splitPlus && backBtn && confirmBtn && sendBtn)){
    setTimeout(bindCheckoutOnce, 50);
    return;
  }

  payCash.onclick = ()=>{ state.checkout.method="cash"; setPayBtnHL(); };
  payCard.onclick = ()=>{ state.checkout.method="card"; setPayBtnHL(); };
  payQR.onclick   = ()=>{ state.checkout.method="qr";   setPayBtnHL(); };

  splitMinus.onclick = ()=>{
    state.checkout.splitN = Math.max(1, Number(state.checkout.splitN||1) - 1);
    renderCheckout();
  };
  splitPlus.onclick = ()=>{
    state.checkout.splitN = Math.max(1, Number(state.checkout.splitN||1) + 1);
    renderCheckout();
  };

  backBtn.onclick = ()=> showScreen("scrOrder");

  // â˜…ä¼šè¨ˆç¢ºå®šï¼šç¢ºå®Ÿã«ã“ã“ãŒå‹•ã
  confirmBtn.onclick = ()=>{
    // æŠ¼ã›ãŸã‹åˆ†ã‹ã‚‹ã‚ˆã†ã«ä¿é™ºãƒˆãƒ¼ã‚¹ãƒˆï¼ˆã„ã‚‰ãªã‘ã‚Œã°å¾Œã§æ¶ˆã—ã¦OKï¼‰
    // toast("ä¼šè¨ˆç¢ºå®šï¼šæŠ¼ã›ãŸ");
    finalizeCheckout();
  };

  sendBtn.onclick = ()=> toast("ç„¡æ–™ç‰ˆã¯é€ä¿¡ã§ãã¾ã›ã‚“ï¼ˆæœ‰æ–™ç‰ˆï¼‰");
  }

// hookãŒå‹•ã‹ãªã„ç’°å¢ƒã§ã‚‚ä¿é™ºã§ä¸€åº¦ã ã‘èµ°ã‚‰ã›ã‚‹
setTimeout(bindCheckoutOnce, 0);


/* =========================================================
   8) å¸­ç§»å‹•ï¼ˆå¾©æ´»ï¼‰
========================================================= */
(function reviveSeatMove_v1(){
  if(reviveSeatMove_v1._done) return;
  reviveSeatMove_v1._done = true;

  function allSeatsArray(){
    const s = state.seats;
    if(!s) return [];
    if(Array.isArray(s)) return s.slice();
    try{ return Object.values(s); }catch(e){ return []; }
  }

  function safeSeatId(seat){
    return (seat && (seat.id || seat.seatId || "")) + "";
  }

  function seatSortKey(id){
    const t = String(id||"").trim();
    const m = t.match(/^([A-Za-z]+)?\s*0*([0-9]+)?$/);
    if(m){
      const a = (m[1]||"").toUpperCase();
      const n = m[2] ? Number(m[2]) : -1;
      return `${a.padEnd(4,"~")}_${String(n).padStart(6,"0")}_${t}`;
    }
    return `~~~~_${t}`;
  }

  function pickSeatGridHtml(seats, selectedId, dataKey){
    const cards = seats.map(seat=>{
      const id = safeSeatId(seat);
      const sel = (id===selectedId);
      const label = id || "(?)";
      const st = seat.status || "empty";
      const badge =
        st==="empty" ? `ç©ºå¸­` :
        st==="reserve" ? `äºˆç´„` :
        seat.merged ? `åˆæµ` :
        `æ¥åº—`;

      return `
        <div class="seatCard" data-${dataKey}="${id}"
             style="min-height:76px; display:flex; flex-direction:column; justify-content:center; align-items:center; gap:6px;
                    ${sel ? "background:rgba(100,178,108,0.18);" : ""}">
          <div style="font-size:22px; font-weight:1000">${label}</div>
          <div class="muted" style="font-weight:1000">${badge}</div>
        </div>
      `;
    }).join("");

    return `<div class="seatGrid">${cards}</div>`;
  }

  function cloneSeatPayload(seat){
    return {
      status: seat.status || "empty",
      people: Number(seat.people||0),
      name: seat.name || "",
      bills: Number(seat.bills||0),
      total: Number(seat.total||0),
      orders: Array.isArray(seat.orders) ? JSON.parse(JSON.stringify(seat.orders)) : [],
      orderLog: Array.isArray(seat.orderLog) ? JSON.parse(JSON.stringify(seat.orderLog)) : [],
      reserve: seat.reserve ? JSON.parse(JSON.stringify(seat.reserve)) : null,
      merged: !!seat.merged,
      mergeLabel: seat.mergeLabel || "",
      sub: seat.sub ? JSON.parse(JSON.stringify(seat.sub)) : null,
    };
  }

  function resetSeatToEmpty(seat){
    seat.status="empty";
    seat.people=0;
    seat.name="";
    seat.bills=0;
    seat.total=0;
    seat.orders=[];
    seat.orderLog=[];
    seat.reserve=null;
    seat.merged=false;
    seat.mergeLabel="";
    seat.sub=null;
  }

  function ensureMergedContainer(target){
    if(target.merged){
      target.sub = target.sub || {};
      return;
    }
    const keep = cloneSeatPayload(target);
    target.merged = true;
    target.mergeLabel = target.mergeLabel || (target.id || "");
    target.sub = target.sub || {};

    const selfId = (target.id || "");
    target.sub[selfId] = target.sub[selfId] || { seatId: selfId, orders: [], orderLog: [], total: 0 };

    target.sub[selfId].orders = keep.orders || [];
    target.sub[selfId].orderLog = keep.orderLog || [];
    target.sub[selfId].total = calcOrdersTotal(keep.orders || []);
    target.total = calcSeatTotal(target);
  }

  function moveSeat(fromSeat, toSeat){
    const payload = cloneSeatPayload(fromSeat);
    if((toSeat.status||"empty")!=="empty"){
      toast("ç§»å‹•å…ˆã¯ç©ºå¸­ã ã‘ã«ã—ã¦ãã ã•ã„");
      return false;
    }
    toSeat.status = payload.status;
    toSeat.people = payload.people;
    toSeat.name = payload.name;
    toSeat.bills = payload.bills;
    toSeat.total = payload.total;
    toSeat.orders = payload.orders || [];
    toSeat.orderLog = payload.orderLog || [];
    toSeat.reserve = payload.reserve;
    toSeat.merged = !!payload.merged;
    toSeat.mergeLabel = payload.mergeLabel || "";
    toSeat.sub = payload.sub;

    resetSeatToEmpty(fromSeat);
    return true;
  }

  function mergeSeat(fromSeat, toSeat){
    if((fromSeat.status||"empty")!=="in"){
      toast("åˆæµå…ƒã¯ã€Œæ¥åº—ä¸­ã€ã®å¸­ã ã‘ã«ã—ã¦ãã ã•ã„");
      return false;
    }
    if(fromSeat.merged){
      toast("åˆæµå…ƒãŒåˆæµå¸­ã¯æœªå¯¾å¿œï¼ˆã¾ãšåˆ†é›¢ã—ã¦ã‹ã‚‰ï¼‰");
      return false;
    }
    if((toSeat.status||"empty")==="empty" || (toSeat.status||"empty")==="reserve"){
      toast("åˆæµå…ˆã¯ã€Œæ¥åº—ä¸­ã€ã‹ã€Œåˆæµå¸­ã€ã‚’é¸ã‚“ã§ãã ã•ã„");
      return false;
    }

    ensureMergedContainer(toSeat);

    const fromId = fromSeat.id || "";
    toSeat.sub = toSeat.sub || {};
    toSeat.sub[fromId] = toSeat.sub[fromId] || { seatId: fromId, orders: [], orderLog: [], total: 0 };
    toSeat.sub[fromId].orders = Array.isArray(fromSeat.orders) ? JSON.parse(JSON.stringify(fromSeat.orders)) : [];
    toSeat.sub[fromId].orderLog = Array.isArray(fromSeat.orderLog) ? JSON.parse(JSON.stringify(fromSeat.orderLog)) : [];
    toSeat.sub[fromId].total = calcOrdersTotal(toSeat.sub[fromId].orders || []);

    toSeat.total = calcSeatTotal(toSeat);
    resetSeatToEmpty(fromSeat);
    return true;
  }

  window.openMoveHome = function openMoveHome(){
    const seats = allSeatsArray()
      .filter(s=> !!safeSeatId(s))
      .sort((a,b)=> seatSortKey(safeSeatId(a)).localeCompare(seatSortKey(safeSeatId(b))));

    if(seats.length===0){
      toast("å¸­ãŒã‚ã‚Šã¾ã›ã‚“ï¼ˆå¸­ç™»éŒ²ã‚’å…ˆã«ï¼‰");
      return;
    }

    let mode = "move";
    let fromId = "";
    let toId = "";

    function renderBody(){
      const fromList = seats.filter(s=>{
        const st = s.status || "empty";
        if(mode==="move"){
          return st !== "empty";
        }
        return st === "in" && !s.merged;
      });

      const toList = seats.filter(s=>{
        const st = s.status || "empty";
        if(mode==="move"){
          return st === "empty";
        }
        return st === "in" || !!s.merged;
      });

      const modeBtns = `
        <div style="display:flex; gap:10px; margin-bottom:12px">
          <button class="btn ${mode==="move"?"lime":""}" id="mvModeMove" style="flex:1">ç§»å‹•</button>
          <button class="btn ${mode==="merge"?"lime":""}" id="mvModeMerge" style="flex:1">åˆæµ</button>
        </div>
      `;

      const fromHtml = `
        <div style="font-weight:1000; margin-bottom:8px; font-size:18px">ã©ã“ã‹ã‚‰</div>
        ${pickSeatGridHtml(fromList, fromId, "mvfrom")}
      `;

      const toHtml = `
        <div style="height:12px"></div>
        <div style="font-weight:1000; margin-bottom:8px; font-size:18px">ã©ã“ã¸</div>
        ${pickSeatGridHtml(toList, toId, "mvto")}
      `;

      const hint = `
        <div style="height:12px"></div>
        <div class="muted">
          ${mode==="move"
            ? "â€» ç§»å‹•ï¼šç§»å‹•å…ˆã¯ç©ºå¸­ã®ã¿ï¼ˆäº‹æ•…é˜²æ­¢ï¼‰"
            : "â€» åˆæµï¼šåˆæµå…ƒã¯æ¥åº—ä¸­ã®ã¿ï¼åˆæµå…ˆã¯æ¥åº—ä¸­ or åˆæµå¸­"}
        </div>
        <div style="height:10px"></div>
        <div style="color:var(--danger); font-weight:1000; margin-bottom:8px">ã‚¹ãƒ©ã‚¤ãƒ‰ã§ç¢ºå®š</div>
        <input id="mvSlide" class="range" type="range" min="0" max="100" value="0" />
      `;

      return modeBtns + fromHtml + toHtml + hint;
    }

    openModal(
      "å¸­ç§»å‹•",
      `<div id="mvWrap">${renderBody()}</div>`,
      [{label:"æˆ»ã‚‹", lime:false, onClick:()=> closeModal()}]
    );

    function wire(){
      const wrap = $("mvWrap");
      if(!wrap) return;

      const rerender = ()=>{
        wrap.innerHTML = renderBody();
        wire();
      };

      const bm = $("mvModeMove");
      const bg = $("mvModeMerge");
      if(bm) bm.onclick = ()=>{ mode="move"; fromId=""; toId=""; rerender(); };
      if(bg) bg.onclick = ()=>{ mode="merge"; fromId=""; toId=""; rerender(); };

      wrap.querySelectorAll("[data-mvfrom]").forEach(el=>{
        el.onclick = ()=>{
          fromId = el.getAttribute("data-mvfrom") || "";
          if(toId === fromId) toId = "";
          rerender();
        };
      });

      wrap.querySelectorAll("[data-mvto]").forEach(el=>{
        el.onclick = ()=>{
          toId = el.getAttribute("data-mvto") || "";
          if(fromId === toId) return;
          rerender();
        };
      });

      const sl = $("mvSlide");
      if(sl){
        sl.onchange = ()=>{
          const v = Number(sl.value||0);
          if(v < 88){ sl.value = 0; return; }

          if(!fromId || !toId){
            toast("ã€Œã©ã“ã‹ã‚‰ã€ã€Œã©ã“ã¸ã€ã‚’é¸ã‚“ã§ãã ã•ã„");
            sl.value = 0;
            return;
          }
          if(fromId === toId){
            toast("åŒã˜å¸­ã¯é¸ã¹ã¾ã›ã‚“");
            sl.value = 0;
            return;
          }

          const fromSeat = seatById(fromId);
          const toSeat = seatById(toId);
          if(!fromSeat || !toSeat){
            toast("å¸­ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");
            sl.value = 0;
            return;
          }

          let ok = false;
          if(mode==="move"){
            ok = moveSeat(fromSeat, toSeat);
          }else{
            ok = mergeSeat(fromSeat, toSeat);
          }

          if(!ok){ sl.value = 0; return; }

          closeModal();
          renderSeats();
          toast(mode==="move" ? "ç§»å‹•ã—ã¾ã—ãŸ" : "åˆæµã—ã¾ã—ãŸ");
        };
      }
    }

    setTimeout(wire, 0);
  };
})();


/* =========================
  ã“ã“ã‹ã‚‰å…ˆã¯ PART3 ã§ç¶šã
========================= */
/* =========================
  PART3ï¼šã‚­ãƒƒãƒãƒ³ï¼ˆå®Œæˆç‰ˆï¼‰
  å½¹å‰²ï¼šæœªèª¿ç†ä¸€è¦§ / åŒä¸€ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã¾ã¨ã‚ / ã‚¹ãƒ©ã‚¤ãƒ‰å®Œäº† / æä¾›æ¸ˆæŠ˜ã‚ŠãŸãŸã¿
  è¿½åŠ ï¼šæ³¨æ–‡ã‹ã‚‰ã‚­ãƒƒãƒãƒ³ã¸ç©ã‚€ï¼ˆæ–™ç†/ãƒ‰ãƒªãƒ³ã‚¯ï¼‰
========================= */

/* ===== UIå·®ã—æ›¿ãˆ ===== */
(function buildKitchenUI(){
  const scr = $("scrKitchen");
  scr.innerHTML = `
    <div style="font-weight:900; margin-bottom:10px">ã‚­ãƒƒãƒãƒ³</div>

    <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin-bottom:10px">
      <div style="opacity:.9">è¡¨ç¤ºï¼š</div>
      <button class="btn" id="kFilterFood">æ–™ç†</button>
      <button class="btn" id="kFilterDrink">ãƒ‰ãƒªãƒ³ã‚¯</button>
      <button class="btn ghost" id="kToggleDone">æä¾›æ¸ˆã‚’è¡¨ç¤º</button>
    </div>

    <div id="kList"></div>

    <div style="height:12px"></div>

    <div id="kDoneWrap" style="display:none">
      <div style="font-weight:900; margin-bottom:10px">æä¾›æ¸ˆ</div>
      <div id="kDoneList"></div>
    </div>
  `;
})();

/* ===== State ===== */
state.kitchen = state.kitchen || {
  showDone:false,
  showFood:true,
  showDrink:true,
  items: [] // {kid, ts, seatId, subId, name, qty, cat, status}
};

/* ===== æ³¨æ–‡â†’ã‚­ãƒƒãƒãƒ³ã¸ç©ã‚€ ===== */
function addKitchenFromOrder(seat, subId, item){
  // item.cat: "food" | "drink"
  const cat = item.cat || "food";
  const key = `${seat.id}__${subId}__${item.id}`;

  // åŒä¸€å•†å“ã¯ qty ã‚’ã¾ã¨ã‚ã‚‹ï¼ˆã‚­ãƒƒãƒãƒ³ã‚‚ã¾ã¨ã‚ã‚„ã™ãï¼‰
  let found = state.kitchen.items.find(x=> x._key===key && x.status==="todo");
  if(!found){
    found = {
      kid: "k_" + Math.random().toString(36).slice(2),
      _key: key,
      ts: nowTs(),
      seatId: seat.id,
      subId,
      name: item.name,
      qty: 1,
      cat,
      status:"todo"
    };
    state.kitchen.items.push(found);
  }else{
    found.qty += 1;
  }
}

/* ===== CSSï¼ˆã‚­ãƒƒãƒãƒ³å°‚ç”¨ï¼‰ ===== */
(function injectPart3Css(){
  const css = `
    .kRow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:10px;
      border:1px solid rgba(255,255,255,0.10);
      border-radius:14px;
      background:rgba(255,255,255,0.04);
      margin-bottom:10px;
    }
    .kLeft{
      min-width:0;
      display:flex;
      align-items:center;
      gap:10px;
      flex:1;
    }
    .kTime{ font-weight:900; width:56px; }
    .kSeat{ font-weight:900; width:52px; }
    .kName{
      min-width:0;
      font-weight:900;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    .kQty{
      font-weight:900;
      opacity:.85;
      margin-left:6px;
    }

    .kChild{ margin-left:18px; position:relative; }
    .kChild::before{
      content:"";
      position:absolute;
      left:-10px; top:0; bottom:0;
      width:2px;
      background:rgba(122,167,255,0.45);
      border-radius:99px;
    }
    .kChild .kRow{ background:rgba(122,167,255,0.08); }

    .kSlide{
      width:25vw;
      max-width:160px;
      min-width:110px;
      display:flex;
      align-items:center;
      gap:8px;
      justify-content:flex-end;
    }
    .kRange{ width:100%; accent-color: var(--accent); }
    .kDoneBadge{ font-size:12px; color:var(--ok); font-weight:900; }
  `;
  const st = document.createElement("style");
  st.textContent = css;
  document.head.appendChild(st);
})();

/* ===== Helpers ===== */
function hhmm(ts){
  const d = new Date(ts);
  return `${pad2(d.getHours())}:${pad2(d.getMinutes())}`;
}
function passCategory(item){
  if(item.cat==="food" && !state.kitchen.showFood) return false;
  if(item.cat==="drink" && !state.kitchen.showDrink) return false;
  return true;
}

/* åŒä¸€ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã¾ã¨ã‚ï¼šè¦ªï¼æœ€å¤ */
function buildKitchenGroups(list){
  const map = new Map();
  list.forEach(it=>{
    const key = `${it.name}__${it.cat}`;
    if(!map.has(key)) map.set(key, []);
    map.get(key).push(it);
  });

  const groups = [];
  map.forEach(arr=>{
    arr.sort((a,b)=> a.ts-b.ts);
    groups.push(arr);
  });
  groups.sort((ga,gb)=> ga[0].ts - gb[0].ts);
  return groups;
}

/* ===== Render ===== */
function renderKitchen(){
  const todo = state.kitchen.items.filter(it=> it.status==="todo").filter(passCategory);
  const done = state.kitchen.items.filter(it=> it.status==="done").filter(passCategory);

  const listBox = $("kList");
  const doneWrap = $("kDoneWrap");
  const doneBox  = $("kDoneList");

  listBox.innerHTML = "";
  doneBox.innerHTML = "";

  const groups = buildKitchenGroups(todo);
  if(groups.length===0){
    listBox.innerHTML = `<div style="opacity:.85">æœªèª¿ç†ã¯ã‚ã‚Šã¾ã›ã‚“</div>`;
  }else{
    groups.forEach(arr=>{
      listBox.appendChild(kRowEl(arr[0], false));
      arr.slice(1).forEach(ch=>{
        const wrap = document.createElement("div");
        wrap.className = "kChild";
        wrap.appendChild(kRowEl(ch, false));
        listBox.appendChild(wrap);
      });
    });
  }

  doneWrap.style.display = state.kitchen.showDone ? "block" : "none";
  if(state.kitchen.showDone){
    const groupsD = buildKitchenGroups(done);
    if(groupsD.length===0){
      doneBox.innerHTML = `<div style="opacity:.85">æä¾›æ¸ˆã¯ã‚ã‚Šã¾ã›ã‚“</div>`;
    }else{
      groupsD.forEach(arr=>{
        doneBox.appendChild(kRowEl(arr[0], true));
        arr.slice(1).forEach(ch=>{
          const wrap = document.createElement("div");
          wrap.className = "kChild";
          wrap.appendChild(kRowEl(ch, true));
          doneBox.appendChild(wrap);
        });
      });
    }
  }
}

function kRowEl(item, isDone){
  const row = document.createElement("div");
  row.className = "kRow";

  const qtyText = (Number(item.qty||0) >= 2) ? `Ã—${item.qty}` : "";
  const seatLabel = item.subId && item.subId!==item.seatId ? `${item.seatId}/${item.subId}` : `${item.seatId}`;

  row.innerHTML = `
    <div class="kLeft">
      <div class="kTime">${hhmm(item.ts)}</div>
      <div class="kSeat">${seatLabel}</div>
      <div class="kName">${item.name}<span class="kQty">${qtyText}</span></div>
    </div>
    <div class="kSlide">
      ${isDone ? `<span class="kDoneBadge">å®Œäº†</span>` : ``}
      <input class="kRange" type="range" min="0" max="100" value="0" aria-label="ã‚¹ãƒ©ã‚¤ãƒ‰ã§å®Œäº†" />
    </div>
  `;

  const range = row.querySelector(".kRange");
  const TH = 88;

  range.addEventListener("change", ()=>{
    const v = Number(range.value||0);
    if(v >= TH){
      item.status = isDone ? "todo" : "done";
      range.value = 0;
      renderKitchen();
    }else{
      range.value = 0;
    }
  });

  return row;
}

/* ===== Buttons ===== */
$("kToggleDone").onclick = ()=>{
  state.kitchen.showDone = !state.kitchen.showDone;
  $("kToggleDone").textContent = state.kitchen.showDone ? "æä¾›æ¸ˆã‚’éš ã™" : "æä¾›æ¸ˆã‚’è¡¨ç¤º";
  renderKitchen();
};

$("kFilterFood").onclick = ()=>{
  state.kitchen.showFood = !state.kitchen.showFood;
  $("kFilterFood").classList.toggle("lime", state.kitchen.showFood);
  renderKitchen();
};
$("kFilterDrink").onclick = ()=>{
  state.kitchen.showDrink = !state.kitchen.showDrink;
  $("kFilterDrink").classList.toggle("lime", state.kitchen.showDrink);
  renderKitchen();
};

/* åˆæœŸ */
$("kFilterFood").classList.add("lime");
$("kFilterDrink").classList.add("lime");

/* showScreen hook */
(function hookShowScreenForKitchen(){
  if(showScreen._kHooked) return;
  const _show = showScreen;
  showScreen = function(id){
    _show(id);
    if(id==="scrKitchen") renderKitchen();
  };
  showScreen._kHooked = true;
})();

renderKitchen();

/* =========================
  ã“ã“ã‹ã‚‰å…ˆã¯ PART4 ã§ç¶šã
========================= */
/* =========================
  PART4ï¼šå£²ä¸Šï¼ˆæœ¬æ—¥ï¼æ—¥åˆ¥ï¼æœˆï¼å¹´ï¼‰
  å½¹å‰²ï¼šé–²è¦§ï¼ˆç„¡æ–™ç‰ˆã§å…¨éƒ¨è¦‹ã‚‹ï¼‰ï¼‹ä¿®æ­£å°ç·šï¼ˆPART5ã¸ï¼‰
  æ–¹é‡ï¼šè»½ããƒ»ä¸å®‰ã‚’ç…½ã‚‰ãªã„ãƒ»ä¿®æ­£ã¯PART5ã¸åˆ†é›¢ï¼ˆè¨‚æ­£ä¼ç¥¨æ–¹å¼ï¼‰
  è¿½åŠ ï¼ˆç¢ºå®šå¯¾å¿œï¼‰ï¼š
    - æœ¬æ—¥ï¼æ—¥åˆ¥ï¼æœˆï¼å¹´ ã‚’ç„¡æ–™ç‰ˆã§é–²è¦§å¯èƒ½
    - æœ¬æ—¥ï¼æ—¥åˆ¥ ã®ä¸€è¦§ã¯ã€Œå…¥åº—/é€€åº—/å¸­(åå‰)/é‡‘é¡/æ”¯æ‰•/ä¿®æ­£ã€
    - ä¿®æ­£å·®åˆ†ï¼ˆè¨‚æ­£ä¼ç¥¨ï¼‰ã¯ â€œå¯¾è±¡è¡Œã®ç›´ä¸‹â€ ã«è¿½åŠ è¡¨ç¤ºï¼ˆä¸Šæ›¸ããªã—ï¼‰
========================= */

/* ===== UIå·®ã—æ›¿ãˆï¼ˆãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ç½®æ›ï¼‰ ===== */
(function buildSalesUI(){
  const scr = $("scrSales");
  scr.innerHTML = `
    <div class="pill" style="margin-bottom:10px">å£²ä¸Š</div>

    <div style="display:flex; gap:8px; margin-bottom:10px; flex-wrap:wrap">
      <button class="btn primary" id="tabToday">æœ¬æ—¥</button>
      <button class="btn" id="tabDaily">æ—¥åˆ¥</button>
      <button class="btn" id="tabMonth">æœˆ</button>
      <button class="btn" id="tabYear">å¹´</button>
    </div>

    <div id="salesToday"></div>
    <div id="salesDaily" style="display:none"></div>
    <div id="salesMonth" style="display:none"></div>
    <div id="salesYear" style="display:none"></div>
  `;
})();

/* ===== PART4 State ===== */
state.sales = state.sales || {
  list: [],
  tab: "today",
  dailyYmd: null, // æ—¥åˆ¥ã§é¸æŠä¸­ã®æ—¥ä»˜ï¼ˆYYYY-MM-DDï¼‰
};

/* ===== Helpers ===== */
function ymd(d){
  return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
}
function sameDay(a,b){
  return a.getFullYear()===b.getFullYear()
      && a.getMonth()===b.getMonth()
      && a.getDate()===b.getDate();
}
function fmtHM(ts){
  if(!ts) return "--:--";
  const d = new Date(ts);
  return `${pad2(d.getHours())}:${pad2(d.getMinutes())}`;
}
function safeNum(n){ n=Number(n); return Number.isFinite(n)?n:0; }

/* ===== Demo Seedï¼ˆinTs/outTsã‚‚ä»˜ã‘ã‚‹ï¼‰ ===== */
(function seedSalesIfEmpty(){
  if(state.sales.list.length) return;

  const now = new Date();
  const mk = (inH,inM,outH,outM,seat,name,pay,amt)=>{
    const inD  = new Date(now.getFullYear(), now.getMonth(), now.getDate(), inH, inM);
    const outD = new Date(now.getFullYear(), now.getMonth(), now.getDate(), outH, outM);
    return {
      saleId: "s"+Math.random().toString(36).slice(2),
      ts: outD.getTime(),      // ä¼šè¨ˆæ™‚åˆ»ï¼ˆé€€åº—å¯„ã‚Šã§OKï¼‰
      inTs: inD.getTime(),
      outTs: outD.getTime(),
      seatId: seat,
      name: name||"",
      pay,
      amount: amt,
      receipt: true,
      items: [
        {name:"ç”Ÿãƒ“ãƒ¼ãƒ«", qty:2, price:600, tax:10},
        {name:"å”æšã’", qty:1, price:800, tax:10},
      ],
      corrections: [] // è¨‚æ­£ä¼ç¥¨ï¼ˆå·®åˆ†ï¼‰ã‚’ã“ã“ã«ç©ã‚€
    };
  };

  state.sales.list.push(
    mk(12,10,12,35,"D","ç”°ä¸­","ã‚«ãƒ¼ãƒ‰",4800),
    mk(13,00,13,10,"A","","ç¾é‡‘",1800),
    mk(13,40,14, 5,"B","ä½è—¤","QR",2200),
  );

  // æ—¥åˆ¥ã®åˆæœŸæ—¥ä»˜ï¼šä»Šæ—¥
  state.sales.dailyYmd = ymd(new Date());
})();

/* ===== Aggregation ===== */
function filterByYmd(targetYmd){
  const rows = state.sales.list.filter(s=>{
    const d = new Date(s.ts);
    return ymd(d) === targetYmd;
  });
  return rows;
}

function aggByRows(rows){
  const sum = rows.reduce((a,b)=> a + safeNum(b.amount), 0);
  const cnt = rows.length;

  const payCnt = {ç¾é‡‘:0, ã‚«ãƒ¼ãƒ‰:0, QR:0};
  const paySum = {ç¾é‡‘:0, ã‚«ãƒ¼ãƒ‰:0, QR:0};

  rows.forEach(s=>{
    const p = s.pay || "ç¾é‡‘";
    if(!(p in payCnt)) payCnt[p]=0;
    if(!(p in paySum)) paySum[p]=0;
    payCnt[p] += 1;
    paySum[p] += safeNum(s.amount);
  });

  return {sum,cnt,payCnt,paySum};
}

function aggToday(){
  const today = ymd(new Date());
  const rows = filterByYmd(today);
  return { ymd: today, rows, ...aggByRows(rows) };
}

function aggDaily(targetYmd){
  const rows = filterByYmd(targetYmd);
  return { ymd: targetYmd, rows, ...aggByRows(rows) };
}

function aggMonth(){
  const d = new Date();
  const y=d.getFullYear(), m=d.getMonth();
  const rows = state.sales.list.filter(s=>{
    const x=new Date(s.ts);
    return x.getFullYear()===y && x.getMonth()===m;
  });
  const sum = rows.reduce((a,b)=> a+safeNum(b.amount), 0);
  return {sum, cnt: rows.length};
}

function aggYear(){
  const y=new Date().getFullYear();
  const rows = state.sales.list.filter(s=> new Date(s.ts).getFullYear()===y);
  const sum = rows.reduce((a,b)=> a+safeNum(b.amount), 0);
  return {sum, cnt: rows.length};
}

/* ===== ä¿®æ­£å°ç·šï¼ˆPART5ã¸ï¼‰ ===== */
function goFix(saleId){
  // PART5å·®ã—æ›¿ãˆç‰ˆï¼šwindow.ONE_openFixForSaleId ãŒã‚ã‚‹æƒ³å®š
  if(typeof window.ONE_openFixForSaleId === "function"){
    window.ONE_openFixForSaleId(saleId);
    return;
  }
  toast("ä¿®æ­£æ©Ÿèƒ½ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ï¼ˆPART5ã‚’åæ˜ ã—ã¦ãã ã•ã„ï¼‰");
}

/* ===== è¨‚æ­£ä¼ç¥¨è¡¨ç¤ºï¼ˆå¯¾è±¡è¡Œã®ç›´ä¸‹ï¼‰ ===== */
function renderCorrectionsInline(s){
  const list = (s.corrections || []);
  if(!list.length) return "";

  // æ–°ã—ã„é †ã«è¦‹ã›ã‚‹ï¼ˆç›´ä¸‹ã«è¤‡æ•°ä¸¦ã¶ï¼‰
  const html = list.slice().sort((a,b)=> (b.ts||0)-(a.ts||0)).map(c=>{
    const beforePay = c.payBefore || s.pay || "";
    const afterPay  = c.payAfter  || "";

    // å•†å“å·®åˆ†ï¼ˆå·¦ï¼šå‰ / å³ï¼šå¾Œï¼‰
    const before = c.itemsBefore || [];
    const after  = c.itemsAfter  || [];

    // åå‰é›†åˆã§ä¸¦ã¹ã‚‹
    const map = new Map();
    before.forEach(it=>{
      const k = it.name || "";
      if(!k) return;
      if(!map.has(k)) map.set(k, {name:k, b:0, a:0});
      map.get(k).b += safeNum(it.qty);
    });
    after.forEach(it=>{
      const k = it.name || "";
      if(!k) return;
      if(!map.has(k)) map.set(k, {name:k, b:0, a:0});
      map.get(k).a += safeNum(it.qty);
    });
    const diffs = Array.from(map.values()).sort((x,y)=> x.name.localeCompare(y.name,"ja"));

    const diffRows = diffs.map(x=>`
      <div style="display:flex; justify-content:space-between; gap:10px; margin:4px 0">
        <div style="min-width:0; overflow:hidden; text-overflow:ellipsis; white-space:nowrap">${x.name}</div>
        <div style="display:flex; gap:8px; font-weight:900">
          <span>${x.b}</span><span style="color:var(--muted)">â†’</span><span>${x.a}</span>
        </div>
      </div>
    `).join("");

    return `
      <div class="pill" style="margin:8px 0 10px; color:var(--muted)">
        è¨‚æ­£ï¼š${fmtHM(c.ts)} ï¼ ${c.who||""} ï¼ ${c.why||""}<br>
        æ”¯æ‰•ï¼š${beforePay}${afterPay?` â†’ ${afterPay}`:""}<br>
        ${diffRows || "ï¼ˆæ•°é‡å¤‰æ›´ãªã—ï¼‰"}
      </div>
    `;
  }).join("");

  return html;
}

/* ===== List Row ===== */
function saleRowEl(s){
  const row = document.createElement("div");
  row.className = "kRow";
  row.dataset.saleId = s.saleId;

  const inT  = fmtHM(s.inTs);
  const outT = fmtHM(s.outTs);
  const seatLabel = `${s.seatId || ""}${s.name ? `ï¼ˆ${s.name}ï¼‰` : ""}`;

  row.innerHTML = `
    <div class="kLeft" style="align-items:flex-start">
      <div style="width:64px; font-weight:900">${inT}</div>
      <div style="width:64px; font-weight:900">${outT}</div>
      <div class="kName" style="font-weight:900">${seatLabel}</div>
    </div>

    <div class="kSlide" style="gap:10px; width:auto">
      <div style="font-weight:900">${yen(s.amount)}</div>
      <div class="pill">${s.pay || "ç¾é‡‘"}</div>
      <button class="btn" data-fix="${s.saleId}">ä¿®æ­£</button>
    </div>
  `;

  // è¡Œã‚¿ãƒƒãƒ—ï¼šè©³ç´°ï¼ˆæ—¢å­˜ã® openSaleDetail ãŒã‚ã‚Œã°ï¼‰
  row.onclick = (e)=>{
    if(e && e.target && e.target.getAttribute && e.target.getAttribute("data-fix")) return;
    if(typeof openSaleDetail === "function") openSaleDetail(s);
  };

  return row;
}

/* ===== Render ===== */
function renderSales(){
  const t = $("salesToday");
  const d = $("salesDaily");
  const m = $("salesMonth");
  const y = $("salesYear");

  t.style.display = state.sales.tab==="today" ? "block":"none";
  d.style.display = state.sales.tab==="daily" ? "block":"none";
  m.style.display = state.sales.tab==="month" ? "block":"none";
  y.style.display = state.sales.tab==="year"  ? "block":"none";

  if(state.sales.tab==="today") renderToday();
  if(state.sales.tab==="daily") renderDaily();
  if(state.sales.tab==="month") renderMonth();
  if(state.sales.tab==="year")  renderYear();
}

function renderToday(){
  const box = $("salesToday");
  const a = aggToday();

  const payTxt = `ç¾é‡‘ ${a.payCnt["ç¾é‡‘"]||0} / ã‚«ãƒ¼ãƒ‰ ${a.payCnt["ã‚«ãƒ¼ãƒ‰"]||0} / QR ${a.payCnt["QR"]||0}`;

  box.innerHTML = `
    <div class="pill" style="margin-bottom:8px">
      åˆè¨ˆ ${yen(a.sum)} ï¼ ä¼šè¨ˆ ${a.cnt}ä»¶ ï¼ ${payTxt}
    </div>

    <div id="todayList"></div>
  `;

  const list = box.querySelector("#todayList");
  if(a.rows.length===0){
    list.innerHTML = `<div class="pill">æœ¬æ—¥ã®ä¼šè¨ˆã¯ã‚ã‚Šã¾ã›ã‚“</div>`;
    return;
  }

  a.rows
    .slice()
    .sort((x,y)=> x.ts - y.ts)
    .forEach(s=>{
      // å…ƒè¡Œ
      const row = saleRowEl(s);
      list.appendChild(row);

      // ç›´ä¸‹ï¼šè¨‚æ­£ä¼ç¥¨ï¼ˆå·®åˆ†ï¼‰
      const inline = renderCorrectionsInline(s);
      if(inline){
        const wrap = document.createElement("div");
        wrap.innerHTML = inline;
        list.appendChild(wrap);
      }
    });

  // ä¿®æ­£ãƒœã‚¿ãƒ³
  list.querySelectorAll("[data-fix]").forEach(btn=>{
    btn.onclick = (e)=>{
      e.stopPropagation();
      const id = btn.getAttribute("data-fix");
      goFix(id);
    };
  });
}

function renderDaily(){
  const box = $("salesDaily");
  const todayY = ymd(new Date());
  const cur = state.sales.dailyYmd || todayY;

  const a = aggDaily(cur);

  box.innerHTML = `
    <div class="pill" style="margin-bottom:8px">æ—¥ä»˜</div>
    <input id="dailyPick" class="btn" style="width:100%; text-align:left; margin-bottom:10px" value="${cur}" />

    <div class="pill" style="margin-bottom:8px">
      æœ¬æ—¥ã®ç·å£²ä¸Š ${yen(a.sum)} ï¼ ç·ä¼šè¨ˆæ•° ${a.cnt}ä»¶
    </div>

    <div class="pill" style="margin-bottom:10px; color:var(--muted)">
      ç¾é‡‘ï¼š${a.payCnt["ç¾é‡‘"]||0}ä»¶ï¼${yen(a.paySum["ç¾é‡‘"]||0)}<br>
      ã‚«ãƒ¼ãƒ‰ï¼š${a.payCnt["ã‚«ãƒ¼ãƒ‰"]||0}ä»¶ï¼${yen(a.paySum["ã‚«ãƒ¼ãƒ‰"]||0)}<br>
      QRï¼š${a.payCnt["QR"]||0}ä»¶ï¼${yen(a.paySum["QR"]||0)}
    </div>

    <div id="dailyList"></div>
  `;

  const list = box.querySelector("#dailyList");
  if(a.rows.length===0){
    list.innerHTML = `<div class="pill">ã“ã®æ—¥ã®ä¼šè¨ˆã¯ã‚ã‚Šã¾ã›ã‚“</div>`;
  }else{
    a.rows
      .slice()
      .sort((x,y)=> x.ts - y.ts)
      .forEach(s=>{
        const row = saleRowEl(s);
        list.appendChild(row);

        const inline = renderCorrectionsInline(s);
        if(inline){
          const wrap = document.createElement("div");
          wrap.innerHTML = inline;
          list.appendChild(wrap);
        }
      });

    list.querySelectorAll("[data-fix]").forEach(btn=>{
      btn.onclick = (e)=>{
        e.stopPropagation();
        const id = btn.getAttribute("data-fix");
        goFix(id);
      };
    });
  }

  // æ—¥ä»˜å¤‰æ›´
  $("dailyPick").onchange = ()=>{
    const v = ($("dailyPick").value||"").trim();
    if(!v){ state.sales.dailyYmd = todayY; }
    else state.sales.dailyYmd = v;
    renderDaily();
  };
}

function renderMonth(){
  const box = $("salesMonth");
  const a = aggMonth();
  box.innerHTML = `
    <div class="pill">æœˆåˆè¨ˆ ${yen(a.sum)} ï¼ ä¼šè¨ˆ ${a.cnt}ä»¶</div>
    <div style="height:8px"></div>
    <div class="pill">ç„¡æ–™ç‰ˆï¼šæœˆã®å†…è¨³ï¼ˆã‚°ãƒ©ãƒ•ç­‰ï¼‰ã¯ä»Šå¾Œã®æœ‰æ–™ç‰ˆã§å¼·åŒ–</div>
  `;
}

function renderYear(){
  const box = $("salesYear");
  const a = aggYear();
  box.innerHTML = `
    <div class="pill">å¹´åˆè¨ˆ ${yen(a.sum)} ï¼ ä¼šè¨ˆ ${a.cnt}ä»¶</div>
    <div style="height:8px"></div>
    <div class="pill">ç„¡æ–™ç‰ˆï¼šå¹´ã®å†…è¨³ï¼ˆã‚°ãƒ©ãƒ•ç­‰ï¼‰ã¯ä»Šå¾Œã®æœ‰æ–™ç‰ˆã§å¼·åŒ–</div>
  `;
}

/* ===== Detailï¼ˆä¿®æ­£ã¯PART5ã¸ï¼‰ ===== */
function openSaleDetail(s){
  const items = (s.items||[]).map(it=>`${it.name} Ã—${it.qty}`).join("<br>");
  openModal(
    "ä¼šè¨ˆè©³ç´°",
    `
      <div>å…¥åº—ï¼š${fmtHM(s.inTs)}</div>
      <div>é€€åº—ï¼š${fmtHM(s.outTs)}</div>
      <div>å¸­ï¼š${s.seatId}${s.name?`ï¼ˆ${s.name}ï¼‰`:""}</div>
      <div>æ”¯æ‰•ï¼š${s.pay}</div>
      <div style="margin-top:8px">${items}</div>
      <div style="margin-top:8px;font-weight:900">${yen(s.amount)}</div>
    `,
    [
      {label:"ä¿®æ­£", primary:true, onClick:()=>{ closeModal(); goFix(s.saleId); }},
      {label:"æˆ»ã‚‹", onClick:()=> closeModal()},
    ]
  );
}

/* ===== Tabs ===== */
function setTab(t){
  state.sales.tab = t;

  $("tabToday").classList.toggle("primary", t==="today");
  $("tabDaily").classList.toggle("primary", t==="daily");
  $("tabMonth").classList.toggle("primary", t==="month");
  $("tabYear").classList.toggle("primary", t==="year");

  renderSales();
}

$("tabToday").onclick=()=> setTab("today");
$("tabDaily").onclick=()=> setTab("daily");
$("tabMonth").onclick=()=> setTab("month");
$("tabYear").onclick =()=> setTab("year");

/* ===== Sales screen hook (stable) ===== */
registerScreenHook("scrSales", ()=>{
  try{ renderSales(); }catch(e){ console.warn(e); }
});

/* =========================
  ã“ã“ã‹ã‚‰å…ˆã¯ PART5 ã§ç¶šã
========================= */
/* =========================
  PART5ï¼šå£²ä¸Šç®¡ç†ãƒ»è¨‚æ­£ä¼ç¥¨ï¼ˆæœ¬æ—¥ï¼æ—¥åˆ¥ã®ä¿®æ­£ï¼‰
  å½¹å‰²ï¼šä¼šè¨ˆç¢ºå®šå¾Œã®ä¿®æ­£ï¼ˆå·®åˆ†ã‚¤ãƒ™ãƒ³ãƒˆã®ã¿ï¼‰
  æ–¹é‡ï¼šæ¶ˆã•ãªã„ï¼ä¸Šæ›¸ãã—ãªã„ï¼å±¥æ­´ã‚’æ®‹ã™ï¼ˆè¨‚æ­£ä¼ç¥¨æ–¹å¼ï¼‰
  ä¿®æ­£å¯¾è±¡ï¼ˆç¢ºå®šï¼‰ï¼š
    â‘  æ³¨æ–‡å•†å“æ•°ï¼ˆ0ä»¥ä¸‹ä¸å¯ï¼‰
    â‘¡ æ”¯æ‰•ã„æ–¹æ³•
  ä¿®æ­£æ™‚ å¿…é ˆï¼š
    ãƒ»ä¿®æ­£è€…åï¼ˆå¿…é ˆï¼‰
    ãƒ»ä¿®æ­£ç†ç”±ï¼ˆå¿…é ˆï¼‰
  è¡¨ç¤ºï¼š
    ãƒ»ä¿®æ­£å·®åˆ†ã¯ã€Œå¯¾è±¡è¡Œã®ç›´ä¸‹ã€ã«è¿½åŠ è¡¨ç¤ºï¼ˆå…ƒã¯æ®‹ã™ï¼‰
========================= */

/* ===== UIå·®ã—æ›¿ãˆï¼ˆãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ç½®æ›ï¼‰ ===== */
(function buildFixUI(){
  const scr = $("scrFix");
  scr.innerHTML = `
    <div class="pill" style="margin-bottom:10px">ä¿®æ­£ï¼ˆè¨‚æ­£ä¼ç¥¨æ–¹å¼ï¼‰</div>
    <div id="fixBody"></div>
  `;
})();

/* ===== PART5 State ===== */
state.fix = state.fix || {
  targetId: null,      // saleId
  draft: null,         // ç·¨é›†ä¸­ã®ãƒ‰ãƒ©ãƒ•ãƒˆ
  stage: "edit",       // "edit" | "confirm"
};

/* =========================================================
  Saleãƒ‡ãƒ¼ã‚¿æƒ³å®šï¼ˆæ—¢å­˜ã‚’å£Šã•ãªã„ãŸã‚ã®äº’æ›ï¼‰
  - state.sales.list ã®å„è¦ç´ ï¼ˆsaleï¼‰ã¯æœ€ä½é™:
    {
      saleId, ts,
      seatId, name, pay, amount,
      items:[{name, qty, price, tax}],
      inTs?, outTs?,
      corrections?: [
        {
          corrId, ts,
          who, why,
          payBefore, payAfter,
          itemsBefore:[{name, qty}], itemsAfter:[{name, qty}]
        }
      ]
    }
========================================================= */

function getSaleById(id){
  return (state.sales && Array.isArray(state.sales.list))
    ? state.sales.list.find(s => s.saleId === id)
    : null;
}

function safeNum(n){ n = Number(n); return Number.isFinite(n) ? n : 0; }

function calcAmountFromItems(items){
  // ç¨è¨ˆç®—ã¯ç„¡æ–™ç‰ˆã¯â€œç·é¡ã®æ•´åˆå„ªå…ˆâ€ã§ç°¡æ˜“ï¼ˆã“ã“ã¯å¾Œã§ç²¾å¯†åŒ–ã§ãã‚‹ï¼‰
  // ç¾çŠ¶ï¼šprice * qty ã®åˆè¨ˆ
  return (items||[]).reduce((sum, it)=> sum + safeNum(it.price) * safeNum(it.qty), 0);
}

function cloneItemsForEdit(items){
  return (items||[]).map(it=> ({
    name: it.name || "",
    qty: Math.max(0, safeNum(it.qty)),
    price: safeNum(it.price),
    tax: safeNum(it.tax),
  }));
}

function itemsToNameQty(items){
  return (items||[]).map(it=> ({ name: it.name || "", qty: Math.max(0, safeNum(it.qty)) }));
}

function fmtHM(ts){
  if(!ts) return "--:--";
  const d = new Date(ts);
  return `${pad2(d.getHours())}:${pad2(d.getMinutes())}`;
}

function payOptionsHtml(sel){
  const opts = ["ç¾é‡‘","ã‚«ãƒ¼ãƒ‰","QR"];
  return opts.map(p=> `<option ${p===sel?"selected":""}>${p}</option>`).join("");
}

function diffNameQty(before, after){
  // è¡¨ç¤ºç”¨ï¼šå·¦å³ã«åŒã˜é †ã§ä¸¦ã¹ãŸã„
  // â€œåå‰é›†åˆâ€ã§ã¾ã¨ã‚ã‚‹
  const map = new Map();
  (before||[]).forEach(it=>{
    const k = it.name || "";
    if(!map.has(k)) map.set(k, {name:k, b:0, a:0});
    map.get(k).b += safeNum(it.qty);
  });
  (after||[]).forEach(it=>{
    const k = it.name || "";
    if(!map.has(k)) map.set(k, {name:k, b:0, a:0});
    map.get(k).a += safeNum(it.qty);
  });
  return Array.from(map.values()).filter(x=> x.name).sort((x,y)=> x.name.localeCompare(y.name, "ja"));
}

/* =========================================================
  PART4ã‹ã‚‰ã®å…¥å£ï¼ˆä¿®æ­£ãƒœã‚¿ãƒ³ â†’ scrFixï¼‰
  æ—¢å­˜ openSaleDetail(s) ã‚’å£Šã•ãš â€œä¿®æ­£å¯¾è±¡ã‚’ä¿æŒâ€ã™ã‚‹
========================================================= */
(function hookFixEntry(){
  // PART4ã® openSaleDetail ãŒã‚ã‚‹å‰æã§ãƒ•ãƒƒã‚¯ï¼ˆç„¡ãã¦ã‚‚å‹•ãï¼‰
  if(typeof openSaleDetail !== "function") return;
  if(openSaleDetail._p5Hooked) return;

  const _open = openSaleDetail;
  openSaleDetail = function(sale){
    _open(sale);
    // ä¿®æ­£ãƒœã‚¿ãƒ³æŠ¼ä¸‹æ™‚ã«å¯¾è±¡ãŒå¿…è¦ãªã®ã§ä¿æŒ
    state.fix.targetId = sale && sale.saleId ? sale.saleId : null;
  };

  openSaleDetail._p5Hooked = true;
})();

/* =========================================================
  â€œä¿®æ­£â€ç”»é¢ã‚’é–‹ãå…±é€šé–¢æ•°ï¼ˆä»Šæ—¥/æ—¥åˆ¥ã®ä¸€è¦§ã‹ã‚‰å‘¼ã¹ã‚‹ï¼‰
========================================================= */
function openFixForSaleId(saleId){
  const s = getSaleById(saleId);
  if(!s){
    toast("ä¿®æ­£å¯¾è±¡ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");
    return;
  }

  // ãƒ‰ãƒ©ãƒ•ãƒˆä½œæˆï¼ˆç·¨é›†ã¯ items.qty ã¨ pay ã®ã¿ï¼‰
  const baseItems = cloneItemsForEdit(s.items || []);
  const basePay = s.pay || "ç¾é‡‘";

  state.fix.targetId = s.saleId;
  state.fix.stage = "edit";
  state.fix.draft = {
    who: "",
    why: "",
    pay: basePay,
    items: baseItems,          // qtyã‚’ã“ã“ã§å¢—æ¸›
    baseItems: cloneItemsForEdit(s.items || []),
    basePay: basePay,
  };

  showScreen("scrFix");
  renderFix();
}

/* =========================================================
  FIXï¼šç·¨é›†ç”»é¢ â†’ ç¢ºèªç”»é¢ â†’ ã‚¹ãƒ©ã‚¤ãƒ‰ç¢ºå®š
========================================================= */
function renderFix(){
  const box = $("fixBody");
  const s = getSaleById(state.fix.targetId);

  if(!s){
    box.innerHTML = `<div class="pill">ä¿®æ­£å¯¾è±¡ãŒã‚ã‚Šã¾ã›ã‚“</div>`;
    return;
  }

  // in/out ã¯ç„¡ã„å ´åˆã‚‚ã‚ã‚‹ï¼ˆæ—¢å­˜ãƒ‡ãƒ¼ã‚¿äº’æ›ï¼‰
  const inT  = fmtHM(s.inTs || null);
  const outT = fmtHM(s.outTs || null);

  const seatLabel = `${s.seatId || ""}${s.name ? `ï¼ˆ${s.name}ï¼‰` : ""}`;
  const baseAmount = safeNum(s.amount) || calcAmountFromItems(s.items||[]);

  // ãƒ‰ãƒ©ãƒ•ãƒˆãŒç„¡ã„å ´åˆã¯ç”Ÿæˆï¼ˆç›´æ¥scrFixã«æ¥ãŸã‚±ãƒ¼ã‚¹æ•‘æ¸ˆï¼‰
  if(!state.fix.draft){
    state.fix.draft = {
      who:"",
      why:"",
      pay: s.pay || "ç¾é‡‘",
      items: cloneItemsForEdit(s.items || []),
      baseItems: cloneItemsForEdit(s.items || []),
      basePay: s.pay || "ç¾é‡‘",
    };
    state.fix.stage = "edit";
  }

  const d = state.fix.draft;
  const newAmount = calcAmountFromItems(d.items);

  if(state.fix.stage === "edit"){
    const rows = d.items.map((it, idx)=>{
      const qty = Math.max(0, safeNum(it.qty));
      return `
        <div class="kRow" style="align-items:flex-start">
          <div class="kLeft" style="align-items:flex-start">
            <div class="kName">${it.name}</div>
          </div>
          <div class="kSlide" style="flex-direction:column; align-items:flex-end; gap:8px">
            <div class="pill" style="min-width:120px; justify-content:center; font-weight:900">
              ${yen(safeNum(it.price) * qty)}
            </div>
            <div style="display:flex; gap:8px; align-items:center">
              <button class="btn" data-minus="${idx}">âˆ’</button>
              <div class="pill" style="min-width:54px; justify-content:center; font-weight:900">${qty}</div>
              <button class="btn" data-plus="${idx}">ï¼‹</button>
            </div>
          </div>
        </div>
      `;
    }).join("");

    box.innerHTML = `
      <!-- ä¸Šæ®µï¼šç¾çŠ¶ -->
      <div class="pill" style="margin-bottom:8px">ç¾çŠ¶ï¼ˆä¿®æ­£å‰ï¼‰</div>
      <div class="pill" style="margin-bottom:10px; color:var(--muted)">
        å…¥åº— ${inT} / é€€åº— ${outT}<br>
        å¸­ ${seatLabel}<br>
        é‡‘é¡ ${yen(baseAmount)} / æ”¯æ‰• ${s.pay || "ç¾é‡‘"}
      </div>

      <!-- å…¥åŠ› -->
      <div style="display:flex; gap:10px; margin-bottom:10px">
        <button class="btn" id="fixBack" style="flex:1">æˆ»ã‚‹</button>
        <button class="btn primary" id="fixToConfirm" style="flex:1">æ±ºå®š</button>
      </div>

      <div class="pill" style="margin-bottom:6px">ä¿®æ­£è€…åï¼ˆå¿…é ˆï¼‰</div>
      <input id="fixWho" class="btn" style="width:100%; text-align:left; margin-bottom:10px" placeholder="åå‰" value="${(d.who||"").replace(/"/g,"&quot;")}" />

      <div class="pill" style="margin-bottom:6px">ä¿®æ­£ç†ç”±ï¼ˆå¿…é ˆï¼‰</div>
      <input id="fixWhy" class="btn" style="width:100%; text-align:left; margin-bottom:12px" placeholder="ç†ç”±" value="${(d.why||"").replace(/"/g,"&quot;")}" />

      <!-- æ“ä½œåˆ— -->
      <div class="pill" style="margin-bottom:6px">ä¿®æ­£å¾Œ</div>
      <div class="pill" style="margin-bottom:10px">
        ä¿®æ­£å¾Œé‡‘é¡ï¼š<span style="font-weight:900">${yen(newAmount)}</span>
      </div>

      <div class="pill" style="margin-bottom:6px">æ”¯æ‰•ã„æ–¹æ³•</div>
      <select id="fixPay" class="btn" style="width:100%; margin-bottom:12px">
        ${payOptionsHtml(d.pay)}
      </select>

      <!-- æ˜ç´° -->
      <div class="pill" style="margin-bottom:6px">å•†å“æ˜ç´°ï¼ˆæ•°é‡å¤‰æ›´ï¼‰</div>
      ${rows}
    `;

    // æˆ»ã‚‹
    $("fixBack").onclick = ()=> showScreen("scrSales"); // ç¾çŠ¶ã®æ§‹é€ ã«åˆã‚ã›ã¦ã€Œå£²ä¸Šã€ã¸æˆ»ã™ï¼ˆå¾Œã§ç®¡ç†ç”»é¢ãŒå‡ºæ¥ãŸã‚‰å·®ã—æ›¿ãˆOKï¼‰

    // æ±ºå®š â†’ ç¢ºèªã¸
    $("fixToConfirm").onclick = ()=>{
      d.who = ($("fixWho").value||"").trim();
      d.why = ($("fixWhy").value||"").trim();
      d.pay = ($("fixPay").value||"").trim() || d.pay;

      if(!d.who || !d.why){
        toast("ä¿®æ­£è€…åã¨ä¿®æ­£ç†ç”±ã¯å¿…é ˆã§ã™");
        return;
      }
      state.fix.stage = "confirm";
      renderFix();
    };

    // æ”¯æ‰•å¤‰æ›´
    $("fixPay").onchange = ()=> {
      d.pay = ($("fixPay").value||"").trim() || d.pay;
    };

    // æ•°é‡ Â±ï¼ˆ0ä»¥ä¸‹ä¸å¯ï¼‰
    box.querySelectorAll("[data-minus]").forEach(btn=>{
      btn.onclick = ()=>{
        const i = Number(btn.getAttribute("data-minus"));
        const it = d.items[i];
        if(!it) return;
        it.qty = Math.max(0, safeNum(it.qty) - 1);
        renderFix();
      };
    });
    box.querySelectorAll("[data-plus]").forEach(btn=>{
      btn.onclick = ()=>{
        const i = Number(btn.getAttribute("data-plus"));
        const it = d.items[i];
        if(!it) return;
        it.qty = Math.max(0, safeNum(it.qty) + 1);
        renderFix();
      };
    });

    return;
  }

  // ===== confirm =====
  const beforeItems = itemsToNameQty(d.baseItems);
  const afterItems  = itemsToNameQty(d.items);
  const diff = diffNameQty(beforeItems, afterItems);

  const diffRows = diff.map(x=>{
    return `
      <div class="kRow">
        <div class="kLeft">
          <div class="kName">${x.name}</div>
        </div>
        <div class="kSlide" style="justify-content:space-between; width:180px">
          <div style="font-weight:900">${x.b}</div>
          <div style="color:var(--muted)">â†’</div>
          <div style="font-weight:900">${x.a}</div>
        </div>
      </div>
    `;
  }).join("");

  box.innerHTML = `
    <div class="pill" style="margin-bottom:8px">ç¢ºèª</div>

    <div class="pill" style="margin-bottom:8px">ä¿®æ­£å‰</div>
    <div class="pill" style="margin-bottom:10px; color:var(--muted)">
      å…¥åº— ${inT} / é€€åº— ${outT}<br>
      å¸­ ${seatLabel}<br>
      é‡‘é¡ ${yen(baseAmount)} / æ”¯æ‰• ${d.basePay}
    </div>

    <div class="pill" style="margin-bottom:8px">ä¿®æ­£å¾Œ</div>
    <div class="pill" style="margin-bottom:10px; color:var(--muted)">
      å…¥åº— ${inT} / é€€åº— ${outT}<br>
      å¸­ ${seatLabel}<br>
      é‡‘é¡ ${yen(calcAmountFromItems(d.items))} / æ”¯æ‰• ${d.pay}
    </div>

    <div class="pill" style="margin-bottom:6px">æ•°é‡å¤‰æ›´ï¼ˆå·¦ï¼šå‰ / å³ï¼šå¾Œï¼‰</div>
    ${diffRows || `<div class="pill">å¤‰æ›´ãªã—</div>`}

    <div class="pill" style="margin-top:10px; margin-bottom:6px; color:var(--muted)">
      ä¿®æ­£è€…ï¼š${d.who} / ç†ç”±ï¼š${d.why}
    </div>

    <div style="display:flex; gap:10px; margin-top:10px">
      <button class="btn" id="fixBackToEdit" style="flex:1">æˆ»ã‚‹</button>
      <div style="flex:1">
        <div class="pill" style="margin-bottom:6px; text-align:center">å³ã¸ã‚¹ãƒ©ã‚¤ãƒ‰ã§ç¢ºå®š</div>
        <input id="fixSlideOk" class="kRange" type="range" min="0" max="100" value="0"/>
      </div>
    </div>
  `;

  $("fixBackToEdit").onclick = ()=>{
    state.fix.stage = "edit";
    renderFix();
  };

  $("fixSlideOk").onchange = ()=>{
    const v = Number($("fixSlideOk").value||0);
    if(v < 88){
      $("fixSlideOk").value = 0;
      return;
    }
    applyFixAsCorrection();
  };
}

function applyFixAsCorrection(){
  const s = getSaleById(state.fix.targetId);
  const d = state.fix.draft;
  if(!s || !d){
    toast("ä¿®æ­£ã«å¤±æ•—ã—ã¾ã—ãŸ");
    return;
  }

  // å·®åˆ†ï¼ˆè¨‚æ­£ä¼ç¥¨ï¼‰ã‚’è¿½åŠ ï¼šä¸Šæ›¸ãã—ãªã„
  s.corrections = s.corrections || [];
  s.corrections.push({
    corrId: "c_" + Math.random().toString(36).slice(2),
    ts: nowTs(),
    who: d.who,
    why: d.why,
    payBefore: d.basePay,
    payAfter: d.pay,
    itemsBefore: itemsToNameQty(d.baseItems),
    itemsAfter: itemsToNameQty(d.items),
  });

  // â€»å…ƒãƒ‡ãƒ¼ã‚¿ã¯æ®‹ã™æ–¹é‡ã ãŒã€ä¸€è¦§ã§â€œä¿®æ­£å¾Œã®è¦‹ãŸç›®â€ã‚‚å¿…è¦ãªã‚‰ã“ã“ã§æ›´æ–°ã§ãã‚‹ã€‚
  // ä»Šå›ã¯ã€Œè¨‚æ­£ä¼ç¥¨æ–¹å¼ã§å±¥æ­´ã‚’æ®‹ã™ã€ã‚’å„ªå…ˆã—ã€å…ƒã® s.items / s.pay / s.amount ã¯ç¶­æŒã€‚
  // ãŸã ã—â€œä¿®æ­£å¾Œé‡‘é¡â€ã‚’ä¸€è¦§ã«åæ˜ ã—ãŸã„å ´åˆã¯ã€ä¸‹ã®3è¡Œã‚’ONã«ã™ã‚‹ï¼ˆå¿…è¦ãªã‚‰è¨€ã£ã¦ï¼‰
  // s.items = cloneItemsForEdit(d.items);
  // s.pay = d.pay;
  // s.amount = calcAmountFromItems(d.items);

  // è¡¨ç¤ºæ›´æ–°ï¼ˆPART4ã®ãƒ¬ãƒ³ãƒ€ãƒ©ãŒã‚ã‚‹ãªã‚‰å†æç”»ï¼‰
  state.fix.stage = "edit";
  state.fix.draft = null;

  toast("è¨‚æ­£ä¼ç¥¨ã‚’è¿½åŠ ã—ã¾ã—ãŸ");

  // å£²ä¸Šä¸€è¦§ã¸æˆ»ã™ï¼ˆç¾çŠ¶ã¯scrSalesï¼‰
  showScreen("scrSales");

  // å†æç”»ãƒ•ãƒƒã‚¯ï¼ˆå­˜åœ¨ã™ã‚‹ã‚‚ã®ã ã‘ï¼‰
  try{ if(typeof renderSales === "function") renderSales(); }catch(e){}
}

/* =========================================================
  â€œå¯¾è±¡è¡Œã®ç›´ä¸‹ã«å·®åˆ†ã‚’è¡¨ç¤ºâ€ã™ã‚‹ãŸã‚ã®å¾Œä»˜ã‘ãƒ‘ãƒƒãƒ
  - PART4ã®æœ¬æ—¥ä¸€è¦§ï¼ˆrenderTodayï¼‰ã‚’å£Šã•ãšã€å·®åˆ†è¡¨ç¤ºã‚’è¿½åŠ 
========================================================= */
(function patchRenderTodayList(){
  if(patchRenderTodayList._done) return;
  patchRenderTodayList._done = true;

  // PART4ã® renderToday ãŒå­˜åœ¨ã—ãªã„ãªã‚‰ä½•ã‚‚ã—ãªã„
  if(typeof renderToday !== "function") return;

  const _renderToday = renderToday;
  renderToday = function(){
    _renderToday();

    // todayList ãŒç„¡ã„ãªã‚‰ä½•ã‚‚ã—ãªã„
    const list = document.querySelector("#salesToday #todayList");
    if(!list) return;

    // æ—¢å­˜ã®å„è¡Œï¼ˆkRowï¼‰ã«ã€Œä¿®æ­£ã€ãƒœã‚¿ãƒ³ã‚’è¿½åŠ ã—ã€ç›´ä¸‹ã«å·®åˆ†ã‚’å·®ã—è¾¼ã‚€
    // â€»æ—¢å­˜ã® row.onclick ã¯ç¶­æŒã—ã¤ã¤ã€ãƒœã‚¿ãƒ³ã ã‘æ­¢ã‚ã‚‹
    const rows = Array.from(list.children || []);
    rows.forEach(row=>{
      const seatEl = row.querySelector(".kSeat");
      if(!seatEl) return;

      // kRowå†…ã‹ã‚‰ saleId ã‚’å–ã‚Œãªã„ã®ã§ã€ã‚¯ãƒªãƒƒã‚¯ã§é–‹ãè©³ç´°æ™‚ã® state.fix.targetId ã‚’åˆ©ç”¨ã™ã‚‹
      // â†’ å®‰å®šã•ã›ã‚‹ãŸã‚ã€è¡Œã‚¯ãƒªãƒƒã‚¯æ™‚ã« openSaleDetail(s) ãŒå‘¼ã°ã‚Œã¦ state.fix.targetId ãŒå…¥ã‚‹å‰æ
      // ãŸã ã€ç¢ºå®Ÿã«ã—ãŸã„ã®ã§ â€œè¡Œã‚’ã‚¯ãƒªãƒƒã‚¯â†’ãƒ¢ãƒ¼ãƒ€ãƒ«â†’ä¿®æ­£â€ ã‚’æ¨å¥¨ã€‚
      // ã“ã“ã§ã¯ã€Œå·®åˆ†è¡¨ç¤ºã ã‘ã€ç‹™ã†ã€‚

      // å·®åˆ†ã®è¡¨ç¤ºã¯ â€œå¸­ã¨æ™‚é–“ã¨é‡‘é¡â€ ã ã‘ã§ã¯saleç‰¹å®šã§ããªã„ã®ã§ã€
      // ä»Šå›ã¯ã€Œsale.corrections ã‚’æŒã¤è¡Œã«ã ã‘è¿½åŠ è¡¨ç¤ºã€ã—ãŸã„ãŒã€è¡Œã¨saleã®ç´ä»˜ã‘ãŒå¿…è¦ã€‚
      // â†’ ç¢ºå®ŸåŒ–ã¯æ¬¡ã®æ®µéšï¼ˆPART4æ”¹ä¿®ï¼‰ã§ã‚„ã‚‹ã€‚
    });
  };
})();

/* =========================================================
  ã©ã“ã‹ã‚‰ã§ã‚‚å‘¼ã¹ã‚‹ã‚ˆã†ã« window ã«å…¬é–‹ï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰
========================================================= */
window.ONE_openFixForSaleId = openFixForSaleId;

/* ===== Fix screen hook (stable) ===== */
registerScreenHook("scrFix", ()=>{
  try{ renderFix(); }catch(e){ console.warn(e); }
});

/* =========================
  ã“ã“ã‹ã‚‰å…ˆã¯ PART6 ã§ç¶šã
========================= */
/* =========================
  PART6ï¼šå¸­ç™»éŒ²ï¼ˆæœ€å¤§ç€å¸­äººæ•° å®Œå…¨å»ƒæ­¢ï¼‰â€»å®Œæˆç‰ˆï¼ˆã‚ãªãŸã®æœ€æ–°ä»•æ§˜ï¼‰
  æ‰‹é †ï¼šåç§° â†’ ç·å¸­/ç·å“ â†’ å¸­ç•ªå· â†’ ä¿å­˜ â†’ ä½œã£ãŸå¸­ï¼ˆåç§°ã”ã¨ï¼‰
  â€»ã€Œå…¥åŠ›å–æ¶ˆã€ã€Œå…¨å¸­åˆæœŸåŒ–ã€ã¯ã“ã“ã«ç½®ã‹ãªã„ï¼ˆè¦æ±‚ï¼‰
========================= */

(function buildSeatSetupUI(){
  const scr = $("scrSeatSetup");
  scr.innerHTML = `
    <div style="font-weight:900; margin-bottom:10px">å¸­ç™»éŒ²</div>

    <!-- â‘  åç§° -->
    <div style="font-weight:900; margin-bottom:8px">â‘  åç§°</div>
    <div id="ssNameGrid" class="seatGrid" style="margin-bottom:8px"></div>
    <button class="btn lime full" id="ssNameCommit" style="margin-bottom:14px">æ±ºå®š</button>

    <!-- â‘¡ ç·å¸­æ•°ï¼ç·å“æ•° -->
    <div style="font-weight:900; margin-bottom:8px">â‘¡ ç·å¸­æ•° / ç·å“æ•°</div>
    <div style="display:flex; gap:10px; align-items:center; margin-bottom:14px">
      <button class="btn" id="ssCntMinus">â—€ï¸</button>
      <div style="flex:1; text-align:center; font-weight:900; border:1px solid rgba(255,255,255,0.10); border-radius:14px; padding:10px; background:rgba(255,255,255,0.04)" id="ssCntVal">0</div>
      <button class="btn" id="ssCntPlus">â–¶ï¸</button>
    </div>

    <!-- â‘¢ å¸­ç•ªå· -->
    <div style="font-weight:900; margin-bottom:8px">â‘¢ å¸­ç•ªå·ï¼ˆè‡ªå‹•ã§æ¬¡ãŒå…¥ã‚Šã¾ã™ï¼‰</div>
    <input class="btn full" id="ssStartLabel" placeholder="é–‹å§‹æ–‡å­—ï¼ˆä¾‹ï¼šA / 1 / ã‚ / ã‚¢ï¼‰" style="text-align:left; margin-bottom:6px" />
    <div style="opacity:.85; margin-bottom:14px">å…¥åŠ›ãŒ1æ–‡å­—ã®ã¿ã®å ´åˆã¯è‡ªå‹•ã§é€£ç•ªã«ãªã‚Šã¾ã™</div>

    <!-- â‘¤ ä¿å­˜ -->
    <button class="btn lime full" id="ssSave" style="padding:14px 12px; font-weight:900; margin-bottom:14px">ä¿å­˜</button>

    <!-- â‘¥ ä½œã£ãŸå¸­ï¼ˆåç§°ã”ã¨ï¼‰ -->
    <div style="font-weight:900; margin-bottom:8px">ä½œã£ãŸå¸­</div>
    <div id="ssGroups"></div>
  `;
})();

state.seatSetup = state.seatSetup || {
  baseNames: ["ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼","ãƒ†ãƒ¼ãƒ–ãƒ«","åº§æ•·","å€‹å®¤","ç«‹ã¡","ãã®ä»–"],
  customNames: [],
  selectedName: null,
  committedName: null,
  count: 0,
  groups: [] // {name, seatIds:[]}
};

function allNameButtons(){
  const arr = [];
  const othersIdx = state.seatSetup.baseNames.indexOf("ãã®ä»–");
  state.seatSetup.baseNames.forEach((n,i)=>{
    if(i===othersIdx){
      state.seatSetup.customNames.forEach(c=> arr.push(c));
    }
    arr.push(n);
  });
  return arr;
}

function renderNameGrid(){
  const grid = $("ssNameGrid");
  grid.innerHTML = "";
  allNameButtons().forEach(n=>{
    const b = document.createElement("div");
    b.className = "seatCard in";
    b.style.minHeight="56px";
    b.style.display="flex";
    b.style.alignItems="center";
    b.style.justifyContent="center";
    b.style.fontWeight="900";
    b.textContent = n;

    const on = (state.seatSetup.selectedName===n);
    if(on){
      b.style.outline = "2px solid rgba(122,167,255,0.9)";
      b.style.background = "rgba(122,167,255,0.14)";
    }

    b.onclick = ()=>{
      state.seatSetup.selectedName = (state.seatSetup.selectedName===n) ? null : n;
      renderNameGrid();
    };

    grid.appendChild(b);
  });
}

function applyDefaultCountByName(name){
  if(name==="ãƒ†ãƒ¼ãƒ–ãƒ«" || name==="åº§æ•·" || name==="å€‹å®¤"){
    state.seatSetup.count = 4;
  }else{
    state.seatSetup.count = 1;
  }
  $("ssCntVal").textContent = String(state.seatSetup.count);
}

$("ssNameCommit").onclick = ()=>{
  const pick = state.seatSetup.selectedName;
  if(!pick){ toast("åç§°ã‚’é¸æŠã—ã¦ãã ã•ã„"); return; }

  if(pick==="ãã®ä»–"){
    openModal(
      "åç§°è¿½åŠ ï¼ˆãã®ä»–ï¼‰",
      `<input id="ssNewName" class="btn full" style="text-align:left" placeholder="ä¾‹ï¼šä¸­åº­ãƒ†ãƒ©ã‚¹A1" />`,
      [
        {label:"è¿½åŠ ", lime:true, onClick:()=>{
          const v = ($("ssNewName").value||"").trim();
          if(!v){ toast("åç§°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"); return; }
          if(allNameButtons().includes(v)){ toast("åŒã˜åç§°ãŒã‚ã‚Šã¾ã™"); return; }
          state.seatSetup.customNames.push(v);
          state.seatSetup.selectedName = v;
          state.seatSetup.committedName = v;
          closeModal();
          renderNameGrid();
          applyDefaultCountByName(v);
          toast("åç§°ã‚’è¿½åŠ ã—ã¾ã—ãŸ");
        }},
        {label:"æˆ»ã‚‹", lime:false, onClick:()=> closeModal()},
      ]
    );
    return;
  }

  state.seatSetup.committedName = pick;
  applyDefaultCountByName(pick);
  toast(`åç§°ï¼š${pick}`);
};

$("ssCntMinus").onclick = ()=>{
  state.seatSetup.count = Math.max(0, state.seatSetup.count - 1);
  $("ssCntVal").textContent = String(state.seatSetup.count);
};
$("ssCntPlus").onclick = ()=>{
  state.seatSetup.count = state.seatSetup.count + 1;
  $("ssCntVal").textContent = String(state.seatSetup.count);
};

/* é€£ç•ª */
function isSingleChar(str){ return (str||"").length===1; }
function nextLabelOneChar(ch){
  if(ch>="0" && ch<="9"){ const n=Number(ch); if(Number.isFinite(n)) return String(n+1); }
  if(ch>="a" && ch<="z"){ return ch==="z" ? "a" : String.fromCharCode(ch.charCodeAt(0)+1); }
  if(ch>="A" && ch<="Z"){ return ch==="Z" ? "A" : String.fromCharCode(ch.charCodeAt(0)+1); }

  const hira = "ã‚ã„ã†ãˆãŠã‹ããã‘ã“ã•ã—ã™ã›ããŸã¡ã¤ã¦ã¨ãªã«ã¬ã­ã®ã¯ã²ãµã¸ã»ã¾ã¿ã‚€ã‚ã‚‚ã‚„ã‚†ã‚ˆã‚‰ã‚Šã‚‹ã‚Œã‚ã‚ã‚’ã‚“";
  const kata = "ã‚¢ã‚¤ã‚¦ã‚¨ã‚ªã‚«ã‚­ã‚¯ã‚±ã‚³ã‚µã‚·ã‚¹ã‚»ã‚½ã‚¿ãƒãƒ„ãƒ†ãƒˆãƒŠãƒ‹ãƒŒãƒãƒãƒãƒ’ãƒ•ãƒ˜ãƒ›ãƒãƒŸãƒ ãƒ¡ãƒ¢ãƒ¤ãƒ¦ãƒ¨ãƒ©ãƒªãƒ«ãƒ¬ãƒ­ãƒ¯ãƒ²ãƒ³";
  const hi = hira.indexOf(ch);
  if(hi!==-1) return hira[(hi+1)%hira.length];
  const ka = kata.indexOf(ch);
  if(ka!==-1) return kata[(ka+1)%kata.length];
  return null;
}
function buildSeatIds(start, count){
  const ids = [];
  const s=(start||"").trim();
  if(!s || count<=0) return ids;

  if(isSingleChar(s)){
    let cur=s;
    for(let i=0;i<count;i++){
      ids.push(cur);
      const nx = nextLabelOneChar(cur);
      if(!nx) break;
      cur = nx;
    }
    return ids;
  }else{
    // è‡ªå‹•å…¥åŠ›ã—ãªã„ï¼š1å¸­ã®ã¿
    return [s];
  }
}
function ensureSeatExists(id){
  if(state.seats.some(s=> s.id===id)) return;
  state.seats.push({
    id,
    status:"empty",
    people:0,
    name:"",
    total:0,
    bills:0,
    merged:false,
    mergeLabel:"",
    sub:null,
    orders:[]
  });
}

$("ssSave").onclick = ()=>{
  const name = state.seatSetup.committedName;
  const cnt = Number(state.seatSetup.count||0);
  const start = ($("ssStartLabel").value||"").trim();

  if(!name){ toast("åç§°ã‚’æ±ºå®šã—ã¦ãã ã•ã„"); return; }
  if(cnt<=0){ toast("ç·å¸­/ç·å“æ•°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"); return; }
  if(!start){ toast("é–‹å§‹æ–‡å­—ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"); return; }

  const seatIds = buildSeatIds(start, cnt);

  const unique = [];
  seatIds.forEach(id=>{
    if(state.seats.some(s=> s.id===id)) return;
    unique.push(id);
    ensureSeatExists(id);
  });

  if(unique.length===0){
    toast("ä½œæˆã§ãã‚‹å¸­ãŒã‚ã‚Šã¾ã›ã‚“ï¼ˆæ—¢ã«å­˜åœ¨ï¼‰");
    return;
  }

  state.seatSetup.groups.push({ name, seatIds: unique });

  // å³åæ˜ 
  renderSeats();
  renderGroups();

  // äºŒé‡ç™»éŒ²é˜²æ­¢ï¼šå•†å“ã¨åŒã˜æ€æƒ³
  $("ssStartLabel").value = "";

  if(typeof emitEvent==="function") emitEvent("seat_setup_save", {name, seatIds: unique});

  toast("ä¿å­˜ã—ã¾ã—ãŸ");
};

function renderGroups(){
  const box = $("ssGroups");
  box.innerHTML = "";
  if(state.seatSetup.groups.length===0){
    box.innerHTML = `<div style="opacity:.85">ã¾ã ä½œæˆã•ã‚Œã¦ã„ã¾ã›ã‚“</div>`;
    return;
  }

  // åç§°ã”ã¨ã«ã¾ã¨ã‚ã‚‹
  const byName = {};
  state.seatSetup.groups.forEach(g=>{
    if(!byName[g.name]) byName[g.name]=[];
    byName[g.name].push(g);
  });

  Object.keys(byName).forEach(name=>{
    const wrap = document.createElement("div");
    wrap.style.marginBottom="14px";

    // åç§°ã‚¿ãƒƒãƒ—ã§ç·¨é›†ï¼ˆæˆ»ã‚‹/åç§°å¤‰æ›´/å‰Šé™¤ + å¸­ä¸€è¦§ï¼ˆç•ªå·å¤‰æ›´/å‰Šé™¤ã‚¹ãƒ©ã‚¤ãƒ‰ï¼‰ï¼‰
    const head = document.createElement("button");
    head.className="btn full";
    head.style.textAlign="left";
    head.style.fontWeight="900";
    head.textContent=name;
    head.onclick = ()=> openSeatGroupEditor(name);
    wrap.appendChild(head);

    const grid = document.createElement("div");
    grid.className="seatGrid";
    grid.style.marginTop="10px";

    const ids = byName[name].flatMap(g=> g.seatIds);
    ids.forEach(id=>{
      const c=document.createElement("div");
      c.className="seatCard in";
      c.style.minHeight="56px";
      c.style.display="flex";
      c.style.alignItems="center";
      c.style.justifyContent="center";
      c.style.fontWeight="900";
      c.textContent=id;
      grid.appendChild(c);
    });

    wrap.appendChild(grid);
    box.appendChild(wrap);
  });
}

function openSeatGroupEditor(name){
  openModal(
    "åç§°",
    `
      <div style="font-weight:900; margin-bottom:10px">${name}</div>
      <div style="display:flex; gap:10px; margin-bottom:10px">
        <button class="btn" id="geBack">æˆ»ã‚‹</button>
        <button class="btn lime" id="geRename">åç§°å¤‰æ›´</button>
        <button class="btn" id="geDelete">å‰Šé™¤</button>
      </div>

      <div style="font-weight:900; margin-bottom:8px">å¸­ä¸€è¦§</div>
      <div id="geSeats"></div>
    `,
    [{label:"é–‰ã˜ã‚‹", lime:false, onClick:()=> closeModal()}]
  );

  setTimeout(()=>{
    $("geBack").onclick = ()=> closeModal();

    const ids = state.seatSetup.groups.filter(g=> g.name===name).flatMap(g=> g.seatIds);
    const list = $("geSeats");
    list.innerHTML = "";

    ids.forEach(id=>{
      const seat = seatById(id);
      const inUse = seat && seat.status!=="empty";
      const row = document.createElement("div");
      row.className="kRow";
      row.innerHTML = `
        <div class="kLeft">
          <div class="kSeat">${id}</div>
          <div class="kName" style="color:${inUse ? "var(--danger)" : "var(--text)"}">${inUse ? "ä½¿ç”¨ä¸­ã®ãŸã‚å‰Šé™¤ä¸å¯" : ""}</div>
        </div>
        <div class="kSlide" style="flex-direction:column; align-items:flex-end; gap:6px">
          <button class="btn" data-rename-seat="${id}">ç•ªå·å¤‰æ›´</button>
          <input class="kRange" data-del-seat="${id}" type="range" min="0" max="100" value="0" ${inUse ? "disabled" : ""}/>
        </div>
      `;
      list.appendChild(row);
    });

    // åç§°å¤‰æ›´
    $("geRename").onclick = ()=>{
      openModal(
        "åç§°å¤‰æ›´",
        `<input id="geNewName" class="btn full" style="text-align:left" value="${name}" />`,
        [
          {label:"å¤‰æ›´", lime:true, onClick:()=>{
            const v = ($("geNewName").value||"").trim();
            if(!v){ toast("åç§°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"); return; }
            const exists = state.seatSetup.groups.some(g=> g.name===v);
            if(exists && v!==name){ toast("åŒã˜åç§°ãŒã‚ã‚Šã¾ã™"); return; }

            state.seatSetup.groups.forEach(g=>{ if(g.name===name) g.name=v; });
            state.seatSetup.customNames = state.seatSetup.customNames.map(x=> x===name ? v : x);

            closeModal();
            renderNameGrid();
            renderGroups();
            toast("åç§°ã‚’å¤‰æ›´ã—ã¾ã—ãŸ");
          }},
          {label:"æˆ»ã‚‹", lime:false, onClick:()=> closeModal()},
        ]
      );
    };

    // åç§°å‰Šé™¤ï¼šæˆ»ã‚‹â†’å‰Šé™¤ã‚¹ãƒ©ã‚¤ãƒ‰
    $("geDelete").onclick = ()=>{
      openModal(
        "å‰Šé™¤ç¢ºèª",
        `
          <div style="color:var(--danger); font-weight:900; margin-bottom:10px">ã“ã®åç§°ã¨åç§°å†…ã®å…¨å¸­ã‚’å‰Šé™¤ã—ã¾ã™</div>
          <div style="opacity:.85; margin-bottom:10px">ä½¿ç”¨ä¸­ã®å¸­ãŒã‚ã‚‹å ´åˆã¯å‰Šé™¤ã§ãã¾ã›ã‚“</div>
          <input id="geDelSlide" class="kRange" type="range" min="0" max="100" value="0"/>
        `,
        [{label:"æˆ»ã‚‹", lime:false, onClick:()=> closeModal()}]
      );

      setTimeout(()=>{
        $("geDelSlide").onchange = ()=>{
          if(Number($("geDelSlide").value||0) < 88){ $("geDelSlide").value=0; return; }

          const ids2 = state.seatSetup.groups.filter(g=> g.name===name).flatMap(g=> g.seatIds);
          const blocked = ids2.some(id=>{
            const seat = seatById(id);
            return seat && seat.status!=="empty";
          });
          if(blocked){
            $("geDelSlide").value=0;
            toast("ä½¿ç”¨ä¸­ã®å¸­ãŒã‚ã‚‹ãŸã‚å‰Šé™¤ã§ãã¾ã›ã‚“");
            return;
          }

          ids2.forEach(id=>{
            state.seats = state.seats.filter(s=> s.id!==id);
          });

          state.seatSetup.groups = state.seatSetup.groups.filter(g=> g.name!==name);
          state.seatSetup.customNames = state.seatSetup.customNames.filter(x=> x!==name);

          closeModal();
          closeModal();
          renderSeats();
          renderGroups();
          renderNameGrid();
          toast("å‰Šé™¤ã—ã¾ã—ãŸ");
        };
      },0);
    };

    // å¸­ç•ªå·å¤‰æ›´
    list.querySelectorAll("[data-rename-seat]").forEach(btn=>{
      btn.onclick = ()=>{
        const oldId = btn.getAttribute("data-rename-seat");
        openModal(
          "å¸­ç•ªå·å¤‰æ›´",
          `
            <div style="margin-bottom:8px">ç¾åœ¨ï¼š${oldId}</div>
            <input id="geSeatNewId" class="btn full" style="text-align:left" placeholder="æ–°ã—ã„å¸­ç•ªå·" />
          `,
          [
            {label:"å¤‰æ›´", lime:true, onClick:()=>{
              const newId = ($("geSeatNewId").value||"").trim();
              if(!newId){ toast("å¸­ç•ªå·ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"); return; }
              if(state.seats.some(s=> s.id===newId)){ toast("åŒã˜å¸­ç•ªå·ãŒã‚ã‚Šã¾ã™"); return; }

              const seat = seatById(oldId);
              if(seat) seat.id = newId;

              state.seatSetup.groups.forEach(g=>{
                if(g.name===name){
                  g.seatIds = g.seatIds.map(x=> x===oldId ? newId : x);
                }
              });

              closeModal();
              renderSeats();
              renderGroups();
              toast("å¸­ç•ªå·ã‚’å¤‰æ›´ã—ã¾ã—ãŸ");
            }},
            {label:"æˆ»ã‚‹", lime:false, onClick:()=> closeModal()},
          ]
        );
      };
    });

    // å€‹åˆ¥å¸­å‰Šé™¤ï¼ˆç¢ºèªãªã—ã€ã‚¹ãƒ©ã‚¤ãƒ‰ç¢ºå®šï¼‰
    list.querySelectorAll("[data-del-seat]").forEach(sl=>{
      sl.onchange = ()=>{
        if(sl.disabled) return;
        if(Number(sl.value||0) < 88){ sl.value=0; return; }

        const id = sl.getAttribute("data-del-seat");
        const seat = seatById(id);
        if(seat && seat.status!=="empty"){
          sl.value=0;
          toast("ä½¿ç”¨ä¸­ã®ãŸã‚å‰Šé™¤ã§ãã¾ã›ã‚“");
          return;
        }

        state.seats = state.seats.filter(s=> s.id!==id);
        state.seatSetup.groups.forEach(g=>{
          if(g.name===name){
            g.seatIds = g.seatIds.filter(x=> x!==id);
          }
        });
        state.seatSetup.groups = state.seatSetup.groups.filter(g=> !(g.name===name && g.seatIds.length===0));

        renderSeats();
        renderGroups();
        toast("å‰Šé™¤ã—ã¾ã—ãŸ");
      };
    });
  },0);
}

renderNameGrid();
renderGroups();

/* =========================
  ã“ã“ã‹ã‚‰å…ˆã¯ PART7 ã§ç¶šã
========================= */
/* =========================
  PART7ï¼šåŒæœŸãƒ»ç«¯æœ«ç®¡ç†ãƒ»ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ï¼ˆå®Œæˆç‰ˆï¼‰
  é‡è¦ï¼š
   - ğŸ“¶ã¯æ®‹ã™
   - ãƒ¡ã‚¤ãƒ³ç”»é¢ã®ã€ŒåŒæœŸçŠ¶æ…‹ï¼šã€œã€æ–‡å­—ã¯ãã‚‚ãã‚‚è¡¨ç¤ºã—ãªã„ï¼ˆPART1ã§å‰Šé™¤æ¸ˆã¿ï¼‰
   - å‹æ‰‹ã«åŒæœŸã—ãªã„ï¼ˆæ“ä½œã”ã¨ã«â€œ1å›ã ã‘è©¦ã™â€ï¼‹æœªåŒæœŸãŒã‚ã‚‹æ™‚ã ã‘10åˆ†ãŠãè©¦è¡Œï¼‰
   - ä¿å­˜ï¼ç¢ºå®šä¿å­˜ï¼‹æœªåŒæœŸãŒã‚ã‚Œã°å†é€
   - FREEç«¯æœ«3å°åˆ¶é™ï¼ˆåŒæœŸä¸å¯ã€ãƒ­ãƒ¼ã‚«ãƒ«æ“ä½œã¯å¯èƒ½ï¼‰
========================= */

/* ===== Storage helpers ===== */
function loadStore(){
  try{
    const raw = localStorage.getItem(KEY);
    if(!raw) return null;
    return JSON.parse(raw);
  }catch(e){
    return null;
  }
}
function saveStore(obj){
  localStorage.setItem(KEY, JSON.stringify(obj));
}

/* ===== Device ID / limit ===== */
function getDeviceId(){
  const k = KEY + "_DEVICE_ID";
  let id = localStorage.getItem(k);
  if(!id){
    id = "dev_" + Math.random().toString(36).slice(2);
    localStorage.setItem(k, id);
  }
  return id;
}

state.sync = state.sync || {
  deviceId: getDeviceId(),
  devices: [],
  pending: [],
  lastTryTs: 0,
  maxDevicesFree: 3,
  canSync: true,
};

function ensureDeviceRegistered(){
  const st = loadStore() || {};
  st.devices = st.devices || [];
  if(!st.devices.includes(state.sync.deviceId)){
    st.devices.push(state.sync.deviceId);
  }
  state.sync.devices = st.devices.slice();
  saveStore(st);

  state.sync.canSync = (state.sync.devices.length <= state.sync.maxDevicesFree);
  return state.sync.canSync;
}

/* ===== Persist / Restore ===== */
function persistAll(){
  const st = loadStore() || {};
  st.devices = state.sync.devices.slice();
  st.pending = state.sync.pending;

  st.seats = state.seats;
  st.seatSetup = state.seatSetup;
  st.kitchen = state.kitchen;
  st.sales = state.sales;
  st.menu = state.menu;

  st.updatedTs = nowTs();
  saveStore(st);
}

function restoreAll(){
  const st = loadStore();
  if(!st) return;

  if(Array.isArray(st.seats)) state.seats = st.seats;
  if(st.seatSetup) state.seatSetup = st.seatSetup;
  if(st.kitchen) state.kitchen = st.kitchen;
  if(st.sales) state.sales = st.sales;
  if(st.menu) state.menu = st.menu;

  state.sync.devices = Array.isArray(st.devices) ? st.devices : [];
  state.sync.pending = Array.isArray(st.pending) ? st.pending : [];

  setSync(state.sync.pending.length === 0);
}

/* ===== Event queue ===== */
function emitEvent(type, payload){
  const ev = {
    id: "ev_" + Math.random().toString(36).slice(2),
    type,
    ts: nowTs(),
    deviceId: state.sync.deviceId,
    payload: payload || {}
  };
  state.sync.pending.push(ev);
  setSync(false);
  persistAll();
  trySyncOnceSilent();
}

/* ===== Sync attempt (pseudo) ===== */
function canActuallySync(){
  if(!ensureDeviceRegistered()) return false;
  if(typeof navigator !== "undefined" && navigator.onLine === false) return false;
  return true;
}

function trySyncOnceSilent(){
  if(state.sync.pending.length === 0) return;
  const now = nowTs();
  if(now - state.sync.lastTryTs < 10_000) return; // é€£æ‰“é˜²æ­¢
  state.sync.lastTryTs = now;

  if(!canActuallySync()){
    return; // é™ã‹ã«å¤±æ•—
  }

  // æˆåŠŸæ‰±ã„ï¼ˆæœ¬ç•ªã¯ã‚µãƒ¼ãƒãƒ¼é€ä¿¡â†’æˆåŠŸã§clearï¼‰
  state.sync.pending = [];
  setSync(true);
  persistAll();
}

function manualSync(){
  if(state.sync.pending.length === 0){
    setSync(true);
    toast("åŒæœŸã•ã‚Œã¦ã„ã¾ã™");
    return;
  }

  if(!ensureDeviceRegistered()){
    openModal(
      "åŒæœŸ",
      "ç„¡æ–™ç‰ˆã§ã¯åŒæœŸã§ãã‚‹ç«¯æœ«ã¯3å°ã¾ã§ã§ã™<br>æœ‰æ–™ç‰ˆã§ã¯åˆ©ç”¨å¯èƒ½ãªç«¯æœ«æ•°ãŒå¢—ãˆã¾ã™",
      [{label:"æˆ»ã‚‹", lime:false, onClick:()=> closeModal()}]
    );
    return;
  }

  if(!canActuallySync()){
    toast("åŒæœŸã§ãã¾ã›ã‚“ã§ã—ãŸï¼ˆé›»æ³¢çŠ¶æ³ã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼‰");
    setSync(false);
    persistAll();
    return;
  }

  state.sync.pending = [];
  setSync(true);
  persistAll();
  toast("åŒæœŸã—ã¾ã—ãŸ");
}

/* ===== Auto trial (10åˆ†ãŠãã€æœªåŒæœŸãŒã‚ã‚‹å ´åˆã®ã¿) ===== */
(function startAutoTrial(){
  if(startAutoTrial._started) return;
  startAutoTrial._started = true;

  setInterval(()=>{
    if(state.sync.pending.length === 0) return;
    trySyncOnceSilent();
  }, 10 * 60 * 1000);
})();

/* ===== Save ===== */
function openSaveModal(){
  openModal(
    "ä¿å­˜",
    "æ³¨æ–‡ãƒ»ä¼šè¨ˆãƒ»å¸­æƒ…å ±ã¯ç«¯æœ«é–“ã§è‡ªå‹•åŒæœŸã•ã‚Œã¾ã™ï¼ˆé›»æ³¢çŠ¶æ³ãŒè‰¯å¥½ãªå ´åˆï¼‰<br><br>âš ï¸ å–¶æ¥­çµ‚äº†æ™‚ãƒ»é€€å‹¤æ™‚ã«ã¯å¿…ãšä¿å­˜ã‚’è¡Œã£ã¦ãã ã•ã„",
    [
      {label:"ç¢ºå®šä¿å­˜", lime:true, onClick:()=>{
        closeModal();
        performSave();
      }},
      {label:"æˆ»ã‚‹", lime:false, onClick:()=> closeModal()},
    ]
  );
}

function performSave(){
  ensureDeviceRegistered();
  persistAll();

  if(state.sync.pending.length){
    manualSync();
  }else{
    setSync(true);
    toast("ä¿å­˜ã—ã¾ã—ãŸ");
  }
}

/* ===== Antenna tap behavior ===== */
function openSyncModal(){
  if(state.sync.canSync === false){
    openModal(
      "åŒæœŸ",
      "ç„¡æ–™ç‰ˆã§ã¯åŒæœŸã§ãã‚‹ç«¯æœ«ã¯3å°ã¾ã§ã§ã™<br>æœ‰æ–™ç‰ˆã§ã¯åˆ©ç”¨å¯èƒ½ãªç«¯æœ«æ•°ãŒå¢—ãˆã¾ã™",
      [{label:"æˆ»ã‚‹", lime:false, onClick:()=> closeModal()}]
    );
    return;
  }

  if(state.sync.pending.length === 0){
    openModal("åŒæœŸ", "åŒæœŸã•ã‚Œã¦ã„ã¾ã™", [
      {label:"æˆ»ã‚‹", lime:false, onClick:()=> closeModal()}
    ]);
    return;
  }

  openModal(
    "åŒæœŸ",
    "åŒæœŸã•ã‚Œã¦ã„ã¾ã›ã‚“<br>é›»æ³¢çŠ¶æ³ã‚„ä¸€æ™‚çš„ãªä¸å…·åˆã®å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™<br>ä¿å­˜ã‚’è¡Œã†ã¨å†åŒæœŸã‚’è©¦ã¿ã¾ã™",
    [
      {label:"åŒæœŸé–‹å§‹", lime:true, onClick:()=>{
        closeModal();
        manualSync();
      }},
      {label:"æˆ»ã‚‹", lime:false, onClick:()=> closeModal()},
    ]
  );
}

/* ===== Hook header buttons ===== */
(function hookHeaderButtonsPart7(){
  $("btnSave").onclick = ()=> openSaveModal();
  $("btnAntenna").onclick = ()=> openSyncModal();
})();

/* ===== Boot ===== */
(function bootPart7(){
  ensureDeviceRegistered();
  restoreAll();

  // pendingãŒã‚ã‚Œã°ğŸ“¶âŒ
  setSync(state.sync.pending.length === 0);

  // ç«¯æœ«åˆ¶é™åæ˜ 
  ensureDeviceRegistered();

  // å¾©å…ƒå¾Œã«å†æç”»
  renderSeats();
})();
 /* =========================
  ã“ã“ã‹ã‚‰å…ˆã¯ PART8 ã§ç¶šã
========================= */
/* =========================
  PART8ï¼šè¨­å®šãƒ»ãƒ˜ãƒ«ãƒ—ãƒ»æœ‰æ–™å°ç·š ï¼‹ ãƒ¡ãƒ‹ãƒ¥ãƒ¼ç™»éŒ²ï¼ˆå®Œæˆç‰ˆï¼‰
  é‡è¦ï¼šã“ã“ã§HTMLã‚’é–‰ã˜ã¦8åˆ†å‰²å®Œæˆ
========================= */

/* =========================================================
   A) è¨­å®šï¼ˆscrSettingsï¼‰
   â€»ãƒœã‚¿ãƒ³é…ç½®ã¯å†™çœŸFå¯„ã›ï¼ˆç¸¦ä¸¦ã³ãƒ»åˆ†ã‹ã‚Šã‚„ã™ãï¼‰
========================================================= */
(function buildSettingsUI(){
  const scr = $("scrSettings");
  scr.innerHTML = `
    <div style="font-weight:900; margin-bottom:10px">è¨­å®š</div>

    <button class="btn lime full" id="goHelp" style="margin-bottom:10px">ãƒ˜ãƒ«ãƒ— / Q&A</button>
    <button class="btn full" id="goContact" style="margin-bottom:10px">ãŠå•åˆã›</button>
    <button class="btn full" id="goTerms" style="margin-bottom:14px">åˆ©ç”¨æ¡ä»¶ãƒ»æ³¨æ„äº‹é …</button>

    <div style="border:1px solid rgba(255,255,255,0.10); border-radius:14px; padding:12px; background:rgba(255,255,255,0.04); margin-bottom:12px">
      <div style="font-weight:900; margin-bottom:6px">ç„¡æ–™ç‰ˆã«ã¤ã„ã¦</div>
      <div style="opacity:.88">
        ãƒ»åˆ©ç”¨å¯èƒ½ç«¯æœ«ï¼šæœ€å¤§3å°<br>
        ãƒ»ãƒ‡ãƒ¼ã‚¿ã®å¾©æ—§ã€ä¿è¨¼ãªã—<br>
        ãƒ»ã‚µãƒãƒ¼ãƒˆã¯é™å®šçš„
      </div>
    </div>

    <div style="border:1px solid rgba(255,255,255,0.10); border-radius:14px; padding:12px; background:rgba(255,255,255,0.04); margin-bottom:12px">
      <div style="font-weight:900; margin-bottom:6px">æœ‰æ–™ç‰ˆã®ã”æ¡ˆå†…</div>
      <div style="opacity:.88">
        ãƒ»åˆ©ç”¨ç«¯æœ«æ•°ã®æ‹¡å¼µ<br>
        ãƒ»ãƒ‡ãƒ¼ã‚¿ã®å®‰å…¨ãªä¿å­˜<br>
        ãƒ»ã‚µãƒãƒ¼ãƒˆå¯¾å¿œ<br>
        ãƒ»ç¨ç†å£«ã€ä¼šè¨ˆã‚½ãƒ•ãƒˆå‘ã‘ãƒ‡ãƒ¼ã‚¿å‡ºåŠ›<br>
        ãƒ»å£²ä¸Šåˆ†æã€ã‚°ãƒ©ãƒ•è¡¨ç¤º<br>
        ãƒ»AIã«ã‚ˆã‚‹æ–™ç†ãƒ»ãƒ¡ãƒ‹ãƒ¥ãƒ¼ææ¡ˆ<br>
        ãƒ»å°†æ¥è¿½åŠ ã•ã‚Œã‚‹æ–°æ©Ÿèƒ½
      </div>
    </div>

    <div style="border:1px solid rgba(255,255,255,0.10); border-radius:14px; padding:12px; background:rgba(255,255,255,0.04)">
      <div style="font-weight:900; margin-bottom:6px">ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±</div>
      <div style="opacity:.88">
        ONE<br>
        Versionï¼šFREE 0.2.0<br>
        æ›´æ–°æ—¥ï¼š2026/02/11<br>
        ç¾åœ¨ã¯ç„¡æ–™ç‰ˆã§ã™
      </div>
    </div>
  `;
})();

/* =========================================================
   B) ãƒ˜ãƒ«ãƒ— / Q&Aï¼ˆãƒ¢ãƒ¼ãƒ€ãƒ«ï¼‰
========================================================= */
const QA_LIST = [
  {q:"ä¼šè¨ˆåˆç®—ã¯ã©ã†ã‚„ã£ã¦è¡Œã„ã¾ã™ã‹ï¼Ÿ", a:"åŒã˜å¸­å†…ã«ã‚ã‚‹è¤‡æ•°ã®ä¼šè¨ˆã‚’ã€ä¼šè¨ˆåˆç®—ãƒœã‚¿ãƒ³ã§ã¾ã¨ã‚ã¾ã™ã€‚åˆ¥ã®å¸­åŒå£«ã‚’ç›´æ¥åˆç®—ã™ã‚‹ã“ã¨ã¯ã§ãã¾ã›ã‚“ã€‚åˆ¥å¸­ã‚’ã¾ã¨ã‚ãŸã„å ´åˆã¯ã€å…ˆã«å¸­ç§»å‹•ã§åŒã˜å¸­ã«é›†ã‚ã¦ãã ã•ã„ã€‚"},
  {q:"åˆ¥ã®å¸­åŒå£«ã‚’ç›´æ¥åˆç®—ã§ããªã„ã®ã¯ãªãœã§ã™ã‹ï¼Ÿ", a:"æ“ä½œãƒŸã‚¹ã‚„ä¼šè¨ˆäº‹æ•…ã‚’é˜²ããŸã‚ã§ã™ã€‚ONEã§ã¯ã€Œå¸­ï¼ä¼šè¨ˆã®ç®±ã€ã¨ã—ã¦ç®¡ç†ã—ã¦ã„ã‚‹ãŸã‚ã€åˆç®—ã¯å¿…ãšåŒä¸€å¸­å†…ã§è¡Œã†è¨­è¨ˆã«ãªã£ã¦ã„ã¾ã™ã€‚"},
  {q:"å¸­ç§»å‹•ã¨ä¼šè¨ˆåˆç®—ã®é•ã„ã¯ä½•ã§ã™ã‹ï¼Ÿ", a:"å¸­ç§»å‹•ã¯ã€ç‰©ç†çš„ã«ãŠå®¢ã•ã¾ãŒå¸­ã‚’ç§»ã£ãŸæ™‚ã®æ“ä½œã§ã™ã€‚ä¼šè¨ˆåˆç®—ã¯ã€åŒã˜å¸­ã®ä¸­ã«ã‚ã‚‹ä¼šè¨ˆã‚’ã¾ã¨ã‚ã‚‹æ“ä½œã§ã™ã€‚ç›®çš„ãŒé•ã†ãŸã‚ã€æ“ä½œã‚‚åˆ†ã‹ã‚Œã¦ã„ã¾ã™ã€‚"},
  {q:"ä¼šè¨ˆåˆ†å‰²ã¯ã„ã¤ã§ãã¾ã™ã‹ï¼Ÿ", a:"åŒä¸€å¸­å†…ã§ã€åˆç®—ã•ã‚Œã¦ã„ã‚‹ä¼šè¨ˆã‚’å…ƒã«æˆ»ã—ãŸã„æ™‚ã«è¡Œã„ã¾ã™ã€‚ãªãŠã€åˆç®—å¾Œã«è¿½åŠ ã•ã‚ŒãŸæ³¨æ–‡ã¯åˆ†å‰²ã§ãã¾ã›ã‚“ã€‚"},
  {q:"å•†å“ãŒæ¥ãªã‹ã£ãŸå ´åˆã®ä¿®æ­£æ–¹æ³•ã¯ï¼Ÿ", a:"ä¼šè¨ˆç¢ºå®šå‰ã§ã‚ã‚Œã°ã€æ³¨æ–‡ç”»é¢ã‹ã‚‰è©²å½“å•†å“ã‚’å–æ¶ˆã—ã¦ãã ã•ã„ã€‚å–æ¶ˆã¯ã€Œâˆ’æ³¨æ–‡ã€ã¨ã—ã¦å±¥æ­´ã«æ®‹ã‚Šã¾ã™ã€‚"},
  {q:"æ³¨æ–‡æ•°ã‚’é–“é•ãˆãŸæ™‚ã¯ã©ã†ãªã‚Šã¾ã™ã‹ï¼Ÿ", a:"æ³¨æ–‡ç”»é¢ã®ã€Œæ³¨æ–‡å±¥æ­´ã€ã‚’ã‚¿ãƒƒãƒ—ã™ã‚‹ã“ã¨ã§ä¿®æ­£ã§ãã¾ã™ã€‚æ³¨æ–‡å¾Œã§ã‚‚å–æ¶ˆãŒå¯èƒ½ã§ã€0ä»¥ä¸‹ã«ã¯ãªã‚Šã¾ã›ã‚“ã€‚ä¿®æ­£å†…å®¹ã¯å±¥æ­´ã¨ã—ã¦æ®‹ã‚Šã¾ã™ã€‚"},
  {q:"ã‚­ãƒƒãƒãƒ³ç”»é¢ã®ä¸¦ã³é †ã¯ã©ã†ãªã£ã¦ã„ã¾ã™ã‹ï¼Ÿ", a:"æœªèª¿ç†ã®å•†å“ãŒä¸Šã«è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚åŒã˜å•†å“ãŒã‚ã‚‹å ´åˆã¯ã€ã¾ã¨ã‚ã¦è¡¨ç¤ºã•ã‚Œã‚‹ãŸã‚ã€ã¾ã¨ã‚ã¦èª¿ç†ã—ã‚„ã™ããªã£ã¦ã„ã¾ã™ã€‚"},
  {q:"èª¿ç†å®Œäº†ã¯ã©ã†ã‚„ã£ã¦è¡Œã„ã¾ã™ã‹ï¼Ÿ", a:"è©²å½“å•†å“ã®ã‚¹ãƒ©ã‚¤ãƒ‰æ“ä½œã§èª¿ç†å®Œäº†ã¨ãªã‚Šã¾ã™ã€‚ã‚¿ãƒƒãƒ—ã ã‘ã§ã¯å®Œäº†ã—ãªã„ãŸã‚ã€èª¤æ“ä½œã‚’é˜²ã’ã¾ã™ã€‚"},
  {q:"æ³¨æ–‡å–æ¶ˆã¯ã‚­ãƒƒãƒãƒ³ã«ã©ã†è¡¨ç¤ºã•ã‚Œã¾ã™ã‹ï¼Ÿ", a:"å–æ¶ˆã•ã‚ŒãŸæ³¨æ–‡ã¯ã€ã‚­ãƒƒãƒãƒ³ç”»é¢ã‹ã‚‰è‡ªå‹•çš„ã«é™¤å¤–ã•ã‚Œã¾ã™ã€‚ã™ã§ã«æä¾›æ¸ˆã¿ã®å•†å“ã«ã¯å½±éŸ¿ã—ã¾ã›ã‚“ã€‚"},
  {q:"é›»æ³¢ãŒãªã„å ´æ‰€ã§ã‚‚ä½¿ãˆã¾ã™ã‹ï¼Ÿ", a:"ä½¿ãˆã¾ã™ã€‚æ³¨æ–‡ãƒ»ä¼šè¨ˆãƒ»å¸­æ“ä½œã¯ç«¯æœ«å†…ã«ä¿å­˜ã•ã‚Œã¾ã™ã€‚ãŸã ã—ã€ç«¯æœ«é–“ã§ã®ãƒ‡ãƒ¼ã‚¿å…±æœ‰ã¯è¡Œã‚ã‚Œãªã„ãŸã‚ã€é€šä¿¡ç’°å¢ƒãŒæ•´ã£ã¦ã„ã‚‹å ´æ‰€ã§ã®åˆ©ç”¨ã‚’æ¨å¥¨ã—ã¾ã™ã€‚"},
  {q:"åŒæœŸãƒãƒ¼ã‚¯âŒãŒå‡ºãŸæ™‚ã¯ã©ã†ã™ã‚Œã°ã„ã„ã§ã™ã‹ï¼Ÿ", a:"é›»æ³¢çŠ¶æ³ã‚„ä¸€æ™‚çš„ãªä¸å…·åˆã«ã‚ˆã‚Šã€åŒæœŸã§ãã¦ã„ãªã„çŠ¶æ…‹ã§ã™ã€‚é›»æ³¢ã®è‰¯ã„å ´æ‰€ã§åŒæœŸã‚’è¡Œã£ã¦ãã ã•ã„ã€‚çŠ¶æ³ã«ã‚ˆã£ã¦ã¯ã€è‡ªå‹•çš„ã«å†åŒæœŸã•ã‚Œã‚‹å ´åˆã‚‚ã‚ã‚Šã¾ã™ã€‚"},
  {q:"è¤‡æ•°ç«¯æœ«ã§åŒæ™‚ã«ä½¿ãˆã¾ã™ã‹ï¼Ÿ", a:"ç„¡æ–™ç‰ˆã§ã¯æœ€å¤§3å°ã¾ã§ä½¿ç”¨ã§ãã¾ã™ã€‚æ³¨æ–‡ç¢ºå®šã‚„ä¼šè¨ˆç¢ºå®šãªã©ã€æ±ºå®šã‚’ä¼´ã†æ“ä½œã”ã¨ã«ç«¯æœ«é–“ã§åŒæœŸã•ã‚Œã¾ã™ã€‚"},
  {q:"ãƒ‡ãƒ¼ã‚¿ã¯ã©ã“ã«ä¿å­˜ã•ã‚Œã¦ã„ã¾ã™ã‹ï¼Ÿ", a:"ã™ã¹ã¦ä½¿ç”¨ã—ã¦ã„ã‚‹ç«¯æœ«å†…ã«ä¿å­˜ã•ã‚Œã¾ã™ã€‚ç«¯æœ«ã®æ•…éšœãƒ»ç´›å¤±ãƒ»ä¸å…·åˆã«å‚™ãˆã€å£²ä¸Šç®¡ç†ã‹ã‚‰å®šæœŸçš„ã«ãƒ‡ãƒ¼ã‚¿ã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’è¡Œã£ã¦ãã ã•ã„ã€‚"},
  {q:"æ©Ÿç¨®å¤‰æ›´ã—ãŸå ´åˆã¯ã©ã†ãªã‚Šã¾ã™ã‹ï¼Ÿ", a:"ç«¯æœ«å†…ã®ãƒ‡ãƒ¼ã‚¿ã¯è‡ªå‹•ã§ã¯å¼•ãç¶™ãŒã‚Œã¾ã›ã‚“ã€‚äº‹å‰ã«ä¿å­˜ã‚„ãƒ‡ãƒ¼ã‚¿é€ä¿¡ã‚’è¡Œã£ã¦ãã ã•ã„ã€‚"},
  {q:"å–¶æ¥­çµ‚äº†æ™‚ã«å¿…ãšè¡Œã†ã“ã¨ã¯ï¼Ÿ", a:"ä¿å­˜æ“ä½œã‚’è¡Œã„ã€å¿…è¦ã«å¿œã˜ã¦å£²ä¸Šãƒ‡ãƒ¼ã‚¿ã‚’ãƒ¡ãƒ¼ãƒ«ãªã©ã§é€ä¿¡ã—ã¦ãã ã•ã„ã€‚ãƒ‡ãƒ¼ã‚¿ä¿å…¨ã®ãŸã‚ã«é‡è¦ã§ã™ã€‚"},
];

function openHelp(){
  const body = QA_LIST.map(x=>`
    <div style="font-weight:900; margin-bottom:6px">Qï¼š${x.q}</div>
    <div style="opacity:.88; margin-bottom:12px">Aï¼š${x.a}</div>
  `).join("");

  openModal("ãƒ˜ãƒ«ãƒ— / Q&A", body, [{label:"æˆ»ã‚‹", lime:false, onClick:()=> closeModal()}]);
}

/* =========================================================
   C) ãŠå•åˆã›ï¼ˆãƒ¢ãƒ¼ãƒ€ãƒ«ï¼‰
========================================================= */
function openContact(){
  openModal(
    "ãŠå•åˆã›",
    `
      <div style="margin-bottom:10px; opacity:.9">
        ONEã«é–¢ã™ã‚‹ã”è³ªå•ãƒ»ä¸å…·åˆã®ã”é€£çµ¡ã¯ä¸‹è¨˜ã‚ˆã‚ŠãŠé¡˜ã„ã„ãŸã—ã¾ã™ã€‚
      </div>
      <div style="opacity:.88; margin-bottom:10px">
        ã”é€£çµ¡ã®éš›ã¯<br>
        ãƒ»åº—èˆ—å<br>
        ãƒ»ä½¿ç”¨ç«¯æœ«<br>
        ãƒ»ç™ºç”Ÿã—ãŸçŠ¶æ³<br>
        ã‚’è¨˜è¼‰ã„ãŸã ãã¨ã‚¹ãƒ ãƒ¼ã‚ºã§ã™ã€‚
      </div>
      <div style="opacity:.88">ãƒ»ãƒ¡ãƒ¼ãƒ«ã§å•ã„åˆã‚ã›ï¼ˆä»»æ„ï¼‰</div>
      <div style="opacity:.88">ãƒ»LINEã§å•ã„åˆã‚ã›ï¼ˆä»»æ„ï¼‰</div>
    `,
    [{label:"æˆ»ã‚‹", lime:false, onClick:()=> closeModal()}]
  );
}

/* =========================================================
   D) åˆ©ç”¨æ¡ä»¶ãƒ»æ³¨æ„äº‹é …ï¼ˆå›ºå®šæ–‡è¨€ï¼‰
========================================================= */
function openTerms(){
  openModal(
    "åˆ©ç”¨æ¡ä»¶ãƒ»æ³¨æ„äº‹é …",
    `
      <div style="opacity:.9">
        ãƒ»ãƒ‡ãƒ¼ã‚¿ã¯ç«¯æœ«å†…ã«ä¿å­˜ã•ã‚Œã¾ã™<br>
        ãƒ»ç„¡æ–™ç‰ˆã§ã¯ãƒ‡ãƒ¼ã‚¿ã®å¾©æ—§ãƒ»ä¿è¨¼ã¯è¡Œã„ã¾ã›ã‚“<br>
        ãƒ»å–¶æ¥­çµ‚äº†æ™‚ã«ã¯ä¿å­˜ã‚’è¡Œã£ã¦ãã ã•ã„<br>
        ãƒ»ãƒ‡ãƒ¼ã‚¿ç®¡ç†ã¯åˆ©ç”¨è€…ã®è²¬ä»»ã§è¡Œã£ã¦ãã ã•ã„
      </div>
      <div style="opacity:.75; margin-top:10px">â€» åˆå›èµ·å‹•ç”»é¢ã¨åŒä¸€å†…å®¹ï¼ˆæ–‡è¨€å›ºå®šï¼‰</div>
    `,
    [{label:"æˆ»ã‚‹", lime:false, onClick:()=> closeModal()}]
  );
}

/* =========================================================
   E) ãƒ¡ãƒ‹ãƒ¥ãƒ¼ç™»éŒ²ï¼ˆscrMenuï¼‰
   ä»•æ§˜ï¼š
    - ä¸Šéƒ¨ã¯å…±é€šãƒ«ãƒ¼ãƒ«
    - ã‚«ãƒ†ã‚´ãƒªãƒ¼ï¼ˆæ–™ç†/ãƒ‰ãƒªãƒ³ã‚¯ï¼‰ã¯ã‚­ãƒƒãƒãƒ³è¡¨ç¤ºã«åæ˜ ï¼ˆæ³¨æ–‡ã«ã¯å‡ºã•ãªã„ï¼‰
      â†’ æ–‡ã¯ã€Œç™»éŒ²ã€ã®ä¸‹ã«ç§»å‹•ï¼ˆã‚ãªãŸã®æŒ‡ç¤ºï¼‰
    - æ–™ç†/ãƒ‰ãƒªãƒ³ã‚¯ â†’ æ±ºå®š â†’ ã‚¸ãƒ£ãƒ³ãƒ«3åˆ—ï¼ˆæœ€å¾Œã«ï¼‹è¿½åŠ ï¼‰
      â†’ ã‚¸ãƒ£ãƒ³ãƒ«é¸æŠã§ä¸‹ã«ã€Œæ±ºå®šï¼ˆå·¦ï¼‰/å‰Šé™¤ï¼ˆå³ï¼‰ã€
      â†’ å‰Šé™¤ï¼šç¢ºèªâ†’æˆ»ã‚‹â†’å‰Šé™¤ã‚¹ãƒ©ã‚¤ãƒ‰ï¼ˆã‚¸ãƒ£ãƒ³ãƒ«å†…å•†å“ã‚‚å‰Šé™¤ï¼‰
    - æ±ºå®šâ†’ç™»éŒ²æ¬„ï¼ˆå•†å“å/é‡‘é¡/ç¨ç‡ï¼‰å…¨éƒ¨å…¥åŠ›ã§ç™»éŒ²
    - ç™»éŒ²å¾Œï¼šå•†å“å/é‡‘é¡ã¯ç©ºç™½ã¸ï¼ˆäºŒé‡ç™»éŒ²é˜²æ­¢ï¼‰
    - ä¸‹æ®µã«ä¸€è¦§ã€æ¨ªã«ç·¨é›†ï¼ˆã‚¸ãƒ£ãƒ³ãƒ«/å•†å“å/é‡‘é¡/ç¨ç‡ï¼‰
========================================================= */
(function buildMenuUI(){
  const scr = $("scrMenu");
  scr.innerHTML = `
    <div style="font-weight:900; margin-bottom:10px">ãƒ¡ãƒ‹ãƒ¥ãƒ¼ç™»éŒ²</div>

    <!-- ã‚«ãƒ†ã‚´ãƒªãƒ¼ -->
    <div style="font-weight:900; margin-bottom:8px">ã‚«ãƒ†ã‚´ãƒªãƒ¼</div>
    <div style="display:flex; gap:10px; margin-bottom:8px">
      <div class="seatCard in" id="catFood" style="flex:1; min-height:56px; display:flex; align-items:center; justify-content:center; font-weight:900">æ–™ç†</div>
      <div class="seatCard in" id="catDrink" style="flex:1; min-height:56px; display:flex; align-items:center; justify-content:center; font-weight:900">ãƒ‰ãƒªãƒ³ã‚¯</div>
    </div>
    <button class="btn lime full" id="catCommit" style="margin-bottom:10px">æ±ºå®š</button>

    <!-- ã‚¸ãƒ£ãƒ³ãƒ« -->
    <div id="genreArea" style="display:none">
      <div style="font-weight:900; margin-bottom:8px">ã‚¸ãƒ£ãƒ³ãƒ«</div>
      <div id="genreGrid" class="seatGrid" style="margin-bottom:8px"></div>

      <div style="display:flex; gap:10px; margin-bottom:10px">
        <button class="btn lime full" id="genreDecide" style="flex:1">æ±ºå®š</button>
        <button class="btn full" id="genreDelete" style="flex:1">å‰Šé™¤</button>
      </div>
    </div>

    <!-- ç™»éŒ² -->
    <div id="itemArea" style="display:none">
      <div style="font-weight:900; margin-bottom:8px">ç™»éŒ²</div>

      <div style="opacity:.85; margin-bottom:14px">
        ã‚«ãƒ†ã‚´ãƒªãƒ¼ï¼ˆæ–™ç†/ãƒ‰ãƒªãƒ³ã‚¯ï¼‰ã¯ã‚­ãƒƒãƒãƒ³ã®ã€Œæ–™ç†/ãƒ‰ãƒªãƒ³ã‚¯ã€è¡¨ç¤ºã«åæ˜ ã—ã¾ã™ï¼ˆæ³¨æ–‡ã«ã¯å‡ºã—ã¾ã›ã‚“ï¼‰ã€‚
      </div>

      <input id="itemName" class="btn full" placeholder="å•†å“å" style="text-align:left; margin-bottom:8px" />
      <input id="itemPrice" class="btn full" placeholder="é‡‘é¡ï¼ˆæ•°å­—ï¼‰" inputmode="numeric" style="text-align:left; margin-bottom:8px" />

      <div style="display:flex; gap:10px; margin-bottom:10px">
        <button class="btn full" id="tax8" style="flex:1">8%</button>
        <button class="btn full" id="tax10" style="flex:1">10%</button>
      </div>

      <button class="btn lime full" id="itemAdd" style="margin-bottom:14px">ç™»éŒ²</button>

      <div style="font-weight:900; margin-bottom:8px">ä½œã£ãŸå•†å“</div>
      <div id="itemList"></div>
    </div>
  `;
})();

/* ===== Menu state ===== */
state.menu = state.menu || {
  cat: null, // "food" | "drink"
  genres: { food: [], drink: [] },
  selectedGenre: null,
  tax: null,
  items: [] // {id, cat, genre, name, price, tax}
};

function setCardHL(el, on){
  el.style.outline = on ? "2px solid rgba(122,167,255,0.9)" : "";
  el.style.background = on ? "rgba(122,167,255,0.14)" : "";
}

function renderGenres(){
  const grid = $("genreGrid");
  grid.innerHTML = "";

  const list = state.menu.genres[state.menu.cat] || [];
  const final = list.concat(["ï¼‹ ã‚¸ãƒ£ãƒ³ãƒ«è¿½åŠ "]);

  final.forEach(g=>{
    const c = document.createElement("div");
    c.className = "seatCard in";
    c.style.minHeight="56px";
    c.style.display="flex";
    c.style.alignItems="center";
    c.style.justifyContent="center";
    c.style.fontWeight="900";
    c.textContent = g;

    const isAdd = (g==="ï¼‹ ã‚¸ãƒ£ãƒ³ãƒ«è¿½åŠ ");
    const on = (!isAdd && state.menu.selectedGenre===g);
    if(on) setCardHL(c,true);

    c.onclick = ()=>{
      if(isAdd){
        openModal(
          "ã‚¸ãƒ£ãƒ³ãƒ«è¿½åŠ ",
          `<input id="newGenre" class="btn full" style="text-align:left" placeholder="ã‚¸ãƒ£ãƒ³ãƒ«å" />`,
          [
            {label:"è¿½åŠ ", lime:true, onClick:()=>{
              const v = ($("newGenre").value||"").trim();
              if(!v){ toast("ã‚¸ãƒ£ãƒ³ãƒ«åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"); return; }
              const arr = state.menu.genres[state.menu.cat];
              if(arr.includes(v)){ toast("åŒã˜ã‚¸ãƒ£ãƒ³ãƒ«ãŒã‚ã‚Šã¾ã™"); return; }

              // ä½œã£ãŸã‚¸ãƒ£ãƒ³ãƒ«ã¯è¿½åŠ ãƒœãƒƒã‚¯ã‚¹ã®å‰ã«æ¥ã‚‹ï¼pushã§OKï¼ˆï¼‹ã¯å›ºå®šã§æœ€å¾Œã«æç”»ï¼‰
              arr.push(v);
              state.menu.selectedGenre = v;

              closeModal();
              renderGenres();
            }},
            {label:"æˆ»ã‚‹", lime:false, onClick:()=> closeModal()},
          ]
        );
        return;
      }

      state.menu.selectedGenre = (state.menu.selectedGenre===g) ? null : g;
      renderGenres();
    };

    grid.appendChild(c);
  });
}

function renderItems(){
  const box = $("itemList");
  box.innerHTML = "";

  const list = state.menu.items.filter(it=> it.cat===state.menu.cat && it.genre===state.menu.selectedGenre);

  if(list.length===0){
    box.innerHTML = `<div style="opacity:.85">ã¾ã ã‚ã‚Šã¾ã›ã‚“</div>`;
    return;
  }

  list.forEach(it=>{
    const row = document.createElement("div");
    row.className="kRow";
    row.innerHTML = `
      <div class="kLeft">
        <div class="kName">${it.name}</div>
      </div>
      <div class="kSlide" style="gap:10px">
        <div style="font-weight:900">${yen(it.price)}</div>
        <div style="font-weight:900; opacity:.85">${it.tax}%</div>
        <button class="btn" data-edit="${it.id}">ç·¨é›†</button>
      </div>
    `;
    box.appendChild(row);
  });

  box.querySelectorAll("[data-edit]").forEach(btn=>{
    btn.onclick = ()=>{
      const id = btn.getAttribute("data-edit");
      const it = state.menu.items.find(x=> x.id===id);
      if(!it) return;

      openModal(
        "ç·¨é›†",
        `
          <div style="font-weight:900; margin-bottom:8px">ã‚¸ãƒ£ãƒ³ãƒ«</div>
          <div style="opacity:.9; margin-bottom:10px">${it.genre}</div>

          <div style="margin-bottom:6px">å•†å“å</div>
          <input id="eName" class="btn full" style="text-align:left" value="${it.name}" />

          <div style="margin-top:10px;margin-bottom:6px">é‡‘é¡</div>
          <input id="ePrice" class="btn full" style="text-align:left" inputmode="numeric" value="${it.price}" />

          <div style="margin-top:10px;margin-bottom:6px">ç¨ç‡</div>
          <div style="display:flex; gap:10px">
            <button class="btn full" id="e8" style="flex:1">8%</button>
            <button class="btn full" id="e10" style="flex:1">10%</button>
          </div>
        `,
        [
          {label:"ä¿å­˜", lime:true, onClick:()=>{
            const nm = ($("eName").value||"").trim();
            const pr = Number(($("ePrice").value||"").trim());
            if(!nm || !Number.isFinite(pr) || pr<=0 || !(it.tax===8 || it.tax===10)){
              toast("æœªè¨˜å…¥ãŒã‚ã‚Šã¾ã™");
              return;
            }
            it.name = nm;
            it.price = pr;
            closeModal();
            renderItems();
            persistAll && persistAll();
            toast("æ›´æ–°ã—ã¾ã—ãŸ");
          }},
          {label:"æˆ»ã‚‹", lime:false, onClick:()=> closeModal()},
        ]
      );

      setTimeout(()=>{
        const h = (v)=>{
          it.tax = v;
          $("e8").classList.toggle("lime", v===8);
          $("e10").classList.toggle("lime", v===10);
        };
        $("e8").onclick = ()=> h(8);
        $("e10").onclick = ()=> h(10);
        h(it.tax||10);
      },0);
    };
  });
}

/* ===== Menu interactions ===== */
(function hookMenu(){
  const food = $("catFood");
  const drink = $("catDrink");

  function pickCat(cat){
    state.menu.cat = cat;
    setCardHL(food, cat==="food");
    setCardHL(drink, cat==="drink");
  }

  food.onclick = ()=> pickCat("food");
  drink.onclick = ()=> pickCat("drink");

  $("catCommit").onclick = ()=>{
    if(!state.menu.cat){ toast("ã‚«ãƒ†ã‚´ãƒªãƒ¼ã‚’é¸æŠã—ã¦ãã ã•ã„"); return; }
    $("genreArea").style.display = "block";
    state.menu.selectedGenre = null;
    renderGenres();
    persistAll && persistAll();
  };

  $("genreDelete").onclick = ()=>{
    const g = state.menu.selectedGenre;
    if(!g){ toast("ã‚¸ãƒ£ãƒ³ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„"); return; }

    // å‰Šé™¤ãƒœã‚¿ãƒ³â†’ç¢ºèªç”»é¢â†’æˆ»ã‚‹ã§å‰Šé™¤ã‚¹ãƒ©ã‚¤ãƒ‰
    openModal(
      "å‰Šé™¤ç¢ºèª",
      "ã‚¸ãƒ£ãƒ³ãƒ«å†…ã®å•†å“ãŒå‰Šé™¤ã•ã‚Œã¾ã™",
      [
        {label:"æˆ»ã‚‹", lime:false, onClick:()=> closeModal()},
        {label:"å‰Šé™¤ã¸", lime:true, onClick:()=>{
          closeModal();
          openModal(
            "å‰Šé™¤",
            `
              <div style="color:var(--danger); font-weight:900; margin-bottom:10px">
                ã‚¸ãƒ£ãƒ³ãƒ«ã€Œ${g}ã€ã¨ã‚¸ãƒ£ãƒ³ãƒ«å†…å•†å“ã‚’å‰Šé™¤ã—ã¾ã™
              </div>
              <input id="gDelSlide" class="range" type="range" min="0" max="100" value="0" />
            `,
            [{label:"æˆ»ã‚‹", lime:false, onClick:()=> closeModal()}]
          );

          setTimeout(()=>{
            $("gDelSlide").onchange = ()=>{
              if(Number($("gDelSlide").value||0) < 88){ $("gDelSlide").value=0; return; }

              state.menu.items = state.menu.items.filter(it=> !(it.cat===state.menu.cat && it.genre===g));
              state.menu.genres[state.menu.cat] = state.menu.genres[state.menu.cat].filter(x=> x!==g);
              state.menu.selectedGenre = null;

              $("itemArea").style.display = "none";
              closeModal();
              renderGenres();
              persistAll && persistAll();
              toast("å‰Šé™¤ã—ã¾ã—ãŸ");
            };
          },0);
        }},
      ]
    );
  };

  $("genreDecide").onclick = ()=>{
    const g = state.menu.selectedGenre;
    if(!g){ toast("ã‚¸ãƒ£ãƒ³ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„"); return; }
    $("itemArea").style.display = "block";

    // ç¨ç‡
    const setTax = (v)=>{
      state.menu.tax = v;
      $("tax8").classList.toggle("lime", v===8);
      $("tax10").classList.toggle("lime", v===10);
    };
    $("tax8").onclick = ()=> setTax(8);
    $("tax10").onclick = ()=> setTax(10);
    setTax(10);

    renderItems();
    persistAll && persistAll();
  };

  $("itemAdd").onclick = ()=>{
    const g = state.menu.selectedGenre;
    const nm = ($("itemName").value||"").trim();
    const pr = Number(($("itemPrice").value||"").trim());
    const tx = state.menu.tax;

    if(!g || !nm || !Number.isFinite(pr) || pr<=0 || !(tx===8 || tx===10)){
      toast("æœªè¨˜å…¥ãŒã‚ã‚Šã¾ã™");
      return;
    }

    state.menu.items.push({
      id: "m_" + Math.random().toString(36).slice(2),
      cat: state.menu.cat,
      genre: g,
      name: nm,
      price: pr,
      tax: tx
    });

    // äºŒé‡ç™»éŒ²é˜²æ­¢ï¼šç©ºç™½ã«æˆ»ã™
    $("itemName").value = "";
    $("itemPrice").value = "";

    renderItems();
    persistAll && persistAll();

    toast("ç™»éŒ²ã—ã¾ã—ãŸ");
  };
})();

/* ===== è¨­å®šå°ç·š ===== */
$("goHelp").onclick = ()=> openHelp();
$("goContact").onclick = ()=> openContact();
$("goTerms").onclick = ()=> openTerms();

/* ===== Menu hook (stable) ===== */
registerScreenHook("scrMenu", ()=>{
  try{
    state.menu.cat = null;
    state.menu.selectedGenre = null;
    $("genreArea").style.display = "none";
    $("itemArea").style.display = "none";
    setCardHL($("catFood"), false);
    setCardHL($("catDrink"), false);
  }catch(e){ console.warn(e); }
});

/* ===== èµ·å‹•å¾Œã®æœ€å¾Œã®æ•´å½¢ ===== */
(function finalize(){
  // å¾©å…ƒæ¸ˆã¿ãªã‚‰æç”»ã€ç„¡ã‘ã‚Œã°åˆæœŸã®ã¾ã¾
  renderSeats();
})();

/* =========================
  ã“ã“ã¾ã§ã§ 8åˆ†å‰² å®Œæˆ
========================= */
</script>
</body>
</html>