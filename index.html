/* ========================= Menu list rendering + edit modal ========================= */
function renderMenuListBySelectedGenre(){
  const box = document.getElementById("menuList");
  box.innerHTML = "";

  const g = (state.ui.menuViewGenre||"æœªåˆ†é¡").trim() || "æœªåˆ†é¡";
  const items = state.menu
    .filter(m=> ((m.genre||"æœªåˆ†é¡").trim()||"æœªåˆ†é¡")===g)
    .sort((a,b)=> jaSort(a.name,b.name));

  const wrap = document.createElement("div");
  wrap.className = "listBox";
  wrap.innerHTML = `<div class="listHead">
    <span>${escapeHtml(g)}</span>
    <span class="muted2">${items.length}ä»¶</span>
  </div>`;
  const body = document.createElement("div");

  items.forEach(m=>{
    const row = document.createElement("div");
    row.className = "listRow";
    row.innerHTML = `
      <div class="listName">${escapeHtml(m.name)}</div>
      <div class="listMeta">${yen(m.price)} / ${m.tax}%</div>
      <div class="btnRow" style="gap:6px;">
        <button class="listBtn btnSmall" data-act="edit">ä¿®æ­£</button>
        <button class="listBtn btnDanger" data-act="del">å‰Šé™¤</button>
      </div>
    `;
    row.querySelector('[data-act="edit"]').onclick = ()=> openEditMenuModal(m);
    row.querySelector('[data-act="del"]').onclick = ()=> {
      openModal({
        title:"å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ",
        sub:`ã€Œ${m.name}ã€ã‚’å‰Šé™¤ã—ã¾ã™`,
        yesText:"å‰Šé™¤",
        noText:"æˆ»ã‚‹",
        yesClass:"btnDanger",
        onYes: ()=>{
          state.menu = state.menu.filter(x=> x.id!==m.id);
          save();
          closeModal();
          rebuildViewGenreSel();
          renderMenuListBySelectedGenre();
        }
      });
    };
    body.appendChild(row);
  });

  wrap.appendChild(body);
  box.appendChild(wrap);
}

function openEditMenuModal(m){
  const genresAll = new Set(["æœªåˆ†é¡"]);
  state.menu.forEach(x=> genresAll.add((x.genre||"æœªåˆ†é¡").trim()||"æœªåˆ†é¡"));
  const gArr = Array.from(genresAll).sort(jaSort);

  openModal({
    title:"ãƒ¡ãƒ‹ãƒ¥ãƒ¼ä¿®æ­£",
    sub:"ã‚¸ãƒ£ãƒ³ãƒ«ãƒ»å•†å“åãƒ»é‡‘é¡ãƒ»ç¨ç‡ã‚’å¤‰æ›´ã§ãã¾ã™",
    bodyHtml: `
      <div class="muted2">ã‚¸ãƒ£ãƒ³ãƒ«</div>
      <select id="emGenre">
        ${gArr.map(g=> `<option value="${escapeHtml(g)}">${escapeHtml(g)}</option>`).join("")}
      </select>

      <div class="muted2">å•†å“å</div>
      <input id="emName" type="text" value="${escapeHtml(m.name)}" />

      <div class="muted2">é‡‘é¡</div>
      <input id="emPrice" class="numField" type="number" inputmode="numeric" value="${escapeHtml(String(m.price||0))}" />

      <div class="muted2">ç¨ç‡</div>
      <select id="emTax">
        <option value="10">10%</option>
        <option value="8">8%</option>
      </select>
    `,
    yesText:"ç™»éŒ²",
    noText:"æˆ»ã‚‹",
    onYes: ()=>{
      const newGenre = (document.getElementById("emGenre").value||"æœªåˆ†é¡").trim() || "æœªåˆ†é¡";
      const newName = (document.getElementById("emName").value||"").trim();
      const newPrice = parseInt(document.getElementById("emPrice").value||"0",10);
      const newTax = parseInt(document.getElementById("emTax").value||"10",10);

      if(!newName || !newPrice){
        openModal({ title:"æœªå…¥åŠ›ãŒã‚ã‚Šã¾ã™", sub:"å•†å“åãƒ»é‡‘é¡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„", yesText:"OK" });
        return;
      }

      const dup = state.menu.find(x=> x.id!==m.id && (x.name||"").trim()===newName);
      if(dup){
        openModal({
          title:"åŒã˜æ–™ç†ï¼ˆãƒ‰ãƒªãƒ³ã‚¯ï¼‰ãŒã‚ã‚Šã¾ã™",
          sub:"åå‰ã‚’å¤‰ãˆã‚‹ã‹ã€æ—¢å­˜ã®æ–™ç†ï¼ˆãƒ‰ãƒªãƒ³ã‚¯ï¼‰ã‚’ç·¨é›†ã—ã¦ãã ã•ã„ã€‚",
          yesText:"OK"
        });
        return;
      }

      m.genre = newGenre;
      m.name = newName;
      m.price = newPrice;
      m.tax = newTax;

      save();
      closeModal();
      rebuildViewGenreSel();
      renderMenuListBySelectedGenre();
    }
  });

  setTimeout(()=>{
    document.getElementById("emGenre").value = (m.genre||"æœªåˆ†é¡").trim() || "æœªåˆ†é¡";
    document.getElementById("emTax").value = String(m.tax||10);
  },0);
}

document.getElementById("backMainFromMenuReg").onclick = ()=> go("settings");

/* ========================= Kitchen render + makeSlider ========================= */
function renderKitchen(){
  syncKitchenTabs();
  const tab = state.ui.kitchenTab;
  const kList = document.getElementById("kList");
  kList.innerHTML = "";

  const all = collectKitchenOrders().filter(o=> tab==="food" ? o.category==="food" : o.category==="drink");
  const remain = all.filter(o=> !state.kitchenDone[kitchenKey(o)]);

  if(tab==="drink"){
    remain.sort((a,b)=> a.ts-b.ts);
    for(const o of remain){
      kList.appendChild(renderKitchenCardSingle(o, false));
    }
    return;
  }

  const byName = {};
  for(const o of remain){
    byName[o.name] = byName[o.name] || [];
    byName[o.name].push(o);
  }
  const names = Object.keys(byName).sort(jaSort);

  for(const nm of names){
    const group = byName[nm].sort((a,b)=> (a.ts-b.ts) || (a.seatKey.localeCompare(b.seatKey, "ja", {numeric:true, sensitivity:"base"})));
    const base = group[0];
    const subs = group.slice(1);

    const promoted = subs.length>0;
    const card = renderKitchenCardGroup(base, subs, promoted);
    kList.appendChild(card);
  }
}

function renderKitchenCardSingle(o, promoted){
  const card = document.createElement("div");
  card.className = "kCard" + (promoted ? " promoted" : "");
  const overdue = (nowTs() - o.ts) >= 15*60*1000;
  if(overdue) card.classList.add("overdue");

  const left = document.createElement("div");
  left.innerHTML = `
    <div class="kName">${escapeHtml(o.name)} <span class="kQty">${escapeHtml(String(o.qty))}å€‹</span></div>
    <div class="kMeta">
      <span class="kSeat">${escapeHtml(o.seatLabel)}</span>
      <span class="kTime">${escapeHtml(fmtTime(o.ts))}</span>
    </div>
  `;

  const slider = makeSlider(()=>{
    state.kitchenDone[kitchenKey(o)] = true;
    save();
    renderKitchen();
  });

  card.appendChild(left);
  card.appendChild(slider);
  return card;
}

function renderKitchenCardGroup(base, subs, promoted){
  const card = document.createElement("div");
  card.className = "kCard" + (promoted ? " promoted" : "");
  const overdue = (nowTs() - base.ts) >= 15*60*1000;
  if(overdue) card.classList.add("overdue");

  const left = document.createElement("div");
  left.innerHTML = `
    <div class="kName">${escapeHtml(base.name)} <span class="kQty">${escapeHtml(String(base.qty))}å€‹</span></div>
    <div class="kMeta">
      <span class="kSeat">${escapeHtml(base.seatLabel)}</span>
      <span class="kTime">${escapeHtml(fmtTime(base.ts))}</span>
    </div>
  `;

  if(subs.length){
    const subWrap = document.createElement("div");
    subWrap.className = "kSubLine";

    subs.forEach(s=>{
      const row = document.createElement("div");
      row.className = "kSubItem";
      const overdueSub = (nowTs() - s.ts) >= 15*60*1000;

      const left2 = document.createElement("div");
      left2.className = "kSubLeft";
      left2.innerHTML = `
        <span class="kSeat">${escapeHtml(s.seatLabel)}</span>
        <span class="kTime">${escapeHtml(fmtTime(s.ts))}</span>
        <span class="kQty">${escapeHtml(String(s.qty))}å€‹</span>
      `;

      const sliderSub = makeSlider(()=>{
        state.kitchenDone[kitchenKey(s)] = true;
        save();
        renderKitchen();
      });

      row.appendChild(left2);
      row.appendChild(sliderSub);

      if(overdueSub){
        row.style.borderColor = "rgba(255,87,87,.35)";
        row.style.background = "rgba(255,87,87,.08)";
      }
      subWrap.appendChild(row);
    });

    left.appendChild(subWrap);
  }

  const sliderBase = makeSlider(()=>{
    state.kitchenDone[kitchenKey(base)] = true;
    save();
    renderKitchen();
  });

  card.appendChild(left);
  card.appendChild(sliderBase);
  return card;
}

function makeSlider(onDone){
  const slider = document.createElement("div");
  slider.className = "slider";
  slider.innerHTML = `
    <div class="sliderTrack">å®Œäº†</div>
    <div class="sliderKnob">â–¶</div>
  `;
  const knob = slider.querySelector(".sliderKnob");
  let dragging=false, startX=0, startLeft=0;

  const maxLeft = ()=> slider.clientWidth - knob.clientWidth - 4;

  function setLeft(px){
    px = Math.max(2, Math.min(px, maxLeft()+2));
    knob.style.left = px+"px";
  }
  function doneCheck(){
    const left = parseFloat(knob.style.left || "2");
    if(left >= maxLeft()) onDone();
    else setLeft(2);
  }

  const onDown = (e)=>{
    dragging=true;
    startX = (e.touches? e.touches[0].clientX : e.clientX);
    startLeft = parseFloat(knob.style.left || "2");
  };
  const onMove = (e)=>{
    if(!dragging) return;
    const x = (e.touches? e.touches[0].clientX : e.clientX);
    const dx = x - startX;
    setLeft(startLeft + dx);
    e.preventDefault?.();
  };
  const onUp = ()=>{
    if(!dragging) return;
    dragging=false;
    doneCheck();
  };

  knob.addEventListener("mousedown", onDown);
  window.addEventListener("mousemove", onMove);
  window.addEventListener("mouseup", onUp);

  knob.addEventListener("touchstart", onDown, {passive:false});
  window.addEventListener("touchmove", onMove, {passive:false});
  window.addEventListener("touchend", onUp);

  return slider;
}

/* ========================= Sales: Month/Year/Manage + Store/Contact/Recipe ========================= */
/* ä»Šå›ã¯ 7ã€œ12 ã®ç¯„å›²å„ªå…ˆã§ã€æœˆ/å¹´/ç®¡ç†/åº—èˆ—/é€£çµ¡/æ–™ç†ææ¡ˆã¯å¾“æ¥ã©ãŠã‚Šä½¿ãˆã‚‹å‰æã€‚
   å¿…è¦ãªã‚‰æ¬¡ã®ä¿®æ­£å›ã§ã€Œå£²ä¸Šç®¡ç†å´ã‚‚è¨‚æ­£ä¼ç¥¨ã‚’è¦‹ã‚„ã™ãã€ã¾ã§æƒãˆã‚‹ã€‚ */

/* sales menu æˆ»ã‚Š */
document.getElementById("salesToMain").onclick = ()=> go("main");

/* settingsâ†’sales ãªã©æ—¢å­˜å°ç·šã®ãŸã‚ã€æœ€ä½é™ã®ãƒœã‚¿ãƒ³å­˜åœ¨ã‚’ä¿ã¤ï¼ˆæœªå®Ÿè£…ãªã‚‰ç„¡è¦–ï¼‰ */
const goMonth = document.getElementById("goMonthSales");
const goYear = document.getElementById("goYearSales");
const goManage = document.getElementById("goSalesManage");
if(goMonth) goMonth.onclick = ()=> openModal({title:"æœªå®Ÿè£…", sub:"ã“ã®åˆ†å‰²ç‰ˆã¯ 7ã€œ12 ã®ä¿®æ­£å„ªå…ˆã§ã™", yesText:"OK"});
if(goYear) goYear.onclick = ()=> openModal({title:"æœªå®Ÿè£…", sub:"ã“ã®åˆ†å‰²ç‰ˆã¯ 7ã€œ12 ã®ä¿®æ­£å„ªå…ˆã§ã™", yesText:"OK"});
if(goManage) goManage.onclick = ()=> openModal({title:"æœªå®Ÿè£…", sub:"ã“ã®åˆ†å‰²ç‰ˆã¯ 7ã€œ12 ã®ä¿®æ­£å„ªå…ˆã§ã™", yesText:"OK"});

/* ========================= end marker ========================= */
</script>
</body>
</html>

ğŸ”´