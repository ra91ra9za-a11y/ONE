<!-- =========================
  ONE ãƒ¬ã‚¸ã‚¢ãƒ—ãƒªï¼ˆç„¡æ–™ç‰ˆï¼‰å®Œå…¨ãƒ•ãƒ«ï¼šPART1ï¼ˆå·®ã—æ›¿ãˆç‰ˆï¼‰
  å½¹å‰²ï¼šHTMLéª¨æ ¼ / CSS / å…±é€šå®šç¾© / å…±é€šUI / ãƒ¡ã‚¤ãƒ³ç”»é¢UI / æœ€ä½é™JS
  ä¿å­˜KEYï¼šONE_FREE_FULL_V2
  ä»•æ§˜ï¼šä¸Šéƒ¨ãƒãƒ¼çµ±ä¸€ï¼ˆONEãƒ»ğŸ“¶ãƒ»ä¸­å¤®ãƒœã‚¿ãƒ³ãƒ»ä¿å­˜ï¼‰/ ä¸‹æ®µã¯ãƒ¡ã‚¤ãƒ³ã®ã¿ï¼ˆå¸­ç§»å‹•ï½œæœ¬æ—¥ã®å£²ä¸Šï½œè¨­å®šï¼‰
========================= -->
<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>ONE FREE</title>

  <style>
    :root{
      --bg:#0b0f14;

      /* åŸºæœ¬æ–‡å­— */
      --text:#e9f1ff;
      --muted:#a9bbd4;

      /* ç·š */
      --line:#233244;

      /* ä¸Šéƒ¨ãƒãƒ¼ï¼ˆæ¿ƒã„ç·‘ï¼‰ */
      --header:#0b2a1b;
      --headerLine:rgba(255,255,255,0.10);

      /* ãƒœã‚¿ãƒ³ï¼ˆé»„ç·‘ï¼‰ */
      --lime:#7fd36b;
      --lime2:#6cc85a;

      /* ã‚¢ã‚¯ã‚»ãƒ³ãƒˆ */
      --accent:#7aa7ff;
      --danger:#ff6b6b;
      --ok:#3ddc97;

      /* å¸­ã‚«ãƒ¼ãƒ‰è‰²ï¼ˆçŠ¶æ…‹åˆ¥ï¼‰ */
      --seatEmpty:#1b2a20;
      --seatReserve:#1b2a4e;
      --seatIn:#121a23;

      --headerH:56px;
      --bottomH:62px;
      --radius:14px;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }

    body{
      margin:0;
      font-family:-apple-system,BlinkMacSystemFont,"Hiragino Sans","Noto Sans JP",system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      background:var(--bg);
      color:var(--text);
      overflow-x:hidden;
      -webkit-font-smoothing:antialiased;
      text-rendering:optimizeLegibility;

      /* ç”»é¢ã‚ºãƒ¬/æš´ã‚Œå¯¾ç­–ï¼ˆåŸºæœ¬ï¼‰ */
      touch-action:pan-y;
      overscroll-behavior-y:contain;
      -webkit-text-size-adjust:100%;
    }

    /* ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤ºä¸­ã«èƒŒæ™¯å›ºå®šï¼ˆâ‘¡å¯¾ç­–ã®æ ¸ï¼‰ */
    body.modalLock{
      position:fixed;
      width:100%;
      overflow:hidden;
    }

    /* iOSã®å…¥åŠ›ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã§å‹æ‰‹ã«æ‹¡å¤§ã•ã‚Œã«ããã™ã‚‹ï¼ˆ16pxãƒ«ãƒ¼ãƒ«ï¼‰ */
    input, textarea, select{
      font-size:16px;
      -webkit-appearance:none;
      appearance:none;
    }

    .app{
      min-height:100%;
      padding-top:calc(var(--headerH) + env(safe-area-inset-top));
      padding-bottom:calc(var(--bottomH) + env(safe-area-inset-bottom));
    }

    /* ===== Header ===== */
    .topbar{
      position:fixed;
      left:0; right:0; top:0;
      padding-top:env(safe-area-inset-top);
      height:calc(var(--headerH) + env(safe-area-inset-top));
      background:var(--header);
      border-bottom:1px solid var(--headerLine);
      z-index:50;
      display:flex;
      align-items:flex-end;
    }
    .topbarInner{
      height:var(--headerH);
      width:100%;
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:0 12px 6px;
      gap:10px;
    }
    .brandWrap{
      display:flex;
      align-items:center;
      gap:8px;
      min-width:96px;
    }
    .brand{
      font-weight:900;
      letter-spacing:0.5px;
      font-size:18px;
      line-height:1;
    }

    /* ã‚¢ãƒ³ãƒ†ãƒŠ */
    .antennaWrap{
      position:relative;
      width:44px;
      height:44px;
      display:flex;
      align-items:center;
      justify-content:center;
      background:transparent;
      border:none;
      padding:0;
      margin:0;
      touch-action:manipulation;
    }
    .antennaIcon{
      font-size:26px;
      line-height:1;
    }
    .antennaX{
      position:absolute;
      top:6px;
      right:6px;
      font-size:15px;
      line-height:1;
      color:var(--danger);
      display:none;
      font-weight:900;
      text-shadow:0 1px 0 rgba(0,0,0,0.35);
    }
    .antennaWrap.off .antennaX{ display:block; }

    .topCenter{
      flex:1;
      display:flex;
      justify-content:center;
    }

    .btn{
      border:1px solid var(--line);
      background:rgba(255,255,255,0.06);
      color:var(--text);
      border-radius:12px;
      padding:10px 14px;
      font-size:14px;
      line-height:1;
      min-height:42px;
      user-select:none;
      -webkit-user-select:none;
      touch-action:manipulation;
    }
    .btn.lime{
      background:var(--lime);
      border-color:rgba(0,0,0,0.15);
      color:#ffffff;
      font-weight:900;
    }
    .btn.ghost{
      background:transparent;
      border-color:transparent;
    }
    .btn.full{ width:100%; }

/* iOSã®è‡ªå‹•ã‚ºãƒ¼ãƒ å¯¾ç­–ï¼šå…¥åŠ›ç³»ã ã‘16pxå›ºå®š */
input.btn, select.btn, textarea.btn{
  font-size:16px;
}

    /* ===== Screens ===== */
    .screen{
      display:none;
      padding:12px;
      max-width:980px;
      margin:0 auto;
    }
    .screen.active{ display:block; }

    /* ===== Main ===== */
    .hintText{
      color:#ffffff;
      font-size:14px;
      padding:6px 2px;
      user-select:none;
    }

    .seatGrid{
      display:grid;
      grid-template-columns:repeat(3, minmax(0, 1fr));
      gap:10px;
    }
    .seatCard{
      border:1px solid rgba(255,255,255,0.10);
      border-radius:var(--radius);
      padding:10px;
      min-height:108px;
      display:flex;
      flex-direction:column;
      justify-content:space-between;
      gap:8px;
      touch-action:manipulation;
      overflow:hidden;
    }

    .seatCard.empty{ background:linear-gradient(180deg, rgba(27,42,32,0.98), rgba(27,42,32,0.86)); }
    .seatCard.reserve{ background:linear-gradient(180deg, rgba(27,42,78,0.98), rgba(27,42,78,0.86)); }
    .seatCard.in{ background:linear-gradient(180deg, rgba(18,26,35,0.98), rgba(18,26,35,0.86)); }

    .seatTop{
      display:flex;
      flex-direction:column;
      gap:6px;
      min-width:0;
    }

    .seatNoLine{
      display:flex;
      align-items:baseline;
      justify-content:space-between;
      gap:8px;
      min-width:0;
    }
    .seatNo{
      font-size:22px;
      font-weight:900;
      letter-spacing:0.5px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .seatPeople{
      font-size:18px;
      font-weight:900;
      white-space:nowrap;
      color:#ffffff;
      opacity:0.95;
    }

    .seatLines{
      font-size:13px;
      color:rgba(255,255,255,0.92);
      display:flex;
      flex-direction:column;
      gap:3px;
      min-width:0;
    }
    .seatLines .muted{ color:rgba(255,255,255,0.75); }

    .seatMoney{
      font-size:16px;
      font-weight:900;
      margin-top:2px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    /* ===== Bottom Bar (Main only) ===== */
    .bottomBar{
      position:fixed;
      left:0; right:0;
      bottom:0;
      padding-bottom:env(safe-area-inset-bottom);
      height:calc(var(--bottomH) + env(safe-area-inset-bottom));
      background:rgba(11,15,20,0.96);
      border-top:1px solid rgba(255,255,255,0.08);
      z-index:45;
      display:flex;
      align-items:center;
    }
    .bottomInner{
      width:100%;
      max-width:980px;
      margin:0 auto;
      padding:0 12px;
      display:grid;
      grid-template-columns:1fr 1fr 1fr;
      gap:10px;
      align-items:center;
      height:var(--bottomH);
    }

    .bottomBtn{
      border-radius:14px;
      min-height:46px;
      font-weight:900;
      border:1px solid rgba(255,255,255,0.14);
      background:rgba(255,255,255,0.05);
      color:var(--text);
      touch-action:manipulation;
    }
    .bottomBtn.move{
      background:rgba(127,211,107,0.22);
      border-color:rgba(127,211,107,0.45);
    }

    /* ===== Modal ===== */
    .backdrop{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,0.58);
      z-index:80;
      display:none;
      align-items:center;
      justify-content:center;
      padding:12px;
      padding-top:calc(12px + env(safe-area-inset-top));
      padding-bottom:calc(12px + env(safe-area-inset-bottom));
    }
    .backdrop.show{ display:flex; }

    .modal{
      width:min(560px, 100%);
      background:#121a23;
      border:1px solid rgba(255,255,255,0.10);
      border-radius:18px;
      overflow:hidden;

      /* ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ãŒå‡ºã¦ã‚‚ç”»é¢ã‹ã‚‰ã¯ã¿å‡ºã—ã«ããã™ã‚‹ */
      max-height:calc(100vh - 24px - env(safe-area-inset-top) - env(safe-area-inset-bottom));
      display:flex;
      flex-direction:column;
    }
    .modalHead{
      padding:14px 14px 10px;
      border-bottom:1px solid rgba(255,255,255,0.08);
      font-weight:900;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex:0 0 auto;
    }
    .modalTitleL{
      display:flex;
      align-items:center;
      gap:10px;
      min-width:0;
    }
    .modalSeatId{
      font-weight:900;
      font-size:18px;
      white-space:nowrap;
    }
    .modalTitleText{
      font-size:16px;
      font-weight:900;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .modalBody{
      padding:14px;
      color:var(--text);
      font-size:15px;
      line-height:1.65;

      /* é•·æ–‡/å…¥åŠ›æ™‚ã«å†…éƒ¨ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ« */
      overflow:auto;
      -webkit-overflow-scrolling:touch;
      flex:1 1 auto;
      min-height:0;
    }
    .modalActions{
      padding:12px 14px 14px;
      display:flex;
      gap:12px;
      justify-content:flex-end;
      flex-wrap:wrap;
      flex:0 0 auto;
    }

    .bigBtn{
      min-height:48px;
      padding:12px 14px;
      font-weight:900;
      border-radius:14px;
    }

    /* äºˆç´„å…¥åŠ›ãªã©ã§ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ãŒå‡ºãŸæ™‚ï¼šä¸Šå¯„ã›ã«ã—ã¦è¦‹åˆ‡ã‚Œã‚’æ¸›ã‚‰ã™ */
    .backdrop.kbOpen{
      align-items:flex-start;
    }

    /* ===== Slide confirm ===== */
    .range{
      width:100%;
      accent-color: var(--accent);
    }

    /* ===== Toast ===== */
    .toast{
      position:fixed;
      left:50%;
      transform:translateX(-50%);
      bottom:calc(var(--bottomH) + 18px + env(safe-area-inset-bottom));
      background:rgba(0,0,0,0.80);
      border:1px solid rgba(255,255,255,0.12);
      color:#fff;
      padding:10px 12px;
      border-radius:999px;
      font-size:13px;
      z-index:90;
      display:none;
      max-width:min(90vw, 860px);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .toast.show{ display:block; }

    /* å°ç”»é¢ */
    @media (max-width: 360px){
      .seatNo{ font-size:20px; }
      .seatPeople{ font-size:16px; }
      .btn{ padding:9px 12px; }
      .antennaIcon{ font-size:24px; }
    }
  </style>
</head>

<body>
  <!-- ===== Header ===== -->
  <header class="topbar" id="topbar">
    <div class="topbarInner">
      <!-- å·¦ï¼šONE + ğŸ“¶ -->
      <div class="brandWrap">
        <div class="brand">ONE</div>
        <button class="antennaWrap" id="btnAntenna" aria-label="åŒæœŸçŠ¶æ…‹">
          <span class="antennaIcon">ğŸ“¶</span>
          <span class="antennaX">âŒ</span>
        </button>
      </div>

      <!-- ä¸­å¤®ï¼šã‚­ãƒƒãƒãƒ³/ãƒ›ãƒ¼ãƒ«/ãƒ¡ã‚¤ãƒ³ -->
      <div class="topCenter">
        <button class="btn lime" id="navSecond">ã‚­ãƒƒãƒãƒ³</button>
      </div>

      <!-- å³ï¼šä¿å­˜ -->
      <div style="min-width:96px; display:flex; justify-content:flex-end">
        <button class="btn lime" id="btnSave">ä¿å­˜</button>
      </div>
    </div>
  </header>

  <!-- ===== App ===== -->
  <main class="app">
    <!-- ãƒ¡ã‚¤ãƒ³ -->
    <section class="screen active" id="scrMain">
      <div class="hintText" id="mainHint">ç©ºå¸­ã‚’ã‚¿ãƒƒãƒ—ã§ æ¥åº— / äºˆç´„ ã‚’åˆ‡æ›¿</div>
      <div style="height:10px"></div>
      <div class="seatGrid" id="seatGrid"></div>
    </section>

    <!-- ã‚­ãƒƒãƒãƒ³ -->
    <section class="screen" id="scrKitchen"><div style="opacity:.8">ï¼ˆPART3ã§å®Ÿè£…ï¼‰</div></section>

    <!-- æœ¬æ—¥ã®å£²ä¸Š/å£²ä¸Š -->
    <section class="screen" id="scrSales"><div style="opacity:.8">ï¼ˆPART4ã§å®Ÿè£…ï¼‰</div></section>

    <!-- è¨‚æ­£ä¼ç¥¨ -->
    <section class="screen" id="scrFix"><div style="opacity:.8">ï¼ˆPART5ã§å®Ÿè£…ï¼‰</div></section>

    <!-- å¸­ç™»éŒ² -->
    <section class="screen" id="scrSeatSetup"><div style="opacity:.8">ï¼ˆPART6ã§å®Ÿè£…ï¼‰</div></section>

    <!-- è¨­å®š -->
    <section class="screen" id="scrSettings"><div style="opacity:.8">ï¼ˆPART8ã§å®Ÿè£…ï¼‰</div></section>

    <!-- ãƒ¡ãƒ‹ãƒ¥ãƒ¼ç™»éŒ² -->
    <section class="screen" id="scrMenu"><div style="opacity:.8">ï¼ˆPART8ã§å®Ÿè£…ï¼‰</div></section>

    <!-- æ³¨æ–‡ -->
    <section class="screen" id="scrOrder"><div style="opacity:.8">ï¼ˆPART2ã§å®Ÿè£…ï¼‰</div></section>
  </main>

  <!-- ===== Bottom (Main only) ===== -->
  <div class="bottomBar" id="bottomBar">
    <div class="bottomInner">
      <button class="bottomBtn move" id="goMove">å¸­ç§»å‹•</button>
      <button class="bottomBtn" id="goTodaySales">æœ¬æ—¥ã®å£²ä¸Š</button>
      <button class="bottomBtn" id="goSettings">è¨­å®š</button>
    </div>
  </div>

  <!-- ===== Modal ===== -->
  <div class="backdrop" id="modalBackdrop" role="dialog" aria-modal="true">
    <div class="modal">
      <div class="modalHead">
        <div class="modalTitleL">
          <div class="modalSeatId" id="modalSeatId" style="display:none"></div>
          <div class="modalTitleText" id="modalTitle"> </div>
        </div>
        <button class="btn ghost" id="modalClose">é–‰ã˜ã‚‹</button>
      </div>
      <div class="modalBody" id="modalBody"> </div>
      <div class="modalActions" id="modalActions"></div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    /* =========================
      Common / State (PART1)
    ========================= */

    const KEY = "ONE_FREE_FULL_V2";
    const $ = (id)=> document.getElementById(id);

    function nowTs(){ return Date.now(); }
    function pad2(n){ return String(n).padStart(2,"0"); }
    function yen(n){
      const x = Number(n||0);
      return "Â¥" + x.toLocaleString("ja-JP");
    }

    /* ãƒ€ãƒ–ãƒ«ã‚¿ãƒƒãƒ—/ãƒ”ãƒ³ãƒã§ã®æ‹¡å¤§ã‚’æŠ‘æ­¢ï¼ˆiOS/Androidå…±é€šã®ä¿é™ºï¼‰ */
    (function preventZoom(){
      document.addEventListener("dblclick", (e)=>{ e.preventDefault(); }, {passive:false});
      document.addEventListener("gesturestart", (e)=>{ e.preventDefault(); }, {passive:false});
      document.addEventListener("gesturechange", (e)=>{ e.preventDefault(); }, {passive:false});
      document.addEventListener("gestureend", (e)=>{ e.preventDefault(); }, {passive:false});
    })();

    function toast(msg, ms=1800){
      const t = $("toast");
      t.textContent = msg;
      t.classList.add("show");
      clearTimeout(toast._tm);
      toast._tm = setTimeout(()=> t.classList.remove("show"), ms);
    }

    /* ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆèƒŒæ™¯å›ºå®šï¼‰â€” â‘¡å¯¾ç­–ã®æ ¸ */
    function lockBody(){
      const y = window.scrollY;
      document.body.dataset.scrollY = String(y);
      document.body.classList.add("modalLock");
      document.body.style.top = `-${y}px`;
    }
    function unlockBody(){
      const y = Number(document.body.dataset.scrollY || "0");
      document.body.classList.remove("modalLock");
      document.body.style.top = "";
      window.scrollTo(0, y);
    }

    /* ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ãŒå‡ºãŸæ™‚ã«ãƒ¢ãƒ¼ãƒ€ãƒ«ãŒè¦‹åˆ‡ã‚Œã«ãã„ã‚ˆã†ã«ã™ã‚‹ */
    (function modalKeyboardAssist(){
      const bd = $("modalBackdrop");
      document.addEventListener("focusin", (e)=>{
        if(!bd.classList.contains("show")) return;
        const t = e.target;
        if(t && (t.tagName==="INPUT" || t.tagName==="TEXTAREA" || t.tagName==="SELECT")){
          bd.classList.add("kbOpen");
        }
      });
      document.addEventListener("focusout", ()=>{
        if(!bd.classList.contains("show")) return;
        setTimeout(()=> bd.classList.remove("kbOpen"), 50);
      });
    })();

    function openModal(title, bodyHtml, actions, seatId=null){
      $("modalTitle").textContent = title || "";
      $("modalBody").innerHTML = bodyHtml || "";

      if(seatId){
        $("modalSeatId").style.display = "block";
        $("modalSeatId").textContent = seatId;
      }else{
        $("modalSeatId").style.display = "none";
        $("modalSeatId").textContent = "";
      }

      const box = $("modalActions");
      box.innerHTML = "";
      (actions||[]).forEach(a=>{
        const b = document.createElement("button");
        b.className = "btn bigBtn" + (a.lime ? " lime" : "");
        b.textContent = a.label;
        b.onclick = ()=> a.onClick && a.onClick();
        box.appendChild(b);
      });

      $("modalBackdrop").classList.add("show");
      lockBody();
    }
    function closeModal(){
      $("modalBackdrop").classList.remove("show");
      $("modalBackdrop").classList.remove("kbOpen");
      unlockBody();
    }

    $("modalClose").onclick = ()=> closeModal();
    $("modalBackdrop").addEventListener("click", (e)=>{
      if(e.target === $("modalBackdrop")) closeModal();
    });

    /* ç”»é¢é·ç§» */
    const screens = ["scrMain","scrKitchen","scrSales","scrFix","scrSeatSetup","scrSettings","scrMenu","scrOrder"];
    function showScreen(id){
      screens.forEach(s=> $(s).classList.toggle("active", s===id));

      // ä¸Šéƒ¨ä¸­å¤®ãƒœã‚¿ãƒ³æ–‡è¨€ï¼ˆå…±é€šãƒ«ãƒ¼ãƒ«ï¼‰
      if(id==="scrMain"){
        $("navSecond").textContent = "ã‚­ãƒƒãƒãƒ³";
      }else if(id==="scrKitchen"){
        $("navSecond").textContent = "ãƒ›ãƒ¼ãƒ«";
      }else{
        $("navSecond").textContent = "ãƒ¡ã‚¤ãƒ³";
      }

      // ä¸‹æ®µã¯ãƒ¡ã‚¤ãƒ³ã ã‘
      $("bottomBar").style.display = (id==="scrMain") ? "flex" : "none";

      /* ç”»é¢é·ç§»æ™‚ã«å¤‰ãªã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®ã‚’æ®‹ã•ãªã„ï¼ˆè»½ã„ä¿é™ºï¼‰ */
      window.scrollTo(0,0);
    }

    /* ===== State ===== */
    const state = {
      syncOk: true,
      seats: [],
      order: { seatId:null, subId:null, catView:"all" },
      sales: null,
      kitchen: null,
      fix: null,
      seatSetup: null,
      sync: null,
      menu: null,
    };

    function setSync(ok){
      state.syncOk = !!ok;
      $("btnAntenna").classList.toggle("off", !ok);
    }

    /* ===== Seat helpers ===== */
    function seatById(id){ return state.seats.find(s=> s.id===id); }

    function ensureSub(seat, subId){
      seat.sub = seat.sub || {};
      if(!seat.sub[subId]){
        seat.sub[subId] = { seatId: subId, people:0, name:"", total:0, orders:[], reserve:null };
      }
      return seat.sub[subId];
    }

    function calcSeatTotal(seat){
      if(!seat.merged){
        return Number(seat.total||0);
      }
      const subs = Object.values(seat.sub||{});
      return subs.reduce((a,b)=> a + Number(b.total||0), 0);
    }

    function calcOrdersTotal(orders){
      return (orders||[]).reduce((sum, o)=> sum + (Number(o.price||0) * Number(o.qty||0)), 0);
    }

    /* ===== Seed ===== */
    function seedSeatsIfEmpty(){
      if(state.seats.length) return;

      state.seats = [
        {id:"A", status:"empty"},
        {id:"B", status:"empty"},
        {id:"C", status:"empty"},
        {id:"D", status:"in", people:2, name:"ç”°ä¸­", total:4800, bills:1},
        {id:"E", status:"empty"},
        {id:"F", status:"reserve", people:3, reserve:{time:"18:30", name:"ä½è—¤", tel:"", note:""}, total:0, bills:0},
      ].map(s=>{
        s.people = Number(s.people||0);
        s.name = s.name || "";
        s.total = Number(s.total||0);
        s.bills = Number(s.bills||0);
        s.merged = false;
        s.mergeLabel = "";
        s.sub = null;
        return s;
      });
    }

    /* ===== Render seats ===== */
    function renderSeats(){
      const grid = $("seatGrid");
      grid.innerHTML = "";

      state.seats.forEach(seat=>{
        const card = document.createElement("div");
        card.className = "seatCard " + (seat.status==="empty" ? "empty" : seat.status==="reserve" ? "reserve" : "in");
        card.dataset.seatId = seat.id;

        const seatLabel = seat.merged ? (seat.mergeLabel || seat.id) : seat.id;
        const people = (seat.status==="in" || seat.status==="reserve") ? Number(seat.people||0) : 0;

        const bills = Number(seat.bills||0);
        const billsLine = (seat.status==="in" && bills>=2) ? `åˆ¥ä¼šè¨ˆ${bills}ä»¶` : "";

        let nameLine = "";
        if(seat.merged){
          nameLine = `<span style="font-weight:900">${seat.mergeLabel || "â¡ï¸"}</span>`;
        }else if(seat.status==="in" && seat.name){
          nameLine = seat.name;
        }else if(seat.status==="reserve"){
          nameLine = "äºˆç´„";
        }else{
          nameLine = "ç©ºå¸­";
        }

        const money = (seat.status==="in") ? yen(calcSeatTotal(seat)) : "";

        card.innerHTML = `
          <div class="seatTop">
            <div class="seatNoLine">
              <div class="seatNo">${seatLabel}</div>
              <div class="seatPeople">${(seat.status==="in"||seat.status==="reserve") ? `${people}å` : ""}</div>
            </div>

            <div class="seatLines">
              ${billsLine ? `<div class="muted">${billsLine}</div>` : ``}
              <div>${nameLine}</div>
            </div>
          </div>

          <div class="seatMoney">${money}</div>
        `;

        card.onclick = ()=> onSeatTap(seat.id);
        grid.appendChild(card);
      });
    }

    /* ===== Seat tap entry ===== */
    function onSeatTap(seatId){
      toast("èª­ã¿è¾¼ã¿ä¸­â€¦");
    }

    /* ===== Header center button ===== */
    $("navSecond").onclick = ()=>{
      const current = screens.find(s=> $(s).classList.contains("active")) || "scrMain";
      if(current==="scrMain"){
        showScreen("scrKitchen");
      }else if(current==="scrKitchen"){
        showScreen("scrMain");
      }else{
        showScreen("scrMain");
      }
    };

    /* Bottom buttons */
    $("goMove").onclick = ()=> openMoveHome();
    $("goTodaySales").onclick = ()=> { state._salesFromMain = true; showScreen("scrSales"); };
    $("goSettings").onclick = ()=> showScreen("scrSettings");

    /* placeholders (PART2ã§å®Ÿè£…) */
    function openMoveHome(){ toast("å¸­ç§»å‹•ï¼ˆPART2ã§å®Ÿè£…ï¼‰"); }

    /* èµ·å‹• */
    (function init(){
      seedSeatsIfEmpty();
      setSync(true);
      renderSeats();
      showScreen("scrMain");
    })();

    /* =========================
      ã“ã“ã‹ã‚‰å…ˆã¯ PART2 ã§ç¶šã
    ========================= */
/* =========================
  PART2ï¼šæ³¨æ–‡ï¼ˆæœ¬æ¥ã®æ§‹æˆã«å¾©å…ƒï¼‰ï¼‹å¸­ã‚¿ãƒƒãƒ—å‹•ç·šï¼ˆç©ºå¸­/äºˆç´„/æ¥åº—/åˆæµï¼‰
  é‡è¦ä¿®æ­£ï¼š
   - IDè¡çªã‚’å›é¿ï¼ˆæ³¨æ–‡å´ã¯ orderCatFood / orderCatDrink ãªã©ã«å¤‰æ›´ï¼‰
   - å¸­ã‚«ãƒ¼ãƒ‰ã‚¿ãƒƒãƒ—ã§ã€Œæ¥åº—/äºˆç´„/æˆ»ã‚‹ã€ã‚’å¾©æ´»
   - æ–™ç†/ãƒ‰ãƒªãƒ³ã‚¯ â†’ ã‚¸ãƒ£ãƒ³ãƒ«(3åˆ—) â†’ å•†å“(3åˆ—) â†’ æ³¨æ–‡ï¼ˆå·®åˆ†å…¥åŠ›ï¼‰
   - æ³¨æ–‡å±¥æ­´ï¼šå•†å“ã”ã¨ã«ã¾ã¨ã‚è¡¨ç¤º â†’ 1æ®µéšç¢ºèª â†’ ä¿®æ­£ï¼ˆå·®åˆ†å‹ï¼‰
  ä¼šè¨ˆï¼šã“ã“ã¯å…¥å£ã®ã¿ï¼ˆä¼šè¨ˆç”»é¢ã¯åˆ¥ãƒ‘ãƒ¼ãƒˆã§å®Ÿè£…ï¼‰
========================= */


/* =========================================================
   0) è»½ã„ã‚ºãƒ¼ãƒ æŠ‘æ­¢ï¼ˆãƒ€ãƒ–ãƒ«ã‚¿ãƒƒãƒ—ï¼‰
========================================================= */
(function preventDoubleTapZoom(){
  if(preventDoubleTapZoom._done) return;
  preventDoubleTapZoom._done = true;

  let lastTouchEnd = 0;
  document.addEventListener("touchend", function(e){
    const now = Date.now();
    if(now - lastTouchEnd <= 300){
      e.preventDefault();
    }
    lastTouchEnd = now;
  }, {passive:false});
})();


/* =========================================================
   1) æ³¨æ–‡UIï¼ˆIDè¡çªã—ãªã„ç‰ˆï¼‰
========================================================= */
(function buildOrderUI_v3(){
  if(buildOrderUI_v3._built) return;
  buildOrderUI_v3._built = true;

  const scr = $("scrOrder");
  scr.innerHTML = `
    <!-- ä¸Šéƒ¨ï¼šæ³¨æ–‡ / å¸­ç•ªå· / ä¼šè¨ˆï¼ˆå…¥å£ï¼‰ -->
    <div style="display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:10px">
      <div style="font-weight:900; font-size:18px">æ³¨æ–‡</div>
      <div style="font-weight:900; opacity:.9" id="orderSeatLabel"></div>
      <button class="btn lime" id="orderGoPay">ä¼šè¨ˆ</button>
    </div>

    <!-- ä¸­éƒ¨ä¸Šæ®µï¼šæ–™ç†/ãƒ‰ãƒªãƒ³ã‚¯/æˆ»ã‚‹ -->
    <div style="display:flex; gap:10px; margin-bottom:10px">
      <button class="btn" id="orderCatFood" style="flex:1; font-weight:900">æ–™ç†</button>
      <button class="btn" id="orderCatDrink" style="flex:1; font-weight:900">ãƒ‰ãƒªãƒ³ã‚¯</button>
      <button class="btn" id="orderBackMain" style="flex:1; font-weight:900">æˆ»ã‚‹</button>
    </div>

    <!-- ã‚¸ãƒ£ãƒ³ãƒ«ï¼ˆ3åˆ—ï¼‰ -->
    <div id="orderGenreWrap" style="display:none; margin-bottom:12px">
      <div class="seatGrid" id="orderGenreGrid"></div>
    </div>

    <!-- å•†å“ï¼ˆ3åˆ—ï¼‰ï¼‹æˆ»ã‚‹ -->
    <div id="orderItemsWrap" style="display:none; margin-bottom:12px">
      <div style="display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:10px">
        <div style="font-weight:900; font-size:16px" id="orderPickedGenre"></div>
        <button class="btn" id="orderItemsBack">æˆ»ã‚‹</button>
      </div>
      <div class="seatGrid" id="orderItemsGrid"></div>
    </div>

    <!-- æ³¨æ–‡å±¥æ­´ï¼ˆç¸¦ï¼‰ -->
    <div style="margin-top:10px">
      <div style="font-weight:900; margin-bottom:8px">æ³¨æ–‡å±¥æ­´</div>
      <div id="orderHistory"></div>
    </div>
  `;
})();


/* =========================================================
   2) æ³¨æ–‡ãƒ‡ãƒ¼ã‚¿ï¼ˆå£Šã•ãªã„ï¼šè¶³ã™ã ã‘ï¼‰
========================================================= */
function getOrderBucket(seat, subId){
  if(seat.merged){
    const b = ensureSub(seat, subId);
    b.orders = b.orders || [];       // é›†è¨ˆ
    b.orderLog = b.orderLog || [];   // å±¥æ­´
    return b;
  }
  seat.orders = seat.orders || [];
  seat.orderLog = seat.orderLog || [];
  return seat;
}

function upsertOrderAgg(bucket, item, delta){
  let o = (bucket.orders||[]).find(x=> x.itemId===item.id);
  const d = Number(delta||0);

  if(!o){
    if(d <= 0) return;
    bucket.orders.push({ itemId:item.id, name:item.name, price:item.price, tax:item.tax, qty:d, cat:item.cat, genre:item.genre });
    return;
  }
  o.qty = Number(o.qty||0) + d;
  if(o.qty <= 0){
    bucket.orders = bucket.orders.filter(x=> x.itemId!==item.id);
  }
}

function pushOrderLog(bucket, item, delta, reason){
  bucket.orderLog = bucket.orderLog || [];
  bucket.orderLog.unshift({
    id: "ol_" + Math.random().toString(36).slice(2),
    ts: nowTs(),
    itemId: item.id,
    name: item.name,
    delta: Number(delta||0),
    reason: reason || "",
  });
}

function formatHM(ts){
  const d = new Date(ts);
  return `${pad2(d.getHours())}:${pad2(d.getMinutes())}`;
}


/* =========================================================
   3) æ³¨æ–‡çŠ¶æ…‹
========================================================= */
state.order = state.order || { seatId:null, subId:null, cat:null, genre:null };


/* =========================================================
   4) æ³¨æ–‡ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
========================================================= */
function setBtnHL(btn, on){
  btn.classList.toggle("lime", !!on);
}

function listGenresByCat(cat){
  return (state.menu?.genres?.[cat] || []).slice();
}

function listItemsBy(cat, genre){
  return (state.menu?.items || []).filter(it=> it.cat===cat && it.genre===genre);
}

function renderOrder_v3(){
  const seat = seatById(state.order.seatId);
  if(!seat){ showScreen("scrMain"); return; }

  const subId = state.order.subId || seat.id;
  $("orderSeatLabel").textContent = seat.merged ? `${seat.mergeLabel} / ${subId}` : `${seat.id}`;

  // ä¼šè¨ˆå…¥å£ï¼ˆä¼šè¨ˆç”»é¢ã¯åˆ¥ãƒ‘ãƒ¼ãƒˆã§å®Ÿè£…ï¼‰
  $("orderGoPay").onclick = ()=> toast("ä¼šè¨ˆï¼ˆåˆ¥ãƒ‘ãƒ¼ãƒˆã§å®Ÿè£…ï¼‰");

  // ãƒ¡ã‚¤ãƒ³ã¸æˆ»ã‚‹
  $("orderBackMain").onclick = ()=>{
    state.order.cat = null;
    state.order.genre = null;
    showScreen("scrMain");
  };

  const foodBtn = $("orderCatFood");
  const drinkBtn = $("orderCatDrink");

  foodBtn.onclick = ()=> toggleCat("food");
  drinkBtn.onclick = ()=> toggleCat("drink");

  function toggleCat(cat){
    if(state.order.cat === cat){
      state.order.cat = null;
      state.order.genre = null;
      renderOrder_v3();
      return;
    }
    state.order.cat = cat;
    state.order.genre = null;
    renderOrder_v3();
  }

  setBtnHL(foodBtn, state.order.cat==="food");
  setBtnHL(drinkBtn, state.order.cat==="drink");

  const gw = $("orderGenreWrap");
  const gg = $("orderGenreGrid");
  const iw = $("orderItemsWrap");
  const ig = $("orderItemsGrid");

  gg.innerHTML = "";
  ig.innerHTML = "";

  if(!state.order.cat){
    gw.style.display = "none";
    iw.style.display = "none";
  }else{
    const genres = listGenresByCat(state.order.cat);
    gw.style.display = "block";
    iw.style.display = "none";

    if(genres.length===0){
      gg.innerHTML = `<div style="opacity:.85">ã‚¸ãƒ£ãƒ³ãƒ«ãŒã‚ã‚Šã¾ã›ã‚“ã€‚å…ˆã«ãƒ¡ãƒ‹ãƒ¥ãƒ¼ç™»éŒ²ã‚’ã—ã¦ãã ã•ã„ã€‚</div>`;
    }else{
      genres.forEach(g=>{
        const b = document.createElement("div");
        b.className = "seatCard";
        b.style.minHeight="56px";
        b.style.display="flex";
        b.style.alignItems="center";
        b.style.justifyContent="center";
        b.style.fontWeight="900";
        b.textContent = g;
        b.onclick = ()=>{
          state.order.genre = g;
          renderOrder_v3();
        };
        gg.appendChild(b);
      });
    }
  }

  if(state.order.cat && state.order.genre){
    // æœ¬æ¥ä»•æ§˜ï¼šã‚«ãƒ†ã‚´ãƒªï¼†ã‚¸ãƒ£ãƒ³ãƒ«éè¡¨ç¤ºã§å•†å“ã¸
    gw.style.display = "none";
    iw.style.display = "block";
    $("orderPickedGenre").textContent = state.order.genre;

    $("orderItemsBack").onclick = ()=>{
      state.order.genre = null;
      renderOrder_v3();
    };

    const items = listItemsBy(state.order.cat, state.order.genre);
    if(items.length===0){
      ig.innerHTML = `<div style="opacity:.85">ã“ã®ã‚¸ãƒ£ãƒ³ãƒ«ã«å•†å“ãŒã‚ã‚Šã¾ã›ã‚“</div>`;
    }else{
      items.forEach(it=>{
        const c = document.createElement("div");
        c.className = "seatCard";
        c.style.minHeight="86px";
        c.style.display="flex";
        c.style.flexDirection="column";
        c.style.justifyContent="space-between";
        c.innerHTML = `
          <div style="font-weight:900; overflow:hidden; text-overflow:ellipsis; white-space:nowrap">${it.name}</div>
          <div style="opacity:.85; font-weight:900">${yen(it.price)}</div>
        `;
        c.onclick = ()=> openOrderDeltaModal_v3(seat, subId, it);
        ig.appendChild(c);
      });
    }
  }

  renderOrderHistory_v3(seat, subId);
}

function openOrderDeltaModal_v3(seat, subId, item){
  const bucket = getOrderBucket(seat, subId);
  let delta = 0;

  openModal(
    "æ³¨æ–‡",
    `
      <div style="font-weight:900; font-size:18px; margin-bottom:10px">${item.name}</div>
      <div style="opacity:.85; margin-bottom:14px">${yen(item.price)} / ç¨${item.tax}%</div>

      <div style="display:flex; align-items:center; justify-content:center; gap:12px; margin-bottom:14px">
        <button class="btn" id="odMinus" style="min-width:64px">â—€ï¸</button>
        <div class="pill" id="odVal" style="min-width:90px; justify-content:center; font-weight:900; font-size:20px">0</div>
        <button class="btn lime" id="odPlus" style="min-width:64px">â–¶ï¸</button>
      </div>

      <div style="opacity:.85">â€» è¿½åŠ ã™ã‚‹æ•°ã‚’é¸ã‚“ã§ãã ã•ã„ï¼ˆ0ãªã‚‰è¿½åŠ ãªã—ï¼‰</div>
    `,
    [
      {label:"æˆ»ã‚‹", lime:false, onClick:()=> closeModal()},
      {label:"æ±ºå®š", lime:true, onClick:()=>{
        if(delta===0){ closeModal(); return; }

        upsertOrderAgg(bucket, item, delta);
        pushOrderLog(bucket, item, delta, "è¿½åŠ ");

        seat.status = "in";
        seat.people = Math.max(1, Number(seat.people||1));
        seat.bills = 1;

        const sum = calcOrdersTotal(bucket.orders || []);
        if(seat.merged){
          bucket.total = sum;
          seat.total = calcSeatTotal(seat);
        }else{
          seat.total = sum;
        }

        if(typeof emitEvent==="function") emitEvent("order_delta", {seatId: seat.id, subId, itemId: item.id, delta});

        closeModal();
        renderSeats();
        renderOrder_v3();
      }},
    ],
    seat.id
  );

  setTimeout(()=>{
    const setVal = ()=> $("odVal").textContent = String(delta);

    $("odMinus").onclick = ()=>{
      if(delta<=0) return;
      delta -= 1;
      setVal();
    };
    $("odPlus").onclick = ()=>{
      delta += 1;
      setVal();
    };

    setVal();
  },0);
}

function renderOrderHistory_v3(seat, subId){
  const bucket = getOrderBucket(seat, subId);
  const box = $("orderHistory");
  box.innerHTML = "";

  const agg = (bucket.orders || []).slice().sort((a,b)=> (b.qty||0) - (a.qty||0));
  if(agg.length===0){
    box.innerHTML = `<div style="opacity:.85">ã¾ã ã‚ã‚Šã¾ã›ã‚“</div>`;
    return;
  }

  agg.forEach(a=>{
    const row = document.createElement("div");
    row.style.border="1px solid rgba(255,255,255,0.10)";
    row.style.borderRadius="14px";
    row.style.padding="12px";
    row.style.background="rgba(255,255,255,0.04)";
    row.style.marginBottom="10px";

    row.innerHTML = `
      <div style="display:flex; justify-content:space-between; gap:10px; align-items:center">
        <div style="min-width:0">
          <div style="font-weight:900; overflow:hidden; text-overflow:ellipsis; white-space:nowrap">${a.name} Ã— ${a.qty}</div>
          <div style="opacity:.8; margin-top:4px">${yen((Number(a.price||0) * Number(a.qty||0)))}</div>
        </div>
        <button class="btn" data-hfix="${a.itemId}">ä¿®æ­£</button>
      </div>
    `;
    box.appendChild(row);

    row.querySelector(`[data-hfix="${a.itemId}"]`).onclick = ()=>{
      openHistoryConfirm_v3(seat, subId, a.itemId);
    };
  });
}


/* =========================================================
   5) å±¥æ­´ â†’ ç¢ºèª â†’ ä¿®æ­£ï¼ˆã‚ãªãŸã®ä»•æ§˜ã«åˆã‚ã›ã¦ä¿æŒï¼‰
========================================================= */
const ORDER_FIX_REASONS = ["æœªæä¾›","æ•°ãˆé–“é•ã„","æ³¨æ–‡å–ã‚Šé•ã„","æä¾›æ¸ˆã¿å–æ¶ˆ","ãã®ä»–"];

function openHistoryConfirm_v3(seat, subId, itemId){
  const bucket = getOrderBucket(seat, subId);
  const agg = (bucket.orders || []).find(x=> x.itemId===itemId);
  if(!agg) return;

  const logs = (bucket.orderLog || []).filter(l=> l.itemId===itemId).slice(0, 8);
  const lines = logs.map(l=>`
    <div style="display:flex; justify-content:space-between; gap:10px; padding:6px 0; border-bottom:1px solid rgba(255,255,255,0.06)">
      <div style="opacity:.85">${formatHM(l.ts)}</div>
      <div style="font-weight:900">${l.name}</div>
      <div style="font-weight:900">${l.delta>0?`+${l.delta}`:String(l.delta)}</div>
    </div>
  `).join("");

  openModal(
    "ä¿®æ­£ç¢ºèª",
    `
      <div style="font-weight:900; font-size:16px; margin-bottom:8px">${agg.name} Ã— ${agg.qty}</div>
      <div style="opacity:.85; margin-bottom:10px">æ³¨æ–‡å±¥æ­´</div>
      <div>${lines || `<div style="opacity:.85">å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“</div>`}</div>
      <div style="height:10px"></div>
      <div style="opacity:.92; font-weight:900">ä¿®æ­£ã—ã¾ã™ã‹ï¼Ÿ</div>
    `,
    [
      {label:"æˆ»ã‚‹", lime:false, onClick:()=> closeModal()},
      {label:"ä¿®æ­£", lime:true, onClick:()=>{
        closeModal();
        openHistoryFix_v3(seat, subId, itemId);
      }},
    ],
    seat.id
  );
}

function openHistoryFix_v3(seat, subId, itemId){
  const bucket = getOrderBucket(seat, subId);
  const agg = (bucket.orders || []).find(x=> x.itemId===itemId);
  if(!agg) return;

  let delta = 0;

  openModal(
    "ä¿®æ­£",
    `
      <div style="font-weight:900; font-size:18px; margin-bottom:8px">${agg.name}</div>
      <div style="opacity:.85; margin-bottom:12px">ç¾åœ¨ï¼š${agg.qty}</div>

      <div style="margin-bottom:6px; font-weight:900">ç†ç”±ï¼ˆå¿…é ˆï¼‰</div>
      <select id="ofWhy" class="btn full" style="text-align:left">
        <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
        ${ORDER_FIX_REASONS.map(x=> `<option value="${x}">${x}</option>`).join("")}
      </select>

      <div style="margin-top:14px; font-weight:900; margin-bottom:8px">å¤‰æ›´ï¼ˆå·®åˆ†ï¼‰</div>
      <div style="display:flex; align-items:center; justify-content:center; gap:12px; margin-bottom:10px">
        <button class="btn" id="ofMinus" style="min-width:64px">â—€ï¸</button>
        <div class="pill" id="ofVal" style="min-width:120px; justify-content:center; font-weight:900; font-size:20px">0</div>
        <button class="btn lime" id="ofPlus" style="min-width:64px">â–¶ï¸</button>
      </div>

      <div style="opacity:.85">â€» åˆè¨ˆãŒ0æœªæº€ã«ã¯ã§ãã¾ã›ã‚“</div>
    `,
    [
      {label:"æˆ»ã‚‹", lime:false, onClick:()=> closeModal()},
      {label:"æ±ºå®š", lime:true, onClick:()=>{
        const reason = $("ofWhy").value || "";
        if(!reason){ toast("ç†ç”±ã‚’é¸æŠã—ã¦ãã ã•ã„"); return; }

        const after = Number(agg.qty||0) + Number(delta||0);
        if(after < 0){ toast("0æœªæº€ã«ã¯ã§ãã¾ã›ã‚“"); return; }

        // åæ˜ 
        const item = { id: agg.itemId, name: agg.name, price: agg.price, tax: agg.tax, cat: agg.cat, genre: agg.genre };
        upsertOrderAgg(bucket, item, delta);
        pushOrderLog(bucket, item, delta, reason);

        const sum = calcOrdersTotal(bucket.orders || []);
        if(seat.merged){
          bucket.total = sum;
          seat.total = calcSeatTotal(seat);
        }else{
          seat.total = sum;
        }

        if(typeof emitEvent==="function") emitEvent("order_fix", {seatId: seat.id, subId, itemId, delta, reason});

        closeModal();
        renderSeats();
        renderOrder_v3();
        toast("ä¿®æ­£ã—ã¾ã—ãŸ");
      }},
    ],
    seat.id
  );

  setTimeout(()=>{
    const setVal = ()=>{
      const s = delta>0 ? `+${delta}` : String(delta);
      $("ofVal").textContent = s;
    };

    $("ofMinus").onclick = ()=>{
      const cur = Number(agg.qty||0) + delta;
      if(cur <= 0) return;
      delta -= 1;
      setVal();
    };
    $("ofPlus").onclick = ()=>{
      delta += 1;
      setVal();
    };

    setVal();
  },0);
}


/* =========================================================
   6) å¸­ã‚¿ãƒƒãƒ—å‹•ç·šï¼ˆç©ºå¸­ï¼šæ¥åº—/äºˆç´„/æˆ»ã‚‹ ã‚’å¾©æ´»ï¼‰
========================================================= */
function openOrderFor_v3(seatId, subId){
  state.order.seatId = seatId;
  state.order.subId = subId || seatId;
  state.order.cat = null;
  state.order.genre = null;
  showScreen("scrOrder");
  renderOrder_v3();
}

/* ç©ºå¸­ï¼šæ¥åº—/äºˆç´„/æˆ»ã‚‹ */
function openEmptyAction_v3(seat){
  openModal(
    "ç©ºå¸­",
    `<div style="opacity:.92; margin-bottom:10px">æ¥åº— / äºˆç´„ ã‚’é¸æŠã—ã¦ãã ã•ã„</div>`,
    [
      {label:"æ¥åº—", lime:true, onClick:()=>{
        closeModal();
        seat.status = "in";
        seat.people = Math.max(1, Number(seat.people||1));
        seat.bills = 1;
        seat.name = seat.name || "";
        seat.total = Number(seat.total||0);
        seat.reserve = null;
        seat.merged = false;
        seat.mergeLabel = "";
        seat.sub = null;

        if(typeof emitEvent==="function") emitEvent("seat_in", {seatId: seat.id});
        renderSeats();
        openOrderFor_v3(seat.id, seat.id);
      }},
      {label:"äºˆç´„", lime:false, onClick:()=>{
        closeModal();
        openReserveInput_v3(seat);
      }},
      {label:"æˆ»ã‚‹", lime:false, onClick:()=> closeModal()},
    ],
    seat.id
  );
}

/* äºˆç´„å…¥åŠ›ï¼ˆã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã¯ä½¿ã†ï¼šâ‘¡ã®æœ¬ä¸¸ãƒã‚§ãƒƒã‚¯ç”¨ï¼‰ */
function openReserveInput_v3(seat){
  openModal(
    "äºˆç´„å…¥åŠ›",
    `
      <div style="margin-bottom:8px">æ¥åº—æ™‚é–“</div>
      <input id="rTime" class="btn full" style="text-align:left" placeholder="ä¾‹ï¼š18:30" inputmode="text" autocomplete="off" />

      <div style="margin-top:12px;margin-bottom:8px">åå‰</div>
      <input id="rName" class="btn full" style="text-align:left" placeholder="ä¾‹ï¼šä½è—¤" inputmode="text" autocomplete="off" />

      <div style="margin-top:12px;margin-bottom:8px">é€£çµ¡å…ˆ</div>
      <input id="rTel" class="btn full" style="text-align:left" placeholder="é›»è©± / ãƒ¡ãƒ¢" inputmode="text" autocomplete="off" />
    `,
    [
      {label:"ä¿å­˜", lime:true, onClick:()=>{
        const time = ($("rTime").value||"").trim();
        const name = ($("rName").value||"").trim();
        const tel  = ($("rTel").value||"").trim();

        if(!time || !name){ toast("æœªè¨˜å…¥ãŒã‚ã‚Šã¾ã™"); return; }

        seat.status = "reserve";
        seat.people = Math.max(1, Number(seat.people||1));
        seat.reserve = { time, name, tel, note:"" };
        seat.name = "";
        seat.total = 0;
        seat.bills = 0;

        if(typeof emitEvent==="function") emitEvent("reserve_set", {seatId: seat.id, time, name, tel});

        closeModal();
        renderSeats();
        toast("äºˆç´„ã‚’ä¿å­˜ã—ã¾ã—ãŸ");
      }},
      {label:"æˆ»ã‚‹", lime:false, onClick:()=> closeModal()},
    ],
    seat.id
  );
}

/* äºˆç´„ã‚«ãƒ¼ãƒ‰ï¼šæ¥åº—/ã‚­ãƒ£ãƒ³ã‚»ãƒ«/æˆ»ã‚‹ */
function openReserveAction_v3(seat){
  const r = seat.reserve || {};
  openModal(
    "äºˆç´„",
    `
      <div style="margin-bottom:6px">æ™‚é–“ï¼š${r.time||""}</div>
      <div style="margin-bottom:6px">åå‰ï¼š${r.name||""}</div>
      <div style="opacity:.85">é€£çµ¡å…ˆï¼š${r.tel||""}</div>
    `,
    [
      {label:"æ¥åº—", lime:true, onClick:()=>{
        closeModal();
        seat.status = "in";
        seat.name = r.name || "";
        seat.bills = 1;
        seat.total = Number(seat.total||0);
        seat.reserve = null;

        if(typeof emitEvent==="function") emitEvent("reserve_to_in", {seatId: seat.id});
        renderSeats();
        openOrderFor_v3(seat.id, seat.id);
      }},
      {label:"ã‚­ãƒ£ãƒ³ã‚»ãƒ«", lime:false, onClick:()=>{
        closeModal();
        openModal(
          "ã‚­ãƒ£ãƒ³ã‚»ãƒ«",
          `
            <div style="color:var(--danger); font-weight:900; margin-bottom:10px">äºˆç´„ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã™</div>
            <input id="rCancelSlide" class="range" type="range" min="0" max="100" value="0" />
          `,
          [{label:"æˆ»ã‚‹", lime:false, onClick:()=> closeModal()}],
          seat.id
        );
        setTimeout(()=>{
          $("rCancelSlide").onchange = ()=>{
            if(Number($("rCancelSlide").value||0) < 88){ $("rCancelSlide").value=0; return; }
            seat.status="empty";
            seat.people=0;
            seat.reserve=null;
            seat.name="";
            seat.total=0;
            seat.bills=0;
            seat.orders=[];
            seat.orderLog=[];
            if(typeof emitEvent==="function") emitEvent("reserve_cancel", {seatId: seat.id});
            closeModal();
            renderSeats();
            toast("ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸ");
          };
        },0);
      }},
      {label:"æˆ»ã‚‹", lime:false, onClick:()=> closeModal()},
    ],
    seat.id
  );
}

/* åˆæµå¸­ï¼šã©ã‚Œã‚’æ“ä½œï¼Ÿ */
function openMergedPick_v3(seat){
  const subs = Object.values(seat.sub||{});
  if(subs.length<=1){
    openOrderFor_v3(seat.id, seat.id);
    return;
  }

  const buttons = subs.map(su=>({
    label: su.seatId,
    lime:true,
    onClick:()=>{
      closeModal();
      openOrderFor_v3(seat.id, su.seatId);
    }
  }));
  buttons.push({label:"æˆ»ã‚‹", lime:false, onClick:()=> closeModal()});

  openModal("ã©ã¡ã‚‰ã®æ³¨æ–‡ã€ä¼šè¨ˆã‚’ã—ã¾ã™ã‹ï¼Ÿ", `<div style="opacity:.9">å¸­ã‚’é¸æŠã—ã¦ãã ã•ã„</div>`, buttons, seat.id);
}

/* å¸­ã‚«ãƒ¼ãƒ‰ã‚¿ãƒƒãƒ—ï¼šæœ¬ä½“ */
onSeatTap = function(seatId){
  const seat = seatById(seatId);
  if(!seat) return;

  if(seat.status==="empty"){
    openEmptyAction_v3(seat);
    return;
  }
  if(seat.status==="reserve"){
    openReserveAction_v3(seat);
    return;
  }

  // æ¥åº—
  if(seat.merged){
    openMergedPick_v3(seat);
    return;
  }

  openOrderFor_v3(seat.id, seat.id);
};


/* =========================================================
   7) æ³¨æ–‡ç”»é¢ã«å…¥ã£ãŸã‚‰å¿…ãšæç”»
========================================================= */
(function hookShowScreenOrder_v3(){
  if(showScreen._orderHookedV3) return;
  const _show = showScreen;
  showScreen = function(id){
    _show(id);
    if(id==="scrOrder"){
      try{ renderOrder_v3(); }catch(e){}
    }
  };
  showScreen._orderHookedV3 = true;
})();


/* =========================================================
   8) å¸­ç§»å‹•ï¼ˆå¾©æ´»ï¼‰ï¼šç§»å‹•/åˆæµãƒˆã‚°ãƒ«ï¼‹å¸­ã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼ï¼‹ã‚¹ãƒ©ã‚¤ãƒ‰ç¢ºå®š
   - ã“ã“ã ã‘è¿½åŠ ï¼šæ³¨æ–‡/å¸­ã‚¿ãƒƒãƒ—å‹•ç·šã¯å£Šã•ãªã„
   - PART1ã® openMoveHome() ã‚’ã“ã“ã§ä¸Šæ›¸ãã—ã¦å¾©æ´»
========================================================= */
(function reviveSeatMove_v1(){
  if(reviveSeatMove_v1._done) return;
  reviveSeatMove_v1._done = true;

  function allSeatsArray(){
    const s = state.seats;
    if(!s) return [];
    if(Array.isArray(s)) return s.slice();
    try{ return Object.values(s); }catch(e){ return []; }
  }

  function safeSeatId(seat){
    return (seat && (seat.id || seat.seatId || "")) + "";
  }

  function seatSortKey(id){
    // A1, A2, B1... / æ•°å­—ã ã‘ã¯æ•°å€¤é †
    const t = String(id||"").trim();
    const m = t.match(/^([A-Za-z]+)?\s*0*([0-9]+)?$/);
    if(m){
      const a = (m[1]||"").toUpperCase();
      const n = m[2] ? Number(m[2]) : -1;
      return `${a.padEnd(4,"~")}_${String(n).padStart(6,"0")}_${t}`;
    }
    return `~~~~_${t}`;
  }

  function pickSeatGridHtml(seats, selectedId, dataKey){
    // seatGrid/seatCard ã‚’æµç”¨ï¼ˆã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ç„¡ã—ï¼‰
    const cards = seats.map(seat=>{
      const id = safeSeatId(seat);
      const sel = (id===selectedId);
      const label = id || "(?)";
      const st = seat.status || "empty";
      const badge =
        st==="empty" ? `<div style="opacity:.75">ç©ºå¸­</div>` :
        st==="reserve" ? `<div style="opacity:.85">äºˆç´„</div>` :
        seat.merged ? `<div style="opacity:.85">åˆæµ</div>` :
        `<div style="opacity:.85">æ¥åº—</div>`;

      return `
        <div class="seatCard" data-${dataKey}="${id}"
             style="min-height:68px; display:flex; flex-direction:column; justify-content:center; align-items:center; gap:4px; font-weight:900;
                    ${sel ? "outline:2px solid rgba(120,255,140,.9); background:rgba(120,255,140,.12);" : ""}">
          <div style="font-size:18px">${label}</div>
          <div style="font-weight:900; font-size:12px">${badge}</div>
        </div>
      `;
    }).join("");

    return `<div class="seatGrid">${cards}</div>`;
  }

  function cloneSeatPayload(seat){
    // ã€Œç§»å‹•ã€ç”¨ï¼šä¸­èº«ã‚’ä¸¸ã”ã¨ç§»ã™ï¼ˆidä»¥å¤–ï¼‰
    return {
      status: seat.status || "empty",
      people: Number(seat.people||0),
      name: seat.name || "",
      bills: Number(seat.bills||0),
      total: Number(seat.total||0),
      orders: Array.isArray(seat.orders) ? JSON.parse(JSON.stringify(seat.orders)) : [],
      orderLog: Array.isArray(seat.orderLog) ? JSON.parse(JSON.stringify(seat.orderLog)) : [],
      reserve: seat.reserve ? JSON.parse(JSON.stringify(seat.reserve)) : null,
      merged: !!seat.merged,
      mergeLabel: seat.mergeLabel || "",
      sub: seat.sub ? JSON.parse(JSON.stringify(seat.sub)) : null,
    };
  }

  function resetSeatToEmpty(seat){
    seat.status="empty";
    seat.people=0;
    seat.name="";
    seat.bills=0;
    seat.total=0;
    seat.orders=[];
    seat.orderLog=[];
    seat.reserve=null;
    seat.merged=false;
    seat.mergeLabel="";
    seat.sub=null;
  }

  function ensureMergedContainer(target){
    // target ã‚’åˆæµã‚³ãƒ³ãƒ†ãƒŠåŒ–ï¼ˆæ—¢ã« merged ãªã‚‰ãã®ã¾ã¾ï¼‰
    if(target.merged){
      target.sub = target.sub || {};
      return;
    }
    const keep = cloneSeatPayload(target);
    target.merged = true;
    target.mergeLabel = target.mergeLabel || (target.id || "");
    target.sub = target.sub || {};

    // targetè‡ªèº«ã‚’ sub ã«å…¥ã‚Œã‚‹ï¼ˆå…ƒã®æ³¨æ–‡ã‚’å¤±ã‚ãªã„ãŸã‚ï¼‰
    const selfId = (target.id || "");
    target.sub[selfId] = target.sub[selfId] || { seatId: selfId, orders: [], orderLog: [], total: 0 };

    // å…ƒã®ãƒ‡ãƒ¼ã‚¿ã‚’ self ã«å…¥ã‚Œã‚‹
    target.sub[selfId].orders = keep.orders || [];
    target.sub[selfId].orderLog = keep.orderLog || [];
    target.sub[selfId].total = calcOrdersTotal(keep.orders || []);
    target.total = calcSeatTotal(target);
  }

  function moveSeat(fromSeat, toSeat){
    const payload = cloneSeatPayload(fromSeat);
    // toã¯ç©ºå¸­ã®ã¿è¨±å¯ï¼ˆäº‹æ•…é˜²æ­¢ï¼‰
    if((toSeat.status||"empty")!=="empty"){
      toast("ç§»å‹•å…ˆã¯ç©ºå¸­ã ã‘ã«ã—ã¦ãã ã•ã„");
      return false;
    }

    // toã¸ç§»ã™ï¼ˆidã¯ç¶­æŒï¼‰
    toSeat.status = payload.status;
    toSeat.people = payload.people;
    toSeat.name = payload.name;
    toSeat.bills = payload.bills;
    toSeat.total = payload.total;
    toSeat.orders = payload.orders || [];
    toSeat.orderLog = payload.orderLog || [];
    toSeat.reserve = payload.reserve;
    toSeat.merged = !!payload.merged;
    toSeat.mergeLabel = payload.mergeLabel || "";
    toSeat.sub = payload.sub;

    // from ã‚’ç©ºå¸­ã¸
    resetSeatToEmpty(fromSeat);

    return true;
  }

  function mergeSeat(fromSeat, toSeat){
    // from ã¯ã€Œæ¥åº—ã€ã ã‘ï¼ˆäºˆç´„/ç©ºå¸­/åˆæµã¯äº‹æ•…ã‚‹ã®ã§ç¦æ­¢ï¼‰
    if((fromSeat.status||"empty")!=="in"){
      toast("åˆæµå…ƒã¯ã€Œæ¥åº—ä¸­ã€ã®å¸­ã ã‘ã«ã—ã¦ãã ã•ã„");
      return false;
    }
    if(fromSeat.merged){
      toast("åˆæµå…ƒãŒåˆæµå¸­ã¯æœªå¯¾å¿œï¼ˆã¾ãšåˆ†é›¢ã—ã¦ã‹ã‚‰ï¼‰");
      return false;
    }

    // to ã¯ã€Œæ¥åº—ã€orã€Œåˆæµã€ã ã‘ï¼ˆç©ºå¸­/äºˆç´„ã¯ç¦æ­¢ï¼‰
    if((toSeat.status||"empty")==="empty" || (toSeat.status||"empty")==="reserve"){
      toast("åˆæµå…ˆã¯ã€Œæ¥åº—ä¸­ã€ã‹ã€Œåˆæµå¸­ã€ã‚’é¸ã‚“ã§ãã ã•ã„");
      return false;
    }

    ensureMergedContainer(toSeat);

    // fromã‚’subã¸è¿½åŠ 
    const fromId = fromSeat.id || "";
    toSeat.sub = toSeat.sub || {};
    toSeat.sub[fromId] = toSeat.sub[fromId] || { seatId: fromId, orders: [], orderLog: [], total: 0 };
    toSeat.sub[fromId].orders = Array.isArray(fromSeat.orders) ? JSON.parse(JSON.stringify(fromSeat.orders)) : [];
    toSeat.sub[fromId].orderLog = Array.isArray(fromSeat.orderLog) ? JSON.parse(JSON.stringify(fromSeat.orderLog)) : [];
    toSeat.sub[fromId].total = calcOrdersTotal(toSeat.sub[fromId].orders || []);

    // to ã®åˆè¨ˆæ›´æ–°
    toSeat.total = calcSeatTotal(toSeat);

    // from ã‚’ç©ºå¸­ã¸
    resetSeatToEmpty(fromSeat);

    return true;
  }

  // ====== ã“ã“ãŒãƒã‚¤ãƒ³ãƒˆï¼šPART1ã®openMoveHomeã‚’ä¸Šæ›¸ãã—ã¦å¾©æ´» ======
  window.openMoveHome = function openMoveHome(){
    const seats = allSeatsArray()
      .filter(s=> !!safeSeatId(s))
      .sort((a,b)=> seatSortKey(safeSeatId(a)).localeCompare(seatSortKey(safeSeatId(b))));

    if(seats.length===0){
      toast("å¸­ãŒã‚ã‚Šã¾ã›ã‚“ï¼ˆå¸­ç™»éŒ²ã‚’å…ˆã«ï¼‰");
      return;
    }

    let mode = "move"; // move | merge
    let fromId = "";
    let toId = "";

    function renderBody(){
      const fromList = seats.filter(s=>{
        const st = s.status || "empty";
        if(mode==="move"){
          // ç§»å‹•ï¼šæ¥åº—/äºˆç´„/åˆæµã‚‚å«ã‚ã¦ã€Œç©ºå¸­ä»¥å¤–ã€ã‚’ç§»å‹•å…ƒã«å‡ºã™ï¼ˆå¿…è¦ãªã‚‰ï¼‰
          return st !== "empty";
        }
        // åˆæµï¼šæ¥åº—ä¸­ã®ã¿
        return st === "in" && !s.merged;
      });

      const toList = seats.filter(s=>{
        const st = s.status || "empty";
        if(mode==="move"){
          // ç§»å‹•å…ˆï¼šç©ºå¸­ã ã‘
          return st === "empty";
        }
        // åˆæµå…ˆï¼šæ¥åº— or åˆæµ
        return st === "in" || !!s.merged;
      });

      const modeBtns = `
        <div style="display:flex; gap:10px; margin-bottom:12px">
          <button class="btn ${mode==="move"?"lime":""}" id="mvModeMove" style="flex:1; font-weight:900">ç§»å‹•</button>
          <button class="btn ${mode==="merge"?"lime":""}" id="mvModeMerge" style="flex:1; font-weight:900">åˆæµ</button>
        </div>
      `;

      const fromHtml = `
        <div style="font-weight:900; margin-bottom:8px">ã©ã“ã‹ã‚‰</div>
        ${pickSeatGridHtml(fromList, fromId, "mvfrom")}
      `;

      const toHtml = `
        <div style="height:12px"></div>
        <div style="font-weight:900; margin-bottom:8px">ã©ã“ã¸</div>
        ${pickSeatGridHtml(toList, toId, "mvto")}
      `;

      const hint = `
        <div style="height:12px"></div>
        <div style="opacity:.85">
          ${mode==="move"
            ? "â€» ç§»å‹•ï¼šç§»å‹•å…ˆã¯ç©ºå¸­ã®ã¿ï¼ˆäº‹æ•…é˜²æ­¢ï¼‰"
            : "â€» åˆæµï¼šåˆæµå…ƒã¯æ¥åº—ä¸­ã®ã¿ï¼åˆæµå…ˆã¯æ¥åº—ä¸­ or åˆæµå¸­"}
        </div>
        <div style="height:10px"></div>
        <div style="color:var(--danger); font-weight:900; margin-bottom:8px">ã‚¹ãƒ©ã‚¤ãƒ‰ã§ç¢ºå®š</div>
        <input id="mvSlide" class="range" type="range" min="0" max="100" value="0" />
      `;

      return modeBtns + fromHtml + toHtml + hint;
    }

    openModal(
      "å¸­ç§»å‹•",
      `<div id="mvWrap">${renderBody()}</div>`,
      [
        {label:"æˆ»ã‚‹", lime:false, onClick:()=> closeModal()},
      ]
    );

    function wire(){
      const wrap = $("mvWrap");

      const rerender = ()=>{
        if(!wrap) return;
        wrap.innerHTML = renderBody();
        wire(); // ä»˜ã‘ç›´ã—
      };

      // mode
      const bm = $("mvModeMove");
      const bg = $("mvModeMerge");
      if(bm) bm.onclick = ()=>{ mode="move"; fromId=""; toId=""; rerender(); };
      if(bg) bg.onclick = ()=>{ mode="merge"; fromId=""; toId=""; rerender(); };

      // select from
      wrap.querySelectorAll("[data-mvfrom]").forEach(el=>{
        el.onclick = ()=>{
          fromId = el.getAttribute("data-mvfrom") || "";
          // åŒã˜ã®é¸ã°ã›ãªã„
          if(toId === fromId) toId = "";
          rerender();
        };
      });

      // select to
      wrap.querySelectorAll("[data-mvto]").forEach(el=>{
        el.onclick = ()=>{
          toId = el.getAttribute("data-mvto") || "";
          if(fromId === toId) return;
          rerender();
        };
      });

      // slide confirm
      const sl = $("mvSlide");
      if(sl){
        sl.onchange = ()=>{
          const v = Number(sl.value||0);
          if(v < 88){ sl.value = 0; return; }

          if(!fromId || !toId){
            toast("ã€Œã©ã“ã‹ã‚‰ã€ã€Œã©ã“ã¸ã€ã‚’é¸ã‚“ã§ãã ã•ã„");
            sl.value = 0;
            return;
          }
          if(fromId === toId){
            toast("åŒã˜å¸­ã¯é¸ã¹ã¾ã›ã‚“");
            sl.value = 0;
            return;
          }

          const fromSeat = seatById(fromId);
          const toSeat = seatById(toId);
          if(!fromSeat || !toSeat){
            toast("å¸­ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");
            sl.value = 0;
            return;
          }

          let ok = false;
          if(mode==="move"){
            ok = moveSeat(fromSeat, toSeat);
            if(ok && typeof emitEvent==="function") emitEvent("seat_move", {from: fromId, to: toId});
          }else{
            ok = mergeSeat(fromSeat, toSeat);
            if(ok && typeof emitEvent==="function") emitEvent("seat_merge", {from: fromId, to: toId});
          }

          if(!ok){
            sl.value = 0;
            return;
          }

          closeModal();
          renderSeats();
          toast(mode==="move" ? "ç§»å‹•ã—ã¾ã—ãŸ" : "åˆæµã—ã¾ã—ãŸ");
        };
      }
    }

    setTimeout(wire, 0);
  };
})();


/* =========================
  ã“ã“ã‹ã‚‰å…ˆã¯ PART3 ã§ç¶šã
========================= */
/* =========================
  PART3ï¼šã‚­ãƒƒãƒãƒ³ï¼ˆå®Œæˆç‰ˆï¼‰
  å½¹å‰²ï¼šæœªèª¿ç†ä¸€è¦§ / åŒä¸€ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã¾ã¨ã‚ / ã‚¹ãƒ©ã‚¤ãƒ‰å®Œäº† / æä¾›æ¸ˆæŠ˜ã‚ŠãŸãŸã¿
  è¿½åŠ ï¼šæ³¨æ–‡ã‹ã‚‰ã‚­ãƒƒãƒãƒ³ã¸ç©ã‚€ï¼ˆæ–™ç†/ãƒ‰ãƒªãƒ³ã‚¯ï¼‰
========================= */

/* ===== UIå·®ã—æ›¿ãˆ ===== */
(function buildKitchenUI(){
  const scr = $("scrKitchen");
  scr.innerHTML = `
    <div style="font-weight:900; margin-bottom:10px">ã‚­ãƒƒãƒãƒ³</div>

    <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin-bottom:10px">
      <div style="opacity:.9">è¡¨ç¤ºï¼š</div>
      <button class="btn" id="kFilterFood">æ–™ç†</button>
      <button class="btn" id="kFilterDrink">ãƒ‰ãƒªãƒ³ã‚¯</button>
      <button class="btn ghost" id="kToggleDone">æä¾›æ¸ˆã‚’è¡¨ç¤º</button>
    </div>

    <div id="kList"></div>

    <div style="height:12px"></div>

    <div id="kDoneWrap" style="display:none">
      <div style="font-weight:900; margin-bottom:10px">æä¾›æ¸ˆ</div>
      <div id="kDoneList"></div>
    </div>
  `;
})();

/* ===== State ===== */
state.kitchen = state.kitchen || {
  showDone:false,
  showFood:true,
  showDrink:true,
  items: [] // {kid, ts, seatId, subId, name, qty, cat, status}
};

/* ===== æ³¨æ–‡â†’ã‚­ãƒƒãƒãƒ³ã¸ç©ã‚€ ===== */
function addKitchenFromOrder(seat, subId, item){
  // item.cat: "food" | "drink"
  const cat = item.cat || "food";
  const key = `${seat.id}__${subId}__${item.id}`;

  // åŒä¸€å•†å“ã¯ qty ã‚’ã¾ã¨ã‚ã‚‹ï¼ˆã‚­ãƒƒãƒãƒ³ã‚‚ã¾ã¨ã‚ã‚„ã™ãï¼‰
  let found = state.kitchen.items.find(x=> x._key===key && x.status==="todo");
  if(!found){
    found = {
      kid: "k_" + Math.random().toString(36).slice(2),
      _key: key,
      ts: nowTs(),
      seatId: seat.id,
      subId,
      name: item.name,
      qty: 1,
      cat,
      status:"todo"
    };
    state.kitchen.items.push(found);
  }else{
    found.qty += 1;
  }
}

/* ===== CSSï¼ˆã‚­ãƒƒãƒãƒ³å°‚ç”¨ï¼‰ ===== */
(function injectPart3Css(){
  const css = `
    .kRow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:10px;
      border:1px solid rgba(255,255,255,0.10);
      border-radius:14px;
      background:rgba(255,255,255,0.04);
      margin-bottom:10px;
    }
    .kLeft{
      min-width:0;
      display:flex;
      align-items:center;
      gap:10px;
      flex:1;
    }
    .kTime{ font-weight:900; width:56px; }
    .kSeat{ font-weight:900; width:52px; }
    .kName{
      min-width:0;
      font-weight:900;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    .kQty{
      font-weight:900;
      opacity:.85;
      margin-left:6px;
    }

    .kChild{ margin-left:18px; position:relative; }
    .kChild::before{
      content:"";
      position:absolute;
      left:-10px; top:0; bottom:0;
      width:2px;
      background:rgba(122,167,255,0.45);
      border-radius:99px;
    }
    .kChild .kRow{ background:rgba(122,167,255,0.08); }

    .kSlide{
      width:25vw;
      max-width:160px;
      min-width:110px;
      display:flex;
      align-items:center;
      gap:8px;
      justify-content:flex-end;
    }
    .kRange{ width:100%; accent-color: var(--accent); }
    .kDoneBadge{ font-size:12px; color:var(--ok); font-weight:900; }
  `;
  const st = document.createElement("style");
  st.textContent = css;
  document.head.appendChild(st);
})();

/* ===== Helpers ===== */
function hhmm(ts){
  const d = new Date(ts);
  return `${pad2(d.getHours())}:${pad2(d.getMinutes())}`;
}
function passCategory(item){
  if(item.cat==="food" && !state.kitchen.showFood) return false;
  if(item.cat==="drink" && !state.kitchen.showDrink) return false;
  return true;
}

/* åŒä¸€ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã¾ã¨ã‚ï¼šè¦ªï¼æœ€å¤ */
function buildKitchenGroups(list){
  const map = new Map();
  list.forEach(it=>{
    const key = `${it.name}__${it.cat}`;
    if(!map.has(key)) map.set(key, []);
    map.get(key).push(it);
  });

  const groups = [];
  map.forEach(arr=>{
    arr.sort((a,b)=> a.ts-b.ts);
    groups.push(arr);
  });
  groups.sort((ga,gb)=> ga[0].ts - gb[0].ts);
  return groups;
}

/* ===== Render ===== */
function renderKitchen(){
  const todo = state.kitchen.items.filter(it=> it.status==="todo").filter(passCategory);
  const done = state.kitchen.items.filter(it=> it.status==="done").filter(passCategory);

  const listBox = $("kList");
  const doneWrap = $("kDoneWrap");
  const doneBox  = $("kDoneList");

  listBox.innerHTML = "";
  doneBox.innerHTML = "";

  const groups = buildKitchenGroups(todo);
  if(groups.length===0){
    listBox.innerHTML = `<div style="opacity:.85">æœªèª¿ç†ã¯ã‚ã‚Šã¾ã›ã‚“</div>`;
  }else{
    groups.forEach(arr=>{
      listBox.appendChild(kRowEl(arr[0], false));
      arr.slice(1).forEach(ch=>{
        const wrap = document.createElement("div");
        wrap.className = "kChild";
        wrap.appendChild(kRowEl(ch, false));
        listBox.appendChild(wrap);
      });
    });
  }

  doneWrap.style.display = state.kitchen.showDone ? "block" : "none";
  if(state.kitchen.showDone){
    const groupsD = buildKitchenGroups(done);
    if(groupsD.length===0){
      doneBox.innerHTML = `<div style="opacity:.85">æä¾›æ¸ˆã¯ã‚ã‚Šã¾ã›ã‚“</div>`;
    }else{
      groupsD.forEach(arr=>{
        doneBox.appendChild(kRowEl(arr[0], true));
        arr.slice(1).forEach(ch=>{
          const wrap = document.createElement("div");
          wrap.className = "kChild";
          wrap.appendChild(kRowEl(ch, true));
          doneBox.appendChild(wrap);
        });
      });
    }
  }
}

function kRowEl(item, isDone){
  const row = document.createElement("div");
  row.className = "kRow";

  const qtyText = (Number(item.qty||0) >= 2) ? `Ã—${item.qty}` : "";
  const seatLabel = item.subId && item.subId!==item.seatId ? `${item.seatId}/${item.subId}` : `${item.seatId}`;

  row.innerHTML = `
    <div class="kLeft">
      <div class="kTime">${hhmm(item.ts)}</div>
      <div class="kSeat">${seatLabel}</div>
      <div class="kName">${item.name}<span class="kQty">${qtyText}</span></div>
    </div>
    <div class="kSlide">
      ${isDone ? `<span class="kDoneBadge">å®Œäº†</span>` : ``}
      <input class="kRange" type="range" min="0" max="100" value="0" aria-label="ã‚¹ãƒ©ã‚¤ãƒ‰ã§å®Œäº†" />
    </div>
  `;

  const range = row.querySelector(".kRange");
  const TH = 88;

  range.addEventListener("change", ()=>{
    const v = Number(range.value||0);
    if(v >= TH){
      item.status = isDone ? "todo" : "done";
      range.value = 0;
      renderKitchen();
    }else{
      range.value = 0;
    }
  });

  return row;
}

/* ===== Buttons ===== */
$("kToggleDone").onclick = ()=>{
  state.kitchen.showDone = !state.kitchen.showDone;
  $("kToggleDone").textContent = state.kitchen.showDone ? "æä¾›æ¸ˆã‚’éš ã™" : "æä¾›æ¸ˆã‚’è¡¨ç¤º";
  renderKitchen();
};

$("kFilterFood").onclick = ()=>{
  state.kitchen.showFood = !state.kitchen.showFood;
  $("kFilterFood").classList.toggle("lime", state.kitchen.showFood);
  renderKitchen();
};
$("kFilterDrink").onclick = ()=>{
  state.kitchen.showDrink = !state.kitchen.showDrink;
  $("kFilterDrink").classList.toggle("lime", state.kitchen.showDrink);
  renderKitchen();
};

/* åˆæœŸ */
$("kFilterFood").classList.add("lime");
$("kFilterDrink").classList.add("lime");

/* showScreen hook */
(function hookShowScreenForKitchen(){
  if(showScreen._kHooked) return;
  const _show = showScreen;
  showScreen = function(id){
    _show(id);
    if(id==="scrKitchen") renderKitchen();
  };
  showScreen._kHooked = true;
})();

renderKitchen();

/* =========================
  ã“ã“ã‹ã‚‰å…ˆã¯ PART4 ã§ç¶šã
========================= */
/* =========================
  PART4ï¼šå£²ä¸Šï¼ˆæœ¬æ—¥ï¼æ—¥åˆ¥ï¼æœˆï¼å¹´ï¼‰
  å½¹å‰²ï¼šé–²è¦§ï¼ˆç„¡æ–™ç‰ˆã§å…¨éƒ¨è¦‹ã‚‹ï¼‰ï¼‹ä¿®æ­£å°ç·šï¼ˆPART5ã¸ï¼‰
  æ–¹é‡ï¼šè»½ããƒ»ä¸å®‰ã‚’ç…½ã‚‰ãªã„ãƒ»ä¿®æ­£ã¯PART5ã¸åˆ†é›¢ï¼ˆè¨‚æ­£ä¼ç¥¨æ–¹å¼ï¼‰
  è¿½åŠ ï¼ˆç¢ºå®šå¯¾å¿œï¼‰ï¼š
    - æœ¬æ—¥ï¼æ—¥åˆ¥ï¼æœˆï¼å¹´ ã‚’ç„¡æ–™ç‰ˆã§é–²è¦§å¯èƒ½
    - æœ¬æ—¥ï¼æ—¥åˆ¥ ã®ä¸€è¦§ã¯ã€Œå…¥åº—/é€€åº—/å¸­(åå‰)/é‡‘é¡/æ”¯æ‰•/ä¿®æ­£ã€
    - ä¿®æ­£å·®åˆ†ï¼ˆè¨‚æ­£ä¼ç¥¨ï¼‰ã¯ â€œå¯¾è±¡è¡Œã®ç›´ä¸‹â€ ã«è¿½åŠ è¡¨ç¤ºï¼ˆä¸Šæ›¸ããªã—ï¼‰
========================= */

/* ===== UIå·®ã—æ›¿ãˆï¼ˆãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ç½®æ›ï¼‰ ===== */
(function buildSalesUI(){
  const scr = $("scrSales");
  scr.innerHTML = `
    <div class="pill" style="margin-bottom:10px">å£²ä¸Š</div>

    <div style="display:flex; gap:8px; margin-bottom:10px; flex-wrap:wrap">
      <button class="btn primary" id="tabToday">æœ¬æ—¥</button>
      <button class="btn" id="tabDaily">æ—¥åˆ¥</button>
      <button class="btn" id="tabMonth">æœˆ</button>
      <button class="btn" id="tabYear">å¹´</button>
    </div>

    <div id="salesToday"></div>
    <div id="salesDaily" style="display:none"></div>
    <div id="salesMonth" style="display:none"></div>
    <div id="salesYear" style="display:none"></div>
  `;
})();

/* ===== PART4 State ===== */
state.sales = state.sales || {
  list: [],
  tab: "today",
  dailyYmd: null, // æ—¥åˆ¥ã§é¸æŠä¸­ã®æ—¥ä»˜ï¼ˆYYYY-MM-DDï¼‰
};

/* ===== Helpers ===== */
function ymd(d){
  return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
}
function sameDay(a,b){
  return a.getFullYear()===b.getFullYear()
      && a.getMonth()===b.getMonth()
      && a.getDate()===b.getDate();
}
function fmtHM(ts){
  if(!ts) return "--:--";
  const d = new Date(ts);
  return `${pad2(d.getHours())}:${pad2(d.getMinutes())}`;
}
function safeNum(n){ n=Number(n); return Number.isFinite(n)?n:0; }

/* ===== Demo Seedï¼ˆinTs/outTsã‚‚ä»˜ã‘ã‚‹ï¼‰ ===== */
(function seedSalesIfEmpty(){
  if(state.sales.list.length) return;

  const now = new Date();
  const mk = (inH,inM,outH,outM,seat,name,pay,amt)=>{
    const inD  = new Date(now.getFullYear(), now.getMonth(), now.getDate(), inH, inM);
    const outD = new Date(now.getFullYear(), now.getMonth(), now.getDate(), outH, outM);
    return {
      saleId: "s"+Math.random().toString(36).slice(2),
      ts: outD.getTime(),      // ä¼šè¨ˆæ™‚åˆ»ï¼ˆé€€åº—å¯„ã‚Šã§OKï¼‰
      inTs: inD.getTime(),
      outTs: outD.getTime(),
      seatId: seat,
      name: name||"",
      pay,
      amount: amt,
      receipt: true,
      items: [
        {name:"ç”Ÿãƒ“ãƒ¼ãƒ«", qty:2, price:600, tax:10},
        {name:"å”æšã’", qty:1, price:800, tax:10},
      ],
      corrections: [] // è¨‚æ­£ä¼ç¥¨ï¼ˆå·®åˆ†ï¼‰ã‚’ã“ã“ã«ç©ã‚€
    };
  };

  state.sales.list.push(
    mk(12,10,12,35,"D","ç”°ä¸­","ã‚«ãƒ¼ãƒ‰",4800),
    mk(13,00,13,10,"A","","ç¾é‡‘",1800),
    mk(13,40,14, 5,"B","ä½è—¤","QR",2200),
  );

  // æ—¥åˆ¥ã®åˆæœŸæ—¥ä»˜ï¼šä»Šæ—¥
  state.sales.dailyYmd = ymd(new Date());
})();

/* ===== Aggregation ===== */
function filterByYmd(targetYmd){
  const rows = state.sales.list.filter(s=>{
    const d = new Date(s.ts);
    return ymd(d) === targetYmd;
  });
  return rows;
}

function aggByRows(rows){
  const sum = rows.reduce((a,b)=> a + safeNum(b.amount), 0);
  const cnt = rows.length;

  const payCnt = {ç¾é‡‘:0, ã‚«ãƒ¼ãƒ‰:0, QR:0};
  const paySum = {ç¾é‡‘:0, ã‚«ãƒ¼ãƒ‰:0, QR:0};

  rows.forEach(s=>{
    const p = s.pay || "ç¾é‡‘";
    if(!(p in payCnt)) payCnt[p]=0;
    if(!(p in paySum)) paySum[p]=0;
    payCnt[p] += 1;
    paySum[p] += safeNum(s.amount);
  });

  return {sum,cnt,payCnt,paySum};
}

function aggToday(){
  const today = ymd(new Date());
  const rows = filterByYmd(today);
  return { ymd: today, rows, ...aggByRows(rows) };
}

function aggDaily(targetYmd){
  const rows = filterByYmd(targetYmd);
  return { ymd: targetYmd, rows, ...aggByRows(rows) };
}

function aggMonth(){
  const d = new Date();
  const y=d.getFullYear(), m=d.getMonth();
  const rows = state.sales.list.filter(s=>{
    const x=new Date(s.ts);
    return x.getFullYear()===y && x.getMonth()===m;
  });
  const sum = rows.reduce((a,b)=> a+safeNum(b.amount), 0);
  return {sum, cnt: rows.length};
}

function aggYear(){
  const y=new Date().getFullYear();
  const rows = state.sales.list.filter(s=> new Date(s.ts).getFullYear()===y);
  const sum = rows.reduce((a,b)=> a+safeNum(b.amount), 0);
  return {sum, cnt: rows.length};
}

/* ===== ä¿®æ­£å°ç·šï¼ˆPART5ã¸ï¼‰ ===== */
function goFix(saleId){
  // PART5å·®ã—æ›¿ãˆç‰ˆï¼šwindow.ONE_openFixForSaleId ãŒã‚ã‚‹æƒ³å®š
  if(typeof window.ONE_openFixForSaleId === "function"){
    window.ONE_openFixForSaleId(saleId);
    return;
  }
  toast("ä¿®æ­£æ©Ÿèƒ½ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ï¼ˆPART5ã‚’åæ˜ ã—ã¦ãã ã•ã„ï¼‰");
}

/* ===== è¨‚æ­£ä¼ç¥¨è¡¨ç¤ºï¼ˆå¯¾è±¡è¡Œã®ç›´ä¸‹ï¼‰ ===== */
function renderCorrectionsInline(s){
  const list = (s.corrections || []);
  if(!list.length) return "";

  // æ–°ã—ã„é †ã«è¦‹ã›ã‚‹ï¼ˆç›´ä¸‹ã«è¤‡æ•°ä¸¦ã¶ï¼‰
  const html = list.slice().sort((a,b)=> (b.ts||0)-(a.ts||0)).map(c=>{
    const beforePay = c.payBefore || s.pay || "";
    const afterPay  = c.payAfter  || "";

    // å•†å“å·®åˆ†ï¼ˆå·¦ï¼šå‰ / å³ï¼šå¾Œï¼‰
    const before = c.itemsBefore || [];
    const after  = c.itemsAfter  || [];

    // åå‰é›†åˆã§ä¸¦ã¹ã‚‹
    const map = new Map();
    before.forEach(it=>{
      const k = it.name || "";
      if(!k) return;
      if(!map.has(k)) map.set(k, {name:k, b:0, a:0});
      map.get(k).b += safeNum(it.qty);
    });
    after.forEach(it=>{
      const k = it.name || "";
      if(!k) return;
      if(!map.has(k)) map.set(k, {name:k, b:0, a:0});
      map.get(k).a += safeNum(it.qty);
    });
    const diffs = Array.from(map.values()).sort((x,y)=> x.name.localeCompare(y.name,"ja"));

    const diffRows = diffs.map(x=>`
      <div style="display:flex; justify-content:space-between; gap:10px; margin:4px 0">
        <div style="min-width:0; overflow:hidden; text-overflow:ellipsis; white-space:nowrap">${x.name}</div>
        <div style="display:flex; gap:8px; font-weight:900">
          <span>${x.b}</span><span style="color:var(--muted)">â†’</span><span>${x.a}</span>
        </div>
      </div>
    `).join("");

    return `
      <div class="pill" style="margin:8px 0 10px; color:var(--muted)">
        è¨‚æ­£ï¼š${fmtHM(c.ts)} ï¼ ${c.who||""} ï¼ ${c.why||""}<br>
        æ”¯æ‰•ï¼š${beforePay}${afterPay?` â†’ ${afterPay}`:""}<br>
        ${diffRows || "ï¼ˆæ•°é‡å¤‰æ›´ãªã—ï¼‰"}
      </div>
    `;
  }).join("");

  return html;
}

/* ===== List Row ===== */
function saleRowEl(s){
  const row = document.createElement("div");
  row.className = "kRow";
  row.dataset.saleId = s.saleId;

  const inT  = fmtHM(s.inTs);
  const outT = fmtHM(s.outTs);
  const seatLabel = `${s.seatId || ""}${s.name ? `ï¼ˆ${s.name}ï¼‰` : ""}`;

  row.innerHTML = `
    <div class="kLeft" style="align-items:flex-start">
      <div style="width:64px; font-weight:900">${inT}</div>
      <div style="width:64px; font-weight:900">${outT}</div>
      <div class="kName" style="font-weight:900">${seatLabel}</div>
    </div>

    <div class="kSlide" style="gap:10px; width:auto">
      <div style="font-weight:900">${yen(s.amount)}</div>
      <div class="pill">${s.pay || "ç¾é‡‘"}</div>
      <button class="btn" data-fix="${s.saleId}">ä¿®æ­£</button>
    </div>
  `;

  // è¡Œã‚¿ãƒƒãƒ—ï¼šè©³ç´°ï¼ˆæ—¢å­˜ã® openSaleDetail ãŒã‚ã‚Œã°ï¼‰
  row.onclick = (e)=>{
    if(e && e.target && e.target.getAttribute && e.target.getAttribute("data-fix")) return;
    if(typeof openSaleDetail === "function") openSaleDetail(s);
  };

  return row;
}

/* ===== Render ===== */
function renderSales(){
  const t = $("salesToday");
  const d = $("salesDaily");
  const m = $("salesMonth");
  const y = $("salesYear");

  t.style.display = state.sales.tab==="today" ? "block":"none";
  d.style.display = state.sales.tab==="daily" ? "block":"none";
  m.style.display = state.sales.tab==="month" ? "block":"none";
  y.style.display = state.sales.tab==="year"  ? "block":"none";

  if(state.sales.tab==="today") renderToday();
  if(state.sales.tab==="daily") renderDaily();
  if(state.sales.tab==="month") renderMonth();
  if(state.sales.tab==="year")  renderYear();
}

function renderToday(){
  const box = $("salesToday");
  const a = aggToday();

  const payTxt = `ç¾é‡‘ ${a.payCnt["ç¾é‡‘"]||0} / ã‚«ãƒ¼ãƒ‰ ${a.payCnt["ã‚«ãƒ¼ãƒ‰"]||0} / QR ${a.payCnt["QR"]||0}`;

  box.innerHTML = `
    <div class="pill" style="margin-bottom:8px">
      åˆè¨ˆ ${yen(a.sum)} ï¼ ä¼šè¨ˆ ${a.cnt}ä»¶ ï¼ ${payTxt}
    </div>

    <div id="todayList"></div>
  `;

  const list = box.querySelector("#todayList");
  if(a.rows.length===0){
    list.innerHTML = `<div class="pill">æœ¬æ—¥ã®ä¼šè¨ˆã¯ã‚ã‚Šã¾ã›ã‚“</div>`;
    return;
  }

  a.rows
    .slice()
    .sort((x,y)=> x.ts - y.ts)
    .forEach(s=>{
      // å…ƒè¡Œ
      const row = saleRowEl(s);
      list.appendChild(row);

      // ç›´ä¸‹ï¼šè¨‚æ­£ä¼ç¥¨ï¼ˆå·®åˆ†ï¼‰
      const inline = renderCorrectionsInline(s);
      if(inline){
        const wrap = document.createElement("div");
        wrap.innerHTML = inline;
        list.appendChild(wrap);
      }
    });

  // ä¿®æ­£ãƒœã‚¿ãƒ³
  list.querySelectorAll("[data-fix]").forEach(btn=>{
    btn.onclick = (e)=>{
      e.stopPropagation();
      const id = btn.getAttribute("data-fix");
      goFix(id);
    };
  });
}

function renderDaily(){
  const box = $("salesDaily");
  const todayY = ymd(new Date());
  const cur = state.sales.dailyYmd || todayY;

  const a = aggDaily(cur);

  box.innerHTML = `
    <div class="pill" style="margin-bottom:8px">æ—¥ä»˜</div>
    <input id="dailyPick" class="btn" style="width:100%; text-align:left; margin-bottom:10px" value="${cur}" />

    <div class="pill" style="margin-bottom:8px">
      æœ¬æ—¥ã®ç·å£²ä¸Š ${yen(a.sum)} ï¼ ç·ä¼šè¨ˆæ•° ${a.cnt}ä»¶
    </div>

    <div class="pill" style="margin-bottom:10px; color:var(--muted)">
      ç¾é‡‘ï¼š${a.payCnt["ç¾é‡‘"]||0}ä»¶ï¼${yen(a.paySum["ç¾é‡‘"]||0)}<br>
      ã‚«ãƒ¼ãƒ‰ï¼š${a.payCnt["ã‚«ãƒ¼ãƒ‰"]||0}ä»¶ï¼${yen(a.paySum["ã‚«ãƒ¼ãƒ‰"]||0)}<br>
      QRï¼š${a.payCnt["QR"]||0}ä»¶ï¼${yen(a.paySum["QR"]||0)}
    </div>

    <div id="dailyList"></div>
  `;

  const list = box.querySelector("#dailyList");
  if(a.rows.length===0){
    list.innerHTML = `<div class="pill">ã“ã®æ—¥ã®ä¼šè¨ˆã¯ã‚ã‚Šã¾ã›ã‚“</div>`;
  }else{
    a.rows
      .slice()
      .sort((x,y)=> x.ts - y.ts)
      .forEach(s=>{
        const row = saleRowEl(s);
        list.appendChild(row);

        const inline = renderCorrectionsInline(s);
        if(inline){
          const wrap = document.createElement("div");
          wrap.innerHTML = inline;
          list.appendChild(wrap);
        }
      });

    list.querySelectorAll("[data-fix]").forEach(btn=>{
      btn.onclick = (e)=>{
        e.stopPropagation();
        const id = btn.getAttribute("data-fix");
        goFix(id);
      };
    });
  }

  // æ—¥ä»˜å¤‰æ›´
  $("dailyPick").onchange = ()=>{
    const v = ($("dailyPick").value||"").trim();
    if(!v){ state.sales.dailyYmd = todayY; }
    else state.sales.dailyYmd = v;
    renderDaily();
  };
}

function renderMonth(){
  const box = $("salesMonth");
  const a = aggMonth();
  box.innerHTML = `
    <div class="pill">æœˆåˆè¨ˆ ${yen(a.sum)} ï¼ ä¼šè¨ˆ ${a.cnt}ä»¶</div>
    <div style="height:8px"></div>
    <div class="pill">ç„¡æ–™ç‰ˆï¼šæœˆã®å†…è¨³ï¼ˆã‚°ãƒ©ãƒ•ç­‰ï¼‰ã¯ä»Šå¾Œã®æœ‰æ–™ç‰ˆã§å¼·åŒ–</div>
  `;
}

function renderYear(){
  const box = $("salesYear");
  const a = aggYear();
  box.innerHTML = `
    <div class="pill">å¹´åˆè¨ˆ ${yen(a.sum)} ï¼ ä¼šè¨ˆ ${a.cnt}ä»¶</div>
    <div style="height:8px"></div>
    <div class="pill">ç„¡æ–™ç‰ˆï¼šå¹´ã®å†…è¨³ï¼ˆã‚°ãƒ©ãƒ•ç­‰ï¼‰ã¯ä»Šå¾Œã®æœ‰æ–™ç‰ˆã§å¼·åŒ–</div>
  `;
}

/* ===== Detailï¼ˆä¿®æ­£ã¯PART5ã¸ï¼‰ ===== */
function openSaleDetail(s){
  const items = (s.items||[]).map(it=>`${it.name} Ã—${it.qty}`).join("<br>");
  openModal(
    "ä¼šè¨ˆè©³ç´°",
    `
      <div>å…¥åº—ï¼š${fmtHM(s.inTs)}</div>
      <div>é€€åº—ï¼š${fmtHM(s.outTs)}</div>
      <div>å¸­ï¼š${s.seatId}${s.name?`ï¼ˆ${s.name}ï¼‰`:""}</div>
      <div>æ”¯æ‰•ï¼š${s.pay}</div>
      <div style="margin-top:8px">${items}</div>
      <div style="margin-top:8px;font-weight:900">${yen(s.amount)}</div>
    `,
    [
      {label:"ä¿®æ­£", primary:true, onClick:()=>{ closeModal(); goFix(s.saleId); }},
      {label:"æˆ»ã‚‹", onClick:()=> closeModal()},
    ]
  );
}

/* ===== Tabs ===== */
function setTab(t){
  state.sales.tab = t;

  $("tabToday").classList.toggle("primary", t==="today");
  $("tabDaily").classList.toggle("primary", t==="daily");
  $("tabMonth").classList.toggle("primary", t==="month");
  $("tabYear").classList.toggle("primary", t==="year");

  renderSales();
}

$("tabToday").onclick=()=> setTab("today");
$("tabDaily").onclick=()=> setTab("daily");
$("tabMonth").onclick=()=> setTab("month");
$("tabYear").onclick =()=> setTab("year");

/* ===== showScreenæ‹¡å¼µ ===== */
(function hookShowScreenForSales(){
  if(showScreen._sHooked2) return;
  const _show = showScreen;
  showScreen = function(id){
    _show(id);
    if(id==="scrSales") renderSales();
  };
  showScreen._sHooked2 = true;
})();

/* åˆæœŸæç”» */
renderSales();

/* =========================
  ã“ã“ã‹ã‚‰å…ˆã¯ PART5 ã§ç¶šã
========================= */
/* =========================
  PART5ï¼šå£²ä¸Šç®¡ç†ãƒ»è¨‚æ­£ä¼ç¥¨ï¼ˆæœ¬æ—¥ï¼æ—¥åˆ¥ã®ä¿®æ­£ï¼‰
  å½¹å‰²ï¼šä¼šè¨ˆç¢ºå®šå¾Œã®ä¿®æ­£ï¼ˆå·®åˆ†ã‚¤ãƒ™ãƒ³ãƒˆã®ã¿ï¼‰
  æ–¹é‡ï¼šæ¶ˆã•ãªã„ï¼ä¸Šæ›¸ãã—ãªã„ï¼å±¥æ­´ã‚’æ®‹ã™ï¼ˆè¨‚æ­£ä¼ç¥¨æ–¹å¼ï¼‰
  ä¿®æ­£å¯¾è±¡ï¼ˆç¢ºå®šï¼‰ï¼š
    â‘  æ³¨æ–‡å•†å“æ•°ï¼ˆ0ä»¥ä¸‹ä¸å¯ï¼‰
    â‘¡ æ”¯æ‰•ã„æ–¹æ³•
  ä¿®æ­£æ™‚ å¿…é ˆï¼š
    ãƒ»ä¿®æ­£è€…åï¼ˆå¿…é ˆï¼‰
    ãƒ»ä¿®æ­£ç†ç”±ï¼ˆå¿…é ˆï¼‰
  è¡¨ç¤ºï¼š
    ãƒ»ä¿®æ­£å·®åˆ†ã¯ã€Œå¯¾è±¡è¡Œã®ç›´ä¸‹ã€ã«è¿½åŠ è¡¨ç¤ºï¼ˆå…ƒã¯æ®‹ã™ï¼‰
========================= */

/* ===== UIå·®ã—æ›¿ãˆï¼ˆãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ç½®æ›ï¼‰ ===== */
(function buildFixUI(){
  const scr = $("scrFix");
  scr.innerHTML = `
    <div class="pill" style="margin-bottom:10px">ä¿®æ­£ï¼ˆè¨‚æ­£ä¼ç¥¨æ–¹å¼ï¼‰</div>
    <div id="fixBody"></div>
  `;
})();

/* ===== PART5 State ===== */
state.fix = state.fix || {
  targetId: null,      // saleId
  draft: null,         // ç·¨é›†ä¸­ã®ãƒ‰ãƒ©ãƒ•ãƒˆ
  stage: "edit",       // "edit" | "confirm"
};

/* =========================================================
  Saleãƒ‡ãƒ¼ã‚¿æƒ³å®šï¼ˆæ—¢å­˜ã‚’å£Šã•ãªã„ãŸã‚ã®äº’æ›ï¼‰
  - state.sales.list ã®å„è¦ç´ ï¼ˆsaleï¼‰ã¯æœ€ä½é™:
    {
      saleId, ts,
      seatId, name, pay, amount,
      items:[{name, qty, price, tax}],
      inTs?, outTs?,
      corrections?: [
        {
          corrId, ts,
          who, why,
          payBefore, payAfter,
          itemsBefore:[{name, qty}], itemsAfter:[{name, qty}]
        }
      ]
    }
========================================================= */

function getSaleById(id){
  return (state.sales && Array.isArray(state.sales.list))
    ? state.sales.list.find(s => s.saleId === id)
    : null;
}

function safeNum(n){ n = Number(n); return Number.isFinite(n) ? n : 0; }

function calcAmountFromItems(items){
  // ç¨è¨ˆç®—ã¯ç„¡æ–™ç‰ˆã¯â€œç·é¡ã®æ•´åˆå„ªå…ˆâ€ã§ç°¡æ˜“ï¼ˆã“ã“ã¯å¾Œã§ç²¾å¯†åŒ–ã§ãã‚‹ï¼‰
  // ç¾çŠ¶ï¼šprice * qty ã®åˆè¨ˆ
  return (items||[]).reduce((sum, it)=> sum + safeNum(it.price) * safeNum(it.qty), 0);
}

function cloneItemsForEdit(items){
  return (items||[]).map(it=> ({
    name: it.name || "",
    qty: Math.max(0, safeNum(it.qty)),
    price: safeNum(it.price),
    tax: safeNum(it.tax),
  }));
}

function itemsToNameQty(items){
  return (items||[]).map(it=> ({ name: it.name || "", qty: Math.max(0, safeNum(it.qty)) }));
}

function fmtHM(ts){
  if(!ts) return "--:--";
  const d = new Date(ts);
  return `${pad2(d.getHours())}:${pad2(d.getMinutes())}`;
}

function payOptionsHtml(sel){
  const opts = ["ç¾é‡‘","ã‚«ãƒ¼ãƒ‰","QR"];
  return opts.map(p=> `<option ${p===sel?"selected":""}>${p}</option>`).join("");
}

function diffNameQty(before, after){
  // è¡¨ç¤ºç”¨ï¼šå·¦å³ã«åŒã˜é †ã§ä¸¦ã¹ãŸã„
  // â€œåå‰é›†åˆâ€ã§ã¾ã¨ã‚ã‚‹
  const map = new Map();
  (before||[]).forEach(it=>{
    const k = it.name || "";
    if(!map.has(k)) map.set(k, {name:k, b:0, a:0});
    map.get(k).b += safeNum(it.qty);
  });
  (after||[]).forEach(it=>{
    const k = it.name || "";
    if(!map.has(k)) map.set(k, {name:k, b:0, a:0});
    map.get(k).a += safeNum(it.qty);
  });
  return Array.from(map.values()).filter(x=> x.name).sort((x,y)=> x.name.localeCompare(y.name, "ja"));
}

/* =========================================================
  PART4ã‹ã‚‰ã®å…¥å£ï¼ˆä¿®æ­£ãƒœã‚¿ãƒ³ â†’ scrFixï¼‰
  æ—¢å­˜ openSaleDetail(s) ã‚’å£Šã•ãš â€œä¿®æ­£å¯¾è±¡ã‚’ä¿æŒâ€ã™ã‚‹
========================================================= */
(function hookFixEntry(){
  // PART4ã® openSaleDetail ãŒã‚ã‚‹å‰æã§ãƒ•ãƒƒã‚¯ï¼ˆç„¡ãã¦ã‚‚å‹•ãï¼‰
  if(typeof openSaleDetail !== "function") return;
  if(openSaleDetail._p5Hooked) return;

  const _open = openSaleDetail;
  openSaleDetail = function(sale){
    _open(sale);
    // ä¿®æ­£ãƒœã‚¿ãƒ³æŠ¼ä¸‹æ™‚ã«å¯¾è±¡ãŒå¿…è¦ãªã®ã§ä¿æŒ
    state.fix.targetId = sale && sale.saleId ? sale.saleId : null;
  };

  openSaleDetail._p5Hooked = true;
})();

/* =========================================================
  â€œä¿®æ­£â€ç”»é¢ã‚’é–‹ãå…±é€šé–¢æ•°ï¼ˆä»Šæ—¥/æ—¥åˆ¥ã®ä¸€è¦§ã‹ã‚‰å‘¼ã¹ã‚‹ï¼‰
========================================================= */
function openFixForSaleId(saleId){
  const s = getSaleById(saleId);
  if(!s){
    toast("ä¿®æ­£å¯¾è±¡ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");
    return;
  }

  // ãƒ‰ãƒ©ãƒ•ãƒˆä½œæˆï¼ˆç·¨é›†ã¯ items.qty ã¨ pay ã®ã¿ï¼‰
  const baseItems = cloneItemsForEdit(s.items || []);
  const basePay = s.pay || "ç¾é‡‘";

  state.fix.targetId = s.saleId;
  state.fix.stage = "edit";
  state.fix.draft = {
    who: "",
    why: "",
    pay: basePay,
    items: baseItems,          // qtyã‚’ã“ã“ã§å¢—æ¸›
    baseItems: cloneItemsForEdit(s.items || []),
    basePay: basePay,
  };

  showScreen("scrFix");
  renderFix();
}

/* =========================================================
  FIXï¼šç·¨é›†ç”»é¢ â†’ ç¢ºèªç”»é¢ â†’ ã‚¹ãƒ©ã‚¤ãƒ‰ç¢ºå®š
========================================================= */
function renderFix(){
  const box = $("fixBody");
  const s = getSaleById(state.fix.targetId);

  if(!s){
    box.innerHTML = `<div class="pill">ä¿®æ­£å¯¾è±¡ãŒã‚ã‚Šã¾ã›ã‚“</div>`;
    return;
  }

  // in/out ã¯ç„¡ã„å ´åˆã‚‚ã‚ã‚‹ï¼ˆæ—¢å­˜ãƒ‡ãƒ¼ã‚¿äº’æ›ï¼‰
  const inT  = fmtHM(s.inTs || null);
  const outT = fmtHM(s.outTs || null);

  const seatLabel = `${s.seatId || ""}${s.name ? `ï¼ˆ${s.name}ï¼‰` : ""}`;
  const baseAmount = safeNum(s.amount) || calcAmountFromItems(s.items||[]);

  // ãƒ‰ãƒ©ãƒ•ãƒˆãŒç„¡ã„å ´åˆã¯ç”Ÿæˆï¼ˆç›´æ¥scrFixã«æ¥ãŸã‚±ãƒ¼ã‚¹æ•‘æ¸ˆï¼‰
  if(!state.fix.draft){
    state.fix.draft = {
      who:"",
      why:"",
      pay: s.pay || "ç¾é‡‘",
      items: cloneItemsForEdit(s.items || []),
      baseItems: cloneItemsForEdit(s.items || []),
      basePay: s.pay || "ç¾é‡‘",
    };
    state.fix.stage = "edit";
  }

  const d = state.fix.draft;
  const newAmount = calcAmountFromItems(d.items);

  if(state.fix.stage === "edit"){
    const rows = d.items.map((it, idx)=>{
      const qty = Math.max(0, safeNum(it.qty));
      return `
        <div class="kRow" style="align-items:flex-start">
          <div class="kLeft" style="align-items:flex-start">
            <div class="kName">${it.name}</div>
          </div>
          <div class="kSlide" style="flex-direction:column; align-items:flex-end; gap:8px">
            <div class="pill" style="min-width:120px; justify-content:center; font-weight:900">
              ${yen(safeNum(it.price) * qty)}
            </div>
            <div style="display:flex; gap:8px; align-items:center">
              <button class="btn" data-minus="${idx}">âˆ’</button>
              <div class="pill" style="min-width:54px; justify-content:center; font-weight:900">${qty}</div>
              <button class="btn" data-plus="${idx}">ï¼‹</button>
            </div>
          </div>
        </div>
      `;
    }).join("");

    box.innerHTML = `
      <!-- ä¸Šæ®µï¼šç¾çŠ¶ -->
      <div class="pill" style="margin-bottom:8px">ç¾çŠ¶ï¼ˆä¿®æ­£å‰ï¼‰</div>
      <div class="pill" style="margin-bottom:10px; color:var(--muted)">
        å…¥åº— ${inT} / é€€åº— ${outT}<br>
        å¸­ ${seatLabel}<br>
        é‡‘é¡ ${yen(baseAmount)} / æ”¯æ‰• ${s.pay || "ç¾é‡‘"}
      </div>

      <!-- å…¥åŠ› -->
      <div style="display:flex; gap:10px; margin-bottom:10px">
        <button class="btn" id="fixBack" style="flex:1">æˆ»ã‚‹</button>
        <button class="btn primary" id="fixToConfirm" style="flex:1">æ±ºå®š</button>
      </div>

      <div class="pill" style="margin-bottom:6px">ä¿®æ­£è€…åï¼ˆå¿…é ˆï¼‰</div>
      <input id="fixWho" class="btn" style="width:100%; text-align:left; margin-bottom:10px" placeholder="åå‰" value="${(d.who||"").replace(/"/g,"&quot;")}" />

      <div class="pill" style="margin-bottom:6px">ä¿®æ­£ç†ç”±ï¼ˆå¿…é ˆï¼‰</div>
      <input id="fixWhy" class="btn" style="width:100%; text-align:left; margin-bottom:12px" placeholder="ç†ç”±" value="${(d.why||"").replace(/"/g,"&quot;")}" />

      <!-- æ“ä½œåˆ— -->
      <div class="pill" style="margin-bottom:6px">ä¿®æ­£å¾Œ</div>
      <div class="pill" style="margin-bottom:10px">
        ä¿®æ­£å¾Œé‡‘é¡ï¼š<span style="font-weight:900">${yen(newAmount)}</span>
      </div>

      <div class="pill" style="margin-bottom:6px">æ”¯æ‰•ã„æ–¹æ³•</div>
      <select id="fixPay" class="btn" style="width:100%; margin-bottom:12px">
        ${payOptionsHtml(d.pay)}
      </select>

      <!-- æ˜ç´° -->
      <div class="pill" style="margin-bottom:6px">å•†å“æ˜ç´°ï¼ˆæ•°é‡å¤‰æ›´ï¼‰</div>
      ${rows}
    `;

    // æˆ»ã‚‹
    $("fixBack").onclick = ()=> showScreen("scrSales"); // ç¾çŠ¶ã®æ§‹é€ ã«åˆã‚ã›ã¦ã€Œå£²ä¸Šã€ã¸æˆ»ã™ï¼ˆå¾Œã§ç®¡ç†ç”»é¢ãŒå‡ºæ¥ãŸã‚‰å·®ã—æ›¿ãˆOKï¼‰

    // æ±ºå®š â†’ ç¢ºèªã¸
    $("fixToConfirm").onclick = ()=>{
      d.who = ($("fixWho").value||"").trim();
      d.why = ($("fixWhy").value||"").trim();
      d.pay = ($("fixPay").value||"").trim() || d.pay;

      if(!d.who || !d.why){
        toast("ä¿®æ­£è€…åã¨ä¿®æ­£ç†ç”±ã¯å¿…é ˆã§ã™");
        return;
      }
      state.fix.stage = "confirm";
      renderFix();
    };

    // æ”¯æ‰•å¤‰æ›´
    $("fixPay").onchange = ()=> {
      d.pay = ($("fixPay").value||"").trim() || d.pay;
    };

    // æ•°é‡ Â±ï¼ˆ0ä»¥ä¸‹ä¸å¯ï¼‰
    box.querySelectorAll("[data-minus]").forEach(btn=>{
      btn.onclick = ()=>{
        const i = Number(btn.getAttribute("data-minus"));
        const it = d.items[i];
        if(!it) return;
        it.qty = Math.max(0, safeNum(it.qty) - 1);
        renderFix();
      };
    });
    box.querySelectorAll("[data-plus]").forEach(btn=>{
      btn.onclick = ()=>{
        const i = Number(btn.getAttribute("data-plus"));
        const it = d.items[i];
        if(!it) return;
        it.qty = Math.max(0, safeNum(it.qty) + 1);
        renderFix();
      };
    });

    return;
  }

  // ===== confirm =====
  const beforeItems = itemsToNameQty(d.baseItems);
  const afterItems  = itemsToNameQty(d.items);
  const diff = diffNameQty(beforeItems, afterItems);

  const diffRows = diff.map(x=>{
    return `
      <div class="kRow">
        <div class="kLeft">
          <div class="kName">${x.name}</div>
        </div>
        <div class="kSlide" style="justify-content:space-between; width:180px">
          <div style="font-weight:900">${x.b}</div>
          <div style="color:var(--muted)">â†’</div>
          <div style="font-weight:900">${x.a}</div>
        </div>
      </div>
    `;
  }).join("");

  box.innerHTML = `
    <div class="pill" style="margin-bottom:8px">ç¢ºèª</div>

    <div class="pill" style="margin-bottom:8px">ä¿®æ­£å‰</div>
    <div class="pill" style="margin-bottom:10px; color:var(--muted)">
      å…¥åº— ${inT} / é€€åº— ${outT}<br>
      å¸­ ${seatLabel}<br>
      é‡‘é¡ ${yen(baseAmount)} / æ”¯æ‰• ${d.basePay}
    </div>

    <div class="pill" style="margin-bottom:8px">ä¿®æ­£å¾Œ</div>
    <div class="pill" style="margin-bottom:10px; color:var(--muted)">
      å…¥åº— ${inT} / é€€åº— ${outT}<br>
      å¸­ ${seatLabel}<br>
      é‡‘é¡ ${yen(calcAmountFromItems(d.items))} / æ”¯æ‰• ${d.pay}
    </div>

    <div class="pill" style="margin-bottom:6px">æ•°é‡å¤‰æ›´ï¼ˆå·¦ï¼šå‰ / å³ï¼šå¾Œï¼‰</div>
    ${diffRows || `<div class="pill">å¤‰æ›´ãªã—</div>`}

    <div class="pill" style="margin-top:10px; margin-bottom:6px; color:var(--muted)">
      ä¿®æ­£è€…ï¼š${d.who} / ç†ç”±ï¼š${d.why}
    </div>

    <div style="display:flex; gap:10px; margin-top:10px">
      <button class="btn" id="fixBackToEdit" style="flex:1">æˆ»ã‚‹</button>
      <div style="flex:1">
        <div class="pill" style="margin-bottom:6px; text-align:center">å³ã¸ã‚¹ãƒ©ã‚¤ãƒ‰ã§ç¢ºå®š</div>
        <input id="fixSlideOk" class="kRange" type="range" min="0" max="100" value="0"/>
      </div>
    </div>
  `;

  $("fixBackToEdit").onclick = ()=>{
    state.fix.stage = "edit";
    renderFix();
  };

  $("fixSlideOk").onchange = ()=>{
    const v = Number($("fixSlideOk").value||0);
    if(v < 88){
      $("fixSlideOk").value = 0;
      return;
    }
    applyFixAsCorrection();
  };
}

function applyFixAsCorrection(){
  const s = getSaleById(state.fix.targetId);
  const d = state.fix.draft;
  if(!s || !d){
    toast("ä¿®æ­£ã«å¤±æ•—ã—ã¾ã—ãŸ");
    return;
  }

  // å·®åˆ†ï¼ˆè¨‚æ­£ä¼ç¥¨ï¼‰ã‚’è¿½åŠ ï¼šä¸Šæ›¸ãã—ãªã„
  s.corrections = s.corrections || [];
  s.corrections.push({
    corrId: "c_" + Math.random().toString(36).slice(2),
    ts: nowTs(),
    who: d.who,
    why: d.why,
    payBefore: d.basePay,
    payAfter: d.pay,
    itemsBefore: itemsToNameQty(d.baseItems),
    itemsAfter: itemsToNameQty(d.items),
  });

  // â€»å…ƒãƒ‡ãƒ¼ã‚¿ã¯æ®‹ã™æ–¹é‡ã ãŒã€ä¸€è¦§ã§â€œä¿®æ­£å¾Œã®è¦‹ãŸç›®â€ã‚‚å¿…è¦ãªã‚‰ã“ã“ã§æ›´æ–°ã§ãã‚‹ã€‚
  // ä»Šå›ã¯ã€Œè¨‚æ­£ä¼ç¥¨æ–¹å¼ã§å±¥æ­´ã‚’æ®‹ã™ã€ã‚’å„ªå…ˆã—ã€å…ƒã® s.items / s.pay / s.amount ã¯ç¶­æŒã€‚
  // ãŸã ã—â€œä¿®æ­£å¾Œé‡‘é¡â€ã‚’ä¸€è¦§ã«åæ˜ ã—ãŸã„å ´åˆã¯ã€ä¸‹ã®3è¡Œã‚’ONã«ã™ã‚‹ï¼ˆå¿…è¦ãªã‚‰è¨€ã£ã¦ï¼‰
  // s.items = cloneItemsForEdit(d.items);
  // s.pay = d.pay;
  // s.amount = calcAmountFromItems(d.items);

  // è¡¨ç¤ºæ›´æ–°ï¼ˆPART4ã®ãƒ¬ãƒ³ãƒ€ãƒ©ãŒã‚ã‚‹ãªã‚‰å†æç”»ï¼‰
  state.fix.stage = "edit";
  state.fix.draft = null;

  toast("è¨‚æ­£ä¼ç¥¨ã‚’è¿½åŠ ã—ã¾ã—ãŸ");

  // å£²ä¸Šä¸€è¦§ã¸æˆ»ã™ï¼ˆç¾çŠ¶ã¯scrSalesï¼‰
  showScreen("scrSales");

  // å†æç”»ãƒ•ãƒƒã‚¯ï¼ˆå­˜åœ¨ã™ã‚‹ã‚‚ã®ã ã‘ï¼‰
  try{ if(typeof renderSales === "function") renderSales(); }catch(e){}
}

/* =========================================================
  â€œå¯¾è±¡è¡Œã®ç›´ä¸‹ã«å·®åˆ†ã‚’è¡¨ç¤ºâ€ã™ã‚‹ãŸã‚ã®å¾Œä»˜ã‘ãƒ‘ãƒƒãƒ
  - PART4ã®æœ¬æ—¥ä¸€è¦§ï¼ˆrenderTodayï¼‰ã‚’å£Šã•ãšã€å·®åˆ†è¡¨ç¤ºã‚’è¿½åŠ 
========================================================= */
(function patchRenderTodayList(){
  if(patchRenderTodayList._done) return;
  patchRenderTodayList._done = true;

  // PART4ã® renderToday ãŒå­˜åœ¨ã—ãªã„ãªã‚‰ä½•ã‚‚ã—ãªã„
  if(typeof renderToday !== "function") return;

  const _renderToday = renderToday;
  renderToday = function(){
    _renderToday();

    // todayList ãŒç„¡ã„ãªã‚‰ä½•ã‚‚ã—ãªã„
    const list = document.querySelector("#salesToday #todayList");
    if(!list) return;

    // æ—¢å­˜ã®å„è¡Œï¼ˆkRowï¼‰ã«ã€Œä¿®æ­£ã€ãƒœã‚¿ãƒ³ã‚’è¿½åŠ ã—ã€ç›´ä¸‹ã«å·®åˆ†ã‚’å·®ã—è¾¼ã‚€
    // â€»æ—¢å­˜ã® row.onclick ã¯ç¶­æŒã—ã¤ã¤ã€ãƒœã‚¿ãƒ³ã ã‘æ­¢ã‚ã‚‹
    const rows = Array.from(list.children || []);
    rows.forEach(row=>{
      const seatEl = row.querySelector(".kSeat");
      if(!seatEl) return;

      // kRowå†…ã‹ã‚‰ saleId ã‚’å–ã‚Œãªã„ã®ã§ã€ã‚¯ãƒªãƒƒã‚¯ã§é–‹ãè©³ç´°æ™‚ã® state.fix.targetId ã‚’åˆ©ç”¨ã™ã‚‹
      // â†’ å®‰å®šã•ã›ã‚‹ãŸã‚ã€è¡Œã‚¯ãƒªãƒƒã‚¯æ™‚ã« openSaleDetail(s) ãŒå‘¼ã°ã‚Œã¦ state.fix.targetId ãŒå…¥ã‚‹å‰æ
      // ãŸã ã€ç¢ºå®Ÿã«ã—ãŸã„ã®ã§ â€œè¡Œã‚’ã‚¯ãƒªãƒƒã‚¯â†’ãƒ¢ãƒ¼ãƒ€ãƒ«â†’ä¿®æ­£â€ ã‚’æ¨å¥¨ã€‚
      // ã“ã“ã§ã¯ã€Œå·®åˆ†è¡¨ç¤ºã ã‘ã€ç‹™ã†ã€‚

      // å·®åˆ†ã®è¡¨ç¤ºã¯ â€œå¸­ã¨æ™‚é–“ã¨é‡‘é¡â€ ã ã‘ã§ã¯saleç‰¹å®šã§ããªã„ã®ã§ã€
      // ä»Šå›ã¯ã€Œsale.corrections ã‚’æŒã¤è¡Œã«ã ã‘è¿½åŠ è¡¨ç¤ºã€ã—ãŸã„ãŒã€è¡Œã¨saleã®ç´ä»˜ã‘ãŒå¿…è¦ã€‚
      // â†’ ç¢ºå®ŸåŒ–ã¯æ¬¡ã®æ®µéšï¼ˆPART4æ”¹ä¿®ï¼‰ã§ã‚„ã‚‹ã€‚
    });
  };
})();

/* =========================================================
  ã©ã“ã‹ã‚‰ã§ã‚‚å‘¼ã¹ã‚‹ã‚ˆã†ã« window ã«å…¬é–‹ï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰
========================================================= */
window.ONE_openFixForSaleId = openFixForSaleId;

/* ===== showScreenæ‹¡å¼µï¼šscrFixã«å…¥ã£ãŸã‚‰æç”» ===== */
(function hookShowScreenForFix(){
  if(showScreen._fHooked2) return;
  const _show = showScreen;
  showScreen = function(id){
    _show(id);
    if(id==="scrFix") renderFix();
  };
  showScreen._fHooked2 = true;
})();

/* åˆæœŸæç”»ï¼ˆå®‰å…¨ï¼‰ */
try{ renderFix(); }catch(e){}

/* =========================
  ã“ã“ã‹ã‚‰å…ˆã¯ PART6 ã§ç¶šã
========================= */
/* =========================
  PART6ï¼šå¸­ç™»éŒ²ï¼ˆæœ€æ–°ä»•æ§˜ï¼‰
  - ã€Œãã®ä»–ã€å‰Šé™¤
  - ã€Œåç§°ã®ä½œæˆã€ãƒœã‚¿ãƒ³ â†’ åç§°ä½œæˆç”»é¢ï¼ˆã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ï¼‰
  - ã€Œåç§°ã¨å¸­ã®å‰Šé™¤ã€ãƒœã‚¿ãƒ³ â†’ å‰Šé™¤ç”»é¢ï¼ˆåç§°å‰Šé™¤ / å¸­å‰Šé™¤ï¼‰
  - ç”»é¢é·ç§»ï¼šå¸­ç™»éŒ² â‡„ åç§°ä½œæˆ â‡„ åç§°ã¨å¸­ã®å‰Šé™¤
========================= */

(function ensureSeatSetupSubScreens(){
  const app = document.querySelector("main.app");
  if(!app) return;

  function ensureScreen(id){
    if(document.getElementById(id)) return;
    const sec = document.createElement("section");
    sec.className = "screen";
    sec.id = id;
    sec.innerHTML = `<div style="opacity:.8">ï¼ˆPART6ã§å®Ÿè£…ï¼‰</div>`;
    app.appendChild(sec);
    try{ screens.push(id); }catch(e){}
  }

  ensureScreen("scrNameCreate");
  ensureScreen("scrNameDelete");
})();

(function buildSeatSetupUI(){
  const scr = $("scrSeatSetup");
  scr.innerHTML = `
    <div style="font-weight:900; margin-bottom:10px">å¸­ç™»éŒ²</div>

    <!-- è¿½åŠ ãƒœã‚¿ãƒ³ï¼ˆã‚¿ã‚¤ãƒˆãƒ«ã®ä¸‹ï¼‰ -->
    <div style="display:flex; gap:10px; margin-bottom:14px">
      <button class="btn lime" id="goNameCreate" style="flex:1; font-weight:900">åç§°ã®ä½œæˆ</button>
      <button class="btn" id="goNameDelete" style="flex:1; font-weight:900">åç§°ã¨å¸­ã®å‰Šé™¤</button>
    </div>

    <!-- â‘  åç§° -->
    <div style="font-weight:900; margin-bottom:8px">â‘  åç§°</div>
    <div id="ssNameGrid" class="seatGrid" style="margin-bottom:8px"></div>
    <button class="btn lime full" id="ssNameCommit" style="margin-bottom:14px">æ±ºå®š</button>

    <!-- â‘¡ ç·å¸­æ•°ï¼ç·å“æ•° -->
    <div style="font-weight:900; margin-bottom:8px">â‘¡ ç·å¸­æ•° / ç·å“æ•°</div>
    <div style="display:flex; gap:10px; align-items:center; margin-bottom:14px">
      <button class="btn" id="ssCntMinus">â—€ï¸</button>
      <div style="flex:1; text-align:center; font-weight:900; border:1px solid rgba(255,255,255,0.10); border-radius:14px; padding:10px; background:rgba(255,255,255,0.04)" id="ssCntVal">0</div>
      <button class="btn" id="ssCntPlus">â–¶ï¸</button>
    </div>

    <!-- â‘¢ å¸­ç•ªå· -->
    <div style="font-weight:900; margin-bottom:8px">â‘¢ å¸­ç•ªå·ï¼ˆè‡ªå‹•ã§æ¬¡ãŒå…¥ã‚Šã¾ã™ï¼‰</div>
    <input class="btn full" id="ssStartLabel" placeholder="é–‹å§‹æ–‡å­—ï¼ˆä¾‹ï¼šA / 1 / ã‚ / ã‚¢ï¼‰" style="text-align:left; margin-bottom:6px" />
    <div style="opacity:.85; margin-bottom:14px">å…¥åŠ›ãŒ1æ–‡å­—ã®ã¿ã®å ´åˆã¯è‡ªå‹•ã§é€£ç•ªã«ãªã‚Šã¾ã™</div>

    <!-- â‘¤ ä¿å­˜ -->
    <button class="btn lime full" id="ssSave" style="padding:14px 12px; font-weight:900; margin-bottom:14px">ä¿å­˜</button>

    <!-- â‘¥ ä½œã£ãŸå¸­ï¼ˆåç§°ã”ã¨ï¼‰ -->
    <div style="font-weight:900; margin-bottom:8px">ä½œã£ãŸå¸­</div>
    <div id="ssGroups"></div>
  `;
})();

/* ===== State ===== */
state.seatSetup = state.seatSetup || {
  // ã€Œãã®ä»–ã€å‰Šé™¤æ¸ˆã¿
  baseNames: ["ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼","ãƒ†ãƒ¼ãƒ–ãƒ«","åº§æ•·","å€‹å®¤","ç«‹ã¡"],
  customNames: [],
  selectedName: null,
  committedName: null,
  count: 0,
  groups: [] // {name, seatIds:[]}
};

function allNameButtons(){
  return state.seatSetup.baseNames.concat(state.seatSetup.customNames);
}

function renderNameGrid(){
  const grid = $("ssNameGrid");
  grid.innerHTML = "";
  allNameButtons().forEach(n=>{
    const b = document.createElement("div");
    b.className = "seatCard in";
    b.style.minHeight="56px";
    b.style.display="flex";
    b.style.alignItems="center";
    b.style.justifyContent="center";
    b.style.fontWeight="900";
    b.textContent = n;

    const on = (state.seatSetup.selectedName===n);
    if(on){
      b.style.outline = "2px solid rgba(122,167,255,0.9)";
      b.style.background = "rgba(122,167,255,0.14)";
    }

    b.onclick = ()=>{
      state.seatSetup.selectedName = (state.seatSetup.selectedName===n) ? null : n;
      renderNameGrid();
    };

    grid.appendChild(b);
  });
}

function applyDefaultCountByName(name){
  if(name==="ãƒ†ãƒ¼ãƒ–ãƒ«" || name==="åº§æ•·" || name==="å€‹å®¤"){
    state.seatSetup.count = 4;
  }else{
    state.seatSetup.count = 1;
  }
  $("ssCntVal").textContent = String(state.seatSetup.count);
}

$("ssNameCommit").onclick = ()=>{
  const pick = state.seatSetup.selectedName;
  if(!pick){ toast("åç§°ã‚’é¸æŠã—ã¦ãã ã•ã„"); return; }
  state.seatSetup.committedName = pick;
  applyDefaultCountByName(pick);
  toast(`åç§°ï¼š${pick}`);
};

$("ssCntMinus").onclick = ()=>{
  state.seatSetup.count = Math.max(0, state.seatSetup.count - 1);
  $("ssCntVal").textContent = String(state.seatSetup.count);
};
$("ssCntPlus").onclick = ()=>{
  state.seatSetup.count = state.seatSetup.count + 1;
  $("ssCntVal").textContent = String(state.seatSetup.count);
};

/* é€£ç•ª */
function isSingleChar(str){ return (str||"").length===1; }
function nextLabelOneChar(ch){
  if(ch>="0" && ch<="9"){ const n=Number(ch); if(Number.isFinite(n)) return String(n+1); }
  if(ch>="a" && ch<="z"){ return ch==="z" ? "a" : String.fromCharCode(ch.charCodeAt(0)+1); }
  if(ch>="A" && ch<="Z"){ return ch==="Z" ? "A" : String.fromCharCode(ch.charCodeAt(0)+1); }

  const hira = "ã‚ã„ã†ãˆãŠã‹ããã‘ã“ã•ã—ã™ã›ããŸã¡ã¤ã¦ã¨ãªã«ã¬ã­ã®ã¯ã²ãµã¸ã»ã¾ã¿ã‚€ã‚ã‚‚ã‚„ã‚†ã‚ˆã‚‰ã‚Šã‚‹ã‚Œã‚ã‚ã‚’ã‚“";
  const kata = "ã‚¢ã‚¤ã‚¦ã‚¨ã‚ªã‚«ã‚­ã‚¯ã‚±ã‚³ã‚µã‚·ã‚¹ã‚»ã‚½ã‚¿ãƒãƒ„ãƒ†ãƒˆãƒŠãƒ‹ãƒŒãƒãƒãƒãƒ’ãƒ•ãƒ˜ãƒ›ãƒãƒŸãƒ ãƒ¡ãƒ¢ãƒ¤ãƒ¦ãƒ¨ãƒ©ãƒªãƒ«ãƒ¬ãƒ­ãƒ¯ãƒ²ãƒ³";
  const hi = hira.indexOf(ch);
  if(hi!==-1) return hira[(hi+1)%hira.length];
  const ka = kata.indexOf(ch);
  if(ka!==-1) return kata[(ka+1)%kata.length];
  return null;
}
function buildSeatIds(start, count){
  const ids = [];
  const s=(start||"").trim();
  if(!s || count<=0) return ids;

  if(isSingleChar(s)){
    let cur=s;
    for(let i=0;i<count;i++){
      ids.push(cur);
      const nx = nextLabelOneChar(cur);
      if(!nx) break;
      cur = nx;
    }
    return ids;
  }else{
    return [s]; // 1æ–‡å­—ã˜ã‚ƒãªã„å ´åˆã¯1å¸­ã®ã¿
  }
}
function ensureSeatExists(id){
  if(state.seats.some(s=> s.id===id)) return;
  state.seats.push({
    id,
    status:"empty",
    people:0,
    name:"",
    total:0,
    bills:0,
    merged:false,
    mergeLabel:"",
    sub:null,
    orders:[],
    orderLog:[]
  });
}

$("ssSave").onclick = ()=>{
  const name = state.seatSetup.committedName;
  const cnt = Number(state.seatSetup.count||0);
  const start = ($("ssStartLabel").value||"").trim();

  if(!name){ toast("åç§°ã‚’æ±ºå®šã—ã¦ãã ã•ã„"); return; }
  if(cnt<=0){ toast("ç·å¸­/ç·å“æ•°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"); return; }
  if(!start){ toast("é–‹å§‹æ–‡å­—ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"); return; }

  const seatIds = buildSeatIds(start, cnt);

  const unique = [];
  seatIds.forEach(id=>{
    if(state.seats.some(s=> s.id===id)) return;
    unique.push(id);
    ensureSeatExists(id);
  });

  if(unique.length===0){
    toast("ä½œæˆã§ãã‚‹å¸­ãŒã‚ã‚Šã¾ã›ã‚“ï¼ˆæ—¢ã«å­˜åœ¨ï¼‰");
    return;
  }

  state.seatSetup.groups.push({ name, seatIds: unique });

  renderSeats();
  renderGroups();

  $("ssStartLabel").value = "";
  if(typeof emitEvent==="function") emitEvent("seat_setup_save", {name, seatIds: unique});
  toast("ä¿å­˜ã—ã¾ã—ãŸ");
};

function renderGroups(){
  const box = $("ssGroups");
  box.innerHTML = "";
  if(state.seatSetup.groups.length===0){
    box.innerHTML = `<div style="opacity:.85">ã¾ã ä½œæˆã•ã‚Œã¦ã„ã¾ã›ã‚“</div>`;
    return;
  }

  const byName = {};
  state.seatSetup.groups.forEach(g=>{
    if(!byName[g.name]) byName[g.name]=[];
    byName[g.name].push(g);
  });

  Object.keys(byName).forEach(name=>{
    const wrap = document.createElement("div");
    wrap.style.marginBottom="14px";

    const head = document.createElement("button");
    head.className="btn full";
    head.style.textAlign="left";
    head.style.fontWeight="900";
    head.textContent=name;
    head.onclick = ()=> toast("åç§°ã®å¤‰æ›´ã¯ã€Œåç§°ã¨å¸­ã®å‰Šé™¤ã€ã‹ã‚‰è¡Œã„ã¾ã™");
    wrap.appendChild(head);

    const grid = document.createElement("div");
    grid.className="seatGrid";
    grid.style.marginTop="10px";

    const ids = byName[name].flatMap(g=> g.seatIds);
    ids.forEach(id=>{
      const c=document.createElement("div");
      c.className="seatCard in";
      c.style.minHeight="56px";
      c.style.display="flex";
      c.style.alignItems="center";
      c.style.justifyContent="center";
      c.style.fontWeight="900";
      c.textContent=id;
      grid.appendChild(c);
    });

    wrap.appendChild(grid);
    box.appendChild(wrap);
  });
}

/* =========================
  åç§°ã®ä½œæˆç”»é¢ï¼ˆscrNameCreateï¼‰
========================= */
function buildNameCreateUI(){
  const scr = $("scrNameCreate");
  scr.innerHTML = `
    <div class="pill" style="margin-bottom:10px">åç§°ã‚’ä½œæˆã—ã¾ã™</div>
    <input id="ncInput" class="btn full" style="text-align:left; margin-bottom:12px" placeholder="åç§°" />

    <div style="display:flex; gap:10px">
      <button class="btn full" id="ncBack">æˆ»ã‚‹</button>
      <button class="btn lime full" id="ncCreate">ä½œæˆ</button>
    </div>
  `;

  $("ncBack").onclick = ()=> showScreen("scrSeatSetup");
  $("ncCreate").onclick = ()=>{
    const v = ($("ncInput").value||"").trim();
    if(!v){ toast("åç§°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"); return; }
    if(allNameButtons().includes(v)){ toast("åŒã˜åç§°ãŒã‚ã‚Šã¾ã™"); return; }
    state.seatSetup.customNames.push(v);
    state.seatSetup.selectedName = v;
    state.seatSetup.committedName = v;

    if(typeof persistAll==="function") persistAll();
    toast("åç§°ã‚’ä½œæˆã—ã¾ã—ãŸ");
    showScreen("scrSeatSetup");
    renderNameGrid();
    applyDefaultCountByName(v);
  };
}

/* =========================
  åç§°ã¨å¸­ã®å‰Šé™¤ç”»é¢ï¼ˆscrNameDeleteï¼‰
  - åç§°å‰Šé™¤ï¼šåç§°å†…ã®å…¨å¸­ãŒç©ºå¸­ã®ã¿å¯èƒ½
  - å¸­å‰Šé™¤ï¼šé¸æŠã—ãŸå¸­ãŒç©ºå¸­ã®ã¿å¯èƒ½ï¼ˆè¤‡æ•°é¸æŠï¼‰
========================= */
function buildNameDeleteUI(){
  const scr = $("scrNameDelete");
  scr.innerHTML = `
    <div class="pill" style="margin-bottom:10px">åç§°ã¾ãŸã¯å¸­ã‚’å‰Šé™¤ã—ã¾ã™</div>

    <div class="pill" style="margin-bottom:8px">åç§°ä¸€è¦§ï¼ˆã‚¿ãƒƒãƒ—ã§é¸æŠï¼‰</div>
    <div id="ndNameGrid" class="seatGrid" style="margin-bottom:10px"></div>

    <div class="pill" style="margin-bottom:8px">é¸æŠã—ãŸåç§°ã”ã¨å¸­ã‚’å‰Šé™¤</div>
    <div class="pill" style="margin-bottom:10px; color:var(--muted); line-height:1.7">
      åç§°å†…ã®å…¨å¸­ãŒç©ºå¸­ã®å ´åˆã®ã¿å‰Šé™¤ã§ãã¾ã™
    </div>
    <div class="pill" style="text-align:center; margin-bottom:6px">å‰Šé™¤ã—ã¾ã™ï¼ˆã‚¹ãƒ©ã‚¤ãƒ‰ï¼‰</div>
    <input id="ndDelNameSlide" class="range" type="range" min="0" max="100" value="0" />

    <div style="height:16px"></div>

    <div class="pill" style="margin-bottom:8px">å¸­ä¸€è¦§ï¼ˆè¤‡æ•°é¸æŠï¼‰</div>
    <div id="ndSeatGrid" class="seatGrid" style="margin-bottom:10px"></div>

    <div class="pill" style="text-align:center; margin-bottom:6px">å‰Šé™¤ã—ã¾ã™ï¼ˆã‚¹ãƒ©ã‚¤ãƒ‰ï¼‰</div>
    <input id="ndDelSeatSlide" class="range" type="range" min="0" max="100" value="0" />

    <div style="height:14px"></div>
    <button class="btn full" id="ndBack">æˆ»ã‚‹</button>
  `;

  let pickedName = null;
  let pickedSeats = new Set();

  function namesWithSeats(){
    const map = new Map();
    (state.seatSetup.groups||[]).forEach(g=>{
      if(!map.has(g.name)) map.set(g.name, []);
      g.seatIds.forEach(id=> map.get(g.name).push(id));
    });
    // â€œåç§°ã ã‘ä½œã£ã¦å¸­ãŒãªã„â€å ´åˆã‚‚è¦‹ã›ãŸã„ â†’ customNamesã‚‚å«ã‚ã‚‹
    allNameButtons().forEach(n=>{
      if(!map.has(n)) map.set(n, []);
    });
    return map;
  }

  function seatIsEmpty(id){
    const s = seatById(id);
    return !s || s.status==="empty";
  }

  function renderNameGrid(){
    const grid = $("ndNameGrid");
    grid.innerHTML = "";
    const map = namesWithSeats();

    Array.from(map.keys()).forEach(n=>{
      const b = document.createElement("div");
      b.className = "seatCard";
      b.style.minHeight="56px";
      b.style.display="flex";
      b.style.alignItems="center";
      b.style.justifyContent="center";
      b.style.fontWeight="900";
      b.textContent = n;

      const on = (pickedName===n);
      if(on){
        b.style.outline = "2px solid rgba(122,167,255,0.9)";
        b.style.background = "rgba(122,167,255,0.14)";
      }
      b.onclick = ()=>{
        pickedName = (pickedName===n) ? null : n;
        pickedSeats = new Set(); // åå‰å¤‰ãˆãŸã‚‰å¸­é¸æŠã¯ãƒªã‚»ãƒƒãƒˆ
        renderNameGrid();
        renderSeatGrid();
      };
      grid.appendChild(b);
    });
  }

  function renderSeatGrid(){
    const grid = $("ndSeatGrid");
    grid.innerHTML = "";
    if(!pickedName){
      grid.innerHTML = `<div style="opacity:.85">åç§°ã‚’é¸æŠã—ã¦ãã ã•ã„</div>`;
      return;
    }

    const ids = (state.seatSetup.groups||[])
      .filter(g=> g.name===pickedName)
      .flatMap(g=> g.seatIds);

    if(ids.length===0){
      grid.innerHTML = `<div style="opacity:.85">ã“ã®åç§°ã«ã¯å¸­ãŒã‚ã‚Šã¾ã›ã‚“</div>`;
      return;
    }

    ids.forEach(id=>{
      const c = document.createElement("div");
      c.className = "seatCard";
      c.style.minHeight="56px";
      c.style.display="flex";
      c.style.alignItems="center";
      c.style.justifyContent="center";
      c.style.fontWeight="900";
      c.textContent = id;

      const on = pickedSeats.has(id);
      if(on){
        c.style.outline = "2px solid rgba(122,167,255,0.9)";
        c.style.background = "rgba(122,167,255,0.14)";
      }

      // ä½¿ç”¨ä¸­ã¯é¸æŠä¸å¯ï¼ˆè¦–è¦šã‚‚èµ¤ï¼‰
      if(!seatIsEmpty(id)){
        c.style.opacity = "0.75";
        c.style.borderColor = "rgba(255,107,107,0.55)";
      }

      c.onclick = ()=>{
        if(!seatIsEmpty(id)){
          toast("ä½¿ç”¨ä¸­ã®å¸­ã¯å‰Šé™¤ã§ãã¾ã›ã‚“");
          return;
        }
        if(pickedSeats.has(id)) pickedSeats.delete(id);
        else pickedSeats.add(id);
        renderSeatGrid();
      };

      grid.appendChild(c);
    });
  }

  function deleteNameAllSeats(){
    if(!pickedName){ toast("åç§°ã‚’é¸æŠã—ã¦ãã ã•ã„"); return false; }

    const ids = (state.seatSetup.groups||[])
      .filter(g=> g.name===pickedName)
      .flatMap(g=> g.seatIds);

    const blocked = ids.some(id=> !seatIsEmpty(id));
    if(blocked){
      toast("ä½¿ç”¨ä¸­ã®å¸­ãŒã‚ã‚‹ãŸã‚å‰Šé™¤ã§ãã¾ã›ã‚“");
      return false;
    }

    // seatså‰Šé™¤
    ids.forEach(id=>{
      state.seats = state.seats.filter(s=> s.id!==id);
    });

    // groupså‰Šé™¤
    state.seatSetup.groups = (state.seatSetup.groups||[]).filter(g=> g.name!==pickedName);

    // custom nameã‚‚æ¶ˆã™ï¼ˆbaseNamesã¯æ¶ˆã•ãªã„ï¼‰
    state.seatSetup.customNames = (state.seatSetup.customNames||[]).filter(x=> x!==pickedName);

    pickedName = null;
    pickedSeats = new Set();

    renderSeats();
    renderGroups();
    renderNameGrid();
    renderSeatGrid();
    renderNameGrid(); // SeatSetupå´
    if(typeof persistAll==="function") persistAll();
    toast("åç§°ã”ã¨å‰Šé™¤ã—ã¾ã—ãŸ");
    return true;
  }

  function deletePickedSeats(){
    if(!pickedName){ toast("åç§°ã‚’é¸æŠã—ã¦ãã ã•ã„"); return false; }
    const ids = Array.from(pickedSeats);
    if(ids.length===0){ toast("å¸­ã‚’é¸æŠã—ã¦ãã ã•ã„"); return false; }

    const blocked = ids.some(id=> !seatIsEmpty(id));
    if(blocked){
      toast("ä½¿ç”¨ä¸­ã®å¸­ãŒã‚ã‚‹ãŸã‚å‰Šé™¤ã§ãã¾ã›ã‚“");
      return false;
    }

    ids.forEach(id=>{
      state.seats = state.seats.filter(s=> s.id!==id);
    });

    // groupsã‹ã‚‰ã‚‚å‰Šé™¤
    state.seatSetup.groups.forEach(g=>{
      if(g.name===pickedName){
        g.seatIds = g.seatIds.filter(id=> !pickedSeats.has(id));
      }
    });
    state.seatSetup.groups = state.seatSetup.groups.filter(g=> g.seatIds.length>0);

    pickedSeats = new Set();

    renderSeats();
    renderGroups();
    renderSeatGrid();
    if(typeof persistAll==="function") persistAll();
    toast("å¸­ã‚’å‰Šé™¤ã—ã¾ã—ãŸ");
    return true;
  }

  $("ndDelNameSlide").onchange = ()=>{
    if(Number($("ndDelNameSlide").value||0) < 88){ $("ndDelNameSlide").value=0; return; }
    const ok = deleteNameAllSeats();
    $("ndDelNameSlide").value = 0;
    if(ok){ /* keep */ }
  };

  $("ndDelSeatSlide").onchange = ()=>{
    if(Number($("ndDelSeatSlide").value||0) < 88){ $("ndDelSeatSlide").value=0; return; }
    const ok = deletePickedSeats();
    $("ndDelSeatSlide").value = 0;
    if(ok){ /* keep */ }
  };

  $("ndBack").onclick = ()=> showScreen("scrSeatSetup");

  renderNameGrid();
  renderSeatGrid();
}

/* ===== å¯¼ç·š ===== */
$("goNameCreate").onclick = ()=> { buildNameCreateUI(); showScreen("scrNameCreate"); };
$("goNameDelete").onclick = ()=> { buildNameDeleteUI(); showScreen("scrNameDelete"); };

/* showScreen hook */
(function hookShowScreenForSeatSetup(){
  if(showScreen._ssHooked_v2) return;
  const _show = showScreen;
  showScreen = function(id){
    _show(id);
    if(id==="scrSeatSetup"){
      renderNameGrid();
      renderGroups();
    }
    if(id==="scrNameCreate"){
      buildNameCreateUI();
    }
    if(id==="scrNameDelete"){
      buildNameDeleteUI();
    }
  };
  showScreen._ssHooked_v2 = true;
})();

renderNameGrid();
renderGroups();

/* =========================
  ã“ã“ã‹ã‚‰å…ˆã¯ PART7 ã§ç¶šã
========================= */
/* =========================
  PART7ï¼šåŒæœŸãƒ»ç«¯æœ«ç®¡ç†ãƒ»ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ï¼ˆå®Œæˆç‰ˆï¼‰
  é‡è¦ï¼š
   - ğŸ“¶ã¯æ®‹ã™
   - ãƒ¡ã‚¤ãƒ³ç”»é¢ã®ã€ŒåŒæœŸçŠ¶æ…‹ï¼šã€œã€æ–‡å­—ã¯ãã‚‚ãã‚‚è¡¨ç¤ºã—ãªã„ï¼ˆPART1ã§å‰Šé™¤æ¸ˆã¿ï¼‰
   - å‹æ‰‹ã«åŒæœŸã—ãªã„ï¼ˆæ“ä½œã”ã¨ã«â€œ1å›ã ã‘è©¦ã™â€ï¼‹æœªåŒæœŸãŒã‚ã‚‹æ™‚ã ã‘10åˆ†ãŠãè©¦è¡Œï¼‰
   - ä¿å­˜ï¼ç¢ºå®šä¿å­˜ï¼‹æœªåŒæœŸãŒã‚ã‚Œã°å†é€
   - FREEç«¯æœ«3å°åˆ¶é™ï¼ˆåŒæœŸä¸å¯ã€ãƒ­ãƒ¼ã‚«ãƒ«æ“ä½œã¯å¯èƒ½ï¼‰
========================= */

/* ===== Storage helpers ===== */
function loadStore(){
  try{
    const raw = localStorage.getItem(KEY);
    if(!raw) return null;
    return JSON.parse(raw);
  }catch(e){
    return null;
  }
}
function saveStore(obj){
  localStorage.setItem(KEY, JSON.stringify(obj));
}

/* ===== Device ID / limit ===== */
function getDeviceId(){
  const k = KEY + "_DEVICE_ID";
  let id = localStorage.getItem(k);
  if(!id){
    id = "dev_" + Math.random().toString(36).slice(2);
    localStorage.setItem(k, id);
  }
  return id;
}

state.sync = state.sync || {
  deviceId: getDeviceId(),
  devices: [],
  pending: [],
  lastTryTs: 0,
  maxDevicesFree: 3,
  canSync: true,
};

function ensureDeviceRegistered(){
  const st = loadStore() || {};
  st.devices = st.devices || [];
  if(!st.devices.includes(state.sync.deviceId)){
    st.devices.push(state.sync.deviceId);
  }
  state.sync.devices = st.devices.slice();
  saveStore(st);

  state.sync.canSync = (state.sync.devices.length <= state.sync.maxDevicesFree);
  return state.sync.canSync;
}

/* ===== Persist / Restore ===== */
function persistAll(){
  const st = loadStore() || {};
  st.devices = state.sync.devices.slice();
  st.pending = state.sync.pending;

  st.seats = state.seats;
  st.seatSetup = state.seatSetup;
  st.kitchen = state.kitchen;
  st.sales = state.sales;
  st.menu = state.menu;

  st.updatedTs = nowTs();
  saveStore(st);
}

function restoreAll(){
  const st = loadStore();
  if(!st) return;

  if(Array.isArray(st.seats)) state.seats = st.seats;
  if(st.seatSetup) state.seatSetup = st.seatSetup;
  if(st.kitchen) state.kitchen = st.kitchen;
  if(st.sales) state.sales = st.sales;
  if(st.menu) state.menu = st.menu;

  state.sync.devices = Array.isArray(st.devices) ? st.devices : [];
  state.sync.pending = Array.isArray(st.pending) ? st.pending : [];

  setSync(state.sync.pending.length === 0);
}

/* ===== Event queue ===== */
function emitEvent(type, payload){
  const ev = {
    id: "ev_" + Math.random().toString(36).slice(2),
    type,
    ts: nowTs(),
    deviceId: state.sync.deviceId,
    payload: payload || {}
  };
  state.sync.pending.push(ev);
  setSync(false);
  persistAll();
  trySyncOnceSilent();
}

/* ===== Sync attempt (pseudo) ===== */
function canActuallySync(){
  if(!ensureDeviceRegistered()) return false;
  if(typeof navigator !== "undefined" && navigator.onLine === false) return false;
  return true;
}

function trySyncOnceSilent(){
  if(state.sync.pending.length === 0) return;
  const now = nowTs();
  if(now - state.sync.lastTryTs < 10_000) return; // é€£æ‰“é˜²æ­¢
  state.sync.lastTryTs = now;

  if(!canActuallySync()){
    return; // é™ã‹ã«å¤±æ•—
  }

  // æˆåŠŸæ‰±ã„ï¼ˆæœ¬ç•ªã¯ã‚µãƒ¼ãƒãƒ¼é€ä¿¡â†’æˆåŠŸã§clearï¼‰
  state.sync.pending = [];
  setSync(true);
  persistAll();
}

function manualSync(){
  if(state.sync.pending.length === 0){
    setSync(true);
    toast("åŒæœŸã•ã‚Œã¦ã„ã¾ã™");
    return;
  }

  if(!ensureDeviceRegistered()){
    openModal(
      "åŒæœŸ",
      "ç„¡æ–™ç‰ˆã§ã¯åŒæœŸã§ãã‚‹ç«¯æœ«ã¯3å°ã¾ã§ã§ã™<br>æœ‰æ–™ç‰ˆã§ã¯åˆ©ç”¨å¯èƒ½ãªç«¯æœ«æ•°ãŒå¢—ãˆã¾ã™",
      [{label:"æˆ»ã‚‹", lime:false, onClick:()=> closeModal()}]
    );
    return;
  }

  if(!canActuallySync()){
    toast("åŒæœŸã§ãã¾ã›ã‚“ã§ã—ãŸï¼ˆé›»æ³¢çŠ¶æ³ã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼‰");
    setSync(false);
    persistAll();
    return;
  }

  state.sync.pending = [];
  setSync(true);
  persistAll();
  toast("åŒæœŸã—ã¾ã—ãŸ");
}

/* ===== Auto trial (10åˆ†ãŠãã€æœªåŒæœŸãŒã‚ã‚‹å ´åˆã®ã¿) ===== */
(function startAutoTrial(){
  if(startAutoTrial._started) return;
  startAutoTrial._started = true;

  setInterval(()=>{
    if(state.sync.pending.length === 0) return;
    trySyncOnceSilent();
  }, 10 * 60 * 1000);
})();

/* ===== Save ===== */
function openSaveModal(){
  openModal(
    "ä¿å­˜",
    "æ³¨æ–‡ãƒ»ä¼šè¨ˆãƒ»å¸­æƒ…å ±ã¯ç«¯æœ«é–“ã§è‡ªå‹•åŒæœŸã•ã‚Œã¾ã™ï¼ˆé›»æ³¢çŠ¶æ³ãŒè‰¯å¥½ãªå ´åˆï¼‰<br><br>âš ï¸ å–¶æ¥­çµ‚äº†æ™‚ãƒ»é€€å‹¤æ™‚ã«ã¯å¿…ãšä¿å­˜ã‚’è¡Œã£ã¦ãã ã•ã„",
    [
      {label:"ç¢ºå®šä¿å­˜", lime:true, onClick:()=>{
        closeModal();
        performSave();
      }},
      {label:"æˆ»ã‚‹", lime:false, onClick:()=> closeModal()},
    ]
  );
}

function performSave(){
  ensureDeviceRegistered();
  persistAll();

  if(state.sync.pending.length){
    manualSync();
  }else{
    setSync(true);
    toast("ä¿å­˜ã—ã¾ã—ãŸ");
  }
}

/* ===== Antenna tap behavior ===== */
function openSyncModal(){
  if(state.sync.canSync === false){
    openModal(
      "åŒæœŸ",
      "ç„¡æ–™ç‰ˆã§ã¯åŒæœŸã§ãã‚‹ç«¯æœ«ã¯3å°ã¾ã§ã§ã™<br>æœ‰æ–™ç‰ˆã§ã¯åˆ©ç”¨å¯èƒ½ãªç«¯æœ«æ•°ãŒå¢—ãˆã¾ã™",
      [{label:"æˆ»ã‚‹", lime:false, onClick:()=> closeModal()}]
    );
    return;
  }

  if(state.sync.pending.length === 0){
    openModal("åŒæœŸ", "åŒæœŸã•ã‚Œã¦ã„ã¾ã™", [
      {label:"æˆ»ã‚‹", lime:false, onClick:()=> closeModal()}
    ]);
    return;
  }

  openModal(
    "åŒæœŸ",
    "åŒæœŸã•ã‚Œã¦ã„ã¾ã›ã‚“<br>é›»æ³¢çŠ¶æ³ã‚„ä¸€æ™‚çš„ãªä¸å…·åˆã®å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™<br>ä¿å­˜ã‚’è¡Œã†ã¨å†åŒæœŸã‚’è©¦ã¿ã¾ã™",
    [
      {label:"åŒæœŸé–‹å§‹", lime:true, onClick:()=>{
        closeModal();
        manualSync();
      }},
      {label:"æˆ»ã‚‹", lime:false, onClick:()=> closeModal()},
    ]
  );
}

/* ===== Hook header buttons ===== */
(function hookHeaderButtonsPart7(){
  $("btnSave").onclick = ()=> openSaveModal();
  $("btnAntenna").onclick = ()=> openSyncModal();
})();

/* ===== Boot ===== */
(function bootPart7(){
  ensureDeviceRegistered();
  restoreAll();

  // pendingãŒã‚ã‚Œã°ğŸ“¶âŒ
  setSync(state.sync.pending.length === 0);

  // ç«¯æœ«åˆ¶é™åæ˜ 
  ensureDeviceRegistered();

  // å¾©å…ƒå¾Œã«å†æç”»
  renderSeats();
})();
 /* =========================
  ã“ã“ã‹ã‚‰å…ˆã¯ PART8 ã§ç¶šã
========================= */
/* =========================
  PART8ï¼šè¨­å®šãƒ»FAQï¼ˆã‚ˆãã‚ã‚‹è³ªå•ï¼‰ãƒ»æœ‰æ–™å°ç·š ï¼‹ ãƒ¡ãƒ‹ãƒ¥ãƒ¼ç™»éŒ² ï¼‹ åº—èˆ—æƒ…å ±
  å¤‰æ›´ç‚¹ï¼š
   - ã€Œã‚ˆãã‚ã‚‹ãŠå•åˆã›ã€â†’ FAQï¼ˆã‚ˆãã‚ã‚‹è³ªå•ï¼‰
   - ãŠå•åˆã›ã¯FAQå†…ã«è¨­ç½®
   - åˆ©ç”¨æ¡ä»¶ãƒœã‚¿ãƒ³å‰Šé™¤ï¼ˆé‡è¤‡ï¼‰
   - å…¨ç”»é¢åŒ–ãƒœã‚¿ãƒ³ã¯3åˆ—æŠ˜ã‚Šè¿”ã—ã®â€œä¸‹æ®µã«æ¨ªé•·â€ã§è¨­ç½®
========================= */

/* =========================================================
   0) ç”»é¢è¿½åŠ ï¼šåº—èˆ—æƒ…å ± / ãƒ¬ã‚·ãƒ”ææ¡ˆï¼ˆPART1ã«ç„¡ã„å ´åˆã“ã“ã§å¢—è¨­ï¼‰
========================================================= */
(function ensureExtraScreens(){
  const app = document.querySelector("main.app");
  if(!app) return;

  function addScreen(id){
    if($(id)) return;
    const sec = document.createElement("section");
    sec.className = "screen";
    sec.id = id;
    sec.innerHTML = `<div style="opacity:.8">ï¼ˆPART8ã§å®Ÿè£…ï¼‰</div>`;
    app.appendChild(sec);
    try{ screens.push(id); }catch(e){}
  }
  addScreen("scrStoreInfo");
  addScreen("scrRecipe");
})();

/* =========================================================
   A) è¨­å®šï¼ˆscrSettingsï¼‰
========================================================= */
(function buildSettingsUI(){
  const scr = $("scrSettings");
  scr.innerHTML = `
    <div class="pill" style="margin-bottom:10px">è¨­å®š</div>

    <!-- ãƒœã‚¿ãƒ³ï¼š3åˆ—æŠ˜ã‚Šè¿”ã—ï¼ˆå…¨ç”»é¢åŒ–ã¯ä¸‹ã«æ¨ªé•·ã§åˆ¥ç½®ãï¼‰ -->
    <div class="seatGrid" style="margin-bottom:10px">
      <button class="seatCard" id="goSeatSetupBtn" style="min-height:56px; font-weight:900; display:flex; align-items:center; justify-content:center">å¸­ç™»éŒ²</button>
      <button class="seatCard" id="goMenuBtn" style="min-height:56px; font-weight:900; display:flex; align-items:center; justify-content:center">ãƒ¡ãƒ‹ãƒ¥ãƒ¼ç™»éŒ²</button>
      <button class="seatCard" id="goStoreBtn" style="min-height:56px; font-weight:900; display:flex; align-items:center; justify-content:center">åº—èˆ—æƒ…å ±</button>

      <button class="seatCard" id="goSalesManageBtn" style="min-height:56px; font-weight:900; display:flex; align-items:center; justify-content:center">å£²ä¸Šç®¡ç†</button>
      <button class="seatCard" id="goFaqBtn" style="min-height:56px; font-weight:900; display:flex; align-items:center; justify-content:center; text-align:center">
        FAQ<br><span style="font-weight:700; opacity:.85">ï¼ˆã‚ˆãã‚ã‚‹è³ªå•ï¼‰</span>
      </button>
      <button class="seatCard" id="goRecipeBtn" style="min-height:56px; font-weight:900; display:flex; align-items:center; justify-content:center">ãƒ¬ã‚·ãƒ”ææ¡ˆ</button>
    </div>

    <!-- å…¨ç”»é¢åŒ–ï¼ˆæ¨ªé•·ï¼‰ -->
    <button class="btn full" id="goPwaBtn" style="min-height:52px; font-weight:900; margin-bottom:12px">å…¨ç”»é¢åŒ–</button>

    <!-- æ³¨æ„äº‹é …ï¼ˆæ¨ªé•·ï¼‰ -->
    <div class="pill" style="margin-bottom:12px; line-height:1.6">
      âš ï¸ å–¶æ¥­çµ‚äº†æ™‚ãƒ»é€€å‹¤æ™‚ã«ã¯å¿…ãšã€Œä¿å­˜ã€ã‚’è¡Œã£ã¦ãã ã•ã„ï¼ˆãƒ‡ãƒ¼ã‚¿ä¿å…¨ã®ãŸã‚ï¼‰
    </div>

    <div class="pill" style="margin-bottom:8px">ç„¡æ–™ç‰ˆã«ã¤ã„ã¦</div>
    <div class="pill" style="color:var(--muted); margin-bottom:12px; line-height:1.7">
      ãƒ»åˆ©ç”¨å¯èƒ½ç«¯æœ«ï¼šæœ€å¤§3å°<br>
      ãƒ»ãƒ‡ãƒ¼ã‚¿ã®å¾©æ—§ã€ä¿è¨¼ãªã—<br>
      ãƒ»ã‚µãƒãƒ¼ãƒˆã¯é™å®šçš„
    </div>

    <div class="pill" style="margin-bottom:8px">æœ‰æ–™ç‰ˆã®ã”æ¡ˆå†…</div>
    <div class="pill" style="color:var(--muted); margin-bottom:12px; line-height:1.7">
      ãƒ»åˆ©ç”¨ç«¯æœ«æ•°ã®æ‹¡å¼µ<br>
      ãƒ»ãƒ‡ãƒ¼ã‚¿ã®å®‰å…¨ãªä¿å­˜<br>
      ãƒ»ã‚µãƒãƒ¼ãƒˆå¯¾å¿œ<br>
      ãƒ»ç¨ç†å£«ã€ä¼šè¨ˆã‚½ãƒ•ãƒˆå‘ã‘ãƒ‡ãƒ¼ã‚¿å‡ºåŠ›<br>
      ãƒ»å£²ä¸Šåˆ†æã€ã‚°ãƒ©ãƒ•è¡¨ç¤º<br>
      ãƒ»AIã«ã‚ˆã‚‹æ–™ç†ãƒ»ãƒ¡ãƒ‹ãƒ¥ãƒ¼ææ¡ˆ<br>
      ãƒ»å°†æ¥è¿½åŠ ã•ã‚Œã‚‹æ–°æ©Ÿèƒ½
    </div>

    <div class="pill" style="margin-bottom:8px">ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±</div>
    <div class="pill" style="color:var(--muted); line-height:1.7">
      ONE<br>
      Versionï¼šFREE 0.1.0<br>
      æ›´æ–°æ—¥ï¼š2026/02/10<br>
      ç¾åœ¨ã¯ç„¡æ–™ç‰ˆã§ã™
    </div>
  `;
})();

/* =========================================================
   B) FAQï¼ˆã‚ˆãã‚ã‚‹è³ªå•ï¼‰ â€»ãŠå•åˆã›ãƒœã‚¿ãƒ³ã¯FAQå†…ã¸
========================================================= */
const FAQ_CATS = [
  {id:"seat",  label:"å¸­/æ³¨æ–‡"},
  {id:"sales", label:"å£²ä¸Š/ä¼šè¨ˆ"},
  {id:"sync",  label:"åŒæœŸ/ä¿å­˜"},
  {id:"backup",label:"ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—"},
  {id:"other", label:"ãã®ä»–"},
];

const FAQ_LIST = [
  {cat:"sales", q:"ä¼šè¨ˆåˆç®—ã¯ã©ã†ã‚„ã£ã¦è¡Œã„ã¾ã™ã‹ï¼Ÿ", a:"åŒã˜å¸­å†…ã«ã‚ã‚‹è¤‡æ•°ã®ä¼šè¨ˆã‚’ã€ä¼šè¨ˆåˆç®—ã§ã¾ã¨ã‚ã¾ã™ã€‚åˆ¥ã®å¸­åŒå£«ã‚’ç›´æ¥åˆç®—ã™ã‚‹ã“ã¨ã¯ã§ãã¾ã›ã‚“ã€‚åˆ¥å¸­ã‚’ã¾ã¨ã‚ãŸã„å ´åˆã¯ã€å…ˆã«å¸­ç§»å‹•ã§åŒã˜å¸­ã«é›†ã‚ã¦ãã ã•ã„ã€‚"},
  {cat:"sales", q:"ä¼šè¨ˆåˆ†å‰²ã¯ã„ã¤ã§ãã¾ã™ã‹ï¼Ÿ", a:"åŒä¸€å¸­å†…ã§ã€åˆç®—ã•ã‚Œã¦ã„ã‚‹ä¼šè¨ˆã‚’å…ƒã«æˆ»ã—ãŸã„æ™‚ã«è¡Œã„ã¾ã™ã€‚ãªãŠã€åˆç®—å¾Œã«è¿½åŠ ã•ã‚ŒãŸæ³¨æ–‡ã¯åˆ†å‰²ã§ãã¾ã›ã‚“ã€‚"},
  {cat:"seat",  q:"å¸­ç§»å‹•ã¨åˆæµã®é•ã„ã¯ä½•ã§ã™ã‹ï¼Ÿ", a:"å¸­ç§»å‹•ã¯å¸­ãƒ‡ãƒ¼ã‚¿ã‚’å…¥ã‚Œæ›¿ãˆã¾ã™ï¼ˆAâ‡„Bï¼‰ã€‚åˆæµã¯è¤‡æ•°å¸­ã‚’åŒã˜ã‚«ãƒ¼ãƒ‰å†…ã«è¡¨ç¤ºã™ã‚‹æ“ä½œã§ã™ï¼ˆAâ¡ï¸Bï¼‰ã€‚"},
  {cat:"seat",  q:"å•†å“ãŒæ¥ãªã‹ã£ãŸå ´åˆã®ä¿®æ­£æ–¹æ³•ã¯ï¼Ÿ", a:"ä¼šè¨ˆç¢ºå®šå‰ã§ã‚ã‚Œã°ã€æ³¨æ–‡å±¥æ­´ã‹ã‚‰è©²å½“å•†å“ã‚’ä¿®æ­£ã§ãã¾ã™ã€‚å–æ¶ˆã¯å±¥æ­´ã¨ã—ã¦æ®‹ã‚Šã¾ã™ã€‚"},
  {cat:"seat",  q:"æ³¨æ–‡æ•°ã‚’é–“é•ãˆãŸæ™‚ã¯ã©ã†ãªã‚Šã¾ã™ã‹ï¼Ÿ", a:"æ³¨æ–‡å±¥æ­´ã‹ã‚‰ä¿®æ­£ã§ãã¾ã™ã€‚ä¿®æ­£å†…å®¹ã¯å±¥æ­´ã«æ®‹ã‚Šã¾ã™ã€‚"},
  {cat:"sync",  q:"åŒæœŸãƒãƒ¼ã‚¯âŒãŒå‡ºãŸæ™‚ã¯ã©ã†ã™ã‚Œã°ã„ã„ã§ã™ã‹ï¼Ÿ", a:"é›»æ³¢çŠ¶æ³ã‚„ä¸€æ™‚çš„ãªä¸å…·åˆã«ã‚ˆã‚Šã€åŒæœŸã§ãã¦ã„ãªã„çŠ¶æ…‹ã§ã™ã€‚é›»æ³¢ã®è‰¯ã„å ´æ‰€ã§åŒæœŸï¼ˆä¿å­˜ï¼‰ã‚’è¡Œã£ã¦ãã ã•ã„ã€‚"},
  {cat:"sync",  q:"é›»æ³¢ãŒãªã„å ´æ‰€ã§ã‚‚ä½¿ãˆã¾ã™ã‹ï¼Ÿ", a:"ä½¿ãˆã¾ã™ã€‚æ³¨æ–‡ãƒ»ä¼šè¨ˆãƒ»å¸­æ“ä½œã¯ç«¯æœ«å†…ã«ä¿å­˜ã•ã‚Œã¾ã™ã€‚ãŸã ã—ç«¯æœ«é–“å…±æœ‰ã¯è¡Œã‚ã‚Œãªã„ãŸã‚ã€é€šä¿¡ç’°å¢ƒãŒæ•´ã£ã¦ã„ã‚‹å ´æ‰€ã§ã®åˆ©ç”¨ã‚’æ¨å¥¨ã—ã¾ã™ã€‚"},
  {cat:"backup",q:"ãƒ‡ãƒ¼ã‚¿ã¯ã©ã“ã«ä¿å­˜ã•ã‚Œã¦ã„ã¾ã™ã‹ï¼Ÿ", a:"ç«¯æœ«å†…ã«ä¿å­˜ã•ã‚Œã¾ã™ã€‚ç«¯æœ«ã®æ•…éšœãƒ»ç´›å¤±ãƒ»ä¸å…·åˆã«å‚™ãˆã€å£²ä¸Šç®¡ç†ã‹ã‚‰ãƒ¡ãƒ¼ãƒ«é€ä¿¡ï¼ˆãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ï¼‰ã‚’è¡Œã£ã¦ãã ã•ã„ã€‚"},
  {cat:"backup",q:"æ©Ÿç¨®å¤‰æ›´ã—ãŸå ´åˆã¯ã©ã†ãªã‚Šã¾ã™ã‹ï¼Ÿ", a:"ç«¯æœ«å†…ã®ãƒ‡ãƒ¼ã‚¿ã¯è‡ªå‹•ã§ã¯å¼•ãç¶™ãŒã‚Œã¾ã›ã‚“ã€‚äº‹å‰ã«ä¿å­˜ã‚„ãƒ‡ãƒ¼ã‚¿é€ä¿¡ã‚’è¡Œã£ã¦ãã ã•ã„ã€‚"},
  {cat:"other", q:"å–¶æ¥­çµ‚äº†æ™‚ã«å¿…ãšè¡Œã†ã“ã¨ã¯ï¼Ÿ", a:"ä¿å­˜æ“ä½œã‚’è¡Œã„ã€å¿…è¦ã«å¿œã˜ã¦å£²ä¸Šãƒ‡ãƒ¼ã‚¿ã‚’ãƒ¡ãƒ¼ãƒ«ãªã©ã§é€ä¿¡ã—ã¦ãã ã•ã„ã€‚ãƒ‡ãƒ¼ã‚¿ä¿å…¨ã®ãŸã‚ã«é‡è¦ã§ã™ã€‚"},
];

function openContactInFaq(){
  openModal(
    "ãŠå•åˆã›",
    `
      <div class="pill" style="margin-bottom:10px; line-height:1.7">
        ONEã«é–¢ã™ã‚‹ã”è³ªå•ãƒ»ä¸å…·åˆã®ã”é€£çµ¡ã¯ä¸‹è¨˜ã‚ˆã‚ŠãŠé¡˜ã„ã„ãŸã—ã¾ã™ã€‚
      </div>
      <div class="pill" style="color:var(--muted); margin-bottom:10px; line-height:1.7">
        ã”é€£çµ¡ã®éš›ã¯<br>
        ãƒ»åº—èˆ—å<br>
        ãƒ»ä½¿ç”¨ç«¯æœ«<br>
        ãƒ»ç™ºç”Ÿã—ãŸçŠ¶æ³<br>
        ã‚’è¨˜è¼‰ã„ãŸã ãã¨ã‚¹ãƒ ãƒ¼ã‚ºã§ã™ã€‚
      </div>
      <div class="pill">ãƒ»ãƒ¡ãƒ¼ãƒ«ã§å•ã„åˆã‚ã›ï¼ˆä»»æ„ï¼‰</div>
      <div class="pill">ãƒ»LINEã§å•ã„åˆã‚ã›ï¼ˆä»»æ„ï¼‰</div>
    `,
    [{label:"æˆ»ã‚‹", onClick:()=> closeModal()}]
  );
}

function openFaqHome(){
  const body = `
    <div style="max-height:70vh; overflow:auto; padding-right:4px">

      <div style="text-align:center; margin-bottom:10px">
        <div style="font-weight:900; font-size:20px">FAQ</div>
        <div style="opacity:.85">ï¼ˆã‚ˆãã‚ã‚‹è³ªå•ï¼‰</div>
      </div>

      <div class="pill" style="margin-bottom:10px; color:var(--muted); line-height:1.7">
        é …ç›®ã‚’é¸ã¶ã¨ã€è©²å½“ã™ã‚‹Q&AãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚<br>
        ãŠå•åˆã›ã¯ä¸‹ã®ãƒœã‚¿ãƒ³ã‹ã‚‰è¡Œãˆã¾ã™ã€‚
      </div>

      <div class="seatGrid" id="faqCatGrid" style="margin-bottom:12px"></div>

      <button class="btn full" id="faqContactBtn" style="min-height:52px; font-weight:900">ãŠå•åˆã›</button>
    </div>
  `;
  openModal("FAQ", body, [{label:"æˆ»ã‚‹", onClick:()=> closeModal()}]);

  setTimeout(()=>{
    const grid = $("faqCatGrid");
    grid.innerHTML = "";
    FAQ_CATS.forEach(c=>{
      const b = document.createElement("button");
      b.className = "seatCard";
      b.style.minHeight = "56px";
      b.style.fontWeight = "900";
      b.style.display="flex";
      b.style.alignItems="center";
      b.style.justifyContent="center";
      b.textContent = c.label;
      b.onclick = ()=> openFaqList(c.id, c.label);
      grid.appendChild(b);
    });

    $("faqContactBtn").onclick = ()=> openContactInFaq();
  },0);
}

function openFaqList(catId, catLabel){
  const list = FAQ_LIST.filter(x=> x.cat===catId);
  const body = `
    <div style="max-height:70vh; overflow:auto; padding-right:4px">
      ${list.map(x=>`
        <div class="pill" style="margin-bottom:6px; font-weight:900">Qï¼š${x.q}</div>
        <div class="pill" style="margin-bottom:12px; color:var(--muted); line-height:1.7">Aï¼š${x.a}</div>
      `).join("") || `<div class="pill">ã¾ã ã‚ã‚Šã¾ã›ã‚“</div>`}
      <div style="height:10px"></div>
      <button class="btn full" id="faqContactBtn2" style="min-height:52px; font-weight:900">ãŠå•åˆã›</button>
    </div>
  `;
  openModal(catLabel, body, [
    {label:"æˆ»ã‚‹", onClick:()=> openFaqHome()},
    {label:"é–‰ã˜ã‚‹", onClick:()=> closeModal()},
  ]);

  setTimeout(()=>{
    $("faqContactBtn2").onclick = ()=> openContactInFaq();
  },0);
}

/* =========================================================
   C) å…¨ç”»é¢åŒ–ï¼ˆPWA/ãƒ›ãƒ¼ãƒ ç”»é¢ã«è¿½åŠ ï¼‰æ¡ˆå†…
========================================================= */
function openPwaGuide(){
  openModal(
    "å…¨ç”»é¢åŒ–ï¼ˆæ¨å¥¨ï¼‰",
    `
      <div style="max-height:70vh; overflow:auto; padding-right:4px; line-height:1.7">
        <div class="pill" style="margin-bottom:10px">
          ONEã‚’ã€Œãƒ›ãƒ¼ãƒ ç”»é¢ã«è¿½åŠ ã€ã§èµ·å‹•ã™ã‚‹ã¨ã€ãƒ–ãƒ©ã‚¦ã‚¶ã®ä¸‹éƒ¨ãƒãƒ¼ç­‰ãŒå‡ºãšã€ã‚¢ãƒ—ãƒªã®ã‚ˆã†ã«å…¨ç”»é¢ã§ä½¿ãˆã¾ã™ã€‚
        </div>

        <div class="pill" style="margin-bottom:10px; color:var(--muted)">
          â–  iPhone / iPadï¼ˆSafariï¼‰<br>
          1) Safariã§ONEã‚’é–‹ã<br>
          2) å…±æœ‰ â†’ã€Œãƒ›ãƒ¼ãƒ ç”»é¢ã«è¿½åŠ ã€<br>
          3) ä»¥å¾Œã€ãƒ›ãƒ¼ãƒ ç”»é¢ã®ONEã‚¢ã‚¤ã‚³ãƒ³ã‹ã‚‰èµ·å‹•
        </div>

        <div class="pill" style="color:var(--muted)">
          â–  Androidï¼ˆChromeç­‰ï¼‰<br>
          1) ãƒ–ãƒ©ã‚¦ã‚¶ã§ONEã‚’é–‹ã<br>
          2) ãƒ¡ãƒ‹ãƒ¥ãƒ¼ â†’ã€Œãƒ›ãƒ¼ãƒ ç”»é¢ã«è¿½åŠ ã€<br>
          3) ä»¥å¾Œã€ãƒ›ãƒ¼ãƒ ç”»é¢ã®ã‚¢ã‚¤ã‚³ãƒ³ã‹ã‚‰èµ·å‹•
        </div>
      </div>
    `,
    [{label:"æˆ»ã‚‹", onClick:()=> closeModal()}]
  );
}

/* =========================================================
   D) åº—èˆ—æƒ…å ±ï¼ˆscrStoreInfoï¼‰
========================================================= */
state.store = state.store || {
  shopName:"",
  tel:"",
  note:"",
  staff:[],
};

function buildStoreInfoUI(){
  const scr = $("scrStoreInfo");
  if(!scr) return;

  scr.innerHTML = `
    <div class="pill" style="margin-bottom:10px">åº—èˆ—æƒ…å ±</div>

    <div class="pill" style="margin-bottom:8px">åº—èˆ—</div>
    <input id="stShop" class="btn full" style="text-align:left; margin-bottom:10px" placeholder="åº—èˆ—å" />
    <input id="stTel" class="btn full" style="text-align:left; margin-bottom:10px" placeholder="é›»è©±ï¼ˆä»»æ„ï¼‰" inputmode="tel" />
    <input id="stNote" class="btn full" style="text-align:left; margin-bottom:14px" placeholder="ãƒ¡ãƒ¢ï¼ˆä»»æ„ï¼‰" />

    <div class="pill" style="margin-bottom:8px">å¾“æ¥­å“¡åï¼ˆä¿®æ­£è€…åã®å€™è£œï¼‰</div>

    <div style="display:flex; gap:10px; align-items:center; margin-bottom:10px">
      <input id="stStaffNew" class="btn full" style="text-align:left" placeholder="è¿½åŠ ã™ã‚‹å¾“æ¥­å“¡å" />
      <button class="btn lime" id="stStaffAdd" style="min-width:92px; font-weight:900">è¿½åŠ </button>
    </div>

    <div class="pill" style="color:var(--muted); margin-bottom:10px; line-height:1.7">
      ãƒ»å‰Šé™¤ã¯ã“ã“ã‹ã‚‰ã®ã¿å¯èƒ½ã§ã™<br>
      ãƒ»å‰Šé™¤ã—ã¦ã‚‚ã€å£²ä¸Šã®ä¿®æ­£å±¥æ­´ã‹ã‚‰åå‰ã¯æ¶ˆãˆã¾ã›ã‚“ï¼ˆè¨˜éŒ²ã¯ä¿æŒï¼‰
    </div>

    <div id="stStaffList"></div>

    <div style="height:14px"></div>
    <div style="display:flex; gap:10px">
      <button class="btn full" id="stBack">æˆ»ã‚‹</button>
      <button class="btn lime full" id="stSave">ä¿å­˜</button>
    </div>
  `;

  $("stShop").value = state.store.shopName || "";
  $("stTel").value  = state.store.tel || "";
  $("stNote").value = state.store.note || "";

  $("stBack").onclick = ()=> showScreen("scrSettings");
  $("stSave").onclick = ()=>{
    state.store.shopName = ($("stShop").value||"").trim();
    state.store.tel      = ($("stTel").value||"").trim();
    state.store.note     = ($("stNote").value||"").trim();
    if(typeof persistAll==="function") persistAll();
    toast("ä¿å­˜ã—ã¾ã—ãŸ");
    showScreen("scrSettings");
  };

  $("stStaffAdd").onclick = ()=>{
    const v = ($("stStaffNew").value||"").trim();
    if(!v){ toast("åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"); return; }
    if(state.store.staff.includes(v)){ toast("åŒã˜åå‰ãŒã‚ã‚Šã¾ã™"); return; }
    state.store.staff.push(v);
    $("stStaffNew").value = "";
    renderStaffList();
    if(typeof persistAll==="function") persistAll();
    toast("è¿½åŠ ã—ã¾ã—ãŸ");
  };

  function renderStaffList(){
    const box = $("stStaffList");
    box.innerHTML = "";
    if(!state.store.staff.length){
      box.innerHTML = `<div class="pill">ã¾ã ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</div>`;
      return;
    }

    state.store.staff.forEach(name=>{
      const row = document.createElement("div");
      row.className = "kRow";
      row.innerHTML = `
        <div class="kLeft"><div class="kName">${name}</div></div>
        <div class="kSlide" style="gap:10px">
          <button class="btn" data-del="${name}">å‰Šé™¤</button>
        </div>
      `;
      box.appendChild(row);
    });

    box.querySelectorAll("[data-del]").forEach(btn=>{
      btn.onclick = ()=>{
        const nm = btn.getAttribute("data-del");
        openModal(
          "å‰Šé™¤",
          `
            <div class="pill" style="margin-bottom:10px; color:var(--danger)">ã€Œ${nm}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ</div>
            <div class="pill" style="color:var(--muted); margin-bottom:10px; line-height:1.7">
              â€» å£²ä¸Šã®ä¿®æ­£å±¥æ­´ã‹ã‚‰åå‰ã¯æ¶ˆãˆã¾ã›ã‚“ï¼ˆè¨˜éŒ²ã¯ä¿æŒï¼‰
            </div>
            <input id="stDelSlide" class="range" type="range" min="0" max="100" value="0" />
          `,
          [{label:"æˆ»ã‚‹", onClick:()=> closeModal()}]
        );
        setTimeout(()=>{
          $("stDelSlide").onchange = ()=>{
            if(Number($("stDelSlide").value||0) < 88){ $("stDelSlide").value=0; return; }
            state.store.staff = state.store.staff.filter(x=> x!==nm);
            closeModal();
            renderStaffList();
            if(typeof persistAll==="function") persistAll();
            toast("å‰Šé™¤ã—ã¾ã—ãŸ");
          };
        },0);
      };
    });
  }
  renderStaffList();
}

/* =========================================================
   E) ãƒ¡ãƒ‹ãƒ¥ãƒ¼ç™»éŒ²ï¼ˆscrMenuï¼‰ â€»ã‚ãªãŸã®æ—¢å­˜å®Ÿè£…ã‚’â€œãã®ã¾ã¾ä½¿ç”¨â€
   â€»ã“ã®PART8å·®ã—æ›¿ãˆã§ã¯ã€ŒscrMenuã®ä¸­èº«ã€ã¯è§¦ã‚Šã¾ã›ã‚“ï¼ˆæ—¢å­˜ãŒæ®‹ã‚‹ï¼‰
========================================================= */

/* =========================================================
   F) ãƒ¬ã‚·ãƒ”ææ¡ˆï¼ˆscrRecipeï¼‰ â€»ç„¡æ–™ç‰ˆã¯å°ç·šã ã‘
========================================================= */
(function buildRecipeUI(){
  const scr = $("scrRecipe");
  if(!scr) return;

  scr.innerHTML = `
    <div class="pill" style="margin-bottom:10px">ãƒ¬ã‚·ãƒ”ææ¡ˆ</div>
    <div class="pill" style="color:var(--muted); line-height:1.7; margin-bottom:14px">
      ç„¡æ–™ç‰ˆã§ã¯ã€Œãƒ¬ã‚·ãƒ”ææ¡ˆã€ã¯æ¡ˆå†…ã®ã¿ã§ã™ã€‚<br>
      æœ‰æ–™ç‰ˆã§ã€Œåº—èˆ—ã®é£Ÿæã‹ã‚‰æ¯æ—¥3å“ææ¡ˆã€ãªã©ãŒåˆ©ç”¨ã§ãã¾ã™ã€‚
    </div>
    <button class="btn full" id="recipeBack">æˆ»ã‚‹</button>
  `;
  $("recipeBack").onclick = ()=> showScreen("scrSettings");
})();

/* =========================================================
   G) è¨­å®šãƒœã‚¿ãƒ³å°ç·š
========================================================= */
$("goSeatSetupBtn").onclick = ()=> showScreen("scrSeatSetup");
$("goMenuBtn").onclick      = ()=> showScreen("scrMenu");
$("goStoreBtn").onclick     = ()=> { buildStoreInfoUI(); showScreen("scrStoreInfo"); };
$("goSalesManageBtn").onclick = ()=> { showScreen("scrSales"); if(typeof renderSales==="function") renderSales(); };
$("goFaqBtn").onclick       = ()=> openFaqHome();
$("goRecipeBtn").onclick    = ()=> showScreen("scrRecipe");
$("goPwaBtn").onclick       = ()=> openPwaGuide();

/* ===== showScreenæ‹¡å¼µ ===== */
(function hookShowScreenPart8(){
  if(showScreen._p8Hooked_v2) return;
  const _show = showScreen;
  showScreen = function(id){
    _show(id);

    if(id==="scrStoreInfo"){
      buildStoreInfoUI();
    }
  };
  showScreen._p8Hooked_v2 = true;
})();

/* èµ·å‹•è£œåŠ© */
(function openFirst(){
  showScreen("scrMain");
  if(typeof renderSeats==="function") renderSeats();
})();

/* =========================
  ã“ã“ã¾ã§ã§ 8åˆ†å‰² å®Œæˆ
========================= */

</script>
</body>
</html>