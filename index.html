<!-- =========================
  ONE ãƒ¬ã‚¸ã‚¢ãƒ—ãƒªï¼ˆç„¡æ–™ç‰ˆï¼‰å®Œå…¨ãƒ•ãƒ«ï¼šPART1
  å½¹å‰²ï¼šHTMLéª¨æ ¼ / CSS / å…±é€šå®šç¾© / å…±é€šUI / ãƒ¡ã‚¤ãƒ³ç”»é¢UI / æœ€ä½é™JS
  ä¿å­˜KEYï¼šONE_FREE_FULL_V1
  ä»•æ§˜ï¼šæœ€æ–°ç¢ºå®šï¼ˆãƒ˜ãƒƒãƒ€ãƒ¼å›ºå®šãƒ»ã‚¢ãƒ³ãƒ†ãƒŠâŒé‡ã­ãƒ»ä¸‹æ®µ2æ®µå›ºå®šãƒ»æ¨ªã‚¹ãƒ¯ã‚¤ãƒ—é˜²æ­¢ãƒ»ãƒ¢ãƒ¼ãƒ€ãƒ«ä¸­èƒŒæ™¯å›ºå®šï¼‰
========================= -->
<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <!-- ãƒ€ãƒ–ãƒ«ã‚¿ãƒƒãƒ—æ‹¡å¤§ã‚’æ®ºã•ãªã„ãŸã‚ user-scalable ã¯ç¦æ­¢ã—ãªã„ -->
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>ONE FREE</title>

  <style>
    :root{
      --bg:#0b0f14;
      --panel:#121a23;
      --panel2:#0f1620;
      --text:#e9f1ff;
      --muted:#9fb0c7;
      --line:#233244;
      --accent:#7aa7ff;
      --danger:#ff6b6b;
      --ok:#3ddc97;

      --headerH:56px;
      --bottomH1:64px;
      --bottomH2:56px;
      --radius:14px;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family:-apple-system,BlinkMacSystemFont,"Hiragino Sans","Noto Sans JP",system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      background:var(--bg);
      color:var(--text);
      overflow-x:hidden; /* æ¨ªã‚¹ãƒ¯ã‚¤ãƒ—ã§ç”»é¢ãŒå‹•ãã®ã‚’å°é– */
      -webkit-font-smoothing:antialiased;
      text-rendering:optimizeLegibility;
      touch-action:pan-y; /* æ¨ªæ–¹å‘ã‚’æŠ‘ãˆã‚‹ã€‚â€»bodyå…¨ä½“ã§manipulationã«ã™ã‚‹ã¨ãƒ€ãƒ–ãƒ«ã‚¿ãƒƒãƒ—æ‹¡å¤§ãŒæ­»ã¬å ´åˆãŒã‚ã‚‹ */
    }

    /* ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤ºä¸­ï¼šèƒŒæ™¯å›ºå®š */
    body.modalLock{
      position:fixed;
      width:100%;
      overflow:hidden;
    }

    .app{
      min-height:100%;
      padding-top:calc(var(--headerH) + env(safe-area-inset-top));
      padding-bottom:calc(var(--bottomH1) + var(--bottomH2) + env(safe-area-inset-bottom));
    }

    /* ===== Header ===== */
    .topbar{
      position:fixed;
      left:0; right:0; top:0;
      padding-top:env(safe-area-inset-top);
      height:calc(var(--headerH) + env(safe-area-inset-top));
      background:linear-gradient(180deg, rgba(18,26,35,0.98), rgba(18,26,35,0.92));
      border-bottom:1px solid var(--line);
      z-index:50;
      display:flex;
      align-items:flex-end;
    }
    .topbarInner{
      height:var(--headerH);
      width:100%;
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:0 12px 10px;
      gap:10px;
    }
    .brand{
      font-weight:800;
      letter-spacing:0.5px;
      font-size:18px;
    }
    .topBtns{
      display:flex;
      gap:8px;
      align-items:center;
    }
    .btn{
      border:1px solid var(--line);
      background:var(--panel2);
      color:var(--text);
      border-radius:12px;
      padding:10px 12px;
      font-size:14px;
      line-height:1;
      min-height:40px;
      user-select:none;
      -webkit-user-select:none;
      touch-action:manipulation; /* ãƒœã‚¿ãƒ³ã ã‘ã¯é«˜é€Ÿã‚¿ãƒƒãƒ—æœ€é©åŒ– */
    }
    .btn.primary{
      background:rgba(122,167,255,0.15);
      border-color:rgba(122,167,255,0.5);
    }
    .btn.ghost{
      background:transparent;
    }

    /* ã‚¢ãƒ³ãƒ†ãƒŠï¼ˆğŸ“¶ã«âŒé‡ã­ï¼‰ */
    .antennaWrap{
      position:relative;
      width:44px;
      height:40px;
      display:flex;
      align-items:center;
      justify-content:center;
      border:1px solid var(--line);
      border-radius:12px;
      background:var(--panel2);
      touch-action:manipulation;
    }
    .antennaIcon{
      font-size:20px;
      line-height:1;
    }
    .antennaX{
      position:absolute;
      top:6px;
      right:8px;
      font-size:14px;
      line-height:1;
      color:var(--danger);
      display:none;
      font-weight:800;
      text-shadow:0 1px 0 rgba(0,0,0,0.35);
    }
    .antennaWrap.off .antennaX{ display:block; }

    /* ===== Screens ===== */
    .screen{
      display:none;
      padding:12px;
      max-width:900px;
      margin:0 auto;
    }
    .screen.active{ display:block; }

    /* ===== Main (Seat Grid) ===== */
    .seatGrid{
      display:grid;
      grid-template-columns:repeat(3, minmax(0, 1fr));
      gap:10px;
    }
    .seatCard{
      border:1px solid var(--line);
      background:var(--panel);
      border-radius:var(--radius);
      padding:10px;
      min-height:100px;
      display:flex;
      flex-direction:column;
      justify-content:space-between;
      gap:6px;
      touch-action:manipulation;
    }
    .seatNo{
      font-size:22px;
      font-weight:900;
      letter-spacing:0.5px;
    }
    .seatMeta{
      color:var(--muted);
      font-size:12px;
      display:flex;
      flex-direction:column;
      gap:2px;
    }
    .seatMoney{
      font-size:16px;
      font-weight:800;
      margin-top:4px;
    }
    .seatCard.empty{
      background:linear-gradient(180deg, rgba(15,22,32,0.9), rgba(15,22,32,0.7));
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:6px;
      border:1px solid var(--line);
      background:rgba(255,255,255,0.03);
      border-radius:999px;
      padding:6px 10px;
      font-size:12px;
      color:var(--muted);
      width:fit-content;
    }

    /* ===== Bottom Bars ===== */
    .bottomBar1{
      position:fixed;
      left:0; right:0;
      bottom:calc(var(--bottomH2) + env(safe-area-inset-bottom));
      height:var(--bottomH1);
      padding:10px 12px;
      background:linear-gradient(180deg, rgba(11,15,20,0), rgba(11,15,20,0.96));
      z-index:40;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .actionBox{
      width:min(900px, 100%);
      border:1px solid rgba(122,167,255,0.55);
      background:rgba(122,167,255,0.10);
      border-radius:16px;
      padding:10px;
      display:grid;
      grid-template-columns:repeat(4, 1fr);
      gap:8px;
    }
    .actionBtn{
      border:1px solid rgba(255,255,255,0.12);
      background:rgba(0,0,0,0.15);
      color:var(--text);
      border-radius:12px;
      padding:12px 8px;
      font-weight:800;
      min-height:42px;
      touch-action:manipulation;
    }
    .actionBtn.on{
      outline:2px solid rgba(122,167,255,0.8);
      background:rgba(122,167,255,0.18);
    }

    .bottomBar2{
      position:fixed;
      left:0; right:0;
      bottom:0;
      padding-bottom:env(safe-area-inset-bottom);
      height:calc(var(--bottomH2) + env(safe-area-inset-bottom));
      background:rgba(18,26,35,0.95);
      border-top:1px solid var(--line);
      z-index:45;
      display:flex;
      align-items:center;
    }
    .bottomBar2Inner{
      width:100%;
      max-width:900px;
      margin:0 auto;
      padding:0 12px;
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:10px;
      align-items:center;
      height:var(--bottomH2);
    }

    /* ===== Modal ===== */
    .backdrop{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,0.55);
      z-index:80;
      display:none;
      align-items:flex-end;
      justify-content:center;
      padding:12px;
      padding-bottom:calc(12px + env(safe-area-inset-bottom));
    }
    .backdrop.show{ display:flex; }
    .modal{
      width:min(560px, 100%);
      background:var(--panel);
      border:1px solid var(--line);
      border-radius:18px;
      overflow:hidden;
    }
    .modalHead{
      padding:14px 14px 10px;
      border-bottom:1px solid var(--line);
      font-weight:900;
    }
    .modalBody{
      padding:14px;
      color:var(--text);
      font-size:14px;
      line-height:1.6;
    }
    .modalActions{
      padding:12px 14px 14px;
      display:flex;
      gap:10px;
      justify-content:flex-end;
    }

    /* ===== Toast ===== */
    .toast{
      position:fixed;
      left:50%;
      transform:translateX(-50%);
      bottom:calc(var(--bottomH1) + var(--bottomH2) + 18px + env(safe-area-inset-bottom));
      background:rgba(0,0,0,0.78);
      border:1px solid rgba(255,255,255,0.12);
      color:#fff;
      padding:10px 12px;
      border-radius:999px;
      font-size:13px;
      z-index:90;
      display:none;
      max-width:min(90vw, 720px);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .toast.show{ display:block; }

    /* iPhone SEãªã©å°ã•ã„ç”»é¢èª¿æ•´ */
    @media (max-width: 360px){
      .seatNo{ font-size:20px; }
      .actionBtn{ font-size:13px; padding:10px 6px; }
      .btn{ padding:9px 10px; }
    }
  </style>
</head>

<body>
  <!-- ===== Fixed Header ===== -->
  <header class="topbar" id="topbar">
    <div class="topbarInner">
      <div class="brand">ONE</div>

      <div class="topBtns">
        <!-- ãƒ¡ã‚¤ãƒ³æ™‚ï¼šã‚­ãƒƒãƒãƒ³ / ã‚­ãƒƒãƒãƒ³æ™‚ï¼šãƒ›ãƒ¼ãƒ« / ãã®ä»–ï¼šãƒ¡ã‚¤ãƒ³ ï¼ˆåˆ‡æ›¿ã¯å…±é€šé–¢æ•°ã§ï¼‰ -->
        <button class="btn primary" id="navSecond">ã‚­ãƒƒãƒãƒ³</button>

        <button class="antennaWrap" id="btnAntenna" aria-label="åŒæœŸçŠ¶æ…‹">
          <span class="antennaIcon">ğŸ“¶</span>
          <span class="antennaX">âŒ</span>
        </button>

        <button class="btn" id="btnSave">ä¿å­˜</button>
      </div>
    </div>
  </header>

  <!-- ===== App Screens ===== -->
  <main class="app">
    <!-- PART1ï¼šãƒ¡ã‚¤ãƒ³ -->
    <section class="screen active" id="scrMain">
      <div class="pill" id="mainHint">ç©ºå¸­ã‚’ã‚¿ãƒƒãƒ—ã§ æ¥åº— / äºˆç´„ ã‚’åˆ‡æ›¿</div>
      <div style="height:10px"></div>

      <div class="seatGrid" id="seatGrid"></div>

      <div style="height:16px"></div>
      <div class="pill" id="syncPill">åŒæœŸçŠ¶æ…‹ï¼š<span id="syncLabel">åŒæœŸã•ã‚Œã¦ã„ã¾ã™</span></div>
    </section>

    <!-- ä»¥é™ã®ç”»é¢ã¯ PART3ã€œPART8 ã§ä¸­èº«ã‚’å®Ÿè£… -->
    <section class="screen" id="scrKitchen"><div class="pill">ã‚­ãƒƒãƒãƒ³ï¼ˆPART3ã§å®Ÿè£…ï¼‰</div></section>
    <section class="screen" id="scrSales"><div class="pill">å£²ä¸Šï¼ˆPART4ã§å®Ÿè£…ï¼‰</div></section>
    <section class="screen" id="scrFix"><div class="pill">è¨‚æ­£ä¼ç¥¨ï¼ˆPART5ã§å®Ÿè£…ï¼‰</div></section>
    <section class="screen" id="scrSeatSetup"><div class="pill">å¸­ç™»éŒ²ï¼ˆPART6ã§å®Ÿè£…ï¼‰</div></section>
    <section class="screen" id="scrSettings"><div class="pill">è¨­å®šãƒ»ãƒ˜ãƒ«ãƒ—ï¼ˆPART8ã§å®Ÿè£…ï¼‰</div></section>
    <section class="screen" id="scrMenuSetup"><div class="pill">ãƒ¡ãƒ‹ãƒ¥ãƒ¼ç™»éŒ²ï¼ˆPART8-Aã§å®Ÿè£…ï¼‰</div></section>
  </main>

  <!-- ===== Bottom Bars (Main only UI base) ===== -->
  <div class="bottomBar1" id="bottomBar1">
    <div class="actionBox">
      <button class="actionBtn" id="modeMove">å¸­ç§»å‹•</button>
      <button class="actionBtn" id="modeMerge">ä¼šè¨ˆåˆç®—</button>
      <button class="actionBtn" id="modeSplit">ä¼šè¨ˆåˆ†å‰²</button>
      <button class="actionBtn primary" id="modeCommit">æ±ºå®š</button>
    </div>
  </div>

  <div class="bottomBar2" id="bottomBar2">
    <div class="bottomBar2Inner">
      <button class="btn" id="goTodaySales">æœ¬æ—¥ã®å£²ä¸Š</button>
      <button class="btn" id="goSettings">è¨­å®š</button>
    </div>
  </div>

  <!-- ===== Modals ===== -->
  <div class="backdrop" id="modalBackdrop" role="dialog" aria-modal="true">
    <div class="modal">
      <div class="modalHead" id="modalTitle"> </div>
      <div class="modalBody" id="modalBody"> </div>
      <div class="modalActions" id="modalActions"></div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    /* =========================
      Common / State (PART1)
    ========================= */

    const KEY = "ONE_FREE_FULL_V1";

    const $ = (id)=> document.getElementById(id);

    function nowTs(){ return Date.now(); }
    function pad2(n){ return String(n).padStart(2,"0"); }

    function yen(n){
      const x = Number(n||0);
      return "Â¥" + x.toLocaleString("ja-JP");
    }

    function toast(msg, ms=1800){
      const t = $("toast");
      t.textContent = msg;
      t.classList.add("show");
      clearTimeout(toast._tm);
      toast._tm = setTimeout(()=> t.classList.remove("show"), ms);
    }

    // ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆèƒŒæ™¯å›ºå®šï¼‰
    function lockBody(){
      const y = window.scrollY;
      document.body.dataset.scrollY = String(y);
      document.body.classList.add("modalLock");
      document.body.style.top = `-${y}px`;
    }
    function unlockBody(){
      const y = Number(document.body.dataset.scrollY || "0");
      document.body.classList.remove("modalLock");
      document.body.style.top = "";
      window.scrollTo(0, y);
    }

    function openModal(title, bodyHtml, actions){
      $("modalTitle").textContent = title || "";
      $("modalBody").innerHTML = bodyHtml || "";
      const box = $("modalActions");
      box.innerHTML = "";
      (actions||[]).forEach(a=>{
        const b = document.createElement("button");
        b.className = "btn" + (a.primary ? " primary" : "");
        b.textContent = a.label;
        b.onclick = ()=> a.onClick && a.onClick();
        box.appendChild(b);
      });
      $("modalBackdrop").classList.add("show");
      lockBody();
    }
    function closeModal(){
      $("modalBackdrop").classList.remove("show");
      unlockBody();
    }

    $("modalBackdrop").addEventListener("click", (e)=>{
      if(e.target === $("modalBackdrop")) closeModal();
    });

    // ç”»é¢é·ç§»ï¼ˆPART1ã¯æœ€ä½é™ï¼‰
    const screens = ["scrMain","scrKitchen","scrSales","scrFix","scrSeatSetup","scrSettings","scrMenuSetup"];
    function showScreen(id){
      screens.forEach(s=> $(s).classList.toggle("active", s===id));
      // ãƒ˜ãƒƒãƒ€ãƒ¼ãƒœã‚¿ãƒ³ï¼ˆç¬¬äºŒãƒœã‚¿ãƒ³ï¼‰æ–‡è¨€åˆ‡æ›¿ï¼ˆæœ€æ–°ãƒ«ãƒ¼ãƒ«ï¼‰
      // ãƒ¡ã‚¤ãƒ³ï¼šã‚­ãƒƒãƒãƒ³ / ã‚­ãƒƒãƒãƒ³ï¼šãƒ›ãƒ¼ãƒ« / ãã®ä»–ï¼šãƒ¡ã‚¤ãƒ³
      if(id==="scrMain"){
        $("navSecond").textContent = "ã‚­ãƒƒãƒãƒ³";
      }else if(id==="scrKitchen"){
        $("navSecond").textContent = "ãƒ›ãƒ¼ãƒ«";
      }else{
        $("navSecond").textContent = "ãƒ¡ã‚¤ãƒ³";
      }
      // ä¸‹éƒ¨ãƒãƒ¼ã¯ãƒ¡ã‚¤ãƒ³ã®ã¿è¡¨ç¤ºï¼ˆä»–ç”»é¢ã¯å°†æ¥æ‹¡å¼µï¼‰
      const onMain = (id==="scrMain");
      $("bottomBar1").style.display = onMain ? "flex" : "none";
      $("bottomBar2").style.display = onMain ? "flex" : "none";
    }

    // åŒæœŸè¡¨ç¤ºï¼ˆPART7ã§æœ¬å®Ÿè£…ï¼‰
    const state = {
      syncOk: true,
      seats: [],
      mode: null,  // "move" | "merge" | "split" | null
    };

    function setSync(ok){
      state.syncOk = !!ok;
      $("btnAntenna").classList.toggle("off", !ok);
      $("syncLabel").textContent = ok ? "åŒæœŸã•ã‚Œã¦ã„ã¾ã™" : "åŒæœŸã•ã‚Œã¦ã„ã¾ã›ã‚“";
    }

    // ãƒ€ãƒŸãƒ¼å¸­ï¼ˆPART6å®Ÿè£…ã§ç½®æ›ï¼‰
    function seedSeatsIfEmpty(){
      if(state.seats.length) return;
      // æœ€ä½é™ã®å‹•ä½œç¢ºèªç”¨ã€‚å¾Œã§PART6ã®å¸­ç™»éŒ²ã‹ã‚‰ç”Ÿæˆã™ã‚‹
      state.seats = [
        {id:"A", name:"", status:"empty", people:0, total:0, bills:0},
        {id:"B", name:"", status:"empty", people:0, total:0, bills:0},
        {id:"C", name:"", status:"empty", people:0, total:0, bills:0},
        {id:"D", name:"ç”°ä¸­", status:"in", people:2, total:4800, bills:1},
        {id:"E", name:"", status:"empty", people:0, total:0, bills:0},
        {id:"F", name:"ä½è—¤", status:"reserve", people:3, total:0, bills:0},
      ];
    }

    function renderSeats(){
      const grid = $("seatGrid");
      grid.innerHTML = "";
      state.seats.forEach(seat=>{
        const card = document.createElement("div");
        card.className = "seatCard" + (seat.status==="empty" ? " empty" : "");
        card.dataset.seatId = seat.id;

        const top = document.createElement("div");
        const no = document.createElement("div");
        no.className = "seatNo";
        no.textContent = seat.id;

        const meta = document.createElement("div");
        meta.className = "seatMeta";

        if(seat.status==="reserve"){
          meta.innerHTML = `<div>äºˆç´„</div><div>${seat.people||0}å</div>`;
        }else if(seat.status==="in"){
          const bills = seat.bills ? `åˆ¥ä¼šè¨ˆ${seat.bills}ä»¶` : "";
          meta.innerHTML = `<div>${seat.name||""}</div><div>${seat.people||0}å ${bills}</div>`;
        }else{
          meta.innerHTML = `<div>ç©ºå¸­</div>`;
        }

        top.appendChild(no);
        top.appendChild(meta);

        const money = document.createElement("div");
        money.className = "seatMoney";
        money.textContent = seat.status==="in" ? yen(seat.total) : "";

        card.appendChild(top);
        card.appendChild(money);

        card.onclick = ()=> onSeatTap(seat.id);

        grid.appendChild(card);
      });
    }

    // ç©ºå¸­ã‚¿ãƒƒãƒ—ã§ã€Œæ¥åº—/äºˆç´„/æˆ»ã‚‹ã€ã‚’å‡ºã™ï¼ˆPART1ä»•æ§˜ã®å…¥å£ï¼‰
    function onSeatTap(seatId){
      const seat = state.seats.find(s=> s.id===seatId);
      if(!seat) return;

      // ãƒ¢ãƒ¼ãƒ‰ä¸­ã®å¸­æ“ä½œã¯PART2ã§æœ¬å®Ÿè£…ã€‚ã“ã“ã§ã¯æœ€ä½é™ã®ã‚¬ãƒ¼ãƒ‰ã ã‘ã€‚
      if(state.mode){
        toast("æ“ä½œãƒ¢ãƒ¼ãƒ‰ä¸­ã§ã™ï¼ˆPART2ã§å®Ÿè£…ï¼‰");
        return;
      }

      if(seat.status==="empty"){
        openModal(
          "ç©ºå¸­",
          `å¸­ ${seatId} ã‚’ã©ã†ã—ã¾ã™ã‹ï¼Ÿ`,
          [
            {label:"æ¥åº—", primary:true, onClick:()=>{ closeModal(); seat.status="in"; seat.people=1; seat.name=""; seat.total=0; seat.bills=1; renderSeats(); }},
            {label:"äºˆç´„", onClick:()=>{ closeModal(); seat.status="reserve"; seat.people=1; renderSeats(); }},
            {label:"æˆ»ã‚‹", onClick:()=> closeModal()},
          ]
        );
      }else{
        // ä½¿ç”¨ä¸­/äºˆç´„ã¯å¾Œç¶šã§æ³¨æ–‡ç”»é¢ã¸ï¼ˆPART1/æ³¨æ–‡ã¯å¾Œã§å®Ÿè£…ï¼‰
        toast(`å¸­ ${seatId}ï¼ˆ${seat.status==="reserve"?"äºˆç´„":"ä½¿ç”¨ä¸­"}ï¼‰`);
      }
    }

    // ä¸‹éƒ¨ãƒ¢ãƒ¼ãƒ‰ï¼ˆè¦‹ãŸç›®ã ã‘ã€‚å‡¦ç†ã¯PART2ã§å®Ÿè£…ï¼‰
    function setMode(m){
      state.mode = m;
      ["modeMove","modeMerge","modeSplit"].forEach(id=> $(id).classList.remove("on"));
      if(m==="move") $("modeMove").classList.add("on");
      if(m==="merge") $("modeMerge").classList.add("on");
      if(m==="split") $("modeSplit").classList.add("on");
    }

    $("modeMove").onclick = ()=> setMode(state.mode==="move" ? null : "move");
    $("modeMerge").onclick = ()=> setMode(state.mode==="merge" ? null : "merge");
    $("modeSplit").onclick = ()=> setMode(state.mode==="split" ? null : "split");
    $("modeCommit").onclick = ()=> {
      if(!state.mode){ toast("æ“ä½œã‚’é¸æŠã—ã¦ãã ã•ã„"); return; }
      toast("æ±ºå®šï¼ˆPART2ã§å®Ÿè£…ï¼‰");
      setMode(null);
    };

    // ãƒ˜ãƒƒãƒ€ãƒ¼ã®ç¬¬2ãƒœã‚¿ãƒ³ï¼ˆãƒ¡ã‚¤ãƒ³<->ã‚­ãƒƒãƒãƒ³/ãã®ä»–ã¯ãƒ¡ã‚¤ãƒ³ã¸ï¼‰
    $("navSecond").onclick = ()=>{
      const current = screens.find(s=> $(s).classList.contains("active")) || "scrMain";
      if(current==="scrMain"){
        showScreen("scrKitchen");
      }else if(current==="scrKitchen"){
        showScreen("scrMain");
      }else{
        showScreen("scrMain");
      }
    };

    // æœ¬æ—¥ã®å£²ä¸Š / è¨­å®šï¼ˆé·ç§»ã®ã¿ã€‚ä¸­èº«ã¯å¾Œã§å®Ÿè£…ï¼‰
    $("goTodaySales").onclick = ()=> showScreen("scrSales");
    $("goSettings").onclick = ()=> showScreen("scrSettings");

    // ã‚¢ãƒ³ãƒ†ãƒŠï¼ˆPART7ã§æœ¬å®Ÿè£…ã€‚ã“ã“ã¯UIã ã‘ï¼‰
    $("btnAntenna").onclick = ()=>{
      if(state.syncOk){
        openModal("åŒæœŸ", "åŒæœŸã•ã‚Œã¦ã„ã¾ã™", [
          {label:"æˆ»ã‚‹", onClick:()=> closeModal()}
        ]);
      }else{
        openModal("åŒæœŸ", "åŒæœŸã•ã‚Œã¦ã„ã¾ã›ã‚“<br>é›»æ³¢çŠ¶æ³ã‚„ä¸€æ™‚çš„ãªä¸å…·åˆã®å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™<br>ä¿å­˜ã‚’è¡Œã†ã¨å†åŒæœŸã‚’è©¦ã¿ã¾ã™", [
          {label:"åŒæœŸé–‹å§‹", primary:true, onClick:()=>{ closeModal(); toast("åŒæœŸé–‹å§‹ï¼ˆPART7ã§å®Ÿè£…ï¼‰"); }},
          {label:"æˆ»ã‚‹", onClick:()=> closeModal()},
        ]);
      }
    };

    // ä¿å­˜ï¼ˆPART7ã§æœ¬å®Ÿè£…ã€‚ã“ã“ã¯UIã ã‘ï¼‰
    $("btnSave").onclick = ()=>{
      openModal(
        "ä¿å­˜",
        "æ³¨æ–‡ãƒ»ä¼šè¨ˆãƒ»å¸­æƒ…å ±ã¯ç«¯æœ«é–“ã§è‡ªå‹•åŒæœŸã•ã‚Œã¾ã™ï¼ˆé›»æ³¢çŠ¶æ³ãŒè‰¯å¥½ãªå ´åˆï¼‰<br><br>å–¶æ¥­çµ‚äº†æ™‚ãƒ»é€€å‹¤æ™‚ã«ã¯å¿…ãšä¿å­˜ã‚’è¡Œã£ã¦ãã ã•ã„",
        [
          {label:"ç¢ºå®šä¿å­˜", primary:true, onClick:()=>{ closeModal(); toast("ä¿å­˜ï¼ˆPART7ã§å®Ÿè£…ï¼‰"); }},
          {label:"æˆ»ã‚‹", onClick:()=> closeModal()},
        ]
      );
    };

    // èµ·å‹•
    (function init(){
      seedSeatsIfEmpty();
      setSync(true); // ã“ã“ã¯ä»®ã€‚PART7ã§å®ŸçŠ¶æ…‹ã«ç½®æ›
      renderSeats();
      showScreen("scrMain");
    })();

    /* =========================
      ã“ã“ã‹ã‚‰å…ˆã¯ PART2 ã§ç¶šã
    ========================= */
/* =========================
  PART2ï¼šå¸­æ“ä½œï¼ˆç§»å‹•ãƒ»åˆç®—ãƒ»åˆ†å‰²ï¼‰
  å½¹å‰²ï¼šæ“ä½œãƒ¢ãƒ¼ãƒ‰åˆ¶å¾¡ / ãƒã‚¤ãƒ©ã‚¤ãƒˆ / ç¢ºèª / å®Ÿè¡Œ
  æ–¹é‡ï¼šäººãŒé¸ã¶â†’æ±ºå®šâ†’ç¢ºèªâ†’ç¢ºå®šï¼ˆå‹æ‰‹ã«å‹•ã‹ãªã„ï¼‰
========================= */

/* ===== PART2 State ===== */
state.op = {
  type: null,         // "move" | "merge" | "split" | null
  fromSeat: null,     // å¸­ç§»å‹•ï¼šç§»å‹•å…ƒ
  toSeat: null,       // å¸­ç§»å‹•ï¼šç§»å‹•å…ˆ
  seatId: null,       // åˆç®—/åˆ†å‰²ï¼šå¯¾è±¡å¸­
  selectedBills: [],  // åˆç®—ï¼šé¸æŠã—ãŸä¼šè¨ˆï¼ˆç•ªå·ï¼‰
};

function resetOp(){
  state.op.type = null;
  state.op.fromSeat = null;
  state.op.toSeat = null;
  state.op.seatId = null;
  state.op.selectedBills = [];
  setMode(null);
  renderSeats(); // ãƒã‚¤ãƒ©ã‚¤ãƒˆè§£é™¤
}

function seatById(id){
  return state.seats.find(s=> s.id===id);
}

/* ===== Highlight ===== */
function renderSeatsWithHighlight(){
  // PART1ã®renderSeatsã‚’ä½¿ã„ã€æç”»å¾Œã«ã‚¯ãƒ©ã‚¹ä»˜ä¸ã ã‘è¡Œã†
  // ï¼ˆrenderSeatså†…ã§ card.onclick ã¯ onSeatTap ã‚’å‚ç…§ã—ã¦ã„ã‚‹ã®ã§ã€ã“ã“ã§ onSeatTap ã‚’ä¸Šæ›¸ãã™ã‚Œã°OKï¼‰
  renderSeats();

  const from = state.op.fromSeat;
  const to = state.op.toSeat;
  const sid = state.op.seatId;

  document.querySelectorAll(".seatCard").forEach(card=>{
    const id = card.dataset.seatId;
    card.classList.remove("hlFrom","hlTo","hlOne");

    if(state.mode==="move"){
      if(id===from) card.classList.add("hlFrom");
      if(id===to) card.classList.add("hlTo");
    }
    if(state.mode==="merge" || state.mode==="split"){
      if(id===sid) card.classList.add("hlOne");
    }
  });
}

/* è¿½åŠ ãƒã‚¤ãƒ©ã‚¤ãƒˆCSSï¼ˆPART1ã®styleæœ«å°¾ã«å…¥ã‚Œãšã€ã“ã“ã§styleã‚¿ã‚°ã‚’æŒ¿å…¥ã—ã¦ã‚‚OKï¼‰ */
(function injectPart2Css(){
  const css = `
    .seatCard.hlFrom{ outline:2px solid rgba(122,167,255,0.95); box-shadow:0 0 0 3px rgba(122,167,255,0.15); }
    .seatCard.hlTo{ outline:2px solid rgba(61,220,151,0.95); box-shadow:0 0 0 3px rgba(61,220,151,0.12); }
    .seatCard.hlOne{ outline:2px solid rgba(122,167,255,0.95); box-shadow:0 0 0 3px rgba(122,167,255,0.15); }
  `;
  const st = document.createElement("style");
  st.textContent = css;
  document.head.appendChild(st);
})();

/* ===== Mode Buttons override ===== */
function setMode(m){
  state.mode = m;
  ["modeMove","modeMerge","modeSplit"].forEach(id=> $(id).classList.remove("on"));
  if(m==="move") $("modeMove").classList.add("on");
  if(m==="merge") $("modeMerge").classList.add("on");
  if(m==="split") $("modeSplit").classList.add("on");

  // ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿æ™‚ã¯æ“ä½œé¸æŠã‚’åˆæœŸåŒ–
  state.op.type = m;
  state.op.fromSeat = null;
  state.op.toSeat = null;
  state.op.seatId = null;
  state.op.selectedBills = [];

  renderSeatsWithHighlight();
}

$("modeMove").onclick = ()=> setMode(state.mode==="move" ? null : "move");
$("modeMerge").onclick = ()=> setMode(state.mode==="merge" ? null : "merge");
$("modeSplit").onclick = ()=> setMode(state.mode==="split" ? null : "split");

/* ===== Seat Tap override (PART2) ===== */
function onSeatTap(seatId){
  const seat = seatById(seatId);
  if(!seat) return;

  // ãƒ¢ãƒ¼ãƒ‰OFFãªã‚‰PART1ã®é€šå¸¸å‹•ä½œï¼ˆç©ºå¸­ï¼šæ¥åº—/äºˆç´„ï¼‰ã«æˆ»ã—ãŸã„ã®ã§ã€PART1ã®å‡¦ç†ã‚’å†ç¾
  if(!state.mode){
    if(seat.status==="empty"){
      openModal(
        "ç©ºå¸­",
        `å¸­ ${seatId} ã‚’ã©ã†ã—ã¾ã™ã‹ï¼Ÿ`,
        [
          {label:"æ¥åº—", primary:true, onClick:()=>{ closeModal(); seat.status="in"; seat.people=1; seat.name=""; seat.total=0; seat.bills=1; renderSeatsWithHighlight(); }},
          {label:"äºˆç´„", onClick:()=>{ closeModal(); seat.status="reserve"; seat.people=1; renderSeatsWithHighlight(); }},
          {label:"æˆ»ã‚‹", onClick:()=> closeModal()},
        ]
      );
    }else{
      toast(`å¸­ ${seatId}ï¼ˆ${seat.status==="reserve"?"äºˆç´„":"ä½¿ç”¨ä¸­"}ï¼‰`);
    }
    return;
  }

  // ===== ãƒ¢ãƒ¼ãƒ‰ONï¼šå¸­æ“ä½œ =====
  if(state.mode==="move"){
    // 1å›ç›®ï¼šç§»å‹•å…ƒ
    if(!state.op.fromSeat){
      state.op.fromSeat = seatId;
      renderSeatsWithHighlight();
      return;
    }
    // 2å›ç›®ï¼šç§»å‹•å…ˆï¼ˆåŒã˜å¸­ã‚’æŠ¼ã—ãŸã‚‰è§£é™¤ï¼‰
    if(state.op.fromSeat===seatId){
      state.op.fromSeat = null;
      renderSeatsWithHighlight();
      return;
    }
    state.op.toSeat = seatId;
    renderSeatsWithHighlight();
    return;
  }

  if(state.mode==="merge"){
    // åˆç®—ã¯ã€ŒåŒä¸€å¸­å†…ã€å‰æãªã®ã§ã€å¯¾è±¡å¸­ã‚’1ã¤é¸ã¶
    state.op.seatId = seatId;
    renderSeatsWithHighlight();
    return;
  }

  if(state.mode==="split"){
    // åˆ†å‰²ã‚‚å¯¾è±¡å¸­ã‚’1ã¤é¸ã¶
    state.op.seatId = seatId;
    renderSeatsWithHighlight();
    return;
  }
}

/* ===== Commit button (æ±ºå®š) ===== */
$("modeCommit").onclick = ()=> {
  if(!state.mode){
    toast("æ“ä½œã‚’é¸æŠã—ã¦ãã ã•ã„");
    return;
  }

  if(state.mode==="move"){
    const fromId = state.op.fromSeat;
    const toId = state.op.toSeat;
    if(!fromId || !toId){
      toast("ç§»å‹•å…ƒã¨ç§»å‹•å…ˆã‚’é¸æŠã—ã¦ãã ã•ã„");
      return;
    }

    openModal(
      "ç¢ºèª",
      "å¸­ã‚’ç§»å‹•ã—ã¾ã™ã‹ï¼Ÿ",
      [
        {label:"ç§»å‹•ã™ã‚‹", primary:true, onClick:()=>{
          closeModal();
          doSeatMove(fromId, toId);
          resetOp();
        }},
        {label:"æˆ»ã‚‹", onClick:()=> closeModal()},
      ]
    );
    return;
  }

  if(state.mode==="merge"){
    const sid = state.op.seatId;
    if(!sid){
      toast("åˆç®—ã™ã‚‹å¸­ã‚’é¸æŠã—ã¦ãã ã•ã„");
      return;
    }
    const seat = seatById(sid);
    const bills = Number(seat.bills||0);

    // åˆ¥å¸­åˆç®—ä¸å¯ï¼ˆä»•æ§˜ï¼‰
    // ã“ã“ã§ã¯ã€Œå¸­ã‚’1ã¤ã—ã‹é¸ã°ã›ãªã„ã€ã“ã¨ã§äº‹æ•…ã‚’å°ã˜ã‚‹

    if(bills<=1){
      toast("ã“ã®å¸­ã«åˆç®—ã§ãã‚‹åˆ¥ä¼šè¨ˆãŒã‚ã‚Šã¾ã›ã‚“");
      return;
    }

    // ä¼šè¨ˆé¸æŠUIï¼ˆç°¡æ˜“ï¼‰ï¼šä¼šè¨ˆç•ªå·ã‚’è¤‡æ•°é¸æŠ â†’ æ±ºå®šã§åˆç®—
    openModal(
      "ä¼šè¨ˆåˆç®—",
      `åˆç®—ã—ãŸã„ä¼šè¨ˆã‚’é¸æŠã—ã¦ãã ã•ã„ï¼ˆå¸­ ${sid}ï¼‰`,
      [
        {label:"é¸æŠã™ã‚‹", primary:true, onClick:()=>{
          closeModal();
          openBillPickerForMerge(sid);
        }},
        {label:"æˆ»ã‚‹", onClick:()=> closeModal()},
      ]
    );
    return;
  }

  if(state.mode==="split"){
    const sid = state.op.seatId;
    if(!sid){
      toast("åˆ†å‰²ã™ã‚‹å¸­ã‚’é¸æŠã—ã¦ãã ã•ã„");
      return;
    }
    const seat = seatById(sid);
    if(!seat._mergeBackup){
      toast("ã“ã®å¸­ã¯åˆ†å‰²ã§ãã¾ã›ã‚“ï¼ˆåˆç®—çŠ¶æ…‹ã§ã¯ã‚ã‚Šã¾ã›ã‚“ï¼‰");
      return;
    }

    // åˆç®—å¾Œã«è¿½åŠ ã•ã‚ŒãŸæ³¨æ–‡ã¯åˆ†å‰²ä¸å¯ï¼ˆä»•æ§˜ï¼‰
    // å®Ÿè£…ã®æœ¬ä½“ã¯PART1ã®æ³¨æ–‡ã‚¤ãƒ™ãƒ³ãƒˆã§ã‚„ã‚‹ã®ã§ã€ã“ã“ã¯ãƒ«ãƒ¼ãƒ«èª¬æ˜ã ã‘ã‚’æ®‹ã™
    openModal(
      "ç¢ºèª",
      "åˆç®—å‰ã®çŠ¶æ…‹ã«æˆ»ã—ã¾ã™ã‹ï¼Ÿ<br>åˆç®—å¾Œã«è¿½åŠ ã•ã‚ŒãŸæ³¨æ–‡ã¯ä»£è¡¨ã«æ®‹ã‚Šã¾ã™ã€‚",
      [
        {label:"åˆ†å‰²ã™ã‚‹", primary:true, onClick:()=>{
          closeModal();
          doSplit(seat);
          resetOp();
        }},
        {label:"æˆ»ã‚‹", onClick:()=> closeModal()},
      ]
    );
    return;
  }
};

/* ===== Operations ===== */

// å¸­ç§»å‹•ï¼ˆç‰©ç†ï¼‰
// ãƒ«ãƒ¼ãƒ«ï¼šç§»å‹•å…ˆãŒä½¿ç”¨ä¸­ã§ã‚‚é‡ã­ã‚‹ï¼ˆäººæ•°ï¼ä¼šè¨ˆæ•°ã‚’å¢—ã‚„ã™ã€‚ã‚³ãƒ¡ãƒ³ãƒˆã¯å‡ºã•ãšçµæœã§ä¼ãˆã‚‹ï¼‰
function doSeatMove(fromId, toId){
  const from = seatById(fromId);
  const to = seatById(toId);
  if(!from || !to) return;

  // ç©ºå¸­åŒå£«ã®ç§»å‹•ã¯æ„å‘³ãŒè–„ã„ã®ã§è¨±å¯ã¯ã™ã‚‹ãŒå®Ÿè³ªå¤‰åŒ–ãªã—
  // ä»•æ§˜ã¨ã—ã¦ç¦æ­¢ã¯ã—ãªã„ï¼ˆæ­¢ã‚ãªã„ï¼‰

  // ç§»å‹•å…ˆã¸åˆæµ
  if(to.status==="empty"){
    // ãã®ã¾ã¾ç§»å‹•
    Object.assign(to, JSON.parse(JSON.stringify(from)));
    to.id = toId;
  }else{
    // é‡ã­ã‚‹ï¼ˆåˆæµï¼‰
    to.status = "in";
    to.people = Number(to.people||0) + Number(from.people||0);
    to.total  = Number(to.total||0)  + Number(from.total||0);
    to.bills  = Number(to.bills||0)  + Number(from.bills||0);

    // åå‰ã¯ç©ºãªã‚‰ç§»ã™ã€ä¸¡æ–¹ã‚ã‚Œã°ãã®ã¾ã¾ï¼ˆã‚³ãƒ¡ãƒ³ãƒˆå‡ºã•ãªã„ï¼‰
    if(!to.name && from.name) to.name = from.name;
  }

  // ç§»å‹•å…ƒã‚’ç©ºå¸­ã«
  from.status = "empty";
  from.people = 0;
  from.total  = 0;
  from.bills  = 0;
  from.name   = "";

  renderSeatsWithHighlight();
}

// åˆç®—ï¼šé¸æŠã—ãŸä¼šè¨ˆã‚’ä»£è¡¨ï¼ˆæœ€åˆã®é¸æŠï¼‰ã«ã¾ã¨ã‚ã‚‹
function openBillPickerForMerge(seatId){
  const seat = seatById(seatId);
  const bills = Number(seat.bills||0);
  const arr = Array.from({length:bills}, (_,i)=> i+1);

  // åˆæœŸï¼šå…¨éƒ¨é¸æŠï¼ˆãŸã ã—ä»£è¡¨ã¯æœ€åˆï¼‰
  let picked = new Set(arr);

  function body(){
    const items = arr.map(n=>{
      const on = picked.has(n);
      return `<div style="display:flex;align-items:center;justify-content:space-between;margin:8px 0;padding:10px;border:1px solid var(--line);border-radius:12px;background:rgba(255,255,255,0.03)">
        <div>ä¼šè¨ˆ ${n}</div>
        <div>${on ? "é¸æŠä¸­" : "æœªé¸æŠ"}</div>
      </div>`;
    }).join("");
    return `<div style="color:var(--muted);font-size:12px;margin-bottom:8px">ã‚¿ãƒƒãƒ—ã§åˆ‡æ›¿ï¼ˆæœ€ä½2ä»¶é¸æŠï¼‰</div>${items}`;
  }

  openModal(
    "ä¼šè¨ˆé¸æŠ",
    body(),
    [
      {label:"æˆ»ã‚‹", onClick:()=> closeModal()},
      {label:"åˆç®—ã™ã‚‹", primary:true, onClick:()=>{
        // æœ€ä½2ä»¶å¿…è¦
        if(picked.size<2){
          toast("2ä»¶ä»¥ä¸Šé¸æŠã—ã¦ãã ã•ã„");
          return;
        }
        closeModal();
        openModal(
          "ç¢ºèª",
          "æœ€åˆã«é¸æŠã—ãŸä¼šè¨ˆã«ã¾ã¨ã‚ã‚‰ã‚Œã¾ã™ã€‚<br>åˆç®—å¾Œã®æ³¨æ–‡ã¯åˆ†å‰²ã§ãã¾ã›ã‚“ã€‚",
          [
            {label:"åˆç®—ã™ã‚‹", primary:true, onClick:()=>{
              closeModal();
              doMerge(seat, Array.from(picked));
              resetOp();
            }},
            {label:"æˆ»ã‚‹", onClick:()=> closeModal()},
          ]
        );
      }},
    ]
  );

  // modalBodyå†…ã®å„è¡Œã‚¯ãƒªãƒƒã‚¯ã§é¸æŠåˆ‡æ›¿ï¼ˆç°¡æ˜“ï¼šå…¨è¡Œã‚’ã‚¯ãƒªãƒƒã‚¯å¯¾è±¡ã«ã™ã‚‹ï¼‰
  // openModalå¾Œã«DOMãŒã§ãã‚‹ã®ã§ã‚¤ãƒ™ãƒ³ãƒˆã‚’ä»˜ä¸ã™ã‚‹
  setTimeout(()=>{
    const rows = $("modalBody").querySelectorAll("div[style*='display:flex']");
    rows.forEach((row, idx)=>{
      row.style.cursor="pointer";
      row.onclick = ()=>{
        const n = arr[idx];
        if(picked.has(n)) picked.delete(n);
        else picked.add(n);
        $("modalBody").innerHTML = body();
        // å†ãƒã‚¤ãƒ³ãƒ‰
        setTimeout(()=> rows.forEach(()=>{}),0);
        // å†åº¦ä»˜ã‘ç›´ã™
        setTimeout(()=>{
          const rows2 = $("modalBody").querySelectorAll("div[style*='display:flex']");
          rows2.forEach((r2, idx2)=>{
            r2.style.cursor="pointer";
            r2.onclick = ()=>{
              const nn = arr[idx2];
              if(picked.has(nn)) picked.delete(nn);
              else picked.add(nn);
              $("modalBody").innerHTML = body();
              // å†å¸°ï¼ˆè»½é‡ï¼‰
              setTimeout(()=> {
                const rows3 = $("modalBody").querySelectorAll("div[style*='display:flex']");
                rows3.forEach((r3, idx3)=>{
                  r3.style.cursor="pointer";
                  r3.onclick = ()=>{ /* æ¬¡å›ã‚¯ãƒªãƒƒã‚¯ã§ã¾ãŸæ›´æ–°ã•ã‚Œã‚‹ã®ã§çœç•¥ */ };
                });
              },0);
            };
          });
        },0);
      };
    });
  },0);
}

// åˆç®—å®Ÿè¡Œï¼ˆãƒ‡ãƒ¼ã‚¿ã¯æœ€å°ã§ä¿æŒï¼‰
// é‡è¦ï¼šåˆ†å‰²å¯èƒ½ã«ã™ã‚‹ãŸã‚åˆç®—å‰ã®çŠ¶æ…‹ã‚’ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã™ã‚‹
function doMerge(seat, pickedBills){
  // ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ï¼ˆåˆç®—å‰ã®ä¼šè¨ˆæ•°ï¼‰
  seat._mergeBackup = {
    billsBefore: Number(seat.bills||0),
    mergeTs: nowTs(),
    picked: pickedBills.slice(),
  };

  // ä»£è¡¨ã«ã¾ã¨ã‚ã‚‹ï¼åˆ¥ä¼šè¨ˆæ•°ã‚’1ã«ã™ã‚‹ï¼ˆç„¡æ–™ç‰ˆã¯è¡¨ç¤ºä¸Šã®æ•´åˆã‚’æœ€å„ªå…ˆï¼‰
  seat.bills = 1;

  toast(`å¸­ ${seat.id} ã‚’åˆç®—ã—ã¾ã—ãŸ`);
  renderSeatsWithHighlight();
}

// åˆ†å‰²å®Ÿè¡Œ
function doSplit(seat){
  const b = seat._mergeBackup;
  if(!b) return;

  // åˆç®—å‰ã®ä¼šè¨ˆæ•°ã¸æˆ»ã™
  seat.bills = b.billsBefore;

  // ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’æ®‹ã—ã¦ã‚‚ã‚ˆã„ãŒã€äºŒé‡åˆ†å‰²ã‚’é˜²ããŸã‚æ¶ˆã™
  delete seat._mergeBackup;

  toast(`å¸­ ${seat.id} ã‚’åˆ†å‰²ã—ã¾ã—ãŸ`);
  renderSeatsWithHighlight();
}

/* ===== åˆå›åæ˜  ===== */
renderSeatsWithHighlight();

/* =========================
  ã“ã“ã‹ã‚‰å…ˆã¯ PART3 ã§ç¶šã
========================= */
/* =========================
  PART3ï¼šã‚­ãƒƒãƒãƒ³
  å½¹å‰²ï¼šæœªèª¿ç†ä¸€è¦§ / åŒä¸€ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã¾ã¨ã‚ / ã‚¹ãƒ©ã‚¤ãƒ‰å®Œäº† / æä¾›æ¸ˆæŠ˜ã‚ŠãŸãŸã¿
  æ–¹é‡ï¼šä½œã‚‹ã“ã¨ã ã‘ã«é›†ä¸­ãƒ»æ¶ˆã•ãªã„ãƒ»æˆ»ã›ã‚‹ãƒ»åŒæœŸçŠ¶æ…‹ã§åˆ¤æ–­ã—ãªã„
========================= */

/* ===== UIå·®ã—æ›¿ãˆï¼ˆPART1ã®ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ã‚’å®Ÿä½“ã«ç½®æ›ï¼‰ */
(function buildKitchenUI(){
  const scr = $("scrKitchen");
  scr.innerHTML = `
    <div class="pill" style="margin-bottom:10px">æœªèª¿ç†ãŒä¸Šã«è¡¨ç¤ºã•ã‚Œã¾ã™</div>

    <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin-bottom:10px">
      <div class="pill" style="border-color:rgba(255,255,255,0.18)">è¡¨ç¤º</div>
      <button class="btn" id="kFilterFood">æ–™ç†</button>
      <button class="btn" id="kFilterDrink">ãƒ‰ãƒªãƒ³ã‚¯</button>
      <button class="btn ghost" id="kToggleDone">æä¾›æ¸ˆã‚’è¡¨ç¤º</button>
    </div>

    <div id="kList"></div>

    <div style="height:12px"></div>

    <div id="kDoneWrap" style="display:none">
      <div class="pill" style="margin-bottom:10px">æä¾›æ¸ˆ</div>
      <div id="kDoneList"></div>
    </div>
  `;
})();

/* ===== PART3 State ===== */
state.kitchen = state.kitchen || {
  showDone: false,
  showFood: true,
  showDrink: true,
  items: []
};

/* ãƒ‡ãƒ¢ï¼ˆå¾Œã§PART1ã®æ³¨æ–‡ã‚¤ãƒ™ãƒ³ãƒˆã‹ã‚‰ç”Ÿæˆã™ã‚‹ï¼‰ */
(function seedKitchenIfEmpty(){
  if(state.kitchen.items.length) return;

  // tsã¯ nowTs() ã‚’åŸºæº–ã«å¤ã„é †ãŒå‡ºã‚‹ã‚ˆã†ã«èª¿æ•´
  const base = nowTs();
  state.kitchen.items = [
    {kid:"k1", ts: base-40*60*1000, seatId:"D", name:"å”æšã’", qty:1, cat:"food", status:"todo"},
    {kid:"k2", ts: base-30*60*1000, seatId:"A", name:"å”æšã’", qty:1, cat:"food", status:"todo"},
    {kid:"k3", ts: base-25*60*1000, seatId:"B", name:"å”æšã’", qty:2, cat:"food", status:"todo"},
    {kid:"k4", ts: base-20*60*1000, seatId:"C", name:"ç”Ÿãƒ“ãƒ¼ãƒ«", qty:1, cat:"drink", status:"todo"},
  ];
})();

/* ===== CSSï¼ˆã‚­ãƒƒãƒãƒ³å°‚ç”¨ï¼‰ ===== */
(function injectPart3Css(){
  const css = `
    .kRow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:10px;
      border:1px solid var(--line);
      border-radius:14px;
      background:rgba(255,255,255,0.03);
      margin-bottom:10px;
    }
    .kLeft{
      min-width:0;
      display:flex;
      align-items:center;
      gap:10px;
      flex:1;
    }
    .kTime{ font-weight:900; width:56px; }
    .kSeat{ font-weight:900; width:32px; }
    .kName{
      min-width:0;
      font-weight:800;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    .kQty{
      font-weight:900;
      color:var(--muted);
      margin-left:6px;
    }

    /* ã¶ã‚‰ä¸‹ã’è¡¨ç¤º */
    .kChild{
      margin-left:18px;
      position:relative;
    }
    .kChild::before{
      content:"";
      position:absolute;
      left:-10px;
      top:0;
      bottom:0;
      width:2px;
      background:rgba(122,167,255,0.45);
      border-radius:99px;
    }
    .kChild .kRow{
      background:rgba(122,167,255,0.08);
    }

    /* ã‚¹ãƒ©ã‚¤ãƒ‰ï¼ˆçŸ­ã‚ï¼šç”»é¢å¹…ã®ç´„1/4ã‚’æ„è­˜ï¼‰ */
    .kSlide{
      width:25vw;
      max-width:160px;
      min-width:110px;
      display:flex;
      align-items:center;
      gap:8px;
      justify-content:flex-end;
    }
    .kRange{
      width:100%;
      accent-color: var(--accent);
    }
    .kDoneBadge{
      font-size:12px;
      color:var(--ok);
      font-weight:900;
    }
  `;
  const st = document.createElement("style");
  st.textContent = css;
  document.head.appendChild(st);
})();

/* ===== Helpers ===== */
function hhmm(ts){
  const d = new Date(ts);
  return `${pad2(d.getHours())}:${pad2(d.getMinutes())}`;
}

function passCategory(item){
  if(item.cat==="food" && !state.kitchen.showFood) return false;
  if(item.cat==="drink" && !state.kitchen.showDrink) return false;
  return true;
}

/* åŒä¸€ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã¾ã¨ã‚ï¼šè¦ªï¼æœ€å¤ã€å­ï¼æ™‚é–“é †ã«ã¶ã‚‰ä¸‹ã’ */
function buildKitchenGroups(list){
  const map = new Map();
  list.forEach(it=>{
    const key = `${it.name}__${it.cat}`;
    if(!map.has(key)) map.set(key, []);
    map.get(key).push(it);
  });

  // å„ã‚°ãƒ«ãƒ¼ãƒ—ã¯å¤ã„é †
  const groups = [];
  map.forEach(arr=>{
    arr.sort((a,b)=> a.ts-b.ts);
    groups.push(arr);
  });

  // ã‚°ãƒ«ãƒ¼ãƒ—ã®ä¸¦ã³ã¯ã€Œè¦ªï¼ˆæœ€å¤ï¼‰ã®æ™‚é–“ãŒå¤ã„é †ã€
  groups.sort((ga,gb)=> ga[0].ts - gb[0].ts);

  return groups;
}

/* ===== Render ===== */
function renderKitchen(){
  const todo = state.kitchen.items
    .filter(it=> it.status==="todo")
    .filter(passCategory);

  const done = state.kitchen.items
    .filter(it=> it.status==="done")
    .filter(passCategory);

  const listBox = $("kList");
  const doneWrap = $("kDoneWrap");
  const doneBox = $("kDoneList");

  listBox.innerHTML = "";
  doneBox.innerHTML = "";

  // æœªèª¿ç†ï¼ˆã‚°ãƒ«ãƒ¼ãƒ—è¡¨ç¤ºï¼‰
  const groups = buildKitchenGroups(todo);
  if(groups.length===0){
    listBox.innerHTML = `<div class="pill">æœªèª¿ç†ã¯ã‚ã‚Šã¾ã›ã‚“</div>`;
  }else{
    groups.forEach(arr=>{
      const parent = arr[0];
      listBox.appendChild(kRowEl(parent, false));

      // å­ã‚’ã¶ã‚‰ä¸‹ã’
      arr.slice(1).forEach(ch=>{
        const wrap = document.createElement("div");
        wrap.className = "kChild";
        wrap.appendChild(kRowEl(ch, false));
        listBox.appendChild(wrap);
      });
    });
  }

  // æä¾›æ¸ˆï¼ˆæŠ˜ã‚ŠãŸãŸã¿ï¼‰
  doneWrap.style.display = state.kitchen.showDone ? "block" : "none";
  if(state.kitchen.showDone){
    const groupsD = buildKitchenGroups(done);
    if(groupsD.length===0){
      doneBox.innerHTML = `<div class="pill">æä¾›æ¸ˆã¯ã‚ã‚Šã¾ã›ã‚“</div>`;
    }else{
      groupsD.forEach(arr=>{
        const parent = arr[0];
        doneBox.appendChild(kRowEl(parent, true));
        arr.slice(1).forEach(ch=>{
          const wrap = document.createElement("div");
          wrap.className = "kChild";
          wrap.appendChild(kRowEl(ch, true));
          doneBox.appendChild(wrap);
        });
      });
    }
  }
}

function kRowEl(item, isDone){
  const row = document.createElement("div");
  row.className = "kRow";

  const qtyText = (Number(item.qty||0) >= 2) ? `Ã—${item.qty}` : "";
  row.innerHTML = `
    <div class="kLeft">
      <div class="kTime">${hhmm(item.ts)}</div>
      <div class="kSeat">${item.seatId}</div>
      <div class="kName">${item.name}<span class="kQty">${qtyText}</span></div>
    </div>
    <div class="kSlide">
      ${isDone ? `<span class="kDoneBadge">å®Œäº†</span>` : ``}
      <input class="kRange" type="range" min="0" max="100" value="0" aria-label="ã‚¹ãƒ©ã‚¤ãƒ‰ã§å®Œäº†" />
    </div>
  `;

  const range = row.querySelector(".kRange");
  const TH = 88; // å®Œäº†åˆ¤å®šã—ãã„å€¤

  function reset(){
    range.value = 0;
  }

  range.addEventListener("change", ()=>{
    const v = Number(range.value||0);
    if(v >= TH){
      // ã‚¹ãƒ©ã‚¤ãƒ‰ç¢ºå®š
      item.status = isDone ? "todo" : "done";
      reset();
      // ä¸¦ã³æ›¿ãˆã¯ renderKitchen ãŒã‚„ã‚‹ï¼ˆæ™‚é–“åŸºæº–ã¯ä¿æŒï¼‰
      renderKitchen();
    }else{
      reset();
    }
  });

  range.addEventListener("input", ()=>{
    // é€”ä¸­ã§é›¢ã—ãŸã‚‰æˆ»ã™ã®ã¯ change ã§å¯¾å¿œ
  });

  return row;
}

/* ===== Buttons ===== */
$("kToggleDone").onclick = ()=>{
  state.kitchen.showDone = !state.kitchen.showDone;
  $("kToggleDone").textContent = state.kitchen.showDone ? "æä¾›æ¸ˆã‚’éš ã™" : "æä¾›æ¸ˆã‚’è¡¨ç¤º";
  renderKitchen();
};

$("kFilterFood").onclick = ()=>{
  state.kitchen.showFood = !state.kitchen.showFood;
  $("kFilterFood").classList.toggle("primary", state.kitchen.showFood);
  renderKitchen();
};
$("kFilterDrink").onclick = ()=>{
  state.kitchen.showDrink = !state.kitchen.showDrink;
  $("kFilterDrink").classList.toggle("primary", state.kitchen.showDrink);
  renderKitchen();
};

// åˆæœŸãƒã‚¤ãƒ©ã‚¤ãƒˆï¼ˆä¸¡æ–¹ONï¼‰
$("kFilterFood").classList.add("primary");
$("kFilterDrink").classList.add("primary");

/* ===== showScreenæ‹¡å¼µï¼šã‚­ãƒƒãƒãƒ³è¡¨ç¤ºæ™‚ã«æç”» ===== */
(function hookShowScreenForKitchen(){
  if(showScreen._kHooked) return;
  const _show = showScreen;
  showScreen = function(id){
    _show(id);
    if(id==="scrKitchen") renderKitchen();
  };
  showScreen._kHooked = true;
})();

/* åˆå›æç”»ï¼ˆã‚­ãƒƒãƒãƒ³ã«å…¥ã£ãŸæ™‚ã«ã‚‚å†æç”»ã•ã‚Œã‚‹ï¼‰ */
renderKitchen();

/* =========================
  ã“ã“ã‹ã‚‰å…ˆã¯ PART4 ã§ç¶šã
========================= */
/* =========================
  PART4ï¼šå£²ä¸Šï¼ˆæœ¬æ—¥ï¼æœˆï¼å¹´ï¼‰
  å½¹å‰²ï¼šè¡¨ç¤ºã®ã¿ï¼ˆç·¨é›†ä¸å¯ï¼‰ï¼å®‰å¿ƒç¢ºèª
  æ–¹é‡ï¼šè»½ããƒ»ä¸å®‰ã‚’ç…½ã‚‰ãªã„ãƒ»ä¿®æ­£ã¯PART5ã¸åˆ†é›¢
========================= */

/* ===== UIå·®ã—æ›¿ãˆï¼ˆãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ç½®æ›ï¼‰ ===== */
(function buildSalesUI(){
  const scr = $("scrSales");
  scr.innerHTML = `
    <div class="pill" style="margin-bottom:10px">å£²ä¸Šï¼ˆè¡¨ç¤ºã®ã¿ï¼‰</div>

    <div style="display:flex; gap:8px; margin-bottom:10px">
      <button class="btn primary" id="tabToday">æœ¬æ—¥</button>
      <button class="btn" id="tabMonth">æœˆ</button>
      <button class="btn" id="tabYear">å¹´</button>
    </div>

    <div id="salesToday"></div>
    <div id="salesMonth" style="display:none"></div>
    <div id="salesYear" style="display:none"></div>
  `;
})();

/* ===== PART4 State ===== */
state.sales = state.sales || {
  // ä¼šè¨ˆç¢ºå®šæ™‚ã«ç©ã¾ã‚Œã‚‹æƒ³å®šï¼ˆãƒ‡ãƒ¢ã‚ã‚Šï¼‰
  list: [],
  cache: { today:null, month:null, year:null },
  tab: "today"
};

/* ===== Demo Seed ===== */
(function seedSalesIfEmpty(){
  if(state.sales.list.length) return;
  const now = new Date();
  const mk = (h,m,seat,name,pay,amt)=>{
    const d = new Date(now.getFullYear(), now.getMonth(), now.getDate(), h, m);
    return {
      saleId: "s"+Math.random().toString(36).slice(2),
      ts: d.getTime(),
      seatId: seat,
      name: name||"",
      pay,
      amount: amt,
      receipt: true,
      items: [
        {name:"ç”Ÿãƒ“ãƒ¼ãƒ«", qty:2, price:600, tax:10},
        {name:"å”æšã’", qty:1, price:800, tax:10},
      ]
    };
  };
  state.sales.list.push(
    mk(12,35,"D","ç”°ä¸­","ã‚«ãƒ¼ãƒ‰",4800),
    mk(13,10,"A","","ç¾é‡‘",1800),
    mk(14,05,"B","ä½è—¤","QR",2200),
  );
})();

/* ===== Helpers ===== */
function sameDay(a,b){
  return a.getFullYear()===b.getFullYear()
      && a.getMonth()===b.getMonth()
      && a.getDate()===b.getDate();
}
function ymd(d){
  return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
}

/* ===== Aggregation (è»½é‡) ===== */
function aggToday(){
  const today = new Date();
  const rows = state.sales.list.filter(s=> sameDay(new Date(s.ts), today));
  const sum = rows.reduce((a,b)=> a+b.amount, 0);
  const cnt = rows.length;
  const pay = rows.reduce((o,s)=> (o[s.pay]=(o[s.pay]||0)+1, o), {});
  return { rows, sum, cnt, pay };
}
function aggMonth(){
  const d = new Date();
  const y=d.getFullYear(), m=d.getMonth();
  const rows = state.sales.list.filter(s=>{
    const x=new Date(s.ts);
    return x.getFullYear()===y && x.getMonth()===m;
  });
  const sum = rows.reduce((a,b)=> a+b.amount, 0);
  return { sum, cnt: rows.length };
}
function aggYear(){
  const y=new Date().getFullYear();
  const rows = state.sales.list.filter(s=> new Date(s.ts).getFullYear()===y);
  const sum = rows.reduce((a,b)=> a+b.amount, 0);
  return { sum, cnt: rows.length };
}

/* ===== Render ===== */
function renderSales(){
  const t = $("salesToday");
  const m = $("salesMonth");
  const y = $("salesYear");

  t.style.display = state.sales.tab==="today" ? "block":"none";
  m.style.display = state.sales.tab==="month" ? "block":"none";
  y.style.display = state.sales.tab==="year"  ? "block":"none";

  if(state.sales.tab==="today") renderToday();
  if(state.sales.tab==="month") renderMonth();
  if(state.sales.tab==="year")  renderYear();
}

function renderToday(){
  const box = $("salesToday");
  const a = aggToday();
  const payTxt = ["ç¾é‡‘","ã‚«ãƒ¼ãƒ‰","QR"].map(k=>`${k} ${a.pay[k]||0}`).join(" / ");

  box.innerHTML = `
    <div class="pill" style="margin-bottom:8px">
      åˆè¨ˆ ${yen(a.sum)} ï¼ ä¼šè¨ˆ ${a.cnt}ä»¶ ï¼ ${payTxt}
    </div>

    <div id="todayList"></div>
  `;

  const list = box.querySelector("#todayList");
  if(a.rows.length===0){
    list.innerHTML = `<div class="pill">æœ¬æ—¥ã®ä¼šè¨ˆã¯ã‚ã‚Šã¾ã›ã‚“</div>`;
    return;
  }

  a.rows
    .sort((x,y)=> x.ts - y.ts)
    .forEach(s=>{
      const d=new Date(s.ts);
      const row=document.createElement("div");
      row.className="kRow";
      row.innerHTML=`
        <div class="kLeft">
          <div class="kTime">${pad2(d.getHours())}:${pad2(d.getMinutes())}</div>
          <div class="kSeat">${s.seatId}</div>
          <div class="kName">${s.name||""}</div>
        </div>
        <div class="kSlide">
          <div style="font-weight:900">${s.pay}</div>
          <div style="width:8px"></div>
          <div style="font-weight:900">${yen(s.amount)}</div>
        </div>
      `;
      row.onclick=()=>{
        openSaleDetail(s);
      };
      list.appendChild(row);
    });
}

function renderMonth(){
  const box = $("salesMonth");
  const a = aggMonth();
  box.innerHTML = `
    <div class="pill">æœˆåˆè¨ˆ ${yen(a.sum)} ï¼ ä¼šè¨ˆ ${a.cnt}ä»¶</div>
    <div style="height:8px"></div>
    <div class="pill">æ—¥åˆ¥å†…è¨³ã¯ç„¡æ–™ç‰ˆã§ã¯è¡¨ç¤ºã—ã¾ã›ã‚“</div>
  `;
}

function renderYear(){
  const box = $("salesYear");
  const a = aggYear();
  box.innerHTML = `
    <div class="pill">å¹´åˆè¨ˆ ${yen(a.sum)} ï¼ ä¼šè¨ˆ ${a.cnt}ä»¶</div>
    <div style="height:8px"></div>
    <div class="pill">æœˆåˆ¥å†…è¨³ã¯ç„¡æ–™ç‰ˆã§ã¯è¡¨ç¤ºã—ã¾ã›ã‚“</div>
  `;
}

/* ===== Detail (ä¿®æ­£ã¯PART5ã¸) ===== */
function openSaleDetail(s){
  const items = s.items.map(it=>`${it.name} Ã—${it.qty}`).join("<br>");
  openModal(
    "ä¼šè¨ˆè©³ç´°",
    `
      <div>å¸­ï¼š${s.seatId}</div>
      <div>æ”¯æ‰•ï¼š${s.pay}</div>
      <div>é›»å­ãƒ¬ã‚·ãƒ¼ãƒˆï¼š${s.receipt?"é€ä¿¡æ¸ˆ":"æœªé€ä¿¡"}</div>
      <div style="margin-top:8px">${items}</div>
      <div style="margin-top:8px;font-weight:900">${yen(s.amount)}</div>
    `,
    [
      {label:"ä¿®æ­£", primary:true, onClick:()=>{ closeModal(); showScreen("scrFix"); }},
      {label:"æˆ»ã‚‹", onClick:()=> closeModal()},
    ]
  );
}

/* ===== Tabs ===== */
$("tabToday").onclick=()=>{ state.sales.tab="today"; $("tabToday").classList.add("primary"); $("tabMonth").classList.remove("primary"); $("tabYear").classList.remove("primary"); renderSales(); };
$("tabMonth").onclick=()=>{ state.sales.tab="month"; $("tabMonth").classList.add("primary"); $("tabToday").classList.remove("primary"); $("tabYear").classList.remove("primary"); renderSales(); };
$("tabYear").onclick =()=>{ state.sales.tab="year";  $("tabYear").classList.add("primary");  $("tabToday").classList.remove("primary"); $("tabMonth").classList.remove("primary"); renderSales(); };

/* ===== showScreenæ‹¡å¼µ ===== */
(function hookShowScreenForSales(){
  if(showScreen._sHooked) return;
  const _show = showScreen;
  showScreen = function(id){
    _show(id);
    if(id==="scrSales") renderSales();
  };
  showScreen._sHooked = true;
})();

/* åˆæœŸæç”» */
renderSales();

/* =========================
  ã“ã“ã‹ã‚‰å…ˆã¯ PART5 ã§ç¶šã
========================= */
/* =========================
  PART5ï¼šå£²ä¸Šç®¡ç†ãƒ»è¨‚æ­£ä¼ç¥¨
  å½¹å‰²ï¼šä¼šè¨ˆç¢ºå®šå¾Œã®ä¿®æ­£ï¼ˆå·®åˆ†ã‚¤ãƒ™ãƒ³ãƒˆã®ã¿ï¼‰
  æ–¹é‡ï¼šæ¶ˆã•ãªã„ï¼ä¸Šæ›¸ãã—ãªã„ï¼å±¥æ­´ã‚’æ®‹ã™
========================= */

/* ===== UIå·®ã—æ›¿ãˆï¼ˆãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ç½®æ›ï¼‰ ===== */
(function buildFixUI(){
  const scr = $("scrFix");
  scr.innerHTML = `
    <div class="pill" style="margin-bottom:10px">è¨‚æ­£ä¼ç¥¨ï¼ˆä¼šè¨ˆç¢ºå®šå¾Œï¼‰</div>
    <div id="fixBody"></div>
  `;
})();

/* ===== PART5 State ===== */
state.fix = state.fix || {
  target: null,   // ä¿®æ­£å¯¾è±¡ã® sale
  drafts: []      // è¿½åŠ äºˆå®šã®è¨‚æ­£ï¼ˆå·®åˆ†ï¼‰
};

/* ===== Entry from PART4 ===== */
(function hookFixEntry(){
  if(openSaleDetail._fixHooked) return;
  const _open = openSaleDetail;
  openSaleDetail = function(sale){
    _open(sale);
    // ä¿®æ­£ãƒœã‚¿ãƒ³ã§ scrFix ã«é·ç§»ã™ã‚‹ãŸã‚ã€å¯¾è±¡ã‚’ä¿æŒ
    state.fix.target = sale;
  };
  openSaleDetail._fixHooked = true;
})();

/* ===== Render ===== */
function renderFix(){
  const box = $("fixBody");
  const s = state.fix.target;

  if(!s){
    box.innerHTML = `<div class="pill">ä¿®æ­£å¯¾è±¡ãŒã‚ã‚Šã¾ã›ã‚“</div>`;
    return;
  }

  const baseItems = s.items.map(it=>`
    <div class="kRow">
      <div class="kLeft">
        <div class="kName">${it.name}</div>
      </div>
      <div class="kSlide">Ã—${it.qty}</div>
    </div>
  `).join("");

  const corrItems = (s.corrections||[]).map(c=>`
    <div class="kRow">
      <div class="kLeft">
        <div class="kName">${c.name}</div>
      </div>
      <div class="kSlide">âˆ’${c.qty}</div>
    </div>
  `).join("");

  box.innerHTML = `
    <div class="pill">å…ƒä¼ç¥¨</div>
    <div style="margin-bottom:8px">
      <div>å¸­ï¼š${s.seatId}</div>
      <div>æ”¯æ‰•ï¼š${s.pay}</div>
      <div>åˆè¨ˆï¼š${yen(s.amount)}</div>
    </div>

    <div class="pill" style="margin-bottom:6px">æ˜ç´°</div>
    ${baseItems}
    ${corrItems ? `<div class="pill">è¨‚æ­£</div>${corrItems}` : ``}

    <div style="height:10px"></div>

    <button class="btn primary" id="btnAddFix">è¨‚æ­£ä¼ç¥¨ã‚’è¿½åŠ </button>
  `;
}

/* ===== Add Correction ===== */
function openAddFix(){
  const s = state.fix.target;
  if(!s) return;

  const opts = s.items.map((it,idx)=>`
    <option value="${idx}">${it.name}</option>
  `).join("");

  openModal(
    "è¨‚æ­£è¿½åŠ ",
    `
      <div style="margin-bottom:6px">è¨‚æ­£è€…å</div>
      <input id="fixWho" class="btn" style="width:100%; text-align:left" placeholder="åå‰" />

      <div style="margin-top:10px;margin-bottom:6px">ç†ç”±</div>
      <select id="fixWhy" class="btn" style="width:100%">
        <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
        <option>æœªæä¾›</option>
        <option>æ”¯æ‰•ã„æ–¹æ³•ãƒŸã‚¹</option>
        <option>äºŒé‡ä¼šè¨ˆ</option>
        <option>è¿”é‡‘å¯¾å¿œ</option>
        <option>ãã®ä»–</option>
      </select>

      <div style="margin-top:10px;margin-bottom:6px">å•†å“</div>
      <select id="fixItem" class="btn" style="width:100%">
        ${opts}
      </select>

      <div style="margin-top:10px;margin-bottom:6px">æ•°é‡ï¼ˆæ¸›ã‚‰ã™ï¼‰</div>
      <input id="fixQty" type="number" class="btn" min="1" value="1" style="width:100%" />
    `,
    [
      {label:"è¿½åŠ ", primary:true, onClick:()=>{
        const who = $("fixWho").value.trim();
        const why = $("fixWhy").value;
        const idx = Number($("fixItem").value);
        const qty = Number($("fixQty").value||0);

        if(!who || !why || !qty){
          toast("å…¥åŠ›ãŒä¸è¶³ã—ã¦ã„ã¾ã™");
          return;
        }

        const it = s.items[idx];
        s.corrections = s.corrections || [];
        s.corrections.push({
          name: it.name,
          qty,
          who,
          why,
          ts: nowTs()
        });

        closeModal();
        toast("è¨‚æ­£ä¼ç¥¨ã‚’è¿½åŠ ã—ã¾ã—ãŸ");
        renderFix();
      }},
      {label:"æˆ»ã‚‹", onClick:()=> closeModal()},
    ]
  );
}

/* ===== Hook Button ===== */
(function hookFixBtn(){
  if(hookFixBtn._done) return;
  document.addEventListener("click",(e)=>{
    if(e.target && e.target.id==="btnAddFix"){
      openAddFix();
    }
  });
  hookFixBtn._done = true;
})();

/* ===== showScreenæ‹¡å¼µ ===== */
(function hookShowScreenForFix(){
  if(showScreen._fHooked) return;
  const _show = showScreen;
  showScreen = function(id){
    _show(id);
    if(id==="scrFix") renderFix();
  };
  showScreen._fHooked = true;
})();

/* åˆæœŸæç”» */
renderFix();

/* =========================
  ã“ã“ã‹ã‚‰å…ˆã¯ PART6 ã§ç¶šã
========================= */
/* =========================
  PART6ï¼šå¸­ç™»éŒ²ãƒ»åˆæœŸè¨­å®šï¼ˆæœ€å¤§ç€å¸­äººæ•° å®Œå…¨å»ƒæ­¢ï¼‰
  å½¹å‰²ï¼šåç§°é¸æŠâ†’ç®±ã®æ•°â†’é–‹å§‹å¸­ç•ªå·â†’ä¿å­˜â†’ä½œæˆæ¸ˆã¿ç®¡ç†
  æ–¹é‡ï¼šåˆ¶é™ã—ãªã„ï¼ç¾å ´åˆ¤æ–­å„ªå…ˆï¼æ­¢ã‚ãªã„ï¼èª¤æ“ä½œã¯ã‚¹ãƒ©ã‚¤ãƒ‰ã§é˜²æ­¢
========================= */

/* ===== UIå·®ã—æ›¿ãˆï¼ˆãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ç½®æ›ï¼‰ ===== */
(function buildSeatSetupUI(){
  const scr = $("scrSeatSetup");
  scr.innerHTML = `
    <div class="pill" style="margin-bottom:10px">å¸­ç™»éŒ²</div>

    <!-- â‘  åç§° -->
    <div class="pill" style="margin-bottom:8px">â‘  åç§°</div>
    <div id="ssNameGrid" class="seatGrid" style="margin-bottom:8px"></div>
    <button class="btn primary" id="ssNameCommit" style="width:100%; margin-bottom:14px">æ±ºå®š</button>

    <!-- â‘¡ ç·å¸­æ•°ï¼ç·å“æ•° -->
    <div class="pill" style="margin-bottom:8px">â‘¡ ç·å¸­æ•°ï¼ç·å“æ•°ï¼ˆç®±ã®æ•°ï¼‰</div>
    <div style="display:flex; gap:10px; align-items:center; margin-bottom:14px">
      <button class="btn" id="ssCntMinus">â—€ï¸</button>
      <div class="pill" id="ssCntVal" style="font-weight:900; min-width:60px; justify-content:center">0</div>
      <button class="btn" id="ssCntPlus">â–¶ï¸</button>
    </div>

    <!-- â‘¢ å¸­ç•ªå· -->
    <div class="pill" style="margin-bottom:8px">â‘¢ å¸­ç•ªå·ï¼ˆè‡ªå‹•ã§æ¬¡ãŒå…¥ã‚Šã¾ã™ï¼‰</div>
    <input class="btn" id="ssStartLabel" placeholder="é–‹å§‹æ–‡å­—ï¼ˆä¾‹ï¼šA / 1 / ã‚ / ã‚¢ï¼‰" style="width:100%; text-align:left; margin-bottom:6px" />
    <div class="pill" style="margin-bottom:14px; color:var(--muted)">
      å…¥åŠ›ãŒ1æ–‡å­—ã®ã¿ã®å ´åˆã¯è‡ªå‹•ã§é€£ç•ªã«ãªã‚Šã¾ã™
    </div>

    <!-- â‘£ æœ€å¤§ç€å¸­äººæ•°ï¼šè¡¨ç¤ºã—ãªã„ï¼ˆæ¦‚å¿µã”ã¨æŒãŸãªã„ï¼‰ -->

    <!-- â‘¤ ä¿å­˜ -->
    <button class="btn primary" id="ssSave" style="width:100%; padding:14px 12px; font-weight:900; margin-bottom:14px">ä¿å­˜</button>

    <!-- â‘¥ ä½œã£ãŸå¸­ï¼ˆåç§°ã”ã¨ï¼‰ -->
    <div class="pill" style="margin-bottom:8px">ä½œã£ãŸå¸­</div>
    <div id="ssGroups"></div>
  `;
})();

/* ===== PART6 State ===== */
state.seatSetup = state.seatSetup || {
  baseNames: ["ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼","ãƒ†ãƒ¼ãƒ–ãƒ«","åº§æ•·","å€‹å®¤","ç«‹ã¡","ãã®ä»–"],
  customNames: [],          // ã€Œãã®ä»–ã€ã§è¿½åŠ ã—ãŸåç§°ï¼ˆè¡¨ç¤ºã¯ãã®ä»–ã®å‰ï¼‰
  selectedName: null,       // ä»Šé¸æŠä¸­ï¼ˆã‚¿ãƒƒãƒ—ã§ãƒã‚¤ãƒ©ã‚¤ãƒˆï¼‰
  committedName: null,      // æ±ºå®šã•ã‚ŒãŸåç§°ï¼ˆä¿å­˜å¯¾è±¡ï¼‰
  count: 0,                 // ç·å¸­/ç·å“ï¼ˆç®±ã®æ•°ï¼‰
  startLabel: "",           // é–‹å§‹æ–‡å­—
  groups: []                // {gid, name, seatIds:[], createdTs}
};

/* ===== Helpers: label auto increment ===== */
function isSingleChar(str){
  return (str || "").length === 1;
}

function nextLabelOneChar(ch){
  // æ•°å­—
  if(ch >= "0" && ch <= "9"){
    const n = Number(ch);
    if(Number.isFinite(n)) return String(n+1);
  }
  // è‹±å­—
  if(ch >= "a" && ch <= "z"){
    if(ch === "z") return "a";
    return String.fromCharCode(ch.charCodeAt(0)+1);
  }
  if(ch >= "A" && ch <= "Z"){
    if(ch === "Z") return "A";
    return String.fromCharCode(ch.charCodeAt(0)+1);
  }

  // ã²ã‚‰ãŒãªãƒ»ã‚«ã‚¿ã‚«ãƒŠï¼ˆç°¡æ˜“ï¼šäº”åéŸ³é †ãƒ†ãƒ¼ãƒ–ãƒ«ï¼‰
  const hira = "ã‚ã„ã†ãˆãŠã‹ããã‘ã“ã•ã—ã™ã›ããŸã¡ã¤ã¦ã¨ãªã«ã¬ã­ã®ã¯ã²ãµã¸ã»ã¾ã¿ã‚€ã‚ã‚‚ã‚„ã‚†ã‚ˆã‚‰ã‚Šã‚‹ã‚Œã‚ã‚ã‚’ã‚“";
  const kata = "ã‚¢ã‚¤ã‚¦ã‚¨ã‚ªã‚«ã‚­ã‚¯ã‚±ã‚³ã‚µã‚·ã‚¹ã‚»ã‚½ã‚¿ãƒãƒ„ãƒ†ãƒˆãƒŠãƒ‹ãƒŒãƒãƒãƒãƒ’ãƒ•ãƒ˜ãƒ›ãƒãƒŸãƒ ãƒ¡ãƒ¢ãƒ¤ãƒ¦ãƒ¨ãƒ©ãƒªãƒ«ãƒ¬ãƒ­ãƒ¯ãƒ²ãƒ³";

  const hi = hira.indexOf(ch);
  if(hi !== -1){
    return hira[(hi+1) % hira.length];
  }
  const ka = kata.indexOf(ch);
  if(ka !== -1){
    return kata[(ka+1) % kata.length];
  }

  // ãã®ä»–ï¼šè‡ªå‹•å…¥åŠ›å¯¾è±¡å¤–
  return null;
}

function buildSeatIds(start, count){
  const ids = [];
  const s = (start || "").trim();
  if(!s || count <= 0) return ids;

  if(isSingleChar(s)){
    let cur = s;
    for(let i=0;i<count;i++){
      ids.push(cur);
      const nx = nextLabelOneChar(cur);
      if(!nx) break;
      cur = nx;
    }
    // ã‚‚ã—è‡ªå‹•å…¥åŠ›ãŒé€”ä¸­ã§æ­¢ã¾ã£ãŸã‚‰ã€ä½œã‚ŒãŸåˆ†ã ã‘ã«ã™ã‚‹
    return ids;
  }else{
    // è¤‡æ•°æ–‡å­—ã¯è‡ªå‹•å…¥åŠ›ãªã—ï¼šåŒã˜ãƒ©ãƒ™ãƒ«ã¯ä½¿ãˆãªã„ã®ã§ã€æœ«å°¾ã« _2 ã‚’ä»˜ã‘ã‚‹ç­‰â€¦ã¯é¿ã‘ã‚‹
    // ä»•æ§˜ä¸Šã€Œè‡ªå‹•å…¥åŠ›ã—ãªã„ã€ãªã®ã§ã€ã“ã“ã§ã¯1å¸­ã ã‘ä½œã‚‹ï¼ˆæ­¢ã‚ãªã„ãŒäº‹æ•…ã‚‚é˜²ãï¼‰
    return [s];
  }
}

function groupByName(name){
  return state.seatSetup.groups.filter(g=> g.name===name);
}

/* ===== Seat Data integration =====
  state.seatsï¼šãƒ¡ã‚¤ãƒ³è¡¨ç¤ºç”¨
  ã“ã“ã§ã¯ã€Œå¸­ç•ªå·ï¼seat.idã€ã¨ã—ã¦ç”Ÿæˆã—ã€å­˜åœ¨ã—ãªã„å¸­ã ã‘è¿½åŠ ã™ã‚‹
*/
function ensureSeatExists(id){
  if(state.seats.some(s=> s.id===id)) return;
  state.seats.push({id, name:"", status:"empty", people:0, total:0, bills:0});
}

/* ===== Name UI ===== */
function allNameButtons(){
  // customNames ã¯ã€Œãã®ä»–ã®å‰ã€ã«è¡¨ç¤º
  const arr = [];
  const othersIdx = state.seatSetup.baseNames.indexOf("ãã®ä»–");
  state.seatSetup.baseNames.forEach((n, i)=>{
    if(i===othersIdx){
      state.seatSetup.customNames.forEach(c=> arr.push(c));
    }
    arr.push(n);
  });
  return arr;
}

function renderNameGrid(){
  const grid = $("ssNameGrid");
  grid.innerHTML = "";
  const names = allNameButtons();

  names.forEach(n=>{
    const b = document.createElement("button");
    b.className = "seatCard";
    b.style.minHeight = "56px";
    b.style.alignItems = "center";
    b.style.justifyContent = "center";
    b.style.fontWeight = "900";
    b.textContent = n;

    const on = (state.seatSetup.selectedName === n);
    if(on){
      b.style.outline = "2px solid rgba(122,167,255,0.9)";
      b.style.background = "rgba(122,167,255,0.14)";
    }

    b.onclick = ()=>{
      // å†ã‚¿ãƒƒãƒ—ã§è§£é™¤
      state.seatSetup.selectedName = (state.seatSetup.selectedName===n) ? null : n;
      renderNameGrid();
    };

    grid.appendChild(b);
  });
}

$("ssNameCommit").onclick = ()=>{
  const pick = state.seatSetup.selectedName;
  if(!pick){
    toast("åç§°ã‚’é¸æŠã—ã¦ãã ã•ã„");
    return;
  }

  if(pick==="ãã®ä»–"){
    // ãã®ä»–ã¯ã€Œæ–°è¦åç§°è¿½åŠ ã€ãƒ¢ãƒ¼ãƒ€ãƒ«
    openModal(
      "åç§°è¿½åŠ ï¼ˆãã®ä»–ï¼‰",
      `
        <div style="margin-bottom:6px">åç§°</div>
        <input id="ssNewName" class="btn" style="width:100%; text-align:left" placeholder="ä¾‹ï¼šä¸­åº­ãƒ†ãƒ©ã‚¹A1" />
      `,
      [
        {label:"è¿½åŠ ", primary:true, onClick:()=>{
          const v = ($("ssNewName").value||"").trim();
          if(!v){ toast("åç§°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"); return; }
          // æ—¢å­˜ã¨é‡è¤‡ã¯è¨±å®¹ã—ãªã„ï¼ˆäº‹æ•…é˜²æ­¢ï¼‰
          const exists = allNameButtons().includes(v);
          if(exists){ toast("åŒã˜åç§°ãŒã‚ã‚Šã¾ã™"); return; }

          state.seatSetup.customNames.push(v);
          // è¿½åŠ ã—ãŸåç§°ã‚’é¸æŠçŠ¶æ…‹ã«ã—ã¦æ±ºå®šã‚‚å®Œäº†æ‰±ã„
          state.seatSetup.selectedName = v;
          state.seatSetup.committedName = v;

          closeModal();
          renderNameGrid();
          toast("åç§°ã‚’è¿½åŠ ã—ã¾ã—ãŸ");
        }},
        {label:"æˆ»ã‚‹", onClick:()=> closeModal()},
      ]
    );
    return;
  }

  state.seatSetup.committedName = pick;
  toast(`åç§°ï¼š${pick}`);
};

/* ===== Count UI ===== */
function applyDefaultCountByName(name){
  // åˆæœŸå€¤ãƒ«ãƒ¼ãƒ«ï¼ˆæœ€æ–°ï¼‰ï¼š
  // ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ï¼ç«‹ã¡ï¼ãã®ä»–ï¼ˆï¼‹ãã®ä»–ã§ä½œæˆã—ãŸåç§°ï¼‰ã¯ 1
  // ãƒ†ãƒ¼ãƒ–ãƒ«ï¼åº§æ•·ï¼å€‹å®¤ ã¯ 4
  if(name==="ãƒ†ãƒ¼ãƒ–ãƒ«" || name==="åº§æ•·" || name==="å€‹å®¤"){
    state.seatSetup.count = 4;
  }else{
    state.seatSetup.count = 1;
  }
  $("ssCntVal").textContent = String(state.seatSetup.count);
}

$("ssCntMinus").onclick = ()=>{
  state.seatSetup.count = Math.max(0, state.seatSetup.count - 1);
  $("ssCntVal").textContent = String(state.seatSetup.count);
};
$("ssCntPlus").onclick = ()=>{
  state.seatSetup.count = state.seatSetup.count + 1;
  $("ssCntVal").textContent = String(state.seatSetup.count);
};

/* committedNameãŒæ±ºã¾ã£ãŸã‚‰åˆæœŸå€¤ã‚’åˆã‚ã›ã‚‹ */
(function hookNameDefaultCount(){
  if(hookNameDefaultCount._done) return;
  const _toast = toast;
  toast = function(msg, ms){
    _toast(msg, ms);
    if(msg && msg.startsWith("åç§°ï¼š")){
      const name = state.seatSetup.committedName;
      applyDefaultCountByName(name);
    }
  };
  hookNameDefaultCount._done = true;
})();

/* ===== Save ===== */
$("ssSave").onclick = ()=>{
  const name = state.seatSetup.committedName;
  const cnt = Number(state.seatSetup.count||0);
  const start = ($("ssStartLabel").value||"").trim();

  if(!name){
    toast("åç§°ã‚’æ±ºå®šã—ã¦ãã ã•ã„");
    return;
  }
  if(cnt <= 0){
    toast("ç®±ã®æ•°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
    return;
  }
  if(!start){
    toast("é–‹å§‹æ–‡å­—ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
    return;
  }

  const seatIds = buildSeatIds(start, cnt);
  if(seatIds.length===0){
    toast("å¸­ç•ªå·ã‚’ä½œã‚Œã¾ã›ã‚“ã§ã—ãŸ");
    return;
  }

  // ç”Ÿæˆã—ãŸå¸­ç•ªå·ãŒæ—¢ã«å­˜åœ¨ã™ã‚‹å ´åˆã€é‡è¤‡ã¯ä½œã‚‰ãªã„ï¼ˆæ­¢ã‚ãªã„ãŒäº‹æ•…é˜²æ­¢ï¼‰
  const unique = [];
  seatIds.forEach(id=>{
    if(state.seats.some(s=> s.id===id)){
      // æ—¢ã«ã‚ã‚‹å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—
      return;
    }
    unique.push(id);
    ensureSeatExists(id);
  });

  const gid = "g" + Math.random().toString(36).slice(2);
  state.seatSetup.groups.push({
    gid,
    name,
    seatIds: unique,
    createdTs: nowTs()
  });

  // ãƒ¡ã‚¤ãƒ³ç”»é¢ã¸å³åæ˜ 
  renderSeatsWithHighlight();
  renderGroups();

  // å…¥åŠ›æ¬„ã‚’è»½ããƒªã‚»ãƒƒãƒˆï¼ˆäº‹æ•…é˜²æ­¢ï¼šäºŒé‡ç™»éŒ²é˜²æ­¢ï¼‰
  $("ssStartLabel").value = "";
  state.seatSetup.count = 0;
  $("ssCntVal").textContent = "0";

  toast("å¸­ã‚’ä½œæˆã—ã¾ã—ãŸ");
};

/* ===== Groups Render ===== */
function renderGroups(){
  const box = $("ssGroups");
  box.innerHTML = "";

  if(state.seatSetup.groups.length===0){
    box.innerHTML = `<div class="pill">ã¾ã ä½œæˆã•ã‚Œã¦ã„ã¾ã›ã‚“</div>`;
    return;
  }

  // åç§°ã”ã¨ã«ã¾ã¨ã‚ã‚‹ï¼ˆä¿å­˜ã®ä¸‹ã«ã€3åˆ—ç¹°ã‚Šè¿”ã—ï¼‰
  const byName = {};
  state.seatSetup.groups.forEach(g=>{
    if(!byName[g.name]) byName[g.name] = [];
    byName[g.name].push(g);
  });

  Object.keys(byName).forEach(name=>{
    const wrap = document.createElement("div");
    wrap.style.marginBottom = "14px";

    const head = document.createElement("button");
    head.className = "btn";
    head.style.width = "100%";
    head.style.textAlign = "left";
    head.style.fontWeight = "900";
    head.textContent = name;

    head.onclick = ()=> openGroupEditor(name);

    wrap.appendChild(head);

    // å¸­ç•ªå·ã‚’3åˆ—ã§è¡¨ç¤º
    const grid = document.createElement("div");
    grid.className = "seatGrid";
    grid.style.marginTop = "10px";

    // ãã®åç§°ã«å±ã™ã‚‹å…¨seatIds
    const ids = byName[name].flatMap(g=> g.seatIds);
    ids.forEach(id=>{
      const c = document.createElement("div");
      c.className = "seatCard";
      c.style.minHeight = "56px";
      c.style.display = "flex";
      c.style.alignItems = "center";
      c.style.justifyContent = "center";
      c.style.fontWeight = "900";
      c.textContent = id;
      grid.appendChild(c);
    });

    wrap.appendChild(grid);
    box.appendChild(wrap);
  });
}

/* ===== Group Editor ===== */
function openGroupEditor(name){
  // ç·¨é›†ç”»é¢ï¼šæˆ»ã‚‹ï¼åç§°å¤‰æ›´ï¼å‰Šé™¤
  openModal(
    "åç§°",
    `
      <div class="pill" style="margin-bottom:10px">${name}</div>
      <div style="display:flex; gap:10px; margin-bottom:10px">
        <button class="btn" id="geBack">æˆ»ã‚‹</button>
        <button class="btn primary" id="geRename">åç§°å¤‰æ›´</button>
        <button class="btn" id="geDelete">å‰Šé™¤</button>
      </div>
      <div class="pill" style="margin-bottom:8px">å¸­ä¸€è¦§</div>
      <div id="geSeats"></div>
    `,
    [
      {label:"é–‰ã˜ã‚‹", onClick:()=> closeModal()}
    ]
  );

  // å¸­ä¸€è¦§ï¼ˆç•ªå·å¤‰æ›´ãƒœã‚¿ãƒ³ï¼‹å‰Šé™¤ã‚¹ãƒ©ã‚¤ãƒ‰ï¼‰
  setTimeout(()=>{
    const list = $("geSeats");
    const groups = groupByName(name);
    const ids = groups.flatMap(g=> g.seatIds);

    if(ids.length===0){
      list.innerHTML = `<div class="pill">å¸­ãŒã‚ã‚Šã¾ã›ã‚“</div>`;
      return;
    }

    list.innerHTML = "";
    ids.forEach(id=>{
      const seat = state.seats.find(s=> s.id===id);
      const inUse = seat && seat.status !== "empty";
      const row = document.createElement("div");
      row.className = "kRow";
      row.innerHTML = `
        <div class="kLeft">
          <div class="kSeat">${id}</div>
          <div class="kName" style="color:${inUse ? "var(--danger)" : "var(--text)"}">
            ${inUse ? "ä½¿ç”¨ä¸­ã®ãŸã‚å‰Šé™¤ä¸å¯" : ""}
          </div>
        </div>
        <div class="kSlide" style="flex-direction:column; align-items:flex-end; gap:6px">
          <button class="btn" data-rename-seat="${id}">ç•ªå·å¤‰æ›´</button>
          <input class="kRange" data-del-seat="${id}" type="range" min="0" max="100" value="0" ${inUse ? "disabled" : ""}/>
        </div>
      `;
      list.appendChild(row);
    });

    // æˆ»ã‚‹
    $("geBack").onclick = ()=> closeModal();

    // åç§°å¤‰æ›´
    $("geRename").onclick = ()=>{
      openModal(
        "åç§°å¤‰æ›´",
        `
          <div style="margin-bottom:6px">æ–°ã—ã„åç§°</div>
          <input id="geNewName" class="btn" style="width:100%; text-align:left" value="${name}" />
        `,
        [
          {label:"å¤‰æ›´", primary:true, onClick:()=>{
            const v = ($("geNewName").value||"").trim();
            if(!v){ toast("åç§°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"); return; }
            // é‡è¤‡ã¯ä¸å¯
            const exists = Object.keys((function(){
              const map={};
              state.seatSetup.groups.forEach(g=> map[g.name]=1);
              return map;
            })()).includes(v);
            if(exists && v!==name){ toast("åŒã˜åç§°ãŒã‚ã‚Šã¾ã™"); return; }

            // groups ã®åç§°æ›´æ–°
            state.seatSetup.groups.forEach(g=>{
              if(g.name===name) g.name=v;
            });

            // customNamesã«å­˜åœ¨ã™ã‚‹å ´åˆã‚‚æ›´æ–°
            state.seatSetup.customNames = state.seatSetup.customNames.map(x=> x===name ? v : x);

            closeModal();
            renderNameGrid();
            renderGroups();
            toast("åç§°ã‚’å¤‰æ›´ã—ã¾ã—ãŸ");
          }},
          {label:"æˆ»ã‚‹", onClick:()=> closeModal()},
        ]
      );
    };

    // åç§°å‰Šé™¤ï¼ˆç¢ºèªâ†’ã‚¹ãƒ©ã‚¤ãƒ‰ã§ç¢ºå®šã€åç§°å†…ã®å…¨å¸­ã‚’å‰Šé™¤ï¼‰
    $("geDelete").onclick = ()=>{
      openModal(
        "å‰Šé™¤ç¢ºèª",
        `
          <div class="pill" style="margin-bottom:8px; color:var(--danger)">ã“ã®åç§°ã¨åç§°å†…ã®å…¨å¸­ã‚’å‰Šé™¤ã—ã¾ã™</div>
          <div class="pill" style="margin-bottom:10px">ä½¿ç”¨ä¸­ã®å¸­ãŒã‚ã‚‹å ´åˆã¯å‰Šé™¤ã§ãã¾ã›ã‚“</div>
          <input id="geDelSlide" class="kRange" type="range" min="0" max="100" value="0"/>
        `,
        [
          {label:"æˆ»ã‚‹", onClick:()=> closeModal()}
        ]
      );

      setTimeout(()=>{
        const slide = $("geDelSlide");
        slide.onchange = ()=>{
          if(Number(slide.value||0) < 88){ slide.value = 0; return; }

          // ä½¿ç”¨ä¸­ãƒã‚§ãƒƒã‚¯
          const ids2 = groupByName(name).flatMap(g=> g.seatIds);
          const blocked = ids2.some(id=>{
            const seat = state.seats.find(s=> s.id===id);
            return seat && seat.status !== "empty";
          });
          if(blocked){
            slide.value = 0;
            toast("ä½¿ç”¨ä¸­ã®å¸­ãŒã‚ã‚‹ãŸã‚å‰Šé™¤ã§ãã¾ã›ã‚“");
            return;
          }

          // seatsã‹ã‚‰å‰Šé™¤
          ids2.forEach(id=>{
            state.seats = state.seats.filter(s=> s.id!==id);
          });

          // groupså‰Šé™¤
          state.seatSetup.groups = state.seatSetup.groups.filter(g=> g.name!==name);

          // customNamesã‹ã‚‰ã‚‚å‰Šé™¤ï¼ˆè©²å½“ã™ã‚‹å ´åˆï¼‰
          state.seatSetup.customNames = state.seatSetup.customNames.filter(x=> x!==name);

          closeModal();
          closeModal(); // ç·¨é›†ç”»é¢ã‚‚é–‰ã˜ã‚‹
          renderSeatsWithHighlight();
          renderGroups();
          renderNameGrid();
          toast("å‰Šé™¤ã—ã¾ã—ãŸ");
        };
      },0);
    };

    // å¸­ç•ªå·å¤‰æ›´
    list.querySelectorAll("[data-rename-seat]").forEach(btn=>{
      btn.onclick = ()=>{
        const oldId = btn.getAttribute("data-rename-seat");
        openModal(
          "å¸­ç•ªå·å¤‰æ›´",
          `
            <div style="margin-bottom:6px">ç¾åœ¨ï¼š${oldId}</div>
            <div style="margin-bottom:6px">æ–°ã—ã„å¸­ç•ªå·</div>
            <input id="geSeatNewId" class="btn" style="width:100%; text-align:left" placeholder="ä¾‹ï¼šA / 1 / ã‚" />
          `,
          [
            {label:"å¤‰æ›´", primary:true, onClick:()=>{
              const newId = ($("geSeatNewId").value||"").trim();
              if(!newId){ toast("å¸­ç•ªå·ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"); return; }
              if(state.seats.some(s=> s.id===newId)){ toast("åŒã˜å¸­ç•ªå·ãŒã‚ã‚Šã¾ã™"); return; }

              // seatæœ¬ä½“å¤‰æ›´ï¼ˆä½¿ç”¨ä¸­ã§ã‚‚ç•ªå·å¤‰æ›´ã¯è¨±å¯ï¼šç¾å ´ã§ã¯èµ·ã“ã‚Šå¾—ã‚‹ã€‚æ­¢ã‚ãªã„ï¼‰
              const seat = state.seats.find(s=> s.id===oldId);
              if(seat) seat.id = newId;

              // groupså†…ã®seatIdsã‚‚å¤‰æ›´
              state.seatSetup.groups.forEach(g=>{
                if(g.name===name){
                  g.seatIds = g.seatIds.map(x=> x===oldId ? newId : x);
                }
              });

              closeModal();
              renderSeatsWithHighlight();
              renderGroups();
              toast("å¸­ç•ªå·ã‚’å¤‰æ›´ã—ã¾ã—ãŸ");
            }},
            {label:"æˆ»ã‚‹", onClick:()=> closeModal()},
          ]
        );
      };
    });

    // å€‹åˆ¥å¸­å‰Šé™¤ï¼ˆã‚¹ãƒ©ã‚¤ãƒ‰ç¢ºå®šãƒ»ç¢ºèªãªã—ï¼‰
    list.querySelectorAll("[data-del-seat]").forEach(sl=>{
      sl.onchange = ()=>{
        if(sl.disabled) return;
        if(Number(sl.value||0) < 88){ sl.value = 0; return; }

        const id = sl.getAttribute("data-del-seat");
        const seat = state.seats.find(s=> s.id===id);
        if(seat && seat.status !== "empty"){
          sl.value = 0;
          toast("ä½¿ç”¨ä¸­ã®ãŸã‚å‰Šé™¤ã§ãã¾ã›ã‚“");
          return;
        }

        // seatsã‹ã‚‰å‰Šé™¤
        state.seats = state.seats.filter(s=> s.id!==id);
        // groupsã‹ã‚‰ã‚‚å‰Šé™¤
        state.seatSetup.groups.forEach(g=>{
          if(g.name===name){
            g.seatIds = g.seatIds.filter(x=> x!==id);
          }
        });

        // ç©ºã«ãªã£ãŸã‚°ãƒ«ãƒ¼ãƒ—ã¯å‰Šé™¤
        state.seatSetup.groups = state.seatSetup.groups.filter(g=> !(g.name===name && g.seatIds.length===0));

        renderSeatsWithHighlight();
        renderGroups();
        toast("å‰Šé™¤ã—ã¾ã—ãŸ");
      };
    });

  },0);
}

/* ===== showScreenæ‹¡å¼µ ===== */
(function hookShowScreenForSeatSetup(){
  if(showScreen._ssHooked) return;
  const _show = showScreen;
  showScreen = function(id){
    _show(id);
    if(id==="scrSeatSetup"){
      renderNameGrid();
      renderGroups();
    }
  };
  showScreen._ssHooked = true;
})();

/* åˆæœŸæç”» */
renderNameGrid();
renderGroups();

/* =========================
  ã“ã“ã‹ã‚‰å…ˆã¯ PART7 ã§ç¶šã
========================= */
/* =========================
  PART7ï¼šåŒæœŸãƒ»ç«¯æœ«ç®¡ç†ãƒ»ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ï¼ˆä¿å­˜ï¼‰
  å½¹å‰²ï¼šğŸ“¶/ğŸ“¶âŒè¡¨ç¤ºãƒ»æœªåŒæœŸã‚¤ãƒ™ãƒ³ãƒˆã‚­ãƒ¥ãƒ¼ãƒ»ä¿å­˜ã§å†é€ãƒ»10åˆ†ãŠãé™ã‹ãªè©¦è¡Œãƒ»ç«¯æœ«3å°åˆ¶é™
  æ–¹é‡ï¼šå‹æ‰‹ã«åŒæœŸã—ãªã„ï¼ç¾å ´ã‚’æ­¢ã‚ãªã„ï¼æ¶ˆã•ãªã„ï¼å·®åˆ†ã‚¤ãƒ™ãƒ³ãƒˆã§æ•´åˆ
========================= */

/* ===== Storage helpers ===== */
function loadStore(){
  try{
    const raw = localStorage.getItem(KEY);
    if(!raw) return null;
    return JSON.parse(raw);
  }catch(e){
    return null;
  }
}
function saveStore(obj){
  localStorage.setItem(KEY, JSON.stringify(obj));
}

/* ===== Device ID / Device limit (FREE: 3) ===== */
function getDeviceId(){
  const k = KEY + "_DEVICE_ID";
  let id = localStorage.getItem(k);
  if(!id){
    id = "dev_" + Math.random().toString(36).slice(2);
    localStorage.setItem(k, id);
  }
  return id;
}

state.sync = state.sync || {
  deviceId: getDeviceId(),
  devices: [],           // ç«¯æœ«IDä¸€è¦§
  pending: [],           // æœªåŒæœŸã‚¤ãƒ™ãƒ³ãƒˆ
  lastTryTs: 0,
  maxDevicesFree: 3,
};

function ensureDeviceRegistered(){
  const st = loadStore() || {};
  st.devices = st.devices || [];
  if(!st.devices.includes(state.sync.deviceId)){
    st.devices.push(state.sync.deviceId);
  }
  state.sync.devices = st.devices.slice();
  saveStore(st);

  // 3å°åˆ¶é™ï¼ˆè¶…éã—ã¦ã‚‚ãƒ­ãƒ¼ã‚«ãƒ«æ“ä½œã¯å¯èƒ½ãƒ»åŒæœŸã ã‘ä¸å¯ï¼‰
  const canSync = state.sync.devices.length <= state.sync.maxDevicesFree;
  state.sync.canSync = canSync;
  return canSync;
}

/* ===== Persist app state ===== */
function persistAll(){
  const st = loadStore() || {};
  st.devices = state.sync.devices.slice();
  st.seats = state.seats;
  st.seatSetup = state.seatSetup;
  st.kitchen = state.kitchen;
  st.sales = state.sales;
  st.fix = state.fix;
  st.pending = state.sync.pending;
  st.updatedTs = nowTs();
  saveStore(st);
}

function restoreAll(){
  const st = loadStore();
  if(!st) return;

  if(Array.isArray(st.seats)) state.seats = st.seats;
  if(st.seatSetup) state.seatSetup = st.seatSetup;
  if(st.kitchen) state.kitchen = st.kitchen;
  if(st.sales) state.sales = st.sales;
  if(st.fix) state.fix = st.fix;

  state.sync.devices = Array.isArray(st.devices) ? st.devices : [];
  state.sync.pending = Array.isArray(st.pending) ? st.pending : [];

  // åŒæœŸçŠ¶æ…‹è¡¨ç¤º
  setSync(state.sync.pending.length === 0);
}

/* ===== Event queue (å·®åˆ†ã‚¤ãƒ™ãƒ³ãƒˆ) ===== */
function emitEvent(type, payload){
  const ev = {
    id: "ev_" + Math.random().toString(36).slice(2),
    type,
    ts: nowTs(),
    deviceId: state.sync.deviceId,
    payload: payload || {}
  };
  state.sync.pending.push(ev);
  // æœªåŒæœŸãŒã‚ã‚‹ï¼ğŸ“¶âŒ
  setSync(false);
  persistAll();
  // å–¶æ¥­ä¸­ï¼šæ“ä½œã”ã¨ã«åŒæœŸã‚’è©¦ã¿ã‚‹ï¼ˆãŸã ã—é€£æ‰“ã—ãªã„ãƒ»1å›ã ã‘è»½ãï¼‰
  trySyncOnceSilent();
}

/* ===== Sync attempt (ç–‘ä¼¼) ===== */
function canActuallySync(){
  // ç«¯æœ«3å°åˆ¶é™
  if(!ensureDeviceRegistered()){
    return false;
  }
  // é€šä¿¡ç’°å¢ƒï¼ˆç–‘ä¼¼ï¼‰ï¼šã‚ªãƒ³ãƒ©ã‚¤ãƒ³ã ã‘æˆåŠŸæ‰±ã„
  if(typeof navigator !== "undefined" && navigator.onLine === false){
    return false;
  }
  return true;
}

function trySyncOnceSilent(){
  // å‹æ‰‹ã«å†è©¦è¡Œã¯ã—ãªã„æ€æƒ³ã‚’å®ˆã‚‹ãŸã‚ã€
  // é€šå¸¸æ“ä½œã§ã®åŒæœŸã¯ã€Œ1å›ã ã‘è»½ãã€è©¦ã™ï¼ˆå¤±æ•—ã—ã¦ã‚‚é€šçŸ¥ãªã—ï¼‰
  if(state.sync.pending.length === 0) return;
  const now = nowTs();
  // é€£æ‰“é˜²æ­¢ï¼šç›´è¿‘10ç§’ä»¥å†…ã¯è©¦ã•ãªã„
  if(now - state.sync.lastTryTs < 10_000) return;
  state.sync.lastTryTs = now;

  if(!canActuallySync()){
    // ğŸ“¶âŒã®ã¾ã¾ï¼ˆé™ã‹ï¼‰
    return;
  }

  // æˆåŠŸæ‰±ã„ï¼špendingã‚’ã‚¯ãƒªã‚¢ï¼ˆæœ¬ç‰©ã®å®Ÿè£…ã§ã¯ã‚µãƒ¼ãƒãƒ¼é€ä¿¡å¾Œã«ã‚¯ãƒªã‚¢ï¼‰
  state.sync.pending = [];
  setSync(true);
  persistAll();
}

function manualSync(){
  // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã€ŒåŒæœŸé–‹å§‹ã€ã‚’æŠ¼ã—ãŸæ™‚ã ã‘ã€ã¾ã¨ã‚ã¦å†é€
  if(state.sync.pending.length === 0){
    setSync(true);
    toast("åŒæœŸã•ã‚Œã¦ã„ã¾ã™");
    return;
  }

  // 3å°åˆ¶é™ã®èª¬æ˜
  if(!ensureDeviceRegistered()){
    openModal(
      "åŒæœŸ",
      "ç„¡æ–™ç‰ˆã§ã¯åŒæœŸã§ãã‚‹ç«¯æœ«ã¯3å°ã¾ã§ã§ã™<br>æœ‰æ–™ç‰ˆã§ã¯åˆ©ç”¨å¯èƒ½ãªç«¯æœ«æ•°ãŒå¢—ãˆã¾ã™",
      [{label:"æˆ»ã‚‹", onClick:()=> closeModal()}]
    );
    return;
  }

  if(!canActuallySync()){
    // å¤±æ•—ï¼šé€šçŸ¥ã¯æœ€å°ï¼ˆãƒˆãƒ¼ã‚¹ãƒˆï¼‰
    toast("åŒæœŸã§ãã¾ã›ã‚“ã§ã—ãŸï¼ˆé›»æ³¢çŠ¶æ³ã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼‰");
    setSync(false);
    persistAll();
    return;
  }

  // æˆåŠŸ
  state.sync.pending = [];
  setSync(true);
  persistAll();
  toast("åŒæœŸã—ã¾ã—ãŸ");
}

/* ===== Auto silent trial (ç¢ºå®šï¼šæœªåŒæœŸãŒã‚ã‚‹æ™‚ã®ã¿ 10åˆ†ãŠãã«1å›) ===== */
(function startAutoTrial(){
  if(startAutoTrial._started) return;
  startAutoTrial._started = true;

  setInterval(()=>{
    if(state.sync.pending.length === 0) return;
    // é™ã‹ã«1å›ã ã‘è©¦è¡Œï¼ˆé€šçŸ¥ãªã—ï¼‰
    trySyncOnceSilent();
  }, 10 * 60 * 1000);
})();

/* ===== Save (ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—) ===== */
function openSaveModal(){
  openModal(
    "ä¿å­˜",
    "æ³¨æ–‡ãƒ»ä¼šè¨ˆãƒ»å¸­æƒ…å ±ã¯ç«¯æœ«é–“ã§è‡ªå‹•åŒæœŸã•ã‚Œã¾ã™ï¼ˆé›»æ³¢çŠ¶æ³ãŒè‰¯å¥½ãªå ´åˆï¼‰<br><br>âš ï¸ å–¶æ¥­çµ‚äº†æ™‚ãƒ»é€€å‹¤æ™‚ã«ã¯å¿…ãšä¿å­˜ã‚’è¡Œã£ã¦ãã ã•ã„",
    [
      {label:"ç¢ºå®šä¿å­˜", primary:true, onClick:()=>{
        closeModal();
        performSave();
      }},
      {label:"æˆ»ã‚‹", onClick:()=> closeModal()},
    ]
  );
}

function performSave(){
  // 1) ç«¯æœ«å†…ãƒ‡ãƒ¼ã‚¿ã‚’ç¢ºå®šä¿å­˜
  ensureDeviceRegistered();
  persistAll();

  // 2) æœªåŒæœŸã‚¤ãƒ™ãƒ³ãƒˆãŒã‚ã‚Œã°ã€Œæ˜ç¤ºçš„åŒæœŸã€ã‚’è©¦ã¿ã‚‹ï¼ˆä¿å­˜ï¼å†åŒæœŸï¼‰
  if(state.sync.pending.length){
    manualSync();
  }else{
    setSync(true);
    toast("ä¿å­˜ã—ã¾ã—ãŸ");
  }
}

/* ===== Antenna tap behavior (ç¢ºå®šä»•æ§˜) ===== */
function openSyncModal(){
  if(state.sync.pending.length === 0 && state.sync.canSync !== false){
    openModal("åŒæœŸ", "åŒæœŸã•ã‚Œã¦ã„ã¾ã™", [
      {label:"æˆ»ã‚‹", onClick:()=> closeModal()}
    ]);
    return;
  }

  // ç«¯æœ«åˆ¶é™ã«å¼•ã£ã‹ã‹ã£ã¦ã„ã‚‹å ´åˆ
  if(state.sync.canSync === false){
    openModal(
      "åŒæœŸ",
      "ç„¡æ–™ç‰ˆã§ã¯åŒæœŸã§ãã‚‹ç«¯æœ«ã¯3å°ã¾ã§ã§ã™<br>æœ‰æ–™ç‰ˆã§ã¯åˆ©ç”¨å¯èƒ½ãªç«¯æœ«æ•°ãŒå¢—ãˆã¾ã™",
      [
        {label:"æˆ»ã‚‹", onClick:()=> closeModal()}
      ]
    );
    return;
  }

  openModal(
    "åŒæœŸ",
    "åŒæœŸã•ã‚Œã¦ã„ã¾ã›ã‚“<br>é›»æ³¢çŠ¶æ³ã‚„ä¸€æ™‚çš„ãªä¸å…·åˆã®å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™<br>ä¿å­˜ã‚’è¡Œã†ã¨å†åŒæœŸã‚’è©¦ã¿ã¾ã™",
    [
      {label:"åŒæœŸé–‹å§‹", primary:true, onClick:()=>{
        closeModal();
        manualSync();
      }},
      {label:"æˆ»ã‚‹", onClick:()=> closeModal()},
    ]
  );
}

/* ===== Hook header buttons (ä¸Šæ›¸ã) ===== */
(function hookHeaderButtonsPart7(){
  // ä¿å­˜ãƒœã‚¿ãƒ³ï¼šPART1ã®ä»®å‡¦ç†ã‚’ä¸Šæ›¸ã
  $("btnSave").onclick = ()=> openSaveModal();

  // ã‚¢ãƒ³ãƒ†ãƒŠï¼šPART1ã®ä»®å‡¦ç†ã‚’ä¸Šæ›¸ã
  $("btnAntenna").onclick = ()=> openSyncModal();
})();

/* ===== Patch operations to emit events (å·®åˆ†) ===== */
(function patchOps(){
  // å¸­ç§»å‹•
  if(typeof doSeatMove === "function" && !doSeatMove._patched){
    const _m = doSeatMove;
    doSeatMove = function(fromId, toId){
      _m(fromId, toId);
      emitEvent("seat_move", {fromId, toId});
    };
    doSeatMove._patched = true;
  }

  // ä¼šè¨ˆåˆç®—
  if(typeof doMerge === "function" && !doMerge._patched){
    const _g = doMerge;
    doMerge = function(seat, pickedBills){
      _g(seat, pickedBills);
      emitEvent("bill_merge", {seatId: seat.id, pickedBills});
    };
    doMerge._patched = true;
  }

  // ä¼šè¨ˆåˆ†å‰²
  if(typeof doSplit === "function" && !doSplit._patched){
    const _s = doSplit;
    doSplit = function(seat){
      _s(seat);
      emitEvent("bill_split", {seatId: seat.id});
    };
    doSplit._patched = true;
  }

  // å¸­ç™»éŒ² ä¿å­˜ï¼ˆPART6ã®onclickã‚’ãƒ©ãƒƒãƒ—ï¼‰
  if($("ssSave") && !$("ssSave")._patched){
    const old = $("ssSave").onclick;
    $("ssSave").onclick = ()=>{
      // oldãŒæˆåŠŸã—ãŸã‹ã¯å³å¯†ã«ã¯åˆ¤å®šã—ãªã„ï¼ˆæ­¢ã‚ãªã„æ€æƒ³ï¼‰
      old && old();
      emitEvent("seat_setup_save", {ts: nowTs()});
    };
    $("ssSave")._patched = true;
  }
})();

/* ===== Boot (restore + device register) ===== */
(function bootPart7(){
  ensureDeviceRegistered();
  restoreAll();

  // pendingãŒã‚ã‚Œã°ğŸ“¶âŒ
  if(state.sync.pending.length){
    setSync(false);
  }else{
    setSync(true);
  }

  // ç«¯æœ«åˆ¶é™ã®çŠ¶æ…‹ã‚’åæ˜ 
  ensureDeviceRegistered();
})();

/* =========================
  ã“ã“ã‹ã‚‰å…ˆã¯ PART8 ã§ç¶šã
========================= */
/* =========================
  PART8ï¼šè¨­å®šãƒ»ãƒ˜ãƒ«ãƒ—ãƒ»æœ‰æ–™å°ç·š ï¼‹ ãƒ¡ãƒ‹ãƒ¥ãƒ¼ç™»éŒ²
  å½¹å‰²ï¼šå–¶æ¥­ä¸­ã¯åŸºæœ¬è§¦ã‚‰ãªã„é ˜åŸŸï¼è‡ªå·±è§£æ±ºï¼å•ã„åˆã‚ã›ï¼æœ‰æ–™æ¡ˆå†…ï¼ˆæ§ãˆã‚ï¼‰
        ï¼‹ ãƒ¡ãƒ‹ãƒ¥ãƒ¼ç™»éŒ²ï¼ˆæ–™ç†/ãƒ‰ãƒªãƒ³ã‚¯â†’ã‚¸ãƒ£ãƒ³ãƒ«â†’å•†å“ç™»éŒ²ï¼‰
  é‡è¦ï¼šã“ã“ã§HTMLã‚’é–‰ã˜ã¦8åˆ†å‰²å®Œæˆ
========================= */

/* =========================================================
   A) è¨­å®šï¼ˆscrSettingsï¼‰
========================================================= */
(function buildSettingsUI(){
  const scr = $("scrSettings");
  scr.innerHTML = `
    <div class="pill" style="margin-bottom:10px">è¨­å®š</div>

    <button class="btn" id="goHelp" style="width:100%; margin-bottom:10px">ãƒ˜ãƒ«ãƒ— / Q&A</button>
    <button class="btn" id="goContact" style="width:100%; margin-bottom:10px">ãŠå•åˆã›</button>
    <button class="btn" id="goTerms" style="width:100%; margin-bottom:10px">åˆ©ç”¨æ¡ä»¶ãƒ»æ³¨æ„äº‹é …</button>

    <div style="height:10px"></div>

    <div class="pill" style="margin-bottom:8px">ç„¡æ–™ç‰ˆã«ã¤ã„ã¦</div>
    <div class="pill" style="color:var(--muted); margin-bottom:10px">
      ãƒ»åˆ©ç”¨å¯èƒ½ç«¯æœ«ï¼šæœ€å¤§3å°<br>
      ãƒ»ãƒ‡ãƒ¼ã‚¿ã®å¾©æ—§ã€ä¿è¨¼ãªã—<br>
      ãƒ»ã‚µãƒãƒ¼ãƒˆã¯é™å®šçš„
    </div>

    <div class="pill" style="margin-bottom:8px">æœ‰æ–™ç‰ˆã®ã”æ¡ˆå†…</div>
    <div class="pill" style="color:var(--muted); margin-bottom:10px">
      ãƒ»åˆ©ç”¨ç«¯æœ«æ•°ã®æ‹¡å¼µ<br>
      ãƒ»ãƒ‡ãƒ¼ã‚¿ã®å®‰å…¨ãªä¿å­˜<br>
      ãƒ»ã‚µãƒãƒ¼ãƒˆå¯¾å¿œ<br>
      ãƒ»ç¨ç†å£«ã€ä¼šè¨ˆã‚½ãƒ•ãƒˆå‘ã‘ãƒ‡ãƒ¼ã‚¿å‡ºåŠ›<br>
      ãƒ»å£²ä¸Šåˆ†æã€ã‚°ãƒ©ãƒ•è¡¨ç¤º<br>
      ãƒ»AIã«ã‚ˆã‚‹æ–™ç†ãƒ»ãƒ¡ãƒ‹ãƒ¥ãƒ¼ææ¡ˆ<br>
      ãƒ»å°†æ¥è¿½åŠ ã•ã‚Œã‚‹æ–°æ©Ÿèƒ½
    </div>

    <div class="pill" style="margin-bottom:8px">ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±</div>
    <div class="pill" style="color:var(--muted)">
      ONE<br>
      Versionï¼šFREE 0.1.0<br>
      æ›´æ–°æ—¥ï¼š2026/02/10<br>
      ç¾åœ¨ã¯ç„¡æ–™ç‰ˆã§ã™
    </div>
  `;
})();

/* =========================================================
   B) ãƒ˜ãƒ«ãƒ— / Q&Aï¼ˆãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤ºï¼‰
========================================================= */
const QA_LIST = [
  {q:"ä¼šè¨ˆåˆç®—ã¯ã©ã†ã‚„ã£ã¦è¡Œã„ã¾ã™ã‹ï¼Ÿ", a:"åŒã˜å¸­å†…ã«ã‚ã‚‹è¤‡æ•°ã®ä¼šè¨ˆã‚’ã€ä¼šè¨ˆåˆç®—ãƒœã‚¿ãƒ³ã§ã¾ã¨ã‚ã¾ã™ã€‚åˆ¥ã®å¸­åŒå£«ã‚’ç›´æ¥åˆç®—ã™ã‚‹ã“ã¨ã¯ã§ãã¾ã›ã‚“ã€‚åˆ¥å¸­ã‚’ã¾ã¨ã‚ãŸã„å ´åˆã¯ã€å…ˆã«å¸­ç§»å‹•ã§åŒã˜å¸­ã«é›†ã‚ã¦ãã ã•ã„ã€‚"},
  {q:"åˆ¥ã®å¸­åŒå£«ã‚’ç›´æ¥åˆç®—ã§ããªã„ã®ã¯ãªãœã§ã™ã‹ï¼Ÿ", a:"æ“ä½œãƒŸã‚¹ã‚„ä¼šè¨ˆäº‹æ•…ã‚’é˜²ããŸã‚ã§ã™ã€‚ONEã§ã¯ã€Œå¸­ï¼ä¼šè¨ˆã®ç®±ã€ã¨ã—ã¦ç®¡ç†ã—ã¦ã„ã‚‹ãŸã‚ã€åˆç®—ã¯å¿…ãšåŒä¸€å¸­å†…ã§è¡Œã†è¨­è¨ˆã«ãªã£ã¦ã„ã¾ã™ã€‚"},
  {q:"å¸­ç§»å‹•ã¨ä¼šè¨ˆåˆç®—ã®é•ã„ã¯ä½•ã§ã™ã‹ï¼Ÿ", a:"å¸­ç§»å‹•ã¯ã€ç‰©ç†çš„ã«ãŠå®¢ã•ã¾ãŒå¸­ã‚’ç§»ã£ãŸæ™‚ã®æ“ä½œã§ã™ã€‚ä¼šè¨ˆåˆç®—ã¯ã€åŒã˜å¸­ã®ä¸­ã«ã‚ã‚‹ä¼šè¨ˆã‚’ã¾ã¨ã‚ã‚‹æ“ä½œã§ã™ã€‚ç›®çš„ãŒé•ã†ãŸã‚ã€æ“ä½œã‚‚åˆ†ã‹ã‚Œã¦ã„ã¾ã™ã€‚"},
  {q:"ä¼šè¨ˆåˆ†å‰²ã¯ã„ã¤ã§ãã¾ã™ã‹ï¼Ÿ", a:"åŒä¸€å¸­å†…ã§ã€åˆç®—ã•ã‚Œã¦ã„ã‚‹ä¼šè¨ˆã‚’å…ƒã«æˆ»ã—ãŸã„æ™‚ã«è¡Œã„ã¾ã™ã€‚ãªãŠã€åˆç®—å¾Œã«è¿½åŠ ã•ã‚ŒãŸæ³¨æ–‡ã¯åˆ†å‰²ã§ãã¾ã›ã‚“ã€‚"},
  {q:"å•†å“ãŒæ¥ãªã‹ã£ãŸå ´åˆã®ä¿®æ­£æ–¹æ³•ã¯ï¼Ÿ", a:"ä¼šè¨ˆç¢ºå®šå‰ã§ã‚ã‚Œã°ã€æ³¨æ–‡ç”»é¢ã‹ã‚‰è©²å½“å•†å“ã‚’å–æ¶ˆã—ã¦ãã ã•ã„ã€‚å–æ¶ˆã¯ã€Œâˆ’æ³¨æ–‡ã€ã¨ã—ã¦å±¥æ­´ã«æ®‹ã‚Šã¾ã™ã€‚"},
  {q:"æ³¨æ–‡æ•°ã‚’é–“é•ãˆãŸæ™‚ã¯ã©ã†ãªã‚Šã¾ã™ã‹ï¼Ÿ", a:"æ³¨æ–‡ç”»é¢ã®ã€Œæ³¨æ–‡å±¥æ­´ã€ã‚’ã‚¿ãƒƒãƒ—ã™ã‚‹ã“ã¨ã§ä¿®æ­£ã§ãã¾ã™ã€‚æ³¨æ–‡å¾Œã§ã‚‚å–æ¶ˆãŒå¯èƒ½ã§ã€0ä»¥ä¸‹ã«ã¯ãªã‚Šã¾ã›ã‚“ã€‚ä¿®æ­£å†…å®¹ã¯å±¥æ­´ã¨ã—ã¦æ®‹ã‚Šã¾ã™ã€‚"},
  {q:"ã‚­ãƒƒãƒãƒ³ç”»é¢ã®ä¸¦ã³é †ã¯ã©ã†ãªã£ã¦ã„ã¾ã™ã‹ï¼Ÿ", a:"æœªèª¿ç†ã®å•†å“ãŒä¸Šã«è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚åŒã˜å•†å“ãŒã‚ã‚‹å ´åˆã¯ã€ã¾ã¨ã‚ã¦è¡¨ç¤ºã•ã‚Œã‚‹ãŸã‚ã€ã¾ã¨ã‚ã¦èª¿ç†ã—ã‚„ã™ããªã£ã¦ã„ã¾ã™ã€‚"},
  {q:"èª¿ç†å®Œäº†ã¯ã©ã†ã‚„ã£ã¦è¡Œã„ã¾ã™ã‹ï¼Ÿ", a:"è©²å½“å•†å“ã®ã‚¹ãƒ©ã‚¤ãƒ‰æ“ä½œã§èª¿ç†å®Œäº†ã¨ãªã‚Šã¾ã™ã€‚ã‚¿ãƒƒãƒ—ã ã‘ã§ã¯å®Œäº†ã—ãªã„ãŸã‚ã€èª¤æ“ä½œã‚’é˜²ã’ã¾ã™ã€‚"},
  {q:"æ³¨æ–‡å–æ¶ˆã¯ã‚­ãƒƒãƒãƒ³ã«ã©ã†è¡¨ç¤ºã•ã‚Œã¾ã™ã‹ï¼Ÿ", a:"å–æ¶ˆã•ã‚ŒãŸæ³¨æ–‡ã¯ã€ã‚­ãƒƒãƒãƒ³ç”»é¢ã‹ã‚‰è‡ªå‹•çš„ã«é™¤å¤–ã•ã‚Œã¾ã™ã€‚ã™ã§ã«æä¾›æ¸ˆã¿ã®å•†å“ã«ã¯å½±éŸ¿ã—ã¾ã›ã‚“ã€‚"},
  {q:"é›»æ³¢ãŒãªã„å ´æ‰€ã§ã‚‚ä½¿ãˆã¾ã™ã‹ï¼Ÿ", a:"ä½¿ãˆã¾ã™ã€‚æ³¨æ–‡ãƒ»ä¼šè¨ˆãƒ»å¸­æ“ä½œã¯ç«¯æœ«å†…ã«ä¿å­˜ã•ã‚Œã¾ã™ã€‚ãŸã ã—ã€ç«¯æœ«é–“ã§ã®ãƒ‡ãƒ¼ã‚¿å…±æœ‰ã¯è¡Œã‚ã‚Œãªã„ãŸã‚ã€é€šä¿¡ç’°å¢ƒãŒæ•´ã£ã¦ã„ã‚‹å ´æ‰€ã§ã®åˆ©ç”¨ã‚’æ¨å¥¨ã—ã¾ã™ã€‚"},
  {q:"åŒæœŸãƒãƒ¼ã‚¯âŒãŒå‡ºãŸæ™‚ã¯ã©ã†ã™ã‚Œã°ã„ã„ã§ã™ã‹ï¼Ÿ", a:"é›»æ³¢çŠ¶æ³ã‚„ä¸€æ™‚çš„ãªä¸å…·åˆã«ã‚ˆã‚Šã€åŒæœŸã§ãã¦ã„ãªã„çŠ¶æ…‹ã§ã™ã€‚é›»æ³¢ã®è‰¯ã„å ´æ‰€ã§åŒæœŸã‚’è¡Œã£ã¦ãã ã•ã„ã€‚çŠ¶æ³ã«ã‚ˆã£ã¦ã¯ã€è‡ªå‹•çš„ã«å†åŒæœŸã•ã‚Œã‚‹å ´åˆã‚‚ã‚ã‚Šã¾ã™ã€‚"},
  {q:"è¤‡æ•°ç«¯æœ«ã§åŒæ™‚ã«ä½¿ãˆã¾ã™ã‹ï¼Ÿ", a:"ç„¡æ–™ç‰ˆã§ã¯æœ€å¤§3å°ã¾ã§ä½¿ç”¨ã§ãã¾ã™ã€‚æ³¨æ–‡ç¢ºå®šã‚„ä¼šè¨ˆç¢ºå®šãªã©ã€æ±ºå®šã‚’ä¼´ã†æ“ä½œã”ã¨ã«ç«¯æœ«é–“ã§åŒæœŸã•ã‚Œã¾ã™ã€‚"},
  {q:"ãƒ‡ãƒ¼ã‚¿ã¯ã©ã“ã«ä¿å­˜ã•ã‚Œã¦ã„ã¾ã™ã‹ï¼Ÿ", a:"ã™ã¹ã¦ä½¿ç”¨ã—ã¦ã„ã‚‹ç«¯æœ«å†…ã«ä¿å­˜ã•ã‚Œã¾ã™ã€‚ç«¯æœ«ã®æ•…éšœãƒ»ç´›å¤±ãƒ»ä¸å…·åˆã«å‚™ãˆã€å£²ä¸Šç®¡ç†ã‹ã‚‰å®šæœŸçš„ã«ãƒ‡ãƒ¼ã‚¿ã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’è¡Œã£ã¦ãã ã•ã„ã€‚"},
  {q:"æ©Ÿç¨®å¤‰æ›´ã—ãŸå ´åˆã¯ã©ã†ãªã‚Šã¾ã™ã‹ï¼Ÿ", a:"ç«¯æœ«å†…ã®ãƒ‡ãƒ¼ã‚¿ã¯è‡ªå‹•ã§ã¯å¼•ãç¶™ãŒã‚Œã¾ã›ã‚“ã€‚äº‹å‰ã«ä¿å­˜ã‚„ãƒ‡ãƒ¼ã‚¿é€ä¿¡ã‚’è¡Œã£ã¦ãã ã•ã„ã€‚"},
  {q:"å–¶æ¥­çµ‚äº†æ™‚ã«å¿…ãšè¡Œã†ã“ã¨ã¯ï¼Ÿ", a:"ä¿å­˜æ“ä½œã‚’è¡Œã„ã€å¿…è¦ã«å¿œã˜ã¦å£²ä¸Šãƒ‡ãƒ¼ã‚¿ã‚’ãƒ¡ãƒ¼ãƒ«ãªã©ã§é€ä¿¡ã—ã¦ãã ã•ã„ã€‚ãƒ‡ãƒ¼ã‚¿ä¿å…¨ã®ãŸã‚ã«é‡è¦ã§ã™ã€‚"},
];

function openHelp(){
  const body = QA_LIST.map(x=>`
    <div class="pill" style="margin-bottom:6px; font-weight:900">Qï¼š${x.q}</div>
    <div class="pill" style="margin-bottom:12px; color:var(--muted)">Aï¼š${x.a}</div>
  `).join("");

  openModal("ãƒ˜ãƒ«ãƒ— / Q&A", body, [{label:"æˆ»ã‚‹", onClick:()=> closeModal()}]);
}

/* =========================================================
   C) ãŠå•åˆã›ï¼ˆãƒ¢ãƒ¼ãƒ€ãƒ«ï¼‰
========================================================= */
function openContact(){
  openModal(
    "ãŠå•åˆã›",
    `
      <div class="pill" style="margin-bottom:10px">
        ONEã«é–¢ã™ã‚‹ã”è³ªå•ãƒ»ä¸å…·åˆã®ã”é€£çµ¡ã¯ä¸‹è¨˜ã‚ˆã‚ŠãŠé¡˜ã„ã„ãŸã—ã¾ã™ã€‚
      </div>
      <div class="pill" style="color:var(--muted); margin-bottom:10px">
        ã”é€£çµ¡ã®éš›ã¯<br>
        ãƒ»åº—èˆ—å<br>
        ãƒ»ä½¿ç”¨ç«¯æœ«<br>
        ãƒ»ç™ºç”Ÿã—ãŸçŠ¶æ³<br>
        ã‚’è¨˜è¼‰ã„ãŸã ãã¨ã‚¹ãƒ ãƒ¼ã‚ºã§ã™ã€‚
      </div>
      <div class="pill">ãƒ»ãƒ¡ãƒ¼ãƒ«ã§å•ã„åˆã‚ã›ï¼ˆä»»æ„ï¼‰</div>
      <div class="pill">ãƒ»LINEã§å•ã„åˆã‚ã›ï¼ˆä»»æ„ï¼‰</div>
    `,
    [{label:"æˆ»ã‚‹", onClick:()=> closeModal()}]
  );
}

/* =========================================================
   D) åˆ©ç”¨æ¡ä»¶ãƒ»æ³¨æ„äº‹é …ï¼ˆå›ºå®šæ–‡è¨€ï¼‰
========================================================= */
function openTerms(){
  openModal(
    "åˆ©ç”¨æ¡ä»¶ãƒ»æ³¨æ„äº‹é …",
    `
      <div class="pill" style="margin-bottom:10px">
        ãƒ»ãƒ‡ãƒ¼ã‚¿ã¯ç«¯æœ«å†…ã«ä¿å­˜ã•ã‚Œã¾ã™<br>
        ãƒ»ç„¡æ–™ç‰ˆã§ã¯ãƒ‡ãƒ¼ã‚¿ã®å¾©æ—§ãƒ»ä¿è¨¼ã¯è¡Œã„ã¾ã›ã‚“<br>
        ãƒ»å–¶æ¥­çµ‚äº†æ™‚ã«ã¯ä¿å­˜ã‚’è¡Œã£ã¦ãã ã•ã„<br>
        ãƒ»ãƒ‡ãƒ¼ã‚¿ç®¡ç†ã¯åˆ©ç”¨è€…ã®è²¬ä»»ã§è¡Œã£ã¦ãã ã•ã„
      </div>
      <div class="pill" style="color:var(--muted)">
        â€» åˆå›èµ·å‹•ç”»é¢ã¨åŒä¸€å†…å®¹ï¼ˆæ–‡è¨€å›ºå®šï¼‰
      </div>
    `,
    [{label:"æˆ»ã‚‹", onClick:()=> closeModal()}]
  );
}

/* =========================================================
   E) ãƒ¡ãƒ‹ãƒ¥ãƒ¼ç™»éŒ²ï¼ˆscrMenuï¼‰
   ä»•æ§˜ï¼šã‚«ãƒ†ã‚´ãƒªãƒ¼ï¼ˆæ–™ç†/ãƒ‰ãƒªãƒ³ã‚¯ï¼‰â†’æ±ºå®šâ†’ã‚¸ãƒ£ãƒ³ãƒ«3åˆ—ï¼‹è¿½åŠ â†’ã‚¸ãƒ£ãƒ³ãƒ«æ±ºå®š/å‰Šé™¤â†’å•†å“ç™»éŒ²â†’ä¸€è¦§ç·¨é›†
========================================================= */
(function buildMenuUI(){
  const scr = $("scrMenu");
  scr.innerHTML = `
    <div class="pill" style="margin-bottom:10px">ãƒ¡ãƒ‹ãƒ¥ãƒ¼ç™»éŒ²</div>

    <!-- ã‚«ãƒ†ã‚´ãƒªãƒ¼ï¼šæ–™ç†/ãƒ‰ãƒªãƒ³ã‚¯ï¼ˆæ³¨æ–‡ã«ã¯å‡ºã•ãªã„ãƒ»ã‚­ãƒƒãƒãƒ³ã«åæ˜ ï¼‰ -->
    <div class="pill" style="margin-bottom:8px">ã‚«ãƒ†ã‚´ãƒªãƒ¼</div>
    <div style="display:flex; gap:10px; margin-bottom:8px">
      <div class="seatCard" id="catFood" style="flex:1; min-height:56px; display:flex; align-items:center; justify-content:center; font-weight:900">æ–™ç†</div>
      <div class="seatCard" id="catDrink" style="flex:1; min-height:56px; display:flex; align-items:center; justify-content:center; font-weight:900">ãƒ‰ãƒªãƒ³ã‚¯</div>
    </div>
    <button class="btn primary" id="catCommit" style="width:100%; margin-bottom:10px">æ±ºå®š</button>

    <div class="pill" style="color:var(--muted); margin-bottom:14px">
      ã‚«ãƒ†ã‚´ãƒªãƒ¼ï¼ˆæ–™ç†/ãƒ‰ãƒªãƒ³ã‚¯ï¼‰ã¯ã‚­ãƒƒãƒãƒ³ã®ã€Œæ–™ç†/ãƒ‰ãƒªãƒ³ã‚¯ã€è¡¨ç¤ºã«åæ˜ ã—ã¾ã™ï¼ˆæ³¨æ–‡ã«ã¯å‡ºã—ã¾ã›ã‚“ï¼‰ã€‚
    </div>

    <!-- ã‚¸ãƒ£ãƒ³ãƒ« -->
    <div id="genreArea" style="display:none">
      <div class="pill" style="margin-bottom:8px">ã‚¸ãƒ£ãƒ³ãƒ«</div>
      <div id="genreGrid" class="seatGrid" style="margin-bottom:8px"></div>
      <div style="display:flex; gap:10px; margin-bottom:14px">
        <button class="btn primary" id="genreDecide" style="flex:1">æ±ºå®š</button>
        <button class="btn" id="genreDelete" style="flex:1">å‰Šé™¤</button>
      </div>
    </div>

    <!-- å•†å“ç™»éŒ² -->
    <div id="itemArea" style="display:none">
      <div class="pill" style="margin-bottom:8px">ç™»éŒ²</div>

      <input id="itemName" class="btn" placeholder="å•†å“å" style="width:100%; text-align:left; margin-bottom:8px" />
      <input id="itemPrice" class="btn" placeholder="é‡‘é¡ï¼ˆæ•°å­—ï¼‰" inputmode="numeric" style="width:100%; text-align:left; margin-bottom:8px" />

      <div style="display:flex; gap:10px; margin-bottom:10px">
        <button class="btn" id="tax8" style="flex:1">8%</button>
        <button class="btn" id="tax10" style="flex:1">10%</button>
      </div>

      <button class="btn primary" id="itemAdd" style="width:100%; margin-bottom:14px">ç™»éŒ²</button>

      <div class="pill" style="margin-bottom:8px">ä½œã£ãŸå•†å“</div>
      <div id="itemList"></div>
    </div>
  `;
})();

/* ===== Menu state ===== */
state.menu = state.menu || {
  cat: null,             // "food" | "drink"
  genres: { food: [], drink: [] },  // ã‚¸ãƒ£ãƒ³ãƒ«ä¸€è¦§
  selectedGenre: null,
  tax: null,             // 8 or 10
  items: []              // {id, cat, genre, name, price, tax}
};

function setCardHL(el, on){
  el.style.outline = on ? "2px solid rgba(122,167,255,0.9)" : "";
  el.style.background = on ? "rgba(122,167,255,0.14)" : "";
}

function renderGenres(){
  const grid = $("genreGrid");
  grid.innerHTML = "";

  const list = state.menu.genres[state.menu.cat] || [];
  // æœ€å¾Œã«ã€Œã‚¸ãƒ£ãƒ³ãƒ«è¿½åŠ ã€
  const final = list.concat(["ï¼‹ ã‚¸ãƒ£ãƒ³ãƒ«è¿½åŠ "]);

  final.forEach(g=>{
    const c = document.createElement("div");
    c.className = "seatCard";
    c.style.minHeight="56px";
    c.style.display="flex";
    c.style.alignItems="center";
    c.style.justifyContent="center";
    c.style.fontWeight="900";
    c.textContent = g;

    const isAdd = (g==="ï¼‹ ã‚¸ãƒ£ãƒ³ãƒ«è¿½åŠ ");
    const on = (!isAdd && state.menu.selectedGenre===g);
    if(on) setCardHL(c,true);

    c.onclick = ()=>{
      if(isAdd){
        openModal(
          "ã‚¸ãƒ£ãƒ³ãƒ«è¿½åŠ ",
          `<input id="newGenre" class="btn" style="width:100%; text-align:left" placeholder="ã‚¸ãƒ£ãƒ³ãƒ«å" />`,
          [
            {label:"è¿½åŠ ", primary:true, onClick:()=>{
              const v = ($("newGenre").value||"").trim();
              if(!v){ toast("ã‚¸ãƒ£ãƒ³ãƒ«åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"); return; }
              const arr = state.menu.genres[state.menu.cat];
              if(arr.includes(v)){ toast("åŒã˜ã‚¸ãƒ£ãƒ³ãƒ«ãŒã‚ã‚Šã¾ã™"); return; }

              // ä½œã£ãŸã‚¸ãƒ£ãƒ³ãƒ«ã¯è¿½åŠ ãƒœãƒƒã‚¯ã‚¹ã®å‰ã«å…¥ã‚‹
              arr.push(v);
              state.menu.selectedGenre = v;

              closeModal();
              renderGenres();
            }},
            {label:"æˆ»ã‚‹", onClick:()=> closeModal()},
          ]
        );
        return;
      }

      state.menu.selectedGenre = (state.menu.selectedGenre===g) ? null : g;
      renderGenres();
    };

    grid.appendChild(c);
  });
}

function renderItems(){
  const box = $("itemList");
  box.innerHTML = "";

  const list = state.menu.items.filter(it=> it.cat===state.menu.cat && it.genre===state.menu.selectedGenre);

  if(list.length===0){
    box.innerHTML = `<div class="pill">ã¾ã ã‚ã‚Šã¾ã›ã‚“</div>`;
    return;
  }

  list.forEach(it=>{
    const row = document.createElement("div");
    row.className = "kRow";
    row.innerHTML = `
      <div class="kLeft">
        <div class="kName">${it.name}</div>
      </div>
      <div class="kSlide" style="gap:10px">
        <div style="font-weight:900">${yen(it.price)}</div>
        <div class="pill">${it.tax}%</div>
        <button class="btn" data-edit="${it.id}">ç·¨é›†</button>
      </div>
    `;
    box.appendChild(row);
  });

  box.querySelectorAll("[data-edit]").forEach(btn=>{
    btn.onclick = ()=>{
      const id = btn.getAttribute("data-edit");
      const it = state.menu.items.find(x=> x.id===id);
      if(!it) return;

      openModal(
        "ç·¨é›†",
        `
          <div class="pill" style="margin-bottom:8px">ã‚¸ãƒ£ãƒ³ãƒ«</div>
          <div class="pill" style="margin-bottom:8px">${it.genre}</div>

          <div style="margin-bottom:6px">å•†å“å</div>
          <input id="eName" class="btn" style="width:100%; text-align:left" value="${it.name}" />

          <div style="margin-top:10px;margin-bottom:6px">é‡‘é¡</div>
          <input id="ePrice" class="btn" style="width:100%; text-align:left" inputmode="numeric" value="${it.price}" />

          <div style="margin-top:10px;margin-bottom:6px">ç¨ç‡</div>
          <div style="display:flex; gap:10px">
            <button class="btn" id="e8" style="flex:1">8%</button>
            <button class="btn" id="e10" style="flex:1">10%</button>
          </div>
        `,
        [
          {label:"ä¿å­˜", primary:true, onClick:()=>{
            const nm = ($("eName").value||"").trim();
            const pr = Number(($("ePrice").value||"").trim());
            if(!nm || !Number.isFinite(pr) || pr<=0 || !(it.tax===8 || it.tax===10)){
              toast("æœªè¨˜å…¥ãŒã‚ã‚Šã¾ã™");
              return;
            }
            it.name = nm;
            it.price = pr;
            closeModal();
            renderItems();
            toast("æ›´æ–°ã—ã¾ã—ãŸ");
          }},
          {label:"æˆ»ã‚‹", onClick:()=> closeModal()},
        ]
      );

      // ç¨ç‡é¸æŠ
      setTimeout(()=>{
        const h = (v)=>{
          it.tax = v;
          $("e8").classList.toggle("primary", v===8);
          $("e10").classList.toggle("primary", v===10);
        };
        $("e8").onclick = ()=> h(8);
        $("e10").onclick = ()=> h(10);
        h(it.tax||10);
      },0);
    };
  });
}

/* ===== Menu interactions ===== */
(function hookMenu(){
  const food = $("catFood");
  const drink = $("catDrink");

  function pickCat(cat){
    state.menu.cat = cat;
    setCardHL(food, cat==="food");
    setCardHL(drink, cat==="drink");
  }

  food.onclick = ()=> pickCat("food");
  drink.onclick = ()=> pickCat("drink");

  $("catCommit").onclick = ()=>{
    if(!state.menu.cat){ toast("ã‚«ãƒ†ã‚´ãƒªãƒ¼ã‚’é¸æŠã—ã¦ãã ã•ã„"); return; }
    $("genreArea").style.display = "block";
    state.menu.selectedGenre = null;
    renderGenres();
  };

  $("genreDelete").onclick = ()=>{
    const g = state.menu.selectedGenre;
    if(!g){ toast("ã‚¸ãƒ£ãƒ³ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„"); return; }

    openModal(
      "å‰Šé™¤ç¢ºèª",
      "ã‚¸ãƒ£ãƒ³ãƒ«å†…ã®å•†å“ãŒå‰Šé™¤ã•ã‚Œã¾ã™",
      [
        {label:"æˆ»ã‚‹", onClick:()=> closeModal()},
        {label:"å‰Šé™¤ã‚¹ãƒ©ã‚¤ãƒ‰ã¸", primary:true, onClick:()=>{
          closeModal();
          openModal(
            "å‰Šé™¤",
            `
              <div class="pill" style="margin-bottom:10px; color:var(--danger)">
                ã‚¸ãƒ£ãƒ³ãƒ«ã€Œ${g}ã€ã¨ã‚¸ãƒ£ãƒ³ãƒ«å†…å•†å“ã‚’å‰Šé™¤ã—ã¾ã™
              </div>
              <input id="gDelSlide" class="kRange" type="range" min="0" max="100" value="0" />
            `,
            [{label:"æˆ»ã‚‹", onClick:()=> closeModal()}]
          );
          setTimeout(()=>{
            $("gDelSlide").onchange = ()=>{
              if(Number($("gDelSlide").value||0) < 88){ $("gDelSlide").value=0; return; }

              // ã‚¸ãƒ£ãƒ³ãƒ«å‰Šé™¤ï¼‹å•†å“å‰Šé™¤
              state.menu.items = state.menu.items.filter(it=> !(it.cat===state.menu.cat && it.genre===g));
              state.menu.genres[state.menu.cat] = state.menu.genres[state.menu.cat].filter(x=> x!==g);
              state.menu.selectedGenre = null;

              closeModal();
              renderGenres();
              $("itemArea").style.display = "none";
              toast("å‰Šé™¤ã—ã¾ã—ãŸ");
            };
          },0);
        }},
      ]
    );
  };

  $("genreDecide").onclick = ()=>{
    const g = state.menu.selectedGenre;
    if(!g){ toast("ã‚¸ãƒ£ãƒ³ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„"); return; }
    $("itemArea").style.display = "block";

    // ç¨ç‡åˆæœŸ
    const setTax = (v)=>{
      state.menu.tax = v;
      $("tax8").classList.toggle("primary", v===8);
      $("tax10").classList.toggle("primary", v===10);
    };
    $("tax8").onclick = ()=> setTax(8);
    $("tax10").onclick = ()=> setTax(10);
    setTax(10);

    renderItems();
  };

  $("itemAdd").onclick = ()=>{
    const g = state.menu.selectedGenre;
    const nm = ($("itemName").value||"").trim();
    const pr = Number(($("itemPrice").value||"").trim());
    const tx = state.menu.tax;

    if(!g || !nm || !Number.isFinite(pr) || pr<=0 || !(tx===8 || tx===10)){
      toast("æœªè¨˜å…¥ãŒã‚ã‚Šã¾ã™");
      return;
    }

    state.menu.items.push({
      id: "m_" + Math.random().toString(36).slice(2),
      cat: state.menu.cat,
      genre: g,
      name: nm,
      price: pr,
      tax: tx
    });

    // äºŒé‡ç™»éŒ²é˜²æ­¢ï¼šå…¥åŠ›æ¬„ã‚’ç©ºç™½ã«æˆ»ã™
    $("itemName").value = "";
    $("itemPrice").value = "";

    renderItems();
    toast("ç™»éŒ²ã—ã¾ã—ãŸ");
  };
})();

/* =========================================================
   F) è¨­å®šãƒœã‚¿ãƒ³å†…å°ç·š
========================================================= */
$("goHelp").onclick = ()=> openHelp();
$("goContact").onclick = ()=> openContact();
$("goTerms").onclick = ()=> openTerms();

/* ===== showScreenæ‹¡å¼µï¼ˆè¨­å®šãƒ»ãƒ¡ãƒ‹ãƒ¥ãƒ¼ï¼‰ ===== */
(function hookShowScreenPart8(){
  if(showScreen._p8Hooked) return;
  const _show = showScreen;
  showScreen = function(id){
    _show(id);
    if(id==="scrMenu"){
      // åˆæœŸè¡¨ç¤º
      state.menu.cat = null;
      state.menu.selectedGenre = null;
      $("genreArea").style.display = "none";
      $("itemArea").style.display = "none";
      setCardHL($("catFood"), false);
      setCardHL($("catDrink"), false);
    }
  };
  showScreen._p8Hooked = true;
})();

/* ===== èµ·å‹•ç›´å¾Œï¼šå¿…è¦ãªã‚‰åˆå›ç”»é¢ ===== */
(function openFirst(){
  // æ—¢ã«DOMæ§‹ç¯‰æ¸ˆã¿ãªã®ã§å³è¡¨ç¤ºã§ã‚‚OK
  // åˆæœŸã¯ãƒ¡ã‚¤ãƒ³ã¸
  showScreen("scrMain");
  renderSeatsWithHighlight();
})();

/* =========================
  ã“ã“ã¾ã§ã§ 8åˆ†å‰² å®Œæˆ
========================= */
</script>
</body>
</html>