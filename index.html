<!-- =========================
  PART1：Bデザイン土台（CSSだけで統一 / 機能は壊さない）
  - 上部固定 / 中央席カード / 下段固定 を別CSSで管理
  - 既存のHTML構造・ID・JSを壊さない（上書き最小）
  - rangeShort（濃いピンクバー＋濃い緑つまみ）
  - stepper（②の総席数UI用：PART6側で使える）
========================= -->
<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<meta name="theme-color" content="#174b2f" />
<title>ONE</title>

<style>
/* ===== 変数（B基準）===== */
:root{
  --sat: env(safe-area-inset-top);
  --sab: env(safe-area-inset-bottom);
  --sal: env(safe-area-inset-left);
  --sar: env(safe-area-inset-right);

  --ink: #173a27;
  --ink2:#1b4a31;

  --pageBg:#eaf4df;     /* 全体背景：うっすら若草 */
  --seatBg:#dff0c9;     /* 席カード塗り */
  --seatOn:#86df63;     /* 選択塗り（黄緑） */

  --darkG:#174b2f;      /* 濃い緑 */
  --moss:#3aa55b;       /* モスグリーン */
  --lime:#d9ff9a;       /* 白寄り明るい黄緑 */

  --pink:#c4587f;       /* スライダーバー（濃いピンク） */
  --thumb:#1e5a39;      /* スライダーつまみ（濃い緑） */

  --tanBg:#eadfcf;      /* 下段背景：薄茶 */
  --tanFill:#e2d3bf;    /* 下段ボタン塗り */
  --tanLineL:#f2eadf;   /* 外枠（白寄り薄茶） */
  --tanLineD:#6b4b2c;   /* 内線（濃い茶） */
  --tanInk:#2f2217;     /* 下段文字（濃い茶） */
}

/* ===== ベース（壊さない）===== */
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  font-family: system-ui, -apple-system, "Hiragino Sans", "Noto Sans JP", sans-serif;
  -webkit-font-smoothing: antialiased;
  background: var(--pageBg);
  color: var(--ink);
}
button,input,select,textarea{font:inherit}

/* ===== 画面コンテナ（既存 main.app を想定）===== */
main.app{
  min-height:100dvh;
  padding-left: calc(10px + var(--sal));
  padding-right: calc(10px + var(--sar));
}

/* ===== ✅上部固定（ヘッダー）===== */
/* 既存ヘッダーが .topBar / #topBar どちらでも効くようにする */
.topBar, #topBar, header.topBar{
  position:fixed;
  top:0; left:0; right:0;
  z-index:50;
  padding-top: var(--sat);
  padding-left: calc(10px + var(--sal));
  padding-right: calc(10px + var(--sar));
  height: calc(56px + var(--sat));
  background: linear-gradient(90deg, #1a5636 0%, #14452b 50%, #1a5636 100%);
}
.topBar::after, #topBar::after{
  content:"";
  position:absolute;
  left:0; right:0;
  bottom:0;
  height:2px;
  background:#77d86b; /* 境界ライン（明るめ緑） */
  opacity:.9;
}

/* ヘッダー内の並び（存在すれば使う） */
.topBarRow{
  height:56px;
  display:flex;
  align-items:center;
  gap:8px;
}

/* ONE枠（存在すれば使う） */
.brandBox{
  height:36px;
  width:92px;
  border-radius:12px;
  border:2px solid var(--lime);
  background: var(--darkG);
  display:flex;
  align-items:center;
  justify-content:center;
  font-weight:900;
  font-size:14px;
  color:#fff;
}
.brandBox .dot{margin-right:6px; color:#58ff7a}

/* アンテナ枠（存在すれば使う） */
.signalBox{
  height:34px;
  width:34px;
  border-radius:10px;
  background: var(--moss);
  display:grid;
  place-items:center;
}
.signalBox svg{display:block}
.signalBox .sigFill{fill:#fff}

/* ヘッダーボタン（存在すれば使う） */
.topBtns{margin-left:auto; display:flex; gap:8px}
.topBtn{
  height:30px;
  min-width:84px;
  border-radius:16px;
  border:2px solid var(--lime);
  background: var(--darkG);
  color:#fff;
  font-weight:400;
  font-size:15px;
  padding:2px 10px;
  display:flex;
  align-items:center;
  justify-content:center;
  line-height:1;
}
.topBtn.wKitchen{min-width:96px}

/* 既存の「メイン/キッチン/保存」ボタンが .btn の場合の保険（上部だけ細く） */
.topBar .btn, #topBar .btn{
  height:30px;
  padding:2px 10px;
  font-weight:400;
  font-size:15px;
  border:2px solid var(--lime);
  background: var(--darkG);
  color:#fff;
}

/* ===== ✅中央（席カード）===== */
/* 既存 seatGrid/seatCard をBデザインに寄せる（他用途は壊しにくい） */
.seatGrid{
  display:grid;
  grid-template-columns: repeat(3, minmax(0, 1fr));
  gap:8px;
  align-items:stretch;
}

/* 「席カード」っぽい要素にだけ効かせたいので、.seatCard を優先 */
.seatCard{
  position:relative;
  background: var(--seatBg);
  border-radius:16px;
  border:2px solid var(--darkG);
  box-shadow: inset 0 0 0 1px #ffffff; /* 内枠白 */
  min-height:150px;
  padding:6px;
  color: var(--ink);
  overflow:hidden;
}

/* 選択時（青やめて統一） */
.seatCard.on, .seatCard.active, .seatCard.selected{
  background: var(--seatOn);
  color:#fff;
  box-shadow: inset 0 0 0 1px #ffffff, 0 0 0 2px var(--lime);
}

/* 状態と金額の間に横線を入れたい時に使うクラス（JS側で追加してもOK） */
.seatDivider{
  position:absolute;
  left:6px; right:6px;
  bottom:32px;
  height:2px;
  background:#000;
  opacity:.35;
}

/* ===== ✅下段固定（3連）===== */
.bottomBar, #bottomBar, footer.bottomBar{
  position:fixed;
  left:0; right:0; bottom:0;
  z-index:50;
  padding-bottom: var(--sab);
  padding-left: calc(10px + var(--sal));
  padding-right: calc(10px + var(--sar));
  height: calc(76px + var(--sab));
  background: var(--tanBg);
}

/* 3連グループ（存在すれば使う） */
.navGroup{
  width:100%;
  display:flex;
  gap:0;
  border-radius:14px;
  overflow:hidden;
  border:2px solid var(--tanLineL);
  box-shadow: inset 0 0 0 1px var(--tanLineD);
  background: var(--tanFill);
}

/* 仕切り線（三重） */
.navSep{
  width:5px;
  background:
    linear-gradient(90deg,
      var(--tanLineL) 0 1px,
      var(--tanLineD) 1px 4px,
      var(--tanLineL) 4px 5px
    );
  flex:0 0 5px;
}

.navBtn{
  flex:1;
  height:60px;
  background: var(--tanFill);
  color: var(--tanInk);
  border:none;
  padding:2px 6px;
  font-weight:800;
  font-size:18px;
  line-height:1.05;
  display:flex;
  align-items:center;
  justify-content:center;
  text-align:center;
}

/* 選択時の“光る”は無し（指定） */
.navBtn.on, .navBtn.active{background: var(--tanFill); color: var(--tanInk)}

/* ===== rangeShort（短い・濃ピンク・濃緑つまみ）===== */
.range{
  width:100%;
  height:28px;
  -webkit-appearance:none;
  appearance:none;
  background: transparent;
}
.rangeShort{width:80%; margin:0 auto; display:block}
.range::-webkit-slider-runnable-track{
  height:20px;
  border-radius:12px;
  background: var(--pink);
  box-shadow: inset 0 0 0 2px rgba(0,0,0,.08);
}
.range::-moz-range-track{
  height:20px;
  border-radius:12px;
  background: var(--pink);
}
.range::-webkit-slider-thumb{
  -webkit-appearance:none;
  appearance:none;
  width:46px;
  height:46px;
  border-radius:50%;
  background: var(--thumb);
  border:0;
  margin-top:-13px;
  box-shadow: 0 6px 14px rgba(0,0,0,.18);
}
.range::-moz-range-thumb{
  width:46px;
  height:46px;
  border-radius:50%;
  background: var(--thumb);
  border:0;
  box-shadow: 0 6px 14px rgba(0,0,0,.18);
}

/* ===== stepper（②用）===== */
.stepper{display:flex; align-items:center; gap:8px}
.stepBtn{
  height:44px;
  width:56px;
  border-radius:16px;
  border:2px solid rgba(23,75,47,.6);
  background: rgba(223,240,201,.55);
  color: var(--ink);
  font-weight:900;
  font-size:18px;
}
.stepVal{
  flex:1;
  height:44px;
  border-radius:16px;
  border:2px solid rgba(23,75,47,.35);
  background: rgba(255,255,255,.55);
  display:flex;
  align-items:center;
  justify-content:center;
  font-weight:900;
  font-size:22px;
  color: var(--ink);
}
</style>
</head>

<body>
<!-- ここは「今のHTMLのまま」続ける（PART2〜に既にあるDOM/IDを壊さない） -->

<script>
/* 最小の保険だけ（既存があれば上書きしない） */
window.$ = window.$ || function(id){ return document.getElementById(id); };

<script>
/* 最小の保険だけ（既存があれば上書きしない） */
window.$ = window.$ || function(id){ return document.getElementById(id); };

<!-- =========================
  ここから先は PART2 で続く
========================= -->
/* =========================
  PART2：注文（本来の構成に復元）＋席タップ動線（空席/予約/来店/合流）＋席移動（復活）
  重要：
   - “弾かれる”原因になりやすい touchend preventDefault はやらない
   - dblclick のみ軽く抑止（入力/モーダル内は除外）
   - ID衝突回避：注文UIのIDは orderCatFood / orderCatDrink 等
========================= */


/* =========================================================
   0) 軽いズーム抑止（dblclickのみ）
   ※ touchend preventDefault はクリックが死ぬ事があるのでやらない
========================================================= */
(function preventDoubleTapZoomSafe(){
  if(preventDoubleTapZoomSafe._done) return;
  preventDoubleTapZoomSafe._done = true;

  document.addEventListener("dblclick", function(e){
    const t = e.target;
    if(
      t && t.closest &&
      (
        t.closest("input,textarea,select,button,[contenteditable='true'],label") ||
        t.closest("#modalBackdrop,.modal,.modalCard,.sheet,.dialog,.overlay,.modalMask,[role='dialog']")
      )
    ){
      return; // 絶対に邪魔しない
    }
    if(e.cancelable) e.preventDefault();
  }, {passive:false});
})();


/* =========================================================
   1) 注文UI（ID衝突しない版）
========================================================= */
(function buildOrderUI_v3(){
  if(buildOrderUI_v3._built) return;
  buildOrderUI_v3._built = true;

  const scr = $("scrOrder");
  scr.innerHTML = `
    <!-- 上部：注文 / 席番号 / 会計（入口） -->
    <div style="display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:10px">
      <div style="font-weight:1000; font-size:22px">注文</div>
      <div style="font-weight:1000; opacity:.9" id="orderSeatLabel"></div>
      <button class="btn lime" id="orderGoPay">会計</button>
    </div>

    <!-- 中部上段：料理/ドリンク/戻る -->
    <div style="display:flex; gap:10px; margin-bottom:10px">
      <button class="btn" id="orderCatFood" style="flex:1">料理</button>
      <button class="btn" id="orderCatDrink" style="flex:1">ドリンク</button>
      <button class="btn" id="orderBackMain" style="flex:1">戻る</button>
    </div>

    <!-- ジャンル（3列） -->
    <div id="orderGenreWrap" style="display:none; margin-bottom:12px">
      <div class="seatGrid" id="orderGenreGrid"></div>
    </div>

    <!-- 商品（3列）＋戻る -->
    <div id="orderItemsWrap" style="display:none; margin-bottom:12px">
      <div style="display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:10px">
        <div style="font-weight:1000; font-size:20px" id="orderPickedGenre"></div>
        <button class="btn" id="orderItemsBack">戻る</button>
      </div>
      <div class="seatGrid" id="orderItemsGrid"></div>
    </div>

    <!-- 注文履歴（縦） -->
    <div style="margin-top:10px">
      <div style="font-weight:1000; margin-bottom:8px; font-size:20px">注文履歴</div>
      <div id="orderHistory"></div>
    </div>
  `;
})();


/* =========================================================
   2) 注文データ（壊さない：足すだけ）
========================================================= */
function getOrderBucket(seat, subId){
  if(seat.merged){
    const b = ensureSub(seat, subId);
    b.orders = b.orders || [];       // 集計
    b.orderLog = b.orderLog || [];   // 履歴
    return b;
  }
  seat.orders = seat.orders || [];
  seat.orderLog = seat.orderLog || [];
  return seat;
}

function upsertOrderAgg(bucket, item, delta){
  let o = (bucket.orders||[]).find(x=> x.itemId===item.id);
  const d = Number(delta||0);

  if(!o){
    if(d <= 0) return;
    bucket.orders.push({ itemId:item.id, name:item.name, price:item.price, tax:item.tax, qty:d, cat:item.cat, genre:item.genre });
    return;
  }
  o.qty = Number(o.qty||0) + d;
  if(o.qty <= 0){
    bucket.orders = bucket.orders.filter(x=> x.itemId!==item.id);
  }
}

function pushOrderLog(bucket, item, delta, reason){
  bucket.orderLog = bucket.orderLog || [];
  bucket.orderLog.unshift({
    id: "ol_" + Math.random().toString(36).slice(2),
    ts: nowTs(),
    itemId: item.id,
    name: item.name,
    delta: Number(delta||0),
    reason: reason || "",
  });
}

function formatHM(ts){
  const d = new Date(ts);
  return `${pad2(d.getHours())}:${pad2(d.getMinutes())}`;
}


/* =========================================================
   3) 注文状態
========================================================= */
state.order = state.order || { seatId:null, subId:null, cat:null, genre:null };


/* =========================================================
   4) 注文レンダリング
========================================================= */
function setBtnHL(btn, on){
  btn.classList.toggle("lime", !!on);
}

function listGenresByCat(cat){
  return (state.menu?.genres?.[cat] || []).slice();
}

function listItemsBy(cat, genre){
  return (state.menu?.items || []).filter(it=> it.cat===cat && it.genre===genre);
}

function renderOrder_v3(){
  const seat = seatById(state.order.seatId);
  if(!seat){ showScreen("scrMain"); return; }

  const subId = state.order.subId || seat.id;
  $("orderSeatLabel").textContent = seat.merged ? `${seat.mergeLabel} / ${subId}` : `${seat.id}`;

  // 会計入口（会計画面は別パートで実装）
  $("orderGoPay").onclick = ()=> toast("会計（別パートで実装）");

  // メインへ戻る
  $("orderBackMain").onclick = ()=>{
    state.order.cat = null;
    state.order.genre = null;
    showScreen("scrMain");
  };

  const foodBtn = $("orderCatFood");
  const drinkBtn = $("orderCatDrink");

  foodBtn.onclick = ()=> toggleCat("food");
  drinkBtn.onclick = ()=> toggleCat("drink");

  function toggleCat(cat){
    if(state.order.cat === cat){
      state.order.cat = null;
      state.order.genre = null;
      renderOrder_v3();
      return;
    }
    state.order.cat = cat;
    state.order.genre = null;
    renderOrder_v3();
  }

  setBtnHL(foodBtn, state.order.cat==="food");
  setBtnHL(drinkBtn, state.order.cat==="drink");

  const gw = $("orderGenreWrap");
  const gg = $("orderGenreGrid");
  const iw = $("orderItemsWrap");
  const ig = $("orderItemsGrid");

  gg.innerHTML = "";
  ig.innerHTML = "";

  if(!state.order.cat){
    gw.style.display = "none";
    iw.style.display = "none";
  }else{
    const genres = listGenresByCat(state.order.cat);
    gw.style.display = "block";
    iw.style.display = "none";

    if(genres.length===0){
      gg.innerHTML = `<div class="panel muted">ジャンルがありません。先にメニュー登録をしてください。</div>`;
    }else{
      genres.forEach(g=>{
        const b = document.createElement("div");
        b.className = "seatCard";
        b.style.minHeight="66px";
        b.style.display="flex";
        b.style.alignItems="center";
        b.style.justifyContent="center";
        b.style.fontWeight="1000";
        b.style.fontSize="18px";
        b.textContent = g;
        b.onclick = ()=>{
          state.order.genre = g;
          renderOrder_v3();
        };
        gg.appendChild(b);
      });
    }
  }

  if(state.order.cat && state.order.genre){
    gw.style.display = "none";
    iw.style.display = "block";
    $("orderPickedGenre").textContent = state.order.genre;

    $("orderItemsBack").onclick = ()=>{
      state.order.genre = null;
      renderOrder_v3();
    };

    const items = listItemsBy(state.order.cat, state.order.genre);
    if(items.length===0){
      ig.innerHTML = `<div class="panel muted">このジャンルに商品がありません</div>`;
    }else{
      items.forEach(it=>{
        const c = document.createElement("div");
        c.className = "seatCard";
        c.style.minHeight="96px";
        c.style.display="flex";
        c.style.flexDirection="column";
        c.style.justifyContent="space-between";
        c.innerHTML = `
          <div style="font-weight:1000; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; font-size:18px">${it.name}</div>
          <div style="opacity:.9; font-weight:1000; font-size:18px">${yen(it.price)}</div>
        `;
        c.onclick = ()=> openOrderDeltaModal_v3(seat, subId, it);
        ig.appendChild(c);
      });
    }
  }

  renderOrderHistory_v3(seat, subId);
}

function openOrderDeltaModal_v3(seat, subId, item){
  const bucket = getOrderBucket(seat, subId);
  let delta = 0;

  openModal(
    "注文",
    `
      <div style="font-weight:1000; font-size:20px; margin-bottom:10px">${item.name}</div>
      <div class="muted" style="margin-bottom:14px">${yen(item.price)} / 税${item.tax}%</div>

      <div style="display:flex; align-items:center; justify-content:center; gap:12px; margin-bottom:14px">
        <button class="btn" id="odMinus" style="min-width:72px">◀︎</button>
        <div class="pill" id="odVal" style="min-width:120px">0</div>
        <button class="btn lime" id="odPlus" style="min-width:72px">▶︎</button>
      </div>

      <div class="muted">※ 追加する数を選んでください（0なら追加なし）</div>
    `,
    [
      {label:"戻る", lime:false, onClick:()=> closeModal()},
      {label:"決定", lime:true, onClick:()=>{
        if(delta===0){ closeModal(); return; }

        upsertOrderAgg(bucket, item, delta);
        pushOrderLog(bucket, item, delta, "追加");

        seat.status = "in";
        seat.people = Math.max(1, Number(seat.people||1));
        seat.bills = 1;

        const sum = calcOrdersTotal(bucket.orders || []);
        if(seat.merged){
          bucket.total = sum;
          seat.total = calcSeatTotal(seat);
        }else{
          seat.total = sum;
        }

        if(typeof emitEvent==="function") emitEvent("order_delta", {seatId: seat.id, subId, itemId: item.id, delta});

        closeModal();
        renderSeats();
        renderOrder_v3();
      }},
    ],
    seat.id
  );

  setTimeout(()=>{
    const setVal = ()=> $("odVal").textContent = String(delta);

    $("odMinus").onclick = ()=>{
      if(delta<=0) return;
      delta -= 1;
      setVal();
    };
    $("odPlus").onclick = ()=>{
      delta += 1;
      setVal();
    };

    setVal();
  },0);
}

function renderOrderHistory_v3(seat, subId){
  const bucket = getOrderBucket(seat, subId);
  const box = $("orderHistory");
  box.innerHTML = "";

  const agg = (bucket.orders || []).slice().sort((a,b)=> (b.qty||0) - (a.qty||0));
  if(agg.length===0){
    box.innerHTML = `<div class="panel muted">まだありません</div>`;
    return;
  }

  agg.forEach(a=>{
    const row = document.createElement("div");
    row.style.border = "none";
    row.style.borderRadius = "26px";
    row.style.padding = "12px";
    row.style.background = "var(--panel)";
    row.style.marginBottom = "10px";

    row.innerHTML = `
      <div style="display:flex; justify-content:space-between; gap:10px; align-items:center">
        <div style="min-width:0">
          <div style="font-weight:1000; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; font-size:18px">${a.name} × ${a.qty}</div>
          <div class="muted" style="margin-top:4px; font-weight:1000; font-size:18px">${yen((Number(a.price||0) * Number(a.qty||0)))}</div>
        </div>
        <button class="btn" data-hfix="${a.itemId}">修正</button>
      </div>
    `;
    box.appendChild(row);

    row.querySelector(`[data-hfix="${a.itemId}"]`).onclick = ()=>{
      openHistoryConfirm_v3(seat, subId, a.itemId);
    };
  });
}


/* =========================================================
   5) 履歴 → 確認 → 修正（保持）
========================================================= */
const ORDER_FIX_REASONS = ["未提供","数え間違い","注文取り違い","提供済み取消","その他"];

function openHistoryConfirm_v3(seat, subId, itemId){
  const bucket = getOrderBucket(seat, subId);
  const agg = (bucket.orders || []).find(x=> x.itemId===itemId);
  if(!agg) return;

  const logs = (bucket.orderLog || []).filter(l=> l.itemId===itemId).slice(0, 8);
  const lines = logs.map(l=>`
    <div style="display:flex; justify-content:space-between; gap:10px; padding:8px 0; border-bottom:1px solid rgba(0,0,0,0.08)">
      <div class="muted">${formatHM(l.ts)}</div>
      <div style="font-weight:1000">${l.name}</div>
      <div style="font-weight:1000">${l.delta>0?`+${l.delta}`:String(l.delta)}</div>
    </div>
  `).join("");

  openModal(
    "修正確認",
    `
      <div style="font-weight:1000; font-size:18px; margin-bottom:8px">${agg.name} × ${agg.qty}</div>
      <div class="muted" style="margin-bottom:10px">注文履歴</div>
      <div>${lines || `<div class="panel muted">履歴がありません</div>`}</div>
      <div style="height:10px"></div>
      <div style="font-weight:1000">修正しますか？</div>
    `,
    [
      {label:"戻る", lime:false, onClick:()=> closeModal()},
      {label:"修正", lime:true, onClick:()=>{
        closeModal();
        openHistoryFix_v3(seat, subId, itemId);
      }},
    ],
    seat.id
  );
}

function openHistoryFix_v3(seat, subId, itemId){
  const bucket = getOrderBucket(seat, subId);
  const agg = (bucket.orders || []).find(x=> x.itemId===itemId);
  if(!agg) return;

  let delta = 0;

  openModal(
    "修正",
    `
      <div style="font-weight:1000; font-size:20px; margin-bottom:8px">${agg.name}</div>
      <div class="muted" style="margin-bottom:12px">現在：${agg.qty}</div>

      <div style="margin-bottom:8px; font-weight:1000">理由（必須）</div>
      <select id="ofWhy" class="btn full" style="text-align:left">
        <option value="">選択してください</option>
        ${ORDER_FIX_REASONS.map(x=> `<option value="${x}">${x}</option>`).join("")}
      </select>

      <div style="margin-top:14px; font-weight:1000; margin-bottom:8px">変更（差分）</div>
      <div style="display:flex; align-items:center; justify-content:center; gap:12px; margin-bottom:10px">
        <button class="btn" id="ofMinus" style="min-width:72px">◀︎</button>
        <div class="pill" id="ofVal" style="min-width:140px">0</div>
        <button class="btn lime" id="ofPlus" style="min-width:72px">▶︎</button>
      </div>

      <div class="muted">※ 合計が0未満にはできません</div>
    `,
    [
      {label:"戻る", lime:false, onClick:()=> closeModal()},
      {label:"決定", lime:true, onClick:()=>{
        const reason = $("ofWhy").value || "";
        if(!reason){ toast("理由を選択してください"); return; }

        const after = Number(agg.qty||0) + Number(delta||0);
        if(after < 0){ toast("0未満にはできません"); return; }

        const item = { id: agg.itemId, name: agg.name, price: agg.price, tax: agg.tax, cat: agg.cat, genre: agg.genre };
        upsertOrderAgg(bucket, item, delta);
        pushOrderLog(bucket, item, delta, reason);

        const sum = calcOrdersTotal(bucket.orders || []);
        if(seat.merged){
          bucket.total = sum;
          seat.total = calcSeatTotal(seat);
        }else{
          seat.total = sum;
        }

        if(typeof emitEvent==="function") emitEvent("order_fix", {seatId: seat.id, subId, itemId, delta, reason});

        closeModal();
        renderSeats();
        renderOrder_v3();
        toast("修正しました");
      }},
    ],
    seat.id
  );

  setTimeout(()=>{
    const setVal = ()=>{
      const s = delta>0 ? `+${delta}` : String(delta);
      $("ofVal").textContent = s; // 中央寄せは pill（PART1）で保証
    };

    $("ofMinus").onclick = ()=>{
      const cur = Number(agg.qty||0) + delta;
      if(cur <= 0) return;
      delta -= 1;
      setVal();
    };
    $("ofPlus").onclick = ()=>{
      delta += 1;
      setVal();
    };

    setVal();
  },0);
}


/* =========================================================
   6) 席タップ動線（空席：来店/予約/戻る を復活）
========================================================= */
function openOrderFor_v3(seatId, subId){
  state.order.seatId = seatId;
  state.order.subId = subId || seatId;
  state.order.cat = null;
  state.order.genre = null;
  showScreen("scrOrder");
  renderOrder_v3();
}

/* 空席：来店/予約/戻る */
function openEmptyAction_v3(seat){
  openModal(
    "空席",
    `<div class="muted" style="margin-bottom:10px">来店 / 予約 を選択してください</div>`,
    [
      {label:"来店", lime:true, onClick:()=>{
        closeModal();
        seat.status = "in";
        seat.people = Math.max(1, Number(seat.people||1));
        seat.bills = 1;
        seat.name = seat.name || "";
        seat.total = Number(seat.total||0);
        seat.reserve = null;
        seat.merged = false;
        seat.mergeLabel = "";
        seat.sub = null;

        if(typeof emitEvent==="function") emitEvent("seat_in", {seatId: seat.id});
        renderSeats();
        openOrderFor_v3(seat.id, seat.id);
      }},
      {label:"予約", lime:false, onClick:()=>{
        closeModal();
        openReserveInput_v3(seat);
      }},
      {label:"戻る", lime:false, onClick:()=> closeModal()},
    ],
    seat.id
  );
}

/* 予約入力 */
function openReserveInput_v3(seat){
  openModal(
    "予約入力",
    `
      <div style="margin-bottom:8px; font-weight:1000">来店時間</div>
      <input id="rTime" class="btn full" style="text-align:left" placeholder="例：18:30" inputmode="text" autocomplete="off" />

      <div style="margin-top:12px;margin-bottom:8px; font-weight:1000">名前</div>
      <input id="rName" class="btn full" style="text-align:left" placeholder="例：佐藤" inputmode="text" autocomplete="off" />

      <div style="margin-top:12px;margin-bottom:8px; font-weight:1000">連絡先</div>
      <input id="rTel" class="btn full" style="text-align:left" placeholder="電話 / メモ" inputmode="text" autocomplete="off" />
    `,
    [
      {label:"保存", lime:true, onClick:()=>{
        const time = ($("rTime").value||"").trim();
        const name = ($("rName").value||"").trim();
        const tel  = ($("rTel").value||"").trim();

        if(!time || !name){ toast("未記入があります"); return; }

        seat.status = "reserve";
        seat.people = Math.max(1, Number(seat.people||1));
        seat.reserve = { time, name, tel, note:"" };
        seat.name = "";
        seat.total = 0;
        seat.bills = 0;

        if(typeof emitEvent==="function") emitEvent("reserve_set", {seatId: seat.id, time, name, tel});

        closeModal();
        renderSeats();
        toast("予約を保存しました");
      }},
      {label:"戻る", lime:false, onClick:()=> closeModal()},
    ],
    seat.id
  );
}

/* 予約カード：来店/キャンセル/戻る */
function openReserveAction_v3(seat){
  const r = seat.reserve || {};
  openModal(
    "予約",
    `
      <div style="margin-bottom:6px; font-weight:1000">時間：${r.time||""}</div>
      <div style="margin-bottom:6px; font-weight:1000">名前：${r.name||""}</div>
      <div class="muted" style="font-weight:1000">連絡先：${r.tel||""}</div>
    `,
    [
      {label:"来店", lime:true, onClick:()=>{
        closeModal();
        seat.status = "in";
        seat.name = r.name || "";
        seat.bills = 1;
        seat.total = Number(seat.total||0);
        seat.reserve = null;

        if(typeof emitEvent==="function") emitEvent("reserve_to_in", {seatId: seat.id});
        renderSeats();
        openOrderFor_v3(seat.id, seat.id);
      }},
      {label:"キャンセル", lime:false, onClick:()=>{
        closeModal();
        openModal(
          "キャンセル",
          `
            <div style="color:var(--danger); font-weight:1000; margin-bottom:10px">予約をキャンセルします</div>
            <input id="rCancelSlide" class="range" type="range" min="0" max="100" value="0" />
          `,
          [{label:"戻る", lime:false, onClick:()=> closeModal()}],
          seat.id
        );
        setTimeout(()=>{
          $("rCancelSlide").onchange = ()=>{
            if(Number($("rCancelSlide").value||0) < 88){ $("rCancelSlide").value=0; return; }
            seat.status="empty";
            seat.people=0;
            seat.reserve=null;
            seat.name="";
            seat.total=0;
            seat.bills=0;
            seat.orders=[];
            seat.orderLog=[];
            if(typeof emitEvent==="function") emitEvent("reserve_cancel", {seatId: seat.id});
            closeModal();
            renderSeats();
            toast("キャンセルしました");
          };
        },0);
      }},
      {label:"戻る", lime:false, onClick:()=> closeModal()},
    ],
    seat.id
  );
}

/* 合流席：どれを操作？ */
function openMergedPick_v3(seat){
  const subs = Object.values(seat.sub||{});
  if(subs.length<=1){
    openOrderFor_v3(seat.id, seat.id);
    return;
  }

  const buttons = subs.map(su=>({
    label: su.seatId,
    lime:true,
    onClick:()=>{
      closeModal();
      openOrderFor_v3(seat.id, su.seatId);
    }
  }));
  buttons.push({label:"戻る", lime:false, onClick:()=> closeModal()});

  openModal("どちらの注文、会計をしますか？", `<div class="muted">席を選択してください</div>`, buttons, seat.id);
}

/* 席カードタップ：本体（PART1の onSeatTap を上書き） */
onSeatTap = function(seatId){
  const seat = seatById(seatId);
  if(!seat) return;

  if(seat.status==="empty"){ openEmptyAction_v3(seat); return; }
  if(seat.status==="reserve"){ openReserveAction_v3(seat); return; }

  if(seat.merged){ openMergedPick_v3(seat); return; }

  openOrderFor_v3(seat.id, seat.id);
};


/* =========================================================
   7) 注文画面に入ったら必ず描画（showScreenフック）
========================================================= */
(function hookShowScreenOrder_v3(){
  if(showScreen._orderHookedV3) return;
  const _show = showScreen;
  showScreen = function(id){
    _show(id);
    if(id==="scrOrder"){
      try{ renderOrder_v3(); }catch(e){}
    }
  };
  showScreen._orderHookedV3 = true;
})();


/* =========================================================
   8) 席移動（復活）：移動/合流トグル＋席セレクター＋スライド確定
   - PART1の openMoveHome() をここで上書きして復活
========================================================= */
(function reviveSeatMove_v1(){
  if(reviveSeatMove_v1._done) return;
  reviveSeatMove_v1._done = true;

  function allSeatsArray(){
    const s = state.seats;
    if(!s) return [];
    if(Array.isArray(s)) return s.slice();
    try{ return Object.values(s); }catch(e){ return []; }
  }

  function safeSeatId(seat){
    return (seat && (seat.id || seat.seatId || "")) + "";
  }

  function seatSortKey(id){
    const t = String(id||"").trim();
    const m = t.match(/^([A-Za-z]+)?\s*0*([0-9]+)?$/);
    if(m){
      const a = (m[1]||"").toUpperCase();
      const n = m[2] ? Number(m[2]) : -1;
      return `${a.padEnd(4,"~")}_${String(n).padStart(6,"0")}_${t}`;
    }
    return `~~~~_${t}`;
  }

  function pickSeatGridHtml(seats, selectedId, dataKey){
    const cards = seats.map(seat=>{
      const id = safeSeatId(seat);
      const sel = (id===selectedId);
      const label = id || "(?)";
      const st = seat.status || "empty";
      const badge =
        st==="empty" ? `空席` :
        st==="reserve" ? `予約` :
        seat.merged ? `合流` :
        `来店`;

      return `
        <div class="seatCard" data-${dataKey}="${id}"
             style="min-height:76px; display:flex; flex-direction:column; justify-content:center; align-items:center; gap:6px;
                    ${sel ? "background:rgba(100,178,108,0.18);" : ""}">
          <div style="font-size:22px; font-weight:1000">${label}</div>
          <div class="muted" style="font-weight:1000">${badge}</div>
        </div>
      `;
    }).join("");

    return `<div class="seatGrid">${cards}</div>`;
  }

  function cloneSeatPayload(seat){
    return {
      status: seat.status || "empty",
      people: Number(seat.people||0),
      name: seat.name || "",
      bills: Number(seat.bills||0),
      total: Number(seat.total||0),
      orders: Array.isArray(seat.orders) ? JSON.parse(JSON.stringify(seat.orders)) : [],
      orderLog: Array.isArray(seat.orderLog) ? JSON.parse(JSON.stringify(seat.orderLog)) : [],
      reserve: seat.reserve ? JSON.parse(JSON.stringify(seat.reserve)) : null,
      merged: !!seat.merged,
      mergeLabel: seat.mergeLabel || "",
      sub: seat.sub ? JSON.parse(JSON.stringify(seat.sub)) : null,
    };
  }

  function resetSeatToEmpty(seat){
    seat.status="empty";
    seat.people=0;
    seat.name="";
    seat.bills=0;
    seat.total=0;
    seat.orders=[];
    seat.orderLog=[];
    seat.reserve=null;
    seat.merged=false;
    seat.mergeLabel="";
    seat.sub=null;
  }

  function ensureMergedContainer(target){
    if(target.merged){
      target.sub = target.sub || {};
      return;
    }
    const keep = cloneSeatPayload(target);
    target.merged = true;
    target.mergeLabel = target.mergeLabel || (target.id || "");
    target.sub = target.sub || {};

    const selfId = (target.id || "");
    target.sub[selfId] = target.sub[selfId] || { seatId: selfId, orders: [], orderLog: [], total: 0 };

    target.sub[selfId].orders = keep.orders || [];
    target.sub[selfId].orderLog = keep.orderLog || [];
    target.sub[selfId].total = calcOrdersTotal(keep.orders || []);
    target.total = calcSeatTotal(target);
  }

  function moveSeat(fromSeat, toSeat){
    const payload = cloneSeatPayload(fromSeat);
    if((toSeat.status||"empty")!=="empty"){
      toast("移動先は空席だけにしてください");
      return false;
    }
    toSeat.status = payload.status;
    toSeat.people = payload.people;
    toSeat.name = payload.name;
    toSeat.bills = payload.bills;
    toSeat.total = payload.total;
    toSeat.orders = payload.orders || [];
    toSeat.orderLog = payload.orderLog || [];
    toSeat.reserve = payload.reserve;
    toSeat.merged = !!payload.merged;
    toSeat.mergeLabel = payload.mergeLabel || "";
    toSeat.sub = payload.sub;

    resetSeatToEmpty(fromSeat);
    return true;
  }

  function mergeSeat(fromSeat, toSeat){
    if((fromSeat.status||"empty")!=="in"){
      toast("合流元は「来店中」の席だけにしてください");
      return false;
    }
    if(fromSeat.merged){
      toast("合流元が合流席は未対応（まず分離してから）");
      return false;
    }
    if((toSeat.status||"empty")==="empty" || (toSeat.status||"empty")==="reserve"){
      toast("合流先は「来店中」か「合流席」を選んでください");
      return false;
    }

    ensureMergedContainer(toSeat);

    const fromId = fromSeat.id || "";
    toSeat.sub = toSeat.sub || {};
    toSeat.sub[fromId] = toSeat.sub[fromId] || { seatId: fromId, orders: [], orderLog: [], total: 0 };
    toSeat.sub[fromId].orders = Array.isArray(fromSeat.orders) ? JSON.parse(JSON.stringify(fromSeat.orders)) : [];
    toSeat.sub[fromId].orderLog = Array.isArray(fromSeat.orderLog) ? JSON.parse(JSON.stringify(fromSeat.orderLog)) : [];
    toSeat.sub[fromId].total = calcOrdersTotal(toSeat.sub[fromId].orders || []);

    toSeat.total = calcSeatTotal(toSeat);
    resetSeatToEmpty(fromSeat);
    return true;
  }

  window.openMoveHome = function openMoveHome(){
    const seats = allSeatsArray()
      .filter(s=> !!safeSeatId(s))
      .sort((a,b)=> seatSortKey(safeSeatId(a)).localeCompare(seatSortKey(safeSeatId(b))));

    if(seats.length===0){
      toast("席がありません（席登録を先に）");
      return;
    }

    let mode = "move"; // move | merge
    let fromId = "";
    let toId = "";

    function renderBody(){
      const fromList = seats.filter(s=>{
        const st = s.status || "empty";
        if(mode==="move"){
          return st !== "empty";
        }
        return st === "in" && !s.merged;
      });

      const toList = seats.filter(s=>{
        const st = s.status || "empty";
        if(mode==="move"){
          return st === "empty";
        }
        return st === "in" || !!s.merged;
      });

      const modeBtns = `
        <div style="display:flex; gap:10px; margin-bottom:12px">
          <button class="btn ${mode==="move"?"lime":""}" id="mvModeMove" style="flex:1">移動</button>
          <button class="btn ${mode==="merge"?"lime":""}" id="mvModeMerge" style="flex:1">合流</button>
        </div>
      `;

      const fromHtml = `
        <div style="font-weight:1000; margin-bottom:8px; font-size:18px">どこから</div>
        ${pickSeatGridHtml(fromList, fromId, "mvfrom")}
      `;

      const toHtml = `
        <div style="height:12px"></div>
        <div style="font-weight:1000; margin-bottom:8px; font-size:18px">どこへ</div>
        ${pickSeatGridHtml(toList, toId, "mvto")}
      `;

      const hint = `
        <div style="height:12px"></div>
        <div class="muted">
          ${mode==="move"
            ? "※ 移動：移動先は空席のみ（事故防止）"
            : "※ 合流：合流元は来店中のみ／合流先は来店中 or 合流席"}
        </div>
        <div style="height:10px"></div>
        <div style="color:var(--danger); font-weight:1000; margin-bottom:8px">スライドで確定</div>
        <input id="mvSlide" class="range" type="range" min="0" max="100" value="0" />
      `;

      return modeBtns + fromHtml + toHtml + hint;
    }

    openModal(
      "席移動",
      `<div id="mvWrap">${renderBody()}</div>`,
      [{label:"戻る", lime:false, onClick:()=> closeModal()}]
    );

    function wire(){
      const wrap = $("mvWrap");
      if(!wrap) return;

      const rerender = ()=>{
        wrap.innerHTML = renderBody();
        wire();
      };

      const bm = $("mvModeMove");
      const bg = $("mvModeMerge");
      if(bm) bm.onclick = ()=>{ mode="move"; fromId=""; toId=""; rerender(); };
      if(bg) bg.onclick = ()=>{ mode="merge"; fromId=""; toId=""; rerender(); };

      wrap.querySelectorAll("[data-mvfrom]").forEach(el=>{
        el.onclick = ()=>{
          fromId = el.getAttribute("data-mvfrom") || "";
          if(toId === fromId) toId = "";
          rerender();
        };
      });

      wrap.querySelectorAll("[data-mvto]").forEach(el=>{
        el.onclick = ()=>{
          toId = el.getAttribute("data-mvto") || "";
          if(fromId === toId) return;
          rerender();
        };
      });

      const sl = $("mvSlide");
      if(sl){
        sl.onchange = ()=>{
          const v = Number(sl.value||0);
          if(v < 88){ sl.value = 0; return; }

          if(!fromId || !toId){
            toast("「どこから」「どこへ」を選んでください");
            sl.value = 0;
            return;
          }
          if(fromId === toId){
            toast("同じ席は選べません");
            sl.value = 0;
            return;
          }

          const fromSeat = seatById(fromId);
          const toSeat = seatById(toId);
          if(!fromSeat || !toSeat){
            toast("席が見つかりません");
            sl.value = 0;
            return;
          }

          let ok = false;
          if(mode==="move"){
            ok = moveSeat(fromSeat, toSeat);
            if(ok && typeof emitEvent==="function") emitEvent("seat_move", {from: fromId, to: toId});
          }else{
            ok = mergeSeat(fromSeat, toSeat);
            if(ok && typeof emitEvent==="function") emitEvent("seat_merge", {from: fromId, to: toId});
          }

          if(!ok){ sl.value = 0; return; }

          closeModal();
          renderSeats();
          toast(mode==="move" ? "移動しました" : "合流しました");
        };
      }
    }

    setTimeout(wire, 0);
  };
})();


/* =========================
  ここから先は PART3 で続く
========================= */
/* =========================
  PART3：キッチン（完成版）
  役割：未調理一覧 / 同一メニューまとめ / スライド完了 / 提供済折りたたみ
  追加：注文からキッチンへ積む（料理/ドリンク）
========================= */

/* ===== UI差し替え ===== */
(function buildKitchenUI(){
  const scr = $("scrKitchen");
  scr.innerHTML = `
    <div style="font-weight:900; margin-bottom:10px">キッチン</div>

    <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin-bottom:10px">
      <div style="opacity:.9">表示：</div>
      <button class="btn" id="kFilterFood">料理</button>
      <button class="btn" id="kFilterDrink">ドリンク</button>
      <button class="btn ghost" id="kToggleDone">提供済を表示</button>
    </div>

    <div id="kList"></div>

    <div style="height:12px"></div>

    <div id="kDoneWrap" style="display:none">
      <div style="font-weight:900; margin-bottom:10px">提供済</div>
      <div id="kDoneList"></div>
    </div>
  `;
})();

/* ===== State ===== */
state.kitchen = state.kitchen || {
  showDone:false,
  showFood:true,
  showDrink:true,
  items: [] // {kid, ts, seatId, subId, name, qty, cat, status}
};

/* ===== 注文→キッチンへ積む ===== */
function addKitchenFromOrder(seat, subId, item){
  // item.cat: "food" | "drink"
  const cat = item.cat || "food";
  const key = `${seat.id}__${subId}__${item.id}`;

  // 同一商品は qty をまとめる（キッチンもまとめやすく）
  let found = state.kitchen.items.find(x=> x._key===key && x.status==="todo");
  if(!found){
    found = {
      kid: "k_" + Math.random().toString(36).slice(2),
      _key: key,
      ts: nowTs(),
      seatId: seat.id,
      subId,
      name: item.name,
      qty: 1,
      cat,
      status:"todo"
    };
    state.kitchen.items.push(found);
  }else{
    found.qty += 1;
  }
}

/* ===== CSS（キッチン専用） ===== */
(function injectPart3Css(){
  const css = `
    .kRow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:10px;
      border:1px solid rgba(255,255,255,0.10);
      border-radius:14px;
      background:rgba(255,255,255,0.04);
      margin-bottom:10px;
    }
    .kLeft{
      min-width:0;
      display:flex;
      align-items:center;
      gap:10px;
      flex:1;
    }
    .kTime{ font-weight:900; width:56px; }
    .kSeat{ font-weight:900; width:52px; }
    .kName{
      min-width:0;
      font-weight:900;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    .kQty{
      font-weight:900;
      opacity:.85;
      margin-left:6px;
    }

    .kChild{ margin-left:18px; position:relative; }
    .kChild::before{
      content:"";
      position:absolute;
      left:-10px; top:0; bottom:0;
      width:2px;
      background:rgba(122,167,255,0.45);
      border-radius:99px;
    }
    .kChild .kRow{ background:rgba(122,167,255,0.08); }

    .kSlide{
      width:25vw;
      max-width:160px;
      min-width:110px;
      display:flex;
      align-items:center;
      gap:8px;
      justify-content:flex-end;
    }
    .kRange{ width:100%; accent-color: var(--accent); }
    .kDoneBadge{ font-size:12px; color:var(--ok); font-weight:900; }
  `;
  const st = document.createElement("style");
  st.textContent = css;
  document.head.appendChild(st);
})();

/* ===== Helpers ===== */
function hhmm(ts){
  const d = new Date(ts);
  return `${pad2(d.getHours())}:${pad2(d.getMinutes())}`;
}
function passCategory(item){
  if(item.cat==="food" && !state.kitchen.showFood) return false;
  if(item.cat==="drink" && !state.kitchen.showDrink) return false;
  return true;
}

/* 同一メニューまとめ：親＝最古 */
function buildKitchenGroups(list){
  const map = new Map();
  list.forEach(it=>{
    const key = `${it.name}__${it.cat}`;
    if(!map.has(key)) map.set(key, []);
    map.get(key).push(it);
  });

  const groups = [];
  map.forEach(arr=>{
    arr.sort((a,b)=> a.ts-b.ts);
    groups.push(arr);
  });
  groups.sort((ga,gb)=> ga[0].ts - gb[0].ts);
  return groups;
}

/* ===== Render ===== */
function renderKitchen(){
  const todo = state.kitchen.items.filter(it=> it.status==="todo").filter(passCategory);
  const done = state.kitchen.items.filter(it=> it.status==="done").filter(passCategory);

  const listBox = $("kList");
  const doneWrap = $("kDoneWrap");
  const doneBox  = $("kDoneList");

  listBox.innerHTML = "";
  doneBox.innerHTML = "";

  const groups = buildKitchenGroups(todo);
  if(groups.length===0){
    listBox.innerHTML = `<div style="opacity:.85">未調理はありません</div>`;
  }else{
    groups.forEach(arr=>{
      listBox.appendChild(kRowEl(arr[0], false));
      arr.slice(1).forEach(ch=>{
        const wrap = document.createElement("div");
        wrap.className = "kChild";
        wrap.appendChild(kRowEl(ch, false));
        listBox.appendChild(wrap);
      });
    });
  }

  doneWrap.style.display = state.kitchen.showDone ? "block" : "none";
  if(state.kitchen.showDone){
    const groupsD = buildKitchenGroups(done);
    if(groupsD.length===0){
      doneBox.innerHTML = `<div style="opacity:.85">提供済はありません</div>`;
    }else{
      groupsD.forEach(arr=>{
        doneBox.appendChild(kRowEl(arr[0], true));
        arr.slice(1).forEach(ch=>{
          const wrap = document.createElement("div");
          wrap.className = "kChild";
          wrap.appendChild(kRowEl(ch, true));
          doneBox.appendChild(wrap);
        });
      });
    }
  }
}

function kRowEl(item, isDone){
  const row = document.createElement("div");
  row.className = "kRow";

  const qtyText = (Number(item.qty||0) >= 2) ? `×${item.qty}` : "";
  const seatLabel = item.subId && item.subId!==item.seatId ? `${item.seatId}/${item.subId}` : `${item.seatId}`;

  row.innerHTML = `
    <div class="kLeft">
      <div class="kTime">${hhmm(item.ts)}</div>
      <div class="kSeat">${seatLabel}</div>
      <div class="kName">${item.name}<span class="kQty">${qtyText}</span></div>
    </div>
    <div class="kSlide">
      ${isDone ? `<span class="kDoneBadge">完了</span>` : ``}
      <input class="kRange" type="range" min="0" max="100" value="0" aria-label="スライドで完了" />
    </div>
  `;

  const range = row.querySelector(".kRange");
  const TH = 88;

  range.addEventListener("change", ()=>{
    const v = Number(range.value||0);
    if(v >= TH){
      item.status = isDone ? "todo" : "done";
      range.value = 0;
      renderKitchen();
    }else{
      range.value = 0;
    }
  });

  return row;
}

/* ===== Buttons ===== */
$("kToggleDone").onclick = ()=>{
  state.kitchen.showDone = !state.kitchen.showDone;
  $("kToggleDone").textContent = state.kitchen.showDone ? "提供済を隠す" : "提供済を表示";
  renderKitchen();
};

$("kFilterFood").onclick = ()=>{
  state.kitchen.showFood = !state.kitchen.showFood;
  $("kFilterFood").classList.toggle("lime", state.kitchen.showFood);
  renderKitchen();
};
$("kFilterDrink").onclick = ()=>{
  state.kitchen.showDrink = !state.kitchen.showDrink;
  $("kFilterDrink").classList.toggle("lime", state.kitchen.showDrink);
  renderKitchen();
};

/* 初期 */
$("kFilterFood").classList.add("lime");
$("kFilterDrink").classList.add("lime");

/* showScreen hook */
(function hookShowScreenForKitchen(){
  if(showScreen._kHooked) return;
  const _show = showScreen;
  showScreen = function(id){
    _show(id);
    if(id==="scrKitchen") renderKitchen();
  };
  showScreen._kHooked = true;
})();

renderKitchen();

/* =========================
  ここから先は PART4 で続く
========================= */
/* =========================
  PART4：売上（本日／日別／月／年）
  役割：閲覧（無料版で全部見る）＋修正導線（PART5へ）
  方針：軽く・不安を煽らない・修正はPART5へ分離（訂正伝票方式）
  追加（確定対応）：
    - 本日／日別／月／年 を無料版で閲覧可能
    - 本日／日別 の一覧は「入店/退店/席(名前)/金額/支払/修正」
    - 修正差分（訂正伝票）は “対象行の直下” に追加表示（上書きなし）
========================= */

/* ===== UI差し替え（プレースホルダ置換） ===== */
(function buildSalesUI(){
  const scr = $("scrSales");
  scr.innerHTML = `
    <div class="pill" style="margin-bottom:10px">売上</div>

    <div style="display:flex; gap:8px; margin-bottom:10px; flex-wrap:wrap">
      <button class="btn primary" id="tabToday">本日</button>
      <button class="btn" id="tabDaily">日別</button>
      <button class="btn" id="tabMonth">月</button>
      <button class="btn" id="tabYear">年</button>
    </div>

    <div id="salesToday"></div>
    <div id="salesDaily" style="display:none"></div>
    <div id="salesMonth" style="display:none"></div>
    <div id="salesYear" style="display:none"></div>
  `;
})();

/* ===== PART4 State ===== */
state.sales = state.sales || {
  list: [],
  tab: "today",
  dailyYmd: null, // 日別で選択中の日付（YYYY-MM-DD）
};

/* ===== Helpers ===== */
function ymd(d){
  return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
}
function sameDay(a,b){
  return a.getFullYear()===b.getFullYear()
      && a.getMonth()===b.getMonth()
      && a.getDate()===b.getDate();
}
function fmtHM(ts){
  if(!ts) return "--:--";
  const d = new Date(ts);
  return `${pad2(d.getHours())}:${pad2(d.getMinutes())}`;
}
function safeNum(n){ n=Number(n); return Number.isFinite(n)?n:0; }

/* ===== Demo Seed（inTs/outTsも付ける） ===== */
(function seedSalesIfEmpty(){
  if(state.sales.list.length) return;

  const now = new Date();
  const mk = (inH,inM,outH,outM,seat,name,pay,amt)=>{
    const inD  = new Date(now.getFullYear(), now.getMonth(), now.getDate(), inH, inM);
    const outD = new Date(now.getFullYear(), now.getMonth(), now.getDate(), outH, outM);
    return {
      saleId: "s"+Math.random().toString(36).slice(2),
      ts: outD.getTime(),      // 会計時刻（退店寄りでOK）
      inTs: inD.getTime(),
      outTs: outD.getTime(),
      seatId: seat,
      name: name||"",
      pay,
      amount: amt,
      receipt: true,
      items: [
        {name:"生ビール", qty:2, price:600, tax:10},
        {name:"唐揚げ", qty:1, price:800, tax:10},
      ],
      corrections: [] // 訂正伝票（差分）をここに積む
    };
  };

  state.sales.list.push(
    mk(12,10,12,35,"D","田中","カード",4800),
    mk(13,00,13,10,"A","","現金",1800),
    mk(13,40,14, 5,"B","佐藤","QR",2200),
  );

  // 日別の初期日付：今日
  state.sales.dailyYmd = ymd(new Date());
})();

/* ===== Aggregation ===== */
function filterByYmd(targetYmd){
  const rows = state.sales.list.filter(s=>{
    const d = new Date(s.ts);
    return ymd(d) === targetYmd;
  });
  return rows;
}

function aggByRows(rows){
  const sum = rows.reduce((a,b)=> a + safeNum(b.amount), 0);
  const cnt = rows.length;

  const payCnt = {現金:0, カード:0, QR:0};
  const paySum = {現金:0, カード:0, QR:0};

  rows.forEach(s=>{
    const p = s.pay || "現金";
    if(!(p in payCnt)) payCnt[p]=0;
    if(!(p in paySum)) paySum[p]=0;
    payCnt[p] += 1;
    paySum[p] += safeNum(s.amount);
  });

  return {sum,cnt,payCnt,paySum};
}

function aggToday(){
  const today = ymd(new Date());
  const rows = filterByYmd(today);
  return { ymd: today, rows, ...aggByRows(rows) };
}

function aggDaily(targetYmd){
  const rows = filterByYmd(targetYmd);
  return { ymd: targetYmd, rows, ...aggByRows(rows) };
}

function aggMonth(){
  const d = new Date();
  const y=d.getFullYear(), m=d.getMonth();
  const rows = state.sales.list.filter(s=>{
    const x=new Date(s.ts);
    return x.getFullYear()===y && x.getMonth()===m;
  });
  const sum = rows.reduce((a,b)=> a+safeNum(b.amount), 0);
  return {sum, cnt: rows.length};
}

function aggYear(){
  const y=new Date().getFullYear();
  const rows = state.sales.list.filter(s=> new Date(s.ts).getFullYear()===y);
  const sum = rows.reduce((a,b)=> a+safeNum(b.amount), 0);
  return {sum, cnt: rows.length};
}

/* ===== 修正導線（PART5へ） ===== */
function goFix(saleId){
  // PART5差し替え版：window.ONE_openFixForSaleId がある想定
  if(typeof window.ONE_openFixForSaleId === "function"){
    window.ONE_openFixForSaleId(saleId);
    return;
  }
  toast("修正機能が見つかりません（PART5を反映してください）");
}

/* ===== 訂正伝票表示（対象行の直下） ===== */
function renderCorrectionsInline(s){
  const list = (s.corrections || []);
  if(!list.length) return "";

  // 新しい順に見せる（直下に複数並ぶ）
  const html = list.slice().sort((a,b)=> (b.ts||0)-(a.ts||0)).map(c=>{
    const beforePay = c.payBefore || s.pay || "";
    const afterPay  = c.payAfter  || "";

    // 商品差分（左：前 / 右：後）
    const before = c.itemsBefore || [];
    const after  = c.itemsAfter  || [];

    // 名前集合で並べる
    const map = new Map();
    before.forEach(it=>{
      const k = it.name || "";
      if(!k) return;
      if(!map.has(k)) map.set(k, {name:k, b:0, a:0});
      map.get(k).b += safeNum(it.qty);
    });
    after.forEach(it=>{
      const k = it.name || "";
      if(!k) return;
      if(!map.has(k)) map.set(k, {name:k, b:0, a:0});
      map.get(k).a += safeNum(it.qty);
    });
    const diffs = Array.from(map.values()).sort((x,y)=> x.name.localeCompare(y.name,"ja"));

    const diffRows = diffs.map(x=>`
      <div style="display:flex; justify-content:space-between; gap:10px; margin:4px 0">
        <div style="min-width:0; overflow:hidden; text-overflow:ellipsis; white-space:nowrap">${x.name}</div>
        <div style="display:flex; gap:8px; font-weight:900">
          <span>${x.b}</span><span style="color:var(--muted)">→</span><span>${x.a}</span>
        </div>
      </div>
    `).join("");

    return `
      <div class="pill" style="margin:8px 0 10px; color:var(--muted)">
        訂正：${fmtHM(c.ts)} ／ ${c.who||""} ／ ${c.why||""}<br>
        支払：${beforePay}${afterPay?` → ${afterPay}`:""}<br>
        ${diffRows || "（数量変更なし）"}
      </div>
    `;
  }).join("");

  return html;
}

/* ===== List Row ===== */
function saleRowEl(s){
  const row = document.createElement("div");
  row.className = "kRow";
  row.dataset.saleId = s.saleId;

  const inT  = fmtHM(s.inTs);
  const outT = fmtHM(s.outTs);
  const seatLabel = `${s.seatId || ""}${s.name ? `（${s.name}）` : ""}`;

  row.innerHTML = `
    <div class="kLeft" style="align-items:flex-start">
      <div style="width:64px; font-weight:900">${inT}</div>
      <div style="width:64px; font-weight:900">${outT}</div>
      <div class="kName" style="font-weight:900">${seatLabel}</div>
    </div>

    <div class="kSlide" style="gap:10px; width:auto">
      <div style="font-weight:900">${yen(s.amount)}</div>
      <div class="pill">${s.pay || "現金"}</div>
      <button class="btn" data-fix="${s.saleId}">修正</button>
    </div>
  `;

  // 行タップ：詳細（既存の openSaleDetail があれば）
  row.onclick = (e)=>{
    if(e && e.target && e.target.getAttribute && e.target.getAttribute("data-fix")) return;
    if(typeof openSaleDetail === "function") openSaleDetail(s);
  };

  return row;
}

/* ===== Render ===== */
function renderSales(){
  const t = $("salesToday");
  const d = $("salesDaily");
  const m = $("salesMonth");
  const y = $("salesYear");

  t.style.display = state.sales.tab==="today" ? "block":"none";
  d.style.display = state.sales.tab==="daily" ? "block":"none";
  m.style.display = state.sales.tab==="month" ? "block":"none";
  y.style.display = state.sales.tab==="year"  ? "block":"none";

  if(state.sales.tab==="today") renderToday();
  if(state.sales.tab==="daily") renderDaily();
  if(state.sales.tab==="month") renderMonth();
  if(state.sales.tab==="year")  renderYear();
}

function renderToday(){
  const box = $("salesToday");
  const a = aggToday();

  const payTxt = `現金 ${a.payCnt["現金"]||0} / カード ${a.payCnt["カード"]||0} / QR ${a.payCnt["QR"]||0}`;

  box.innerHTML = `
    <div class="pill" style="margin-bottom:8px">
      合計 ${yen(a.sum)} ／ 会計 ${a.cnt}件 ／ ${payTxt}
    </div>

    <div id="todayList"></div>
  `;

  const list = box.querySelector("#todayList");
  if(a.rows.length===0){
    list.innerHTML = `<div class="pill">本日の会計はありません</div>`;
    return;
  }

  a.rows
    .slice()
    .sort((x,y)=> x.ts - y.ts)
    .forEach(s=>{
      // 元行
      const row = saleRowEl(s);
      list.appendChild(row);

      // 直下：訂正伝票（差分）
      const inline = renderCorrectionsInline(s);
      if(inline){
        const wrap = document.createElement("div");
        wrap.innerHTML = inline;
        list.appendChild(wrap);
      }
    });

  // 修正ボタン
  list.querySelectorAll("[data-fix]").forEach(btn=>{
    btn.onclick = (e)=>{
      e.stopPropagation();
      const id = btn.getAttribute("data-fix");
      goFix(id);
    };
  });
}

function renderDaily(){
  const box = $("salesDaily");
  const todayY = ymd(new Date());
  const cur = state.sales.dailyYmd || todayY;

  const a = aggDaily(cur);

  box.innerHTML = `
    <div class="pill" style="margin-bottom:8px">日付</div>
    <input id="dailyPick" class="btn" style="width:100%; text-align:left; margin-bottom:10px" value="${cur}" />

    <div class="pill" style="margin-bottom:8px">
      本日の総売上 ${yen(a.sum)} ／ 総会計数 ${a.cnt}件
    </div>

    <div class="pill" style="margin-bottom:10px; color:var(--muted)">
      現金：${a.payCnt["現金"]||0}件／${yen(a.paySum["現金"]||0)}<br>
      カード：${a.payCnt["カード"]||0}件／${yen(a.paySum["カード"]||0)}<br>
      QR：${a.payCnt["QR"]||0}件／${yen(a.paySum["QR"]||0)}
    </div>

    <div id="dailyList"></div>
  `;

  const list = box.querySelector("#dailyList");
  if(a.rows.length===0){
    list.innerHTML = `<div class="pill">この日の会計はありません</div>`;
  }else{
    a.rows
      .slice()
      .sort((x,y)=> x.ts - y.ts)
      .forEach(s=>{
        const row = saleRowEl(s);
        list.appendChild(row);

        const inline = renderCorrectionsInline(s);
        if(inline){
          const wrap = document.createElement("div");
          wrap.innerHTML = inline;
          list.appendChild(wrap);
        }
      });

    list.querySelectorAll("[data-fix]").forEach(btn=>{
      btn.onclick = (e)=>{
        e.stopPropagation();
        const id = btn.getAttribute("data-fix");
        goFix(id);
      };
    });
  }

  // 日付変更
  $("dailyPick").onchange = ()=>{
    const v = ($("dailyPick").value||"").trim();
    if(!v){ state.sales.dailyYmd = todayY; }
    else state.sales.dailyYmd = v;
    renderDaily();
  };
}

function renderMonth(){
  const box = $("salesMonth");
  const a = aggMonth();
  box.innerHTML = `
    <div class="pill">月合計 ${yen(a.sum)} ／ 会計 ${a.cnt}件</div>
    <div style="height:8px"></div>
    <div class="pill">無料版：月の内訳（グラフ等）は今後の有料版で強化</div>
  `;
}

function renderYear(){
  const box = $("salesYear");
  const a = aggYear();
  box.innerHTML = `
    <div class="pill">年合計 ${yen(a.sum)} ／ 会計 ${a.cnt}件</div>
    <div style="height:8px"></div>
    <div class="pill">無料版：年の内訳（グラフ等）は今後の有料版で強化</div>
  `;
}

/* ===== Detail（修正はPART5へ） ===== */
function openSaleDetail(s){
  const items = (s.items||[]).map(it=>`${it.name} ×${it.qty}`).join("<br>");
  openModal(
    "会計詳細",
    `
      <div>入店：${fmtHM(s.inTs)}</div>
      <div>退店：${fmtHM(s.outTs)}</div>
      <div>席：${s.seatId}${s.name?`（${s.name}）`:""}</div>
      <div>支払：${s.pay}</div>
      <div style="margin-top:8px">${items}</div>
      <div style="margin-top:8px;font-weight:900">${yen(s.amount)}</div>
    `,
    [
      {label:"修正", primary:true, onClick:()=>{ closeModal(); goFix(s.saleId); }},
      {label:"戻る", onClick:()=> closeModal()},
    ]
  );
}

/* ===== Tabs ===== */
function setTab(t){
  state.sales.tab = t;

  $("tabToday").classList.toggle("primary", t==="today");
  $("tabDaily").classList.toggle("primary", t==="daily");
  $("tabMonth").classList.toggle("primary", t==="month");
  $("tabYear").classList.toggle("primary", t==="year");

  renderSales();
}

$("tabToday").onclick=()=> setTab("today");
$("tabDaily").onclick=()=> setTab("daily");
$("tabMonth").onclick=()=> setTab("month");
$("tabYear").onclick =()=> setTab("year");

/* ===== showScreen拡張 ===== */
(function hookShowScreenForSales(){
  if(showScreen._sHooked2) return;
  const _show = showScreen;
  showScreen = function(id){
    _show(id);
    if(id==="scrSales") renderSales();
  };
  showScreen._sHooked2 = true;
})();

/* 初期描画 */
renderSales();

/* =========================
  ここから先は PART5 で続く
========================= */
/* =========================
  PART5：売上管理・訂正伝票（本日／日別の修正）
  役割：会計確定後の修正（差分イベントのみ）
  方針：消さない／上書きしない／履歴を残す（訂正伝票方式）
  修正対象（確定）：
    ① 注文商品数（0以下不可）
    ② 支払い方法
  修正時 必須：
    ・修正者名（必須）
    ・修正理由（必須）
  表示：
    ・修正差分は「対象行の直下」に追加表示（元は残す）
========================= */

/* ===== UI差し替え（プレースホルダ置換） ===== */
(function buildFixUI(){
  const scr = $("scrFix");
  scr.innerHTML = `
    <div class="pill" style="margin-bottom:10px">修正（訂正伝票方式）</div>
    <div id="fixBody"></div>
  `;
})();

/* ===== PART5 State ===== */
state.fix = state.fix || {
  targetId: null,      // saleId
  draft: null,         // 編集中のドラフト
  stage: "edit",       // "edit" | "confirm"
};

/* =========================================================
  Saleデータ想定（既存を壊さないための互換）
  - state.sales.list の各要素（sale）は最低限:
    {
      saleId, ts,
      seatId, name, pay, amount,
      items:[{name, qty, price, tax}],
      inTs?, outTs?,
      corrections?: [
        {
          corrId, ts,
          who, why,
          payBefore, payAfter,
          itemsBefore:[{name, qty}], itemsAfter:[{name, qty}]
        }
      ]
    }
========================================================= */

function getSaleById(id){
  return (state.sales && Array.isArray(state.sales.list))
    ? state.sales.list.find(s => s.saleId === id)
    : null;
}

function safeNum(n){ n = Number(n); return Number.isFinite(n) ? n : 0; }

function calcAmountFromItems(items){
  // 税計算は無料版は“総額の整合優先”で簡易（ここは後で精密化できる）
  // 現状：price * qty の合計
  return (items||[]).reduce((sum, it)=> sum + safeNum(it.price) * safeNum(it.qty), 0);
}

function cloneItemsForEdit(items){
  return (items||[]).map(it=> ({
    name: it.name || "",
    qty: Math.max(0, safeNum(it.qty)),
    price: safeNum(it.price),
    tax: safeNum(it.tax),
  }));
}

function itemsToNameQty(items){
  return (items||[]).map(it=> ({ name: it.name || "", qty: Math.max(0, safeNum(it.qty)) }));
}

function fmtHM(ts){
  if(!ts) return "--:--";
  const d = new Date(ts);
  return `${pad2(d.getHours())}:${pad2(d.getMinutes())}`;
}

function payOptionsHtml(sel){
  const opts = ["現金","カード","QR"];
  return opts.map(p=> `<option ${p===sel?"selected":""}>${p}</option>`).join("");
}

function diffNameQty(before, after){
  // 表示用：左右に同じ順で並べたい
  // “名前集合”でまとめる
  const map = new Map();
  (before||[]).forEach(it=>{
    const k = it.name || "";
    if(!map.has(k)) map.set(k, {name:k, b:0, a:0});
    map.get(k).b += safeNum(it.qty);
  });
  (after||[]).forEach(it=>{
    const k = it.name || "";
    if(!map.has(k)) map.set(k, {name:k, b:0, a:0});
    map.get(k).a += safeNum(it.qty);
  });
  return Array.from(map.values()).filter(x=> x.name).sort((x,y)=> x.name.localeCompare(y.name, "ja"));
}

/* =========================================================
  PART4からの入口（修正ボタン → scrFix）
  既存 openSaleDetail(s) を壊さず “修正対象を保持”する
========================================================= */
(function hookFixEntry(){
  // PART4の openSaleDetail がある前提でフック（無くても動く）
  if(typeof openSaleDetail !== "function") return;
  if(openSaleDetail._p5Hooked) return;

  const _open = openSaleDetail;
  openSaleDetail = function(sale){
    _open(sale);
    // 修正ボタン押下時に対象が必要なので保持
    state.fix.targetId = sale && sale.saleId ? sale.saleId : null;
  };

  openSaleDetail._p5Hooked = true;
})();

/* =========================================================
  “修正”画面を開く共通関数（今日/日別の一覧から呼べる）
========================================================= */
function openFixForSaleId(saleId){
  const s = getSaleById(saleId);
  if(!s){
    toast("修正対象が見つかりません");
    return;
  }

  // ドラフト作成（編集は items.qty と pay のみ）
  const baseItems = cloneItemsForEdit(s.items || []);
  const basePay = s.pay || "現金";

  state.fix.targetId = s.saleId;
  state.fix.stage = "edit";
  state.fix.draft = {
    who: "",
    why: "",
    pay: basePay,
    items: baseItems,          // qtyをここで増減
    baseItems: cloneItemsForEdit(s.items || []),
    basePay: basePay,
  };

  showScreen("scrFix");
  renderFix();
}

/* =========================================================
  FIX：編集画面 → 確認画面 → スライド確定
========================================================= */
function renderFix(){
  const box = $("fixBody");
  const s = getSaleById(state.fix.targetId);

  if(!s){
    box.innerHTML = `<div class="pill">修正対象がありません</div>`;
    return;
  }

  // in/out は無い場合もある（既存データ互換）
  const inT  = fmtHM(s.inTs || null);
  const outT = fmtHM(s.outTs || null);

  const seatLabel = `${s.seatId || ""}${s.name ? `（${s.name}）` : ""}`;
  const baseAmount = safeNum(s.amount) || calcAmountFromItems(s.items||[]);

  // ドラフトが無い場合は生成（直接scrFixに来たケース救済）
  if(!state.fix.draft){
    state.fix.draft = {
      who:"",
      why:"",
      pay: s.pay || "現金",
      items: cloneItemsForEdit(s.items || []),
      baseItems: cloneItemsForEdit(s.items || []),
      basePay: s.pay || "現金",
    };
    state.fix.stage = "edit";
  }

  const d = state.fix.draft;
  const newAmount = calcAmountFromItems(d.items);

  if(state.fix.stage === "edit"){
    const rows = d.items.map((it, idx)=>{
      const qty = Math.max(0, safeNum(it.qty));
      return `
        <div class="kRow" style="align-items:flex-start">
          <div class="kLeft" style="align-items:flex-start">
            <div class="kName">${it.name}</div>
          </div>
          <div class="kSlide" style="flex-direction:column; align-items:flex-end; gap:8px">
            <div class="pill" style="min-width:120px; justify-content:center; font-weight:900">
              ${yen(safeNum(it.price) * qty)}
            </div>
            <div style="display:flex; gap:8px; align-items:center">
              <button class="btn" data-minus="${idx}">−</button>
              <div class="pill" style="min-width:54px; justify-content:center; font-weight:900">${qty}</div>
              <button class="btn" data-plus="${idx}">＋</button>
            </div>
          </div>
        </div>
      `;
    }).join("");

    box.innerHTML = `
      <!-- 上段：現状 -->
      <div class="pill" style="margin-bottom:8px">現状（修正前）</div>
      <div class="pill" style="margin-bottom:10px; color:var(--muted)">
        入店 ${inT} / 退店 ${outT}<br>
        席 ${seatLabel}<br>
        金額 ${yen(baseAmount)} / 支払 ${s.pay || "現金"}
      </div>

      <!-- 入力 -->
      <div style="display:flex; gap:10px; margin-bottom:10px">
        <button class="btn" id="fixBack" style="flex:1">戻る</button>
        <button class="btn primary" id="fixToConfirm" style="flex:1">決定</button>
      </div>

      <div class="pill" style="margin-bottom:6px">修正者名（必須）</div>
      <input id="fixWho" class="btn" style="width:100%; text-align:left; margin-bottom:10px" placeholder="名前" value="${(d.who||"").replace(/"/g,"&quot;")}" />

      <div class="pill" style="margin-bottom:6px">修正理由（必須）</div>
      <input id="fixWhy" class="btn" style="width:100%; text-align:left; margin-bottom:12px" placeholder="理由" value="${(d.why||"").replace(/"/g,"&quot;")}" />

      <!-- 操作列 -->
      <div class="pill" style="margin-bottom:6px">修正後</div>
      <div class="pill" style="margin-bottom:10px">
        修正後金額：<span style="font-weight:900">${yen(newAmount)}</span>
      </div>

      <div class="pill" style="margin-bottom:6px">支払い方法</div>
      <select id="fixPay" class="btn" style="width:100%; margin-bottom:12px">
        ${payOptionsHtml(d.pay)}
      </select>

      <!-- 明細 -->
      <div class="pill" style="margin-bottom:6px">商品明細（数量変更）</div>
      ${rows}
    `;

    // 戻る
    $("fixBack").onclick = ()=> showScreen("scrSales"); // 現状の構造に合わせて「売上」へ戻す（後で管理画面が出来たら差し替えOK）

    // 決定 → 確認へ
    $("fixToConfirm").onclick = ()=>{
      d.who = ($("fixWho").value||"").trim();
      d.why = ($("fixWhy").value||"").trim();
      d.pay = ($("fixPay").value||"").trim() || d.pay;

      if(!d.who || !d.why){
        toast("修正者名と修正理由は必須です");
        return;
      }
      state.fix.stage = "confirm";
      renderFix();
    };

    // 支払変更
    $("fixPay").onchange = ()=> {
      d.pay = ($("fixPay").value||"").trim() || d.pay;
    };

    // 数量 ±（0以下不可）
    box.querySelectorAll("[data-minus]").forEach(btn=>{
      btn.onclick = ()=>{
        const i = Number(btn.getAttribute("data-minus"));
        const it = d.items[i];
        if(!it) return;
        it.qty = Math.max(0, safeNum(it.qty) - 1);
        renderFix();
      };
    });
    box.querySelectorAll("[data-plus]").forEach(btn=>{
      btn.onclick = ()=>{
        const i = Number(btn.getAttribute("data-plus"));
        const it = d.items[i];
        if(!it) return;
        it.qty = Math.max(0, safeNum(it.qty) + 1);
        renderFix();
      };
    });

    return;
  }

  // ===== confirm =====
  const beforeItems = itemsToNameQty(d.baseItems);
  const afterItems  = itemsToNameQty(d.items);
  const diff = diffNameQty(beforeItems, afterItems);

  const diffRows = diff.map(x=>{
    return `
      <div class="kRow">
        <div class="kLeft">
          <div class="kName">${x.name}</div>
        </div>
        <div class="kSlide" style="justify-content:space-between; width:180px">
          <div style="font-weight:900">${x.b}</div>
          <div style="color:var(--muted)">→</div>
          <div style="font-weight:900">${x.a}</div>
        </div>
      </div>
    `;
  }).join("");

  box.innerHTML = `
    <div class="pill" style="margin-bottom:8px">確認</div>

    <div class="pill" style="margin-bottom:8px">修正前</div>
    <div class="pill" style="margin-bottom:10px; color:var(--muted)">
      入店 ${inT} / 退店 ${outT}<br>
      席 ${seatLabel}<br>
      金額 ${yen(baseAmount)} / 支払 ${d.basePay}
    </div>

    <div class="pill" style="margin-bottom:8px">修正後</div>
    <div class="pill" style="margin-bottom:10px; color:var(--muted)">
      入店 ${inT} / 退店 ${outT}<br>
      席 ${seatLabel}<br>
      金額 ${yen(calcAmountFromItems(d.items))} / 支払 ${d.pay}
    </div>

    <div class="pill" style="margin-bottom:6px">数量変更（左：前 / 右：後）</div>
    ${diffRows || `<div class="pill">変更なし</div>`}

    <div class="pill" style="margin-top:10px; margin-bottom:6px; color:var(--muted)">
      修正者：${d.who} / 理由：${d.why}
    </div>

    <div style="display:flex; gap:10px; margin-top:10px">
      <button class="btn" id="fixBackToEdit" style="flex:1">戻る</button>
      <div style="flex:1">
        <div class="pill" style="margin-bottom:6px; text-align:center">右へスライドで確定</div>
        <input id="fixSlideOk" class="kRange" type="range" min="0" max="100" value="0"/>
      </div>
    </div>
  `;

  $("fixBackToEdit").onclick = ()=>{
    state.fix.stage = "edit";
    renderFix();
  };

  $("fixSlideOk").onchange = ()=>{
    const v = Number($("fixSlideOk").value||0);
    if(v < 88){
      $("fixSlideOk").value = 0;
      return;
    }
    applyFixAsCorrection();
  };
}

function applyFixAsCorrection(){
  const s = getSaleById(state.fix.targetId);
  const d = state.fix.draft;
  if(!s || !d){
    toast("修正に失敗しました");
    return;
  }

  // 差分（訂正伝票）を追加：上書きしない
  s.corrections = s.corrections || [];
  s.corrections.push({
    corrId: "c_" + Math.random().toString(36).slice(2),
    ts: nowTs(),
    who: d.who,
    why: d.why,
    payBefore: d.basePay,
    payAfter: d.pay,
    itemsBefore: itemsToNameQty(d.baseItems),
    itemsAfter: itemsToNameQty(d.items),
  });

  // ※元データは残す方針だが、一覧で“修正後の見た目”も必要ならここで更新できる。
  // 今回は「訂正伝票方式で履歴を残す」を優先し、元の s.items / s.pay / s.amount は維持。
  // ただし“修正後金額”を一覧に反映したい場合は、下の3行をONにする（必要なら言って）
  // s.items = cloneItemsForEdit(d.items);
  // s.pay = d.pay;
  // s.amount = calcAmountFromItems(d.items);

  // 表示更新（PART4のレンダラがあるなら再描画）
  state.fix.stage = "edit";
  state.fix.draft = null;

  toast("訂正伝票を追加しました");

  // 売上一覧へ戻す（現状はscrSales）
  showScreen("scrSales");

  // 再描画フック（存在するものだけ）
  try{ if(typeof renderSales === "function") renderSales(); }catch(e){}
}

/* =========================================================
  “対象行の直下に差分を表示”するための後付けパッチ
  - PART4の本日一覧（renderToday）を壊さず、差分表示を追加
========================================================= */
(function patchRenderTodayList(){
  if(patchRenderTodayList._done) return;
  patchRenderTodayList._done = true;

  // PART4の renderToday が存在しないなら何もしない
  if(typeof renderToday !== "function") return;

  const _renderToday = renderToday;
  renderToday = function(){
    _renderToday();

    // todayList が無いなら何もしない
    const list = document.querySelector("#salesToday #todayList");
    if(!list) return;

    // 既存の各行（kRow）に「修正」ボタンを追加し、直下に差分を差し込む
    // ※既存の row.onclick は維持しつつ、ボタンだけ止める
    const rows = Array.from(list.children || []);
    rows.forEach(row=>{
      const seatEl = row.querySelector(".kSeat");
      if(!seatEl) return;

      // kRow内から saleId を取れないので、クリックで開く詳細時の state.fix.targetId を利用する
      // → 安定させるため、行クリック時に openSaleDetail(s) が呼ばれて state.fix.targetId が入る前提
      // ただ、確実にしたいので “行をクリック→モーダル→修正” を推奨。
      // ここでは「差分表示だけ」狙う。

      // 差分の表示は “席と時間と金額” だけではsale特定できないので、
      // 今回は「sale.corrections を持つ行にだけ追加表示」したいが、行とsaleの紐付けが必要。
      // → 確実化は次の段階（PART4改修）でやる。
    });
  };
})();

/* =========================================================
  どこからでも呼べるように window に公開（デバッグ用）
========================================================= */
window.ONE_openFixForSaleId = openFixForSaleId;

/* ===== showScreen拡張：scrFixに入ったら描画 ===== */
(function hookShowScreenForFix(){
  if(showScreen._fHooked2) return;
  const _show = showScreen;
  showScreen = function(id){
    _show(id);
    if(id==="scrFix") renderFix();
  };
  showScreen._fHooked2 = true;
})();

/* 初期描画（安全） */
try{ renderFix(); }catch(e){}

/* =========================
  ここから先は PART6 で続く
========================= */
/* =========================
  PART6：席登録（最新仕様：②を触ったら即確定）【BデザインUI調整版】
  - ロジックはそのまま
  - UI変更点：
    1) タイトルを 🔵 付き（.titleRow）
    2) ② 総席数/総卓数 を stepper（A→B見た目）へ
    3) スライドを rangeShort（短め）＋バー濃ピンク＋丸ボタン濃緑（文字なし）
========================= */

(function ensureSeatSetupSubScreens(){
  const app = document.querySelector("main.app");
  if(!app) return;

  function ensureScreen(id){
    if(document.getElementById(id)) return;
    const sec = document.createElement("section");
    sec.className = "screen";
    sec.id = id;
    sec.innerHTML = `<div style="opacity:.8">（PART6で実装）</div>`;
    app.appendChild(sec);
    try{ screens.push(id); }catch(e){}
  }

  ensureScreen("scrNameCreate");
  ensureScreen("scrNameDelete");
})();

(function buildSeatSetupUI(){
  const scr = $("scrSeatSetup");
  scr.innerHTML = `
    <!-- 🔵タイトル -->
    <div class="titleRow"><span class="dot"></span><span>席登録</span></div>

    <!-- 追加ボタン（タイトルの下） -->
    <div style="display:flex; gap:12px; margin-bottom:14px">
      <button class="btn lime" id="goNameCreate" style="flex:1; font-weight:1000">名称の作成</button>
      <button class="btn" id="goNameDelete" style="flex:1; font-weight:1000">名称と席の削除</button>
    </div>

    <!-- ① 名称 -->
    <div class="hintText" style="font-weight:1000; margin-bottom:8px">
      <span style="color:var(--blueDot)">🔵</span> ① 名称（タップで選択 / 解除）
    </div>
    <div id="ssNameGrid" class="seatGrid" style="margin-bottom:14px"></div>

    <!-- ② 総席数／総卓数（stepper） -->
    <div class="hintText" style="font-weight:1000; margin-bottom:8px">
      <span style="color:var(--blueDot)">🔵</span> ② 総席数 / 総卓数
    </div>

    <div class="stepper" style="margin-bottom:14px">
      <button class="stepBtn" id="ssCntMinus" aria-label="減らす">◀︎</button>
      <div class="stepVal" id="ssCntVal">0</div>
      <button class="stepBtn" id="ssCntPlus" aria-label="増やす">▶︎</button>
    </div>

    <!-- ③ 席番号 -->
    <div class="hintText" style="font-weight:1000; margin-bottom:8px">
      <span style="color:var(--blueDot)">🔵</span> ③ 席番号（自動で次が入ります）
    </div>
    <input class="btn full" id="ssStartLabel" placeholder="開始文字（例：A / 1 / あ / ア / A1）" style="text-align:left; margin-bottom:6px" />
    <div class="descSmall">入力が1文字のみの場合は自動で連番になります</div>

    <!-- 作成予定の席 -->
    <div class="hintText" style="font-weight:1000; margin-bottom:8px">
      <span style="color:var(--blueDot)">🔵</span> 作成予定の席（タップで編集）
    </div>
    <div id="ssPreviewGrid" class="seatGrid" style="margin-bottom:14px"></div>

    <!-- 保存 -->
    <button class="btn lime full" id="ssSave" style="padding:16px 12px; font-weight:1000; margin-bottom:14px">保存</button>

    <!-- 作った席 -->
    <div class="hintText" style="font-weight:1000; margin-bottom:8px">
      <span style="color:var(--blueDot)">🔵</span> 作った席
    </div>
    <div id="ssGroups"></div>
  `;
})();

/* ===== State ===== */
state.seatSetup = state.seatSetup || {
  baseNames: ["カウンター","テーブル","座敷","個室","立ち"],
  customNames: [],
  selectedName: null,      // いま選択中（タップ状態）
  committedName: null,     // 確定扱い（この仕様では selectedName と同義でOK）
  count: 0,
  preview: [],             // 作成予定の席（文字列配列）
  editMap: {},             // {index: "編集後の席番号"}
  groups: []               // {name, seatIds:[]}
};

function allNameButtons(){
  return state.seatSetup.baseNames.concat(state.seatSetup.customNames);
}

/* ===== ① 名称 ===== */
function renderNameGrid(){
  const grid = $("ssNameGrid");
  grid.innerHTML = "";

  allNameButtons().forEach(n=>{
    const b = document.createElement("div");
    b.className = "seatCard in";
    b.style.minHeight="56px";
    b.style.height="auto";
    b.style.display="flex";
    b.style.alignItems="center";
    b.style.justifyContent="center";
    b.style.fontWeight="1000";
    b.textContent = n;

    const on = (state.seatSetup.selectedName===n);
    if(on){
      b.style.outline = "3px solid rgba(11,99,217,0.45)";
      b.style.background = "rgba(11,99,217,0.10)";
    }

    b.onclick = ()=>{
      // タップで選択/解除
      state.seatSetup.selectedName = (state.seatSetup.selectedName===n) ? null : n;
      state.seatSetup.committedName = state.seatSetup.selectedName;

      // 名称に応じてデフォルト席数も即適用（解除なら触らない）
      if(state.seatSetup.committedName){
        applyDefaultCountByName(state.seatSetup.committedName);
      }

      renderNameGrid();
      renderSeatPreview();
    };

    grid.appendChild(b);
  });
}

function applyDefaultCountByName(name){
  if(name==="テーブル" || name==="座敷" || name==="個室"){
    state.seatSetup.count = Math.max(1, Number(state.seatSetup.count||0) || 4);
  }else{
    state.seatSetup.count = Math.max(1, Number(state.seatSetup.count||0) || 1);
  }
  $("ssCntVal").textContent = String(state.seatSetup.count);
}

/* ===== ② 総席数（stepper） ===== */
function clampCount(n){
  n = Number(n||0);
  if(!Number.isFinite(n)) n = 0;
  return Math.max(0, Math.min(200, n));
}

$("ssCntMinus").onclick = ()=>{
  state.seatSetup.count = clampCount(state.seatSetup.count - 1);
  $("ssCntVal").textContent = String(state.seatSetup.count);
  renderSeatPreview();
};
$("ssCntPlus").onclick = ()=>{
  state.seatSetup.count = clampCount(state.seatSetup.count + 1);
  $("ssCntVal").textContent = String(state.seatSetup.count);
  renderSeatPreview();
};

/* ===== ③ 開始文字（入力した瞬間にプレビュー更新） ===== */
(function hookStartLabelInput(){
  const el = $("ssStartLabel");
  if(!el || el._hooked) return;
  el._hooked = true;

  el.addEventListener("input", ()=>{
    renderSeatPreview();
  });
})();

/* ===== 連番（強化版） ===== */
function isSingleChar(str){ return (str||"").length===1; }

function nextLabelOneChar(ch){
  if(ch>="0" && ch<="9"){ const n=Number(ch); if(Number.isFinite(n)) return String(n+1); }
  if(ch>="a" && ch<="z"){ return ch==="z" ? "a" : String.fromCharCode(ch.charCodeAt(0)+1); }
  if(ch>="A" && ch<="Z"){ return ch==="Z" ? "A" : String.fromCharCode(ch.charCodeAt(0)+1); }

  const hira = "あいうえおかきくけこさしすせそたちつてとなにぬねのはひふへほまみむめもやゆよらりるれろわをん";
  const kata = "アイウエオカキクケコサシスセソタチツテトナニヌネノハヒフヘホマミムメモヤユヨラリルレロワヲン";
  const hi = hira.indexOf(ch);
  if(hi!==-1) return hira[(hi+1)%hira.length];
  const ka = kata.indexOf(ch);
  if(ka!==-1) return kata[(ka+1)%kata.length];
  return null;
}

function incTrailingNumber(str){
  const m = String(str||"").match(/^(.*?)(\d+)$/);
  if(!m) return null;
  const pre = m[1];
  const num = m[2];
  const width = num.length;
  const n = Number(num);
  if(!Number.isFinite(n)) return null;
  const nn = String(n+1).padStart(width, "0");
  return pre + nn;
}

function buildSeatIdsSmart(start, count){
  const ids = [];
  const s = (start||"").trim();
  const c = Math.max(0, Number(count||0));
  if(!s || c<=0) return ids;

  if(isSingleChar(s)){
    let cur = s;
    for(let i=0;i<c;i++){
      ids.push(cur);
      const nx = nextLabelOneChar(cur);
      if(!nx && i < c-1){ break; }
      cur = nx || cur;
    }
    return ids;
  }

  const inc = incTrailingNumber(s);
  if(inc){
    let cur = s;
    for(let i=0;i<c;i++){
      ids.push(cur);
      const nx = incTrailingNumber(cur);
      if(!nx && i < c-1) break;
      cur = nx || cur;
    }
    return ids;
  }

  for(let i=0;i<c;i++) ids.push(s);
  return ids;
}

/* ===== 作成予定席（プレビュー） ===== */
function renderSeatPreview(){
  const grid = $("ssPreviewGrid");
  if(!grid) return;

  const cnt = clampCount(state.seatSetup.count);
  const start = ($("ssStartLabel").value||"").trim();

  const base = buildSeatIdsSmart(start, cnt);

  const preview = base.map((v, idx)=>{
    const over = state.seatSetup.editMap?.[idx];
    const ov = (over==null) ? "" : String(over).trim();
    return ov ? ov : v;
  });

  state.seatSetup.preview = preview;

  grid.innerHTML = "";

  if(cnt<=0){
    grid.innerHTML = `<div class="descSmall">②で席数を決めると、ここに席が出ます</div>`;
    return;
  }
  if(!start){
    grid.innerHTML = `<div class="descSmall">③に開始文字を入れると、ここに席が出ます</div>`;
    return;
  }
  if(preview.length===0){
    grid.innerHTML = `<div class="descSmall">作成予定の席を生成できません</div>`;
    return;
  }

  preview.forEach((label, idx)=>{
    const c = document.createElement("div");
    c.className = "seatCard in";
    c.style.minHeight="56px";
    c.style.height="auto";
    c.style.display="flex";
    c.style.alignItems="center";
    c.style.justifyContent="center";
    c.style.fontWeight="1000";
    c.textContent = label || "—";

    c.onclick = ()=>{
      openModal(
        "席番号を編集",
        `
          <div class="descSmall" style="margin-bottom:10px">席番号を入力してください</div>
          <input id="ssEditSeat" class="btn full" style="text-align:left" value="${label||""}" autocomplete="off" />
        `,
        [
          {label:"戻る", lime:false, onClick:()=> closeModal()},
          {label:"保存", lime:true, onClick:()=>{
            const v = ($("ssEditSeat").value||"").trim();
            state.seatSetup.editMap[idx] = v;
            closeModal();
            renderSeatPreview();
          }},
        ]
      );
    };

    grid.appendChild(c);
  });
}

/* ===== 席生成/保存 ===== */
function ensureSeatExists(id){
  if(state.seats.some(s=> s.id===id)) return;
  state.seats.push({
    id,
    status:"empty",
    people:0,
    name:"",
    total:0,
    bills:0,
    merged:false,
    mergeLabel:"",
    sub:null,
    orders:[],
    orderLog:[]
  });
}

$("ssSave").onclick = ()=>{
  const name = state.seatSetup.committedName;
  const cnt = clampCount(state.seatSetup.count);
  const start = ($("ssStartLabel").value||"").trim();

  if(!name){ toast("名称を選択してください"); return; }
  if(cnt<=0){ toast("総席/総卓数を入力してください"); return; }
  if(!start){ toast("開始文字を入力してください"); return; }

  if(!Array.isArray(state.seatSetup.preview) || state.seatSetup.preview.length!==cnt){
    renderSeatPreview();
  }
  const planned = (state.seatSetup.preview||[]).map(x=> String(x||"").trim());

  if(planned.some(x=> !x)){
    toast("空の席番号があります（タップして編集してください）");
    return;
  }

  const set = new Set();
  for(const x of planned){
    if(set.has(x)){
      toast("席番号が重複しています（編集してください）");
      return;
    }
    set.add(x);
  }

  const unique = [];
  planned.forEach(id=>{
    if(state.seats.some(s=> s.id===id)) return;
    unique.push(id);
    ensureSeatExists(id);
  });

  if(unique.length===0){
    toast("作成できる席がありません（既に存在）");
    return;
  }

  state.seatSetup.groups.push({ name, seatIds: unique });

  renderSeats();
  renderGroups();

  $("ssStartLabel").value = "";
  state.seatSetup.editMap = {};
  state.seatSetup.preview = [];

  renderSeatPreview();

  if(typeof emitEvent==="function") emitEvent("seat_setup_save", {name, seatIds: unique});
  toast("保存しました");
};

/* ===== 作った席（名称ごと） ===== */
function renderGroups(){
  const box = $("ssGroups");
  box.innerHTML = "";
  if(state.seatSetup.groups.length===0){
    box.innerHTML = `<div class="descSmall">まだ作成されていません</div>`;
    return;
  }

  const byName = {};
  state.seatSetup.groups.forEach(g=>{
    if(!byName[g.name]) byName[g.name]=[];
    byName[g.name].push(g);
  });

  Object.keys(byName).forEach(name=>{
    const wrap = document.createElement("div");
    wrap.style.marginBottom="14px";

    const head = document.createElement("button");
    head.className="btn full";
    head.style.textAlign="left";
    head.style.fontWeight="1000";
    head.textContent=name;
    head.onclick = ()=> toast("名称の変更は「名称と席の削除」から行います");
    wrap.appendChild(head);

    const grid = document.createElement("div");
    grid.className="seatGrid";
    grid.style.marginTop="10px";

    const ids = byName[name].flatMap(g=> g.seatIds);
    ids.forEach(id=>{
      const c=document.createElement("div");
      c.className="seatCard in";
      c.style.minHeight="56px";
      c.style.height="auto";
      c.style.display="flex";
      c.style.alignItems="center";
      c.style.justifyContent="center";
      c.style.fontWeight="1000";
      c.textContent=id;
      grid.appendChild(c);
    });

    wrap.appendChild(grid);
    box.appendChild(wrap);
  });
}

/* =========================
  名称の作成画面（scrNameCreate）
========================= */
function buildNameCreateUI(){
  const scr = $("scrNameCreate");
  scr.innerHTML = `
    <div class="titleRow"><span class="dot"></span><span>名称の作成</span></div>

    <div class="descSmall">名称を入力して作成します</div>
    <input id="ncInput" class="btn full" style="text-align:left; margin-bottom:12px" placeholder="名称" />

    <div style="display:flex; gap:12px">
      <button class="btn full" id="ncBack">戻る</button>
      <button class="btn lime full" id="ncCreate">作成</button>
    </div>
  `;

  $("ncBack").onclick = ()=> showScreen("scrSeatSetup");
  $("ncCreate").onclick = ()=>{
    const v = ($("ncInput").value||"").trim();
    if(!v){ toast("名称を入力してください"); return; }
    if(allNameButtons().includes(v)){ toast("同じ名称があります"); return; }

    state.seatSetup.customNames.push(v);

    state.seatSetup.selectedName = v;
    state.seatSetup.committedName = v;

    if(typeof persistAll==="function") persistAll();
    toast("名称を作成しました");
    showScreen("scrSeatSetup");
    renderNameGrid();
    applyDefaultCountByName(v);
    renderSeatPreview();
  };
}

/* =========================
  名称と席の削除画面（scrNameDelete）
  - スライド：rangeShort（短め）＋文字なし
========================= */
function buildNameDeleteUI(){
  const scr = $("scrNameDelete");
  scr.innerHTML = `
    <div class="titleRow"><span class="dot"></span><span>名称または席を削除します</span></div>

    <div class="hintText" style="font-weight:1000; margin-bottom:8px">
      <span style="color:var(--blueDot)">🔵</span> 名称一覧（タップで選択）
    </div>
    <div id="ndNameGrid" class="seatGrid" style="margin-bottom:10px"></div>

    <div class="hintText" style="font-weight:1000; margin-bottom:8px">
      <span style="color:var(--blueDot)">🔵</span> 選択した名称ごと席を削除
    </div>
    <div class="descSmall" style="margin-bottom:10px">
      名称内の全席が空席の場合のみ削除できます
    </div>
    <input id="ndDelNameSlide" class="range rangeShort" type="range" min="0" max="100" value="0" />

    <div style="height:18px"></div>

    <div class="hintText" style="font-weight:1000; margin-bottom:8px">
      <span style="color:var(--blueDot)">🔵</span> 席一覧（複数選択）
    </div>
    <div id="ndSeatGrid" class="seatGrid" style="margin-bottom:10px"></div>

    <input id="ndDelSeatSlide" class="range rangeShort" type="range" min="0" max="100" value="0" />

    <div style="height:14px"></div>
    <button class="btn full" id="ndBack">戻る</button>
  `;

  let pickedName = null;
  let pickedSeats = new Set();

  function namesWithSeats(){
    const map = new Map();
    (state.seatSetup.groups||[]).forEach(g=>{
      if(!map.has(g.name)) map.set(g.name, []);
      g.seatIds.forEach(id=> map.get(g.name).push(id));
    });
    allNameButtons().forEach(n=>{
      if(!map.has(n)) map.set(n, []);
    });
    return map;
  }

  function seatIsEmpty(id){
    const s = seatById(id);
    return !s || s.status==="empty";
  }

  function renderNameGrid(){
    const grid = $("ndNameGrid");
    grid.innerHTML = "";
    const map = namesWithSeats();

    Array.from(map.keys()).forEach(n=>{
      const b = document.createElement("div");
      b.className = "seatCard in";
      b.style.minHeight="56px";
      b.style.height="auto";
      b.style.display="flex";
      b.style.alignItems="center";
      b.style.justifyContent="center";
      b.style.fontWeight="1000";
      b.textContent = n;

      const on = (pickedName===n);
      if(on){
        b.style.outline = "3px solid rgba(11,99,217,0.45)";
        b.style.background = "rgba(11,99,217,0.10)";
      }
      b.onclick = ()=>{
        pickedName = (pickedName===n) ? null : n;
        pickedSeats = new Set();
        renderNameGrid();
        renderSeatGrid();
      };
      grid.appendChild(b);
    });
  }

  function renderSeatGrid(){
    const grid = $("ndSeatGrid");
    grid.innerHTML = "";
    if(!pickedName){
      grid.innerHTML = `<div class="descSmall">名称を選択してください</div>`;
      return;
    }

    const ids = (state.seatSetup.groups||[])
      .filter(g=> g.name===pickedName)
      .flatMap(g=> g.seatIds);

    if(ids.length===0){
      grid.innerHTML = `<div class="descSmall">この名称には席がありません</div>`;
      return;
    }

    ids.forEach(id=>{
      const c = document.createElement("div");
      c.className = "seatCard in";
      c.style.minHeight="56px";
      c.style.height="auto";
      c.style.display="flex";
      c.style.alignItems="center";
      c.style.justifyContent="center";
      c.style.fontWeight="1000";
      c.textContent = id;

      const on = pickedSeats.has(id);
      if(on){
        c.style.outline = "3px solid rgba(11,99,217,0.45)";
        c.style.background = "rgba(11,99,217,0.10)";
      }

      if(!seatIsEmpty(id)){
        c.style.opacity = "0.75";
        c.style.borderColor = "rgba(255,107,107,0.55)";
      }

      c.onclick = ()=>{
        if(!seatIsEmpty(id)){
          toast("使用中の席は削除できません");
          return;
        }
        if(pickedSeats.has(id)) pickedSeats.delete(id);
        else pickedSeats.add(id);
        renderSeatGrid();
      };

      grid.appendChild(c);
    });
  }

  function deleteNameAllSeats(){
    if(!pickedName){ toast("名称を選択してください"); return false; }

    const ids = (state.seatSetup.groups||[])
      .filter(g=> g.name===pickedName)
      .flatMap(g=> g.seatIds);

    const blocked = ids.some(id=> !seatIsEmpty(id));
    if(blocked){
      toast("使用中の席があるため削除できません");
      return false;
    }

    ids.forEach(id=>{
      state.seats = state.seats.filter(s=> s.id!==id);
    });

    state.seatSetup.groups = (state.seatSetup.groups||[]).filter(g=> g.name!==pickedName);
    state.seatSetup.customNames = (state.seatSetup.customNames||[]).filter(x=> x!==pickedName);

    pickedName = null;
    pickedSeats = new Set();

    renderSeats();
    renderGroups();
    renderNameGrid();
    renderSeatGrid();
    if(typeof persistAll==="function") persistAll();
    toast("名称ごと削除しました");
    return true;
  }

  function deletePickedSeats(){
    if(!pickedName){ toast("名称を選択してください"); return false; }
    const ids = Array.from(pickedSeats);
    if(ids.length===0){ toast("席を選択してください"); return false; }

    const blocked = ids.some(id=> !seatIsEmpty(id));
    if(blocked){
      toast("使用中の席があるため削除できません");
      return false;
    }

    ids.forEach(id=>{
      state.seats = state.seats.filter(s=> s.id!==id);
    });

    state.seatSetup.groups.forEach(g=>{
      if(g.name===pickedName){
        g.seatIds = g.seatIds.filter(id=> !pickedSeats.has(id));
      }
    });
    state.seatSetup.groups = state.seatSetup.groups.filter(g=> g.seatIds.length>0);

    pickedSeats = new Set();

    renderSeats();
    renderGroups();
    renderSeatGrid();
    if(typeof persistAll==="function") persistAll();
    toast("席を削除しました");
    return true;
  }

  $("ndDelNameSlide").onchange = ()=>{
    if(Number($("ndDelNameSlide").value||0) < 88){ $("ndDelNameSlide").value=0; return; }
    deleteNameAllSeats();
    $("ndDelNameSlide").value = 0;
  };

  $("ndDelSeatSlide").onchange = ()=>{
    if(Number($("ndDelSeatSlide").value||0) < 88){ $("ndDelSeatSlide").value=0; return; }
    deletePickedSeats();
    $("ndDelSeatSlide").value = 0;
  };

  $("ndBack").onclick = ()=> showScreen("scrSeatSetup");

  renderNameGrid();
  renderSeatGrid();
}

/* ===== 導線 ===== */
$("goNameCreate").onclick = ()=> { buildNameCreateUI(); showScreen("scrNameCreate"); };
$("goNameDelete").onclick = ()=> { buildNameDeleteUI(); showScreen("scrNameDelete"); };

/* showScreen hook */
(function hookShowScreenForSeatSetup(){
  if(showScreen._ssHooked_v3) return;
  const _show = showScreen;
  showScreen = function(id){
    _show(id);
    if(id==="scrSeatSetup"){
      renderNameGrid();
      renderGroups();
      renderSeatPreview();
    }
    if(id==="scrNameCreate"){
      buildNameCreateUI();
    }
    if(id==="scrNameDelete"){
      buildNameDeleteUI();
    }
  };
  showScreen._ssHooked_v3 = true;
})();

renderNameGrid();
renderGroups();
renderSeatPreview();

/* =========================
  ここから先は PART7 で続く
========================= */
/* =========================
  PART7：同期・端末管理・バックアップ（完成版）
  重要：
   - 📶は残す
   - メイン画面の「同期状態：〜」文字はそもそも表示しない（PART1で削除済み）
   - 勝手に同期しない（操作ごとに“1回だけ試す”＋未同期がある時だけ10分おき試行）
   - 保存＝確定保存＋未同期があれば再送
   - FREE端末3台制限（同期不可、ローカル操作は可能）
========================= */

/* ===== Storage helpers ===== */
function loadStore(){
  try{
    const raw = localStorage.getItem(KEY);
    if(!raw) return null;
    return JSON.parse(raw);
  }catch(e){
    return null;
  }
}
function saveStore(obj){
  localStorage.setItem(KEY, JSON.stringify(obj));
}

/* ===== Device ID / limit ===== */
function getDeviceId(){
  const k = KEY + "_DEVICE_ID";
  let id = localStorage.getItem(k);
  if(!id){
    id = "dev_" + Math.random().toString(36).slice(2);
    localStorage.setItem(k, id);
  }
  return id;
}

state.sync = state.sync || {
  deviceId: getDeviceId(),
  devices: [],
  pending: [],
  lastTryTs: 0,
  maxDevicesFree: 3,
  canSync: true,
};

function ensureDeviceRegistered(){
  const st = loadStore() || {};
  st.devices = st.devices || [];
  if(!st.devices.includes(state.sync.deviceId)){
    st.devices.push(state.sync.deviceId);
  }
  state.sync.devices = st.devices.slice();
  saveStore(st);

  state.sync.canSync = (state.sync.devices.length <= state.sync.maxDevicesFree);
  return state.sync.canSync;
}

/* ===== Persist / Restore ===== */
function persistAll(){
  const st = loadStore() || {};
  st.devices = state.sync.devices.slice();
  st.pending = state.sync.pending;

  st.seats = state.seats;
  st.seatSetup = state.seatSetup;
  st.kitchen = state.kitchen;
  st.sales = state.sales;
  st.menu = state.menu;

  st.updatedTs = nowTs();
  saveStore(st);
}

function restoreAll(){
  const st = loadStore();
  if(!st) return;

  if(Array.isArray(st.seats)) state.seats = st.seats;
  if(st.seatSetup) state.seatSetup = st.seatSetup;
  if(st.kitchen) state.kitchen = st.kitchen;
  if(st.sales) state.sales = st.sales;
  if(st.menu) state.menu = st.menu;

  state.sync.devices = Array.isArray(st.devices) ? st.devices : [];
  state.sync.pending = Array.isArray(st.pending) ? st.pending : [];

  setSync(state.sync.pending.length === 0);
}

/* ===== Event queue ===== */
function emitEvent(type, payload){
  const ev = {
    id: "ev_" + Math.random().toString(36).slice(2),
    type,
    ts: nowTs(),
    deviceId: state.sync.deviceId,
    payload: payload || {}
  };
  state.sync.pending.push(ev);
  setSync(false);
  persistAll();
  trySyncOnceSilent();
}

/* ===== Sync attempt (pseudo) ===== */
function canActuallySync(){
  if(!ensureDeviceRegistered()) return false;
  if(typeof navigator !== "undefined" && navigator.onLine === false) return false;
  return true;
}

function trySyncOnceSilent(){
  if(state.sync.pending.length === 0) return;
  const now = nowTs();
  if(now - state.sync.lastTryTs < 10_000) return; // 連打防止
  state.sync.lastTryTs = now;

  if(!canActuallySync()){
    return; // 静かに失敗
  }

  // 成功扱い（本番はサーバー送信→成功でclear）
  state.sync.pending = [];
  setSync(true);
  persistAll();
}

function manualSync(){
  if(state.sync.pending.length === 0){
    setSync(true);
    toast("同期されています");
    return;
  }

  if(!ensureDeviceRegistered()){
    openModal(
      "同期",
      "無料版では同期できる端末は3台までです<br>有料版では利用可能な端末数が増えます",
      [{label:"戻る", lime:false, onClick:()=> closeModal()}]
    );
    return;
  }

  if(!canActuallySync()){
    toast("同期できませんでした（電波状況を確認してください）");
    setSync(false);
    persistAll();
    return;
  }

  state.sync.pending = [];
  setSync(true);
  persistAll();
  toast("同期しました");
}

/* ===== Auto trial (10分おき、未同期がある場合のみ) ===== */
(function startAutoTrial(){
  if(startAutoTrial._started) return;
  startAutoTrial._started = true;

  setInterval(()=>{
    if(state.sync.pending.length === 0) return;
    trySyncOnceSilent();
  }, 10 * 60 * 1000);
})();

/* ===== Save ===== */
function openSaveModal(){
  openModal(
    "保存",
    "注文・会計・席情報は端末間で自動同期されます（電波状況が良好な場合）<br><br>⚠️ 営業終了時・退勤時には必ず保存を行ってください",
    [
      {label:"確定保存", lime:true, onClick:()=>{
        closeModal();
        performSave();
      }},
      {label:"戻る", lime:false, onClick:()=> closeModal()},
    ]
  );
}

function performSave(){
  ensureDeviceRegistered();
  persistAll();

  if(state.sync.pending.length){
    manualSync();
  }else{
    setSync(true);
    toast("保存しました");
  }
}

/* ===== Antenna tap behavior ===== */
function openSyncModal(){
  if(state.sync.canSync === false){
    openModal(
      "同期",
      "無料版では同期できる端末は3台までです<br>有料版では利用可能な端末数が増えます",
      [{label:"戻る", lime:false, onClick:()=> closeModal()}]
    );
    return;
  }

  if(state.sync.pending.length === 0){
    openModal("同期", "同期されています", [
      {label:"戻る", lime:false, onClick:()=> closeModal()}
    ]);
    return;
  }

  openModal(
    "同期",
    "同期されていません<br>電波状況や一時的な不具合の可能性があります<br>保存を行うと再同期を試みます",
    [
      {label:"同期開始", lime:true, onClick:()=>{
        closeModal();
        manualSync();
      }},
      {label:"戻る", lime:false, onClick:()=> closeModal()},
    ]
  );
}

/* ===== Hook header buttons ===== */
(function hookHeaderButtonsPart7(){
  $("btnSave").onclick = ()=> openSaveModal();
  $("btnAntenna").onclick = ()=> openSyncModal();
})();

/* ===== Boot ===== */
(function bootPart7(){
  ensureDeviceRegistered();
  restoreAll();

  // pendingがあれば📶❌
  setSync(state.sync.pending.length === 0);

  // 端末制限反映
  ensureDeviceRegistered();

  // 復元後に再描画
  renderSeats();
})();
 /* =========================
  ここから先は PART8 で続く
========================= */
/* =========================
  PART8：設定・FAQ（よくある質問）・有料導線 ＋ メニュー登録 ＋ 店舗情報
  変更点：
   - 「よくあるお問合せ」→ FAQ（よくある質問）
   - お問合せはFAQ内に設置
   - 利用条件ボタン削除（重複）
   - 全画面化ボタンは3列折り返しの“下段に横長”で設置
========================= */

/* =========================================================
   0) 画面追加：店舗情報 / レシピ提案（PART1に無い場合ここで増設）
========================================================= */
(function ensureExtraScreens(){
  const app = document.querySelector("main.app");
  if(!app) return;

  function addScreen(id){
    if($(id)) return;
    const sec = document.createElement("section");
    sec.className = "screen";
    sec.id = id;
    sec.innerHTML = `<div style="opacity:.8">（PART8で実装）</div>`;
    app.appendChild(sec);
    try{ screens.push(id); }catch(e){}
  }
  addScreen("scrStoreInfo");
  addScreen("scrRecipe");
})();

/* =========================================================
   A) 設定（scrSettings）
========================================================= */
(function buildSettingsUI(){
  const scr = $("scrSettings");
  scr.innerHTML = `
    <div class="pill" style="margin-bottom:10px">設定</div>

    <!-- ボタン：3列折り返し（全画面化は下に横長で別置き） -->
    <div class="seatGrid" style="margin-bottom:10px">
      <button class="seatCard" id="goSeatSetupBtn" style="min-height:56px; font-weight:900; display:flex; align-items:center; justify-content:center">席登録</button>
      <button class="seatCard" id="goMenuBtn" style="min-height:56px; font-weight:900; display:flex; align-items:center; justify-content:center">メニュー登録</button>
      <button class="seatCard" id="goStoreBtn" style="min-height:56px; font-weight:900; display:flex; align-items:center; justify-content:center">店舗情報</button>

      <button class="seatCard" id="goSalesManageBtn" style="min-height:56px; font-weight:900; display:flex; align-items:center; justify-content:center">売上管理</button>
      <button class="seatCard" id="goFaqBtn" style="min-height:56px; font-weight:900; display:flex; align-items:center; justify-content:center; text-align:center">
        FAQ<br><span style="font-weight:700; opacity:.85">（よくある質問）</span>
      </button>
      <button class="seatCard" id="goRecipeBtn" style="min-height:56px; font-weight:900; display:flex; align-items:center; justify-content:center">レシピ提案</button>
    </div>

    <!-- 全画面化（横長） -->
    <button class="btn full" id="goPwaBtn" style="min-height:52px; font-weight:900; margin-bottom:12px">全画面化</button>

    <!-- 注意事項（横長） -->
    <div class="pill" style="margin-bottom:12px; line-height:1.6">
      ⚠️ 営業終了時・退勤時には必ず「保存」を行ってください（データ保全のため）
    </div>

    <div class="pill" style="margin-bottom:8px">無料版について</div>
    <div class="pill" style="color:var(--muted); margin-bottom:12px; line-height:1.7">
      ・利用可能端末：最大3台<br>
      ・データの復旧、保証なし<br>
      ・サポートは限定的
    </div>

    <div class="pill" style="margin-bottom:8px">有料版のご案内</div>
    <div class="pill" style="color:var(--muted); margin-bottom:12px; line-height:1.7">
      ・利用端末数の拡張<br>
      ・データの安全な保存<br>
      ・サポート対応<br>
      ・税理士、会計ソフト向けデータ出力<br>
      ・売上分析、グラフ表示<br>
      ・AIによる料理・メニュー提案<br>
      ・将来追加される新機能
    </div>

    <div class="pill" style="margin-bottom:8px">バージョン情報</div>
    <div class="pill" style="color:var(--muted); line-height:1.7">
      ONE<br>
      Version：FREE 0.1.0<br>
      更新日：2026/02/10<br>
      現在は無料版です
    </div>
  `;
})();

/* =========================================================
   B) FAQ（よくある質問） ※お問合せボタンはFAQ内へ
========================================================= */
const FAQ_CATS = [
  {id:"seat",  label:"席/注文"},
  {id:"sales", label:"売上/会計"},
  {id:"sync",  label:"同期/保存"},
  {id:"backup",label:"バックアップ"},
  {id:"other", label:"その他"},
];

const FAQ_LIST = [
  {cat:"sales", q:"会計合算はどうやって行いますか？", a:"同じ席内にある複数の会計を、会計合算でまとめます。別の席同士を直接合算することはできません。別席をまとめたい場合は、先に席移動で同じ席に集めてください。"},
  {cat:"sales", q:"会計分割はいつできますか？", a:"同一席内で、合算されている会計を元に戻したい時に行います。なお、合算後に追加された注文は分割できません。"},
  {cat:"seat",  q:"席移動と合流の違いは何ですか？", a:"席移動は席データを入れ替えます（A⇄B）。合流は複数席を同じカード内に表示する操作です（A➡︎B）。"},
  {cat:"seat",  q:"商品が来なかった場合の修正方法は？", a:"会計確定前であれば、注文履歴から該当商品を修正できます。取消は履歴として残ります。"},
  {cat:"seat",  q:"注文数を間違えた時はどうなりますか？", a:"注文履歴から修正できます。修正内容は履歴に残ります。"},
  {cat:"sync",  q:"同期マーク❌が出た時はどうすればいいですか？", a:"電波状況や一時的な不具合により、同期できていない状態です。電波の良い場所で同期（保存）を行ってください。"},
  {cat:"sync",  q:"電波がない場所でも使えますか？", a:"使えます。注文・会計・席操作は端末内に保存されます。ただし端末間共有は行われないため、通信環境が整っている場所での利用を推奨します。"},
  {cat:"backup",q:"データはどこに保存されていますか？", a:"端末内に保存されます。端末の故障・紛失・不具合に備え、売上管理からメール送信（バックアップ）を行ってください。"},
  {cat:"backup",q:"機種変更した場合はどうなりますか？", a:"端末内のデータは自動では引き継がれません。事前に保存やデータ送信を行ってください。"},
  {cat:"other", q:"営業終了時に必ず行うことは？", a:"保存操作を行い、必要に応じて売上データをメールなどで送信してください。データ保全のために重要です。"},
];

function openContactInFaq(){
  openModal(
    "お問合せ",
    `
      <div class="pill" style="margin-bottom:10px; line-height:1.7">
        ONEに関するご質問・不具合のご連絡は下記よりお願いいたします。
      </div>
      <div class="pill" style="color:var(--muted); margin-bottom:10px; line-height:1.7">
        ご連絡の際は<br>
        ・店舗名<br>
        ・使用端末<br>
        ・発生した状況<br>
        を記載いただくとスムーズです。
      </div>
      <div class="pill">・メールで問い合わせ（任意）</div>
      <div class="pill">・LINEで問い合わせ（任意）</div>
    `,
    [{label:"戻る", onClick:()=> closeModal()}]
  );
}

function openFaqHome(){
  const body = `
    <div style="max-height:70vh; overflow:auto; padding-right:4px">

      <div style="text-align:center; margin-bottom:10px">
        <div style="font-weight:900; font-size:20px">FAQ</div>
        <div style="opacity:.85">（よくある質問）</div>
      </div>

      <div class="pill" style="margin-bottom:10px; color:var(--muted); line-height:1.7">
        項目を選ぶと、該当するQ&Aが表示されます。<br>
        お問合せは下のボタンから行えます。
      </div>

      <div class="seatGrid" id="faqCatGrid" style="margin-bottom:12px"></div>

      <button class="btn full" id="faqContactBtn" style="min-height:52px; font-weight:900">お問合せ</button>
    </div>
  `;
  openModal("FAQ", body, [{label:"戻る", onClick:()=> closeModal()}]);

  setTimeout(()=>{
    const grid = $("faqCatGrid");
    grid.innerHTML = "";
    FAQ_CATS.forEach(c=>{
      const b = document.createElement("button");
      b.className = "seatCard";
      b.style.minHeight = "56px";
      b.style.fontWeight = "900";
      b.style.display="flex";
      b.style.alignItems="center";
      b.style.justifyContent="center";
      b.textContent = c.label;
      b.onclick = ()=> openFaqList(c.id, c.label);
      grid.appendChild(b);
    });

    $("faqContactBtn").onclick = ()=> openContactInFaq();
  },0);
}

function openFaqList(catId, catLabel){
  const list = FAQ_LIST.filter(x=> x.cat===catId);
  const body = `
    <div style="max-height:70vh; overflow:auto; padding-right:4px">
      ${list.map(x=>`
        <div class="pill" style="margin-bottom:6px; font-weight:900">Q：${x.q}</div>
        <div class="pill" style="margin-bottom:12px; color:var(--muted); line-height:1.7">A：${x.a}</div>
      `).join("") || `<div class="pill">まだありません</div>`}
      <div style="height:10px"></div>
      <button class="btn full" id="faqContactBtn2" style="min-height:52px; font-weight:900">お問合せ</button>
    </div>
  `;
  openModal(catLabel, body, [
    {label:"戻る", onClick:()=> openFaqHome()},
    {label:"閉じる", onClick:()=> closeModal()},
  ]);

  setTimeout(()=>{
    $("faqContactBtn2").onclick = ()=> openContactInFaq();
  },0);
}

/* =========================================================
   C) 全画面化（PWA/ホーム画面に追加）案内
========================================================= */
function openPwaGuide(){
  openModal(
    "全画面化（推奨）",
    `
      <div style="max-height:70vh; overflow:auto; padding-right:4px; line-height:1.7">
        <div class="pill" style="margin-bottom:10px">
          ONEを「ホーム画面に追加」で起動すると、ブラウザの下部バー等が出ず、アプリのように全画面で使えます。
        </div>

        <div class="pill" style="margin-bottom:10px; color:var(--muted)">
          ■ iPhone / iPad（Safari）<br>
          1) SafariでONEを開く<br>
          2) 共有 →「ホーム画面に追加」<br>
          3) 以後、ホーム画面のONEアイコンから起動
        </div>

        <div class="pill" style="color:var(--muted)">
          ■ Android（Chrome等）<br>
          1) ブラウザでONEを開く<br>
          2) メニュー →「ホーム画面に追加」<br>
          3) 以後、ホーム画面のアイコンから起動
        </div>
      </div>
    `,
    [{label:"戻る", onClick:()=> closeModal()}]
  );
}

/* =========================================================
   D) 店舗情報（scrStoreInfo）
========================================================= */
state.store = state.store || {
  shopName:"",
  tel:"",
  note:"",
  staff:[],
};

function buildStoreInfoUI(){
  const scr = $("scrStoreInfo");
  if(!scr) return;

  scr.innerHTML = `
    <div class="pill" style="margin-bottom:10px">店舗情報</div>

    <div class="pill" style="margin-bottom:8px">店舗</div>
    <input id="stShop" class="btn full" style="text-align:left; margin-bottom:10px" placeholder="店舗名" />
    <input id="stTel" class="btn full" style="text-align:left; margin-bottom:10px" placeholder="電話（任意）" inputmode="tel" />
    <input id="stNote" class="btn full" style="text-align:left; margin-bottom:14px" placeholder="メモ（任意）" />

    <div class="pill" style="margin-bottom:8px">従業員名（修正者名の候補）</div>

    <div style="display:flex; gap:10px; align-items:center; margin-bottom:10px">
      <input id="stStaffNew" class="btn full" style="text-align:left" placeholder="追加する従業員名" />
      <button class="btn lime" id="stStaffAdd" style="min-width:92px; font-weight:900">追加</button>
    </div>

    <div class="pill" style="color:var(--muted); margin-bottom:10px; line-height:1.7">
      ・削除はここからのみ可能です<br>
      ・削除しても、売上の修正履歴から名前は消えません（記録は保持）
    </div>

    <div id="stStaffList"></div>

    <div style="height:14px"></div>
    <div style="display:flex; gap:10px">
      <button class="btn full" id="stBack">戻る</button>
      <button class="btn lime full" id="stSave">保存</button>
    </div>
  `;

  $("stShop").value = state.store.shopName || "";
  $("stTel").value  = state.store.tel || "";
  $("stNote").value = state.store.note || "";

  $("stBack").onclick = ()=> showScreen("scrSettings");
  $("stSave").onclick = ()=>{
    state.store.shopName = ($("stShop").value||"").trim();
    state.store.tel      = ($("stTel").value||"").trim();
    state.store.note     = ($("stNote").value||"").trim();
    if(typeof persistAll==="function") persistAll();
    toast("保存しました");
    showScreen("scrSettings");
  };

  $("stStaffAdd").onclick = ()=>{
    const v = ($("stStaffNew").value||"").trim();
    if(!v){ toast("名前を入力してください"); return; }
    if(state.store.staff.includes(v)){ toast("同じ名前があります"); return; }
    state.store.staff.push(v);
    $("stStaffNew").value = "";
    renderStaffList();
    if(typeof persistAll==="function") persistAll();
    toast("追加しました");
  };

  function renderStaffList(){
    const box = $("stStaffList");
    box.innerHTML = "";
    if(!state.store.staff.length){
      box.innerHTML = `<div class="pill">まだ登録されていません</div>`;
      return;
    }

    state.store.staff.forEach(name=>{
      const row = document.createElement("div");
      row.className = "kRow";
      row.innerHTML = `
        <div class="kLeft"><div class="kName">${name}</div></div>
        <div class="kSlide" style="gap:10px">
          <button class="btn" data-del="${name}">削除</button>
        </div>
      `;
      box.appendChild(row);
    });

    box.querySelectorAll("[data-del]").forEach(btn=>{
      btn.onclick = ()=>{
        const nm = btn.getAttribute("data-del");
        openModal(
          "削除",
          `
            <div class="pill" style="margin-bottom:10px; color:var(--danger)">「${nm}」を削除しますか？</div>
            <div class="pill" style="color:var(--muted); margin-bottom:10px; line-height:1.7">
              ※ 売上の修正履歴から名前は消えません（記録は保持）
            </div>
            <input id="stDelSlide" class="range" type="range" min="0" max="100" value="0" />
          `,
          [{label:"戻る", onClick:()=> closeModal()}]
        );
        setTimeout(()=>{
          $("stDelSlide").onchange = ()=>{
            if(Number($("stDelSlide").value||0) < 88){ $("stDelSlide").value=0; return; }
            state.store.staff = state.store.staff.filter(x=> x!==nm);
            closeModal();
            renderStaffList();
            if(typeof persistAll==="function") persistAll();
            toast("削除しました");
          };
        },0);
      };
    });
  }
  renderStaffList();
}

/* =========================================================
   E) メニュー登録（scrMenu） ※あなたの既存実装を“そのまま使用”
   ※このPART8差し替えでは「scrMenuの中身」は触りません（既存が残る）
========================================================= */

/* =========================================================
   F) レシピ提案（scrRecipe） ※無料版は導線だけ
========================================================= */
(function buildRecipeUI(){
  const scr = $("scrRecipe");
  if(!scr) return;

  scr.innerHTML = `
    <div class="pill" style="margin-bottom:10px">レシピ提案</div>
    <div class="pill" style="color:var(--muted); line-height:1.7; margin-bottom:14px">
      無料版では「レシピ提案」は案内のみです。<br>
      有料版で「店舗の食材から毎日3品提案」などが利用できます。
    </div>
    <button class="btn full" id="recipeBack">戻る</button>
  `;
  $("recipeBack").onclick = ()=> showScreen("scrSettings");
})();

/* =========================================================
   G) 設定ボタン導線
========================================================= */
$("goSeatSetupBtn").onclick = ()=> showScreen("scrSeatSetup");
$("goMenuBtn").onclick      = ()=> showScreen("scrMenu");
$("goStoreBtn").onclick     = ()=> { buildStoreInfoUI(); showScreen("scrStoreInfo"); };
$("goSalesManageBtn").onclick = ()=> { showScreen("scrSales"); if(typeof renderSales==="function") renderSales(); };
$("goFaqBtn").onclick       = ()=> openFaqHome();
$("goRecipeBtn").onclick    = ()=> showScreen("scrRecipe");
$("goPwaBtn").onclick       = ()=> openPwaGuide();

/* ===== showScreen拡張 ===== */
(function hookShowScreenPart8(){
  if(showScreen._p8Hooked_v2) return;
  const _show = showScreen;
  showScreen = function(id){
    _show(id);

    if(id==="scrStoreInfo"){
      buildStoreInfoUI();
    }
  };
  showScreen._p8Hooked_v2 = true;
})();

/* 起動補助 */
(function openFirst(){
  showScreen("scrMain");
  if(typeof renderSeats==="function") renderSeats();
})();

/* =========================
  ここまでで 8分割 完成
========================= */
</script>
</body>
</html>