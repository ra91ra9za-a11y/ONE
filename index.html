<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>ONEï¼ˆç„¡æ–™ç‰ˆï¼‰</title>

  <style>
    /* =========================
      1) æ¨ªã‚ºãƒ¬é˜²æ­¢ï¼ˆå…¨ãƒšãƒ¼ã‚¸ï¼‰
    ========================= */
    html, body{
      width:100%;
      height:100%;
      overflow-x:hidden;
      overscroll-behavior-x:none;
      touch-action: pan-y;
    }
    body{
      margin:0;
      font-family: -apple-system, BlinkMacSystemFont, "Hiragino Kaku Gothic ProN", "Noto Sans JP", sans-serif;
      -webkit-text-size-adjust:100%;
      text-size-adjust:100%;
      background: #0f1720;
      color:#eaf0f6;
    }

    :root{
      --bg:#0f1720;
      --panel:#131e2a;
      --panel2:#0f1a25;
      --card:#182638;
      --card2:#1a2a3f;
      --line:rgba(255,255,255,.10);
      --muted:rgba(234,240,246,.72);
      --muted2:rgba(234,240,246,.55);
      --accent:#2dbE60;
      --accent2:#8fe35a; /* é»„ç·‘ï¼ˆã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ï¼‰ */
      --warn:#ff5757;
      --amber:#ffbf3c;
      --shadow: 0 8px 24px rgba(0,0,0,.35);
      --radius:14px;
      --radius2:18px;
      --tap: rgba(255,255,255,.08);
    }

    html{ font-size:18px; }
    *{ box-sizing:border-box; }
    button, input, select{ font: inherit; }

    input[type="text"], input[type="number"], select{
      width:100%;
      background: rgba(255,255,255,.06);
      color:#eaf0f6;
      border:1px solid var(--line);
      border-radius:12px;
      padding:12px 12px;
      outline:none;
    }
    input::placeholder{ color: rgba(234,240,246,.45); }

    .numField{
      width: 88px;
      text-align:center;
      font-size:1.12rem;
      padding:10px 10px;
    }

    button{
      background: rgba(255,255,255,.08);
      color:#eaf0f6;
      border:1px solid var(--line);
      border-radius:14px;
      padding:14px 14px;
      min-height: 50px;
      cursor:pointer;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }
    button:active{ background: rgba(255,255,255,.12); }
    .btnPrimary{ background: rgba(45,190,96,.16); border-color: rgba(45,190,96,.45); }
    .btnPrimary:active{ background: rgba(45,190,96,.22); }
    .btnDanger{ background: rgba(255,87,87,.12); border-color: rgba(255,87,87,.45); }
    .btnGhost{ background: transparent; }
    .btnSmall{ min-height: 42px; padding:10px 12px; border-radius:12px; font-size:.95rem; }
    .btnRow{ display:flex; gap:10px; flex-wrap:wrap; }
    .btnRow > button{ flex:1; }

    /* =========================
      3) ä¸Šéƒ¨å›ºå®šãƒ˜ãƒƒãƒ€ãƒ¼ï¼šã•ã‚‰ã«è–„ãï¼†ä¸­å¤®ã‚’åºƒã
      + ã‚ªãƒ³ãƒ©ã‚¤ãƒ³/ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ã‚¢ã‚¤ã‚³ãƒ³
      + å…¨ç”»é¢ãƒˆãƒƒãƒ—ãƒãƒ¼å³å´ã«ã€Œãƒ¡ã‚¤ãƒ³ã€ãƒœã‚¿ãƒ³ï¼ˆãƒ¡ã‚¤ãƒ³ç”»é¢ã§ã¯éè¡¨ç¤ºï¼‰
    ========================= */
    .topbar{
      position: sticky;
      top:0;
      z-index:50;
      padding: 6px 10px calc(6px + env(safe-area-inset-top));
      background: linear-gradient(180deg, rgba(15,23,32,.96), rgba(15,23,32,.86));
      backdrop-filter: blur(10px);
      border-bottom: 1px solid var(--line);
    }
    .topbarInner{
      display:grid;
      grid-template-columns: 1fr auto 1fr;
      align-items:center;
      gap:8px;
    }
    .brandBtn{
      justify-self:start;
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 10px;
      min-height:40px;
      border-radius:14px;
    }
    .brandDot{
      width:10px; height:10px; border-radius:99px;
      background: var(--accent);
      box-shadow: 0 0 0 6px rgba(45,190,96,.18);
    }
    .topCenter{
      justify-self:center;
      display:flex;
      gap:8px;
      align-items:center;
    }
    .topRight{
      justify-self:end;
      display:flex;
      gap:8px;
      align-items:center;
    }
    #backupBtn{
      font-size:.88rem;
      padding: 8px 10px;
      min-height:40px;
      white-space:nowrap;
    }
    #kitchenBtn{
      padding: 8px 10px;
      min-height:40px;
      white-space:nowrap;
    }
    #topMainBtn{
      font-size:.88rem;
      padding: 8px 10px;
      min-height:40px;
      white-space:nowrap;
      display:none;
    }

    .netIcon{
      width:40px;
      min-height:40px;
      display:flex;
      align-items:center;
      justify-content:center;
      border-radius:14px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.06);
      font-size: 1.05rem;
    }

    /* =========================
      CONTENT
    ========================= */
    .content{
      padding: 12px 12px 140px;
      max-width: 920px;
      margin: 0 auto;
    }
    .gridSeats{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap:10px;
    }
    @media (max-width: 420px){
      .gridSeats{ grid-template-columns: repeat(3, 1fr); }
    }

    .seatCard{
      background: linear-gradient(180deg, rgba(24,38,56,.92), rgba(20,32,48,.92));
      border:1px solid var(--line);
      border-radius: 16px;
      padding: 10px 10px;
      box-shadow: var(--shadow);
      min-height: 92px;
      display:flex;
      flex-direction:column;
      gap:6px;
      overflow:hidden;
    }
    .seatTop{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
    }
    .seatLabel{
      font-weight: 800;
      font-size: 1.12rem;
      letter-spacing: .02em;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width: 60%;
    }
    .seatStatus{
      font-size:.88rem;
      color: var(--muted);
      white-space:nowrap;
    }
    .seatMeta{
      font-size:.88rem;
      color: var(--muted);
      display:flex;
      gap:8px;
      align-items:center;
      flex-wrap:wrap;
      min-height: 18px;
    }
    .seatMoney{
      margin-top:auto;
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap:8px;
    }
    .yen{
      font-weight: 900;
      font-size: 1.15rem;
      white-space:nowrap;
    }
    .tagMini{
      font-size:.8rem;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid var(--line);
      color: var(--muted);
      background: rgba(255,255,255,.04);
      white-space:nowrap;
    }
    .seatCard.active{ outline: 2px solid rgba(45,190,96,.55); }
    .seatCard.reserve{ outline: 2px solid rgba(255,191,60,.55); }
    .seatCard.merged{ outline: 2px dashed rgba(234,240,246,.30); opacity:.78; }

    /* =========================
      bottomDockï¼šãƒ¡ã‚¤ãƒ³ã®ã¿è¡¨ç¤º
      + æ“ä½œæ ã®èƒŒæ™¯ã‚’ç™½ã£ã½ãï¼ˆ12ï¼‰
    ========================= */
    .bottomDock{
      position: fixed;
      left:0; right:0; bottom:0;
      z-index: 60;
      padding: 8px 10px calc(8px + env(safe-area-inset-bottom));
      background: linear-gradient(180deg, rgba(15,23,32,.55), rgba(15,23,32,.94));
      border-top: 1px solid var(--line);
      backdrop-filter: blur(10px);
      display:none;
    }
    .bottomDock.show{ display:block; }

    .dockWrap{
      max-width: 920px;
      margin: 0 auto;
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .opsBox{
      border:1px solid var(--line);
      border-radius: 16px;
      padding: 8px;
      background: rgba(255,255,255,.06);
    }
    .opsRow{
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap:8px;
    }
    .opsBtn{
      min-height: 48px;
      font-size: 1.02rem;
      font-weight: 800;
      padding: 10px 10px;
    }
    .opsBtn .twoLine{
      display:flex;
      flex-direction:column;
      line-height: 1.05;
      gap:2px;
      align-items:center;
    }
    .opsBtn.same{ background: rgba(255,255,255,.06); }
    .opsBtn.same.selected{
      background: rgba(45,190,96,.16);
      border-color: rgba(45,190,96,.45);
    }
    .opsBtn.decide{
      background: rgba(45,190,96,.22);
      border-color: rgba(45,190,96,.55);
    }
    .bottomRow2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:8px;
    }
    .bottomRow2 button{
      min-height: 48px;
      font-weight: 800;
    }

    /* SETTINGS cards */
    .cardGrid2{
      display:grid;
      grid-template-columns: repeat(2, 1fr);
      gap:10px;
    }
    .menuCard{
      background: rgba(24,38,56,.86);
      border: 1px solid var(--line);
      border-radius: 16px;
      padding: 14px;
      box-shadow: var(--shadow);
      min-height: 72px;
      display:flex;
      align-items:center;
      justify-content:center;
      text-align:center;
      font-weight: 900;
      letter-spacing:.02em;
    }
    .menuCard:active{ background: rgba(255,255,255,.10); }

    /* order header */
    .orderHeaderFixed{
      position: sticky;
      top: 56px;
      z-index: 45;
      background: rgba(15,23,32,.92);
      border-bottom: 1px solid var(--line);
      padding: 10px 12px;
      margin: 0 -12px 12px;
      backdrop-filter: blur(10px);
    }
    .orderHeaderRow{
      display:flex;
      justify-content:space-between;
      gap:10px;
      align-items:center;
    }
    .orderHeaderTitle{
      font-weight: 900;
      font-size: 1.05rem;
      color:#eaf0f6;
      display:flex;
      gap:8px;
      align-items:center;
      flex-wrap:wrap;
    }
    .orderHeaderTitle .badge{
      font-size:.82rem;
      padding: 4px 9px;
      border-radius:999px;
      border:1px solid rgba(45,190,96,.45);
      background: rgba(45,190,96,.14);
    }

    /* order grids */
    .genreGrid{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap:10px;
    }
    .genreBtn{
      min-height: 56px;
      font-weight: 900;
      background: rgba(255,255,255,.06);
      padding: 10px 10px;
      white-space: normal;
      line-height: 1.15;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .itemsGrid{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap:10px;
    }
    .itemBtn{
      min-height: 66px;
      font-weight: 900;
      padding: 12px 10px;
    }
    .itemBtn small{
      display:block;
      margin-top:6px;
      color: var(--muted);
      font-weight:700;
      font-size:.86rem;
    }

    /* list box */
    .listBox{
      margin-top: 12px;
      border:1px solid var(--line);
      border-radius: 16px;
      background: rgba(19,30,42,.60);
      overflow:hidden;
    }
    .listBox .listHead{
      padding: 10px 12px;
      border-bottom:1px solid var(--line);
      color: var(--muted);
      font-weight:900;
      font-size:.92rem;
      display:flex;
      justify-content:space-between;
      align-items:center;
    }
    .listRow{
      display:grid;
      grid-template-columns: 1fr auto auto;
      gap:10px;
      align-items:center;
      padding: 10px 12px;
      border-bottom:1px solid rgba(255,255,255,.06);
    }
    .listRow:last-child{ border-bottom:none; }
    .listName{
      font-weight:900;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    .listMeta{
      color: var(--muted);
      font-weight:800;
      white-space:nowrap;
    }
    .listBtn{
      min-height: 40px;
      padding: 8px 10px;
      border-radius: 12px;
      font-size:.92rem;
      font-weight:900;
    }

    /* pay */
    .payBtns{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap:10px;
    }
    .payBtn{ min-height: 54px; font-weight: 900; }
    .payBtn.selected{
      background: rgba(45,190,96,.18);
      border-color: rgba(45,190,96,.55);
    }

    /* modal */
    .modalRoot{
      position: fixed;
      inset:0;
      z-index: 200;
      display:none;
      align-items:center;
      justify-content:center;
      padding: 16px;
      background: rgba(0,0,0,.55);
      backdrop-filter: blur(4px);
    }
    .modalRoot.show{ display:flex; }
    .modal{
      width: min(520px, 100%);
      background: linear-gradient(180deg, rgba(24,38,56,.98), rgba(19,30,42,.98));
      border:1px solid var(--line);
      border-radius: 18px;
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .modalHead{ padding: 14px 14px 10px; border-bottom: 1px solid var(--line); }
    .modalTitle{ font-weight: 900; font-size: 1.05rem; }
    .modalSub{ margin-top: 6px; color: var(--muted); font-weight: 700; font-size:.92rem; line-height:1.35; }
    .modalBody{ padding: 12px 14px; display:flex; flex-direction:column; gap:10px; }
    .modalFoot{ padding: 12px 14px 14px; border-top:1px solid var(--line); display:flex; gap:10px; }
    .modalFoot button{ flex:1; }

    .stepper{
      display:flex; align-items:center; gap:10px; justify-content:center; padding: 8px 0;
    }
    .stepBtn{
      width: 54px; min-height: 54px;
      font-size: 1.25rem; font-weight: 900;
      border-radius: 16px;
    }
    .stepNum{
      width: 96px; text-align:center;
      font-weight: 900; font-size: 1.25rem;
      padding: 12px 0;
      border-radius: 16px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.06);
    }

    /* kitchen */
    .kTabs{ display:flex; gap:10px; margin-top: 10px; }
    .kTabs button{ flex:1; min-height: 48px; font-weight: 900; }
    .kTabs button.selected{ background: rgba(45,190,96,.18); border-color: rgba(45,190,96,.55); }

    .kList{ display:flex; flex-direction:column; gap:8px; margin-top: 12px; }

    .kCard{
      position: relative;
      background: rgba(24,38,56,.88);
      border:1px solid var(--line);
      border-radius: 16px;
      padding: 10px 12px;
      display:grid;
      grid-template-columns: 1fr auto;
      gap:10px;
      align-items:center;
      overflow:hidden;
    }
    .kCard::before{
      content:"";
      position:absolute;
      left:0; top:0; bottom:0;
      width: 6px;
      background: rgba(45,190,96,.65);
    }
    .kCard.promoted::before{ background: rgba(255,191,60,.75); }
    .kCard.overdue .kName{ color: var(--warn); }

    .kName{ font-weight: 950; font-size: 1.10rem; line-height:1.2; }
    .kMeta{
      margin-top: 6px;
      color: var(--muted);
      font-weight: 800;
      font-size:.92rem;
      display:flex;
      gap:14px;
      flex-wrap:wrap;
    }
    .kQty{
      font-weight: 950;
      font-size: 1.12rem;
      margin-left: 10px;
      color:#eaf0f6;
    }

    .kSubLine{
      margin-top: 8px;
      padding-left: 10px;
      border-left: 2px dashed rgba(255,255,255,.12);
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .kSubItem{
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
      padding: 6px 8px;
      border-radius: 12px;
      background: rgba(255,255,255,.04);
      border:1px solid rgba(255,255,255,.08);
    }
    .kSubLeft{
      display:flex;
      align-items:center;
      gap:10px;
      overflow:hidden;
      white-space:nowrap;
      text-overflow:ellipsis;
    }
    .kTime{ font-weight:900; color: var(--muted); }
    .kSeat{ font-weight: 950; color: rgba(234,240,246,.92); }

    /* ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ */
    .slider{
      width: 140px;
      height: 42px;
      border-radius: 999px;
      background: rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.16);
      position: relative;
      overflow:hidden;
      justify-self:end;
    }
    .slider.short{ width: 110px; }
    .slider.shift{ justify-self:end; margin-right: 6px; }

    .sliderTrack{
      position:absolute; inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      color: rgba(234,240,246,.55);
      font-weight: 900;
      font-size:.9rem;
      pointer-events:none;
    }
    .sliderKnob{
      position:absolute;
      left: 2px;
      top: 2px;
      width: 38px;
      height: 38px;
      border-radius: 999px;
      background: rgba(143,227,90,.92);
      box-shadow: 0 8px 18px rgba(0,0,0,.35);
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight: 950;
      color:#0b121a;
      user-select:none;
      touch-action: pan-x;
    }

    .view{ display:none; }
    .view.show{ display:block; }

    .muted{ color: var(--muted); }
    .muted2{ color: var(--muted2); }
    .warnText{ color: var(--warn); font-weight: 950; }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 8px 10px;
      border-radius: 999px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.04);
      font-weight: 900;
      color: var(--muted);
      font-size:.9rem;
    }
    .hr{ height:1px; background: rgba(255,255,255,.08); margin: 10px 0; }

    button, .seatCard, .menuCard, .genreBtn, .itemBtn{ touch-action: manipulation; }

    /* å¸­ç™»éŒ²ã®è¦‹å‡ºã—ã‚’è¦‹ã‚„ã™ã */
    .srHead{ color: rgba(234,240,246,.92); font-weight: 950; }

    /* ===== æœ¬æ—¥ã®å£²ä¸Šï¼ˆè¨‚æ­£ä¼ç¥¨æ–¹å¼å¯¾å¿œï¼‰ ===== */
    .saleRow{
      padding: 10px 12px;
      border-bottom: 1px solid rgba(255,255,255,.06);
    }
    .saleRow:last-child{ border-bottom:none; }
    .saleTop{
      display:flex;
      justify-content:space-between;
      gap:10px;
      align-items:flex-start;
    }
    .saleTitle{
      font-weight: 950;
      line-height:1.25;
    }
    .saleMeta{
      margin-top:6px;
      color: var(--muted);
      font-weight: 800;
      font-size:.92rem;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
    }
    .saleBtns{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    .saleBtns button{ min-height: 42px; padding: 10px 12px; }

    .tagFix{
      display:inline-flex;
      align-items:center;
      gap:6px;
      font-size:.82rem;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid rgba(255,191,60,.45);
      background: rgba(255,191,60,.10);
      color: rgba(255,240,200,.92);
      font-weight: 900;
    }

  </style>
</head>

<body>
  <!-- ========================= TOP BAR ========================= -->
  <div class="topbar" id="topbar">
    <div class="topbarInner">
      <button class="brandBtn btnGhost" id="brandBtn" title="ç„¡æ–™/æœ‰æ–™ã®å…¥å£">
        <span class="brandDot"></span>
        <span style="font-weight:950; letter-spacing:.02em;">ONE</span>
      </button>

      <div class="topCenter" id="topCenter">
        <button class="btnSmall" id="kitchenBtn">ã‚­ãƒƒãƒãƒ³</button>
      </div>

      <div class="topRight" id="topRight">
        <div class="netIcon" id="netIcon" title="ã‚ªãƒ³ãƒ©ã‚¤ãƒ³çŠ¶æ…‹">ğŸ“¶</div>
        <button class="btnSmall" id="topMainBtn">ãƒ¡ã‚¤ãƒ³</button>
        <button class="btnSmall" id="backupBtn">ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—</button>
      </div>
    </div>
  </div>

  <!-- ========================= CONTENT ========================= -->
  <div class="content">

    <!-- MAIN VIEW -->
    <section class="view show" id="viewMain">
      <div class="muted" style="font-weight:900; margin: 4px 0 10px;">
        å¸­ï¼ˆç©ºå¸­ã‚¿ãƒƒãƒ— â†’ æ¥åº— / äºˆç´„ï¼‰
      </div>
      <div class="gridSeats" id="seatGrid"></div>
      <div style="height:12px;"></div>
      <div class="muted2" style="font-size:.92rem;">
        â€» ä¸‹ã®ã€Œå¸­ç§»å‹• / åˆè¨ˆåˆç®— / åˆè¨ˆåˆ†å‰²ã€ã‚’æŠ¼ã™ã¨é¸æŠçŠ¶æ…‹ã«ãªã‚Šã¾ã™ï¼ˆå†ã‚¿ãƒƒãƒ—ã§è§£é™¤ï¼‰â†’ã€Œæ±ºå®šã€ã§å®Ÿè¡Œã€‚
      </div>
    </section>

    <!-- SETTINGS VIEW -->
    <section class="view" id="viewSettings">
      <div class="muted" style="font-weight:950; margin: 6px 0 12px;">è¨­å®š</div>
      <div class="cardGrid2">
        <div class="menuCard" data-go="seatRegister">å¸­ç™»éŒ²</div>
        <div class="menuCard" data-go="menuRegister">ãƒ¡ãƒ‹ãƒ¥ãƒ¼ç™»éŒ²</div>
        <div class="menuCard" data-go="sales">å£²ä¸Š</div>
        <div class="menuCard" data-go="storeInfo">åº—èˆ—æƒ…å ±</div>
        <div class="menuCard" data-go="contact">ãŠå•åˆã›</div>
        <div class="menuCard" data-go="recipe" style="opacity:.55;">æ–™ç†ææ¡ˆï¼ˆæœ‰æ–™æº–å‚™ä¸­ï¼‰</div>
      </div>
      <div style="height:14px;"></div>
      <div class="muted2" style="font-size:.92rem;">â€» æ–™ç†ææ¡ˆï¼ˆãƒ©ã‚¤ãƒˆï¼‰ã¯æœ‰æ–™ç‰ˆã«å…¥ã‚Œã‚‹äºˆå®šï¼ˆç¾åœ¨æº–å‚™ä¸­ï¼‰</div>
    </section>

    <!-- SEAT REGISTER VIEW -->
    <section class="view" id="viewSeatRegister">
      <div class="srHead" style="margin: 6px 0 12px;">å¸­ç™»éŒ²</div>

      <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
        <span class="pill" style="border:none; background:transparent; padding:0; color:rgba(234,240,246,.72);">
          æ‰‹é †ï¼šåç§° â†’ ç·å¸­/ç·å“ â†’ å¸­ç•ªå· â†’ æœ€å¤§äººæ•°
        </span>
      </div>

      <div style="height:10px;"></div>

      <div class="btnRow">
        <button class="btnSmall btnDanger" id="resetSeatReg">å…¥åŠ›ã‚’å–æ¶ˆ</button>
        <button class="btnSmall btnDanger" id="initAllSeatsBtn">å…¨å¸­ãƒ‡ãƒ¼ã‚¿ã®åˆæœŸåŒ–</button>
      </div>

      <div class="hr"></div>

      <!-- åç§°é¸æŠ -->
      <div class="srHead" style="margin-bottom:8px;">åç§°</div>
      <div class="btnRow">
        <button class="btnSmall" data-seatType="counter">ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼</button>
        <button class="btnSmall" data-seatType="stand">ç«‹ã¡</button>
        <button class="btnSmall" data-seatType="table">ãƒ†ãƒ¼ãƒ–ãƒ«</button>
      </div>
      <div class="btnRow" style="margin-top:8px;">
        <button class="btnSmall" data-seatType="zashiki">åº§æ•·</button>
        <button class="btnSmall" data-seatType="room">å€‹å®¤</button>
        <button class="btnSmall" data-seatType="other">ãã®ä»–</button>
      </div>

      <div id="otherNameWrap" style="display:none; margin-top:10px;">
        <div class="srHead" style="margin-bottom:8px;">ãã®ä»–ã®åç§°ï¼ˆä¾‹ï¼šä¸­åº­ãƒ†ãƒ©ã‚¹ï¼‰</div>
        <input id="otherName" type="text" placeholder="ä¾‹ï¼šä¸­åº­ãƒ†ãƒ©ã‚¹" />
        <div class="muted2" style="font-size:.9rem; margin-top:6px;">â€» å…¥åŠ›ã—ãŸåç§°ã¯æ¬¡å›ä»¥é™ã€åç§°ä¸€è¦§ã¨ã—ã¦ä½¿ãˆã¾ã™ï¼ˆç„¡æ–™ç‰ˆã§ã¯ç°¡æ˜“ä¿å­˜ï¼‰</div>
      </div>

      <div class="hr"></div>

      <!-- ç·æ•° -->
      <div class="srHead" style="margin-bottom:8px;" id="countLabel">ç·å¸­æ•° / ç·å“æ•°</div>
      <div style="display:flex; gap:10px; align-items:center;">
        <button class="stepBtn" id="countDec">â—€ï¸</button>
        <div class="stepNum" id="countNum">0</div>
        <button class="stepBtn" id="countInc">â–¶ï¸</button>
      </div>

      <div class="hr"></div>

      <!-- å¸­ç•ªå·å…¥åŠ› -->
      <div class="srHead" style="margin-bottom:8px;">å¸­ç•ªå·ï¼ˆè‡ªå‹•ã§æ¬¡ãŒå…¥ã‚Šã¾ã™ï¼‰</div>
      <div class="muted2" style="font-size:.92rem; margin-bottom:10px;">ä¾‹ï¼š1 â†’ 2 / A â†’ B / C1 â†’ C2ï¼ˆã‚¢ãƒ«ãƒ•ã‚¡ãƒ™ãƒƒãƒˆã¯å¤§æ–‡å­—ï¼‰</div>
      <div id="seatInputs"></div>

      <div class="hr"></div>

      <!-- æœ€å¤§ç€å¸­äººæ•° -->
      <div class="srHead" style="margin-bottom:8px;">æœ€å¤§ç€å¸­äººæ•°ï¼ˆå¸­ã”ã¨ï¼‰</div>
      <div id="capInputs"></div>

      <div style="height:12px;"></div>
      <div class="btnRow">
        <button class="btnPrimary" id="saveSeats">ä¿å­˜</button>
      </div>

      <div class="hr"></div>

      <!-- ä½œã£ãŸå¸­ã‚’åç§°ã”ã¨ã«ã¾ã¨ã‚ã‚‹ -->
      <div class="srHead" style="margin: 6px 0 10px;">ä½œã£ãŸå¸­ï¼ˆåç§°ã”ã¨ï¼‰</div>
      <div id="seatPreviewGrouped"></div>

      <div class="muted2" style="font-size:.9rem; margin-top:8px;">â€» ç„¡æ–™ç‰ˆã¯ã€Œå¸­ã®å€‹åˆ¥ç·¨é›†ã€ã¯ç°¡æ˜“å¯¾å¿œï¼ˆæ¬¡ãƒ•ã‚§ãƒ¼ã‚ºã§å¼·åŒ–ï¼‰</div>
    </section>

    <!-- MENU REGISTER VIEW -->
    <section class="view" id="viewMenuRegister">
      <div class="muted" style="font-weight:950; margin: 6px 0 12px;">ãƒ¡ãƒ‹ãƒ¥ãƒ¼ç™»éŒ²</div>

      <div class="btnRow">
        <button class="btnSmall btnDanger" id="initMenuBtn">ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãƒ‡ãƒ¼ã‚¿ã®åˆæœŸåŒ–</button>
      </div>

      <div class="muted2" style="font-size:.92rem; margin-top:10px;">
        ã‚«ãƒ†ã‚´ãƒªãƒ¼ï¼ˆæ–™ç†/ãƒ‰ãƒªãƒ³ã‚¯ï¼‰ã¯ã‚­ãƒƒãƒãƒ³ã®ã€Œæ–™ç†/ãƒ‰ãƒªãƒ³ã‚¯ã€è¡¨ç¤ºã«åæ˜ ã—ã¾ã™ï¼ˆæ³¨æ–‡ã«ã¯å‡ºã—ã¾ã›ã‚“ï¼‰ã€‚
      </div>

      <div style="height:10px;"></div>

      <div class="btnRow">
        <button class="btnSmall btnPrimary" id="photoBtn">å†™çœŸæ’®å½±</button>
        <button class="btnSmall btnDanger" id="photoClearBtn">å†™çœŸã‚’æ¶ˆã™</button>
      </div>
      <div class="warnText" style="margin-top:8px;">èª¤èªè­˜å‰æã«ãªã‚Šã¾ã™ï¼ˆç„¡æ–™ç‰ˆï¼‰</div>
      <div class="muted2" style="font-size:.9rem; margin-top:6px;">â€» å†™çœŸã‹ã‚‰ã®è‡ªå‹•èª­ã¿å–ã‚Šï¼ˆOCRï¼‰ã¯æ”¹å–„ä¸­ï¼ˆæœªå®Œæˆï¼‰</div>

      <div class="hr"></div>

      <!-- ã‚¸ãƒ£ãƒ³ãƒ«é¸æŠï¼‹æ–°è¦è¿½åŠ ï¼ˆæœªé¸æŠã¯æœªåˆ†é¡ï¼‰ -->
      <div class="muted" style="font-weight:950; margin-bottom:10px;">ç™»éŒ²</div>

      <div class="btnRow">
        <select id="mCategory">
          <option value="food">æ–™ç†</option>
          <option value="drink">ãƒ‰ãƒªãƒ³ã‚¯</option>
        </select>

        <select id="mGenreSel">
          <option value="">ï¼ˆæœªé¸æŠâ†’æœªåˆ†é¡ï¼‰</option>
        </select>

        <button class="btnSmall" id="addGenreBtn">ï¼‹ã‚¸ãƒ£ãƒ³ãƒ«è¿½åŠ </button>
      </div>

      <div style="height:10px;"></div>

      <input id="mName" type="text" placeholder="å•†å“åï¼ˆé‡è¤‡ä¸å¯ï¼‰" />
      <div style="height:10px;"></div>

      <div style="display:flex; gap:10px; align-items:center;">
        <input id="mPrice" class="numField" type="number" inputmode="numeric" placeholder="é‡‘é¡" />
        <select id="mTax" style="width:160px;">
          <option value="10">10%</option>
          <option value="8">8%</option>
        </select>
        <button class="btnPrimary" id="mAdd">ç™»éŒ²</button>
      </div>

      <div class="hr"></div>

      <!-- é–²è¦§ãƒ»ä¿®æ­£ãƒ»å‰Šé™¤ -->
      <div class="muted" style="font-weight:950; margin: 6px 0 8px;">å•†å“ã®é–²è¦§ã¨ä¿®æ­£</div>

      <div class="btnRow">
        <select id="viewGenreSel"></select>
        <button class="btnPrimary btnSmall" id="viewGenreDecide">æ±ºå®š</button>
      </div>

      <div id="menuList"></div>

      <div style="height:12px;"></div>

      <input id="photoInput" type="file" accept="image/*" capture="environment" style="display:none;" />
    </section>

    <!-- ORDER VIEW -->
    <section class="view" id="viewOrder">
      <div class="orderHeaderFixed" id="orderHeaderFixed">
        <div class="orderHeaderRow">
          <div class="orderHeaderTitle" id="orderHeaderTitle"></div>
        </div>
      </div>

      <div id="orderTopButtons" class="btnRow" style="margin-bottom:12px;">
        <button class="btnSmall" id="orderGoGenre">ã‚¸ãƒ£ãƒ³ãƒ«</button>
        <button class="btnSmall" id="orderGoMain">ãƒ¡ã‚¤ãƒ³</button>
        <button class="btnSmall btnPrimary" id="orderGoCheckout">ä¼šè¨ˆ</button>
      </div>

      <div class="btnRow" style="margin-bottom:12px;">
        <button class="btnSmall btnPrimary" id="orderCatFood">æ–™ç†</button>
        <button class="btnSmall" id="orderCatDrink">ãƒ‰ãƒªãƒ³ã‚¯</button>
      </div>

      <div id="orderStageGenres">
        <div class="muted" style="font-weight:950; margin-bottom:10px;">ã‚¸ãƒ£ãƒ³ãƒ«</div>
        <div class="genreGrid" id="genreGrid"></div>
      </div>

      <div id="orderStageItems" style="display:none;">
        <div class="itemsGrid" id="itemsGrid"></div>
      </div>

      <div class="listBox" id="orderListBox">
        <div class="listHead">
          <span>æ³¨æ–‡å±¥æ­´</span>
          <span class="muted2" id="orderSum">åˆè¨ˆ Â¥0</span>
        </div>
        <div id="orderList"></div>
      </div>
    </section>

    <!-- CHECKOUT VIEW -->
    <section class="view" id="viewCheckout">
      <div class="muted" style="font-weight:950; margin: 6px 0 12px;">ä¼šè¨ˆ</div>

      <div class="seatCard" style="min-height:auto;">
        <div class="seatTop">
          <div class="seatLabel" id="coSeatLabel">å¸­</div>
          <div class="seatStatus" id="coPeople">äººæ•°</div>
        </div>
        <div class="yen" style="font-size:1.45rem;" id="coTotal">åˆè¨ˆ Â¥0</div>
      </div>

      <div style="height:12px;"></div>

      <div class="muted" style="font-weight:900; margin-bottom:8px;">æ”¯æ‰•ã„æ–¹æ³•</div>
      <div class="payBtns">
        <button class="payBtn" data-pay="cash">ç¾é‡‘</button>
        <button class="payBtn" data-pay="card">ã‚«ãƒ¼ãƒ‰</button>
        <button class="payBtn" data-pay="qr">QR/é›»å­æ±ºæ¸ˆ</button>
      </div>

      <div style="height:12px;"></div>
      <div class="btnRow">
        <button class="btnSmall" id="warikanBtn">å‰²ã‚Šå‹˜</button>
        <button class="btnPrimary" id="confirmCheckout">ä¼šè¨ˆç¢ºå®š</button>
      </div>

      <div class="listBox" style="margin-top:12px;">
        <div class="listHead">
          <span>æ³¨æ–‡ä¸€è¦§ï¼ˆä¿®æ­£ï¼‰</span>
          <span class="muted2">0å€‹ã«ã™ã‚‹ã¨æ¶ˆãˆã¾ã™</span>
        </div>
        <div id="checkoutOrderList"></div>
      </div>
    </section>

    <!-- KITCHEN VIEW -->
    <section class="view" id="viewKitchen">
      <div class="muted" style="font-weight:950; margin: 6px 0 6px;">
        ã‚­ãƒƒãƒãƒ³
      </div>

      <div class="btnRow">
        <button class="btnSmall" id="kRefresh">æ›´æ–°</button>
        <button class="btnSmall btnPrimary" id="kFoodTab">æ–™ç†</button>
        <button class="btnSmall" id="kDrinkTab">ãƒ‰ãƒªãƒ³ã‚¯</button>
      </div>

      <div class="kList" id="kList"></div>

      <div class="muted2" style="font-size:.9rem; margin-top:10px;">
        â€» æ–™ç†ï¼šåŒã˜æ–™ç†ã¯ä¸‹ã«ã¶ã‚‰ä¸‹ã’ï¼ˆæ˜‡æ ¼ã—ãŸå´ã®ã¿è‰²ï¼‰ / ãƒ‰ãƒªãƒ³ã‚¯ï¼šã¾ã¨ã‚ãªã„
      </div>
    </section>

    <!-- SALES VIEW -->
    <section class="view" id="viewSales">
      <div class="muted" style="font-weight:950; margin: 6px 0 12px;">å£²ä¸Š</div>
      <div class="btnRow">
        <button class="btnPrimary" id="goTodaySales">æœ¬æ—¥ã®å£²ä¸Š</button>
        <button class="btnPrimary" id="goMonthSales">æœˆå£²ä¸Š</button>
        <button class="btnPrimary" id="goYearSales">å¹´å£²ä¸Š</button>
      </div>
      <div style="height:10px;"></div>
      <div class="btnRow">
        <button class="btnPrimary" id="goSalesManage">å£²ä¸Šç®¡ç†</button>
      </div>
    </section>

    <!-- TODAY SALES VIEW -->
    <section class="view" id="viewTodaySales">
      <div class="muted" style="font-weight:950; margin: 6px 0 12px;">æœ¬æ—¥ã®å£²ä¸Š</div>
      <div class="seatCard" style="min-height:auto;">
        <div class="seatTop">
          <div class="seatLabel">æœ¬æ—¥åˆè¨ˆ</div>
          <div class="seatStatus" id="todayCount">0ä»¶</div>
        </div>
        <div class="yen" style="font-size:1.45rem;" id="todayTotal">åˆè¨ˆ Â¥0</div>
      </div>

      <div class="listBox" id="todaySalesList"></div>
      <div style="height:12px;"></div>
      <button id="todayToSales">å£²ä¸Šã¸æˆ»ã‚‹</button>
    </section>

    <section class="view" id="viewMonthSales">
      <div class="muted" style="font-weight:950; margin: 6px 0 12px;">æœˆå£²ä¸Š</div>
      <div class="hr"></div>
      <div id="monthSalesBox" class="muted2"></div>
      <div style="height:12px;"></div>
      <button id="monthToSales">å£²ä¸Šã¸æˆ»ã‚‹</button>
    </section>

    <section class="view" id="viewYearSales">
      <div class="muted" style="font-weight:950; margin: 6px 0 12px;">å¹´å£²ä¸Š</div>
      <div class="hr"></div>
      <div id="yearSalesBox" class="muted2"></div>
      <div style="height:12px;"></div>
      <button id="yearToSales">å£²ä¸Šã¸æˆ»ã‚‹</button>
    </section>

    <section class="view" id="viewSalesManage">
      <div class="muted" style="font-weight:950; margin: 6px 0 12px;">å£²ä¸Šç®¡ç†</div>

      <div class="btnRow">
        <button class="btnPrimary" id="exportCsv">CSVå‡ºåŠ›ï¼ˆæ¨å¥¨ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆï¼‰</button>
        <button class="btnDanger" id="initSalesBtn">å£²ä¸Šãƒ‡ãƒ¼ã‚¿ã®åˆæœŸåŒ–</button>
      </div>

      <div class="hr"></div>
      <div id="salesLog" class="muted2"></div>
      <div style="height:12px;"></div>
      <button id="manageToSales">å£²ä¸Šã¸æˆ»ã‚‹</button>
    </section>

    <!-- STORE INFO / CONTACT -->
    <section class="view" id="viewStoreInfo">
      <div class="muted" style="font-weight:950; margin: 6px 0 12px;">åº—èˆ—æƒ…å ±</div>
      <div class="muted2">
        ç„¡æ–™ç‰ˆï¼šä¿å­˜ã¯ç°¡æ˜“ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ï¼‰<br>
        æœ‰æ–™ç‰ˆï¼šé›»å­ãƒ¬ã‚·ãƒ¼ãƒˆã«ã€Œåº—èˆ—åãƒ»é€£çµ¡å…ˆãƒ»ä½æ‰€ã€ã‚’è‡ªå‹•åæ˜ äºˆå®š
      </div>
      <div class="hr"></div>
      <input id="stName" type="text" placeholder="åº—èˆ—å" />
      <div style="height:10px;"></div>
      <input id="stPhone" type="text" placeholder="é€£çµ¡å…ˆï¼ˆé›»è©±ï¼‰" />
      <div style="height:10px;"></div>
      <input id="stAddr" type="text" placeholder="ä½æ‰€" />
      <div style="height:12px;"></div>
      <div class="btnRow">
        <button class="btnPrimary" id="saveStoreInfo">ä¿å­˜</button>
      </div>
    </section>

    <section class="view" id="viewContact">
      <div class="muted" style="font-weight:950; margin: 6px 0 12px;">ãŠå•åˆã›</div>
      <div class="muted2">ç„¡æ–™ç‰ˆï¼šç”»é¢ã‚µãƒ³ãƒ—ãƒ«ã§ã™ï¼ˆé€ä¿¡ã¯å®Ÿè£…æº–å‚™ä¸­ï¼‰</div>
      <div class="hr"></div>
      <input type="text" placeholder="ä»¶å" />
      <div style="height:10px;"></div>
      <input type="text" placeholder="å†…å®¹ï¼ˆç°¡æ˜“ï¼‰" />
    </section>

    <section class="view" id="viewRecipe">
      <div class="muted" style="font-weight:950; margin: 6px 0 12px;">æ–™ç†ææ¡ˆï¼ˆæœ‰æ–™æº–å‚™ä¸­ï¼‰</div>
      <div class="muted2">ã“ã®æ©Ÿèƒ½ã¯æœ‰æ–™ç‰ˆã«å…¥ã‚Œã‚‹äºˆå®šï¼ˆãƒ©ã‚¤ãƒˆç‰ˆï¼‰ã€‚</div>
    </section>

  </div>

  <!-- =========================
    BOTTOM DOCKï¼ˆãƒ¡ã‚¤ãƒ³ã®ã¿ï¼‰
  ========================= -->
  <div class="bottomDock" id="bottomDock">
    <div class="dockWrap">
      <div class="opsBox">
        <div class="opsRow">
          <button class="opsBtn same" data-op="move"><div class="twoLine"><span>å¸­ç§»å‹•</span></div></button>
          <button class="opsBtn same" data-op="merge"><div class="twoLine"><span>åˆè¨ˆ</span><span>åˆç®—</span></div></button>
          <button class="opsBtn same" data-op="split"><div class="twoLine"><span>åˆè¨ˆ</span><span>åˆ†å‰²</span></div></button>
          <button class="opsBtn decide" id="opDecide">æ±ºå®š</button>
        </div>
      </div>
      <div class="bottomRow2">
        <button id="todaySalesBtn">æœ¬æ—¥ã®å£²ä¸Š</button>
        <button id="settingsBtn">è¨­å®š</button>
      </div>
    </div>
  </div>

  <!-- ========================= MODAL ROOT ========================= -->
  <div class="modalRoot" id="modalRoot">
    <div class="modal">
      <div class="modalHead">
        <div class="modalTitle" id="mTitle">ã‚¿ã‚¤ãƒˆãƒ«</div>
        <div class="modalSub" id="mSub"></div>
      </div>
      <div class="modalBody" id="mBody"></div>
      <div class="modalFoot" id="mFoot"></div>
    </div>
  </div>

<script>
/* =========================
  ä¿å­˜ãƒ‡ãƒ¼ã‚¿ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ï¼‰
========================= */
const KEY = "ONE_FREE_V2";
const nowTs = ()=> Date.now();
const pad2 = (n)=> String(n).padStart(2,"0");
const fmtTime = (ts)=>{
  const d = new Date(ts);
  if(!isFinite(d.getTime())) return "??:??";
  return `${pad2(d.getHours())}:${pad2(d.getMinutes())}`;
};
const yen = (n)=> `Â¥${(n||0).toLocaleString("ja-JP")}`;
const jaSort = (a,b)=> (a||"").localeCompare((b||""), "ja", { sensitivity:"base" });

function normalizeKey(s){
  return String(s||"").trim().normalize("NFKC").toUpperCase();
}

const defaultState = {
  seats: [],
  menu: [],
  genres: { food: [], drink: [] },
  sales: [],     // å£²ä¸Šä¼ç¥¨ï¼ˆç¢ºå®šï¼‰
  salesFix: [],  // è¨‚æ­£ä¼ç¥¨ï¼ˆæ–¹å¼1ï¼‰
  store: { name:"", phone:"", addr:"" },
  ui: {
    view:"main",
    selectedSeatIds: [],
    opSelected: null,
    orderSeatId: null,
    orderGenre: null,
    orderCat: "food",
    kitchenTab: "food",
    pay: "cash",
    menuViewGenre: ""
  },
  kitchenDone: {}
};

let state = load();

function load(){
  try{
    const raw = localStorage.getItem(KEY);
    if(!raw) return structuredClone(defaultState);
    const s = JSON.parse(raw);

    const merged = {
      ...structuredClone(defaultState),
      ...s,
      ui: { ...structuredClone(defaultState.ui), ...(s.ui||{}) },
      store: { ...structuredClone(defaultState.store), ...(s.store||{}) },
      kitchenDone: s.kitchenDone || {},
      genres: { ...structuredClone(defaultState.genres), ...(s.genres||{}) },
      salesFix: s.salesFix || []
    };

    if((!merged.genres.food.length && !merged.genres.drink.length) && Array.isArray(merged.menu)){
      const gf = new Set(), gd = new Set();
      merged.menu.forEach(m=>{
        const g = (m.genre||"").trim();
        if(!g) return;
        if(m.category==="drink") gd.add(g);
        else gf.add(g);
      });
      merged.genres.food = Array.from(gf).sort(jaSort);
      merged.genres.drink = Array.from(gd).sort(jaSort);
    }

    return merged;
  }catch(e){
    return structuredClone(defaultState);
  }
}
function save(){ localStorage.setItem(KEY, JSON.stringify(state)); }

/* ========================= Views ========================= */
const views = {
  main: document.getElementById("viewMain"),
  settings: document.getElementById("viewSettings"),
  seatRegister: document.getElementById("viewSeatRegister"),
  menuRegister: document.getElementById("viewMenuRegister"),
  order: document.getElementById("viewOrder"),
  checkout: document.getElementById("viewCheckout"),
  kitchen: document.getElementById("viewKitchen"),
  sales: document.getElementById("viewSales"),
  todaySales: document.getElementById("viewTodaySales"),
  month: document.getElementById("viewMonthSales"),
  year: document.getElementById("viewYearSales"),
  manage: document.getElementById("viewSalesManage"),
  storeInfo: document.getElementById("viewStoreInfo"),
  contact: document.getElementById("viewContact"),
  recipe: document.getElementById("viewRecipe"),
};

const bottomDock = document.getElementById("bottomDock");
const kitchenBtn = document.getElementById("kitchenBtn");
const topMainBtn = document.getElementById("topMainBtn");

/* bottomDockã¯ãƒ¡ã‚¤ãƒ³ã®ã¿ */
function syncDock(){
  const isMain = state.ui.view==="main";
  bottomDock.classList.toggle("show", isMain);
}

/* topbarä¸­å¤®ãƒœã‚¿ãƒ³ã¯ã€ã‚­ãƒƒãƒãƒ³ç”»é¢ã§ã¯ã€Œãƒ›ãƒ¼ãƒ«ã€ */
function syncTopCenter(){
  if(state.ui.view==="kitchen"){
    kitchenBtn.textContent = "ãƒ›ãƒ¼ãƒ«";
  }else{
    kitchenBtn.textContent = "ã‚­ãƒƒãƒãƒ³";
  }
}

/* å…¨ç”»é¢ãƒˆãƒƒãƒ—ãƒãƒ¼å³å´ã«ã€Œãƒ¡ã‚¤ãƒ³ã€ãƒœã‚¿ãƒ³ï¼ˆãƒ¡ã‚¤ãƒ³ç”»é¢ã§ã¯éè¡¨ç¤ºï¼‰ */
function syncTopMainBtn(){
  const isMain = state.ui.view==="main";
  topMainBtn.style.display = isMain ? "none" : "inline-flex";
}

/* ã‚ªãƒ³ãƒ©ã‚¤ãƒ³çŠ¶æ…‹ */
const netIcon = document.getElementById("netIcon");
function syncNetIcon(){
  const on = navigator.onLine;
  netIcon.textContent = on ? "ğŸ“¶" : "ğŸ“¶âŒ";
  netIcon.title = on ? "ã‚ªãƒ³ãƒ©ã‚¤ãƒ³" : "ã‚ªãƒ•ãƒ©ã‚¤ãƒ³";
}
window.addEventListener("online", syncNetIcon);
window.addEventListener("offline", syncNetIcon);

function go(viewKey){
  Object.values(views).forEach(v=> v.classList.remove("show"));
  views[viewKey].classList.add("show");
  state.ui.view = viewKey;
  save();

  syncDock();
  syncTopCenter();
  syncTopMainBtn();

  if(viewKey==="main") renderMain();
  if(viewKey==="seatRegister") renderSeatRegisterPreview();
  if(viewKey==="menuRegister") renderMenuRegister();
  if(viewKey==="order") renderOrder();
  if(viewKey==="checkout") renderCheckout();
  if(viewKey==="kitchen") renderKitchen();
  if(viewKey==="sales") renderSales();
  if(viewKey==="todaySales") renderTodaySales();
  if(viewKey==="month") renderMonthSales();
  if(viewKey==="year") renderYearSales();
  if(viewKey==="manage") renderSalesManage();
  if(viewKey==="storeInfo") renderStoreInfo();
}

/* ========================= Modal ========================= */
const modalRoot = document.getElementById("modalRoot");
const mTitle = document.getElementById("mTitle");
const mSub = document.getElementById("mSub");
const mBody = document.getElementById("mBody");
const mFoot = document.getElementById("mFoot");

function lockBg(lock){
  if(lock){
    document.documentElement.style.overflow = "hidden";
    document.body.style.overflow = "hidden";
  }else{
    document.documentElement.style.overflow = "";
    document.body.style.overflow = "";
  }
}
function openModal({title, sub="", bodyHtml="", yesText="OK", noText="", onYes=null, onNo=null, yesClass="btnPrimary", noClass=""}){
  mTitle.textContent = title || "";
  mSub.textContent = sub || "";
  mBody.innerHTML = bodyHtml || "";
  mFoot.innerHTML = "";

  if(noText){
    const bNo = document.createElement("button");
    bNo.textContent = noText;
    bNo.className = noClass || "";
    bNo.onclick = ()=>{
      closeModal();
      if(onNo) onNo();
    };
    mFoot.appendChild(bNo);
  }

  const bYes = document.createElement("button");
  bYes.textContent = yesText;
  bYes.className = yesClass || "";
  bYes.onclick = ()=>{
    if(onYes) onYes();
    else closeModal();
  };
  mFoot.appendChild(bYes);

  modalRoot.classList.add("show");
  lockBg(true);
}
function closeModal(){
  modalRoot.classList.remove("show");
  lockBg(false);
}

/* ========================= Helper ========================= */
function escapeHtml(s){
  return String(s||"")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#39;");
}

/* ========================= Main: Seats ========================= */
const seatGrid = document.getElementById("seatGrid");

function seatTotal(seat){
  const ids = [seat.id, ...state.seats.filter(s=> s.mergedInto===seat.id).map(s=> s.id)];
  let sum = 0;
  for(const sid of ids){
    const s = state.seats.find(x=> x.id===sid);
    if(!s) continue;
    for(const o of (s.orders||[])) sum += (o.price||0) * (o.qty||1);
  }
  return sum;
}

function renderMain(){
  state.ui.selectedSeatIds = state.ui.selectedSeatIds.filter(id=> state.seats.some(s=> s.id===id));
  save();

  seatGrid.innerHTML = "";
  const sorted = [...state.seats].sort((a,b)=> {
    return (a.label||"").localeCompare((b.label||""), "ja", { numeric:true, sensitivity:"base" });
  });

  for(const seat of sorted){
    const card = document.createElement("div");
    card.className = "seatCard";
    const isSelected = state.ui.selectedSeatIds.includes(seat.id);
    if(isSelected) card.classList.add("active");
    if(seat.status==="reserve") card.classList.add("reserve");
    if(seat.mergedInto) card.classList.add("merged");

    const label = seat.label || "";
    const statusTxt = seat.mergedInto
      ? `åˆç®— â†’ ${state.seats.find(s=> s.id===seat.mergedInto)?.label || ""}`
      : seat.status==="empty" ? "ç©ºå¸­"
      : seat.status==="reserve" ? "äºˆç´„"
      : "ç€å¸­";

    const people = seat.party?.people ? `${seat.party.people}å` : "";
    const opened = seat.openedAt ? fmtTime(seat.openedAt) : "";
    const name = seat.party?.name ? seat.party.name : "";
    const total = seat.mergedInto ? 0 : seatTotal(seat);

    const metaParts = [];
    if(people) metaParts.push(people);
    if(name) metaParts.push(name);
    if(opened) metaParts.push(opened);

    const mergedTag = seat.mergedInto ? `<span class="tagMini">åˆç®—</span>` : "";

    card.innerHTML = `
      <div class="seatTop">
        <div class="seatLabel" title="${escapeHtml(label)}">${escapeHtml(label)}</div>
        <div class="seatStatus">${escapeHtml(statusTxt)}</div>
      </div>
      <div class="seatMeta">${metaParts.map(x=>`<span>${escapeHtml(x)}</span>`).join("")}</div>
      <div class="seatMoney">
        <div class="yen">${yen(total)}</div>
        ${mergedTag}
      </div>
    `;

    card.onclick = ()=>{
      if(state.ui.opSelected){
        toggleSeatSelect(seat.id);
        return;
      }
      if(seat.mergedInto){
        openModal({ title:"åˆç®—ä¸­ã®å¸­ã§ã™", sub:"åˆç®—ã®å…ƒã®å¸­ã‚’æ“ä½œã—ã¦ãã ã•ã„", yesText:"OK" });
        return;
      }
      onSeatTap(seat);
    };

    seatGrid.appendChild(card);
  }

  renderOpsButtons();
}

function toggleSeatSelect(id){
  const idx = state.ui.selectedSeatIds.indexOf(id);
  if(idx>=0) state.ui.selectedSeatIds.splice(idx,1);
  else state.ui.selectedSeatIds.push(id);
  save();
  renderMain();
}

/* ========================= Seat tap flow ========================= */
function onSeatTap(seat){
  if(seat.status==="empty") openChooseArriveReserve(seat);
  else if(seat.status==="reserve") openReserveAction(seat);
  else openOrderForSeat(seat.id);
}

function openChooseArriveReserve(seat){
  openModal({
    title:`å¸­ï¼ˆ${seat.label}ï¼‰`,
    sub:"ç©ºå¸­ã§ã™ã€‚ã©ã‚Œã‚’é¸ã³ã¾ã™ã‹ï¼Ÿ",
    bodyHtml: `
      <div class="btnRow">
        <button class="btnPrimary" id="chooseArrive">æ¥åº—</button>
        <button class="btnPrimary" id="chooseReserve">äºˆç´„</button>
      </div>
    `,
    yesText:"é–‰ã˜ã‚‹",
    onYes: ()=> closeModal()
  });

  setTimeout(()=>{
    document.getElementById("chooseArrive").onclick = ()=> { closeModal(); openPartyInput(seat, "arrive"); };
    document.getElementById("chooseReserve").onclick = ()=> { closeModal(); openPartyInput(seat, "reserve"); };
  },0);
}

function openPartyInput(seat, mode){
  const title = mode==="arrive" ? "æ¥åº—å…¥åŠ›" : "äºˆç´„å…¥åŠ›";
  const sub = mode==="arrive" ? "æ±ºå®šã§æ³¨æ–‡ãƒšãƒ¼ã‚¸ã¸ç§»å‹•ã—ã¾ã™" : "æ±ºå®šã§ãƒ¡ã‚¤ãƒ³ã¸æˆ»ã‚Šã€å¸­ãŒäºˆç´„è¡¨ç¤ºã«ãªã‚Šã¾ã™";

  const bodyHtml = `
    <div class="muted2">äººæ•°</div>
    <div class="stepper">
      <button class="stepBtn" id="piDec">â—€ï¸</button>
      <div class="stepNum" id="piNum">1</div>
      <button class="stepBtn" id="piInc">â–¶ï¸</button>
    </div>

    <div class="muted2">åå‰ï¼ˆä»»æ„ï¼‰</div>
    <input id="piName" type="text" placeholder="ä¾‹ï¼šç”°ä¸­" />

    ${mode==="reserve" ? `
      <div class="muted2">é›»è©±ç•ªå·ï¼ˆä»»æ„ï¼‰</div>
      <input id="piPhone" type="text" placeholder="ä¾‹ï¼š090-xxxx-xxxx" />
    ` : ``}
  `;

  openModal({
    title:`${title}ï¼ˆ${seat.label}ï¼‰`,
    sub,
    bodyHtml,
    yesText:"æ±ºå®š",
    noText:"æˆ»ã‚‹",
    onYes: ()=>{
      const people = parseInt(document.getElementById("piNum").textContent||"0",10);
      const name = (document.getElementById("piName").value||"").trim();
      const phone = mode==="reserve" ? (document.getElementById("piPhone").value||"").trim() : "";

      if(!people){
        openModal({ title:"äººæ•°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„", sub:"", yesText:"OK" });
        return;
      }

      if(mode==="arrive"){
        seat.status="active";
        seat.party = { people, name, phone:"" };
        seat.openedAt = nowTs();
        seat.orders = seat.orders || [];
        seat.mergedInto = null;
        save();
        closeModal();
        openOrderForSeat(seat.id);
      }else{
        seat.status="reserve";
        seat.party = { people, name, phone };
        seat.openedAt = nowTs();
        seat.orders = seat.orders || [];
        seat.mergedInto = null;
        save();
        closeModal();
        renderMain();
        go("main");
      }
    }
  });

  setTimeout(()=>{
    let n = 1;
    const render = ()=> document.getElementById("piNum").textContent = String(n);
    render();
    document.getElementById("piDec").onclick = ()=> { n = Math.max(1, n-1); render(); };
    document.getElementById("piInc").onclick = ()=> { n = Math.min(99, n+1); render(); };
  },0);
}

/* 7ï¼šäºˆç´„å¸­ã‚¿ãƒƒãƒ—æ™‚ã«äºˆç´„è€…æƒ…å ±ã‚’è¡¨ç¤º */
function openReserveAction(seat){
  const p = seat.party || {};
  const info = `
    <div class="muted2" style="font-weight:900; margin-bottom:8px;">äºˆç´„è€…æƒ…å ±</div>
    <div class="muted2">åå‰ï¼š${escapeHtml(p.name||"æœªå…¥åŠ›")}</div>
    <div class="muted2">é€£çµ¡å…ˆï¼š${escapeHtml(p.phone||"æœªå…¥åŠ›")}</div>
    <div class="muted2">æ™‚é–“ï¼š${seat.openedAt ? escapeHtml(fmtTime(seat.openedAt)) : "æœªå…¥åŠ›"}</div>
    <div class="hr"></div>
  `;

  openModal({
    title:`äºˆç´„ï¼ˆ${seat.label}ï¼‰`,
    sub:"ã©ã‚Œã‚’é¸ã³ã¾ã™ã‹ï¼Ÿ",
    bodyHtml: `
      ${info}
      <div class="btnRow">
        <button class="btnPrimary" id="rvArrive">æ¥åº—</button>
        <button class="btnDanger" id="rvCancel">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      </div>
    `,
    yesText:"æˆ»ã‚‹",
    onYes: ()=> closeModal()
  });

  setTimeout(()=>{
    document.getElementById("rvArrive").onclick = ()=>{ closeModal(); openPartyInput(seat, "arrive"); };
    document.getElementById("rvCancel").onclick = ()=>{
      seat.status="empty"; seat.party=null; seat.openedAt=null; seat.orders=[]; seat.mergedInto=null;
      save(); closeModal(); renderMain();
    };
  },0);
}

/* ========================= Ops ========================= */
const opButtons = Array.from(document.querySelectorAll(".opsBtn.same"));
const opDecide = document.getElementById("opDecide");

function renderOpsButtons(){
  const selected = state.ui.opSelected;
  opButtons.forEach(b=> b.classList.toggle("selected", selected===b.dataset.op));
}
opButtons.forEach(b=>{
  b.onclick = ()=>{
    const op = b.dataset.op;
    state.ui.opSelected = (state.ui.opSelected===op) ? null : op;
    if(!state.ui.opSelected) state.ui.selectedSeatIds = [];
    save();
    renderMain();
  };
});

/* 7-2ï¼šå¸­ç§»å‹•ã¯çµ±åˆã—ãªã„ã€ãƒ‡ãƒ¼ã‚¿ã®å…¥ã‚Œæ›¿ãˆï¼ˆswapï¼‰ */
opDecide.onclick = ()=>{
  const op = state.ui.opSelected;
  if(!op){
    openModal({ title:"æ“ä½œã‚’é¸ã‚“ã§ãã ã•ã„", sub:"å¸­ç§»å‹• / åˆè¨ˆåˆç®— / åˆè¨ˆåˆ†å‰² ã®ã©ã‚Œã‹ã‚’é¸æŠã—ã¾ã™", yesText:"OK" });
    return;
  }
  const ids = state.ui.selectedSeatIds;
  if(ids.length===0){
    openModal({ title:"å¸­ã‚’é¸æŠã—ã¦ãã ã•ã„", sub:"æ“ä½œã—ãŸã„å¸­ã‚’ã‚¿ãƒƒãƒ—ã—ã¦é¸ã³ã¾ã™ï¼ˆå†ã‚¿ãƒƒãƒ—ã§è§£é™¤ï¼‰", yesText:"OK" });
    return;
  }

  if(op==="merge"){
    if(ids.length<2){
      openModal({ title:"åˆè¨ˆåˆç®—", sub:"2å¸­ä»¥ä¸Šã‚’é¸æŠã—ã¦ãã ã•ã„", yesText:"OK" });
      return;
    }
    const seats = ids.map(id=> state.seats.find(s=> s.id===id)).filter(Boolean);
    seats.sort((a,b)=> (a.label||"").localeCompare((b.label||""), "ja", { numeric:true, sensitivity:"base" }));
    const base = seats[0];
    const others = seats.slice(1);

    openModal({
      title:"åˆè¨ˆåˆç®—ã—ã¾ã™ã‹ï¼Ÿ",
      sub:`ã€Œ${base.label}ã€ã«åˆç®—ã—ã¾ã™ï¼ˆä»–ã®å¸­ã¯ã€Œåˆç®—ã€è¡¨ç¤ºã«ãªã‚Šã¾ã™ï¼‰`,
      yesText:"æ±ºå®š",
      noText:"æˆ»ã‚‹",
      onYes: ()=>{
        for(const s of others){ s.mergedInto = base.id; }
        save();
        closeModal();
        state.ui.opSelected = null;
        state.ui.selectedSeatIds = [];
        save();
        renderMain();
      }
    });

  }else if(op==="split"){
    const seats = ids.map(id=> state.seats.find(s=> s.id===id)).filter(Boolean);
    openModal({
      title:"åˆè¨ˆåˆ†å‰²ã—ã¾ã™ã‹ï¼Ÿ",
      sub:"èª¤æ“ä½œã®æ•‘æ¸ˆç”¨ã§ã™ï¼ˆåˆç®—çŠ¶æ…‹ã‚’è§£é™¤ã—ã¾ã™ï¼‰",
      yesText:"æ±ºå®š",
      noText:"æˆ»ã‚‹",
      onYes: ()=>{
        const selectedSet = new Set(ids);
        for(const s of seats){ if(s.mergedInto) s.mergedInto = null; }
        for(const s of seats){
          const baseId = s.id;
          if(selectedSet.has(baseId)){
            state.seats.forEach(x=>{ if(x.mergedInto===baseId) x.mergedInto = null; });
          }
        }
        save();
        closeModal();
        state.ui.opSelected = null;
        state.ui.selectedSeatIds = [];
        save();
        renderMain();
      }
    });

  }else if(op==="move"){
    if(ids.length!==2){
      openModal({ title:"å¸­ç§»å‹•", sub:"ç§»å‹•å…ƒã¨ç§»å‹•å…ˆã®2å¸­ã‚’é¸æŠã—ã¦ãã ã•ã„", yesText:"OK" });
      return;
    }
    const a = state.seats.find(s=> s.id===ids[0]);
    const b = state.seats.find(s=> s.id===ids[1]);
    if(!a || !b) return;

    openModal({
      title:"å¸­ç§»å‹•ã—ã¾ã™ã‹ï¼Ÿ",
      sub:`ã€Œ${a.label}ã€â‡„ã€Œ${b.label}ã€ã®ãƒ‡ãƒ¼ã‚¿ã‚’å…¥ã‚Œæ›¿ãˆã¾ã™ï¼ˆä¸Šæ›¸ããªã—ï¼‰`,
      yesText:"æ±ºå®š",
      noText:"æˆ»ã‚‹",
      onYes: ()=>{
        const tmp = {
          status:a.status, party:a.party, openedAt:a.openedAt, orders:(a.orders||[]), mergedInto:a.mergedInto
        };
        a.status = b.status;
        a.party = b.party;
        a.openedAt = b.openedAt;
        a.orders = (b.orders||[]);
        a.mergedInto = b.mergedInto;

        b.status = tmp.status;
        b.party = tmp.party;
        b.openedAt = tmp.openedAt;
        b.orders = tmp.orders;
        b.mergedInto = tmp.mergedInto;

        save();
        closeModal();
        state.ui.opSelected = null;
        state.ui.selectedSeatIds = [];
        save();
        renderMain();
      }
    });
  }
};

/* ========================= Navigation ========================= */
document.getElementById("settingsBtn").onclick = ()=> go("settings");
document.getElementById("todaySalesBtn").onclick = ()=> go("todaySales");

document.getElementById("backupBtn").onclick = ()=>{
  openModal({
    title:"ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ï¼ˆç„¡æ–™ç‰ˆï¼‰",
    sub:"ç„¡æ–™ç‰ˆã¯ç°¡æ˜“ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã§ã™ï¼ˆç«¯æœ«å†…ä¿å­˜ï¼‰ã€‚æœ‰æ–™ç‰ˆã§è¤‡æ•°ç«¯æœ«å…±æœ‰/ãƒ¡ãƒ¼ãƒ«é€ä¿¡ã‚’å¼·åŒ–äºˆå®šã€‚",
    yesText:"OK"
  });
};
document.getElementById("brandBtn").onclick = ()=>{
  openModal({
    title:"ONEï¼ˆç„¡æ–™/æœ‰æ–™ï¼‰",
    sub:"ç¾åœ¨ã€æœ‰æ–™ç‰ˆã¯æº–å‚™ä¸­ã§ã™ã€‚ç„¡æ–™ç‰ˆã‚’ãŠä½¿ã„ãã ã•ã„ã€‚",
    yesText:"OK"
  });
};
kitchenBtn.onclick = ()=>{
  if(state.ui.view==="kitchen") go("main");
  else go("kitchen");
};

topMainBtn.onclick = ()=> go("main");

document.querySelectorAll(".menuCard").forEach(el=>{
  el.addEventListener("click", ()=>{
    const goKey = el.getAttribute("data-go");
    if(goKey==="recipe") go("recipe");
    else go(goKey);
  });
});

/* ========================= Seat Register logic ========================= */
const otherNameWrap = document.getElementById("otherNameWrap");
const otherName = document.getElementById("otherName");
const countNum = document.getElementById("countNum");
const countLabel = document.getElementById("countLabel");
const seatInputs = document.getElementById("seatInputs");
const capInputs = document.getElementById("capInputs");
const resetSeatReg = document.getElementById("resetSeatReg");
const saveSeatsBtn = document.getElementById("saveSeats");

let sr = { type: null, typeName: "", count: 0, labels: [], caps: [], defaultCap: 4 };

function typeToName(t){
  const map = { counter:"ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼", stand:"ç«‹ã¡", table:"ãƒ†ãƒ¼ãƒ–ãƒ«", zashiki:"åº§æ•·", room:"å€‹å®¤", other:"ãã®ä»–" };
  return map[t] || "";
}

/* åç§°ãƒœã‚¿ãƒ³é¸æŠï¼ˆãƒã‚¤ãƒ©ã‚¤ãƒˆON/OFFï¼‰ */
document.querySelectorAll("[data-seatType]").forEach(btn=>{
  const handler = ()=>{
    const clicked = btn.dataset.seatType;

    if(sr.type===clicked){
      sr.type = null;
      sr.typeName = "";
      otherNameWrap.style.display = "none";
      document.querySelectorAll("[data-seatType]").forEach(b=> b.classList.remove("btnPrimary"));
      renderSeatInputs();
      renderCapInputs();
      return;
    }

    sr.type = clicked;
    document.querySelectorAll("[data-seatType]").forEach(b=> b.classList.remove("btnPrimary"));
    btn.classList.add("btnPrimary");

    let name = typeToName(sr.type);
    if(sr.type==="other"){
      otherNameWrap.style.display = "block";
      name = (otherName.value||"").trim() || "ãã®ä»–";
    }else{
      otherNameWrap.style.display = "none";
    }
    sr.typeName = name;

    sr.defaultCap = (sr.type==="counter" || sr.type==="stand") ? 1 : 4;
    countLabel.textContent = (sr.type==="counter" || sr.type==="stand") ? "ç·å¸­æ•°" : "ç·å“æ•°";

    renderSeatInputs();
    renderCapInputs();
  };

  btn.addEventListener("click", handler);
  btn.addEventListener("touchend", (e)=>{ e.preventDefault(); handler(); }, {passive:false});
});

otherName.addEventListener("input", ()=>{
  if(sr.type==="other") sr.typeName = (otherName.value||"").trim() || "ãã®ä»–";
});

document.getElementById("countDec").onclick = ()=> {
  sr.count = Math.max(0, sr.count-1);
  countNum.textContent = String(sr.count);
  renderSeatInputs();
  renderCapInputs();
};
document.getElementById("countInc").onclick = ()=> {
  sr.count = Math.min(99, sr.count+1);
  countNum.textContent = String(sr.count);
  renderSeatInputs();
  renderCapInputs();
};

resetSeatReg.onclick = ()=>{
  sr.type = null; sr.typeName = ""; sr.count = 0; sr.labels = []; sr.caps = [];
  otherName.value = ""; otherNameWrap.style.display = "none";
  countNum.textContent = "0"; countLabel.textContent = "ç·å¸­æ•° / ç·å“æ•°";
  document.querySelectorAll("[data-seatType]").forEach(b=> b.classList.remove("btnPrimary"));
  renderSeatInputs(); renderCapInputs();
  openModal({ title:"å…¥åŠ›ã‚’å–ã‚Šæ¶ˆã—ã¾ã—ãŸ", sub:"ã“ã®ç”»é¢ã®å…¥åŠ›ã‚’åˆæœŸçŠ¶æ…‹ã«æˆ»ã—ã¾ã—ãŸ", yesText:"OK" });
};

function guessNextLabel(prev){
  if(!prev) return "";
  prev = String(prev).trim();
  if(!prev) return "";
  prev = prev.toUpperCase();

  const m = prev.match(/^(.*?)(\d+)$/);
  if(m){
    const head = m[1];
    const num = parseInt(m[2],10);
    return head + String(num+1);
  }
  if(prev.length===1 && prev>="A" && prev<="Z"){
    const c = prev.charCodeAt(0);
    if(c<90) return String.fromCharCode(c+1);
    return "A";
  }
  const last = prev.slice(-1);
  if(last>="A" && last<="Z"){
    const c = last.charCodeAt(0);
    const next = (c<90) ? String.fromCharCode(c+1) : "A";
    return prev.slice(0,-1)+next;
  }
  return prev + "_2";
}

function renderSeatInputs(){
  seatInputs.innerHTML = "";
  const count = sr.count || 0;
  while(sr.labels.length < count) sr.labels.push("");
  sr.labels = sr.labels.slice(0,count);

  for(let i=0;i<count;i++){
    const wrap = document.createElement("div");
    wrap.style.marginBottom = "10px";

    if(!sr.labels[i] && i>0){
      const auto = guessNextLabel(sr.labels[i-1]);
      if(auto) sr.labels[i] = auto;
    }

    const nextHint = (i>0) ? guessNextLabel(sr.labels[i-1] || sr.labels[i] || "") : "";

    wrap.innerHTML = `
      <div class="muted2" style="margin-bottom:6px; font-weight:900;">${i+1}å¸­ï¼ˆå“ï¼‰ç›®</div>
      <input type="text" value="${escapeHtml(sr.labels[i]||"")}" data-idx="${i}"
        placeholder="${i===0 ? "ä¾‹ï¼š1 / A / C1" : (nextHint ? `ä¾‹ï¼š${escapeHtml(nextHint)}` : "ä¾‹ï¼š2")}" />
    `;
    const input = wrap.querySelector("input");
    input.oninput = (e)=>{
      let v = (e.target.value||"").toUpperCase().trim();
      sr.labels[i] = v;

      if(i<count-1 && !sr.labels[i+1]){
        const auto = guessNextLabel(v);
        if(auto){
          sr.labels[i+1] = auto;
          renderSeatInputs();
        }
      }
    };
    seatInputs.appendChild(wrap);
  }
}

function renderCapInputs(){
  capInputs.innerHTML = "";
  const count = sr.count || 0;
  while(sr.caps.length < count) sr.caps.push(sr.defaultCap || 4);
  sr.caps = sr.caps.slice(0,count);

  for(let i=0;i<count;i++){
    const row = document.createElement("div");
    row.style.marginBottom = "10px";
    row.innerHTML = `
      <div class="muted2" style="margin-bottom:6px; font-weight:900;">${escapeHtml(sr.labels[i]||`${i+1}`)} ã®æœ€å¤§äººæ•°</div>
      <div style="display:flex; gap:10px; align-items:center;">
        <button class="stepBtn" data-dec="${i}">â—€ï¸</button>
        <div class="stepNum" id="capNum_${i}">${sr.caps[i]||1}</div>
        <button class="stepBtn" data-inc="${i}">â–¶ï¸</button>
      </div>
    `;
    capInputs.appendChild(row);

    row.querySelector(`[data-dec="${i}"]`).onclick = ()=>{
      sr.caps[i] = Math.max(1, (sr.caps[i]||1)-1);
      document.getElementById(`capNum_${i}`).textContent = String(sr.caps[i]);
    };
    row.querySelector(`[data-inc="${i}"]`).onclick = ()=>{
      sr.caps[i] = Math.min(99, (sr.caps[i]||1)+1);
      document.getElementById(`capNum_${i}`).textContent = String(sr.caps[i]);
    };
  }
}

saveSeatsBtn.onclick = ()=>{
  if(!sr.type){
    openModal({ title:"åç§°ã‚’é¸ã‚“ã§ãã ã•ã„", sub:"ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ / ç«‹ã¡ / ãƒ†ãƒ¼ãƒ–ãƒ« / åº§æ•· / å€‹å®¤ / ãã®ä»–", yesText:"OK" });
    return;
  }
  if(sr.type==="other"){
    const nm = (otherName.value||"").trim();
    if(!nm){
      openModal({ title:"ãã®ä»–ã®åç§°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„", sub:"ä¾‹ï¼šä¸­åº­ãƒ†ãƒ©ã‚¹", yesText:"OK" });
      return;
    }
    sr.typeName = nm;
  }
  if(!sr.count){
    openModal({ title:"ç·å¸­æ•° / ç·å“æ•°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„", sub:"â—€ï¸ / â–¶ï¸ ã§æ•°ã‚’èª¿æ•´ã§ãã¾ã™", yesText:"OK" });
    return;
  }

  const labels = sr.labels.map(x=> (x||"").toUpperCase().trim());
  for(let i=0;i<labels.length;i++){
    if(!labels[i]){
      openModal({ title:"å¸­ç•ªå·ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„", sub:`${i+1}å¸­ï¼ˆå“ï¼‰ç›®ãŒç©ºã§ã™`, yesText:"OK" });
      return;
    }
  }

  const existingLabels = new Set(state.seats.map(s=> (s.label||"").toUpperCase()));
  const dup = labels.find(l => existingLabels.has(l));
  if(dup){
    openModal({
      title:"åŒã˜å¸­ï¼ˆå“ï¼‰ç•ªå·ãŒã‚ã‚Šã¾ã™ãŒç™»éŒ²ã—ã¾ã™ã‹ï¼Ÿ",
      sub:`ã€Œ${dup}ã€ãŒæ—¢ã«å­˜åœ¨ã—ã¾ã™`,
      yesText:"â—‹ï¼ˆç™»éŒ²ã™ã‚‹ï¼‰",
      noText:"âœ–ï¸ï¼ˆæˆ»ã‚‹ï¼‰",
      onYes: ()=>{ closeModal(); doSaveSeats(labels); }
    });
    return;
  }

  doSaveSeats(labels);
};

function doSaveSeats(labels){
  for(let i=0;i<labels.length;i++){
    state.seats.push({
      id: "S"+nowTs()+ "_" + i + "_" + Math.random().toString(16).slice(2),
      label: labels[i],
      type: sr.type,
      typeName: sr.typeName,
      cap: sr.caps[i] || (sr.defaultCap||4),
      status: "empty",
      party: null,
      openedAt: null,
      orders: [],
      mergedInto: null
    });
  }
  save();
  openModal({ title:"ä¿å­˜ã—ã¾ã—ãŸ", sub:"ãƒ¡ã‚¤ãƒ³ã«åæ˜ ã—ã¾ã—ãŸ", yesText:"OK", onYes: ()=>{ closeModal(); go("main"); }});
}

/* å…¨å¸­ãƒ‡ãƒ¼ã‚¿ã®åˆæœŸåŒ–ï¼ˆæœªä¼šè¨ˆãŒã‚ã‚‹ã¨ä¸å¯ï¼‰ */
document.getElementById("initAllSeatsBtn").onclick = ()=>{
  const hasUnpaid = state.seats.some(s=> (s.orders||[]).length>0 || s.status==="active" || s.status==="reserve" || s.mergedInto);
  if(hasUnpaid){
    openModal({
      title:"åˆæœŸåŒ–ã§ãã¾ã›ã‚“",
      sub:"æœªä¼šè¨ˆã®å¸­ãŒã‚ã‚Šã¾ã™ã€‚å…¨å¸­ãŒä¼šè¨ˆæ¸ˆã¿ã«ãªã‚‰ãªã„ã¨åˆæœŸåŒ–ã§ãã¾ã›ã‚“ã€‚",
      yesText:"OK"
    });
    return;
  }

  openModal({
    title:"å…¨å¸­ãƒ‡ãƒ¼ã‚¿ã®åˆæœŸåŒ–",
    sub:"å¸­ãƒ‡ãƒ¼ã‚¿ã‚’åˆæœŸåŒ–ã™ã‚‹ã¨å…ƒã«æˆ»ã›ã¾ã›ã‚“ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ",
    yesText:"æ¬¡ã¸",
    noText:"æˆ»ã‚‹",
    onYes: ()=>{
      closeModal();
      openDangerSlideModal({
        title:"å…¨å¸­ãƒ‡ãƒ¼ã‚¿ã‚’åˆæœŸåŒ–ã—ã¾ã™",
        sub:"ã‚¹ãƒ©ã‚¤ãƒ‰ã™ã‚‹ã¨å…¨å¸­ãƒ‡ãƒ¼ã‚¿ã‚’åˆæœŸåŒ–ã—ã¾ã™ï¼ˆå…ƒã«æˆ»ã›ã¾ã›ã‚“ï¼‰",
        onDone: ()=>{
          state.seats = [];
          save();
          closeModal();
          renderSeatRegisterPreview();
          renderMain();
          openModal({ title:"åˆæœŸåŒ–ã—ã¾ã—ãŸ", sub:"å…¨å¸­ãƒ‡ãƒ¼ã‚¿ã‚’åˆæœŸåŒ–ã—ã¾ã—ãŸ", yesText:"OK" });
        }
      });
    }
  });
};

/* ========================= ã“ã“ã‹ã‚‰å…ˆã¯ PART2 ã§ç¶šã ========================= *//* =========================
  å±é™ºæ“ä½œã‚¹ãƒ©ã‚¤ãƒ‰ãƒ¢ãƒ¼ãƒ€ãƒ«
========================= */
function openDangerSlideModal({title, sub, onDone}){
  openModal({
    title,
    sub,
    bodyHtml: `
      <div class="muted2" style="font-weight:900; margin-bottom:10px;">å±é™ºæ“ä½œ</div>
      <div class="slider" id="dangerSlider">
        <div class="sliderTrack">ã‚¹ãƒ©ã‚¤ãƒ‰ã§å®Ÿè¡Œ</div>
        <div class="sliderKnob" id="dangerKnob">â–¶ï¸</div>
      </div>
      <div class="muted2" style="margin-top:10px; font-size:.92rem;">
        â€» å³ç«¯ã¾ã§ã‚¹ãƒ©ã‚¤ãƒ‰ã™ã‚‹ã¨å®Ÿè¡Œã•ã‚Œã¾ã™
      </div>
    `,
    yesText:"æˆ»ã‚‹",
    yesClass:"",
    onYes: ()=> closeModal()
  });

  setTimeout(()=>{
    const slider = document.getElementById("dangerSlider");
    const knob = document.getElementById("dangerKnob");
    if(!slider || !knob) return;

    let dragging = false;
    let startX = 0;
    let startLeft = 2;
    const maxLeft = slider.clientWidth - knob.clientWidth - 2;

    const setLeft = (x)=>{
      const left = Math.max(2, Math.min(maxLeft, x));
      knob.style.left = left + "px";
      return left;
    };

    const doneIfNeeded = (left)=>{
      if(left >= maxLeft - 2){
        // å®Ÿè¡Œ
        if(onDone) onDone();
      }else{
        // æˆ»ã™
        knob.style.left = "2px";
      }
    };

    const onDown = (e)=>{
      dragging = true;
      startX = (e.touches ? e.touches[0].clientX : e.clientX);
      startLeft = parseFloat(getComputedStyle(knob).left) || 2;
      e.preventDefault();
    };
    const onMove = (e)=>{
      if(!dragging) return;
      const x = (e.touches ? e.touches[0].clientX : e.clientX);
      const dx = x - startX;
      setLeft(startLeft + dx);
      e.preventDefault();
    };
    const onUp = ()=>{
      if(!dragging) return;
      dragging = false;
      const left = parseFloat(getComputedStyle(knob).left) || 2;
      doneIfNeeded(left);
    };

    knob.addEventListener("mousedown", onDown);
    knob.addEventListener("touchstart", onDown, {passive:false});
    window.addEventListener("mousemove", onMove, {passive:false});
    window.addEventListener("touchmove", onMove, {passive:false});
    window.addEventListener("mouseup", onUp);
    window.addEventListener("touchend", onUp);
  },0);
}

/* =========================
  ãƒ¡ãƒ‹ãƒ¥ãƒ¼ç™»éŒ²
========================= */
const mCategory = document.getElementById("mCategory");
const mGenreSel = document.getElementById("mGenreSel");
const addGenreBtn = document.getElementById("addGenreBtn");
const mName = document.getElementById("mName");
const mPrice = document.getElementById("mPrice");
const mTax = document.getElementById("mTax");
const mAdd = document.getElementById("mAdd");
const viewGenreSel = document.getElementById("viewGenreSel");
const viewGenreDecide = document.getElementById("viewGenreDecide");
const menuList = document.getElementById("menuList");

function ensureDefaultGenres(){
  // ç„¡æ–™ç‰ˆï¼šåˆæœŸã‚¸ãƒ£ãƒ³ãƒ«ã‚’å°‘ã—ã ã‘ç”¨æ„ï¼ˆç©ºã§ã‚‚OKï¼‰
  if(!state.genres.food.length) state.genres.food = ["ãŠã™ã™ã‚", "å®šç•ª"].filter(Boolean);
  if(!state.genres.drink.length) state.genres.drink = ["ãƒ“ãƒ¼ãƒ«", "ãƒã‚¤ãƒœãƒ¼ãƒ«", "ã‚½ãƒ•ãƒˆãƒ‰ãƒªãƒ³ã‚¯"].filter(Boolean);
}

function renderGenreSelects(){
  ensureDefaultGenres();

  const cat = mCategory.value || "food";
  const genres = (cat==="drink") ? state.genres.drink : state.genres.food;

  mGenreSel.innerHTML = `<option value="">ï¼ˆæœªé¸æŠâ†’æœªåˆ†é¡ï¼‰</option>` +
    genres.map(g=> `<option value="${escapeHtml(g)}">${escapeHtml(g)}</option>`).join("");

  // é–²è¦§å´ï¼šæ–™ç†/ãƒ‰ãƒªãƒ³ã‚¯ã¾ã¨ã‚
  const all = [];
  for(const g of state.genres.food) all.push({cat:"food", g});
  for(const g of state.genres.drink) all.push({cat:"drink", g});
  all.sort((a,b)=> (a.g||"").localeCompare((b.g||""), "ja", { sensitivity:"base", numeric:true }));

  viewGenreSel.innerHTML =
    `<option value="__ALL__">ï¼ˆå…¨ã¦ï¼‰</option>` +
    `<optgroup label="æ–™ç†">` + state.genres.food.map(g=> `<option value="food::${escapeHtml(g)}">${escapeHtml(g)}</option>`).join("") + `</optgroup>` +
    `<optgroup label="ãƒ‰ãƒªãƒ³ã‚¯">` + state.genres.drink.map(g=> `<option value="drink::${escapeHtml(g)}">${escapeHtml(g)}</option>`).join("") + `</optgroup>` +
    `<option value="food::__UN__">æ–™ç†ï¼šæœªåˆ†é¡</option>` +
    `<option value="drink::__UN__">ãƒ‰ãƒªãƒ³ã‚¯ï¼šæœªåˆ†é¡</option>`;
}

function renderMenuRegister(){
  renderGenreSelects();
  renderMenuListBySelector();
}

mCategory.onchange = ()=> renderGenreSelects();

addGenreBtn.onclick = ()=>{
  openModal({
    title:"ã‚¸ãƒ£ãƒ³ãƒ«è¿½åŠ ",
    sub:"ä¾‹ï¼šæšã’ç‰© / ç„¼ãç‰© / æ—¥æœ¬é…’ / ãƒ¯ã‚¤ãƒ³ ãªã©",
    bodyHtml:`<input id="newGenre" type="text" placeholder="ã‚¸ãƒ£ãƒ³ãƒ«å" />`,
    yesText:"è¿½åŠ ",
    noText:"æˆ»ã‚‹",
    onYes: ()=>{
      const g = (document.getElementById("newGenre").value||"").trim();
      if(!g){
        openModal({ title:"ã‚¸ãƒ£ãƒ³ãƒ«åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„", sub:"", yesText:"OK" });
        return;
      }
      const cat = mCategory.value || "food";
      const list = (cat==="drink") ? state.genres.drink : state.genres.food;
      if(list.includes(g)){
        closeModal();
        openModal({ title:"æ—¢ã«å­˜åœ¨ã—ã¾ã™", sub:`ã€Œ${g}ã€ã¯ç™»éŒ²æ¸ˆã¿ã§ã™`, yesText:"OK" });
        return;
      }
      list.push(g);
      list.sort(jaSort);
      save();
      closeModal();
      renderGenreSelects();
    }
  });
};

mAdd.onclick = ()=>{
  const cat = mCategory.value || "food";
  const genre = (mGenreSel.value||"").trim();
  const name = (mName.value||"").trim();
  const price = parseInt(mPrice.value||"0",10);
  const tax = parseInt(mTax.value||"10",10);

  if(!name){
    openModal({ title:"å•†å“åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„", sub:"", yesText:"OK" });
    return;
  }
  if(!price || price<0){
    openModal({ title:"é‡‘é¡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„", sub:"0ã‚„æœªå…¥åŠ›ã¯ç™»éŒ²ã§ãã¾ã›ã‚“", yesText:"OK" });
    return;
  }

  // é‡è¤‡åˆ¤å®šï¼ˆç„¡æ–™ç‰ˆï¼šæ–­å®šã›ãšç¢ºèªï¼‰
  const nk = normalizeKey(name);
  const exists = state.menu.find(m=> normalizeKey(m.name)===nk && (m.category||"food")===cat);
  if(exists){
    openModal({
      title:"é‡è¤‡ã®å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™",
      sub:`ã€Œ${exists.name}ã€ãŒæ—¢ã«ã‚ã‚Šã¾ã™ã€‚ç™»éŒ²ã—ã¾ã™ã‹ï¼Ÿï¼ˆæœ€çµ‚åˆ¤æ–­ã¯äººï¼‰`,
      yesText:"ç™»éŒ²ã™ã‚‹",
      noText:"æˆ»ã‚‹",
      onYes: ()=>{
        closeModal();
        doAddMenu({cat, genre, name, price, tax});
      }
    });
    return;
  }

  doAddMenu({cat, genre, name, price, tax});
};

function doAddMenu({cat, genre, name, price, tax}){
  state.menu.push({
    id: "M"+nowTs()+"_"+Math.random().toString(16).slice(2),
    category: cat,
    genre: genre || "",
    name,
    price,
    tax
  });
  save();
  mName.value = "";
  mPrice.value = "";
  renderMenuListBySelector();
  openModal({ title:"ç™»éŒ²ã—ã¾ã—ãŸ", sub:`${name} ã‚’è¿½åŠ ã—ã¾ã—ãŸ`, yesText:"OK" });
}

viewGenreDecide.onclick = ()=> renderMenuListBySelector();

function renderMenuListBySelector(){
  const sel = viewGenreSel.value || "__ALL__";
  let list = [...state.menu];

  if(sel !== "__ALL__"){
    const [cat, g] = sel.split("::");
    list = list.filter(m=> (m.category||"food")===cat);
    if(g==="__UN__") list = list.filter(m=> !(m.genre||"").trim());
    else list = list.filter(m=> (m.genre||"").trim()===g);
  }

  // ä¸¦ã³ï¼šã‚¸ãƒ£ãƒ³ãƒ«â†’åå‰
  list.sort((a,b)=>{
    const ga = (a.genre||"")||"";
    const gb = (b.genre||"")||"";
    const cg = ga.localeCompare(gb, "ja", { sensitivity:"base" });
    if(cg!==0) return cg;
    return (a.name||"").localeCompare((b.name||""), "ja", { sensitivity:"base", numeric:true });
  });

  menuList.innerHTML = "";
  if(!list.length){
    menuList.innerHTML = `<div class="muted2" style="margin-top:10px;">è©²å½“ã™ã‚‹å•†å“ãŒã‚ã‚Šã¾ã›ã‚“</div>`;
    return;
  }

  const box = document.createElement("div");
  box.className = "listBox";
  box.innerHTML = `
    <div class="listHead">
      <span>ä¸€è¦§</span>
      <span class="muted2">${list.length}ä»¶</span>
    </div>
    <div id="menuRows"></div>
  `;
  menuList.appendChild(box);

  const rows = box.querySelector("#menuRows");

  for(const m of list){
    const row = document.createElement("div");
    row.className = "listRow";
    row.innerHTML = `
      <div>
        <div class="listName">${escapeHtml(m.genre ? `${m.name}ï¼ˆ${m.genre}ï¼‰` : m.name)}</div>
        <div class="muted2" style="font-size:.88rem; font-weight:800;">
          ${m.category==="drink" ? "ãƒ‰ãƒªãƒ³ã‚¯" : "æ–™ç†"} / ç¨${m.tax||10}% / ${yen(m.price)}
        </div>
      </div>
      <button class="listBtn" data-edit="${m.id}">ä¿®æ­£</button>
      <button class="listBtn btnDanger" data-del="${m.id}">å‰Šé™¤</button>
    `;
    rows.appendChild(row);
  }

  rows.querySelectorAll("[data-edit]").forEach(btn=>{
    btn.onclick = ()=>{
      const id = btn.getAttribute("data-edit");
      const m = state.menu.find(x=> x.id===id);
      if(!m) return;
      openEditMenu(m);
    };
  });

  rows.querySelectorAll("[data-del]").forEach(btn=>{
    btn.onclick = ()=>{
      const id = btn.getAttribute("data-del");
      const m = state.menu.find(x=> x.id===id);
      if(!m) return;
      openModal({
        title:"å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ",
        sub:`${m.name}`,
        yesText:"å‰Šé™¤",
        noText:"æˆ»ã‚‹",
        yesClass:"btnDanger",
        onYes: ()=>{
          state.menu = state.menu.filter(x=> x.id!==id);
          save();
          closeModal();
          renderMenuListBySelector();
        }
      });
    };
  });
}

function openEditMenu(m){
  openModal({
    title:"å•†å“ã‚’ä¿®æ­£",
    sub:"å•†å“åãƒ»é‡‘é¡ãƒ»ç¨ç‡ãƒ»ã‚¸ãƒ£ãƒ³ãƒ«ã‚’ä¿®æ­£ã§ãã¾ã™",
    bodyHtml: `
      <div class="muted2">å•†å“å</div>
      <input id="emName" type="text" value="${escapeHtml(m.name)}" />
      <div style="height:10px;"></div>

      <div class="muted2">é‡‘é¡</div>
      <input id="emPrice" class="numField" type="number" inputmode="numeric" value="${m.price||0}" />
      <div style="height:10px;"></div>

      <div class="muted2">ç¨ç‡</div>
      <select id="emTax">
        <option value="10" ${String(m.tax||10)==="10"?"selected":""}>10%</option>
        <option value="8"  ${String(m.tax||10)==="8"?"selected":""}>8%</option>
      </select>
      <div style="height:10px;"></div>

      <div class="muted2">ã‚¸ãƒ£ãƒ³ãƒ«</div>
      <input id="emGenre" type="text" value="${escapeHtml(m.genre||"")}" placeholder="ç©ºãªã‚‰æœªåˆ†é¡" />
    `,
    yesText:"ä¿å­˜",
    noText:"æˆ»ã‚‹",
    onYes: ()=>{
      const name = (document.getElementById("emName").value||"").trim();
      const price = parseInt(document.getElementById("emPrice").value||"0",10);
      const tax = parseInt(document.getElementById("emTax").value||"10",10);
      const genre = (document.getElementById("emGenre").value||"").trim();

      if(!name){
        openModal({ title:"å•†å“åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„", sub:"", yesText:"OK" });
        return;
      }
      if(!price || price<0){
        openModal({ title:"é‡‘é¡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„", sub:"0ã‚„æœªå…¥åŠ›ã¯ä¿å­˜ã§ãã¾ã›ã‚“", yesText:"OK" });
        return;
      }

      // é‡è¤‡ç¢ºèªï¼ˆåŒã‚«ãƒ†ã‚´ãƒªå†…ï¼‰
      const nk = normalizeKey(name);
      const dup = state.menu.find(x=> x.id!==m.id && (x.category||"food")===(m.category||"food") && normalizeKey(x.name)===nk);
      if(dup){
        openModal({
          title:"é‡è¤‡ã®å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™",
          sub:`ã€Œ${dup.name}ã€ãŒæ—¢ã«ã‚ã‚Šã¾ã™ã€‚ä¿å­˜ã—ã¾ã™ã‹ï¼Ÿï¼ˆæœ€çµ‚åˆ¤æ–­ã¯äººï¼‰`,
          yesText:"ä¿å­˜ã™ã‚‹",
          noText:"æˆ»ã‚‹",
          onYes: ()=>{
            closeModal();
            m.name=name; m.price=price; m.tax=tax; m.genre=genre;
            save();
            renderMenuListBySelector();
            openModal({ title:"ä¿å­˜ã—ã¾ã—ãŸ", sub:"", yesText:"OK" });
          }
        });
        return;
      }

      m.name=name; m.price=price; m.tax=tax; m.genre=genre;
      save();
      closeModal();
      renderMenuListBySelector();
    }
  });
}

/* ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãƒ‡ãƒ¼ã‚¿ã®åˆæœŸåŒ–ï¼ˆæœªä¼šè¨ˆãŒã‚ã‚‹ã¨ä¸å¯ï¼‰ */
document.getElementById("initMenuBtn").onclick = ()=>{
  const hasUnpaid = state.seats.some(s=> (s.orders||[]).length>0 || s.status==="active" || s.status==="reserve" || s.mergedInto);
  if(hasUnpaid){
    openModal({
      title:"åˆæœŸåŒ–ã§ãã¾ã›ã‚“",
      sub:"æœªä¼šè¨ˆã®å¸­ãŒã‚ã‚Šã¾ã™ã€‚å…¨å¸­ãŒä¼šè¨ˆæ¸ˆã¿ã«ãªã‚‰ãªã„ã¨ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã¯åˆæœŸåŒ–ã§ãã¾ã›ã‚“ã€‚",
      yesText:"OK"
    });
    return;
  }

  openModal({
    title:"ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãƒ‡ãƒ¼ã‚¿ã®åˆæœŸåŒ–",
    sub:"åˆæœŸåŒ–å¯¾è±¡ã‚’é¸ã‚“ã§ãã ã•ã„",
    bodyHtml: `
      <div class="btnRow">
        <button class="btnPrimary" id="miFood">æ–™ç†</button>
        <button class="btnPrimary" id="miDrink">ãƒ‰ãƒªãƒ³ã‚¯</button>
        <button class="btnPrimary" id="miAll">å…¨ã¦</button>
      </div>
    `,
    yesText:"æˆ»ã‚‹",
    onYes: ()=> closeModal()
  });

  setTimeout(()=>{
    const goSlide = (mode)=>{
      closeModal();
      openDangerSlideModal({
        title:"ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’åˆæœŸåŒ–ã—ã¾ã™",
        sub:`ã‚¹ãƒ©ã‚¤ãƒ‰ã™ã‚‹ã¨ã€Œ${mode==="food"?"æ–™ç†":mode==="drink"?"ãƒ‰ãƒªãƒ³ã‚¯":"å…¨ã¦"}ã€ã‚’åˆæœŸåŒ–ã—ã¾ã™ï¼ˆå…ƒã«æˆ»ã›ã¾ã›ã‚“ï¼‰`,
        onDone: ()=>{
          if(mode==="food"){
            state.menu = state.menu.filter(m=> (m.category||"food")==="drink");
            state.genres.food = [];
          }else if(mode==="drink"){
            state.menu = state.menu.filter(m=> (m.category||"food")==="food");
            state.genres.drink = [];
          }else{
            state.menu = [];
            state.genres.food = [];
            state.genres.drink = [];
          }
          save();
          closeModal();
          renderMenuRegister();
          openModal({ title:"åˆæœŸåŒ–ã—ã¾ã—ãŸ", sub:"ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’åˆæœŸåŒ–ã—ã¾ã—ãŸ", yesText:"OK" });
        }
      });
    };

    document.getElementById("miFood").onclick = ()=> goSlide("food");
    document.getElementById("miDrink").onclick = ()=> goSlide("drink");
    document.getElementById("miAll").onclick = ()=> goSlide("all");
  },0);
};

/* å†™çœŸï¼ˆç„¡æ–™ç‰ˆã¯ãƒ€ãƒŸãƒ¼ï¼‰ */
const photoInput = document.getElementById("photoInput");
document.getElementById("photoBtn").onclick = ()=> {
  openModal({
    title:"å†™çœŸæ’®å½±ï¼ˆç„¡æ–™ç‰ˆï¼‰",
    sub:"ã“ã®æ©Ÿèƒ½ã¯æ”¹å–„ä¸­ã§ã™ã€‚ç¾æ™‚ç‚¹ã§ã¯æ’®å½±ã®ã¿ï¼ˆèª­ã¿å–ã‚Šã¯æœªå®Œæˆï¼‰ã§ã™ã€‚",
    yesText:"æ’®å½±ã™ã‚‹",
    noText:"æˆ»ã‚‹",
    onYes: ()=>{
      closeModal();
      photoInput.click();
    }
  });
};
document.getElementById("photoClearBtn").onclick = ()=> {
  photoInput.value = "";
  openModal({ title:"å†™çœŸã‚’æ¶ˆã—ã¾ã—ãŸ", sub:"", yesText:"OK" });
};
photoInput.onchange = ()=>{
  openModal({
    title:"èª­ã¿å–ã‚Šæº–å‚™ä¸­",
    sub:"ç„¡æ–™ç‰ˆã¯èª¤èªè­˜ãŒå¤šã„ãŸã‚ã€ç¾åœ¨ã¯æœªå®Œæˆã§ã™ï¼ˆæ¬¡ãƒ•ã‚§ãƒ¼ã‚ºã§å¼·åŒ–ï¼‰",
    yesText:"OK"
  });
};

/* =========================
  æ³¨æ–‡
========================= */
const orderHeaderTitle = document.getElementById("orderHeaderTitle");
const genreGrid = document.getElementById("genreGrid");
const itemsGrid = document.getElementById("itemsGrid");
const orderStageGenres = document.getElementById("orderStageGenres");
const orderStageItems = document.getElementById("orderStageItems");
const orderList = document.getElementById("orderList");
const orderSum = document.getElementById("orderSum");

document.getElementById("orderGoGenre").onclick = ()=>{
  state.ui.orderGenre = null;
  save();
  renderOrder();
};
document.getElementById("orderGoMain").onclick = ()=> go("main");
document.getElementById("orderGoCheckout").onclick = ()=> go("checkout");

document.getElementById("orderCatFood").onclick = ()=>{
  state.ui.orderCat = "food";
  state.ui.orderGenre = null;
  save();
  renderOrder();
};
document.getElementById("orderCatDrink").onclick = ()=>{
  state.ui.orderCat = "drink";
  state.ui.orderGenre = null;
  save();
  renderOrder();
};

function openOrderForSeat(seatId){
  state.ui.orderSeatId = seatId;
  state.ui.orderGenre = null;
  save();
  go("order");
}

function renderOrder(){
  const seat = state.seats.find(s=> s.id===state.ui.orderSeatId);
  if(!seat){
    go("main");
    return;
  }

  // è¦‹å‡ºã—ï¼šã€Œå•†å“ï¼ˆã‚¸ãƒ£ãƒ³ãƒ«ï¼‰ï¼æˆ»ã‚‹ã€ã‚’å›ºå®šè¡¨ç¤ºï¼‹å¼·èª¿
  const catLabel = state.ui.orderCat==="drink" ? "ãƒ‰ãƒªãƒ³ã‚¯" : "æ–™ç†";
  const g = state.ui.orderGenre ? `ï¼ˆ${state.ui.orderGenre}ï¼‰` : "";
  const people = seat.party?.people ? `${seat.party.people}å` : "";
  orderHeaderTitle.innerHTML = `
    <span class="badge">${escapeHtml(catLabel)}</span>
    <span style="font-weight:950;">${escapeHtml(seat.label)} ${people ? " / "+escapeHtml(people) : ""}</span>
    <span class="muted2" style="font-weight:900;">å•†å“${escapeHtml(g)}</span>
  `;

  // ã‚¸ãƒ£ãƒ³ãƒ«è¡¨ç¤º
  orderStageGenres.style.display = state.ui.orderGenre ? "none" : "block";
  orderStageItems.style.display  = state.ui.orderGenre ? "block" : "none";

  const cat = state.ui.orderCat || "food";

  // ã‚¸ãƒ£ãƒ³ãƒ«ä¸€è¦§
  const genres = new Set();
  for(const m of state.menu){
    if((m.category||"food")!==cat) continue;
    const gg = (m.genre||"").trim() || "æœªåˆ†é¡";
    genres.add(gg);
  }
  const glist = Array.from(genres).sort(jaSort);

  genreGrid.innerHTML = "";
  if(!glist.length){
    genreGrid.innerHTML = `<div class="muted2">ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãŒã‚ã‚Šã¾ã›ã‚“ï¼ˆãƒ¡ãƒ‹ãƒ¥ãƒ¼ç™»éŒ²ã§è¿½åŠ ã—ã¦ãã ã•ã„ï¼‰</div>`;
  }else{
    for(const gg of glist){
      const b = document.createElement("button");
      b.className = "genreBtn";
      b.textContent = gg;
      b.onclick = ()=>{
        state.ui.orderGenre = gg==="æœªåˆ†é¡" ? "__UN__" : gg;
        save();
        renderOrder();
      };
      genreGrid.appendChild(b);
    }
  }

  // å•†å“ä¸€è¦§
  itemsGrid.innerHTML = "";
  if(state.ui.orderGenre){
    const target = state.ui.orderGenre;
    let items = state.menu.filter(m=> (m.category||"food")===cat);
    if(target==="__UN__") items = items.filter(m=> !(m.genre||"").trim());
    else items = items.filter(m=> (m.genre||"").trim()===target);

    items.sort((a,b)=> (a.name||"").localeCompare((b.name||""), "ja", { sensitivity:"base", numeric:true }));

    for(const it of items){
      const btn = document.createElement("button");
      btn.className = "itemBtn";
      btn.innerHTML = `${escapeHtml(it.name)}<small>${yen(it.price)}</small>`;
      btn.onclick = ()=>{
        addOrder(seat.id, it);
        renderOrder();
      };
      itemsGrid.appendChild(btn);
    }
    if(!items.length){
      itemsGrid.innerHTML = `<div class="muted2">ã“ã®ã‚¸ãƒ£ãƒ³ãƒ«ã«å•†å“ãŒã‚ã‚Šã¾ã›ã‚“</div>`;
    }
  }

  renderOrderList(seat);
}

function addOrder(seatId, menuItem){
  const seat = state.seats.find(s=> s.id===seatId);
  if(!seat) return;
  seat.orders = seat.orders || [];

  const key = `${menuItem.id}`;
  const found = seat.orders.find(o=> o.menuId===key);
  if(found){
    found.qty = (found.qty||1) + 1;
  }else{
    seat.orders.push({
      id: "O"+nowTs()+"_"+Math.random().toString(16).slice(2),
      menuId: key,
      name: menuItem.name,
      price: menuItem.price,
      tax: menuItem.tax || 10,
      category: menuItem.category || "food",
      genre: menuItem.genre || "",
      qty: 1,
      at: nowTs(),
      promoted: false
    });
  }
  save();
}

/* æ³¨æ–‡å±¥æ­´ï¼ˆå¢—æ¸›ãƒ»å‰Šé™¤ï¼‰ */
function renderOrderList(seat){
  orderList.innerHTML = "";

  // åˆç®—æ™‚ã¯ãƒ™ãƒ¼ã‚¹ã«é›†ã‚ã¦è¦‹ã‚‹ï¼ˆè¦‹ãŸç›®ã ã‘ï¼‰
  const ids = [seat.id, ...state.seats.filter(s=> s.mergedInto===seat.id).map(s=> s.id)];
  const allOrders = [];
  for(const sid of ids){
    const s = state.seats.find(x=> x.id===sid);
    if(!s) continue;
    for(const o of (s.orders||[])){
      allOrders.push({seatId:sid, o});
    }
  }

  // è¡¨ç¤ºï¼šæ–°ã—ã„é †
  allOrders.sort((a,b)=> (b.o.at||0)-(a.o.at||0));

  let sum = 0;
  for(const x of allOrders){
    sum += (x.o.price||0) * (x.o.qty||1);
  }
  orderSum.textContent = `åˆè¨ˆ ${yen(sum)}`;

  if(!allOrders.length){
    orderList.innerHTML = `<div class="muted2" style="padding:12px;">ã¾ã æ³¨æ–‡ãŒã‚ã‚Šã¾ã›ã‚“</div>`;
    return;
  }

  for(const x of allOrders){
    const o = x.o;
    const row = document.createElement("div");
    row.className = "listRow";
    row.innerHTML = `
      <div>
        <div class="listName">${escapeHtml(o.name)}</div>
        <div class="muted2" style="font-size:.88rem; font-weight:800;">
          ${yen(o.price)} / Ã—${o.qty||1} ${x.seatId!==seat.id ? `ï¼ˆåˆç®—å¸­ï¼‰` : ``}
        </div>
      </div>
      <button class="listBtn" data-minus="${escapeHtml(o.id)}">ï¼</button>
      <button class="listBtn" data-plus="${escapeHtml(o.id)}">ï¼‹</button>
    `;
    orderList.appendChild(row);

    row.querySelector(`[data-minus="${o.id}"]`).onclick = ()=>{
      // å®Ÿä½“ã®å¸­ã‚’æ¢ã—ã¦æ•°é‡å¤‰æ›´
      const host = state.seats.find(s=> (s.orders||[]).some(z=> z.id===o.id));
      if(!host) return;
      const ref = host.orders.find(z=> z.id===o.id);
      ref.qty = Math.max(0, (ref.qty||1) - 1);
      if(ref.qty===0){
        host.orders = host.orders.filter(z=> z.id!==o.id);
      }
      save();
      renderOrder();
    };
    row.querySelector(`[data-plus="${o.id}"]`).onclick = ()=>{
      const host = state.seats.find(s=> (s.orders||[]).some(z=> z.id===o.id));
      if(!host) return;
      const ref = host.orders.find(z=> z.id===o.id);
      ref.qty = Math.min(999, (ref.qty||1) + 1);
      save();
      renderOrder();
    };
  }
}

/* =========================
  ä¼šè¨ˆ
========================= */
const coSeatLabel = document.getElementById("coSeatLabel");
const coPeople = document.getElementById("coPeople");
const coTotal = document.getElementById("coTotal");
const checkoutOrderList = document.getElementById("checkoutOrderList");
const payBtns = Array.from(document.querySelectorAll(".payBtn"));

payBtns.forEach(b=>{
  b.onclick = ()=>{
    payBtns.forEach(x=> x.classList.remove("selected"));
    b.classList.add("selected");
    state.ui.pay = b.dataset.pay;
    save();
  };
});

document.getElementById("warikanBtn").onclick = ()=>{
  const seat = state.seats.find(s=> s.id===state.ui.orderSeatId);
  if(!seat) return;
  const people = seat.party?.people || 0;
  if(!people){
    openModal({ title:"äººæ•°ãŒã‚ã‚Šã¾ã›ã‚“", sub:"æ¥åº—å…¥åŠ›ã§äººæ•°ã‚’å…¥ã‚Œã¦ãã ã•ã„", yesText:"OK" });
    return;
  }
  const total = seatTotal(seat);
  const per = Math.ceil(total / people);
  openModal({
    title:"å‰²ã‚Šå‹˜",
    sub:`${people}å / 1äººã‚ãŸã‚Šï¼ˆåˆ‡ã‚Šä¸Šã’ï¼‰`,
    bodyHtml:`<div class="yen" style="font-size:1.6rem; font-weight:950;">${yen(per)}</div>`,
    yesText:"OK"
  });
};

function renderCheckout(){
  const seat = state.seats.find(s=> s.id===state.ui.orderSeatId);
  if(!seat){
    go("main");
    return;
  }

  coSeatLabel.textContent = seat.label || "å¸­";
  coPeople.textContent = seat.party?.people ? `${seat.party.people}å` : "";
  coTotal.textContent = `åˆè¨ˆ ${yen(seatTotal(seat))}`;

  // æ”¯æ‰•ã„ãƒœã‚¿ãƒ³ãƒã‚¤ãƒ©ã‚¤ãƒˆ
  payBtns.forEach(x=> x.classList.toggle("selected", x.dataset.pay===state.ui.pay));

  // æ³¨æ–‡ä¸€è¦§ï¼ˆä¿®æ­£ï¼‰
  checkoutOrderList.innerHTML = "";
  const ids = [seat.id, ...state.seats.filter(s=> s.mergedInto===seat.id).map(s=> s.id)];
  const all = [];
  for(const sid of ids){
    const s = state.seats.find(x=> x.id===sid);
    if(!s) continue;
    for(const o of (s.orders||[])) all.push({sid, o});
  }

  if(!all.length){
    checkoutOrderList.innerHTML = `<div class="muted2" style="padding:12px;">æ³¨æ–‡ãŒã‚ã‚Šã¾ã›ã‚“</div>`;
    return;
  }

  // ã¾ã¨ã‚ï¼šåŒã˜å•†å“ã¯åˆç®—è¡¨ç¤ºï¼ˆç„¡æ–™ç‰ˆï¼‰
  const map = new Map();
  for(const x of all){
    const k = normalizeKey(x.o.name) + "::" + (x.o.price||0);
    if(!map.has(k)) map.set(k, {name:x.o.name, price:x.o.price, qty:0, ids:[]});
    const v = map.get(k);
    v.qty += (x.o.qty||1);
    v.ids.push({sid:x.sid, oid:x.o.id});
  }
  const items = Array.from(map.values()).sort((a,b)=> (a.name||"").localeCompare((b.name||""), "ja", {sensitivity:"base"}));

  for(const it of items){
    const row = document.createElement("div");
    row.className = "listRow";
    row.innerHTML = `
      <div>
        <div class="listName">${escapeHtml(it.name)}</div>
        <div class="muted2" style="font-size:.88rem; font-weight:800;">${yen(it.price)} / Ã—${it.qty}</div>
      </div>
      <button class="listBtn" data-minus="${escapeHtml(it.name)}">ï¼</button>
      <button class="listBtn" data-plus="${escapeHtml(it.name)}">ï¼‹</button>
    `;
    checkoutOrderList.appendChild(row);

    const applyDelta = (delta)=>{
      // ç°¡æ˜“ï¼šidsé †ã« qtyã‚’å¢—æ¸›
      let remain = Math.abs(delta);
      if(delta<0){
        for(const ref of it.ids){
          if(remain<=0) break;
          const host = state.seats.find(s=> (s.orders||[]).some(z=> z.id===ref.oid));
          if(!host) continue;
          const o = host.orders.find(z=> z.id===ref.oid);
          if(!o) continue;
          if((o.qty||1) > 0){
            o.qty = Math.max(0, (o.qty||1)-1);
            remain--;
            if(o.qty===0) host.orders = host.orders.filter(z=> z.id!==o.id);
          }
        }
      }else{
        // å¢—ã‚„ã™ï¼šæœ€åˆã®æ³¨æ–‡ã«è¶³ã™ï¼ˆãªã‘ã‚Œã°ä½œã‚Šç›´ã—ã¯ã—ãªã„ï¼‰
        const first = it.ids[0];
        const host = state.seats.find(s=> (s.orders||[]).some(z=> z.id===first.oid));
        if(host){
          const o = host.orders.find(z=> z.id===first.oid);
          if(o) o.qty = Math.min(999, (o.qty||1)+1);
        }
      }
      save();
      renderCheckout();
    };

    row.querySelector(`[data-minus="${it.name}"]`).onclick = ()=> applyDelta(-1);
    row.querySelector(`[data-plus="${it.name}"]`).onclick = ()=> applyDelta(1);
  }
}

/* ä¼šè¨ˆç¢ºå®š */
document.getElementById("confirmCheckout").onclick = ()=>{
  const seat = state.seats.find(s=> s.id===state.ui.orderSeatId);
  if(!seat) return;

  const baseId = seat.id;
  const mergeIds = state.seats.filter(s=> s.mergedInto===baseId).map(s=> s.id);
  const ids = [baseId, ...mergeIds];

  // åˆè¨ˆï¼ˆãƒ™ãƒ¼ã‚¹ã¸é›†è¨ˆï¼‰
  let total = 0;
  const allOrders = [];
  for(const sid of ids){
    const s = state.seats.find(x=> x.id===sid);
    if(!s) continue;
    for(const o of (s.orders||[])){
      total += (o.price||0) * (o.qty||1);
      allOrders.push({...o});
    }
  }

  if(total<=0){
    openModal({ title:"æ³¨æ–‡ãŒã‚ã‚Šã¾ã›ã‚“", sub:"", yesText:"OK" });
    return;
  }

  openModal({
    title:"ä¼šè¨ˆã‚’ç¢ºå®šã—ã¾ã™ã‹ï¼Ÿ",
    sub:`æ”¯æ‰•ã„ï¼š${state.ui.pay==="cash"?"ç¾é‡‘":state.ui.pay==="card"?"ã‚«ãƒ¼ãƒ‰":"QR/é›»å­æ±ºæ¸ˆ"} / åˆè¨ˆ ${yen(total)}`,
    yesText:"ç¢ºå®š",
    noText:"æˆ»ã‚‹",
    onYes: ()=>{
      // å£²ä¸Šä¼ç¥¨ã‚’ä½œæˆ
      const ts = nowTs();
      const sale = {
        id: "SL"+ts+"_"+Math.random().toString(16).slice(2),
        at: ts,
        seatLabel: seat.label || "",
        pay: state.ui.pay || "cash",
        total,
        items: allOrders.map(o=> ({name:o.name, price:o.price, qty:o.qty||1, tax:o.tax||10})),
        type: "sale"
      };
      state.sales.push(sale);

      // å¸­ã‚’ç©ºå¸­ã¸ï¼ˆåˆç®—å¸­ã‚‚å«ã‚€ï¼‰
      for(const sid of ids){
        const s = state.seats.find(x=> x.id===sid);
        if(!s) continue;
        s.status="empty";
        s.party=null;
        s.openedAt=null;
        s.orders=[];
        s.mergedInto=null;
      }

      // ä»–ã®å¸­ãŒbaseã¸åˆç®—ã•ã‚Œã¦ã„ãŸå ´åˆã‚‚å¿µã®ãŸã‚è§£é™¤
      state.seats.forEach(s=>{ if(s.mergedInto===baseId) s.mergedInto=null; });

      save();
      closeModal();
      state.ui.opSelected = null;
      state.ui.selectedSeatIds = [];
      save();
      go("main");
    }
  });
};

/* =========================
  ã‚­ãƒƒãƒãƒ³
========================= */
const kList = document.getElementById("kList");
const kFoodTab = document.getElementById("kFoodTab");
const kDrinkTab = document.getElementById("kDrinkTab");

document.getElementById("kRefresh").onclick = ()=> renderKitchen();

kFoodTab.onclick = ()=>{
  state.ui.kitchenTab = "food";
  save();
  renderKitchen();
};
kDrinkTab.onclick = ()=>{
  state.ui.kitchenTab = "drink";
  save();
  renderKitchen();
};

function renderKitchen(){
  kFoodTab.classList.toggle("selected", state.ui.kitchenTab==="food");
  kDrinkTab.classList.toggle("selected", state.ui.kitchenTab==="drink");

  const tab = state.ui.kitchenTab || "food";
  kList.innerHTML = "";

  // é›†è¨ˆï¼šå¸­å…¨ä½“ã‹ã‚‰ã€Œæœªå®Œäº†ã€ã‚’æŠ½å‡º
  const all = [];
  for(const s of state.seats){
    if(s.mergedInto) continue;
    for(const o of (s.orders||[])){
      // æ–™ç†/ãƒ‰ãƒªãƒ³ã‚¯ã§åˆ†é¡
      const cat = (o.category||"food")==="drink" ? "drink" : "food";
      if(cat!==tab) continue;
      all.push({
        seatLabel: s.label||"",
        at: o.at||0,
        name: o.name||"",
        qty: o.qty||1,
        promoted: !!o.promoted,
        oid: o.id
      });
    }
  }

  if(!all.length){
    kList.innerHTML = `<div class="muted2">æœªæä¾›ãŒã‚ã‚Šã¾ã›ã‚“</div>`;
    return;
  }

  if(tab==="drink"){
    // ãƒ‰ãƒªãƒ³ã‚¯ï¼šã¾ã¨ã‚ãªã„
    all.sort((a,b)=> (a.at||0)-(b.at||0));
    for(const x of all){
      const card = document.createElement("div");
      card.className="kCard";
      card.innerHTML = `
        <div>
          <div class="kName">${escapeHtml(x.name)}</div>
          <div class="kMeta">
            <span class="kSeat">${escapeHtml(x.seatLabel)}</span>
            <span class="kTime">${escapeHtml(fmtTime(x.at))}</span>
          </div>
        </div>
        <div class="kQty">Ã—${x.qty}</div>
      `;
      kList.appendChild(card);
    }
    return;
  }

  // æ–™ç†ï¼šåŒä¸€æ–™ç†ã¯ä¸‹ã«ã¶ã‚‰ä¸‹ã’ï¼ˆæ˜‡æ ¼ã—ãŸå´ã®ã¿è‰²ï¼‰
  const group = new Map();
  for(const x of all){
    const key = normalizeKey(x.name);
    if(!group.has(key)) group.set(key, []);
    group.get(key).push(x);
  }

  const groups = Array.from(group.values());
  // æ˜‡æ ¼ï¼ˆèµ¤ï¼‰â†’å¤ã„é †ï¼ˆæœªå®Ÿè£…ã®èµ¤åˆ¤å®šã¯ç°¡æ˜“ï¼š15åˆ†ä»¥ä¸Šã§èµ¤ï¼‰
  const now = nowTs();
  const isOverdue = (t)=> (now - t) > (15*60*1000);

  groups.sort((ga,gb)=>{
    const ta = Math.min(...ga.map(x=> x.at||0));
    const tb = Math.min(...gb.map(x=> x.at||0));
    return ta - tb;
  });

  for(const arr of groups){
    arr.sort((a,b)=> (a.at||0)-(b.at||0));
    const head = arr[0];
    const totalQty = arr.reduce((s,x)=> s+(x.qty||1), 0);

    const card = document.createElement("div");
    card.className="kCard";
    if(head.promoted) card.classList.add("promoted");
    if(isOverdue(head.at)) card.classList.add("overdue");

    const subs = arr.slice(1).map(x=>{
      return `
        <div class="kSubItem">
          <div class="kSubLeft">
            <span class="kSeat">${escapeHtml(x.seatLabel)}</span>
            <span class="kTime">${escapeHtml(fmtTime(x.at))}</span>
          </div>
          <div class="kQty">Ã—${x.qty}</div>
        </div>
      `;
    }).join("");

    card.innerHTML = `
      <div>
        <div class="kName">${escapeHtml(head.name)}</div>
        <div class="kMeta">
          <span class="kSeat">${escapeHtml(head.seatLabel)}</span>
          <span class="kTime">${escapeHtml(fmtTime(head.at))}</span>
          ${head.promoted ? `<span class="tagFix">æ˜‡æ ¼</span>` : ``}
          ${isOverdue(head.at) ? `<span class="tagFix" style="border-color:rgba(255,87,87,.45); background:rgba(255,87,87,.10);">é…ã„</span>` : ``}
        </div>
        ${subs ? `<div class="kSubLine">${subs}</div>` : ``}
      </div>
      <div class="kQty">Ã—${totalQty}</div>
    `;
    kList.appendChild(card);
  }
}

/* =========================
  å£²ä¸Šï¼ˆæœ¬æ—¥ / æœˆ / å¹´ / ç®¡ç†ï¼‰
  + è¨‚æ­£ä¼ç¥¨æ–¹å¼ï¼ˆæ–¹å¼1ï¼‰
========================= */
document.getElementById("goTodaySales").onclick = ()=> go("todaySales");
document.getElementById("goMonthSales").onclick = ()=> go("month");
document.getElementById("goYearSales").onclick = ()=> go("year");
document.getElementById("goSalesManage").onclick = ()=> go("manage");

document.getElementById("todayToSales").onclick = ()=> go("sales");
document.getElementById("monthToSales").onclick = ()=> go("sales");
document.getElementById("yearToSales").onclick = ()=> go("sales");
document.getElementById("manageToSales").onclick = ()=> go("sales");

function sameDay(tsA, tsB){
  const a = new Date(tsA), b = new Date(tsB);
  return a.getFullYear()===b.getFullYear() && a.getMonth()===b.getMonth() && a.getDate()===b.getDate();
}

function applyFixesToSales(){
  // æ–¹å¼1ï¼šè¨‚æ­£ä¼ç¥¨ï¼ˆåŠ ç®—/æ¸›ç®—ï¼‰ã‚’ sales ã«ã¶ã‚‰ä¸‹ã’ã¦é›†è¨ˆã«åæ˜ ã•ã›ã‚‹
  // freeç‰ˆï¼šsalesFix ã¯ {targetSaleId, deltaTotal, reason, at}
  const fixById = new Map();
  for(const f of (state.salesFix||[])){
    if(!fixById.has(f.targetSaleId)) fixById.set(f.targetSaleId, []);
    fixById.get(f.targetSaleId).push(f);
  }
  return {fixById};
}

function renderTodaySales(){
  const todaySalesList = document.getElementById("todaySalesList");
  const todayTotal = document.getElementById("todayTotal");
  const todayCount = document.getElementById("todayCount");

  const {fixById} = applyFixesToSales();
  const today = nowTs();
  const list = state.sales.filter(s=> sameDay(s.at, today));

  let sum = 0;
  for(const s of list){
    let t = s.total||0;
    const fixes = fixById.get(s.id)||[];
    for(const f of fixes) t += (f.deltaTotal||0);
    sum += t;
  }

  todayTotal.textContent = `åˆè¨ˆ ${yen(sum)}`;
  todayCount.textContent = `${list.length}ä»¶`;

  todaySalesList.innerHTML = "";
  const box = document.createElement("div");
  box.className = "listBox";
  box.innerHTML = `<div class="listHead"><span>ä¼ç¥¨ä¸€è¦§</span><span class="muted2">æ–¹å¼1ï¼ˆè¨‚æ­£ä¼ç¥¨ï¼‰å¯¾å¿œ</span></div>`;
  todaySalesList.appendChild(box);

  if(!list.length){
    const d = document.createElement("div");
    d.className = "muted2";
    d.style.padding = "12px";
    d.textContent = "æœ¬æ—¥ã®å£²ä¸Šã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“";
    box.appendChild(d);
    return;
  }

  for(const s of [...list].sort((a,b)=> (b.at||0)-(a.at||0))){
    const fixes = fixById.get(s.id)||[];
    const fixedSum = (s.total||0) + fixes.reduce((a,f)=> a+(f.deltaTotal||0),0);

    const row = document.createElement("div");
    row.className = "saleRow";
    row.innerHTML = `
      <div class="saleTop">
        <div>
          <div class="saleTitle">
            ${escapeHtml(fmtTime(s.at))} / ${escapeHtml(s.pay==="cash"?"ç¾é‡‘":s.pay==="card"?"ã‚«ãƒ¼ãƒ‰":"QR/é›»å­æ±ºæ¸ˆ")}
            ${fixes.length ? ` <span class="tagFix">è¨‚æ­£ ${fixes.length}</span>` : ``}
          </div>
          <div class="saleMeta">
            <span>åˆè¨ˆ ${yen(fixedSum)}</span>
            <span class="muted2">ï¼ˆå…ƒï¼š${yen(s.total||0)}ï¼‰</span>
          </div>
        </div>
        <div class="saleBtns">
          <button class="btnSmall" data-detail="${s.id}">è©³ç´°</button>
          <button class="btnSmall btnDanger" data-fix="${s.id}">ä¿®æ­£</button>
        </div>
      </div>
    `;
    box.appendChild(row);
  }

  box.querySelectorAll("[data-detail]").forEach(btn=>{
    btn.onclick = ()=>{
      const id = btn.getAttribute("data-detail");
      const s = state.sales.find(x=> x.id===id);
      if(!s) return;
      openSaleDetail(s);
    };
  });

  box.querySelectorAll("[data-fix]").forEach(btn=>{
    btn.onclick = ()=>{
      const id = btn.getAttribute("data-fix");
      const s = state.sales.find(x=> x.id===id);
      if(!s) return;
      openFixSlip(s);
    };
  });
}

function openSaleDetail(s){
  const {fixById} = applyFixesToSales();
  const fixes = fixById.get(s.id)||[];
  const fixedSum = (s.total||0) + fixes.reduce((a,f)=> a+(f.deltaTotal||0),0);

  const itemsHtml = (s.items||[]).map(it=>{
    return `<div class="muted2" style="display:flex; justify-content:space-between; gap:10px;">
      <span>${escapeHtml(it.name)} Ã—${it.qty}</span><span>${yen((it.price||0)*(it.qty||1))}</span>
    </div>`;
  }).join("");

  const fixHtml = fixes.length ? `
    <div class="hr"></div>
    <div class="muted2" style="font-weight:950;">è¨‚æ­£ä¼ç¥¨</div>
    ${fixes.map(f=>`
      <div class="muted2" style="display:flex; justify-content:space-between; gap:10px;">
        <span>${escapeHtml(fmtTime(f.at))} / ${escapeHtml(f.reason||"è¨‚æ­£")}</span>
        <span class="${(f.deltaTotal||0)<0 ? "warnText" : ""}">${(f.deltaTotal||0)<0 ? "-" : "+"}${yen(Math.abs(f.deltaTotal||0))}</span>
      </div>
    `).join("")}
  ` : "";

  openModal({
    title:"ä¼ç¥¨è©³ç´°",
    sub:`${escapeHtml(fmtTime(s.at))} / ${escapeHtml(s.pay==="cash"?"ç¾é‡‘":s.pay==="card"?"ã‚«ãƒ¼ãƒ‰":"QR/é›»å­æ±ºæ¸ˆ")}`,
    bodyHtml: `
      <div class="muted2" style="font-weight:950;">åˆè¨ˆ</div>
      <div class="yen" style="font-size:1.5rem; font-weight:950;">${yen(fixedSum)}</div>
      <div class="muted2">ï¼ˆå…ƒï¼š${yen(s.total||0)}ï¼‰</div>
      <div class="hr"></div>
      <div class="muted2" style="font-weight:950;">å†…è¨³</div>
      ${itemsHtml || `<div class="muted2">ï¼ˆå†…è¨³ãªã—ï¼‰</div>`}
      ${fixHtml}
    `,
    yesText:"OK"
  });
}

function openFixSlip(s){
  openModal({
    title:"ä¿®æ­£ï¼ˆè¨‚æ­£ä¼ç¥¨ï¼‰",
    sub:"æ–¹å¼1ï¼šå…ƒã®ä¼ç¥¨ã¯å¤‰æ›´ã›ãšã€è¨‚æ­£ä¼ç¥¨ã‚’è¿½åŠ ã—ã¾ã™",
    bodyHtml: `
      <div class="muted2">ä¿®æ­£é¡ï¼ˆÂ±ï¼‰</div>
      <input id="fixDelta" class="numField" type="number" inputmode="numeric" placeholder="-100 ãªã©" />
      <div style="height:10px;"></div>
      <div class="muted2">ç†ç”±ï¼ˆä»»æ„ï¼‰</div>
      <input id="fixReason" type="text" placeholder="ä¾‹ï¼šå€¤å¼•ã/è¿”å“/å…¥åŠ›ãƒŸã‚¹è¨‚æ­£" />
      <div class="muted2" style="margin-top:10px; font-size:.92rem;">
        â€» ã“ã“ã§å…¥åŠ›ã—ãŸé‡‘é¡ãŒã€é›†è¨ˆã«ãã®ã¾ã¾åæ˜ ã•ã‚Œã¾ã™
      </div>
    `,
    yesText:"è¿½åŠ ã™ã‚‹",
    noText:"æˆ»ã‚‹",
    onYes: ()=>{
      const delta = parseInt(document.getElementById("fixDelta").value||"0",10);
      const reason = (document.getElementById("fixReason").value||"").trim() || "è¨‚æ­£";
      if(!delta){
        openModal({ title:"ä¿®æ­£é¡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„", sub:"0ã¯è¿½åŠ ã§ãã¾ã›ã‚“", yesText:"OK" });
        return;
      }
      state.salesFix.push({
        id: "FX"+nowTs()+"_"+Math.random().toString(16).slice(2),
        targetSaleId: s.id,
        deltaTotal: delta,
        reason,
        at: nowTs(),
        type:"fix"
      });
      save();
      closeModal();
      renderTodaySales();
    }
  });
}

function monthKey(ts){
  const d = new Date(ts);
  return `${d.getFullYear()}-${pad2(d.getMonth()+1)}`;
}
function yearKey(ts){
  const d = new Date(ts);
  return `${d.getFullYear()}`;
}

function calcAggByPeriod(getKey){
  const {fixById} = applyFixesToSales();
  const agg = new Map();
  for(const s of state.sales){
    const k = getKey(s.at);
    let t = s.total||0;
    const fixes = fixById.get(s.id)||[];
    for(const f of fixes) t += (f.deltaTotal||0);
    agg.set(k, (agg.get(k)||0) + t);
  }
  const keys = Array.from(agg.keys()).sort((a,b)=> a.localeCompare(b));
  return keys.map(k=> ({k, total: agg.get(k)||0}));
}

function renderMonthSales(){
  const box = document.getElementById("monthSalesBox");
  const list = calcAggByPeriod(monthKey);

  if(!list.length){
    box.innerHTML = `æœˆå£²ä¸Šã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“`;
    return;
  }

  box.innerHTML = list.map(x=> `
    <div class="listRow">
      <div class="listName">${escapeHtml(x.k)}</div>
      <div class="listMeta">${yen(x.total)}</div>
      <div></div>
    </div>
  `).join("");
}

function renderYearSales(){
  const box = document.getElementById("yearSalesBox");
  const list = calcAggByPeriod(yearKey);

  if(!list.length){
    box.innerHTML = `å¹´å£²ä¸Šã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“`;
    return;
  }

  box.innerHTML = list.map(x=> `
    <div class="listRow">
      <div class="listName">${escapeHtml(x.k)}å¹´</div>
      <div class="listMeta">${yen(x.total)}</div>
      <div></div>
    </div>
  `).join("");
}

/* =========================
  å£²ä¸Šç®¡ç†ï¼šCSVå‡ºåŠ›ï¼ˆæ¨å¥¨ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆï¼‰
  + å£²ä¸Šãƒ‡ãƒ¼ã‚¿åˆæœŸåŒ–ï¼ˆ2æ®µéšï¼‹ã‚¹ãƒ©ã‚¤ãƒ‰ï¼‰
========================= */
const salesLog = document.getElementById("salesLog");

function renderSales(){
  // ç”»é¢ã®ã¿
}
function renderSalesManage(){
  salesLog.innerHTML = `
    <div class="muted2">
      ãƒ»CSVå‡ºåŠ›ï¼šç„¡æ–™ç‰ˆã¯ã€Œæ¨å¥¨ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã€ã¨ã—ã¦å‡ºåŠ›ã—ã¾ã™ï¼ˆè‡ªå‹•å–è¾¼ã¯ä¿è¨¼ã—ãªã„ï¼‰<br>
      ãƒ»åˆæœŸåŒ–ï¼šå£²ä¸Šãƒ‡ãƒ¼ã‚¿ã®ã¿ï¼ˆå¸­/ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã¯å¯¾è±¡å¤–ï¼‰
    </div>
  `;
}

/* CSVå‡ºåŠ›ï¼šæ¨å¥¨ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆï¼ˆæ±ç”¨/å¼¥ç”Ÿ/freee/ãƒãƒãƒ•ã‚©ã®ä¸¦ã³æ›¿ãˆï¼†ã‚¿ã‚¤ãƒˆãƒ«å¤‰æ›´ï¼‰ */
document.getElementById("exportCsv").onclick = ()=>{
  openModal({
    title:"CSVå‡ºåŠ›ï¼ˆæ¨å¥¨ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆï¼‰",
    sub:"å–ã‚Šè¾¼ã¿æ™‚ã«å®Œå…¨ä¸€è‡´ãŒå¿…è¦ãªå ´åˆãŒã‚ã‚‹ãŸã‚ã€ç„¡æ–™ç‰ˆã¯ã€Œæ¨å¥¨ã€ã¨ã—ã¦å‡ºã—ã¾ã™",
    bodyHtml: `
      <div class="btnRow" style="margin-bottom:10px;">
        <button class="btnPrimary" id="csvGeneral">æ±ç”¨ï¼ˆç¨ç†å£«å‘ã‘ï¼‰</button>
        <button class="btnPrimary" id="csvYayoi">å¼¥ç”Ÿï¼ˆæ¨å¥¨ï¼‰</button>
      </div>
      <div class="btnRow">
        <button class="btnPrimary" id="csvFreee">freeeï¼ˆæ¨å¥¨ï¼‰</button>
        <button class="btnPrimary" id="csvMF">ãƒãƒãƒ¼ãƒ•ã‚©ãƒ¯ãƒ¼ãƒ‰ï¼ˆæ¨å¥¨ï¼‰</button>
      </div>
      <div class="muted2" style="margin-top:10px; font-size:.92rem;">
        â€» ç„¡æ–™ç‰ˆã¯ã€Œè‡ªå‹•å–è¾¼å®Œå…¨ä¸€è‡´ã€ã‚’ä¿è¨¼ã—ã¾ã›ã‚“ã€‚<br>
        â€» ã¾ãšã¯ç¨ç†å£«å‘ã‘ï¼ˆæ±ç”¨ï¼‰ãŒãŠã™ã™ã‚ã§ã™ã€‚
      </div>
    `,
    yesText:"æˆ»ã‚‹",
    onYes: ()=> closeModal()
  });

  setTimeout(()=>{
    const run = (mode)=>{
      closeModal();
      exportCsv(mode);
    };
    document.getElementById("csvGeneral").onclick = ()=> run("general");
    document.getElementById("csvYayoi").onclick = ()=> run("yayoi");
    document.getElementById("csvFreee").onclick = ()=> run("freee");
    document.getElementById("csvMF").onclick = ()=> run("mf");
  },0);
};

function csvEscape(v){
  const s = String(v??"");
  if(/[,"\n]/.test(s)) return `"${s.replaceAll('"','""')}"`;
  return s;
}

function exportCsv(mode){
  // æ–¹å¼1åæ˜ å¾Œã®é‡‘é¡ã§å‡ºã™
  const {fixById} = applyFixesToSales();

  // åŸºæœ¬ãƒ‡ãƒ¼ã‚¿ï¼ˆå…±é€šï¼‰
  const rows = [];
  for(const s of [...state.sales].sort((a,b)=> (a.at||0)-(b.at||0))){
    let total = s.total||0;
    const fixes = fixById.get(s.id)||[];
    for(const f of fixes) total += (f.deltaTotal||0);

    const d = new Date(s.at);
    const date = `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
    const time = `${pad2(d.getHours())}:${pad2(d.getMinutes())}`;
    const pay = s.pay==="cash"?"ç¾é‡‘":s.pay==="card"?"ã‚«ãƒ¼ãƒ‰":"QR";
    const note = fixes.length ? `è¨‚æ­£${fixes.length}ä»¶` : "";

    rows.push({date, time, pay, total, note});
  }

  if(!rows.length){
    openModal({ title:"å£²ä¸ŠãŒã‚ã‚Šã¾ã›ã‚“", sub:"CSVå‡ºåŠ›ã§ãã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“", yesText:"OK" });
    return;
  }

  // ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆï¼ˆç„¡æ–™ç‰ˆã¯ã€Œæ¨å¥¨ã€ãƒ¬ãƒ™ãƒ«ã§ä¸¦ã³æ›¿ãˆï¼†ãƒ˜ãƒƒãƒ€å¤‰æ›´ï¼‰
  let header = [];
  let body = [];

  if(mode==="general"){
    header = ["æ—¥ä»˜","æ™‚åˆ»","æ”¯æ‰•æ–¹æ³•","é‡‘é¡","å‚™è€ƒ"];
    body = rows.map(r=> [r.date, r.time, r.pay, r.total, r.note]);
  }else if(mode==="yayoi"){
    header = ["å–å¼•æ—¥","é‡‘é¡","æ‘˜è¦","æ”¯æ‰•æ–¹æ³•","æ™‚åˆ»"];
    body = rows.map(r=> [r.date, r.total, "å£²ä¸Šï¼ˆæ¨å¥¨ï¼‰"+(r.note?` / ${r.note}`:""), r.pay, r.time]);
  }else if(mode==="freee"){
    header = ["æ—¥ä»˜","é‡‘é¡","å†…å®¹","æ±ºæ¸ˆæ–¹æ³•","å‚™è€ƒ"];
    body = rows.map(r=> [r.date, r.total, "å£²ä¸Šï¼ˆæ¨å¥¨ï¼‰", r.pay, r.note]);
  }else{
    // mf
    header = ["æ—¥ä»˜","å†…å®¹","é‡‘é¡","æ”¯æ‰•æ–¹æ³•","å‚™è€ƒ"];
    body = rows.map(r=> [r.date, "å£²ä¸Šï¼ˆæ¨å¥¨ï¼‰", r.total, r.pay, r.note]);
  }

  const csv = [header, ...body].map(line=> line.map(csvEscape).join(",")).join("\n");

  // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ï¼ˆiPhoneå¯¾å¿œï¼šBlobâ†’a.clickï¼‰
  const blob = new Blob([csv], {type:"text/csv;charset=utf-8"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  const fname = `ONE_sales_${mode}_${Date.now()}.csv`;
  a.download = fname;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);

  openModal({
    title:"CSVã‚’å‡ºåŠ›ã—ã¾ã—ãŸ",
    sub:`ãƒ•ã‚¡ã‚¤ãƒ«åï¼š${fname}`,
    yesText:"OK"
  });
}

/* å£²ä¸Šãƒ‡ãƒ¼ã‚¿ã®åˆæœŸåŒ–ï¼ˆå£²ä¸Šã®ã¿ï¼‰ */
document.getElementById("initSalesBtn").onclick = ()=>{
  // â‘¡ æ³¨æ„æ–‡ï¼‹åŒæ„ã¸
  openModal({
    title:"å£²ä¸Šãƒ‡ãƒ¼ã‚¿ã®åˆæœŸåŒ–",
    sub:"å£²ä¸Šãƒ‡ãƒ¼ã‚¿ã‚’åˆæœŸåŒ–ã™ã‚‹ã¨å…ƒã«æˆ»ã™ã“ã¨ã¯å‡ºæ¥ã¾ã›ã‚“ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ",
    yesText:"åŒæ„ã™ã‚‹",
    noText:"æˆ»ã‚‹",
    onYes: ()=>{
      closeModal();
      // â‘¢ æœ€çµ‚ç”»é¢ï¼ˆæˆ»ã‚‹ï¼‹ã‚¹ãƒ©ã‚¤ãƒ‰ï¼‰
      openModal({
        title:"åˆæœŸåŒ–ã‚’å®Ÿè¡Œã—ã¾ã™",
        sub:"æˆ»ã‚‹ / ã‚¹ãƒ©ã‚¤ãƒ‰ã§å£²ä¸Šãƒ‡ãƒ¼ã‚¿åˆæœŸåŒ–",
        bodyHtml: `
          <div class="muted2" style="font-weight:900; margin-bottom:10px;">æœ€çµ‚ç¢ºèª</div>
          <div class="muted2">å£²ä¸Šãƒ‡ãƒ¼ã‚¿ã®ã¿åˆæœŸåŒ–ã—ã¾ã™ï¼ˆå¸­/ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã¯æ®‹ã‚Šã¾ã™ï¼‰</div>
          <div style="height:12px;"></div>
          <div class="slider" id="salesInitSlider">
            <div class="sliderTrack">ã‚¹ãƒ©ã‚¤ãƒ‰ã§å£²ä¸Šãƒ‡ãƒ¼ã‚¿åˆæœŸåŒ–</div>
            <div class="sliderKnob" id="salesInitKnob">â–¶ï¸</div>
          </div>
        `,
        yesText:"æˆ»ã‚‹",
        yesClass:"",
        onYes: ()=>{ closeModal(); go("manage"); }
      });

      setTimeout(()=>{
        const slider = document.getElementById("salesInitSlider");
        const knob = document.getElementById("salesInitKnob");
        if(!slider || !knob) return;

        let dragging=false, startX=0, startLeft=2;
        const maxLeft = slider.clientWidth - knob.clientWidth - 2;

        const setLeft=(x)=>{
          const left = Math.max(2, Math.min(maxLeft, x));
          knob.style.left = left+"px";
          return left;
        };

        const onDown=(e)=>{
          dragging=true;
          startX = (e.touches?e.touches[0].clientX:e.clientX);
          startLeft = parseFloat(getComputedStyle(knob).left)||2;
          e.preventDefault();
        };
        const onMove=(e)=>{
          if(!dragging) return;
          const x = (e.touches?e.touches[0].clientX:e.clientX);
          setLeft(startLeft + (x-startX));
          e.preventDefault();
        };
        const onUp=()=>{
          if(!dragging) return;
          dragging=false;
          const left = parseFloat(getComputedStyle(knob).left)||2;
          if(left >= maxLeft-2){
            // å®Ÿè¡Œ
            state.sales = [];
            state.salesFix = [];
            save();
            closeModal();
            go("manage");
            openModal({ title:"åˆæœŸåŒ–ã—ã¾ã—ãŸ", sub:"å£²ä¸Šãƒ‡ãƒ¼ã‚¿ã‚’åˆæœŸåŒ–ã—ã¾ã—ãŸ", yesText:"OK" });
          }else{
            knob.style.left="2px";
          }
        };

        knob.addEventListener("mousedown", onDown);
        knob.addEventListener("touchstart", onDown, {passive:false});
        window.addEventListener("mousemove", onMove, {passive:false});
        window.addEventListener("touchmove", onMove, {passive:false});
        window.addEventListener("mouseup", onUp);
        window.addEventListener("touchend", onUp);
      },0);
    }
  });
};

/* =========================
  åº—èˆ—æƒ…å ±
========================= */
function renderStoreInfo(){
  const s = state.store || {};
  document.getElementById("stName").value = s.name || "";
  document.getElementById("stPhone").value = s.phone || "";
  document.getElementById("stAddr").value = s.addr || "";
}
document.getElementById("saveStoreInfo").onclick = ()=>{
  state.store = {
    name: (document.getElementById("stName").value||"").trim(),
    phone: (document.getElementById("stPhone").value||"").trim(),
    addr: (document.getElementById("stAddr").value||"").trim()
  };
  save();
  openModal({ title:"ä¿å­˜ã—ã¾ã—ãŸ", sub:"", yesText:"OK" });
};

/* =========================
  åˆå›ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
========================= */
function renderSeatRegisterPreview(){
  // åç§°ã”ã¨ã«ã¾ã¨ã‚ã‚‹ï¼ˆç°¡æ˜“ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼‰
  const wrap = document.getElementById("seatPreviewGrouped");
  if(!wrap) return;
  wrap.innerHTML = "";

  const groups = new Map();
  for(const s of state.seats){
    const key = s.typeName || typeToName(s.type) || "æœªåˆ†é¡";
    if(!groups.has(key)) groups.set(key, []);
    groups.get(key).push(s);
  }
  const keys = Array.from(groups.keys()).sort(jaSort);

  if(!keys.length){
    wrap.innerHTML = `<div class="muted2">ã¾ã å¸­ãŒã‚ã‚Šã¾ã›ã‚“</div>`;
    return;
  }

  for(const k of keys){
    const arr = groups.get(k);
    arr.sort((a,b)=> (a.label||"").localeCompare((b.label||""), "ja", {numeric:true, sensitivity:"base"}));

    const box = document.createElement("div");
    box.className = "listBox";
    box.innerHTML = `
      <div class="listHead">
        <span>${escapeHtml(k)}</span>
        <span class="muted2">${arr.length}ä»¶</span>
      </div>
      <div>
        ${arr.map(s=>`
          <div class="listRow">
            <div class="listName">${escapeHtml(s.label||"")}</div>
            <div class="listMeta">${escapeHtml(String(s.cap||""))}å</div>
            <div></div>
          </div>
        `).join("")}
      </div>
    `;
    wrap.appendChild(box);
  }
}

syncNetIcon();
syncDock();
syncTopCenter();
syncTopMainBtn();

go(state.ui.view || "main");
renderMain();
renderSeatRegisterPreview();
renderMenuRegister();
/* =========================
   FIX: å¸­ç™»éŒ²ã€Œåç§°ã€ãƒœã‚¿ãƒ³ãŒ state ã«åæ˜ ã•ã‚Œãªã„å•é¡Œ
   è¿½è¨˜ã™ã‚‹ã ã‘ã§å‹•ããƒ‘ãƒƒãƒ
========================= */
(function seatGroupFixPatch(){
  const GROUP_LABELS = ["ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼","ç«‹ã¡","ãƒ†ãƒ¼ãƒ–ãƒ«","åº§æ•·","å€‹å®¤","ãã®ä»–"];

  function ensureSeatForm(){
    if (!window.state) window.state = {};
    if (!state.seatForm) state.seatForm = {};
  }

  function findSeatRegRoot(){
    // ã§ãã‚‹ã ã‘åºƒãæ¢ã™ï¼ˆIDãŒé•ã£ã¦ã‚‚æ‹¾ãˆã‚‹ã‚ˆã†ã«ï¼‰
    return (
      document.getElementById("seatReg") ||
      document.querySelector('[data-view="seatReg"]') ||
      document.querySelector('[data-view="seatreg"]') ||
      document.querySelector("#view-seatReg") ||
      document.querySelector("#view-seatreg") ||
      document.body
    );
  }

  function pickGroupButtons(root){
    const btns = Array.from(root.querySelectorAll("button"));
    return btns.filter(b => GROUP_LABELS.includes((b.textContent || "").trim()));
  }

  function syncVisual(btns){
    const cur = ((state.seatForm && state.seatForm.group) || "").trim();
    btns.forEach(b => {
      const on = (b.textContent || "").trim() === cur;
      // æ—¢å­˜CSSã«å½±éŸ¿ã—ãªã„â€œè¿½åŠ ã‚¯ãƒ©ã‚¹â€ã ã‘ä»˜ã‘ã‚‹
      b.classList.toggle("seatGroupSelected", on);
      // ã‚ˆãã‚ã‚‹ã‚¯ãƒ©ã‚¹ã‚‚å¿µã®ãŸã‚åŒæœŸï¼ˆæ—¢å­˜ãŒä½¿ã£ã¦ãŸã‚‰åŠ¹ãï¼‰
      b.classList.toggle("active", on);
      b.classList.toggle("selected", on);
      b.setAttribute("aria-pressed", on ? "true" : "false");
    });
  }

  function wireOnce(){
    const root = findSeatRegRoot();
    const btns = pickGroupButtons(root);
    if (!btns.length) return false;

    // äºŒé‡ç™»éŒ²é˜²æ­¢
    if (root.__seatGroupFixWired) {
      // ç”»é¢å†æç”»ã«å‚™ãˆã¦è¦‹ãŸç›®ã ã‘åŒæœŸ
      try { ensureSeatForm(); syncVisual(btns); } catch(e){}
      return true;
    }
    root.__seatGroupFixWired = true;

    btns.forEach(btn => {
      btn.addEventListener("click", () => {
        // æ—¢å­˜ãƒãƒ³ãƒ‰ãƒ©ãŒèµ°ã£ãŸâ€œã‚ã¨â€ã« state ã‚’ç¢ºå®Ÿã«ä¸Šæ›¸ãã™ã‚‹
        setTimeout(() => {
          try {
            ensureSeatForm();
            const label = (btn.textContent || "").trim();
            const cur = (state.seatForm.group || "").trim();
            state.seatForm.group = (cur === label) ? "" : label; // ã‚‚ã†ä¸€åº¦æŠ¼ã—ãŸã‚‰è§£é™¤
            syncVisual(btns);
          } catch(e) {
            // ä½•ã‚‚ã—ãªã„ï¼ˆè½ã¡ãªã„ã®ãŒæœ€å„ªå…ˆï¼‰
          }
        }, 0);
      }, false);
    });

    // åˆæœŸåŒæœŸ
    try { ensureSeatForm(); syncVisual(btns); } catch(e){}
    return true;
  }

  function tryWire(){
    if (wireOnce()) return;
    setTimeout(tryWire, 250);
  }

  // DOMæº–å‚™å¾Œã‚‚ã€ç”»é¢åˆ‡æ›¿å¾Œã‚‚æ‹¾ãˆã‚‹ã‚ˆã†ã«ã™ã‚‹
  document.addEventListener("DOMContentLoaded", tryWire);

  // ã‚‚ã— go(view) ãŒã‚ã‚‹ãªã‚‰ã€ç”»é¢é·ç§»ã®ãŸã³ã«å†åŒæœŸ
  const oldGo = window.go;
  if (typeof oldGo === "function" && !oldGo.__seatGroupFixWrapped) {
    window.go = function(){
      const r = oldGo.apply(this, arguments);
      setTimeout(tryWire, 50);
      return r;
    };
    window.go.__seatGroupFixWrapped = true;
  }

  // ä»Šã“ã®ç¬é–“ã‚‚è©¦ã™
  tryWire();
})();
/* =========================
   å¸­ç™»éŒ²ï¼šåç§°ãƒœã‚¿ãƒ³ãŒè¦‹ãŸç›®ã ã‘ã§ state ã«å…¥ã‚‰ãªã„å¯¾ç­–ï¼ˆè¿½è¨˜ãƒ‘ãƒƒãƒï¼‰
   æœ«å°¾ã«è²¼ã‚‹ã ã‘
========================= */
(() => {
  const NAMES = ["ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼","ç«‹ã¡","ãƒ†ãƒ¼ãƒ–ãƒ«","åº§æ•·","å€‹å®¤","ãã®ä»–"];

  function findNameFromButton(btn){
    const t = (btn.textContent || "").trim();
    // ãƒœã‚¿ãƒ³å†…ã«æ”¹è¡Œã‚„ä½™è¨ˆãªæ–‡å­—ãŒã‚ã£ã¦ã‚‚æ‹¾ãˆã‚‹ã‚ˆã†ã« includes
    for (const n of NAMES) if (t.includes(n)) return n;
    return null;
  }

  function markSelected(name){
    const btns = Array.from(document.querySelectorAll("button"));
    for (const b of btns){
      const n = findNameFromButton(b);
      if (!n) continue;
      // æ—¢å­˜CSSã«ä¾å­˜ã—ãªã„ã‚ˆã† class ã‚’ä¸¡æ–¹ã„ã˜ã‚‹ï¼ˆã©ã£ã¡ã§ã‚‚åŠ¹ãï¼‰
      if (n === name){
        b.classList.add("isSelected","selected","active");
        b.setAttribute("aria-pressed","true");
      } else {
        b.classList.remove("isSelected","selected","active");
        b.setAttribute("aria-pressed","false");
      }
    }
  }

  function wire(){
    // state ãŒç„¡ã„ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã ã¨è½ã¡ã‚‹ã®ã§ã‚¬ãƒ¼ãƒ‰
    if (!window.state) return false;
    if (!state.ui) state.ui = {};

    // ã„ã£ãŸã‚“å…¨ãƒœã‚¿ãƒ³ã‹ã‚‰ã€Œåç§°ãƒœã‚¿ãƒ³ã£ã½ã„ã‚‚ã®ã€ã‚’æ‹¾ã£ã¦å€‹åˆ¥ã«ãƒãƒ³ãƒ‰ãƒ©ä»˜ä¸
    const btns = Array.from(document.querySelectorAll("button"));
    let found = 0;

    for (const b of btns){
      const name = findNameFromButton(b);
      if (!name) continue;

      // äºŒé‡ä»˜ä¸é˜²æ­¢
      if (b.__seatGroupWired) continue;
      b.__seatGroupWired = true;
      found++;

      const onPick = (ev) => {
        try{
          ev && ev.preventDefault && ev.preventDefault();
          ev && ev.stopPropagation && ev.stopPropagation();
        }catch{}

        // â˜…ã“ã“ãŒæœ¬å‘½ï¼šå†…éƒ¨stateã«ç¢ºå®Ÿã«å…¥ã‚Œã‚‹
        state.ui.seatGroup = name;

        // å¿µã®ãŸã‚ â€œæœ€å¾Œã«é¸ã‚“ã åç§°â€ ã‚‚æ§ãˆã‚‹ï¼ˆã©ã“ã‹ã§ state ãŒä¸Šæ›¸ãã•ã‚Œã¦ã‚‚å¾©æ—§ã—ã‚„ã™ã„ï¼‰
        window.__lastSeatGroup = name;

        markSelected(name);

        // ç”»é¢å´ã«å†æç”»é–¢æ•°ãŒã‚ã‚‹å ´åˆã¯å‘¼ã¶ï¼ˆå­˜åœ¨ã—ãªã‘ã‚Œã°ç„¡è¦–ï¼‰
        try { if (typeof window.renderSeatReg === "function") window.renderSeatReg(); } catch {}
        try { if (typeof window.save === "function") window.save(); } catch {}
      };

      // iPhoneå¯¾ç­–ï¼štouchstartã‚‚æ‹¾ã†ï¼ˆclickãŒæ½°ã‚Œã‚‹/é…ã‚Œã‚‹ã‚±ãƒ¼ã‚¹å¯¾ç­–ï¼‰
      b.addEventListener("click", onPick, { passive:false });
      b.addEventListener("touchstart", onPick, { passive:false });
    }

    // æ—¢ã«é¸æŠã•ã‚Œã¦ã‚‹è¡¨ç¤ºãŒã‚ã‚‹ãªã‚‰ state ã‚’è£œå®Œï¼ˆé€†æ–¹å‘ã®è£œæ­£ï¼‰
    if (!state.ui.seatGroup && window.__lastSeatGroup){
      state.ui.seatGroup = window.__lastSeatGroup;
    }
    if (state.ui.seatGroup) markSelected(state.ui.seatGroup);

    return found > 0;
  }

  // DOMæº–å‚™/ç”»é¢åˆ‡æ›¿ã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§ã‚‚æ‹¾ãˆã‚‹ã‚ˆã†ã«ãƒªãƒˆãƒ©ã‚¤
  let tries = 0;
  const timer = setInterval(() => {
    tries++;
    const ok = wire();
    if (ok || tries > 40) clearInterval(timer); // æœ€å¤§10ç§’ç¨‹åº¦ã§æ‰“ã¡åˆ‡ã‚Š
  }, 250);

  // å¿µã®ãŸã‚åˆå›å³å®Ÿè¡Œ
  try{ wire(); }catch{}
})();
</script>
</body>
</html>