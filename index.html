<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>ONE（無料版）</title>

<style>
  :root{
    --bg:#0f172a;          /* 濃紺 */
    --panel:#111c33;       /* パネル */
    --card:#162447;        /* カード */
    --card2:#0f1a33;
    --text:#e5e7eb;
    --muted:#a7b0c0;
    --line:rgba(255,255,255,.10);
    --accent:#ff8a3d;      /* 決定/強調 */
    --accent2:#2dbE60;     /* OK */
    --warn:#ff4d4d;
    --hi:#2b3a66;          /* 選択ハイライト */
    --lime:#7CFF62;        /* スライダーつまみ黄緑 */
    --shadow:0 6px 20px rgba(0,0,0,.35);
    --radius:14px;
    --barH:64px;           /* 下部固定バー高さ */
    --topH:60px;           /* 上部固定バー高さ（17で狭める） */
  }

  /* ===== 横ズレ防止（1） ===== */
  html, body{
    width:100%;
    max-width:100%;
    overflow-x:hidden;
    overscroll-behavior: none;
    background:var(--bg);
    color:var(--text);
    font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Hiragino Kaku Gothic ProN","Noto Sans JP",sans-serif;
    -webkit-text-size-adjust:100%;
    text-size-adjust:100%;
  }
  *{ box-sizing:border-box; }
  a, button{ touch-action: manipulation; }
  input, button, select { font: inherit; }

  /* ダブルタップ拡大を抑制（完全停止はOS都合で不可だが誤爆減らす） */
  body { -webkit-tap-highlight-color: transparent; }

  /* ===== 画面レイアウト ===== */
  .app{
    min-height:100vh;
    padding-top: calc(var(--topH) + env(safe-area-inset-top));
    padding-bottom: calc(var(--barH) + env(safe-area-inset-bottom));
  }

  /* ===== 上部固定バー ===== */
  .topbar{
    position:fixed;
    top:0; left:0; right:0;
    height: calc(var(--topH) + env(safe-area-inset-top));
    padding-top: env(safe-area-inset-top);
    background:rgba(10,16,32,.92);
    backdrop-filter: blur(8px);
    border-bottom:1px solid var(--line);
    z-index:50;
    display:flex;
    align-items:center;
    gap:10px;
    padding-left:12px;
    padding-right:12px;
  }
  .topbar .left, .topbar .right{
    display:flex; align-items:center; gap:10px;
  }
  .topbar .center{
    flex:1;
    display:flex;
    justify-content:center;
  }

  .pill{
    border:1px solid var(--line);
    background:rgba(255,255,255,.04);
    color:var(--text);
    padding:10px 12px;
    border-radius:999px;
    display:inline-flex;
    align-items:center;
    gap:8px;
    box-shadow: none;
  }
  .pill strong{ font-weight:700; letter-spacing:.5px; }
  .pill.btn{ cursor:pointer; }
  .pill.btn:active{ transform: translateY(1px); }

  /* トップバーのボタン内収まり改善（17） */
  .pill.small{
    padding:10px 10px;
    min-width: 92px;
    justify-content:center;
    white-space:nowrap;
  }

  /* ===== 下部固定バー（17） ===== */
  .bottombar{
    position:fixed;
    left:0; right:0; bottom:0;
    height: calc(var(--barH) + env(safe-area-inset-bottom));
    padding-bottom: env(safe-area-inset-bottom);
    background:rgba(10,16,32,.92);
    backdrop-filter: blur(8px);
    border-top:1px solid var(--line);
    z-index:50;
  }
  .barwrap{
    height:var(--barH);
    display:flex;
    flex-direction:column;
    justify-content:center;
    gap:8px;
    padding:8px 10px;
  }

  /* 18：4ボタンを線で囲ってグループ化 */
  .opGroup{
    border:1px solid var(--line);
    border-radius:14px;
    padding:6px;
    background:rgba(255,255,255,.03);
  }
  .opRow{
    display:grid;
    grid-template-columns: repeat(4, 1fr);
    gap:8px;
  }
  .opRow2{
    display:grid;
    grid-template-columns: repeat(2, 1fr);
    gap:8px;
  }

  .btn{
    border:1px solid var(--line);
    background:rgba(255,255,255,.06);
    color:var(--text);
    border-radius:14px;
    padding:12px 10px;
    min-height:48px;
    text-align:center;
    font-weight:700;
    letter-spacing:.2px;
    box-shadow: none;
    user-select:none;
  }
  .btn:active{ transform: translateY(1px); }

  /* 18：決定以外 同系色 / 決定は強調 */
  .btn.op{ background:rgba(90,120,255,.13); border-color:rgba(90,120,255,.25); }
  .btn.op.selected{ background:var(--hi); border-color:rgba(120,160,255,.55); }
  .btn.decide{ background:rgba(255,138,61,.20); border-color:rgba(255,138,61,.45); }
  .btn.decide:active{ filter:brightness(1.05); }

  .btn.secondary{
    background:rgba(255,255,255,.05);
  }
  .btn.danger{
    background:rgba(255,77,77,.12);
    border-color:rgba(255,77,77,.3);
  }
  .btn.good{
    background:rgba(45,190,96,.16);
    border-color:rgba(45,190,96,.35);
  }

  .content{
    padding:12px;
  }

  /* ===== 席カード ===== */
  .gridSeats{
    display:grid;
    grid-template-columns: repeat(3, minmax(0, 1fr));
    gap:10px;
  }
  .seatCard{
    background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
    border:1px solid var(--line);
    border-radius: var(--radius);
    padding:12px;
    box-shadow: var(--shadow);
    min-height:110px;
    position:relative;
    overflow:hidden; /* 13：長文化対策 */
  }
  .seatCard .label{
    font-size:22px;
    font-weight:900;
    letter-spacing:.5px;
    margin-bottom:4px;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
  }
  .seatCard .meta{
    font-size:12px;
    color:var(--muted);
    line-height:1.25;
    min-height:30px;
  }
  .seatCard .sum{
    margin-top:8px;
    font-size:16px;
    font-weight:900;
  }
  .badge{
    position:absolute;
    right:10px;
    top:10px;
    font-size:11px;
    padding:4px 8px;
    border-radius:999px;
    border:1px solid var(--line);
    background:rgba(255,255,255,.04);
    color:var(--text);
  }
  .badge.reserve{ border-color:rgba(255,215,0,.35); background:rgba(255,215,0,.10); }
  .badge.merge{ border-color:rgba(90,120,255,.35); background:rgba(90,120,255,.12); }

  .seatCard.empty{ background:rgba(255,255,255,.03); box-shadow:none; }
  .seatCard.active{ border-color:rgba(45,190,96,.35); }
  .seatCard.reserve{ border-color:rgba(255,215,0,.35); }

  /* ===== 設定カード ===== */
  .gridCards{
    display:grid;
    grid-template-columns: repeat(2, minmax(0, 1fr));
    gap:10px;
  }
  .cardBtn{
    background:rgba(255,255,255,.05);
    border:1px solid var(--line);
    border-radius: var(--radius);
    padding:14px;
    box-shadow: var(--shadow);
    text-align:left;
  }
  .cardBtn .t{ font-weight:900; font-size:16px; }
  .cardBtn .s{ margin-top:4px; font-size:12px; color:var(--muted); }

  /* ===== 注文画面 ===== */
  .stickyHead{
    position:sticky;
    top:0;
    z-index:20;
    background:rgba(15,23,42,.92);
    backdrop-filter: blur(8px);
    border-bottom:1px solid var(--line);
    padding:10px;
    border-radius:14px;
    margin-bottom:10px;
  }
  .headRow{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
  }
  .headTitle{
    font-weight:900;
    font-size:16px;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
  }
  .smallBtn{
    padding:10px 12px;
    border-radius:12px;
    min-height:44px;
  }

  /* 24：商品カード 3列（狭い端末は2列） */
  .itemsGrid{
    display:grid;
    grid-template-columns: repeat(3, minmax(0, 1fr));
    gap:10px;
  }
  @media (max-width: 360px){
    .itemsGrid{ grid-template-columns: repeat(2, minmax(0, 1fr)); }
  }
  .itemCard{
    background:rgba(255,255,255,.05);
    border:1px solid var(--line);
    border-radius:14px;
    padding:12px;
    box-shadow: var(--shadow);
    min-width:0;
  }
  .itemCard .nm{
    font-weight:900;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
  }
  .itemCard .pr{
    margin-top:4px;
    font-size:12px;
    color:var(--muted);
  }

  .list{
    margin-top:10px;
    border:1px solid var(--line);
    border-radius:14px;
    overflow:hidden;
  }
  .row{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
    padding:10px 12px;
    border-top:1px solid var(--line);
    background:rgba(255,255,255,.03);
  }
  .row:first-child{ border-top:none; }
  .row .l{ min-width:0; }
  .row .l .a{ font-weight:900; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
  .row .l .b{ font-size:12px; color:var(--muted); margin-top:2px; }
  .row .r{ display:flex; gap:8px; }

  /* ===== 会計 ===== */
  .payBtns{
    display:grid;
    grid-template-columns: repeat(3, 1fr);
    gap:10px;
  }
  .payBtn{
    border-radius:14px;
    padding:12px 10px;
    min-height:48px;
    font-weight:900;
    border:1px solid var(--line);
    background:rgba(255,255,255,.06);
  }
  .payBtn.active{
    border-color:rgba(45,190,96,.55);
    background:rgba(45,190,96,.18);
  }
  .bigTotal{
    font-size:28px;
    font-weight:1000;
    letter-spacing:.5px;
    margin:6px 0 10px;
  }

  /* ===== メニュー登録 ===== */
  .noteRed{
    color:var(--warn);
    font-weight:900;
    font-size:13px;
    line-height:1.35;
    margin:8px 0 10px;
  }
  .field{
    display:flex;
    flex-direction:column;
    gap:6px;
    margin:10px 0;
  }
  .field label{ font-size:12px; color:var(--muted); }
  .in{
    width:100%;
    border:1px solid var(--line);
    background:rgba(255,255,255,.05);
    color:var(--text);
    border-radius:14px;
    padding:12px 12px;
    min-height:46px;
  }
  .in.small{ min-height:44px; padding:10px 12px; }

  /* 10：数字欄を狭く、数字大きめ */
  .numRow{
    display:flex;
    align-items:center;
    gap:10px;
  }
  .numBox{
    width:86px;
    text-align:center;
    font-size:18px;
    font-weight:900;
  }
  .stepBtn{
    width:52px;
    min-height:46px;
    border-radius:14px;
    border:1px solid var(--line);
    background:rgba(255,255,255,.06);
    color:var(--text);
    font-weight:1000;
    font-size:18px;
  }

  /* ===== モーダル（2/3：背景固定） ===== */
  .modalBackdrop{
    position:fixed;
    inset:0;
    background:rgba(0,0,0,.55);
    z-index:100;
    display:flex;
    align-items:center;
    justify-content:center;
    padding:14px;
  }
  .modal{
    width:min(560px, 100%);
    background:rgba(20,30,55,.98);
    border:1px solid var(--line);
    border-radius:18px;
    box-shadow:var(--shadow);
    padding:14px;
  }
  .modal h3{
    margin:0;
    font-size:16px;
    font-weight:1000;
  }
  .modal .sub{
    margin:6px 0 10px;
    font-size:12px;
    color:var(--muted);
    line-height:1.35;
  }
  .modal .actions{
    display:grid;
    grid-template-columns: 1fr 1fr;
    gap:10px;
    margin-top:12px;
  }
  .modal .actions.one{
    grid-template-columns: 1fr;
  }

  /* ===== キッチン ===== */
  .kTopRow{
    display:flex;
    gap:10px;
    margin-bottom:10px;
  }
  .kTopRow .btn{ flex:1; }
  .kList{
    display:flex;
    flex-direction:column;
    gap:8px;
  }
  .kCard{
    position:relative;
    border:1px solid var(--line);
    border-radius:14px;
    background:rgba(255,255,255,.04);
    box-shadow: var(--shadow);
    padding:10px 12px; /* 26：縦幅削減 */
  }
  .kRow{
    display:flex;
    align-items:flex-start;
    justify-content:space-between;
    gap:10px;
  }
  .kName{
    font-size:18px;     /* 26：料理名大きめ */
    font-weight:1000;
    line-height:1.15;
  }
  .kQty{
    font-size:18px;     /* 26：個数数字大きめ */
    font-weight:1000;
    margin-left:10px;   /* 26：数字少し右へ */
  }
  .kMeta{
    margin-top:4px;
    font-size:12px;
    color:var(--muted);
  }
  .kMeta .late{ color:var(--warn); font-weight:900; } /* 15分経過で赤 */
  .kChild{
    margin-top:6px;
    margin-left:14px;
    padding-left:10px;
    border-left:2px solid rgba(255,255,255,.12);
  }

  /* 25：昇格（親）＝左バー＋背景少し明るく */
  .kPromoted{
    background:rgba(255,255,255,.07);
  }
  .kPromoted::before{
    content:"";
    position:absolute;
    left:0; top:0; bottom:0;
    width:6px;
    background:rgba(255,138,61,.85);
    border-top-left-radius:14px;
    border-bottom-left-radius:14px;
  }

  /* 26：完了スライダー短く＆右寄せ */
  .kSliderWrap{
    margin-top:6px;
    display:flex;
    justify-content:flex-end;
  }
  .kSlider{
    width:50%;
    max-width:240px;
    height:28px;
    accent-color: var(--lime); /* つまみ色（対応ブラウザ） */
  }

  /* ===== 画面切替 ===== */
  .view{ display:none; }
  .view.active{ display:block; }

  .titleRow{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
    margin:10px 0 12px;
  }
  .titleRow h2{
    margin:0;
    font-size:18px;
    font-weight:1000;
  }

  .hr{ height:1px; background:var(--line); margin:10px 0; }

  .muted{ color:var(--muted); }
</style>
</head>

<body>
<div class="topbar">
  <div class="left">
    <!-- 28：ONE＝プラン入口 -->
    <div class="pill btn" id="btnOne"><strong>ONE</strong></div>
  </div>

  <div class="center">
    <!-- メインではキッチン、キッチンではホール（4/17） -->
    <button class="pill btn small" id="btnTopCenter">キッチン</button>
  </div>

  <div class="right">
    <button class="pill btn small" id="btnBackup">バックアップ</button>
  </div>
</div>

<div class="app">
  <!-- MAIN -->
  <div class="view active" id="viewMain">
    <div class="content">
      <div class="titleRow">
        <h2>席</h2>
        <div class="muted" id="modeLabel">通常</div>
      </div>

      <div class="gridSeats" id="seatGrid"></div>
    </div>
  </div>

  <!-- SETTINGS -->
  <div class="view" id="viewSettings">
    <div class="content">
      <div class="titleRow">
        <h2>設定</h2>
        <button class="btn smallBtn secondary" id="btnToMainFromSettings">メイン</button>
      </div>

      <div class="gridCards">
        <div class="cardBtn btn" id="goSeatRegister">
          <div class="t">席登録</div>
          <div class="s">席を作成・編集・削除</div>
        </div>
        <div class="cardBtn btn" id="goMenuRegister">
          <div class="t">メニュー登録</div>
          <div class="s">料理/ドリンクの登録</div>
        </div>
        <div class="cardBtn btn" id="goSales">
          <div class="t">売上</div>
          <div class="s">月/年/管理（簡易）</div>
        </div>
        <div class="cardBtn btn" id="goStoreInfo">
          <div class="t">店舗情報</div>
          <div class="s">（有料版で拡張予定）</div>
        </div>
        <div class="cardBtn btn" id="goSuggest">
          <div class="t">料理提案</div>
          <div class="s">無料版は準備中</div>
        </div>
        <div class="cardBtn btn" id="goContact">
          <div class="t">お問合せ</div>
          <div class="s">案内</div>
        </div>
      </div>
    </div>
  </div>

  <!-- SEAT REGISTER -->
  <div class="view" id="viewSeatRegister">
    <div class="content">
      <div class="titleRow">
        <h2>席登録</h2>
        <button class="btn smallBtn secondary" id="btnSeatRegBack">戻る</button>
      </div>

      <div class="field">
        <label>席の名称（種類）</label>
        <select class="in" id="srType"></select>
      </div>

      <div class="field" id="srOtherWrap" style="display:none;">
        <label>その他の名称（入力すると次回から一覧に追加）</label>
        <input class="in" id="srOtherName" placeholder="例：中庭テラス" />
      </div>

      <div class="field">
        <label id="srCountLabel">総席数 / 総卓数</label>
        <div class="numRow">
          <button class="stepBtn" id="srCountMinus">◀︎</button>
          <input class="in numBox" id="srCount" inputmode="numeric" value="1" />
          <button class="stepBtn" id="srCountPlus">▶︎</button>
        </div>
      </div>

      <div class="field">
        <label>最大着席人数（デフォルト：カウンター/立ちは1、他は4）</label>
        <div class="numRow">
          <button class="stepBtn" id="srCapMinus">◀︎</button>
          <input class="in numBox" id="srCap" inputmode="numeric" value="4" />
          <button class="stepBtn" id="srCapPlus">▶︎</button>
        </div>
      </div>

      <button class="btn good" id="srStart">席（卓）番号入力へ</button>
      <div class="hr"></div>

      <div id="srEntryArea" style="display:none;">
        <div class="field">
          <label>席（卓）番号（自動で次候補が出ます／英字は大文字）</label>
          <div class="numRow">
            <button class="stepBtn" id="srLblPrev">◀︎</button>
            <input class="in" id="srLabel" placeholder="例：1 / A / C1" />
            <button class="stepBtn" id="srLblNext">▶︎</button>
          </div>
        </div>

        <button class="btn" id="srAddSeat">この席を追加</button>
        <div class="muted" id="srProgress" style="margin-top:8px;"></div>

        <div class="hr"></div>
        <div class="muted">作った席（タップで編集）</div>
        <div style="margin-top:10px;" class="gridSeats" id="srSeatPreview"></div>

        <div class="hr"></div>
        <button class="btn danger" id="srReset">削除（この画面の入力を初期化）</button>
      </div>
    </div>
  </div>

  <!-- MENU REGISTER -->
  <div class="view" id="viewMenuRegister">
    <div class="content">
      <div class="titleRow">
        <h2>メニュー登録</h2>
        <button class="btn smallBtn secondary" id="btnMenuBack">戻る</button>
      </div>

      <!-- 20：文言修正＋誤認識前提を赤文字 -->
      <div class="noteRed">
        ※ 無料OCRのため誤認識が発生します（必ず確認・修正してください）
      </div>

      <div class="field">
        <label>写真を撮って登録（端末のカメラを起動します）</label>
        <input class="in" type="file" accept="image/*" capture="environment" id="mrCamera" />
        <div class="muted" style="margin-top:6px;">※撮影後、候補を表示します（登録は1件ずつ）</div>
        <button class="btn secondary" id="mrClearPhoto" style="margin-top:10px;">撮った写真を消す</button>
      </div>

      <div class="hr"></div>

      <div class="field">
        <label>区分（料理/ドリンク）</label>
        <select class="in" id="mrCategory">
          <option value="料理">料理</option>
          <option value="ドリンク">ドリンク</option>
        </select>
      </div>

      <div class="field">
        <label>ジャンル</label>
        <input class="in" id="mrGenre" placeholder="例：揚げ物 / ビール / 定番" />
      </div>

      <div class="field">
        <label>商品名</label>
        <input class="in" id="mrName" placeholder="例：唐揚げ" />
      </div>

      <div class="field">
        <label>価格</label>
        <input class="in" id="mrPrice" inputmode="numeric" placeholder="例：680" />
      </div>

      <div class="field">
        <label>税率（8 / 10）</label>
        <select class="in" id="mrTax">
          <option value="10">10</option>
          <option value="8">8</option>
        </select>
      </div>

      <button class="btn good" id="mrAdd">登録</button>
      <button class="btn secondary" id="mrCsv" style="margin-top:10px;">CSVを出力（日本語）</button>

      <div class="hr"></div>
      <div class="muted">登録済み（あいうえお順）</div>
      <div class="list" id="mrList"></div>
    </div>
  </div>

  <!-- ORDER -->
  <div class="view" id="viewOrder">
    <div class="content">
      <!-- 8：商品（ジャンル）／戻る を固定＋強調 -->
      <div class="stickyHead">
        <div class="headRow">
          <!-- 7：見出しは注文 -->
          <div class="headTitle" id="orderHead">注文</div>
          <button class="btn smallBtn secondary" id="btnOrderBack">メイン</button> <!-- 9：戻る→メイン -->
        </div>
        <div class="muted" id="orderSub" style="margin-top:6px;"></div>
      </div>

      <div id="genreArea">
        <div class="muted">ジャンルを選択</div>
        <div class="list" id="genreList" style="margin-top:10px;"></div>
      </div>

      <div id="itemsArea" style="display:none;">
        <div class="headRow" style="margin-bottom:10px;">
          <div class="headTitle" id="itemsTitle">商品</div>
          <button class="btn smallBtn secondary" id="btnBackToGenres">戻る</button>
        </div>
        <div class="itemsGrid" id="itemsGrid"></div>
      </div>

      <div class="hr"></div>
      <div class="muted">注文履歴</div>
      <div class="list" id="orderList"></div>

      <button class="btn" id="goCheckout" style="margin-top:12px;">会計へ</button>
    </div>
  </div>

  <!-- CHECKOUT -->
  <div class="view" id="viewCheckout">
    <div class="content">
      <div class="titleRow">
        <h2>会計</h2>
        <button class="btn smallBtn secondary" id="btnCheckoutBack">メイン</button>
      </div>

      <div id="coInfo" class="muted"></div>
      <div class="bigTotal" id="coTotal">¥0</div>

      <div class="field">
        <label>支払い方法</label>
        <div class="payBtns">
          <button class="payBtn" id="payCash">現金</button>
          <button class="payBtn" id="payCard">カード</button>
          <button class="payBtn" id="payQr">QR/電子決済</button>
        </div>
      </div>

      <div class="field">
        <label>割り勘（人数で均等割：簡易）</label>
        <button class="btn secondary" id="btnSplit">割り勘を表示</button>
        <div class="muted" id="splitInfo" style="margin-top:6px;"></div>
      </div>

      <button class="btn decide" id="btnCheckoutConfirm">会計確定</button>

      <div class="hr"></div>
      <div class="muted">注文一覧（修正）</div>
      <div class="list" id="coList"></div>
    </div>
  </div>

  <!-- KITCHEN -->
  <div class="view" id="viewKitchen">
    <div class="content">
      <div class="titleRow">
        <h2>キッチン</h2>
        <!-- 4：キッチン画面ではホール表示でメインへ -->
        <button class="btn smallBtn secondary" id="btnHall">ホール</button>
      </div>

      <!-- 更新/料理/ドリンク -->
      <div class="kTopRow">
        <button class="btn secondary" id="kRefresh">更新</button>
        <button class="btn secondary" id="kFood">料理</button>
        <button class="btn secondary" id="kDrink">ドリンク</button>
      </div>

      <div class="kList" id="kList"></div>
    </div>
  </div>

  <!-- SALES -->
  <div class="view" id="viewSales">
    <div class="content">
      <div class="titleRow">
        <h2 id="salesTitle">売上</h2>
        <button class="btn smallBtn secondary" id="btnSalesBack">メイン</button>
      </div>

      <div class="kTopRow">
        <button class="btn secondary" id="goMonthly">月売上</button>
        <button class="btn secondary" id="goYearly">年売上</button>
        <button class="btn secondary" id="goSalesMgmt">売上管理</button>
      </div>

      <div class="muted" id="salesBody" style="margin-top:12px;">
        ※無料版は簡易表示（後で拡張）
      </div>
    </div>
  </div>

  <!-- StoreInfo / Suggest / Contact are simple stubs -->
  <div class="view" id="viewStub">
    <div class="content">
      <div class="titleRow">
        <h2 id="stubTitle">ページ</h2>
        <button class="btn smallBtn secondary" id="btnStubBack">戻る</button>
      </div>
      <div class="muted" id="stubBody"></div>
    </div>
  </div>
</div>

<!-- Bottom fixed bar -->
<div class="bottombar">
  <div class="barwrap">

    <div class="opGroup">
      <div class="opRow">
        <button class="btn op" id="opMove">席移動</button>
        <button class="btn op" id="opMerge">合計<br>合算</button>
        <button class="btn op" id="opSplit">合計<br>分割</button>
        <button class="btn decide" id="opDecide">決定</button>
      </div>
    </div>

    <div class="opRow2">
      <button class="btn secondary" id="btnTodaySales">本日の売上</button>
      <button class="btn secondary" id="btnSettings">設定</button>
    </div>

  </div>
</div>

<script>
/* =========================
  Storage / State
========================= */
const LS_KEY = "ONE_FREE_V1";

const nowTs = ()=> Date.now();
const fmtTime = (ts)=>{
  const d = new Date(ts);
  const hh = String(d.getHours()).padStart(2,"0");
  const mm = String(d.getMinutes()).padStart(2,"0");
  return `${hh}:${mm}`;
};
const yen = (n)=> "¥" + (Math.round(n)||0).toLocaleString("ja-JP");

const defaultState = ()=>{
  return {
    ui:{
      view:"main",
      selectedSeatIds:[],
      op:null, // "move"|"merge"|"split"
      kitchenFilter:"all" // all|food|drink
    },
    seatTypes:["カウンター","立ち","テーブル","座敷","個室","その他"],
    seats:[],  // {id,label,typeName,cap,status,party{people,name,phone},openedAt,reservedAt,orders[], mergedInto:null}
    menu:[],   // {id,category,genre,name,price,tax}
    sales:[],  // {id,ts,total,payMethod,items[]}
  };
};

let state = load();

function load(){
  try{
    const raw = localStorage.getItem(LS_KEY);
    if(!raw) return defaultState();
    const s = JSON.parse(raw);
    return Object.assign(defaultState(), s);
  }catch(e){
    return defaultState();
  }
}
function save(){
  localStorage.setItem(LS_KEY, JSON.stringify(state));
}

/* =========================
  View switch
========================= */
const V = {
  main: document.getElementById("viewMain"),
  settings: document.getElementById("viewSettings"),
  seatReg: document.getElementById("viewSeatRegister"),
  menuReg: document.getElementById("viewMenuRegister"),
  order: document.getElementById("viewOrder"),
  checkout: document.getElementById("viewCheckout"),
  kitchen: document.getElementById("viewKitchen"),
  sales: document.getElementById("viewSales"),
  stub: document.getElementById("viewStub")
};

function show(view){
  Object.values(V).forEach(el=> el.classList.remove("active"));
  const map = {
    main:V.main, settings:V.settings, seatReg:V.seatReg, menuReg:V.menuReg,
    order:V.order, checkout:V.checkout, kitchen:V.kitchen, sales:V.sales, stub:V.stub
  };
  map[view].classList.add("active");
  state.ui.view = view;
  save();
}

/* =========================
  Modal (2/3 background fixed)
========================= */
let modalEl = null;
function openModal({title, sub="", bodyHtml="", yesText="OK", noText="閉じる", onYes=null, onNo=null, one=false}){
  closeModal();

  // 背景固定（3）
  document.body.style.overflow = "hidden";

  const b = document.createElement("div");
  b.className = "modalBackdrop";
  b.innerHTML = `
    <div class="modal" role="dialog" aria-modal="true">
      <h3>${escapeHtml(title)}</h3>
      <div class="sub">${escapeHtml(sub)}</div>
      <div class="body">${bodyHtml||""}</div>
      <div class="actions ${one ? "one":""}">
        ${!one ? `<button class="btn secondary" id="mNo">${escapeHtml(noText)}</button>` : ``}
        <button class="btn good" id="mYes">${escapeHtml(yesText)}</button>
      </div>
    </div>
  `;
  document.body.appendChild(b);
  modalEl = b;

  const yes = b.querySelector("#mYes");
  const no  = b.querySelector("#mNo");

  yes?.addEventListener("click", ()=>{
    if(onYes) onYes();
  });
  no?.addEventListener("click", ()=>{
    if(onNo) onNo();
    closeModal();
  });

  // backdrop tap close for safety (optional)
  b.addEventListener("click",(e)=>{
    if(e.target === b){
      if(onNo) onNo();
      closeModal();
    }
  });
}
function closeModal(){
  if(modalEl){
    modalEl.remove();
    modalEl = null;
  }
  document.body.style.overflow = "";
}
function escapeHtml(s){
  return String(s ?? "").replace(/[&<>"']/g, (c)=>({
    "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;"
  }[c]));
}

/* =========================
  Helpers
========================= */
function normalizeName(s){
  return (s ?? "")
    .trim()
    .replace(/\s+/g," ")
    .replace(/（/g,"(").replace(/）/g,")")
    .toLowerCase();
}
function localeSortJa(a,b){
  return String(a).localeCompare(String(b), "ja", { sensitivity:"base", numeric:true });
}
function seatSortKey(label){
  const s = String(label ?? "");
  if (/^[A-Za-z]+$/.test(s)) return [0, s.toUpperCase(), 0];
  if (/^\d+$/.test(s)) return [1, "", Number(s)];
  const m = s.match(/^([A-Za-z]+)(\d+)$/);
  if(m) return [0, m[1].toUpperCase(), Number(m[2])];
  return [2, s.toUpperCase(), 0];
}
function seatCompare(a,b){
  const A = seatSortKey(a.label);
  const B = seatSortKey(b.label);
  for(let i=0;i<3;i++){
    if(A[i]<B[i]) return -1;
    if(A[i]>B[i]) return 1;
  }
  return 0;
}
function totalSeat(seat){
  // mergedInto なら自分は0表示（合算先に寄せる）
  if(seat.mergedInto) return 0;
  const ids = [seat.id, ...state.seats.filter(s=> s.mergedInto===seat.id).map(s=>s.id)];
  let sum=0;
  for(const sid of ids){
    const s = state.seats.find(x=>x.id===sid);
    for(const o of (s.orders||[])){
      sum += (o.price||0) * (o.qty||1);
    }
  }
  return sum;
}

/* =========================
  MAIN: seat rendering
========================= */
const seatGrid = document.getElementById("seatGrid");
function renderSeats(){
  // sort
  state.seats.sort(seatCompare);
  save();

  seatGrid.innerHTML = "";
  for(const seat of state.seats){
    const card = document.createElement("div");
    card.className = "seatCard";
    if(seat.status==="empty") card.classList.add("empty");
    if(seat.status==="active") card.classList.add("active");
    if(seat.status==="reserve") card.classList.add("reserve");

    const merged = seat.mergedInto ? true : false;
    const badge = seat.status==="reserve" ? `<div class="badge reserve">予約</div>` :
                  merged ? `<div class="badge merge">合算</div>` : ``;

    const people = seat.party?.people ? `${seat.party.people}名` : "";
    const name = seat.party?.name ? seat.party.name : "";
    const meta1 = (seat.status==="active" ? `来店 ${fmtTime(seat.openedAt||nowTs())}` :
                   seat.status==="reserve" ? `予約 ${fmtTime(seat.reservedAt||nowTs())}` : "空席");
    // 13：undefined非表示
    const meta2 = [people, name].filter(Boolean).join(" / ");

    const sum = totalSeat(seat);
    const sumText = merged ? "" : (seat.status==="empty" ? "" : yen(sum));

    card.innerHTML = `
      ${badge}
      <div class="label">${escapeHtml(seat.label||"")}</div>
      <div class="meta">
        <div>${escapeHtml(meta1)}</div>
        <div>${escapeHtml(meta2)}</div>
      </div>
      <div class="sum">${escapeHtml(sumText)}</div>
    `;

    card.addEventListener("click", ()=> onSeatTap(seat.id));
    seatGrid.appendChild(card);
  }

  // if none seats, hint
  if(state.seats.length===0){
    const hint = document.createElement("div");
    hint.className = "muted";
    hint.style.marginTop="10px";
    hint.innerHTML = `席がありません。<strong>設定 → 席登録</strong>から作成してください。`;
    seatGrid.appendChild(hint);
  }
}
function getSeat(id){ return state.seats.find(s=>s.id===id); }

/* =========================
  Seat tap behavior
  - empty -> choose arrive/reserve
  - reserve -> choose arrive/cancel
  - active -> go order
========================= */
let currentSeatId = null;

function onSeatTap(id){
  const seat = getSeat(id);
  if(!seat) return;

  // selection for operations (18)
  if(state.ui.op && state.ui.op!==""){
    toggleSelectedSeat(id);
    renderSeats(); // selection is visual via badge? We'll keep selection internal only for now
    return;
  }

  // merged seats tap: if mergedInto -> open target seat order
  if(seat.mergedInto){
    const target = getSeat(seat.mergedInto);
    if(target){ openOrder(target.id); return; }
  }

  if(seat.status==="active"){
    openOrder(seat.id);
    return;
  }

  if(seat.status==="reserve"){
    openReserveActions(seat);
    return;
  }

  if(seat.status==="empty"){
    openEmptyActions(seat);
    return;
  }
}

function openEmptyActions(seat){
  const body = `
    <div class="actions" style="grid-template-columns:1fr 1fr; gap:10px;">
      <button class="btn good" id="aArrive">来店</button>
      <button class="btn" id="aReserve">予約</button>
    </div>
  `;
  openModal({
    title:`席（${seat.label}）`,
    sub:"選択してください",
    bodyHtml: body,
    yesText:"閉じる",
    one:true,
    onYes:()=>closeModal()
  });
  setTimeout(()=>{
    document.getElementById("aArrive")?.addEventListener("click", ()=>{
      closeModal();
      openPartyInput(seat, "arrive");
    });
    document.getElementById("aReserve")?.addEventListener("click", ()=>{
      closeModal();
      openPartyInput(seat, "reserve");
    });
  },0);
}

function openReserveActions(seat){
  const body = `
    <div class="actions" style="grid-template-columns:1fr 1fr; gap:10px;">
      <button class="btn good" id="rArrive">来店</button>
      <button class="btn danger" id="rCancel">キャンセル</button>
    </div>
    <div class="muted" style="margin-top:10px;">来店：通常表示に戻して注文へ／キャンセル：空席に戻します</div>
  `;
  openModal({
    title:`予約（${seat.label}）`,
    sub:"操作を選択",
    bodyHtml: body,
    yesText:"閉じる",
    one:true,
    onYes:()=>closeModal()
  });
  setTimeout(()=>{
    document.getElementById("rArrive")?.addEventListener("click", ()=>{
      closeModal();
      openPartyInput(seat, "arriveFromReserve");
    });
    document.getElementById("rCancel")?.addEventListener("click", ()=>{
      // cancel -> empty
      seat.status="empty";
      seat.party=null;
      seat.reservedAt=null;
      seat.orders = seat.orders || [];
      seat.mergedInto=null;
      save();
      closeModal();
      renderSeats();
    });
  },0);
}

/* =========================
  People input (2,3)
  - No keyboard: use stepper
========================= */
function openPartyInput(seat, mode){
  const title = mode==="reserve" ? "予約入力" : "来店入力";
  const showPhone = (mode==="reserve");
  const sub = mode==="reserve" ? "決定でメインへ戻り、席が予約表示になります" : "決定で注文ページへ移動します";

  const body = `
    <div class="field">
      <label>人数</label>
      <div class="numRow">
        <button class="stepBtn" id="piMinus">◀︎</button>
        <input class="in numBox" id="piPeople" value="${seat.party?.people||1}" readonly />
        <button class="stepBtn" id="piPlus">▶︎</button>
      </div>
    </div>

    <div class="field">
      <label>名前（任意）</label>
      <input class="in" id="piName" placeholder="例：田中" value="${escapeHtml(seat.party?.name||"")}" />
    </div>

    ${showPhone ? `
      <div class="field">
        <label>代表者電話番号（任意）</label>
        <input class="in" id="piPhone" placeholder="例：090-1234-5678" value="${escapeHtml(seat.party?.phone||"")}" />
      </div>
    ` : ``}
  `;

  openModal({
    title:`${title}（${seat.label}）`,
    sub,
    bodyHtml: body,
    yesText:"決定",
    noText:"戻る",
    onYes:()=>{
      const people = parseInt(document.getElementById("piPeople").value||"0",10);
      const name = document.getElementById("piName").value?.trim() || "";
      const phone = showPhone ? (document.getElementById("piPhone").value?.trim()||"") : "";

      if(!people){
        openModal({title:"人数を入力してください", sub:"", yesText:"OK", noText:"閉じる", one:true, onYes:()=>closeModal()});
        return;
      }

      if(mode==="reserve"){
        seat.status="reserve";
        seat.party={people,name,phone};
        seat.reservedAt = nowTs();
        seat.orders = seat.orders || [];
        seat.mergedInto=null;
        save();
        closeModal();
        renderSeats();
        return;
      }

      // arrive modes
      seat.status="active";
      seat.party={people,name,phone:""};
      seat.openedAt = seat.openedAt || nowTs();
      seat.orders = seat.orders || [];
      seat.mergedInto=null;
      if(mode==="arriveFromReserve"){
        seat.reservedAt = null;
      }
      save();
      closeModal();
      renderSeats();
      openOrder(seat.id);
    },
    onNo:()=>{ closeModal(); }
  });

  setTimeout(()=>{
    const peopleEl = document.getElementById("piPeople");
    document.getElementById("piMinus")?.addEventListener("click", ()=>{
      let v = parseInt(peopleEl.value||"1",10);
      v = Math.max(1, v-1);
      peopleEl.value = v;
    });
    document.getElementById("piPlus")?.addEventListener("click", ()=>{
      let v = parseInt(peopleEl.value||"1",10);
      v = Math.min(99, v+1);
      peopleEl.value = v;
    });
  },0);
}

/* =========================
  Bottom operations (18)
========================= */
const opMove = document.getElementById("opMove");
const opMerge = document.getElementById("opMerge");
const opSplit = document.getElementById("opSplit");
const opDecide= document.getElementById("opDecide");

function clearOpSelection(){
  state.ui.op = null;
  state.ui.selectedSeatIds = [];
  [opMove,opMerge,opSplit].forEach(b=> b.classList.remove("selected"));
  save();
}
function setOp(op){
  if(state.ui.op===op){
    // re-tap cancels
    clearOpSelection();
    return;
  }
  state.ui.op=op;
  state.ui.selectedSeatIds=[];
  [opMove,opMerge,opSplit].forEach(b=> b.classList.remove("selected"));
  if(op==="move") opMove.classList.add("selected");
  if(op==="merge") opMerge.classList.add("selected");
  if(op==="split") opSplit.classList.add("selected");
  save();
}
function toggleSelectedSeat(id){
  const a = state.ui.selectedSeatIds;
  const idx = a.indexOf(id);
  if(idx>=0) a.splice(idx,1); else a.push(id);
  save();
}
opMove.addEventListener("click", ()=> setOp("move"));
opMerge.addEventListener("click", ()=> setOp("merge"));
opSplit.addEventListener("click", ()=> setOp("split"));

opDecide.addEventListener("click", ()=>{
  if(!state.ui.op){
    openModal({title:"操作を選んでください", sub:"席移動 / 合計合算 / 合計分割 を選択してから決定してください", yesText:"OK", one:true, onYes:()=>closeModal()});
    return;
  }
  const ids = [...state.ui.selectedSeatIds];
  const op = state.ui.op;

  if(op==="move"){
    if(ids.length!==2){
      openModal({title:"席を2つ選択してください", sub:"席移動は2席選択が必要です", yesText:"OK", one:true, onYes:()=>closeModal()});
      return;
    }
    const s1=getSeat(ids[0]), s2=getSeat(ids[1]);
    openModal({
      title:"席移動しますか？",
      sub:`${s1?.label} と ${s2?.label} を入れ替えます`,
      yesText:"決定",
      noText:"戻る",
      onYes:()=>{
        // swap labels + party/status/orders keep attached to seat object (物理席を入替える扱い)
        const tmp = s1.label; s1.label=s2.label; s2.label=tmp;
        save();
        closeModal();
        clearOpSelection();
        renderSeats();
      }
    });
  }

  if(op==="merge"){
    if(ids.length<2){
      openModal({title:"席を2つ以上選択してください", sub:"合計合算は2席以上選択が必要です", yesText:"OK", one:true, onYes:()=>closeModal()});
      return;
    }
    const seats = ids.map(getSeat).filter(Boolean).filter(s=>!s.mergedInto);
    seats.sort(seatCompare);
    const target = seats[0];
    openModal({
      title:"合計合算しますか？",
      sub:`合算先：${target.label}（他の席は「合算」表示になります）`,
      yesText:"決定",
      noText:"戻る",
      onYes:()=>{
        for(const s of seats){
          if(s.id===target.id) continue;
          s.mergedInto = target.id;
        }
        save();
        closeModal();
        clearOpSelection();
        renderSeats();
      }
    });
  }

  if(op==="split"){
    if(ids.length<1){
      openModal({title:"席を選択してください", sub:"合計分割は合算状態の席を選択してください", yesText:"OK", one:true, onYes:()=>closeModal()});
      return;
    }
    const seats = ids.map(getSeat).filter(Boolean);
    openModal({
      title:"合計分割しますか？",
      sub:"選択した席の合算状態を解除します（注文は消しません）",
      yesText:"決定",
      noText:"戻る",
      onYes:()=>{
        for(const s of seats){
          // if selected is target, unmerge all children
          const children = state.seats.filter(x=>x.mergedInto===s.id);
          for(const c of children) c.mergedInto=null;
          // if selected is child
          s.mergedInto=null;
        }
        save();
        closeModal();
        clearOpSelection();
        renderSeats();
      }
    });
  }
});

/* =========================
  Top buttons
========================= */
const btnTopCenter = document.getElementById("btnTopCenter");
btnTopCenter.addEventListener("click", ()=>{
  // center button toggles kitchen/main depending on view
  if(state.ui.view==="kitchen"){
    show("main");
    btnTopCenter.textContent="キッチン";
    renderSeats();
  }else{
    show("kitchen");
    btnTopCenter.textContent="ホール";
    renderKitchen();
  }
});
document.getElementById("btnHall").addEventListener("click", ()=>{
  show("main");
  btnTopCenter.textContent="キッチン";
  renderSeats();
});

document.getElementById("btnSettings").addEventListener("click", ()=>{
  show("settings");
});
document.getElementById("btnToMainFromSettings").addEventListener("click", ()=>{
  show("main"); renderSeats();
});
document.getElementById("btnBackup").addEventListener("click", ()=>{
  openModal({
    title:"バックアップ（無料版）",
    sub:"無料版は簡易案内のみ（有料版で拡張予定）",
    bodyHtml:`<div class="muted">※データは端末内（ブラウザ）に保存されています。<br>将来、メール送信/複数端末共有は有料版で対応予定です。</div>`,
    yesText:"OK",
    one:true,
    onYes:()=>closeModal()
  });
});

/* 28：ONEプラン入口 */
document.getElementById("btnOne").addEventListener("click", ()=>{
  openModal({
    title:"ONE レジアプリ",
    sub:"現在のプラン：無料版",
    bodyHtml:`<div class="muted">
      有料版で追加予定：<br>
      ・電子レシート送信（店舗情報入り）<br>
      ・バックアップ拡張<br>
      ・分析機能の拡張 など<br><br>
      <strong>有料版は準備中です</strong>
    </div>`,
    yesText:"OK",
    one:true,
    onYes:()=>closeModal()
  });
});

/* =========================
  SETTINGS navigation
========================= */
document.getElementById("goSeatRegister").addEventListener("click", ()=>{
  openSeatRegister();
});
document.getElementById("goMenuRegister").addEventListener("click", ()=>{
  show("menuReg");
  renderMenuRegister();
});
document.getElementById("goSales").addEventListener("click", ()=>{
  show("sales");
  renderSales("top");
});
document.getElementById("goStoreInfo").addEventListener("click", ()=>{
  openStub("店舗情報", "無料版は表示のみ。店舗情報のレシート反映は有料版で拡張予定です。");
});
document.getElementById("goSuggest").addEventListener("click", ()=>{
  openStub("料理提案", "無料版は準備中です（有料版で提供予定）。");
});
document.getElementById("goContact").addEventListener("click", ()=>{
  openStub("お問合せ", "無料版は準備中です。");
});
document.getElementById("btnStubBack").addEventListener("click", ()=>{
  show("settings");
});
function openStub(title, body){
  document.getElementById("stubTitle").textContent = title;
  document.getElementById("stubBody").innerHTML = `<div class="muted">${escapeHtml(body)}</div>`;
  show("stub");
}

/* =========================
  Seat Register (14,12,11 etc)
========================= */
const srType = document.getElementById("srType");
const srOtherWrap = document.getElementById("srOtherWrap");
const srOtherName = document.getElementById("srOtherName");
const srCountLabel = document.getElementById("srCountLabel");
const srCount = document.getElementById("srCount");
const srCap = document.getElementById("srCap");
let srNeed = 0;
let srAdded = 0;

function openSeatRegister(){
  show("seatReg");
  fillSeatTypes();
  resetSeatRegInputs(true);
}

function fillSeatTypes(){
  srType.innerHTML = "";
  for(const t of state.seatTypes){
    const op = document.createElement("option");
    op.value=t; op.textContent=t;
    srType.appendChild(op);
  }
  srType.value = "カウンター";
  srOtherWrap.style.display="none";
  updateSeatRegLabels();
}
function updateSeatRegLabels(){
  const t = srType.value;
  srCountLabel.textContent = (t==="カウンター"||t==="立ち") ? "総席数" : "総卓数";
  // default cap
  srCap.value = (t==="カウンター"||t==="立ち") ? "1" : "4";
  srOtherWrap.style.display = (t==="その他") ? "block":"none";
}

srType.addEventListener("change", updateSeatRegLabels);

document.getElementById("srCountMinus").addEventListener("click", ()=>{
  srCount.value = String(Math.max(1, (parseInt(srCount.value||"1",10)-1)));
});
document.getElementById("srCountPlus").addEventListener("click", ()=>{
  srCount.value = String(Math.min(200, (parseInt(srCount.value||"1",10)+1)));
});
document.getElementById("srCapMinus").addEventListener("click", ()=>{
  srCap.value = String(Math.max(1, (parseInt(srCap.value||"1",10)-1)));
});
document.getElementById("srCapPlus").addEventListener("click", ()=>{
  srCap.value = String(Math.min(50, (parseInt(srCap.value||"1",10)+1)));
});

document.getElementById("srStart").addEventListener("click", ()=>{
  // apply other type name into list (14)
  const t = srType.value;
  if(t==="その他"){
    const nm = srOtherName.value.trim();
    if(nm){
      if(!state.seatTypes.includes(nm)){
        state.seatTypes.splice(state.seatTypes.length-1, 0, nm); // before その他
      }
    }
  }
  save();
  document.getElementById("srEntryArea").style.display="block";
  srNeed = Math.max(1, parseInt(srCount.value||"1",10));
  srAdded = 0;
  // suggest initial label
  const lab = suggestFirstLabel();
  document.getElementById("srLabel").value = lab;
  updateSrProgress();
  renderSeatPreview();
});

function suggestFirstLabel(){
  // if seats exist, suggest next after last by sort
  if(state.seats.length===0) return "1";
  const s = [...state.seats].sort(seatCompare);
  const last = s[s.length-1].label || "1";
  return nextLabel(last);
}

/* label increment/decrement (fix a_2 bug) */
function nextLabel(label){
  const s = String(label||"").trim().toUpperCase();
  if(/^\d+$/.test(s)) return String(parseInt(s,10)+1);
  if(/^[A-Z]$/.test(s)) return String.fromCharCode(s.charCodeAt(0)+1);
  const m = s.match(/^([A-Z]+)(\d+)$/);
  if(m) return m[1] + String(parseInt(m[2],10)+1);
  // fallback: if unknown, append 2
  return s + "2";
}
function prevLabel(label){
  const s = String(label||"").trim().toUpperCase();
  if(/^\d+$/.test(s)) return String(Math.max(1, parseInt(s,10)-1));
  if(/^[A-Z]$/.test(s)){
    const c = s.charCodeAt(0);
    return String.fromCharCode(Math.max("A".charCodeAt(0), c-1));
  }
  const m = s.match(/^([A-Z]+)(\d+)$/);
  if(m){
    const n = Math.max(1, parseInt(m[2],10)-1);
    return m[1] + String(n);
  }
  return s;
}
document.getElementById("srLblNext").addEventListener("click", ()=>{
  const el = document.getElementById("srLabel");
  el.value = nextLabel(el.value);
});
document.getElementById("srLblPrev").addEventListener("click", ()=>{
  const el = document.getElementById("srLabel");
  el.value = prevLabel(el.value);
});
document.getElementById("srAddSeat").addEventListener("click", ()=>{
  if(srAdded >= srNeed){
    openModal({title:"入力は完了しています", sub:"", yesText:"OK", one:true, onYes:()=>closeModal()});
    return;
  }
  const t = srType.value;
  let typeName = (t==="その他" ? (srOtherName.value.trim() || "その他") : t);
  const cap = Math.max(1, parseInt(srCap.value||"1",10));
  const label = document.getElementById("srLabel").value.trim().toUpperCase();

  if(!label){
    openModal({title:"席番号を入力してください", sub:"", yesText:"OK", one:true, onYes:()=>closeModal()});
    return;
  }

  // duplicate check message (仕様に近い形：同じ席番号がある場合の確認)
  const exists = state.seats.some(s=> (s.label||"").toUpperCase()===label);
  if(exists){
    openModal({
      title:"同じ席（卓）番号がありますが登録しますか？",
      sub:"◯：そのまま進む／戻る：席番号入力に戻ります",
      yesText:"◯ 登録する",
      noText:"戻る",
      onYes:()=>{
        addSeatRecord(typeName, label, cap);
        closeModal();
      }
    });
    return;
  }

  addSeatRecord(typeName, label, cap);
});

function addSeatRecord(typeName, label, cap){
  const seat = {
    id: crypto.randomUUID ? crypto.randomUUID() : String(nowTs())+Math.random(),
    label,
    typeName,
    cap,
    status:"empty",
    party:null,
    openedAt:null,
    reservedAt:null,
    orders:[],
    mergedInto:null
  };
  state.seats.push(seat);
  save();
  srAdded++;
  // next suggestion
  document.getElementById("srLabel").value = nextLabel(label);
  updateSrProgress();
  renderSeatPreview();

  if(srAdded>=srNeed){
    openModal({
      title:"席登録が完了しました",
      sub:"メインに戻ります",
      yesText:"OK",
      one:true,
      onYes:()=>{
        closeModal();
        show("main");
        renderSeats();
      }
    });
  }
}
function updateSrProgress(){
  document.getElementById("srProgress").textContent = `入力：${srAdded} / ${srNeed}`;
}

document.getElementById("srReset").addEventListener("click", ()=>{
  // 変更：全削除→削除（入力初期化）（指定どおり）
  resetSeatRegInputs(false);
});

function resetSeatRegInputs(hard){
  srCount.value="1";
  updateSeatRegLabels();
  srOtherName.value="";
  document.getElementById("srEntryArea").style.display="none";
  srNeed=0; srAdded=0;
  if(hard){
    // nothing
  }
  renderSeatPreview();
}

function renderSeatPreview(){
  const area = document.getElementById("srSeatPreview");
  area.innerHTML="";
  // same rendering format as main (13)
  const sorted = [...state.seats].sort(seatCompare);
  for(const seat of sorted){
    const card = document.createElement("div");
    card.className = "seatCard";
    card.innerHTML = `
      <div class="label">${escapeHtml(seat.label||"")}</div>
      <div class="meta">
        <div>${escapeHtml(seat.typeName||"")}</div>
        <div>最大 ${escapeHtml(seat.cap)}名</div>
      </div>
      <div class="sum"></div>
    `;
    card.addEventListener("click", ()=> editSeat(seat.id));
    area.appendChild(card);
  }
}
function editSeat(id){
  const seat = getSeat(id);
  if(!seat) return;

  const body = `
    <div class="field">
      <label>名称</label>
      <input class="in" id="esType" value="${escapeHtml(seat.typeName||"")}" />
    </div>
    <div class="field">
      <label>席番号</label>
      <input class="in" id="esLabel" value="${escapeHtml(seat.label||"")}" />
    </div>
    <div class="field">
      <label>最大着席人数</label>
      <input class="in" id="esCap" inputmode="numeric" value="${escapeHtml(seat.cap||4)}" />
    </div>
    <div class="muted">※席に紐付いた売上などのデータはそのまま残ります（名称・席番号のみ変更）</div>
  `;

  openModal({
    title:`席編集（${seat.label}）`,
    sub:"変更 / 削除",
    bodyHtml: body,
    yesText:"変更",
    noText:"閉じる",
    onYes:()=>{
      const typeName = document.getElementById("esType").value.trim() || seat.typeName;
      const label = document.getElementById("esLabel").value.trim().toUpperCase() || seat.label;
      const cap = Math.max(1, parseInt(document.getElementById("esCap").value||String(seat.cap||4),10));

      seat.typeName=typeName;
      seat.label=label;
      seat.cap=cap;
      save();
      closeModal();
      renderSeatPreview();
      renderSeats();
    },
    onNo:()=>{ closeModal(); }
  });

  // Add delete option as extra modal
  setTimeout(()=>{
    const m = modalEl?.querySelector(".body");
    if(!m) return;
    const del = document.createElement("button");
    del.className="btn danger";
    del.style.marginTop="10px";
    del.textContent="削除";
    del.addEventListener("click", ()=>{
      // 12：未会計の注文がなければ即削除
      const hasOpenOrders = (seat.orders||[]).some(o => (o.qty||0) > 0);
      if(hasOpenOrders){
        openModal({title:"未会計の注文があります", sub:"会計後に削除してください", yesText:"OK", one:true, onYes:()=>closeModal()});
        return;
      }
      // if merged into/from, detach
      for(const s of state.seats){
        if(s.mergedInto===seat.id) s.mergedInto=null;
      }
      seat.mergedInto=null;

      state.seats = state.seats.filter(s=>s.id!==seat.id);
      save();
      closeModal();
      renderSeatPreview();
      renderSeats();
    });
    m.appendChild(del);
  },0);
}

document.getElementById("btnSeatRegBack").addEventListener("click", ()=>{
  show("settings");
});
document.getElementById("btnSeatRegBack").addEventListener("click", ()=>{});
document.getElementById("btnSeatRegBack").addEventListener("click", ()=>{});
document.getElementById("btnSeatRegBack").addEventListener("click", ()=>{});
document.getElementById("btnSeatRegBack").addEventListener("click", ()=>{});
document.getElementById("btnSeatRegBack").addEventListener("click", ()=>{});
document.getElementById("btnSeatRegBack").addEventListener("click", ()=>{});

document.getElementById("btnSeatRegBack").addEventListener("click", ()=>{
  show("settings");
});

/* =========================
  Menu Register (20/21/22/23)
========================= */
const mrList = document.getElementById("mrList");
function renderMenuRegister(){
  // list sorted by あいうえお (23)
  const items = [...state.menu].sort((a,b)=> localeSortJa(a.name,b.name));
  mrList.innerHTML = "";
  if(items.length===0){
    mrList.innerHTML = `<div class="row"><div class="l"><div class="a">まだ登録がありません</div><div class="b">上で追加してください</div></div></div>`;
    return;
  }
  for(const m of items){
    const r = document.createElement("div");
    r.className = "row";
    r.innerHTML = `
      <div class="l">
        <div class="a">${escapeHtml(m.name)}</div>
        <div class="b">${escapeHtml(m.category)} / ${escapeHtml(m.genre||"-")} / ${yen(m.price)} / 税${escapeHtml(m.tax)}%</div>
      </div>
      <div class="r">
        <button class="btn smallBtn secondary">編集</button>
      </div>
    `;
    r.querySelector("button").addEventListener("click", ()=> editMenu(m.id));
    mrList.appendChild(r);
  }
}
function editMenu(id){
  const m = state.menu.find(x=>x.id===id);
  if(!m) return;

  const body = `
    <div class="field">
      <label>区分</label>
      <select class="in" id="emCat">
        <option value="料理" ${m.category==="料理"?"selected":""}>料理</option>
        <option value="ドリンク" ${m.category==="ドリンク"?"selected":""}>ドリンク</option>
      </select>
    </div>
    <div class="field">
      <label>ジャンル</label>
      <input class="in" id="emGenre" value="${escapeHtml(m.genre||"")}" />
    </div>
    <div class="field">
      <label>商品名</label>
      <input class="in" id="emName" value="${escapeHtml(m.name||"")}" />
    </div>
    <div class="field">
      <label>価格</label>
      <input class="in" id="emPrice" inputmode="numeric" value="${escapeHtml(m.price||0)}" />
    </div>
    <div class="field">
      <label>税率</label>
      <select class="in" id="emTax">
        <option value="10" ${String(m.tax)==="10"?"selected":""}>10</option>
        <option value="8" ${String(m.tax)==="8"?"selected":""}>8</option>
      </select>
    </div>
  `;
  openModal({
    title:"メニュー編集",
    sub:"変更 / 削除",
    bodyHtml: body,
    yesText:"変更",
    noText:"閉じる",
    onYes:()=>{
      const cat = document.getElementById("emCat").value;
      const genre = document.getElementById("emGenre").value.trim();
      const name = document.getElementById("emName").value.trim();
      const price = parseInt(document.getElementById("emPrice").value||"0",10);
      const tax = parseInt(document.getElementById("emTax").value||"10",10);

      if(!name || !price){
        openModal({title:"商品名と価格を入力してください", sub:"", yesText:"OK", one:true, onYes:()=>closeModal()});
        return;
      }

      // 22：同名禁止（自分以外）
      const exists = state.menu.some(x=> x.id!==m.id && normalizeName(x.name)===normalizeName(name));
      if(exists){
        openModal({
          title:"同じ料理（ドリンク）があります",
          sub:"名前を変えるか、既存の料理（ドリンク）を編集してください。",
          yesText:"OK",
          one:true,
          onYes:()=>closeModal()
        });
        return;
      }

      m.category=cat; m.genre=genre; m.name=name; m.price=price; m.tax=tax;
      save();
      closeModal();
      renderMenuRegister();
    }
  });

  // delete button
  setTimeout(()=>{
    const mbody = modalEl?.querySelector(".body");
    if(!mbody) return;
    const del = document.createElement("button");
    del.className="btn danger";
    del.style.marginTop="10px";
    del.textContent="削除";
    del.addEventListener("click", ()=>{
      state.menu = state.menu.filter(x=>x.id!==m.id);
      save();
      closeModal();
      renderMenuRegister();
    });
    mbody.appendChild(del);
  },0);
}

document.getElementById("mrAdd").addEventListener("click", ()=>{
  const category = document.getElementById("mrCategory").value;
  const genre = document.getElementById("mrGenre").value.trim();
  const name = document.getElementById("mrName").value.trim();
  const price = parseInt(document.getElementById("mrPrice").value||"0",10);
  const tax = parseInt(document.getElementById("mrTax").value||"10",10);

  if(!name){
    openModal({title:"商品名を入力してください", sub:"", yesText:"OK", one:true, onYes:()=>closeModal()});
    return;
  }
  if(!price){
    openModal({title:"価格を入力してください", sub:"未記入は登録できません", yesText:"OK", one:true, onYes:()=>closeModal()});
    return;
  }

  // 22：同名禁止（価格違いでも不可）
  const exists = state.menu.some(x=> normalizeName(x.name)===normalizeName(name));
  if(exists){
    openModal({
      title:"同じ料理（ドリンク）があります",
      sub:"名前を変えるか、既存の料理（ドリンク）を編集してください。",
      yesText:"OK",
      one:true,
      onYes:()=>closeModal()
    });
    return;
  }

  state.menu.push({
    id: crypto.randomUUID ? crypto.randomUUID() : String(nowTs())+Math.random(),
    category, genre, name, price, tax
  });
  save();

  document.getElementById("mrGenre").value="";
  document.getElementById("mrName").value="";
  document.getElementById("mrPrice").value="";
  document.getElementById("mrTax").value="10";

  renderMenuRegister();
});

document.getElementById("mrCsv").addEventListener("click", ()=>{
  // 21：日本語ヘッダー
  const rows = [];
  rows.push(["区分","ジャンル","商品名","価格","税率"].join(","));
  const items = [...state.menu].sort((a,b)=> localeSortJa(a.name,b.name));
  for(const m of items){
    rows.push([m.category, m.genre||"", m.name, m.price, m.tax].map(v=>{
      const s=String(v??"");
      return /[,"\n]/.test(s) ? `"${s.replace(/"/g,'""')}"` : s;
    }).join(","));
  }
  const blob = new Blob([rows.join("\n")], {type:"text/csv;charset=utf-8"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href=url;
  a.download="ONE_メニュー.csv";
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
});

document.getElementById("mrCamera").addEventListener("change", (e)=>{
  // 19：OCR精度は未完成（ここでは疑似候補を出すだけ）
  const f = e.target.files?.[0];
  if(!f) return;

  openModal({
    title:"写真を受け取りました",
    sub:"無料版は誤認識前提です。候補を手直しして登録してください。",
    bodyHtml:`<div class="muted">
      ※OCRは端末やブラウザ制限があるため、無料版では候補の自動入力は簡易です。<br>
      下の入力欄に手動で反映・修正して登録してください。
    </div>`,
    yesText:"OK",
    one:true,
    onYes:()=>closeModal()
  });
});

document.getElementById("mrClearPhoto").addEventListener("click", ()=>{
  const el = document.getElementById("mrCamera");
  el.value = "";
  openModal({title:"写真を消しました", sub:"", yesText:"OK", one:true, onYes:()=>closeModal()});
});

document.getElementById("btnMenuBack").addEventListener("click", ()=>{
  show("settings");
});

/* =========================
  ORDER (7/8/9/23/24)
========================= */
let currentOrderSeatId = null;

function openOrder(seatId){
  const seat = getSeat(seatId);
  if(!seat) return;
  currentOrderSeatId = seatId;

  // header
  document.getElementById("orderHead").textContent = "注文";
  document.getElementById("orderSub").textContent = `席：${seat.label}　${seat.party?.people? `人数：${seat.party.people}名`:""}`;

  // show genres
  document.getElementById("genreArea").style.display="block";
  document.getElementById("itemsArea").style.display="none";

  renderGenres();
  renderOrderList();
  show("order");
}

document.getElementById("btnOrderBack").addEventListener("click", ()=>{
  show("main"); renderSeats();
});
document.getElementById("btnBackToGenres").addEventListener("click", ()=>{
  document.getElementById("genreArea").style.display="block";
  document.getElementById("itemsArea").style.display="none";
});

function renderGenres(){
  const list = document.getElementById("genreList");
  list.innerHTML="";

  // group menu by genre
  const menu = [...state.menu];
  const genres = [...new Set(menu.map(m=> (m.genre||"未分類").trim() || "未分類"))].sort(localeSortJa);

  if(genres.length===0){
    list.innerHTML = `<div class="row"><div class="l"><div class="a">メニューがありません</div><div class="b">設定 → メニュー登録 で追加してください</div></div></div>`;
    return;
  }

  for(const g of genres){
    const r = document.createElement("div");
    r.className="row";
    r.innerHTML = `<div class="l"><div class="a">${escapeHtml(g)}</div><div class="b">タップで商品を表示</div></div><div class="r"></div>`;
    r.addEventListener("click", ()=> openGenre(g));
    list.appendChild(r);
  }
}

function openGenre(genre){
  document.getElementById("genreArea").style.display="none";
  document.getElementById("itemsArea").style.display="block";
  document.getElementById("itemsTitle").textContent = `商品（${genre}）`;

  const grid = document.getElementById("itemsGrid");
  grid.innerHTML="";

  // 23：あいうえお順
  const items = state.menu
    .filter(m=> ((m.genre||"未分類").trim() || "未分類") === genre)
    .sort((a,b)=> localeSortJa(a.name,b.name));

  for(const m of items){
    const c = document.createElement("div");
    c.className="itemCard";
    c.innerHTML = `
      <div class="nm">${escapeHtml(m.name)}</div>
      <div class="pr">${yen(m.price)} / 税${escapeHtml(m.tax)}%</div>
    `;
    c.addEventListener("click", ()=> openQtyPicker(m));
    grid.appendChild(c);
  }
}

function openQtyPicker(menuItem, existingOrderIdx=null){
  // quantity modal center (requested)
  const seat = getSeat(currentOrderSeatId);
  if(!seat) return;

  const curQty = existingOrderIdx!=null ? (seat.orders[existingOrderIdx]?.qty||1) : 1;

  const body = `
    <div class="muted" style="font-weight:900;">${escapeHtml(menuItem.name)}　${yen(menuItem.price)}</div>

    <div class="field" style="margin-top:12px;">
      <label>個数</label>
      <div class="numRow" style="justify-content:center;">
        <button class="stepBtn" id="qMinus">◀︎</button>
        <input class="in numBox" id="qVal" value="${curQty}" readonly />
        <button class="stepBtn" id="qPlus">▶︎</button>
      </div>
    </div>
  `;

  openModal({
    title:"個数を選択",
    sub:"戻る：中止／決定：反映",
    bodyHtml: body,
    yesText:"決定",
    noText:"戻る",
    onYes:()=>{
      const qty = parseInt(document.getElementById("qVal").value||"0",10);
      if(existingOrderIdx!=null){
        if(qty<=0){
          seat.orders.splice(existingOrderIdx,1);
        }else{
          seat.orders[existingOrderIdx].qty = qty;
        }
      }else{
        seat.orders.push({
          id: crypto.randomUUID ? crypto.randomUUID() : String(nowTs())+Math.random(),
          category: menuItem.category,
          name: menuItem.name,
          price: menuItem.price,
          tax: menuItem.tax,
          qty: qty,
          ts: nowTs()
        });
      }
      save();
      closeModal();
      renderOrderList();
    }
  });

  setTimeout(()=>{
    const qEl = document.getElementById("qVal");
    document.getElementById("qMinus")?.addEventListener("click", ()=>{
      let v=parseInt(qEl.value||"1",10);
      v=Math.max(0,v-1);
      qEl.value=v;
    });
    document.getElementById("qPlus")?.addEventListener("click", ()=>{
      let v=parseInt(qEl.value||"1",10);
      v=Math.min(99,v+1);
      qEl.value=v;
    });
  },0);
}

function renderOrderList(){
  const seat = getSeat(currentOrderSeatId);
  if(!seat) return;
  const list = document.getElementById("orderList");
  list.innerHTML = "";

  if(!seat.orders || seat.orders.length===0){
    list.innerHTML = `<div class="row"><div class="l"><div class="a">まだ注文がありません</div><div class="b">商品をタップして追加</div></div></div>`;
    return;
  }

  // show in time order
  const orders = seat.orders.map((o,idx)=>({...o, _idx:idx}));
  for(const o of orders){
    const r = document.createElement("div");
    r.className="row";
    r.innerHTML = `
      <div class="l">
        <div class="a">${escapeHtml(o.name)}　×${escapeHtml(o.qty)}</div>
        <div class="b">${yen(o.price)}　${fmtTime(o.ts||nowTs())}</div>
      </div>
      <div class="r">
        <button class="btn smallBtn secondary">修正</button>
      </div>
    `;
    r.querySelector("button").addEventListener("click", ()=>{
      // edit qty
      const mi = {name:o.name, price:o.price};
      openQtyPicker(mi, o._idx);
    });
    list.appendChild(r);
  }
}

document.getElementById("goCheckout").addEventListener("click", ()=>{
  openCheckout(currentOrderSeatId);
});

/* =========================
  CHECKOUT (15/16)
========================= */
let currentCheckoutSeatId = null;
let currentPayMethod = "cash";

function openCheckout(seatId){
  currentCheckoutSeatId = seatId;
  currentPayMethod = "cash"; // 15：会計に行くたび現金に戻す
  setPayActive();

  const seat = getSeat(seatId);
  if(!seat) return;

  const total = totalSeat(seat);
  document.getElementById("coInfo").textContent =
    `席：${seat.label}　${seat.party?.people? `人数：${seat.party.people}名`:""}`;
  document.getElementById("coTotal").textContent = yen(total);

  renderCheckoutList();
  document.getElementById("splitInfo").textContent = "";
  show("checkout");
}

function renderCheckoutList(){
  const seat = getSeat(currentCheckoutSeatId);
  const list = document.getElementById("coList");
  list.innerHTML="";
  if(!seat) return;

  // include merged children
  const ids = [seat.id, ...state.seats.filter(s=> s.mergedInto===seat.id).map(s=>s.id)];
  const all = [];
  for(const sid of ids){
    const s = getSeat(sid);
    for(const o of (s.orders||[])){
      all.push({seatLabel:s.label, ...o});
    }
  }
  if(all.length===0){
    list.innerHTML = `<div class="row"><div class="l"><div class="a">注文がありません</div></div></div>`;
    return;
  }

  all.forEach((o, idx)=>{
    const r = document.createElement("div");
    r.className="row";
    r.innerHTML = `
      <div class="l">
        <div class="a">${escapeHtml(o.name)} ×${escapeHtml(o.qty)}</div>
        <div class="b">${yen(o.price)}　席:${escapeHtml(o.seatLabel)}</div>
      </div>
      <div class="r">
        <button class="btn smallBtn secondary">修正</button>
      </div>
    `;
    r.querySelector("button").addEventListener("click", ()=>{
      // jump to order view of that seat
      show("order");
      openOrder(seat.id);
    });
    list.appendChild(r);
  });
}

document.getElementById("btnCheckoutBack").addEventListener("click", ()=>{
  show("main"); renderSeats();
});

function setPayActive(){
  document.getElementById("payCash").classList.toggle("active", currentPayMethod==="cash");
  document.getElementById("payCard").classList.toggle("active", currentPayMethod==="card");
  document.getElementById("payQr").classList.toggle("active", currentPayMethod==="qr");
}
document.getElementById("payCash").addEventListener("click", ()=>{ currentPayMethod="cash"; setPayActive(); });
document.getElementById("payCard").addEventListener("click", ()=>{ currentPayMethod="card"; setPayActive(); });
document.getElementById("payQr").addEventListener("click", ()=>{ currentPayMethod="qr"; setPayActive(); });

document.getElementById("btnSplit").addEventListener("click", ()=>{
  const seat = getSeat(currentCheckoutSeatId);
  if(!seat) return;
  const total = totalSeat(seat);
  const p = Math.max(1, parseInt(seat.party?.people||"1",10));
  const each = Math.ceil(total / p);
  document.getElementById("splitInfo").textContent = `1人あたり目安：${yen(each)}（人数：${p}名）`;
});

document.getElementById("btnCheckoutConfirm").addEventListener("click", ()=>{
  const seat = getSeat(currentCheckoutSeatId);
  if(!seat) return;

  const total = totalSeat(seat);
  if(total<=0){
    openModal({title:"合計が0円です", sub:"", yesText:"OK", one:true, onYes:()=>closeModal()});
    return;
  }

  // 16：電子レシート確認→無料版は案内
  openModal({
    title:"電子レシートはいりますか？",
    sub:"◯：送る（無料版は案内）／×：送らない",
    yesText:"◯ 送る",
    noText:"× 送らない",
    onYes:()=>{
      closeModal();
      // free upsell
      openModal({
        title:"電子レシートは有料版の機能です",
        sub:"無料版では送信できません",
        bodyHtml:`<div class="muted">
          有料版で：<br>
          ・店舗情報入り電子レシート送信<br>
          ・履歴管理 など<br><br>
          ※現在、有料版は準備中です
        </div>`,
        yesText:"OK",
        one:true,
        onYes:()=>{
          closeModal();
          finalizeCheckout(seat, total);
        }
      });
    },
    onNo:()=>{
      closeModal();
      finalizeCheckout(seat, total);
    }
  });
});

function finalizeCheckout(seat, total){
  // record sale (simple)
  state.sales.push({
    id: crypto.randomUUID ? crypto.randomUUID() : String(nowTs())+Math.random(),
    ts: nowTs(),
    total,
    payMethod: currentPayMethod,
    // 16：レシートに席番号/人数は載せないが、内部には残す
    internal: { seatLabel: seat.label, people: seat.party?.people||null }
  });

  // clear orders for seat and merged children
  const ids = [seat.id, ...state.seats.filter(s=> s.mergedInto===seat.id).map(s=>s.id)];
  for(const sid of ids){
    const s = getSeat(sid);
    s.orders = [];
    s.mergedInto = null;
    s.status = "empty";
    s.party = null;
    s.openedAt = null;
    s.reservedAt = null;
  }
  save();
  show("main");
  renderSeats();
}

/* =========================
  KITCHEN (25/26/27)
========================= */
const kList = document.getElementById("kList");
document.getElementById("kRefresh").addEventListener("click", ()=> renderKitchen());
document.getElementById("kFood").addEventListener("click", ()=>{
  state.ui.kitchenFilter="food"; save(); renderKitchen();
});
document.getElementById("kDrink").addEventListener("click", ()=>{
  state.ui.kitchenFilter="drink"; save(); renderKitchen();
});

function renderKitchen(){
  // build open orders from active seats (including merged seats)
  const lines = [];
  for(const seat of state.seats){
    if(seat.status!=="active") continue;
    if(seat.mergedInto) continue; // merged children are also active but treated separately - we still need them
    // include self + children
    const ids = [seat.id, ...state.seats.filter(s=>s.mergedInto===seat.id).map(s=>s.id)];
    for(const sid of ids){
      const s = getSeat(sid);
      for(const o of (s.orders||[])){
        lines.push({
          orderId: o.id,
          category: o.category || "料理",
          name: o.name,
          qty: o.qty||1,
          seatLabel: s.label,
          ts: o.ts || nowTs()
        });
      }
    }
  }

  // apply filter
  let filtered = lines;
  if(state.ui.kitchenFilter==="food"){
    filtered = filtered.filter(x=> x.category==="料理");
  }else if(state.ui.kitchenFilter==="drink"){
    filtered = filtered.filter(x=> x.category==="ドリンク");
  }

  // separate food/drink because 27: drink not grouped
  const food = filtered.filter(x=> x.category==="料理");
  const drink = filtered.filter(x=> x.category==="ドリンク");

  // 25: food grouping (no qty aggregation) - show promoted parent + children
  const foodGroups = new Map();
  for(const ln of food){
    const key = normalizeName(ln.name);
    if(!foodGroups.has(key)) foodGroups.set(key, []);
    foodGroups.get(key).push(ln);
  }

  // sort each group by time asc
  for(const arr of foodGroups.values()){
    arr.sort((a,b)=> (a.ts-b.ts) || localeSortJa(a.seatLabel,b.seatLabel));
  }

  // create display blocks
  const blocks = [];

  // food: if group size >=2 => promoted parent is first; else single normal
  for(const [k, arr] of foodGroups.entries()){
    if(arr.length>=2){
      blocks.push({
        kind:"foodGroup",
        ts: arr[0].ts,
        name: arr[0].name,
        parent: arr[0],
        children: arr.slice(1)
      });
    }else{
      blocks.push({
        kind:"single",
        ts: arr[0].ts,
        item: arr[0]
      });
    }
  }

  // drink: no grouping, each as single
  for(const d of drink){
    blocks.push({ kind:"single", ts:d.ts, item:d, drink:true });
  }

  // sort blocks by time asc; tie-break by name, seat
  blocks.sort((a,b)=>{
    if(a.ts!==b.ts) return a.ts-b.ts;
    const an = a.kind==="foodGroup" ? a.name : a.item.name;
    const bn = b.kind==="foodGroup" ? b.name : b.item.name;
    const c = localeSortJa(an,bn);
    if(c!==0) return c;
    const as = a.kind==="foodGroup" ? a.parent.seatLabel : a.item.seatLabel;
    const bs = b.kind==="foodGroup" ? b.parent.seatLabel : b.item.seatLabel;
    return localeSortJa(as,bs);
  });

  // render
  kList.innerHTML="";
  if(blocks.length===0){
    kList.innerHTML = `<div class="muted">注文はありません</div>`;
    return;
  }

  for(const b of blocks){
    if(b.kind==="foodGroup"){
      const parent = b.parent;
      const elapsedMin = Math.floor((nowTs()-parent.ts)/60000);
      const late = elapsedMin>=15;
      const card = document.createElement("div");
      card.className = "kCard kPromoted";
      card.innerHTML = `
        <div class="kRow">
          <div>
            <div class="kName">${escapeHtml(parent.name)} <span class="kQty">${escapeHtml(parent.qty)}個</span></div>
            <div class="kMeta">
              ${escapeHtml(parent.seatLabel)}　${escapeHtml(fmtTime(parent.ts))}　
              <span class="${late?"late":""}">${elapsedMin}分</span>
            </div>
          </div>
          <div></div>
        </div>

        <div class="kSliderWrap">
          <input class="kSlider" type="range" min="0" max="100" value="0" data-order="${escapeHtml(parent.orderId)}" />
        </div>

        <div class="kChild" id="childWrap"></div>
      `;

      const childWrap = card.querySelector("#childWrap");
      for(const ch of b.children){
        const eMin = Math.floor((nowTs()-ch.ts)/60000);
        const isLate = eMin>=15;
        const row = document.createElement("div");
        row.style.marginTop="6px";
        row.innerHTML = `
          <div class="kRow">
            <div>
              <div class="kName" style="font-size:16px;">${escapeHtml(ch.name)} <span class="kQty">${escapeHtml(ch.qty)}個</span></div>
              <div class="kMeta">
                ${escapeHtml(ch.seatLabel)}　${escapeHtml(fmtTime(ch.ts))}　
                <span class="${isLate?"late":""}">${eMin}分</span>
              </div>
            </div>
            <div></div>
          </div>
          <div class="kSliderWrap">
            <input class="kSlider" type="range" min="0" max="100" value="0" data-order="${escapeHtml(ch.orderId)}" />
          </div>
        `;
        childWrap.appendChild(row);
      }

      kList.appendChild(card);
    }else{
      const it = b.item;
      const elapsedMin = Math.floor((nowTs()-it.ts)/60000);
      const late = elapsedMin>=15;
      const card = document.createElement("div");
      card.className = "kCard";
      card.innerHTML = `
        <div class="kRow">
          <div>
            <div class="kName">${escapeHtml(it.name)} <span class="kQty">${escapeHtml(it.qty)}個</span></div>
            <div class="kMeta">
              ${escapeHtml(it.seatLabel)}　${escapeHtml(fmtTime(it.ts))}　
              <span class="${late?"late":""}">${elapsedMin}分</span>
              ${b.drink ? `<span class="muted">（ドリンク）</span>`:""}
            </div>
          </div>
          <div></div>
        </div>
        <div class="kSliderWrap">
          <input class="kSlider" type="range" min="0" max="100" value="0" data-order="${escapeHtml(it.orderId)}" />
        </div>
      `;
      kList.appendChild(card);
    }
  }

  // slider handling (26)
  kList.querySelectorAll(".kSlider").forEach(sl=>{
    sl.addEventListener("input", ()=>{
      if(parseInt(sl.value,10) >= 95){
        const oid = sl.getAttribute("data-order");
        completeKitchenOrder(oid);
      }
    });
  });
}

function completeKitchenOrder(orderId){
  // remove only that order line; regroup automatically next render
  for(const seat of state.seats){
    for(const o of (seat.orders||[])){
      if(o.id===orderId){
        seat.orders = (seat.orders||[]).filter(x=>x.id!==orderId);
        save();
        renderKitchen();
        return;
      }
    }
  }
}

/* =========================
  SALES (simple)
========================= */
function renderSales(mode){
  document.getElementById("salesTitle").textContent = "売上";
  document.getElementById("salesBody").textContent = `本日の売上件数：${state.sales.length}（無料版は簡易表示）`;
}
document.getElementById("btnSalesBack").addEventListener("click", ()=>{ show("main"); renderSeats(); });
document.getElementById("goMonthly").addEventListener("click", ()=>{
  document.getElementById("salesTitle").textContent="月売上";
  document.getElementById("salesBody").textContent="※無料版は簡易表示（今後拡張）";
});
document.getElementById("goYearly").addEventListener("click", ()=>{
  document.getElementById("salesTitle").textContent="年売上";
  document.getElementById("salesBody").textContent="※無料版は簡易表示（今後拡張）";
});
document.getElementById("goSalesMgmt").addEventListener("click", ()=>{
  document.getElementById("salesTitle").textContent="売上管理";
  document.getElementById("salesBody").textContent="※無料版は簡易表示（今後拡張）";
});
document.getElementById("btnTodaySales").addEventListener("click", ()=>{
  show("sales"); renderSales("top");
});

/* =========================
  Initial navigation buttons
========================= */
document.getElementById("btnSeatRegBack").addEventListener("click", ()=>{
  show("settings");
});
document.getElementById("btnSeatRegBack").addEventListener("click", ()=>{});

/* Fix duplicate accidental listeners above: ignore (harmless) */

/* =========================
  Buttons
========================= */
document.getElementById("btnSeatRegBack").addEventListener("click", ()=>{
  show("settings");
});
document.getElementById("btnMenuBack").addEventListener("click", ()=>{
  show("settings");
});
document.getElementById("btnToMainFromSettings").addEventListener("click", ()=>{
  show("main"); renderSeats();
});

document.getElementById("btnSettings").addEventListener("click", ()=>{
  show("settings");
});

/* =========================
  Boot
========================= */
function boot(){
  // default seats if none (optional) -> keep none
  renderSeats();
  renderMenuRegister();

  // if restore view
  if(state.ui.view && state.ui.view!=="main"){
    show(state.ui.view);
  }

  // keep top center label
  if(state.ui.view==="kitchen"){
    btnTopCenter.textContent="ホール";
    renderKitchen();
  }else{
    btnTopCenter.textContent="キッチン";
  }
}
boot();
</script>
</body>
</html>