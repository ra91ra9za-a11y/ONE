<!-- =========================
  ONE 無料版（最新版仕様）- PART 1/6
  役割：HTML骨組み + CSS（見た目）
  まだ動き（JS）はPART2以降
========================= -->

<style>
  :root{
    --bg:#0b1220;
    --panel:#0f1a2e;
    --card:#111c33;
    --text:#f8fafc;
    --sub:#b6c2d6;
    --line:rgba(148,163,184,.22);
    --primary:#3b82f6;
    --ok:#22c55e;
    --warn:#ef4444;
    --accent:#f59e0b;
    --purple:#a78bfa;
  }
  *{ box-sizing:border-box; -webkit-tap-highlight-color: transparent; }
  html,body{ height:100%; }
  body{
    margin:0;
    font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,"Hiragino Kaku Gothic ProN","Noto Sans JP",sans-serif;
    background:linear-gradient(180deg, var(--bg), #060b15);
    color:var(--text);
    overscroll-behavior:none;
    touch-action: manipulation;
  }
  a,button,input,select,textarea{ touch-action: manipulation; }
  .hidden{ display:none !important; }

  /* iOSのズーム防止（user-scalable=no と併用前提） */
  input,select,textarea{ font-size:16px; }

  .topbar{
    position:sticky; top:0; z-index:50;
    background:rgba(6,11,21,.9);
    border-bottom:1px solid var(--line);
    backdrop-filter: blur(10px);
    padding:10px 12px;
    display:grid;
    grid-template-columns: 1fr auto 1fr;
    gap:8px; align-items:center;
  }
  .brand{ font-weight:900; font-size:20px; letter-spacing:.6px; }
  .top-center-btn{
    justify-self:center;
    border:1px solid rgba(59,130,246,.25);
    background:rgba(59,130,246,.15);
    color:var(--text);
    font-weight:900;
    padding:10px 14px;
    border-radius:14px;
    min-width:120px;
  }
  .top-right{ justify-self:end; display:flex; gap:8px; }

  .wrap{ padding:12px; max-width:780px; margin:0 auto; }
  .title{ font-weight:900; font-size:18px; margin:10px 0 6px; }
  .subtle{ color:var(--sub); font-size:12px; line-height:1.4; }
  .divider{ height:1px; background:var(--line); margin:12px 0; }
  .bottom-safe{ height:18px; }

  .btn{
    border:1px solid var(--line);
    background:rgba(255,255,255,.03);
    color:var(--text);
    padding:12px 12px;
    border-radius:16px;
    font-weight:900;
    font-size:16px;
  }
  .btn.small{ padding:10px 10px; font-size:14px; border-radius:14px; }
  .btn.full{ width:100%; }
  .btn.primary{ background:rgba(59,130,246,.18); border-color:rgba(59,130,246,.35); }
  .btn.ok{ background:rgba(34,197,94,.18); border-color:rgba(34,197,94,.35); }
  .btn.warn{ background:rgba(239,68,68,.18); border-color:rgba(239,68,68,.35); }
  .btn.accent{ background:rgba(245,158,11,.16); border-color:rgba(245,158,11,.33); }

  .btnrow4{ display:grid; grid-template-columns: repeat(4,1fr); gap:10px; margin:12px 0 8px; }
  .btnrow2{ display:grid; grid-template-columns: repeat(2,1fr); gap:10px; margin:10px 0; }

  .twoline{ display:flex; flex-direction:column; gap:2px; align-items:center; justify-content:center; line-height:1.05; }
  .twoline span:first-child{ font-size:12px; opacity:.95; }
  .twoline span:last-child{ font-size:16px; font-weight:900; }

  input,select,textarea{
    width:100%;
    padding:12px;
    border-radius:16px;
    border:1px solid var(--line);
    background:rgba(255,255,255,.03);
    color:var(--text);
    outline:none;
  }
  textarea{ resize:vertical; }
  .field{ display:grid; gap:8px; margin:10px 0; }
  .label{ font-weight:900; font-size:13px; color:#dbeafe; }
  .note{ color:var(--sub); font-size:12px; white-space:pre-line; margin-top:8px; }

  /* 席カード */
  .seats-grid{
    display:grid;
    grid-template-columns: repeat(3, 1fr);
    gap:10px;
    margin-top:12px;
  }
  .seat{
    position:relative;
    background:rgba(255,255,255,.03);
    border:1px solid var(--line);
    border-radius:18px;
    padding:10px;
    min-height:100px;
    display:flex;
    flex-direction:column;
    justify-content:space-between;
  }
  .seat.selected{ outline:3px solid rgba(147,197,253,.45); border-color:rgba(147,197,253,.55); }
  .seat.merged{ background:rgba(167,139,250,.10); border-color:rgba(167,139,250,.28); }
  .seat-no{ font-weight:900; font-size:22px; line-height:1.1; white-space:pre-line; }
  .seat-meta{ color:var(--sub); font-size:12px; white-space:pre-line; margin-top:6px; }
  .seat-money{ font-weight:900; font-size:15px; margin-top:6px; }

  .badge{
    position:absolute; right:10px; top:10px;
    font-size:11px; font-weight:900;
    padding:4px 8px; border-radius:999px;
    border:1px solid var(--line);
    background:rgba(255,255,255,.04);
    color:var(--text);
  }
  .badge.reserve{ border-color:rgba(251,146,60,.35); background:rgba(251,146,60,.14); color:#ffd8b4; }
  .badge.merged{ border-color:rgba(167,139,250,.35); background:rgba(167,139,250,.14); color:#ede9fe; }

  /* 設定カード */
  .card-list{ display:grid; grid-template-columns: repeat(2,1fr); gap:12px; margin-top:12px; }
  .nav-card{
    background:rgba(255,255,255,.03);
    border:1px solid var(--line);
    border-radius:18px;
    padding:14px;
    min-height:90px;
    display:flex;
    flex-direction:column;
    justify-content:space-between;
  }
  .nav-title{ font-weight:900; font-size:16px; }
  .nav-sub{ color:var(--sub); font-size:12px; margin-top:6px; }

  /* 注文UI */
  .pill-row{ display:flex; gap:8px; flex-wrap:wrap; margin:10px 0 12px; }
  .pill{
    border:1px solid var(--line);
    background:rgba(255,255,255,.03);
    color:var(--text);
    padding:10px 12px;
    border-radius:999px;
    font-weight:900;
    font-size:14px;
  }
  .pill.active{ background:rgba(59,130,246,.18); border-color:rgba(59,130,246,.35); }

  .menu-grid{ display:grid; grid-template-columns: repeat(2, 1fr); gap:10px; }
  .item{
    background:rgba(255,255,255,.03);
    border:1px solid var(--line);
    border-radius:18px;
    padding:12px;
    min-height:74px;
    display:flex;
    flex-direction:column;
    justify-content:space-between;
  }
  .item-name{ font-weight:900; font-size:16px; }
  .item-sub{ color:var(--sub); font-size:12px; margin-top:6px; }

  .panel{
    background:rgba(255,255,255,.03);
    border:1px solid var(--line);
    border-radius:18px;
    padding:10px;
    margin-top:12px;
  }
  .order-row{
    display:grid;
    grid-template-columns: 1fr auto;
    gap:10px;
    padding:12px 8px;
    border-bottom:1px dashed rgba(226,232,240,.25);
    align-items:center;
  }
  .order-row:last-child{ border-bottom:none; }
  .order-name{ font-weight:900; font-size:16px; }
  .order-sub{ color:var(--sub); font-size:12px; margin-top:2px; }

  /* モーダル（中央表示） */
  .overlay{
    position:fixed; inset:0; z-index:80;
    background:rgba(0,0,0,.55);
    display:flex; align-items:center; justify-content:center;
    padding:16px;
  }
  .modal{
    width:100%; max-width:540px;
    background:linear-gradient(180deg, rgba(17,28,51,.98), rgba(10,16,30,.98));
    border:1px solid var(--line);
    border-radius:22px;
    padding:14px;
    box-shadow:0 18px 40px rgba(0,0,0,.35);
  }
  .modal-title{ font-weight:900; font-size:18px; margin-bottom:8px; }
  .modal-sub{ color:var(--sub); font-size:13px; margin-bottom:12px; white-space:pre-line; }
  .modal-body{ margin:10px 0 14px; }
  .modal-actions{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; }

  /* キッチン */
  .kitchen-list{ margin-top:12px; display:grid; gap:10px; }
  .ticket{
    background:rgba(255,255,255,.03);
    border:1px solid var(--line);
    border-radius:18px;
    padding:12px;
    display:grid;
    grid-template-columns: 1fr auto;
    gap:12px;
    align-items:center;
  }
  .ticket-name{ font-weight:900; font-size:20px; line-height:1.15; }
  .ticket-name.overdue{ color:var(--warn); }
  .ticket-sub{ margin-top:6px; color:var(--sub); font-size:12px; white-space:pre-line; }

  /* 短く太いスライドバー（文字なし） */
  input[type="range"].slider{
    width:140px; height:30px;
    -webkit-appearance:none; appearance:none;
    background:rgba(226,232,240,.18);
    border-radius:999px;
    outline:none;
    border:1px solid rgba(203,213,225,.25);
  }
  input[type="range"].slider::-webkit-slider-thumb{
    -webkit-appearance:none; appearance:none;
    width:34px; height:34px;
    border-radius:50%;
    background:rgba(34,197,94,.95);
    border:2px solid rgba(255,255,255,.8);
    box-shadow:0 10px 22px rgba(0,0,0,.35);
  }/* ===== スマホ実機向け 強制スケール調整 ===== */
html {
  font-size: 18px;
}

body {
  -webkit-text-size-adjust: 100%;
  text-size-adjust: 100%;
}

/* ボタン */
button {
  font-size: 1.1rem;
  padding: 14px 16px;
}

/* メイン操作ボタン */
.nav button,
.main-actions button {
  font-size: 1.15rem;
  min-height: 52px;
}

/* 席カード */
.seat {
  font-size: 1.05rem;
}

/* 見出し */
h1, h2, h3 {
  font-size: 1.2rem;
}
</style>

<!-- 画面 -->
<div id="appRoot">

  <!-- Topbar MAIN -->
  <div id="topbarMain" class="topbar">
    <div class="brand">ONE</div>
    <button class="top-center-btn" id="btnKitchen">キッチン</button>
    <div class="top-right">
      <button class="btn small primary" id="btnBackupTop">バックアップ</button>
    </div>
  </div>

  <!-- Topbar SUB -->
  <div id="topbarSub" class="topbar hidden">
    <div class="brand">ONE</div>
    <button class="top-center-btn" id="btnMainTop">メイン</button>
    <div class="top-right">
      <button class="btn small primary" id="btnMainTopR">メイン</button>
    </div>
  </div>

  <div class="wrap">

    <!-- MAIN -->
    <section id="viewMain">
      <div class="title">席</div>
      <div class="subtle">席をタップして選択 → 「決定」で注文へ（空席は来店/予約）。合算/分割は専用ボタンのみ。</div>

      <div id="seatGrid" class="seats-grid"></div>

      <div class="btnrow4">
        <button class="btn full" id="btnSeatMove">席移動</button>
        <button class="btn full primary" id="btnMerge"><div class="twoline"><span>合計</span><span>合算</span></div></button>
        <button class="btn full accent" id="btnSplit"><div class="twoline"><span>合計</span><span>分割</span></div></button>
        <button class="btn full ok" id="btnDecide">決定</button>
      </div>

      <div class="btnrow2">
        <button class="btn full" id="btnSalesToday">本日の売上</button>
        <button class="btn full" id="btnSettings">設定</button>
      </div>

      <div class="bottom-safe"></div>
    </section>

    <!-- SETTINGS -->
    <section id="viewSettings" class="hidden">
      <div class="title">設定</div>
      <div class="subtle">無料版（最新版仕様）</div>

      <div class="card-list">
        <div class="nav-card" id="navSeatRegister">
          <div class="nav-title">席登録</div>
          <div class="nav-sub">作成 / 編集 / 削除（売上データ保持）</div>
        </div>
        <div class="nav-card" id="navMenuRegister">
          <div class="nav-title">メニュー登録</div>
          <div class="nav-sub">カメラOCR / カテゴリー（料理・ドリンク）</div>
        </div>
        <div class="nav-card" id="navSales">
          <div class="nav-title">売上</div>
          <div class="nav-sub">月 / 年 / 管理</div>
        </div>
        <div class="nav-card" id="navStoreInfo">
          <div class="nav-title">店舗情報</div>
          <div class="nav-sub">無料版は簡易メモ</div>
        </div>
        <div class="nav-card" id="navSuggest">
          <div class="nav-title">料理提案</div>
          <div class="nav-sub">無料版はプレースホルダ</div>
        </div>
        <div class="nav-card" id="navContact">
          <div class="nav-title">お問合せ</div>
          <div class="nav-sub">メモ</div>
        </div>
      </div>

      <div class="btnrow2" style="margin-top:14px;">
        <button class="btn full" id="btnMainFromSettings">メイン</button>
        <button class="btn full primary" id="btnBackupFromSettings">バックアップ</button>
      </div>

      <div class="bottom-safe"></div>
    </section>

    <!-- SEAT REGISTER -->
    <section id="viewSeatRegister" class="hidden">
      <div class="title">席登録</div>
      <div class="subtle">席の名称 → 総席(卓)数 → 席番号 → 最大着席人数。重複席番号は確認。</div>

      <div class="field">
        <div class="label">席の名称</div>
        <select id="srType">
          <option value="counter">カウンター</option>
          <option value="stand">立ち</option>
          <option value="table">テーブル</option>
          <option value="zashiki">座敷</option>
          <option value="private">個室</option>
          <option value="other">その他</option>
        </select>
      </div>

      <div id="srOtherWrap" class="field hidden">
        <div class="label">その他の名称（次回から一覧に追加）</div>
        <input id="srOtherName" placeholder="例：テラス" />
        <button class="btn small primary" id="btnSaveOtherName">名称を保存</button>
      </div>

      <div class="field">
        <div class="label" id="srCountLabel">総席数</div>
        <input id="srTotal" type="number" min="1" placeholder="例：10" />
      </div>

      <div class="field">
        <div class="label">席(卓)番号（1つ目）</div>
        <input id="srLabel" placeholder="例：1 / A / C1" />
        <div class="note">入力後、次の席(卓)候補が自動で入ります（例：1→2 / A→B / C1→C2）</div>
      </div>

      <div class="field">
        <div class="label">最大着席人数（デフォルト）</div>
        <input id="srCapDefault" type="number" min="1" placeholder="カウンター/立ちは1、他は4" />
      </div>

      <div class="btnrow2">
        <button class="btn full ok" id="btnCreateSeats">決定</button>
        <button class="btn full" id="btnResetSeatReg">削除（入力を初期化）</button>
      </div>

      <div class="divider"></div>
      <div class="title">作成済の席（タップで編集）</div>
      <div id="srCreatedSeatGrid" class="seats-grid"></div>

      <div class="btnrow2" style="margin-top:14px;">
        <button class="btn full" id="btnMainFromSeatReg">メイン</button>
        <button class="btn full primary" id="btnSettingsFromSeatReg">設定</button>
      </div>
      <div class="bottom-safe"></div>
    </section>

    <!-- MENU REGISTER -->
    <section id="viewMenuRegister" class="hidden">
      <div class="title">メニュー登録</div>
      <div class="subtle">無料版でもカメラOCR（自動文字起こし）を使えます。写真は「写真を消す」で破棄。</div>

      <div class="field">
        <div class="label">カテゴリー</div>
        <select id="mrCategory">
          <option value="food">料理</option>
          <option value="drink">ドリンク</option>
        </select>
      </div>

      <div class="field">
        <div class="label">ジャンル</div>
        <input id="mrGenre" placeholder="例：揚げ物 / ビール" />
      </div>

      <div class="field">
        <div class="label">商品名</div>
        <input id="mrName" placeholder="例：唐揚げ" />
      </div>

      <div class="field">
        <div class="label">価格</div>
        <input id="mrPrice" type="number" min="0" placeholder="例：600" />
      </div>

      <div class="btnrow2">
        <button class="btn full ok" id="btnAddMenu">登録</button>
        <button class="btn full" id="btnClearMenuInputs">入力クリア</button>
      </div>

      <div class="divider"></div>
      <div class="title">カメラで登録（OCR）</div>
      <input id="mrPhoto" type="file" accept="image/*" capture="environment" />
      <div class="btnrow2" style="margin-top:10px;">
        <button class="btn full primary" id="btnOcr">写真から文字起こし</button>
        <button class="btn full warn" id="btnPhotoClear">写真を消す</button>
      </div>
      <div class="panel">
        <div class="subtle">OCR結果（必要なら修正して登録）</div>
        <textarea id="mrOcrText" rows="6" placeholder="ここにOCR結果が表示されます"></textarea>
        <div class="btnrow2" style="margin-top:10px;">
          <button class="btn full ok" id="btnOcrToFields">OCRを入力欄へ反映</button>
          <button class="btn full" id="btnOcrClear">OCR結果クリア</button>
        </div>
      </div>

      <div class="divider"></div>
      <div class="title">登録済メニュー</div>
      <div id="mrMenuList" class="panel"></div>

      <div class="btnrow2" style="margin-top:14px;">
        <button class="btn full" id="btnMainFromMenuReg">メイン</button>
        <button class="btn full primary" id="btnSettingsFromMenuReg">設定</button>
      </div>
      <div class="bottom-safe"></div>
    </section>

    <!-- ORDER -->
    <section id="viewOrder" class="hidden">
      <div class="title" id="orderTitle">注文</div>
      <div class="subtle">ジャンルを選ぶ → 商品を選ぶ → 数量を中央で入力。履歴は下に表示。</div>

      <div class="pill-row" id="genreRow"></div>
      <div class="menu-grid" id="menuGrid"></div>

      <div class="panel">
        <div class="title" style="margin:6px 0;">注文履歴</div>
        <div id="orderList"></div>
      </div>

      <div class="btnrow2" style="margin-top:14px;">
        <button class="btn full primary" id="btnToCheckout">会計</button>
        <button class="btn full" id="btnMainFromOrder">メイン</button>
      </div>
      <div class="bottom-safe"></div>
    </section>

    <!-- CHECKOUT -->
    <section id="viewCheckout" class="hidden">
      <div class="title">会計</div>
      <div class="subtle">会計確定 → 電子レシートの要否を確認します。</div>

      <div class="panel">
        <div class="title" id="coSeatLabel" style="margin:6px 0;">席</div>
        <div id="coPeople" class="subtle"></div>
        <div id="coTotal" style="font-weight:900; font-size:26px; margin-top:8px;">合計 ¥0</div>
      </div>

      <div class="panel">
        <div class="label">支払い方法</div>
        <select id="coPayMethod">
          <option value="cash">現金</option>
          <option value="card">カード</option>
          <option value="qr">QR</option>
          <option value="other">その他</option>
        </select>

        <div class="btnrow2" style="margin-top:12px;">
          <button class="btn full" id="btnSplitBill">割り勘</button>
          <button class="btn full ok" id="btnCheckoutConfirm">会計確定</button>
        </div>
      </div>

      <div class="panel">
        <div class="title" style="margin:6px 0;">注文一覧（修正）</div>
        <div id="coOrderList"></div>
      </div>

      <div class="btnrow2" style="margin-top:14px;">
        <button class="btn full" id="btnBackToOrder">戻る</button>
        <button class="btn full primary" id="btnMainFromCheckout">メイン</button>
      </div>
      <div class="bottom-safe"></div>
    </section>

    <!-- KITCHEN -->
    <section id="viewKitchen" class="hidden">
      <div class="title">ホール</div>
      <div class="subtle">注文順に表示。15分超で赤。完了はスライド。</div>

      <div class="btnrow2">
        <button class="btn full primary" id="btnKitchenRefresh">更新</button>
        <button class="btn full" id="btnKitchenHall">ホール</button>
      </div>

      <div class="btnrow2">
        <button class="btn full" id="btnKitchenFood">料理</button>
        <button class="btn full" id="btnKitchenDrink">ドリンク</button>
      </div>

      <div id="kitchenList" class="kitchen-list"></div>

      <div class="btnrow2" style="margin-top:14px;">
        <button class="btn full" id="btnMainFromKitchen">メイン</button>
        <button class="btn full primary" id="btnMenuFromKitchen">メニュー登録</button>
      </div>
      <div class="bottom-safe"></div>
    </section>

    <!-- SALES -->
    <section id="viewSales" class="hidden">
      <div class="title">売上</div>
      <div class="subtle">月売上 / 年売上 / 売上管理</div>

      <div class="btnrow2">
        <button class="btn full" id="btnSalesMonth">月売上</button>
        <button class="btn full" id="btnSalesYear">年売上</button>
      </div>
      <div class="btnrow2">
        <button class="btn full" id="btnSalesManage">売上管理</button>
        <button class="btn full primary" id="btnMainFromSales">メイン</button>
      </div>

      <div class="bottom-safe"></div>
    </section>

    <section id="viewSalesMonth" class="hidden">
      <div class="title">月売上</div>
      <div class="btnrow2">
        <button class="btn full" id="btnToSalesYearFromMonth">年売上</button>
        <button class="btn full" id="btnToSalesManageFromMonth">売上管理</button>
      </div>
      <div id="salesMonthBody" class="panel"></div>
      <div class="btnrow2" style="margin-top:14px;">
        <button class="btn full primary" id="btnMainFromSalesMonth">メイン</button>
        <button class="btn full" id="btnBackSalesFromMonth">売上</button>
      </div>
      <div class="bottom-safe"></div>
    </section>

    <section id="viewSalesYear" class="hidden">
      <div class="title">年売上</div>
      <div class="btnrow2">
        <button class="btn full" id="btnToSalesMonthFromYear">月売上</button>
        <button class="btn full" id="btnToSalesManageFromYear">売上管理</button>
      </div>
      <div id="salesYearBody" class="panel"></div>
      <div class="btnrow2" style="margin-top:14px;">
        <button class="btn full primary" id="btnMainFromSalesYear">メイン</button>
        <button class="btn full" id="btnBackSalesFromYear">売上</button>
      </div>
      <div class="bottom-safe"></div>
    </section>

    <section id="viewSalesManage" class="hidden">
      <div class="title">売上管理</div>
      <div class="btnrow2">
        <button class="btn full" id="btnToSalesMonthFromManage">月売上</button>
        <button class="btn full" id="btnToSalesYearFromManage">年売上</button>
      </div>
      <div id="salesManageBody" class="panel"></div>
      <div class="btnrow2" style="margin-top:14px;">
        <button class="btn full primary" id="btnMainFromSalesManage">メイン</button>
        <button class="btn full" id="btnBackSalesFromManage">売上</button>
      </div>
      <div class="bottom-safe"></div>
    </section>

    <!-- BACKUP -->
    <section id="viewBackup" class="hidden">
      <div class="title">バックアップ</div>
      <div class="subtle">JSONで書き出し / 読み込み（無料版）</div>

      <div class="btnrow2">
        <button class="btn full ok" id="btnExport">書き出し</button>
        <button class="btn full" id="btnImport">読み込み</button>
      </div>

      <div class="panel">
        <div class="subtle">バックアップJSON</div>
        <textarea id="backupText" rows="10" placeholder="ここにJSONが表示されます / ここに貼って読み込みます"></textarea>
      </div>

      <div class="btnrow2" style="margin-top:14px;">
        <button class="btn full primary" id="btnMainFromBackup">メイン</button>
        <button class="btn full" id="btnSettingsFromBackup">設定</button>
      </div>
      <div class="bottom-safe"></div>
    </section>

    <!-- STORE INFO -->
    <section id="viewStoreInfo" class="hidden">
      <div class="title">店舗情報</div>
      <div class="panel">
        <textarea id="storeInfoText" rows="10" placeholder="無料版：メモ（店舗情報）"></textarea>
      </div>
      <div class="btnrow2" style="margin-top:14px;">
        <button class="btn full primary" id="btnMainFromStoreInfo">メイン</button>
        <button class="btn full" id="btnSettingsFromStoreInfo">設定</button>
      </div>
      <div class="bottom-safe"></div>
    </section>

    <!-- SUGGEST (placeholder) -->
    <section id="viewSuggest" class="hidden">
      <div class="title">料理提案</div>
      <div class="panel">
        <div class="subtle">無料版：プレースホルダ（将来：店舗材料・季節から提案）</div>
      </div>
      <div class="btnrow2" style="margin-top:14px;">
        <button class="btn full primary" id="btnMainFromSuggest">メイン</button>
        <button class="btn full" id="btnSettingsFromSuggest">設定</button>
      </div>
      <div class="bottom-safe"></div>
    </section>

    <!-- CONTACT -->
    <section id="viewContact" class="hidden">
      <div class="title">お問合せ</div>
      <div class="panel">
        <textarea id="contactText" rows="10" placeholder="メモ（問い合わせ内容・要望など）"></textarea>
      </div>
      <div class="btnrow2" style="margin-top:14px;">
        <button class="btn full primary" id="btnMainFromContact">メイン</button>
        <button class="btn full" id="btnSettingsFromContact">設定</button>
      </div>
      <div class="bottom-safe"></div>
    </section>

  </div><!-- /wrap -->
</div><!-- /appRoot -->

<!-- モーダル領域（JSで生成） -->
<div id="modalRoot" class="hidden"></div>
<!-- =========================
  ONE 無料版（最新版仕様）- PART 2/6
  役割：JS土台（state / save-load / util / modal / view切替）
  ※ まだ席登録・注文などの本体ロジックはPART3以降
========================= -->

<script>
/* ========= 基本 ========= */
const LS_KEY = "ONE_FREE_V1";

/* ========= state =========
  seats: [
    { id, label, areaType, areaName, cap, status:'empty'|'active'|'reserve', party:{people,name,phone}, openedAt, orders:[...], mergedInto:null|seatId, updatedAt }
  ]
  menus: [
    { id, category:'food'|'drink', genre, name, price }
  ]
  sales: [
    { id, at, seatLabel, seatId, total, payMethod, items:[{name,qty,price}], emailReceipt?:{to, note} }
  ]
  seatHistory: [
    { id, at, type:'delete'|'rename', fromLabel, toLabel, seatId, reason }
  ]
*/
let state = {
  seats: [],
  menus: [],
  sales: [],
  seatHistory: [],
  otherSeatNames: [],   // 「その他」で保存した名称
  ui: {
    view: "viewMain",
    selectedSeatIds: [],
    orderBaseSeatId: null, // 注文している“代表”席（合算後の基準）
    activeGenre: null,
    kitchenFilter: "all", // all | food | drink
    kitchenDone: {},      // orderItemId:true（完了済み）
  }
};

/* ========= ユーティリティ ========= */
function nowTs(){ return Date.now(); }

function pad2(n){ return String(n).padStart(2,"0"); }
function formatHM(ts){
  const d = new Date(ts);
  return `${pad2(d.getHours())}:${pad2(d.getMinutes())}`;
}
function yen(n){
  const x = Number(n||0);
  return "¥" + x.toLocaleString("ja-JP");
}
function uid(prefix="id"){
  return prefix + "_" + Math.random().toString(16).slice(2) + "_" + Date.now();
}

function deepClone(obj){
  return JSON.parse(JSON.stringify(obj));
}

function save(){
  try{
    localStorage.setItem(LS_KEY, JSON.stringify(state));
  }catch(e){
    console.warn("save failed", e);
  }
}
function load(){
  try{
    const raw = localStorage.getItem(LS_KEY);
    if(raw){
      const parsed = JSON.parse(raw);
      // 安全に最低限マージ
      state = Object.assign(deepClone(state), parsed);
      state.ui = Object.assign(deepClone(state.ui), parsed.ui||{});
    }
  }catch(e){
    console.warn("load failed", e);
  }
}

/* ========= 画面切替 ========= */
const VIEW_IDS = [
  "viewMain",
  "viewSettings",
  "viewSeatRegister",
  "viewMenuRegister",
  "viewOrder",
  "viewCheckout",
  "viewKitchen",
  "viewSales",
  "viewSalesMonth",
  "viewSalesYear",
  "viewSalesManage",
  "viewBackup",
  "viewStoreInfo",
  "viewSuggest",
  "viewContact"
];

function showView(id){
  VIEW_IDS.forEach(v=>{
    const el = document.getElementById(v);
    if(el) el.classList.toggle("hidden", v!==id);
  });
  state.ui.view = id;

  // topbar切替（メインのみ main / それ以外は sub）
  const isMain = id === "viewMain";
  document.getElementById("topbarMain").classList.toggle("hidden", !isMain);
  document.getElementById("topbarSub").classList.toggle("hidden", isMain);

  save();
}

function goMain(){
  state.ui.selectedSeatIds = [];
  showView("viewMain");
  renderSeats();
}

function openSettings(){
  showView("viewSettings");
}

/* ========= モーダル ========= */
function openModal({title="確認", sub="", bodyHtml="", yesText="OK", noText="戻る", onYes=null, onNo=null}){
  const root = document.getElementById("modalRoot");
  root.innerHTML = `
    <div class="overlay">
      <div class="modal">
        <div class="modal-title">${escapeHtml(title)}</div>
        ${sub ? `<div class="modal-sub">${escapeHtml(sub)}</div>` : ""}
        ${bodyHtml ? `<div class="modal-body">${bodyHtml}</div>` : ""}
        <div class="modal-actions">
          <button class="btn full ok" id="modalYes">${escapeHtml(yesText)}</button>
          <button class="btn full" id="modalNo">${escapeHtml(noText)}</button>
        </div>
      </div>
    </div>
  `;
  root.classList.remove("hidden");

  document.getElementById("modalYes").onclick = ()=>{
    closeModal();
    try{ if(onYes) onYes(); }catch(e){ console.warn(e); }
  };
  document.getElementById("modalNo").onclick = ()=>{
    closeModal();
    try{ if(onNo) onNo(); }catch(e){ console.warn(e); }
  };
}
function closeModal(){
  const root = document.getElementById("modalRoot");
  root.classList.add("hidden");
  root.innerHTML = "";
}

function escapeHtml(s){
  return String(s)
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

/* ========= データ検索 ========= */
function getSeat(id){ return state.seats.find(s=>s.id===id) || null; }
function getMenu(id){ return state.menus.find(m=>m.id===id) || null; }

function seatDisplayLabel(seat){
  // 予約は「予約」表示、団体は廃止（仕様反映）
  return seat.label;
}

/* ========= 合算（代表席） =========
  mergedInto が null の席が“代表”。
  mergedInto が入っている席は代表席に合算されている扱い。
*/
function getMergeBaseId(seatId){
  let cur = getSeat(seatId);
  let guard = 0;
  while(cur && cur.mergedInto && guard<20){
    cur = getSeat(cur.mergedInto);
    guard++;
  }
  return cur ? cur.id : seatId;
}

function isMergedChild(seat){
  return !!seat.mergedInto;
}

/* ========= 金額計算 ========= */
function sumOrders(orders){
  return (orders||[]).reduce((acc,o)=> acc + (Number(o.price||0) * Number(o.qty||1)), 0);
}

function seatTotal(seatId){
  const baseId = getMergeBaseId(seatId);
  const base = getSeat(baseId);
  if(!base) return 0;

  let total = sumOrders(base.orders);

  // baseに合算されている子席の注文も合計
  state.seats.forEach(s=>{
    if(s.mergedInto === baseId){
      total += sumOrders(s.orders);
    }
  });
  return total;
}

/* ========= 表示（席） ========= */
function seatStatusBadge(seat){
  if(seat.status==="reserve") return `<span class="badge reserve">予約</span>`;
  if(seat.mergedInto) return `<span class="badge merged">合算</span>`;
  return "";
}

function seatMetaText(seat){
  if(seat.status==="reserve"){
    const p = seat.party?.people || "";
    const nm = seat.party?.name ? `\n${seat.party.name}` : "";
    const ph = seat.party?.phone ? `\n${seat.party.phone}` : "";
    return `${p}名${nm}${ph}`;
  }
  if(seat.status==="active"){
    const p = seat.party?.people || "";
    const nm = seat.party?.name ? `\n${seat.party.name}` : "";
    const hm = seat.openedAt ? `\n${formatHM(seat.openedAt)}` : "";
    return `${p}名${nm}${hm}`;
  }
  return "空席";
}

function renderSeats(){
  const grid = document.getElementById("seatGrid");
  if(!grid) return;

  // 席ラベル順：英字→数字（簡易ソート）
  const sorted = [...state.seats].sort((a,b)=>{
    const la = a.label||"", lb = b.label||"";
    return la.localeCompare(lb, "ja");
  });

  grid.innerHTML = "";
  sorted.forEach(seat=>{
    const isSel = state.ui.selectedSeatIds.includes(seat.id);
    const cls = ["seat"];
    if(isSel) cls.push("selected");
    if(seat.mergedInto) cls.push("merged");

    const baseId = getMergeBaseId(seat.id);
    const baseSeat = getSeat(baseId);
    const total = baseSeat ? seatTotal(baseId) : 0;

    // 金額表示ルール（仕様）：合算後は“若い方（代表）”に金額、子には「合算」表示＋色
    let moneyHtml = "";
    if(seat.mergedInto){
      moneyHtml = `<div class="seat-money" style="color:#ede9fe;">合算</div>`;
    }else{
      moneyHtml = `<div class="seat-money">${yen(total)}</div>`;
    }

    const html = `
      <div class="${cls.join(" ")}" data-seat="${seat.id}">
        ${seatStatusBadge(seat)}
        <div>
          <div class="seat-no">${escapeHtml(seatDisplayLabel(seat))}</div>
          <div class="seat-meta">${escapeHtml(seatMetaText(seat))}</div>
        </div>
        ${moneyHtml}
      </div>
    `;
    grid.insertAdjacentHTML("beforeend", html);
  });

  // クリック
  grid.querySelectorAll(".seat").forEach(el=>{
    el.onclick = ()=>{
      const id = el.getAttribute("data-seat");
      toggleSelectSeat(id);
    };
  });
}

function toggleSelectSeat(seatId){
  const id = String(seatId);
  const idx = state.ui.selectedSeatIds.indexOf(id);
  if(idx>=0){
    state.ui.selectedSeatIds.splice(idx,1);
  }else{
    state.ui.selectedSeatIds.push(id);
  }
  save();
  renderSeats();
}

/* ========= イベント：トップとナビ ========= */
function bindNav(){
  // Top
  document.getElementById("btnKitchen").onclick = ()=> goKitchen();
  document.getElementById("btnBackupTop").onclick = ()=> openBackup();

  document.getElementById("btnMainTop").onclick = ()=> goMain();
  document.getElementById("btnMainTopR").onclick = ()=> goMain();

  // Main buttons
  document.getElementById("btnSettings").onclick = ()=> openSettings();
  document.getElementById("btnSalesToday").onclick = ()=> openSalesToday();
  document.getElementById("btnSeatMove").onclick = ()=> openSeatMove();
  document.getElementById("btnMerge").onclick = ()=> mergeSelected();
  document.getElementById("btnSplit").onclick = ()=> splitSelected();
  document.getElementById("btnDecide").onclick = ()=> decideMain();

  // Settings cards
  document.getElementById("navSeatRegister").onclick = ()=> openSeatRegister();
  document.getElementById("navMenuRegister").onclick = ()=> openMenuRegister();
  document.getElementById("navSales").onclick = ()=> openSales();
  document.getElementById("navStoreInfo").onclick = ()=> openStoreInfo();
  document.getElementById("navSuggest").onclick = ()=> openSuggest();
  document.getElementById("navContact").onclick = ()=> openContact();

  document.getElementById("btnMainFromSettings").onclick = ()=> goMain();
  document.getElementById("btnBackupFromSettings").onclick = ()=> openBackup();

  // Seat register nav
  document.getElementById("btnMainFromSeatReg").onclick = ()=> goMain();
  document.getElementById("btnSettingsFromSeatReg").onclick = ()=> openSettings();

  // Menu register nav
  document.getElementById("btnMainFromMenuReg").onclick = ()=> goMain();
  document.getElementById("btnSettingsFromMenuReg").onclick = ()=> openSettings();

  // Order nav
  document.getElementById("btnMainFromOrder").onclick = ()=> goMain();
  document.getElementById("btnToCheckout").onclick = ()=> openCheckout();

  // Checkout nav
  document.getElementById("btnMainFromCheckout").onclick = ()=> goMain();
  document.getElementById("btnBackToOrder").onclick = ()=> backToOrder();

  // Kitchen nav
  document.getElementById("btnMainFromKitchen").onclick = ()=> goMain();
  document.getElementById("btnMenuFromKitchen").onclick = ()=> openMenuRegister();
  document.getElementById("btnKitchenRefresh").onclick = ()=> renderKitchen(true);
  document.getElementById("btnKitchenHall").onclick = ()=> goMain();
  document.getElementById("btnKitchenFood").onclick = ()=> setKitchenFilter("food");
  document.getElementById("btnKitchenDrink").onclick = ()=> setKitchenFilter("drink");

  // Sales nav
  document.getElementById("btnSalesMonth").onclick = ()=> openSalesMonth();
  document.getElementById("btnSalesYear").onclick = ()=> openSalesYear();
  document.getElementById("btnSalesManage").onclick = ()=> openSalesManage();
  document.getElementById("btnMainFromSales").onclick = ()=> goMain();

  document.getElementById("btnMainFromSalesMonth").onclick = ()=> goMain();
  document.getElementById("btnBackSalesFromMonth").onclick = ()=> openSales();
  document.getElementById("btnToSalesYearFromMonth").onclick = ()=> openSalesYear();
  document.getElementById("btnToSalesManageFromMonth").onclick = ()=> openSalesManage();

  document.getElementById("btnMainFromSalesYear").onclick = ()=> goMain();
  document.getElementById("btnBackSalesFromYear").onclick = ()=> openSales();
  document.getElementById("btnToSalesMonthFromYear").onclick = ()=> openSalesMonth();
  document.getElementById("btnToSalesManageFromYear").onclick = ()=> openSalesManage();

  document.getElementById("btnMainFromSalesManage").onclick = ()=> goMain();
  document.getElementById("btnBackSalesFromManage").onclick = ()=> openSales();
  document.getElementById("btnToSalesMonthFromManage").onclick = ()=> openSalesMonth();
  document.getElementById("btnToSalesYearFromManage").onclick = ()=> openSalesYear();

  // Backup nav
  document.getElementById("btnMainFromBackup").onclick = ()=> goMain();
  document.getElementById("btnSettingsFromBackup").onclick = ()=> openSettings();
  document.getElementById("btnExport").onclick = ()=> exportBackup();
  document.getElementById("btnImport").onclick = ()=> importBackup();

  // Store info / suggest / contact
  document.getElementById("btnMainFromStoreInfo").onclick = ()=> goMain();
  document.getElementById("btnSettingsFromStoreInfo").onclick = ()=> openSettings();

  document.getElementById("btnMainFromSuggest").onclick = ()=> goMain();
  document.getElementById("btnSettingsFromSuggest").onclick = ()=> openSettings();

  document.getElementById("btnMainFromContact").onclick = ()=> goMain();
  document.getElementById("btnSettingsFromContact").onclick = ()=> openSettings();
}

/* ========= 未実装（PART3以降で実体化） =========
  ここでは“関数の箱”だけ用意しておく（エラー防止）
*/
function openSeatRegister(){ showView("viewSeatRegister"); }
function openMenuRegister(){ showView("viewMenuRegister"); }
function openSales(){ showView("viewSales"); }
function openSalesMonth(){ showView("viewSalesMonth"); }
function openSalesYear(){ showView("viewSalesYear"); }
function openSalesManage(){ showView("viewSalesManage"); }
function openStoreInfo(){ showView("viewStoreInfo"); }
function openSuggest(){ showView("viewSuggest"); }
function openContact(){ showView("viewContact"); }
function openBackup(){ showView("viewBackup"); }

function openSeatMove(){ openModal({title:"席移動", sub:"（PART3で実装します）"}); }
function mergeSelected(){ openModal({title:"合計合算", sub:"（PART3で実装します）"}); }
function splitSelected(){ openModal({title:"合計分割", sub:"（PART3で実装します）"}); }
function decideMain(){ openModal({title:"決定", sub:"（PART3で実装します）"}); }

function openOrder(){ showView("viewOrder"); }
function openCheckout(){ showView("viewCheckout"); }
function backToOrder(){ showView("viewOrder"); }

function goKitchen(){ showView("viewKitchen"); }
function openSalesToday(){ openSales(); }

function setKitchenFilter(f){ state.ui.kitchenFilter=f; save(); renderKitchen(true); }
function renderKitchen(){ /* PART5で実装 */ }

function exportBackup(){
  document.getElementById("backupText").value = JSON.stringify(state, null, 2);
}
function importBackup(){
  const txt = document.getElementById("backupText").value.trim();
  if(!txt) return;
  try{
    const parsed = JSON.parse(txt);
    state = Object.assign(deepClone(state), parsed);
    state.ui = Object.assign(deepClone(state.ui), parsed.ui||{});
    save();
    openModal({title:"読み込み完了", sub:"メインへ戻って確認してください", yesText:"メイン", noText:"閉じる", onYes:()=>goMain()});
  }catch(e){
    openModal({title:"読み込みエラー", sub:"JSONの形式を確認してください"});
  }
}

/* ========= 起動 ========= */
function boot(){
  load();
  bindNav();
  showView(state.ui.view || "viewMain");
  renderSeats();
  // テキスト保存（店舗情報/問い合わせ）
  const si = document.getElementById("storeInfoText");
  const ct = document.getElementById("contactText");
  if(si){
    si.value = state.storeInfoText || "";
    si.oninput = ()=>{ state.storeInfoText = si.value; save(); };
  }
  if(ct){
    ct.value = state.contactText || "";
    ct.oninput = ()=>{ state.contactText = ct.value; save(); };
  }
}
document.addEventListener("DOMContentLoaded", boot);

/* =========================
  PART 2 END
========================= */
</script>
<!-- =========================
  PART 1（HTML）END
========================= --><!-- =========================
  ONE 無料版（最新版仕様）- PART 3/6
  役割：席登録 / 来店・予約 / 席移動 / 合算・分割 / 決定→注文
========================= -->

<script>
/* ========= 席登録 ========= */
const SEAT_TYPE_LABEL = {
  counter:"カウンター",
  stand:"立ち",
  table:"テーブル",
  zashiki:"座敷",
  private:"個室",
  other:"その他"
};

function openSeatRegister(){
  showView("viewSeatRegister");
  renderCreatedSeats();
}

document.getElementById("srType").onchange = ()=>{
  const v = document.getElementById("srType").value;
  document.getElementById("srOtherWrap").classList.toggle("hidden", v!=="other");
  document.getElementById("srCountLabel").textContent =
    (v==="counter"||v==="stand") ? "総席数" : "総卓数";
};

document.getElementById("btnSaveOtherName").onclick = ()=>{
  const name = document.getElementById("srOtherName").value.trim();
  if(!name) return;
  if(!state.otherSeatNames.includes(name)){
    state.otherSeatNames.push(name);
    save();
    openModal({title:"保存しました", sub:`「${name}」を追加しました`});
  }
};

document.getElementById("btnResetSeatReg").onclick = ()=>{
  document.getElementById("srTotal").value = "";
  document.getElementById("srLabel").value = "";
  document.getElementById("srCapDefault").value = "";
};

document.getElementById("btnCreateSeats").onclick = ()=>{
  const type = document.getElementById("srType").value;
  let areaName = SEAT_TYPE_LABEL[type];
  if(type==="other"){
    areaName = document.getElementById("srOtherName").value.trim();
    if(!areaName){
      openModal({title:"名称を入力してください"});
      return;
    }
  }
  const total = parseInt(document.getElementById("srTotal").value||"0",10);
  if(!total){
    openModal({title:"総数を入力してください"});
    return;
  }
  const startLabel = document.getElementById("srLabel").value.trim();
  if(!startLabel){
    openModal({title:"席番号を入力してください"});
    return;
  }
  const capDefault = parseInt(document.getElementById("srCapDefault").value||"0",10)
    || ((type==="counter"||type==="stand")?1:4);

  // 連番生成
  let labels = [];
  let cur = startLabel;
  for(let i=0;i<total;i++){
    labels.push(cur);
    cur = nextLabel(cur);
  }

  // 重複チェック
  const dup = labels.find(l => state.seats.some(s=>s.label===l));
  if(dup){
    openModal({
      title:"同じ席番号があります",
      sub:`「${dup}」が既に存在します。登録しますか？`,
      yesText:"登録する",
      noText:"戻る",
      onYes:()=> createSeats(areaName, type, labels, capDefault)
    });
    return;
  }
  createSeats(areaName, type, labels, capDefault);
};

function createSeats(areaName, type, labels, cap){
  labels.forEach(l=>{
    state.seats.push({
      id: uid("seat"),
      label: l,
      areaType: type,
      areaName,
      cap,
      status:"empty",
      party:null,
      openedAt:null,
      orders:[],
      mergedInto:null,
      updatedAt: nowTs()
    });
  });
  save();
  renderCreatedSeats();
  renderSeats();
  openModal({title:"作成しました"});
}

function renderCreatedSeats(){
  const grid = document.getElementById("srCreatedSeatGrid");
  if(!grid) return;
  grid.innerHTML = "";
  state.seats.forEach(seat=>{
    const html = `
      <div class="seat" data-seat="${seat.id}">
        <div class="seat-no">${seat.label}</div>
        <div class="seat-meta">${seat.areaName}\n最大${seat.cap}名</div>
      </div>
    `;
    grid.insertAdjacentHTML("beforeend", html);
  });
  grid.querySelectorAll(".seat").forEach(el=>{
    el.onclick = ()=>{
      const id = el.getAttribute("data-seat");
      openSeatEdit(id);
    };
  });
}

function openSeatEdit(seatId){
  const seat = getSeat(seatId);
  if(!seat) return;
  openModal({
    title:`席編集（${seat.label}）`,
    sub:"名称・番号・人数は変更できます。売上データは保持されます。",
    bodyHtml:`
      <div class="field"><div class="label">席番号</div>
      <input id="editLabel" value="${seat.label}"></div>
      <div class="field"><div class="label">最大着席人数</div>
      <input id="editCap" type="number" value="${seat.cap}"></div>
    `,
    yesText:"変更",
    noText:"削除",
    onYes:()=>{
      seat.label = document.getElementById("editLabel").value.trim();
      seat.cap = parseInt(document.getElementById("editCap").value||seat.cap,10);
      seat.updatedAt = nowTs();
      save();
      renderCreatedSeats();
      renderSeats();
    },
    onNo:()=>{
      openModal({
        title:"席を削除しますか？",
        sub:"売上データは履歴として残ります",
        yesText:"削除",
        noText:"戻る",
        onYes:()=>{
          state.seatHistory.push({
            id: uid("hist"),
            at: nowTs(),
            type:"delete",
            fromLabel: seat.label,
            seatId: seat.id,
            reason:"席登録変更"
          });
          state.seats = state.seats.filter(s=>s.id!==seat.id);
          save();
          renderCreatedSeats();
          renderSeats();
        }
      });
    }
  });
}

/* ========= 来店・予約 ========= */
function decideMain(){
  if(state.ui.selectedSeatIds.length!==1){
    openModal({title:"席を1つ選択してください"});
    return;
  }
  const seat = getSeat(state.ui.selectedSeatIds[0]);
  if(!seat) return;

  if(seat.status==="empty"){
    openArriveReserve(seat);
    return;
  }
  if(seat.status==="reserve"){
    openReserveToArrive(seat);
    return;
  }
  if(seat.status==="active"){
    openOrder(getMergeBaseId(seat.id));
  }
}

function openArriveReserve(seat){
  openModal({
    title:`来店 / 予約（${seat.label}）`,
    bodyHtml:`
      <div class="btnrow2">
        <button class="btn full ok" id="btnArrive">来店</button>
        <button class="btn full" id="btnReserve">予約</button>
      </div>
    `,
    yesText:"閉じる",
    noText:"閉じる",
    onYes:()=>{},
    onNo:()=>{}
  });
  setTimeout(()=>{
    document.getElementById("btnArrive").onclick = ()=> openPartyInput(seat,"arrive");
    document.getElementById("btnReserve").onclick = ()=> openPartyInput(seat,"reserve");
  },0);
}

function openPartyInput(seat, mode){
  const title = mode==="arrive" ? "来店" : "予約";
  const bodyHtml = `
    <div class="field"><div class="label">人数</div>
    <input id="piPeople" type="number" min="1"></div>
    <div class="field"><div class="label">名前（任意）</div>
    <input id="piName"></div>
    ${mode==="reserve" ? `
      <div class="field"><div class="label">電話番号（任意）</div>
      <input id="piPhone"></div>` : ""}
  `;
  openModal({
    title: `${title}（${seat.label}）`,
    sub: mode==="arrive" ? "決定で注文ページへ移動します" : "決定でメインへ戻ります",
    bodyHtml,
    yesText:"決定",
    noText:"戻る",
    onYes:()=>{
      const people = parseInt(document.getElementById("piPeople").value||"0",10);
      const name = document.getElementById("piName").value?.trim() || "";
      const phone = mode==="reserve" ? (document.getElementById("piPhone").value?.trim()||"") : "";
      if(!people){
        openModal({title:"人数を入力してください"});
        return;
      }
      if(mode==="arrive"){
        seat.status="active";
        seat.party={people,name,phone:""};
        seat.openedAt=nowTs();
        seat.orders = seat.orders || [];
        seat.mergedInto=null;
        seat.updatedAt=nowTs();
        save();
        state.ui.selectedSeatIds=[seat.id];
        renderSeats();
        openOrder(seat.id);
      }else{
        seat.status="reserve";
        seat.party={people,name,phone};
        seat.updatedAt=nowTs();
        save();
        renderSeats();
        goMain();
      }
    }
  });
}

function openReserveToArrive(seat){
  openModal({
    title:`予約（${seat.label}）`,
    bodyHtml:`<div class="btnrow2">
      <button class="btn full ok" id="btnToArrive">来店</button>
      <button class="btn full warn" id="btnCancel">キャンセル</button>
    </div>`,
    yesText:"閉じる",
    noText:"閉じる",
    onYes:()=>{},
    onNo:()=>{}
  });
  setTimeout(()=>{
    document.getElementById("btnToArrive").onclick = ()=>{
      openPartyInput(seat,"arrive");
    };
    document.getElementById("btnCancel").onclick = ()=>{
      seat.status="empty";
      seat.party=null;
      seat.updatedAt=nowTs();
      save();
      renderSeats();
      goMain();
    };
  },0);
}

/* ========= 合算 / 分割 ========= */
function mergeSelected(){
  if(state.ui.selectedSeatIds.length<2){
    openModal({title:"2席以上選択してください"});
    return;
  }
  const ids = [...state.ui.selectedSeatIds].sort();
  const baseId = ids[0];
  ids.slice(1).forEach(id=>{
    const s = getSeat(id);
    if(s) s.mergedInto = baseId;
  });
  save();
  renderSeats();
}

function splitSelected(){
  state.ui.selectedSeatIds.forEach(id=>{
    const s = getSeat(id);
    if(s) s.mergedInto = null;
  });
  save();
  renderSeats();
}

/* ========= 席移動 ========= */
function openSeatMove(){
  if(state.ui.selectedSeatIds.length!==1){
    openModal({title:"移動元の席を1つ選択してください"});
    return;
  }
  const from = getSeat(state.ui.selectedSeatIds[0]);
  if(!from) return;
  openModal({
    title:"席移動",
    bodyHtml:`<div class="subtle">移動先をタップしてください</div>`,
    yesText:"閉じる",
    noText:"閉じる",
    onYes:()=>{},
    onNo:()=>{}
  });
  // 次に空席をタップしたら移動
  const prev = [...state.ui.selectedSeatIds];
  state.ui.selectedSeatIds = [];
  renderSeats();
  document.getElementById("seatGrid").onclick = (e)=>{
    const el = e.target.closest(".seat");
    if(!el) return;
    const toId = el.getAttribute("data-seat");
    const to = getSeat(toId);
    if(!to || to.status!=="empty") return;
    // 移動
    to.status="active";
    to.party=from.party;
    to.orders=from.orders;
    to.openedAt=from.openedAt;
    from.status="empty";
    from.party=null;
    from.orders=[];
    save();
    document.getElementById("seatGrid").onclick=null;
    renderSeats();
    goMain();
  };
}

/* ========= ラベル連番 ========= */
function nextLabel(label){
  if(/^\d+$/.test(label)) return String(parseInt(label,10)+1);
  if(/^[A-Z]$/.test(label)) return String.fromCharCode(label.charCodeAt(0)+1);
  const m = label.match(/^([A-Z]+)(\d+)$/);
  if(m) return m[1]+(parseInt(m[2],10)+1);
  return label+"_2";
}

/* =========================
  PART 3 END
========================= */
</script><!-- =========================
  ONE 無料版（最新版仕様）- PART 4/6
  役割：注文ページ（ジャンル→商品→中央数量入力 / 履歴修正）
========================= -->

<script>
/* ========= 注文ページ：実装 ========= */

// openOrder を“実装”に差し替え（PART2の仮関数を上書き）
function openOrder(baseSeatId){
  const baseId = getMergeBaseId(baseSeatId);
  state.ui.orderBaseSeatId = baseId;
  state.ui.activeGenre = null; // まずジャンル一覧
  save();

  const base = getSeat(baseId);
  const title = base ? `会計（${base.label}）` : "会計";
  document.getElementById("orderTitle").textContent = title;

  showView("viewOrder");
  renderOrderPage();
}

function renderOrderPage(){
  renderGenreRow();
  renderMenuGrid();
  renderOrderHistory();
}

// ジャンル一覧（ピル）
function renderGenreRow(){
  const row = document.getElementById("genreRow");
  row.innerHTML = "";

  // 登録メニューからジャンル抽出
  const genres = Array.from(new Set(state.menus.map(m => (m.genre||"").trim()).filter(Boolean)))
    .sort((a,b)=> a.localeCompare(b,"ja"));

  // 「戻る」ピル（商品表示中のみ）
  if(state.ui.activeGenre){
    const back = document.createElement("button");
    back.className = "pill active";
    back.textContent = "戻る";
    back.onclick = ()=>{
      state.ui.activeGenre = null;
      save();
      renderOrderPage();
    };
    row.appendChild(back);
  }

  // ジャンルがない場合
  if(genres.length===0){
    const p = document.createElement("div");
    p.className = "subtle";
    p.textContent = "メニュー登録がまだありません。設定→メニュー登録から追加してください。";
    row.appendChild(p);
    return;
  }

  // ジャンルのみ表示（activeGenre が null の時）
  if(!state.ui.activeGenre){
    genres.forEach(g=>{
      const b = document.createElement("button");
      b.className = "pill";
      b.textContent = g;
      b.onclick = ()=>{
        state.ui.activeGenre = g;
        save();
        renderOrderPage();
      };
      row.appendChild(b);
    });
  }else{
    // 商品表示中はジャンル名だけ“表示”しておく（戻ると並べる）
    const tag = document.createElement("button");
    tag.className = "pill active";
    tag.textContent = state.ui.activeGenre;
    tag.onclick = ()=>{};
    row.appendChild(tag);
  }
}

// 商品カード表示
function renderMenuGrid(){
  const grid = document.getElementById("menuGrid");
  grid.innerHTML = "";

  // activeGenre がない → ジャンル選択だけにしたいので何も出さない
  if(!state.ui.activeGenre){
    return;
  }

  const g = state.ui.activeGenre;
  const items = state.menus
    .filter(m => (m.genre||"").trim()===g)
    .sort((a,b)=> (a.name||"").localeCompare((b.name||""),"ja"));

  // 先頭に「戻る」カード（仕様）
  const backCard = document.createElement("div");
  backCard.className = "item";
  backCard.innerHTML = `<div class="item-name">戻る</div><div class="item-sub">ジャンル選択へ</div>`;
  backCard.onclick = ()=>{
    state.ui.activeGenre = null;
    save();
    renderOrderPage();
  };
  grid.appendChild(backCard);

  items.forEach(m=>{
    const div = document.createElement("div");
    div.className = "item";
    div.innerHTML = `
      <div class="item-name">${escapeHtml(m.name)}</div>
      <div class="item-sub">${yen(m.price)}</div>
    `;
    div.onclick = ()=>{
      openQtyModalForMenu(m);
    };
    grid.appendChild(div);
  });
}

/* ========= 注文データ：統合表示 =========
  代表席 + 子席の orders をまとめて表示し、修正は元の seatId に対して反映。
*/
function collectOrderLinesForBase(baseId){
  const base = getSeat(baseId);
  if(!base) return [];
  const seats = [base, ...state.seats.filter(s=>s.mergedInto===baseId)];
  let lines = [];
  seats.forEach(seat=>{
    (seat.orders||[]).forEach(o=>{
      lines.push({
        seatId: seat.id,
        seatLabel: seat.label,
        ...o
      });
    });
  });
  // 時間順（古い→新しい）
  lines.sort((a,b)=> (a.createdAt||0) - (b.createdAt||0));
  return lines;
}

function renderOrderHistory(){
  const wrap = document.getElementById("orderList");
  wrap.innerHTML = "";

  const baseId = state.ui.orderBaseSeatId;
  if(!baseId){
    wrap.innerHTML = `<div class="subtle">席を選択してください</div>`;
    return;
  }
  const lines = collectOrderLinesForBase(baseId);
  if(lines.length===0){
    wrap.innerHTML = `<div class="subtle">まだ注文はありません</div>`;
    return;
  }

  lines.forEach(line=>{
    const row = document.createElement("div");
    row.className = "order-row";
    row.innerHTML = `
      <div>
        <div class="order-name">${escapeHtml(line.name)}　×${line.qty}</div>
        <div class="order-sub">${yen(line.price)}　/　小計 ${yen(line.price*line.qty)}</div>
      </div>
      <button class="btn small" data-oid="${line.id}">修正</button>
    `;
    row.querySelector("button").onclick = ()=>{
      openQtyModalForExisting(line);
    };
    wrap.appendChild(row);
  });
}

/* ========= 数量モーダル（中央表示） ========= */

// 新規追加
function openQtyModalForMenu(menu){
  const baseId = state.ui.orderBaseSeatId;
  if(!baseId){
    openModal({title:"席が選択されていません"});
    return;
  }
  const baseSeat = getSeat(baseId);
  if(!baseSeat){
    openModal({title:"席が見つかりません"});
    return;
  }
  openQtyModalCore({
    title: `${menu.name}`,
    price: Number(menu.price||0),
    startQty: 1,
    onCommit:(qty)=>{
      if(qty<=0) return; // 新規は0なら何もしない
      // 基本は代表席に追加（子席から入っても代表に積む）
      baseSeat.orders = baseSeat.orders || [];
      baseSeat.orders.push({
        id: uid("ol"),
        menuId: menu.id,
        name: menu.name,
        price: Number(menu.price||0),
        qty: qty,
        category: menu.category || "food",  // キッチン用
        createdAt: nowTs()
      });
      baseSeat.updatedAt = nowTs();
      save();
      renderSeats();
      renderOrderHistory();
    }
  });
}

// 既存修正（どの席の注文かも保持）
function openQtyModalForExisting(line){
  openQtyModalCore({
    title: `${line.name}`,
    price: Number(line.price||0),
    startQty: Number(line.qty||1),
    onCommit:(qty)=>{
      const seat = getSeat(line.seatId);
      if(!seat) return;

      seat.orders = seat.orders || [];
      const idx = seat.orders.findIndex(o=>o.id===line.id);
      if(idx<0) return;

      if(qty<=0){
        // 0個なら削除（仕様）
        seat.orders.splice(idx,1);
      }else{
        seat.orders[idx].qty = qty;
        seat.orders[idx].updatedAt = nowTs();
      }
      seat.updatedAt = nowTs();
      save();
      renderSeats();
      renderOrderHistory();
    }
  });
}

// コア（左右▲で加減算 / 戻る&決定）
function openQtyModalCore({title, price, startQty, onCommit}){
  let qty = Math.max(0, Number(startQty||0));

  const bodyHtml = `
    <div style="text-align:center; margin-top:6px;">
      <div style="font-size:14px; color:rgba(226,232,240,.85); font-weight:900;">${escapeHtml(title)}</div>
      <div style="margin-top:6px; font-size:13px; color:rgba(226,232,240,.75);">価格 ${yen(price)}</div>

      <div style="margin:14px 0 6px; display:flex; align-items:center; justify-content:center; gap:18px;">
        <button class="btn small" id="qtyDec" style="min-width:64px;">◀</button>
        <div id="qtyVal" style="font-weight:900; font-size:30px; min-width:60px;">${qty}</div>
        <button class="btn small" id="qtyInc" style="min-width:64px;">▶</button>
      </div>

      <div style="margin-top:10px; font-size:12px; color:rgba(226,232,240,.7);">
        0にすると削除（修正時）
      </div>
    </div>
  `;

  openModal({
    title: "数量",
    sub: "",
    bodyHtml,
    yesText:"決定",
    noText:"戻る",
    onYes:()=>{
      try{ onCommit(qty); }catch(e){ console.warn(e); }
    },
    onNo:()=>{}
  });

  setTimeout(()=>{
    const val = document.getElementById("qtyVal");
    document.getElementById("qtyDec").onclick = ()=>{
      qty = Math.max(0, qty-1);
      val.textContent = String(qty);
    };
    document.getElementById("qtyInc").onclick = ()=>{
      qty = qty+1;
      val.textContent = String(qty);
    };
  },0);
}

/* ========= 注文ページ→会計ページへ（PART5で完成させる） ========= */
function openCheckout(){
  // PART5で会計を本実装するため、ここでは“最低限”だけ用意
  const baseId = state.ui.orderBaseSeatId;
  if(!baseId){
    openModal({title:"席が選択されていません"});
    return;
  }
  state.ui.checkoutBaseSeatId = baseId;
  save();

  // 表示だけ先に更新
  const base = getSeat(baseId);
  document.getElementById("coSeatLabel").textContent = base ? `席 ${base.label}` : "席";
  document.getElementById("coPeople").textContent = base?.party?.people ? `${base.party.people}名` : "";
  document.getElementById("coTotal").textContent = `合計 ${yen(seatTotal(baseId))}`;

  // 注文一覧（修正）を表示
  renderCheckoutOrderList();

  showView("viewCheckout");
}

// 会計ページの注文一覧（修正）—注文と同じモーダルを使う
function renderCheckoutOrderList(){
  const wrap = document.getElementById("coOrderList");
  if(!wrap) return;

  const baseId = state.ui.checkoutBaseSeatId || state.ui.orderBaseSeatId;
  const lines = collectOrderLinesForBase(baseId);
  if(lines.length===0){
    wrap.innerHTML = `<div class="subtle">注文はありません</div>`;
    return;
  }

  wrap.innerHTML = "";
  lines.forEach(line=>{
    const row = document.createElement("div");
    row.className = "order-row";
    row.innerHTML = `
      <div>
        <div class="order-name">${escapeHtml(line.name)}　×${line.qty}</div>
        <div class="order-sub">${yen(line.price)}　/　小計 ${yen(line.price*line.qty)}</div>
      </div>
      <button class="btn small">修正</button>
    `;
    row.querySelector("button").onclick = ()=>{
      openQtyModalForExisting(line);
      // 修正後に会計合計も更新したいので、モーダル確定後に再描画するように少し遅延
      setTimeout(()=> {
        document.getElementById("coTotal").textContent = `合計 ${yen(seatTotal(baseId))}`;
        renderCheckoutOrderList();
      }, 250);
    };
    wrap.appendChild(row);
  });
}

/* =========================
  PART 4 END
========================= */
</script><!-- =========================
  ONE 無料版（最新版仕様）- PART 5/6
  役割：会計（割り勘/確定/電子レシート）＋キッチン（料理/ドリンク/15分赤/スライド完了/繰り上がり色）
========================= -->

<script>
/* ========= 会計：確定・割り勘・電子レシート ========= */

// 既にbindNav()で btnToCheckout は openCheckout() に繋がってる（PART4で実装済）
// ここでは会計ページ内のボタンを生やす

function attachCheckoutHandlers(){
  const btnSplit = document.getElementById("btnSplitBill");
  const btnConfirm = document.getElementById("btnCheckoutConfirm");
  if(btnSplit) btnSplit.onclick = ()=> openSplitBillModal();
  if(btnConfirm) btnConfirm.onclick = ()=> confirmCheckoutFlow();
}
function attachKitchenHandlers(){
  // 既に bindNav で更新・料理・ドリンク・ホールはつながってる（PART2）
  // ここでは renderKitchen の本体を入れたので、初回描画だけ
}

function openSplitBillModal(){
  const baseId = state.ui.checkoutBaseSeatId || state.ui.orderBaseSeatId;
  if(!baseId){ openModal({title:"席が選択されていません"}); return; }
  const base = getSeat(baseId);
  const total = seatTotal(baseId);
  const peopleDefault = base?.party?.people || 1;

  const bodyHtml = `
    <div class="field">
      <div class="label">人数</div>
      <input id="sbPeople" type="number" min="1" value="${peopleDefault}">
    </div>
    <div class="panel">
      <div class="subtle">合計 ${yen(total)}</div>
      <div id="sbResult" style="margin-top:6px; font-weight:900; font-size:18px;">1人あたり ${yen(total)}</div>
      <div class="subtle" style="margin-top:6px;">端数は最後の人に加算</div>
    </div>
  `;

  openModal({
    title:"割り勘",
    sub:"",
    bodyHtml,
    yesText:"OK",
    noText:"戻る",
    onYes:()=>{}
  });

  setTimeout(()=>{
    const inp = document.getElementById("sbPeople");
    const out = document.getElementById("sbResult");
    const recompute = ()=>{
      const p = Math.max(1, parseInt(inp.value||"1",10));
      const baseEach = Math.floor(total / p);
      const rem = total - baseEach * p;
      if(rem===0){
        out.textContent = `1人あたり ${yen(baseEach)}`;
      }else{
        out.textContent = `1人あたり ${yen(baseEach)}（最後の人 +${yen(rem)}）`;
      }
    };
    inp.oninput = recompute;
    recompute();
  },0);
}

function confirmCheckoutFlow(){
  const baseId = state.ui.checkoutBaseSeatId || state.ui.orderBaseSeatId;
  if(!baseId){ openModal({title:"席が選択されていません"}); return; }

  // 念のため合計更新
  document.getElementById("coTotal").textContent = `合計 ${yen(seatTotal(baseId))}`;

  openModal({
    title:"会計確定",
    sub:"電子レシートはいりますか？",
    yesText:"○",
    noText:"✖︎",
    onYes:()=> openReceiptInputAndFinalize(baseId),
    onNo:()=> finalizeCheckout(baseId, null)
  });
}

function openReceiptInputAndFinalize(baseId){
  const bodyHtml = `
    <div class="field">
      <div class="label">送信先メールアドレス</div>
      <input id="rcptEmail" placeholder="例：example@gmail.com" inputmode="email">
    </div>
    <div class="field">
      <div class="label">メモ（任意）</div>
      <input id="rcptNote" placeholder="例：領収書希望 など">
    </div>
    <div class="subtle">※無料版は送信はしません（保存のみ）。</div>
  `;
  openModal({
    title:"電子レシート",
    sub:"入力して「決定」で保存します",
    bodyHtml,
    yesText:"決定",
    noText:"戻る",
    onYes:()=>{
      const to = document.getElementById("rcptEmail").value.trim();
      const note = document.getElementById("rcptNote").value.trim();
      if(!to){
        openModal({title:"メールアドレスを入力してください"});
        return;
      }
      finalizeCheckout(baseId, {to, note});
    }
  });
}

function finalizeCheckout(baseId, receipt){
  const payMethod = document.getElementById("coPayMethod")?.value || "cash";
  const base = getSeat(baseId);
  if(!base){ openModal({title:"席が見つかりません"}); return; }

  // 対象席：代表 + 子（合算）を全て含める
  const targets = [base, ...state.seats.filter(s=>s.mergedInto===baseId)];

  // 明細（seat跨ぎで一つに保存）
  const lines = collectOrderLinesForBase(baseId);
  const items = lines.map(l=>({ name:l.name, qty:l.qty, price:l.price, at:l.createdAt||nowTs() }));

  const total = seatTotal(baseId);
  if(total<=0){
    openModal({title:"注文がありません"});
    return;
  }

  // 売上保存
  state.sales.push({
    id: uid("sale"),
    at: nowTs(),
    seatId: baseId,
    seatLabel: base.label,
    total,
    payMethod,
    items,
    emailReceipt: receipt || null
  });

  // キッチン完了状態をクリア（対象の注文ID）
  targets.forEach(s=>{
    (s.orders||[]).forEach(o=>{
      if(o?.id) delete state.ui.kitchenDone[o.id];
    });
  });

  // 席を空席へ（合算解除も含む）
  targets.forEach(s=>{
    s.status = "empty";
    s.party = null;
    s.openedAt = null;
    s.orders = [];
    s.mergedInto = null;
    s.updatedAt = nowTs();
  });

  save();
  renderSeats();

  // 会計ページ更新
  document.getElementById("coTotal").textContent = `合計 ${yen(0)}`;
  renderCheckoutOrderList();

  openModal({
    title:"会計を確定しました",
    sub:"席は空席に戻りました",
    yesText:"メイン",
    noText:"閉じる",
    onYes:()=> goMain()
  });
}

/* ========= キッチン：表示・完了スライド・15分赤・繰り上がり色 ========= */

// renderKitchen（PART2の仮）を本実装で上書き
function renderKitchen(force){
  const list = document.getElementById("kitchenList");
  if(!list) return;

  // 注文を「1行=1注文」として集計
  // 仕様：同じ商品でも別注文は別行（改行扱い）／完了で消える／消えたら時間順に戻る
  let rows = [];
  state.seats.forEach(seat=>{
    if(seat.status!=="active" && seat.status!=="reserve") return;
    (seat.orders||[]).forEach(o=>{
      rows.push({
        orderId: o.id,
        name: o.name,
        qty: o.qty,
        seatLabel: seat.label,
        at: o.createdAt || nowTs(),
        category: o.category || "food"
      });
    });
  });

  // 完了済みは除外
  rows = rows.filter(r=> !state.ui.kitchenDone[r.orderId]);

  // フィルタ（料理/ドリンク）
  if(state.ui.kitchenFilter==="food"){
    rows = rows.filter(r=> r.category==="food");
  }else if(state.ui.kitchenFilter==="drink"){
    rows = rows.filter(r=> r.category==="drink");
  }

  // 時間順（古い→新しい）
  rows.sort((a,b)=> a.at - b.at);

  // 繰り上がり色付け：前回順序と比較して「前より上に来たものだけ」強調
  const prev = state.ui.kitchenPrevOrderIds || [];
  const prevIndex = new Map(prev.map((id,idx)=>[id,idx]));
  const nowIds = rows.map(r=>r.orderId);
  state.ui.kitchenPrevOrderIds = nowIds;
  save();

  list.innerHTML = "";

  if(rows.length===0){
    list.innerHTML = `<div class="subtle">表示する注文はありません</div>`;
    return;
  }

  const now = nowTs();
  rows.forEach(r=>{
    const overdue = (now - r.at) >= 15*60*1000;
    const movedUp = prevIndex.has(r.orderId) ? (nowIds.indexOf(r.orderId) < prevIndex.get(r.orderId)) : false;

    const borderStyle = movedUp ? `style="border-color:rgba(59,130,246,.55); background:rgba(59,130,246,.12);"` : "";
    const nameCls = ["ticket-name"];
    if(overdue) nameCls.push("overdue");

    const ticket = document.createElement("div");
    ticket.className = "ticket";
    ticket.setAttribute("data-oid", r.orderId);
    ticket.innerHTML = `
      <div ${borderStyle}>
        <div class="${nameCls.join(" ")}">${escapeHtml(r.name)}　×${r.qty}</div>
        <div class="ticket-sub">${escapeHtml(r.seatLabel)}　${escapeHtml(formatHM(r.at))}</div>
      </div>
      <div style="display:flex; justify-content:flex-end;">
        <input class="slider" type="range" min="0" max="100" value="0" data-oid="${r.orderId}">
      </div>
    `;
    list.appendChild(ticket);
  });

  // スライド完了（100で確定、文字なし）
  list.querySelectorAll('input.slider').forEach(sl=>{
    sl.oninput = ()=>{
      const v = Number(sl.value||0);
      if(v>=100){
        const oid = sl.getAttribute("data-oid");
        state.ui.kitchenDone[oid] = true;
        save();
        renderKitchen(true);
      }
    };
    // 誤タップ防止：離したら戻す（100未満なら0に戻す）
    sl.onchange = ()=>{
      const v = Number(sl.value||0);
      if(v<100){
        sl.value = "0";
      }
    };
  });
}

// キッチン画面へ
function goKitchen(){
  showView("viewKitchen");
  renderKitchen(true);
}

/* ========= 売上：本日ボタンの挙動を少し実体化（詳細はPART6） ========= */
function openSalesToday(){
  // 売上ページへ移動（本日=売上管理で見られる想定）
  openSalesManage();
}

/* ========= 画面遷移で会計の合計を更新 ========= */
function backToOrder(){
  showView("viewOrder");
  renderOrderPage();
}
function openCheckout(){
  // PART4の openCheckout を上書きして「確定ボタンも動く」状態にする
  const baseId = state.ui.orderBaseSeatId;
  if(!baseId){
    openModal({title:"席が選択されていません"});
    return;
  }
  state.ui.checkoutBaseSeatId = baseId;
  save();

  const base = getSeat(baseId);
  document.getElementById("coSeatLabel").textContent = base ? `席 ${base.label}` : "席";
  document.getElementById("coPeople").textContent = base?.party?.people ? `${base.party.people}名` : "";
  document.getElementById("coTotal").textContent = `合計 ${yen(seatTotal(baseId))}`;
  renderCheckoutOrderList();

  showView("viewCheckout");

  // ハンドラがまだなら付与
  attachCheckoutHandlers();
}

/* ========= 初回バインド（貼った直後にも効くように） ========= */
(function initPart5(){
  // DOMがもうできていれば即、まだなら後で
  const run = ()=>{
    attachCheckoutHandlers();
    attachKitchenHandlers();
  };
  if(document.readyState==="loading"){
    document.addEventListener("DOMContentLoaded", run, {once:true});
  }else{
    run();
  }
})();

/* =========================
  PART 5 END
========================= */
</script><!-- =========================
  ONE 無料版（最新版仕様）- PART 6/6
  役割：売上（月/年/管理）/ バックアップ仕上げ / OCR擬似 / 初期化 / 完全クローズ
========================= -->

<script>
/* ========= 売上：集計 ========= */

function groupSalesByMonth(){
  const map = {};
  state.sales.forEach(s=>{
    const d = new Date(s.at);
    const key = `${d.getFullYear()}-${pad2(d.getMonth()+1)}`;
    map[key] = (map[key]||0) + s.total;
  });
  return Object.entries(map).sort((a,b)=> a[0].localeCompare(b[0]));
}

function groupSalesByYear(){
  const map = {};
  state.sales.forEach(s=>{
    const y = new Date(s.at).getFullYear();
    map[y] = (map[y]||0) + s.total;
  });
  return Object.entries(map).sort((a,b)=> a[0]-b[0]);
}

function renderSalesMonth(){
  const box = document.getElementById("salesMonthBody");
  box.innerHTML = "";
  const rows = groupSalesByMonth();
  if(rows.length===0){
    box.innerHTML = `<div class="subtle">データがありません</div>`;
    return;
  }
  rows.forEach(([k,v])=>{
    box.insertAdjacentHTML("beforeend",
      `<div class="order-row">
        <div class="order-name">${k}</div>
        <div class="order-name">${yen(v)}</div>
      </div>`
    );
  });
}

function renderSalesYear(){
  const box = document.getElementById("salesYearBody");
  box.innerHTML = "";
  const rows = groupSalesByYear();
  if(rows.length===0){
    box.innerHTML = `<div class="subtle">データがありません</div>`;
    return;
  }
  rows.forEach(([k,v])=>{
    box.insertAdjacentHTML("beforeend",
      `<div class="order-row">
        <div class="order-name">${k}年</div>
        <div class="order-name">${yen(v)}</div>
      </div>`
    );
  });
}

function renderSalesManage(){
  const box = document.getElementById("salesManageBody");
  box.innerHTML = "";
  if(state.sales.length===0){
    box.innerHTML = `<div class="subtle">売上データがありません</div>`;
    return;
  }
  state.sales
    .slice()
    .sort((a,b)=> b.at - a.at)
    .forEach(s=>{
      const d = new Date(s.at);
      box.insertAdjacentHTML("beforeend",
        `<div class="panel">
          <div class="order-name">${d.toLocaleString("ja-JP")} / 席 ${escapeHtml(s.seatLabel)}</div>
          <div class="order-sub">合計 ${yen(s.total)} / ${escapeHtml(s.payMethod)}</div>
        </div>`
      );
    });
}

// 売上画面を開くたびに再描画
const _openSalesMonth = openSalesMonth;
openSalesMonth = function(){
  _openSalesMonth();
  renderSalesMonth();
};
const _openSalesYear = openSalesYear;
openSalesYear = function(){
  _openSalesYear();
  renderSalesYear();
};
const _openSalesManage = openSalesManage;
openSalesManage = function(){
  _openSalesManage();
  renderSalesManage();
};

/* ========= メニュー登録：OCR 擬似（無料版仕様） ========= */

document.getElementById("btnOcr").onclick = ()=>{
  const file = document.getElementById("mrPhoto").files[0];
  if(!file){
    openModal({title:"写真を選択してください"});
    return;
  }
  // 無料版：擬似OCR（実際は将来API）
  document.getElementById("mrOcrText").value =
    "唐揚げ 600\n枝豆 400\n生ビール 550";
};

document.getElementById("btnOcrToFields").onclick = ()=>{
  const txt = document.getElementById("mrOcrText").value.trim();
  if(!txt){
    openModal({title:"OCR結果がありません"});
    return;
  }
  const line = txt.split(/\n/)[0];
  const m = line.match(/(.+?)\s+(\d+)/);
  if(m){
    document.getElementById("mrName").value = m[1];
    document.getElementById("mrPrice").value = m[2];
  }
};

document.getElementById("btnOcrClear").onclick = ()=>{
  document.getElementById("mrOcrText").value = "";
};

document.getElementById("btnPhotoClear").onclick = ()=>{
  document.getElementById("mrPhoto").value = "";
};

/* ========= メニュー登録：保存・一覧 ========= */

document.getElementById("btnAddMenu").onclick = ()=>{
  const category = document.getElementById("mrCategory").value;
  const genre = document.getElementById("mrGenre").value.trim();
  const name = document.getElementById("mrName").value.trim();
  const price = parseInt(document.getElementById("mrPrice").value||"0",10);

  if(!genre || !name || !price){
    openModal({title:"未入力があります"});
    return;
  }
  state.menus.push({
    id: uid("menu"),
    category,
    genre,
    name,
    price
  });
  save();
  renderMenuRegisterList();
};

document.getElementById("btnClearMenuInputs").onclick = ()=>{
  ["mrGenre","mrName","mrPrice"].forEach(id=> document.getElementById(id).value="");
};

function renderMenuRegisterList(){
  const box = document.getElementById("mrMenuList");
  box.innerHTML = "";
  if(state.menus.length===0){
    box.innerHTML = `<div class="subtle">まだメニューはありません</div>`;
    return;
  }
  state.menus.forEach(m=>{
    box.insertAdjacentHTML("beforeend",
      `<div class="order-row">
        <div>
          <div class="order-name">${escapeHtml(m.name)}</div>
          <div class="order-sub">${escapeHtml(m.genre)} / ${yen(m.price)}</div>
        </div>
      </div>`
    );
  });
}

// メニュー登録画面を開いたら一覧更新
const _openMenuRegister2 = openMenuRegister;
openMenuRegister = function(){
  _openMenuRegister2();
  renderMenuRegisterList();
};

/* ========= バックアップ：注意書き ========= */

document.getElementById("backupText").placeholder =
  "ここにJSONが表示されます。\n別端末に保存／復元できます（無料版）。";

/* ========= 初期データ（初回のみ） ========= */
(function initOnce(){
  if(state.__initialized) return;
  state.__initialized = true;

  // 初期ジャンル例（削除OK）
  if(state.menus.length===0){
    state.menus.push(
      {id:uid("menu"), category:"food", genre:"定番", name:"唐揚げ", price:600},
      {id:uid("menu"), category:"drink", genre:"ビール", name:"生ビール", price:550}
    );
  }
  save();
})();

/* ========= 完全起動後の最終調整 ========= */
(function finalize(){
  // 売上画面の再描画用
  document.getElementById("btnSalesMonth").onclick = ()=> openSalesMonth();
  document.getElementById("btnSalesYear").onclick = ()=> openSalesYear();
  document.getElementById("btnSalesManage").onclick = ()=> openSalesManage();
})();

/* =========================
  PART 6 END（完成）
========================= */
</script>