<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<meta name="theme-color" content="#174b2f" />
<title>ONE</title>

<style>
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  font-family:-apple-system,BlinkMacSystemFont,"Hiragino Sans","Noto Sans JP",sans-serif;
  background:#eaf4df;
  color:#173a27;
}
button{font:inherit}

/* ===== ä¸Šéƒ¨å›ºå®š ===== */
.topBar{
  position:fixed;
  top:0;left:0;right:0;
  height:56px;
  display:flex;
  align-items:center;
  padding:0 10px;
  gap:8px;
  background:linear-gradient(90deg,#1a5636,#14452b,#1a5636);
  z-index:100;
}
.topBar:after{
  content:"";
  position:absolute;
  bottom:0;left:0;right:0;
  height:2px;
  background:#77d86b;
}
.brandBox{
  height:36px;
  width:92px;
  border-radius:12px;
  border:2px solid #d9ff9a;
  background:#174b2f;
  display:flex;
  align-items:center;
  justify-content:center;
  font-weight:900;
  font-size:14px;
  color:#fff;
}
.signalBox{
  width:34px;
  height:34px;
  border-radius:10px;
  background:#3aa55b;
  display:flex;
  align-items:center;
  justify-content:center;
}
.topBtns{
  margin-left:auto;
  display:flex;
  gap:8px;
}
.topBtn{
  height:30px;
  min-width:84px;
  border-radius:16px;
  border:2px solid #d9ff9a;
  background:#174b2f;
  color:#fff;
  font-size:16px;
  font-weight:500;
  padding:0 10px;
}
.topBtn.wKitchen{min-width:100px}

/* ===== ä¸­å¤® ===== */
main{
  padding-top:70px;
  padding-bottom:90px;
  padding-left:10px;
  padding-right:10px;
}
.hint{
  font-weight:700;
  margin:6px 0 10px 0;
}

.seatGrid{
  display:grid;
  grid-template-columns:repeat(3,1fr);
  gap:8px;
}

/* ===== å¸­ã‚«ãƒ¼ãƒ‰ ===== */
.seatCard{
  position:relative;
  min-height:150px;
  padding:6px;
  background:#dff0c9;
  border-radius:16px;
  border:2px solid #174b2f;
  box-shadow:inset 0 0 0 1px #fff;
}
.seatCard.on{
  background:#86df63;
  color:#fff;
  box-shadow:inset 0 0 0 1px #fff,0 0 0 2px #bdf07a;
}
.seatNo{
  position:absolute;
  left:6px;
  top:6px;
  font-size:32px;
  font-weight:900;
}
.seatPeople{
  position:absolute;
  right:6px;
  top:16px;
  font-size:15px;
  font-weight:700;
}
.seatName{
  position:absolute;
  left:6px;
  top:52px;
  font-size:15px;
  font-weight:700;
}
.seatState{
  position:absolute;
  left:6px;
  top:74px;
  font-size:15px;
  font-weight:700;
}
.seatDivider{
  position:absolute;
  left:6px;
  right:6px;
  bottom:34px;
  height:2px;
  background:#000;
  opacity:.3;
}
.seatPrice{
  position:absolute;
  left:6px;
  bottom:8px;
  font-size:16px;
  font-weight:800;
}

/* ===== ä¸‹æ®µå›ºå®š ===== */
.bottomBar{
  position:fixed;
  bottom:0;left:0;right:0;
  height:76px;
  background:#eadfcf;
  display:flex;
  align-items:center;
  padding:0 10px;
}
.navGroup{
  width:100%;
  display:flex;
  border-radius:14px;
  overflow:hidden;
  border:2px solid #f2eadf;
  box-shadow:inset 0 0 0 1px #6b4b2c;
}
.navBtn{
  flex:1;
  background:#e2d3bf;
  border:none;
  font-weight:800;
  font-size:18px;
  color:#2f2217;
}
.navSep{
  width:5px;
  background:linear-gradient(90deg,#f2eadf,#6b4b2c,#f2eadf);
}
</style>
</head>

<body>

<header class="topBar">
  <div class="brandBox">ğŸŸ¢ONE</div>

  <div class="signalBox">
    <svg width="20" height="20" viewBox="0 0 24 24">
      <path fill="#fff" d="M3 20h2v-2H3v2zm4 0h2v-4H7v4zm4 0h2v-6h-2v6zm4 0h2v-8h-2v8zm4 0h2V4h-2v16z"/>
    </svg>
  </div>

  <div class="topBtns">
    <button class="topBtn wKitchen" id="btnKitchen">ã‚­ãƒƒãƒãƒ³</button>
    <button class="topBtn" id="btnSave">ä¿å­˜</button>
  </div>
</header>

<main>
  <section class="screen active" id="scrMain">
    <div class="hint">ç©ºå¸­ã‚’ã‚¿ãƒƒãƒ—ã§ æ¥åº— / äºˆç´„ ã‚’åˆ‡æ›¿</div>
    <div class="seatGrid" id="seatGrid"></div>
  </section>

  <!-- æ—¢å­˜screenã¯å‰Šã‚‰ãªã„ -->
  <section class="screen" id="scrSeatSetup"></section>
  <section class="screen" id="scrKitchen"></section>
  <section class="screen" id="scrSettings"></section>
</main>

<footer class="bottomBar">
  <div class="navGroup">
    <button class="navBtn" id="navMove">å¸­ç§»å‹•</button>
    <div class="navSep"></div>
    <button class="navBtn" id="navSales">æœ¬æ—¥ã®å£²ä¸Š</button>
    <div class="navSep"></div>
    <button class="navBtn" id="navSettings">è¨­å®š</button>
  </div>
</footer>

<script>
/* ã“ã“ã§ã¯é–‰ã˜ãªã„ã€‚PART2ã¸ç¶šã */
/* =========================
  PART2ï¼šæ³¨æ–‡ï¼ˆæœ¬æ¥ã®æ§‹æˆã«å¾©å…ƒï¼‰ï¼‹å¸­ã‚¿ãƒƒãƒ—å‹•ç·šï¼ˆç©ºå¸­/äºˆç´„/æ¥åº—/åˆæµï¼‰ï¼‹å¸­ç§»å‹•ï¼ˆå¾©æ´»ï¼‰
  é‡è¦ï¼š
   - â€œå¼¾ã‹ã‚Œã‚‹â€åŸå› ã«ãªã‚Šã‚„ã™ã„ touchend preventDefault ã¯ã‚„ã‚‰ãªã„
   - dblclick ã®ã¿è»½ãæŠ‘æ­¢ï¼ˆå…¥åŠ›/ãƒ¢ãƒ¼ãƒ€ãƒ«å†…ã¯é™¤å¤–ï¼‰
   - IDè¡çªå›é¿ï¼šæ³¨æ–‡UIã®IDã¯ orderCatFood / orderCatDrink ç­‰
========================= */


/* =========================================================
   0) è»½ã„ã‚ºãƒ¼ãƒ æŠ‘æ­¢ï¼ˆdblclickã®ã¿ï¼‰
   â€» touchend preventDefault ã¯ã‚¯ãƒªãƒƒã‚¯ãŒæ­»ã¬äº‹ãŒã‚ã‚‹ã®ã§ã‚„ã‚‰ãªã„
========================================================= */
(function preventDoubleTapZoomSafe(){
  if(preventDoubleTapZoomSafe._done) return;
  preventDoubleTapZoomSafe._done = true;

  document.addEventListener("dblclick", function(e){
    const t = e.target;
    if(
      t && t.closest &&
      (
        t.closest("input,textarea,select,button,[contenteditable='true'],label") ||
        t.closest("#modalBackdrop,.modal,.modalCard,.sheet,.dialog,.overlay,.modalMask,[role='dialog']")
      )
    ){
      return; // çµ¶å¯¾ã«é‚ªé­”ã—ãªã„
    }
    if(e.cancelable) e.preventDefault();
  }, {passive:false});
})();


/* =========================================================
   1) æ³¨æ–‡UIï¼ˆIDè¡çªã—ãªã„ç‰ˆï¼‰
========================================================= */
(function buildOrderUI_v3(){
  if(buildOrderUI_v3._built) return;
  buildOrderUI_v3._built = true;

  const scr = $("scrOrder");
  scr.innerHTML = `
    <!-- ä¸Šéƒ¨ï¼šæ³¨æ–‡ / å¸­ç•ªå· / ä¼šè¨ˆï¼ˆå…¥å£ï¼‰ -->
    <div style="display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:10px">
      <div style="font-weight:1000; font-size:22px">æ³¨æ–‡</div>
      <div style="font-weight:1000; opacity:.9" id="orderSeatLabel"></div>
      <button class="btn lime" id="orderGoPay">ä¼šè¨ˆ</button>
    </div>

    <!-- ä¸­éƒ¨ä¸Šæ®µï¼šæ–™ç†/ãƒ‰ãƒªãƒ³ã‚¯/æˆ»ã‚‹ -->
    <div style="display:flex; gap:10px; margin-bottom:10px">
      <button class="btn" id="orderCatFood" style="flex:1">æ–™ç†</button>
      <button class="btn" id="orderCatDrink" style="flex:1">ãƒ‰ãƒªãƒ³ã‚¯</button>
      <button class="btn" id="orderBackMain" style="flex:1">æˆ»ã‚‹</button>
    </div>

    <!-- ã‚¸ãƒ£ãƒ³ãƒ«ï¼ˆ3åˆ—ï¼‰ -->
    <div id="orderGenreWrap" style="display:none; margin-bottom:12px">
      <div class="seatGrid" id="orderGenreGrid"></div>
    </div>

    <!-- å•†å“ï¼ˆ3åˆ—ï¼‰ï¼‹æˆ»ã‚‹ -->
    <div id="orderItemsWrap" style="display:none; margin-bottom:12px">
      <div style="display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:10px">
        <div style="font-weight:1000; font-size:20px" id="orderPickedGenre"></div>
        <button class="btn" id="orderItemsBack">æˆ»ã‚‹</button>
      </div>
      <div class="seatGrid" id="orderItemsGrid"></div>
    </div>

    <!-- æ³¨æ–‡å±¥æ­´ï¼ˆç¸¦ï¼‰ -->
    <div style="margin-top:10px">
      <div style="font-weight:1000; margin-bottom:8px; font-size:20px">æ³¨æ–‡å±¥æ­´</div>
      <div id="orderHistory"></div>
    </div>
  `;
})();


/* =========================================================
   2) æ³¨æ–‡ãƒ‡ãƒ¼ã‚¿ï¼ˆå£Šã•ãªã„ï¼šè¶³ã™ã ã‘ï¼‰
========================================================= */
function getOrderBucket(seat, subId){
  if(seat.merged){
    const b = ensureSub(seat, subId);
    b.orders = b.orders || [];       // é›†è¨ˆ
    b.orderLog = b.orderLog || [];   // å±¥æ­´
    return b;
  }
  seat.orders = seat.orders || [];
  seat.orderLog = seat.orderLog || [];
  return seat;
}

function upsertOrderAgg(bucket, item, delta){
  let o = (bucket.orders||[]).find(x=> x.itemId===item.id);
  const d = Number(delta||0);

  if(!o){
    if(d <= 0) return;
    bucket.orders.push({ itemId:item.id, name:item.name, price:item.price, tax:item.tax, qty:d, cat:item.cat, genre:item.genre });
    return;
  }
  o.qty = Number(o.qty||0) + d;
  if(o.qty <= 0){
    bucket.orders = bucket.orders.filter(x=> x.itemId!==item.id);
  }
}

function pushOrderLog(bucket, item, delta, reason){
  bucket.orderLog = bucket.orderLog || [];
  bucket.orderLog.unshift({
    id: "ol_" + Math.random().toString(36).slice(2),
    ts: nowTs(),
    itemId: item.id,
    name: item.name,
    delta: Number(delta||0),
    reason: reason || "",
  });
}

function formatHM(ts){
  const d = new Date(ts);
  return `${pad2(d.getHours())}:${pad2(d.getMinutes())}`;
}


/* =========================================================
   3) æ³¨æ–‡çŠ¶æ…‹
========================================================= */
state.order = state.order || { seatId:null, subId:null, cat:null, genre:null };


/* =========================================================
   4) æ³¨æ–‡ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
========================================================= */
function setBtnHL(btn, on){
  btn.classList.toggle("lime", !!on);
}

function listGenresByCat(cat){
  return (state.menu?.genres?.[cat] || []).slice();
}

function listItemsBy(cat, genre){
  return (state.menu?.items || []).filter(it=> it.cat===cat && it.genre===genre);
}

function renderOrder_v3(){
  const seat = seatById(state.order.seatId);
  if(!seat){ showScreen("scrMain"); return; }

  const subId = state.order.subId || seat.id;
  $("orderSeatLabel").textContent = seat.merged ? `${seat.mergeLabel} / ${subId}` : `${seat.id}`;

  // ä¼šè¨ˆå…¥å£ï¼ˆä¼šè¨ˆç”»é¢ã¯åˆ¥ãƒ‘ãƒ¼ãƒˆã§å®Ÿè£…ï¼‰
  $("orderGoPay").onclick = ()=> toast("ä¼šè¨ˆï¼ˆåˆ¥ãƒ‘ãƒ¼ãƒˆã§å®Ÿè£…ï¼‰");

  // ãƒ¡ã‚¤ãƒ³ã¸æˆ»ã‚‹
  $("orderBackMain").onclick = ()=>{
    state.order.cat = null;
    state.order.genre = null;
    showScreen("scrMain");
  };

  const foodBtn = $("orderCatFood");
  const drinkBtn = $("orderCatDrink");

  foodBtn.onclick = ()=> toggleCat("food");
  drinkBtn.onclick = ()=> toggleCat("drink");

  function toggleCat(cat){
    if(state.order.cat === cat){
      state.order.cat = null;
      state.order.genre = null;
      renderOrder_v3();
      return;
    }
    state.order.cat = cat;
    state.order.genre = null;
    renderOrder_v3();
  }

  setBtnHL(foodBtn, state.order.cat==="food");
  setBtnHL(drinkBtn, state.order.cat==="drink");

  const gw = $("orderGenreWrap");
  const gg = $("orderGenreGrid");
  const iw = $("orderItemsWrap");
  const ig = $("orderItemsGrid");

  gg.innerHTML = "";
  ig.innerHTML = "";

  if(!state.order.cat){
    gw.style.display = "none";
    iw.style.display = "none";
  }else{
    const genres = listGenresByCat(state.order.cat);
    gw.style.display = "block";
    iw.style.display = "none";

    if(genres.length===0){
      gg.innerHTML = `<div class="panel muted">ã‚¸ãƒ£ãƒ³ãƒ«ãŒã‚ã‚Šã¾ã›ã‚“ã€‚å…ˆã«ãƒ¡ãƒ‹ãƒ¥ãƒ¼ç™»éŒ²ã‚’ã—ã¦ãã ã•ã„ã€‚</div>`;
    }else{
      genres.forEach(g=>{
        const b = document.createElement("div");
        b.className = "seatCard";
        b.style.minHeight="66px";
        b.style.display="flex";
        b.style.alignItems="center";
        b.style.justifyContent="center";
        b.style.fontWeight="1000";
        b.style.fontSize="18px";
        b.textContent = g;
        b.onclick = ()=>{
          state.order.genre = g;
          renderOrder_v3();
        };
        gg.appendChild(b);
      });
    }
  }

  if(state.order.cat && state.order.genre){
    gw.style.display = "none";
    iw.style.display = "block";
    $("orderPickedGenre").textContent = state.order.genre;

    $("orderItemsBack").onclick = ()=>{
      state.order.genre = null;
      renderOrder_v3();
    };

    const items = listItemsBy(state.order.cat, state.order.genre);
    if(items.length===0){
      ig.innerHTML = `<div class="panel muted">ã“ã®ã‚¸ãƒ£ãƒ³ãƒ«ã«å•†å“ãŒã‚ã‚Šã¾ã›ã‚“</div>`;
    }else{
      items.forEach(it=>{
        const c = document.createElement("div");
        c.className = "seatCard";
        c.style.minHeight="96px";
        c.style.display="flex";
        c.style.flexDirection="column";
        c.style.justifyContent="space-between";
        c.innerHTML = `
          <div style="font-weight:1000; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; font-size:18px">${it.name}</div>
          <div style="opacity:.9; font-weight:1000; font-size:18px">${yen(it.price)}</div>
        `;
        c.onclick = ()=> openOrderDeltaModal_v3(seat, subId, it);
        ig.appendChild(c);
      });
    }
  }

  renderOrderHistory_v3(seat, subId);
}

function openOrderDeltaModal_v3(seat, subId, item){
  const bucket = getOrderBucket(seat, subId);
  let delta = 0;

  openModal(
    "æ³¨æ–‡",
    `
      <div style="font-weight:1000; font-size:20px; margin-bottom:10px">${item.name}</div>
      <div class="muted" style="margin-bottom:14px">${yen(item.price)} / ç¨${item.tax}%</div>

      <div style="display:flex; align-items:center; justify-content:center; gap:12px; margin-bottom:14px">
        <button class="btn" id="odMinus" style="min-width:72px">â—€ï¸</button>
        <div class="pill" id="odVal" style="min-width:120px">0</div>
        <button class="btn lime" id="odPlus" style="min-width:72px">â–¶ï¸</button>
      </div>

      <div class="muted">â€» è¿½åŠ ã™ã‚‹æ•°ã‚’é¸ã‚“ã§ãã ã•ã„ï¼ˆ0ãªã‚‰è¿½åŠ ãªã—ï¼‰</div>
    `,
    [
      {label:"æˆ»ã‚‹", lime:false, onClick:()=> closeModal()},
      {label:"æ±ºå®š", lime:true, onClick:()=>{
        if(delta===0){ closeModal(); return; }

        upsertOrderAgg(bucket, item, delta);
        pushOrderLog(bucket, item, delta, "è¿½åŠ ");

        seat.status = "in";
        seat.people = Math.max(1, Number(seat.people||1));
        seat.bills = 1;

        const sum = calcOrdersTotal(bucket.orders || []);
        if(seat.merged){
          bucket.total = sum;
          seat.total = calcSeatTotal(seat);
        }else{
          seat.total = sum;
        }

        if(typeof emitEvent==="function") emitEvent("order_delta", {seatId: seat.id, subId, itemId: item.id, delta});

        closeModal();
        renderSeats();
        renderOrder_v3();
      }},
    ],
    seat.id
  );

  setTimeout(()=>{
    const setVal = ()=> $("odVal").textContent = String(delta);

    $("odMinus").onclick = ()=>{
      if(delta<=0) return;
      delta -= 1;
      setVal();
    };
    $("odPlus").onclick = ()=>{
      delta += 1;
      setVal();
    };

    setVal();
  },0);
}

function renderOrderHistory_v3(seat, subId){
  const bucket = getOrderBucket(seat, subId);
  const box = $("orderHistory");
  box.innerHTML = "";

  const agg = (bucket.orders || []).slice().sort((a,b)=> (b.qty||0) - (a.qty||0));
  if(agg.length===0){
    box.innerHTML = `<div class="panel muted">ã¾ã ã‚ã‚Šã¾ã›ã‚“</div>`;
    return;
  }

  agg.forEach(a=>{
    const row = document.createElement("div");
    row.style.border = "none";
    row.style.borderRadius = "26px";
    row.style.padding = "12px";
    row.style.background = "var(--panel)";
    row.style.marginBottom = "10px";

    row.innerHTML = `
      <div style="display:flex; justify-content:space-between; gap:10px; align-items:center">
        <div style="min-width:0">
          <div style="font-weight:1000; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; font-size:18px">${a.name} Ã— ${a.qty}</div>
          <div class="muted" style="margin-top:4px; font-weight:1000; font-size:18px">${yen((Number(a.price||0) * Number(a.qty||0)))}</div>
        </div>
        <button class="btn" data-hfix="${a.itemId}">ä¿®æ­£</button>
      </div>
    `;
    box.appendChild(row);

    row.querySelector(`[data-hfix="${a.itemId}"]`).onclick = ()=>{
      openHistoryConfirm_v3(seat, subId, a.itemId);
    };
  });
}


/* =========================================================
   5) å±¥æ­´ â†’ ç¢ºèª â†’ ä¿®æ­£ï¼ˆä¿æŒï¼‰
========================================================= */
const ORDER_FIX_REASONS = ["æœªæä¾›","æ•°ãˆé–“é•ã„","æ³¨æ–‡å–ã‚Šé•ã„","æä¾›æ¸ˆã¿å–æ¶ˆ","ãã®ä»–"];

function openHistoryConfirm_v3(seat, subId, itemId){
  const bucket = getOrderBucket(seat, subId);
  const agg = (bucket.orders || []).find(x=> x.itemId===itemId);
  if(!agg) return;

  const logs = (bucket.orderLog || []).filter(l=> l.itemId===itemId).slice(0, 8);
  const lines = logs.map(l=>`
    <div style="display:flex; justify-content:space-between; gap:10px; padding:8px 0; border-bottom:1px solid rgba(0,0,0,0.08)">
      <div class="muted">${formatHM(l.ts)}</div>
      <div style="font-weight:1000">${l.name}</div>
      <div style="font-weight:1000">${l.delta>0?`+${l.delta}`:String(l.delta)}</div>
    </div>
  `).join("");

  openModal(
    "ä¿®æ­£ç¢ºèª",
    `
      <div style="font-weight:1000; font-size:18px; margin-bottom:8px">${agg.name} Ã— ${agg.qty}</div>
      <div class="muted" style="margin-bottom:10px">æ³¨æ–‡å±¥æ­´</div>
      <div>${lines || `<div class="panel muted">å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“</div>`}</div>
      <div style="height:10px"></div>
      <div style="font-weight:1000">ä¿®æ­£ã—ã¾ã™ã‹ï¼Ÿ</div>
    `,
    [
      {label:"æˆ»ã‚‹", lime:false, onClick:()=> closeModal()},
      {label:"ä¿®æ­£", lime:true, onClick:()=>{
        closeModal();
        openHistoryFix_v3(seat, subId, itemId);
      }},
    ],
    seat.id
  );
}

function openHistoryFix_v3(seat, subId, itemId){
  const bucket = getOrderBucket(seat, subId);
  const agg = (bucket.orders || []).find(x=> x.itemId===itemId);
  if(!agg) return;

  let delta = 0;

  openModal(
    "ä¿®æ­£",
    `
      <div style="font-weight:1000; font-size:20px; margin-bottom:8px">${agg.name}</div>
      <div class="muted" style="margin-bottom:12px">ç¾åœ¨ï¼š${agg.qty}</div>

      <div style="margin-bottom:8px; font-weight:1000">ç†ç”±ï¼ˆå¿…é ˆï¼‰</div>
      <select id="ofWhy" class="btn full" style="text-align:left">
        <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
        ${ORDER_FIX_REASONS.map(x=> `<option value="${x}">${x}</option>`).join("")}
      </select>

      <div style="margin-top:14px; font-weight:1000; margin-bottom:8px">å¤‰æ›´ï¼ˆå·®åˆ†ï¼‰</div>
      <div style="display:flex; align-items:center; justify-content:center; gap:12px; margin-bottom:10px">
        <button class="btn" id="ofMinus" style="min-width:72px">â—€ï¸</button>
        <div class="pill" id="ofVal" style="min-width:140px">0</div>
        <button class="btn lime" id="ofPlus" style="min-width:72px">â–¶ï¸</button>
      </div>

      <div class="muted">â€» åˆè¨ˆãŒ0æœªæº€ã«ã¯ã§ãã¾ã›ã‚“</div>
    `,
    [
      {label:"æˆ»ã‚‹", lime:false, onClick:()=> closeModal()},
      {label:"æ±ºå®š", lime:true, onClick:()=>{
        const reason = $("ofWhy").value || "";
        if(!reason){ toast("ç†ç”±ã‚’é¸æŠã—ã¦ãã ã•ã„"); return; }

        const after = Number(agg.qty||0) + Number(delta||0);
        if(after < 0){ toast("0æœªæº€ã«ã¯ã§ãã¾ã›ã‚“"); return; }

        const item = { id: agg.itemId, name: agg.name, price: agg.price, tax: agg.tax, cat: agg.cat, genre: agg.genre };
        upsertOrderAgg(bucket, item, delta);
        pushOrderLog(bucket, item, delta, reason);

        const sum = calcOrdersTotal(bucket.orders || []);
        if(seat.merged){
          bucket.total = sum;
          seat.total = calcSeatTotal(seat);
        }else{
          seat.total = sum;
        }

        if(typeof emitEvent==="function") emitEvent("order_fix", {seatId: seat.id, subId, itemId, delta, reason});

        closeModal();
        renderSeats();
        renderOrder_v3();
        toast("ä¿®æ­£ã—ã¾ã—ãŸ");
      }},
    ],
    seat.id
  );

  setTimeout(()=>{
    const setVal = ()=>{
      const s = delta>0 ? `+${delta}` : String(delta);
      $("ofVal").textContent = s; // ä¸­å¤®å¯„ã›ã¯ pillï¼ˆPART1ï¼‰ã§ä¿è¨¼
    };

    $("ofMinus").onclick = ()=>{
      const cur = Number(agg.qty||0) + delta;
      if(cur <= 0) return;
      delta -= 1;
      setVal();
    };
    $("ofPlus").onclick = ()=>{
      delta += 1;
      setVal();
    };

    setVal();
  },0);
}


/* =========================================================
   6) å¸­ã‚¿ãƒƒãƒ—å‹•ç·šï¼ˆç©ºå¸­ï¼šæ¥åº—/äºˆç´„/æˆ»ã‚‹ ã‚’å¾©æ´»ï¼‰
========================================================= */
function openOrderFor_v3(seatId, subId){
  state.order.seatId = seatId;
  state.order.subId = subId || seatId;
  state.order.cat = null;
  state.order.genre = null;
  showScreen("scrOrder");
  renderOrder_v3();
}

/* ç©ºå¸­ï¼šæ¥åº—/äºˆç´„/æˆ»ã‚‹ */
function openEmptyAction_v3(seat){
  openModal(
    "ç©ºå¸­",
    `<div class="muted" style="margin-bottom:10px">æ¥åº— / äºˆç´„ ã‚’é¸æŠã—ã¦ãã ã•ã„</div>`,
    [
      {label:"æ¥åº—", lime:true, onClick:()=>{
        closeModal();
        seat.status = "in";
        seat.people = Math.max(1, Number(seat.people||1));
        seat.bills = 1;
        seat.name = seat.name || "";
        seat.total = Number(seat.total||0);
        seat.reserve = null;
        seat.merged = false;
        seat.mergeLabel = "";
        seat.sub = null;

        if(typeof emitEvent==="function") emitEvent("seat_in", {seatId: seat.id});
        renderSeats();
        openOrderFor_v3(seat.id, seat.id);
      }},
      {label:"äºˆç´„", lime:false, onClick:()=>{
        closeModal();
        openReserveInput_v3(seat);
      }},
      {label:"æˆ»ã‚‹", lime:false, onClick:()=> closeModal()},
    ],
    seat.id
  );
}

/* äºˆç´„å…¥åŠ› */
function openReserveInput_v3(seat){
  openModal(
    "äºˆç´„å…¥åŠ›",
    `
      <div style="margin-bottom:8px; font-weight:1000">æ¥åº—æ™‚é–“</div>
      <input id="rTime" class="btn full" style="text-align:left" placeholder="ä¾‹ï¼š18:30" inputmode="text" autocomplete="off" />

      <div style="margin-top:12px;margin-bottom:8px; font-weight:1000">åå‰</div>
      <input id="rName" class="btn full" style="text-align:left" placeholder="ä¾‹ï¼šä½è—¤" inputmode="text" autocomplete="off" />

      <div style="margin-top:12px;margin-bottom:8px; font-weight:1000">é€£çµ¡å…ˆ</div>
      <input id="rTel" class="btn full" style="text-align:left" placeholder="é›»è©± / ãƒ¡ãƒ¢" inputmode="text" autocomplete="off" />
    `,
    [
      {label:"ä¿å­˜", lime:true, onClick:()=>{
        const time = ($("rTime").value||"").trim();
        const name = ($("rName").value||"").trim();
        const tel  = ($("rTel").value||"").trim();

        if(!time || !name){ toast("æœªè¨˜å…¥ãŒã‚ã‚Šã¾ã™"); return; }

        seat.status = "reserve";
        seat.people = Math.max(1, Number(seat.people||1));
        seat.reserve = { time, name, tel, note:"" };
        seat.name = "";
        seat.total = 0;
        seat.bills = 0;

        if(typeof emitEvent==="function") emitEvent("reserve_set", {seatId: seat.id, time, name, tel});

        closeModal();
        renderSeats();
        toast("äºˆç´„ã‚’ä¿å­˜ã—ã¾ã—ãŸ");
      }},
      {label:"æˆ»ã‚‹", lime:false, onClick:()=> closeModal()},
    ],
    seat.id
  );
}

/* äºˆç´„ã‚«ãƒ¼ãƒ‰ï¼šæ¥åº—/ã‚­ãƒ£ãƒ³ã‚»ãƒ«/æˆ»ã‚‹ */
function openReserveAction_v3(seat){
  const r = seat.reserve || {};
  openModal(
    "äºˆç´„",
    `
      <div style="margin-bottom:6px; font-weight:1000">æ™‚é–“ï¼š${r.time||""}</div>
      <div style="margin-bottom:6px; font-weight:1000">åå‰ï¼š${r.name||""}</div>
      <div class="muted" style="font-weight:1000">é€£çµ¡å…ˆï¼š${r.tel||""}</div>
    `,
    [
      {label:"æ¥åº—", lime:true, onClick:()=>{
        closeModal();
        seat.status = "in";
        seat.name = r.name || "";
        seat.bills = 1;
        seat.total = Number(seat.total||0);
        seat.reserve = null;

        if(typeof emitEvent==="function") emitEvent("reserve_to_in", {seatId: seat.id});
        renderSeats();
        openOrderFor_v3(seat.id, seat.id);
      }},
      {label:"ã‚­ãƒ£ãƒ³ã‚»ãƒ«", lime:false, onClick:()=>{
        closeModal();
        openModal(
          "ã‚­ãƒ£ãƒ³ã‚»ãƒ«",
          `
            <div style="color:var(--danger); font-weight:1000; margin-bottom:10px">äºˆç´„ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã™</div>
            <input id="rCancelSlide" class="range" type="range" min="0" max="100" value="0" />
          `,
          [{label:"æˆ»ã‚‹", lime:false, onClick:()=> closeModal()}],
          seat.id
        );
        setTimeout(()=>{
          $("rCancelSlide").onchange = ()=>{
            if(Number($("rCancelSlide").value||0) < 88){ $("rCancelSlide").value=0; return; }
            seat.status="empty";
            seat.people=0;
            seat.reserve=null;
            seat.name="";
            seat.total=0;
            seat.bills=0;
            seat.orders=[];
            seat.orderLog=[];
            if(typeof emitEvent==="function") emitEvent("reserve_cancel", {seatId: seat.id});
            closeModal();
            renderSeats();
            toast("ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸ");
          };
        },0);
      }},
      {label:"æˆ»ã‚‹", lime:false, onClick:()=> closeModal()},
    ],
    seat.id
  );
}

/* åˆæµå¸­ï¼šã©ã‚Œã‚’æ“ä½œï¼Ÿ */
function openMergedPick_v3(seat){
  const subs = Object.values(seat.sub||{});
  if(subs.length<=1){
    openOrderFor_v3(seat.id, seat.id);
    return;
  }

  const buttons = subs.map(su=>({
    label: su.seatId,
    lime:true,
    onClick:()=>{
      closeModal();
      openOrderFor_v3(seat.id, su.seatId);
    }
  }));
  buttons.push({label:"æˆ»ã‚‹", lime:false, onClick:()=> closeModal()});

  openModal("ã©ã¡ã‚‰ã®æ³¨æ–‡ã€ä¼šè¨ˆã‚’ã—ã¾ã™ã‹ï¼Ÿ", `<div class="muted">å¸­ã‚’é¸æŠã—ã¦ãã ã•ã„</div>`, buttons, seat.id);
}

/* å¸­ã‚«ãƒ¼ãƒ‰ã‚¿ãƒƒãƒ—ï¼šæœ¬ä½“ï¼ˆPART1ã® onSeatTap ã‚’ä¸Šæ›¸ãï¼‰ */
onSeatTap = function(seatId){
  const seat = seatById(seatId);
  if(!seat) return;

  if(seat.status==="empty"){ openEmptyAction_v3(seat); return; }
  if(seat.status==="reserve"){ openReserveAction_v3(seat); return; }

  if(seat.merged){ openMergedPick_v3(seat); return; }

  openOrderFor_v3(seat.id, seat.id);
};


/* =========================================================
   7) æ³¨æ–‡ç”»é¢ã«å…¥ã£ãŸã‚‰å¿…ãšæç”»ï¼ˆshowScreenãƒ•ãƒƒã‚¯ï¼‰
========================================================= */
(function hookShowScreenOrder_v3(){
  if(showScreen._orderHookedV3) return;
  const _show = showScreen;
  showScreen = function(id){
    _show(id);
    if(id==="scrOrder"){
      try{ renderOrder_v3(); }catch(e){}
    }
  };
  showScreen._orderHookedV3 = true;
})();


/* =========================================================
   8) å¸­ç§»å‹•ï¼ˆå¾©æ´»ï¼‰ï¼šç§»å‹•/åˆæµãƒˆã‚°ãƒ«ï¼‹å¸­ã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼ï¼‹ã‚¹ãƒ©ã‚¤ãƒ‰ç¢ºå®š
   - PART1ã® openMoveHome() ã‚’ã“ã“ã§ä¸Šæ›¸ãã—ã¦å¾©æ´»
========================================================= */
(function reviveSeatMove_v1(){
  if(reviveSeatMove_v1._done) return;
  reviveSeatMove_v1._done = true;

  function allSeatsArray(){
    const s = state.seats;
    if(!s) return [];
    if(Array.isArray(s)) return s.slice();
    try{ return Object.values(s); }catch(e){ return []; }
  }

  function safeSeatId(seat){
    return (seat && (seat.id || seat.seatId || "")) + "";
  }

  function seatSortKey(id){
    const t = String(id||"").trim();
    const m = t.match(/^([A-Za-z]+)?\s*0*([0-9]+)?$/);
    if(m){
      const a = (m[1]||"").toUpperCase();
      const n = m[2] ? Number(m[2]) : -1;
      return `${a.padEnd(4,"~")}_${String(n).padStart(6,"0")}_${t}`;
    }
    return `~~~~_${t}`;
  }

  function pickSeatGridHtml(seats, selectedId, dataKey){
    const cards = seats.map(seat=>{
      const id = safeSeatId(seat);
      const sel = (id===selectedId);
      const label = id || "(?)";
      const st = seat.status || "empty";
      const badge =
        st==="empty" ? `ç©ºå¸­` :
        st==="reserve" ? `äºˆç´„` :
        seat.merged ? `åˆæµ` :
        `æ¥åº—`;

      return `
        <div class="seatCard" data-${dataKey}="${id}"
             style="min-height:76px; display:flex; flex-direction:column; justify-content:center; align-items:center; gap:6px;
                    ${sel ? "background:rgba(100,178,108,0.18);" : ""}">
          <div style="font-size:22px; font-weight:1000">${label}</div>
          <div class="muted" style="font-weight:1000">${badge}</div>
        </div>
      `;
    }).join("");

    return `<div class="seatGrid">${cards}</div>`;
  }

  function cloneSeatPayload(seat){
    return {
      status: seat.status || "empty",
      people: Number(seat.people||0),
      name: seat.name || "",
      bills: Number(seat.bills||0),
      total: Number(seat.total||0),
      orders: Array.isArray(seat.orders) ? JSON.parse(JSON.stringify(seat.orders)) : [],
      orderLog: Array.isArray(seat.orderLog) ? JSON.parse(JSON.stringify(seat.orderLog)) : [],
      reserve: seat.reserve ? JSON.parse(JSON.stringify(seat.reserve)) : null,
      merged: !!seat.merged,
      mergeLabel: seat.mergeLabel || "",
      sub: seat.sub ? JSON.parse(JSON.stringify(seat.sub)) : null,
    };
  }

  function resetSeatToEmpty(seat){
    seat.status="empty";
    seat.people=0;
    seat.name="";
    seat.bills=0;
    seat.total=0;
    seat.orders=[];
    seat.orderLog=[];
    seat.reserve=null;
    seat.merged=false;
    seat.mergeLabel="";
    seat.sub=null;
  }

  function ensureMergedContainer(target){
    if(target.merged){
      target.sub = target.sub || {};
      return;
    }
    const keep = cloneSeatPayload(target);
    target.merged = true;
    target.mergeLabel = target.mergeLabel || (target.id || "");
    target.sub = target.sub || {};

    const selfId = (target.id || "");
    target.sub[selfId] = target.sub[selfId] || { seatId: selfId, orders: [], orderLog: [], total: 0 };

    target.sub[selfId].orders = keep.orders || [];
    target.sub[selfId].orderLog = keep.orderLog || [];
    target.sub[selfId].total = calcOrdersTotal(keep.orders || []);
    target.total = calcSeatTotal(target);
  }

  function moveSeat(fromSeat, toSeat){
    const payload = cloneSeatPayload(fromSeat);
    if((toSeat.status||"empty")!=="empty"){
      toast("ç§»å‹•å…ˆã¯ç©ºå¸­ã ã‘ã«ã—ã¦ãã ã•ã„");
      return false;
    }
    toSeat.status = payload.status;
    toSeat.people = payload.people;
    toSeat.name = payload.name;
    toSeat.bills = payload.bills;
    toSeat.total = payload.total;
    toSeat.orders = payload.orders || [];
    toSeat.orderLog = payload.orderLog || [];
    toSeat.reserve = payload.reserve;
    toSeat.merged = !!payload.merged;
    toSeat.mergeLabel = payload.mergeLabel || "";
    toSeat.sub = payload.sub;

    resetSeatToEmpty(fromSeat);
    return true;
  }

  function mergeSeat(fromSeat, toSeat){
    if((fromSeat.status||"empty")!=="in"){
      toast("åˆæµå…ƒã¯ã€Œæ¥åº—ä¸­ã€ã®å¸­ã ã‘ã«ã—ã¦ãã ã•ã„");
      return false;
    }
    if(fromSeat.merged){
      toast("åˆæµå…ƒãŒåˆæµå¸­ã¯æœªå¯¾å¿œï¼ˆã¾ãšåˆ†é›¢ã—ã¦ã‹ã‚‰ï¼‰");
      return false;
    }
    if((toSeat.status||"empty")==="empty" || (toSeat.status||"empty")==="reserve"){
      toast("åˆæµå…ˆã¯ã€Œæ¥åº—ä¸­ã€ã‹ã€Œåˆæµå¸­ã€ã‚’é¸ã‚“ã§ãã ã•ã„");
      return false;
    }

    ensureMergedContainer(toSeat);

    const fromId = fromSeat.id || "";
    toSeat.sub = toSeat.sub || {};
    toSeat.sub[fromId] = toSeat.sub[fromId] || { seatId: fromId, orders: [], orderLog: [], total: 0 };
    toSeat.sub[fromId].orders = Array.isArray(fromSeat.orders) ? JSON.parse(JSON.stringify(fromSeat.orders)) : [];
    toSeat.sub[fromId].orderLog = Array.isArray(fromSeat.orderLog) ? JSON.parse(JSON.stringify(fromSeat.orderLog)) : [];
    toSeat.sub[fromId].total = calcOrdersTotal(toSeat.sub[fromId].orders || []);

    toSeat.total = calcSeatTotal(toSeat);
    resetSeatToEmpty(fromSeat);
    return true;
  }

  window.openMoveHome = function openMoveHome(){
    const seats = allSeatsArray()
      .filter(s=> !!safeSeatId(s))
      .sort((a,b)=> seatSortKey(safeSeatId(a)).localeCompare(seatSortKey(safeSeatId(b))));

    if(seats.length===0){
      toast("å¸­ãŒã‚ã‚Šã¾ã›ã‚“ï¼ˆå¸­ç™»éŒ²ã‚’å…ˆã«ï¼‰");
      return;
    }

    let mode = "move"; // move | merge
    let fromId = "";
    let toId = "";

    function renderBody(){
      const fromList = seats.filter(s=>{
        const st = s.status || "empty";
        if(mode==="move"){
          return st !== "empty";
        }
        return st === "in" && !s.merged;
      });

      const toList = seats.filter(s=>{
        const st = s.status || "empty";
        if(mode==="move"){
          return st === "empty";
        }
        return st === "in" || !!s.merged;
      });

      const modeBtns = `
        <div style="display:flex; gap:10px; margin-bottom:12px">
          <button class="btn ${mode==="move"?"lime":""}" id="mvModeMove" style="flex:1">ç§»å‹•</button>
          <button class="btn ${mode==="merge"?"lime":""}" id="mvModeMerge" style="flex:1">åˆæµ</button>
        </div>
      `;

      const fromHtml = `
        <div style="font-weight:1000; margin-bottom:8px; font-size:18px">ã©ã“ã‹ã‚‰</div>
        ${pickSeatGridHtml(fromList, fromId, "mvfrom")}
      `;

      const toHtml = `
        <div style="height:12px"></div>
        <div style="font-weight:1000; margin-bottom:8px; font-size:18px">ã©ã“ã¸</div>
        ${pickSeatGridHtml(toList, toId, "mvto")}
      `;

      const hint = `
        <div style="height:12px"></div>
        <div class="muted">
          ${mode==="move"
            ? "â€» ç§»å‹•ï¼šç§»å‹•å…ˆã¯ç©ºå¸­ã®ã¿ï¼ˆäº‹æ•…é˜²æ­¢ï¼‰"
            : "â€» åˆæµï¼šåˆæµå…ƒã¯æ¥åº—ä¸­ã®ã¿ï¼åˆæµå…ˆã¯æ¥åº—ä¸­ or åˆæµå¸­"}
        </div>
        <div style="height:10px"></div>
        <div style="color:var(--danger); font-weight:1000; margin-bottom:8px">ã‚¹ãƒ©ã‚¤ãƒ‰ã§ç¢ºå®š</div>
        <input id="mvSlide" class="range" type="range" min="0" max="100" value="0" />
      `;

      return modeBtns + fromHtml + toHtml + hint;
    }

    openModal(
      "å¸­ç§»å‹•",
      `<div id="mvWrap">${renderBody()}</div>`,
      [{label:"æˆ»ã‚‹", lime:false, onClick:()=> closeModal()}]
    );

    function wire(){
      const wrap = $("mvWrap");
      if(!wrap) return;

      const rerender = ()=>{
        wrap.innerHTML = renderBody();
        wire();
      };

      const bm = $("mvModeMove");
      const bg = $("mvModeMerge");
      if(bm) bm.onclick = ()=>{ mode="move"; fromId=""; toId=""; rerender(); };
      if(bg) bg.onclick = ()=>{ mode="merge"; fromId=""; toId=""; rerender(); };

      wrap.querySelectorAll("[data-mvfrom]").forEach(el=>{
        el.onclick = ()=>{
          fromId = el.getAttribute("data-mvfrom") || "";
          if(toId === fromId) toId = "";
          rerender();
        };
      });

      wrap.querySelectorAll("[data-mvto]").forEach(el=>{
        el.onclick = ()=>{
          toId = el.getAttribute("data-mvto") || "";
          if(fromId === toId) return;
          rerender();
        };
      });

      const sl = $("mvSlide");
      if(sl){
        sl.onchange = ()=>{
          const v = Number(sl.value||0);
          if(v < 88){ sl.value = 0; return; }

          if(!fromId || !toId){
            toast("ã€Œã©ã“ã‹ã‚‰ã€ã€Œã©ã“ã¸ã€ã‚’é¸ã‚“ã§ãã ã•ã„");
            sl.value = 0;
            return;
          }
          if(fromId === toId){
            toast("åŒã˜å¸­ã¯é¸ã¹ã¾ã›ã‚“");
            sl.value = 0;
            return;
          }

          const fromSeat = seatById(fromId);
          const toSeat = seatById(toId);
          if(!fromSeat || !toSeat){
            toast("å¸­ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");
            sl.value = 0;
            return;
          }

          let ok = false;
          if(mode==="move"){
            ok = moveSeat(fromSeat, toSeat);
            if(ok && typeof emitEvent==="function") emitEvent("seat_move", {from: fromId, to: toId});
          }else{
            ok = mergeSeat(fromSeat, toSeat);
            if(ok && typeof emitEvent==="function") emitEvent("seat_merge", {from: fromId, to: toId});
          }

          if(!ok){ sl.value = 0; return; }

          closeModal();
          renderSeats();
          toast(mode==="move" ? "ç§»å‹•ã—ã¾ã—ãŸ" : "åˆæµã—ã¾ã—ãŸ");
        };
      }
    }

    setTimeout(wire, 0);
  };
})();


/* =========================
  ã“ã“ã‹ã‚‰å…ˆã¯ PART3 ã§ç¶šã
========================= */
/* =========================
  PART3ï¼šã‚­ãƒƒãƒãƒ³ï¼ˆå®Œæˆç‰ˆï¼‰
  å½¹å‰²ï¼šæœªèª¿ç†ä¸€è¦§ / åŒä¸€ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã¾ã¨ã‚ / ã‚¹ãƒ©ã‚¤ãƒ‰å®Œäº† / æä¾›æ¸ˆæŠ˜ã‚ŠãŸãŸã¿
  è¿½åŠ ï¼šæ³¨æ–‡ã‹ã‚‰ã‚­ãƒƒãƒãƒ³ã¸ç©ã‚€ï¼ˆæ–™ç†/ãƒ‰ãƒªãƒ³ã‚¯ï¼‰
========================= */

/* ===== UIå·®ã—æ›¿ãˆ ===== */
(function buildKitchenUI(){
  const scr = $("scrKitchen");
  scr.innerHTML = `
    <div style="font-weight:900; margin-bottom:10px">ã‚­ãƒƒãƒãƒ³</div>

    <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin-bottom:10px">
      <div style="opacity:.9">è¡¨ç¤ºï¼š</div>
      <button class="btn" id="kFilterFood">æ–™ç†</button>
      <button class="btn" id="kFilterDrink">ãƒ‰ãƒªãƒ³ã‚¯</button>
      <button class="btn ghost" id="kToggleDone">æä¾›æ¸ˆã‚’è¡¨ç¤º</button>
    </div>

    <div id="kList"></div>

    <div style="height:12px"></div>

    <div id="kDoneWrap" style="display:none">
      <div style="font-weight:900; margin-bottom:10px">æä¾›æ¸ˆ</div>
      <div id="kDoneList"></div>
    </div>
  `;
})();

/* ===== State ===== */
state.kitchen = state.kitchen || {
  showDone:false,
  showFood:true,
  showDrink:true,
  items: [] // {kid, ts, seatId, subId, name, qty, cat, status}
};

/* ===== æ³¨æ–‡â†’ã‚­ãƒƒãƒãƒ³ã¸ç©ã‚€ ===== */
function addKitchenFromOrder(seat, subId, item){
  // item.cat: "food" | "drink"
  const cat = item.cat || "food";
  const key = `${seat.id}__${subId}__${item.id}`;

  // åŒä¸€å•†å“ã¯ qty ã‚’ã¾ã¨ã‚ã‚‹ï¼ˆã‚­ãƒƒãƒãƒ³ã‚‚ã¾ã¨ã‚ã‚„ã™ãï¼‰
  let found = state.kitchen.items.find(x=> x._key===key && x.status==="todo");
  if(!found){
    found = {
      kid: "k_" + Math.random().toString(36).slice(2),
      _key: key,
      ts: nowTs(),
      seatId: seat.id,
      subId,
      name: item.name,
      qty: 1,
      cat,
      status:"todo"
    };
    state.kitchen.items.push(found);
  }else{
    found.qty += 1;
  }
}

/* ===== CSSï¼ˆã‚­ãƒƒãƒãƒ³å°‚ç”¨ï¼‰ ===== */
(function injectPart3Css(){
  const css = `
    .kRow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:10px;
      border:1px solid rgba(255,255,255,0.10);
      border-radius:14px;
      background:rgba(255,255,255,0.04);
      margin-bottom:10px;
    }
    .kLeft{
      min-width:0;
      display:flex;
      align-items:center;
      gap:10px;
      flex:1;
    }
    .kTime{ font-weight:900; width:56px; }
    .kSeat{ font-weight:900; width:52px; }
    .kName{
      min-width:0;
      font-weight:900;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    .kQty{
      font-weight:900;
      opacity:.85;
      margin-left:6px;
    }

    .kChild{ margin-left:18px; position:relative; }
    .kChild::before{
      content:"";
      position:absolute;
      left:-10px; top:0; bottom:0;
      width:2px;
      background:rgba(122,167,255,0.45);
      border-radius:99px;
    }
    .kChild .kRow{ background:rgba(122,167,255,0.08); }

    .kSlide{
      width:25vw;
      max-width:160px;
      min-width:110px;
      display:flex;
      align-items:center;
      gap:8px;
      justify-content:flex-end;
    }
    .kRange{ width:100%; accent-color: var(--accent); }
    .kDoneBadge{ font-size:12px; color:var(--ok); font-weight:900; }
  `;
  const st = document.createElement("style");
  st.textContent = css;
  document.head.appendChild(st);
})();

/* ===== Helpers ===== */
function hhmm(ts){
  const d = new Date(ts);
  return `${pad2(d.getHours())}:${pad2(d.getMinutes())}`;
}
function passCategory(item){
  if(item.cat==="food" && !state.kitchen.showFood) return false;
  if(item.cat==="drink" && !state.kitchen.showDrink) return false;
  return true;
}

/* åŒä¸€ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã¾ã¨ã‚ï¼šè¦ªï¼æœ€å¤ */
function buildKitchenGroups(list){
  const map = new Map();
  list.forEach(it=>{
    const key = `${it.name}__${it.cat}`;
    if(!map.has(key)) map.set(key, []);
    map.get(key).push(it);
  });

  const groups = [];
  map.forEach(arr=>{
    arr.sort((a,b)=> a.ts-b.ts);
    groups.push(arr);
  });
  groups.sort((ga,gb)=> ga[0].ts - gb[0].ts);
  return groups;
}

/* ===== Render ===== */
function renderKitchen(){
  const todo = state.kitchen.items.filter(it=> it.status==="todo").filter(passCategory);
  const done = state.kitchen.items.filter(it=> it.status==="done").filter(passCategory);

  const listBox = $("kList");
  const doneWrap = $("kDoneWrap");
  const doneBox  = $("kDoneList");

  listBox.innerHTML = "";
  doneBox.innerHTML = "";

  const groups = buildKitchenGroups(todo);
  if(groups.length===0){
    listBox.innerHTML = `<div style="opacity:.85">æœªèª¿ç†ã¯ã‚ã‚Šã¾ã›ã‚“</div>`;
  }else{
    groups.forEach(arr=>{
      listBox.appendChild(kRowEl(arr[0], false));
      arr.slice(1).forEach(ch=>{
        const wrap = document.createElement("div");
        wrap.className = "kChild";
        wrap.appendChild(kRowEl(ch, false));
        listBox.appendChild(wrap);
      });
    });
  }

  doneWrap.style.display = state.kitchen.showDone ? "block" : "none";
  if(state.kitchen.showDone){
    const groupsD = buildKitchenGroups(done);
    if(groupsD.length===0){
      doneBox.innerHTML = `<div style="opacity:.85">æä¾›æ¸ˆã¯ã‚ã‚Šã¾ã›ã‚“</div>`;
    }else{
      groupsD.forEach(arr=>{
        doneBox.appendChild(kRowEl(arr[0], true));
        arr.slice(1).forEach(ch=>{
          const wrap = document.createElement("div");
          wrap.className = "kChild";
          wrap.appendChild(kRowEl(ch, true));
          doneBox.appendChild(wrap);
        });
      });
    }
  }
}

function kRowEl(item, isDone){
  const row = document.createElement("div");
  row.className = "kRow";

  const qtyText = (Number(item.qty||0) >= 2) ? `Ã—${item.qty}` : "";
  const seatLabel = item.subId && item.subId!==item.seatId ? `${item.seatId}/${item.subId}` : `${item.seatId}`;

  row.innerHTML = `
    <div class="kLeft">
      <div class="kTime">${hhmm(item.ts)}</div>
      <div class="kSeat">${seatLabel}</div>
      <div class="kName">${item.name}<span class="kQty">${qtyText}</span></div>
    </div>
    <div class="kSlide">
      ${isDone ? `<span class="kDoneBadge">å®Œäº†</span>` : ``}
      <input class="kRange" type="range" min="0" max="100" value="0" aria-label="ã‚¹ãƒ©ã‚¤ãƒ‰ã§å®Œäº†" />
    </div>
  `;

  const range = row.querySelector(".kRange");
  const TH = 88;

  range.addEventListener("change", ()=>{
    const v = Number(range.value||0);
    if(v >= TH){
      item.status = isDone ? "todo" : "done";
      range.value = 0;
      renderKitchen();
    }else{
      range.value = 0;
    }
  });

  return row;
}

/* ===== Buttons ===== */
$("kToggleDone").onclick = ()=>{
  state.kitchen.showDone = !state.kitchen.showDone;
  $("kToggleDone").textContent = state.kitchen.showDone ? "æä¾›æ¸ˆã‚’éš ã™" : "æä¾›æ¸ˆã‚’è¡¨ç¤º";
  renderKitchen();
};

$("kFilterFood").onclick = ()=>{
  state.kitchen.showFood = !state.kitchen.showFood;
  $("kFilterFood").classList.toggle("lime", state.kitchen.showFood);
  renderKitchen();
};
$("kFilterDrink").onclick = ()=>{
  state.kitchen.showDrink = !state.kitchen.showDrink;
  $("kFilterDrink").classList.toggle("lime", state.kitchen.showDrink);
  renderKitchen();
};

/* åˆæœŸ */
$("kFilterFood").classList.add("lime");
$("kFilterDrink").classList.add("lime");

/* showScreen hook */
(function hookShowScreenForKitchen(){
  if(showScreen._kHooked) return;
  const _show = showScreen;
  showScreen = function(id){
    _show(id);
    if(id==="scrKitchen") renderKitchen();
  };
  showScreen._kHooked = true;
})();

renderKitchen();

/* =========================
  ã“ã“ã‹ã‚‰å…ˆã¯ PART4 ã§ç¶šã
========================= */
/* =========================
  PART4ï¼šå£²ä¸Šï¼ˆæœ¬æ—¥ï¼æ—¥åˆ¥ï¼æœˆï¼å¹´ï¼‰
  å½¹å‰²ï¼šé–²è¦§ï¼ˆç„¡æ–™ç‰ˆã§å…¨éƒ¨è¦‹ã‚‹ï¼‰ï¼‹ä¿®æ­£å°ç·šï¼ˆPART5ã¸ï¼‰
  æ–¹é‡ï¼šè»½ããƒ»ä¸å®‰ã‚’ç…½ã‚‰ãªã„ãƒ»ä¿®æ­£ã¯PART5ã¸åˆ†é›¢ï¼ˆè¨‚æ­£ä¼ç¥¨æ–¹å¼ï¼‰
  è¿½åŠ ï¼ˆç¢ºå®šå¯¾å¿œï¼‰ï¼š
    - æœ¬æ—¥ï¼æ—¥åˆ¥ï¼æœˆï¼å¹´ ã‚’ç„¡æ–™ç‰ˆã§é–²è¦§å¯èƒ½
    - æœ¬æ—¥ï¼æ—¥åˆ¥ ã®ä¸€è¦§ã¯ã€Œå…¥åº—/é€€åº—/å¸­(åå‰)/é‡‘é¡/æ”¯æ‰•/ä¿®æ­£ã€
    - ä¿®æ­£å·®åˆ†ï¼ˆè¨‚æ­£ä¼ç¥¨ï¼‰ã¯ â€œå¯¾è±¡è¡Œã®ç›´ä¸‹â€ ã«è¿½åŠ è¡¨ç¤ºï¼ˆä¸Šæ›¸ããªã—ï¼‰
========================= */

/* ===== UIå·®ã—æ›¿ãˆï¼ˆãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ç½®æ›ï¼‰ ===== */
(function buildSalesUI(){
  const scr = $("scrSales");
  scr.innerHTML = `
    <div class="pill" style="margin-bottom:10px">å£²ä¸Š</div>

    <div style="display:flex; gap:8px; margin-bottom:10px; flex-wrap:wrap">
      <button class="btn primary" id="tabToday">æœ¬æ—¥</button>
      <button class="btn" id="tabDaily">æ—¥åˆ¥</button>
      <button class="btn" id="tabMonth">æœˆ</button>
      <button class="btn" id="tabYear">å¹´</button>
    </div>

    <div id="salesToday"></div>
    <div id="salesDaily" style="display:none"></div>
    <div id="salesMonth" style="display:none"></div>
    <div id="salesYear" style="display:none"></div>
  `;
})();

/* ===== PART4 State ===== */
state.sales = state.sales || {
  list: [],
  tab: "today",
  dailyYmd: null, // æ—¥åˆ¥ã§é¸æŠä¸­ã®æ—¥ä»˜ï¼ˆYYYY-MM-DDï¼‰
};

/* ===== Helpers ===== */
function ymd(d){
  return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
}
function sameDay(a,b){
  return a.getFullYear()===b.getFullYear()
      && a.getMonth()===b.getMonth()
      && a.getDate()===b.getDate();
}
function fmtHM(ts){
  if(!ts) return "--:--";
  const d = new Date(ts);
  return `${pad2(d.getHours())}:${pad2(d.getMinutes())}`;
}
function safeNum(n){ n=Number(n); return Number.isFinite(n)?n:0; }

/* ===== Demo Seedï¼ˆinTs/outTsã‚‚ä»˜ã‘ã‚‹ï¼‰ ===== */
(function seedSalesIfEmpty(){
  if(state.sales.list.length) return;

  const now = new Date();
  const mk = (inH,inM,outH,outM,seat,name,pay,amt)=>{
    const inD  = new Date(now.getFullYear(), now.getMonth(), now.getDate(), inH, inM);
    const outD = new Date(now.getFullYear(), now.getMonth(), now.getDate(), outH, outM);
    return {
      saleId: "s"+Math.random().toString(36).slice(2),
      ts: outD.getTime(),      // ä¼šè¨ˆæ™‚åˆ»ï¼ˆé€€åº—å¯„ã‚Šã§OKï¼‰
      inTs: inD.getTime(),
      outTs: outD.getTime(),
      seatId: seat,
      name: name||"",
      pay,
      amount: amt,
      receipt: true,
      items: [
        {name:"ç”Ÿãƒ“ãƒ¼ãƒ«", qty:2, price:600, tax:10},
        {name:"å”æšã’", qty:1, price:800, tax:10},
      ],
      corrections: [] // è¨‚æ­£ä¼ç¥¨ï¼ˆå·®åˆ†ï¼‰ã‚’ã“ã“ã«ç©ã‚€
    };
  };

  state.sales.list.push(
    mk(12,10,12,35,"D","ç”°ä¸­","ã‚«ãƒ¼ãƒ‰",4800),
    mk(13,00,13,10,"A","","ç¾é‡‘",1800),
    mk(13,40,14, 5,"B","ä½è—¤","QR",2200),
  );

  // æ—¥åˆ¥ã®åˆæœŸæ—¥ä»˜ï¼šä»Šæ—¥
  state.sales.dailyYmd = ymd(new Date());
})();

/* ===== Aggregation ===== */
function filterByYmd(targetYmd){
  const rows = state.sales.list.filter(s=>{
    const d = new Date(s.ts);
    return ymd(d) === targetYmd;
  });
  return rows;
}

function aggByRows(rows){
  const sum = rows.reduce((a,b)=> a + safeNum(b.amount), 0);
  const cnt = rows.length;

  const payCnt = {ç¾é‡‘:0, ã‚«ãƒ¼ãƒ‰:0, QR:0};
  const paySum = {ç¾é‡‘:0, ã‚«ãƒ¼ãƒ‰:0, QR:0};

  rows.forEach(s=>{
    const p = s.pay || "ç¾é‡‘";
    if(!(p in payCnt)) payCnt[p]=0;
    if(!(p in paySum)) paySum[p]=0;
    payCnt[p] += 1;
    paySum[p] += safeNum(s.amount);
  });

  return {sum,cnt,payCnt,paySum};
}

function aggToday(){
  const today = ymd(new Date());
  const rows = filterByYmd(today);
  return { ymd: today, rows, ...aggByRows(rows) };
}

function aggDaily(targetYmd){
  const rows = filterByYmd(targetYmd);
  return { ymd: targetYmd, rows, ...aggByRows(rows) };
}

function aggMonth(){
  const d = new Date();
  const y=d.getFullYear(), m=d.getMonth();
  const rows = state.sales.list.filter(s=>{
    const x=new Date(s.ts);
    return x.getFullYear()===y && x.getMonth()===m;
  });
  const sum = rows.reduce((a,b)=> a+safeNum(b.amount), 0);
  return {sum, cnt: rows.length};
}

function aggYear(){
  const y=new Date().getFullYear();
  const rows = state.sales.list.filter(s=> new Date(s.ts).getFullYear()===y);
  const sum = rows.reduce((a,b)=> a+safeNum(b.amount), 0);
  return {sum, cnt: rows.length};
}

/* ===== ä¿®æ­£å°ç·šï¼ˆPART5ã¸ï¼‰ ===== */
function goFix(saleId){
  // PART5å·®ã—æ›¿ãˆç‰ˆï¼šwindow.ONE_openFixForSaleId ãŒã‚ã‚‹æƒ³å®š
  if(typeof window.ONE_openFixForSaleId === "function"){
    window.ONE_openFixForSaleId(saleId);
    return;
  }
  toast("ä¿®æ­£æ©Ÿèƒ½ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ï¼ˆPART5ã‚’åæ˜ ã—ã¦ãã ã•ã„ï¼‰");
}

/* ===== è¨‚æ­£ä¼ç¥¨è¡¨ç¤ºï¼ˆå¯¾è±¡è¡Œã®ç›´ä¸‹ï¼‰ ===== */
function renderCorrectionsInline(s){
  const list = (s.corrections || []);
  if(!list.length) return "";

  // æ–°ã—ã„é †ã«è¦‹ã›ã‚‹ï¼ˆç›´ä¸‹ã«è¤‡æ•°ä¸¦ã¶ï¼‰
  const html = list.slice().sort((a,b)=> (b.ts||0)-(a.ts||0)).map(c=>{
    const beforePay = c.payBefore || s.pay || "";
    const afterPay  = c.payAfter  || "";

    // å•†å“å·®åˆ†ï¼ˆå·¦ï¼šå‰ / å³ï¼šå¾Œï¼‰
    const before = c.itemsBefore || [];
    const after  = c.itemsAfter  || [];

    // åå‰é›†åˆã§ä¸¦ã¹ã‚‹
    const map = new Map();
    before.forEach(it=>{
      const k = it.name || "";
      if(!k) return;
      if(!map.has(k)) map.set(k, {name:k, b:0, a:0});
      map.get(k).b += safeNum(it.qty);
    });
    after.forEach(it=>{
      const k = it.name || "";
      if(!k) return;
      if(!map.has(k)) map.set(k, {name:k, b:0, a:0});
      map.get(k).a += safeNum(it.qty);
    });
    const diffs = Array.from(map.values()).sort((x,y)=> x.name.localeCompare(y.name,"ja"));

    const diffRows = diffs.map(x=>`
      <div style="display:flex; justify-content:space-between; gap:10px; margin:4px 0">
        <div style="min-width:0; overflow:hidden; text-overflow:ellipsis; white-space:nowrap">${x.name}</div>
        <div style="display:flex; gap:8px; font-weight:900">
          <span>${x.b}</span><span style="color:var(--muted)">â†’</span><span>${x.a}</span>
        </div>
      </div>
    `).join("");

    return `
      <div class="pill" style="margin:8px 0 10px; color:var(--muted)">
        è¨‚æ­£ï¼š${fmtHM(c.ts)} ï¼ ${c.who||""} ï¼ ${c.why||""}<br>
        æ”¯æ‰•ï¼š${beforePay}${afterPay?` â†’ ${afterPay}`:""}<br>
        ${diffRows || "ï¼ˆæ•°é‡å¤‰æ›´ãªã—ï¼‰"}
      </div>
    `;
  }).join("");

  return html;
}

/* ===== List Row ===== */
function saleRowEl(s){
  const row = document.createElement("div");
  row.className = "kRow";
  row.dataset.saleId = s.saleId;

  const inT  = fmtHM(s.inTs);
  const outT = fmtHM(s.outTs);
  const seatLabel = `${s.seatId || ""}${s.name ? `ï¼ˆ${s.name}ï¼‰` : ""}`;

  row.innerHTML = `
    <div class="kLeft" style="align-items:flex-start">
      <div style="width:64px; font-weight:900">${inT}</div>
      <div style="width:64px; font-weight:900">${outT}</div>
      <div class="kName" style="font-weight:900">${seatLabel}</div>
    </div>

    <div class="kSlide" style="gap:10px; width:auto">
      <div style="font-weight:900">${yen(s.amount)}</div>
      <div class="pill">${s.pay || "ç¾é‡‘"}</div>
      <button class="btn" data-fix="${s.saleId}">ä¿®æ­£</button>
    </div>
  `;

  // è¡Œã‚¿ãƒƒãƒ—ï¼šè©³ç´°ï¼ˆæ—¢å­˜ã® openSaleDetail ãŒã‚ã‚Œã°ï¼‰
  row.onclick = (e)=>{
    if(e && e.target && e.target.getAttribute && e.target.getAttribute("data-fix")) return;
    if(typeof openSaleDetail === "function") openSaleDetail(s);
  };

  return row;
}

/* ===== Render ===== */
function renderSales(){
  const t = $("salesToday");
  const d = $("salesDaily");
  const m = $("salesMonth");
  const y = $("salesYear");

  t.style.display = state.sales.tab==="today" ? "block":"none";
  d.style.display = state.sales.tab==="daily" ? "block":"none";
  m.style.display = state.sales.tab==="month" ? "block":"none";
  y.style.display = state.sales.tab==="year"  ? "block":"none";

  if(state.sales.tab==="today") renderToday();
  if(state.sales.tab==="daily") renderDaily();
  if(state.sales.tab==="month") renderMonth();
  if(state.sales.tab==="year")  renderYear();
}

function renderToday(){
  const box = $("salesToday");
  const a = aggToday();

  const payTxt = `ç¾é‡‘ ${a.payCnt["ç¾é‡‘"]||0} / ã‚«ãƒ¼ãƒ‰ ${a.payCnt["ã‚«ãƒ¼ãƒ‰"]||0} / QR ${a.payCnt["QR"]||0}`;

  box.innerHTML = `
    <div class="pill" style="margin-bottom:8px">
      åˆè¨ˆ ${yen(a.sum)} ï¼ ä¼šè¨ˆ ${a.cnt}ä»¶ ï¼ ${payTxt}
    </div>

    <div id="todayList"></div>
  `;

  const list = box.querySelector("#todayList");
  if(a.rows.length===0){
    list.innerHTML = `<div class="pill">æœ¬æ—¥ã®ä¼šè¨ˆã¯ã‚ã‚Šã¾ã›ã‚“</div>`;
    return;
  }

  a.rows
    .slice()
    .sort((x,y)=> x.ts - y.ts)
    .forEach(s=>{
      // å…ƒè¡Œ
      const row = saleRowEl(s);
      list.appendChild(row);

      // ç›´ä¸‹ï¼šè¨‚æ­£ä¼ç¥¨ï¼ˆå·®åˆ†ï¼‰
      const inline = renderCorrectionsInline(s);
      if(inline){
        const wrap = document.createElement("div");
        wrap.innerHTML = inline;
        list.appendChild(wrap);
      }
    });

  // ä¿®æ­£ãƒœã‚¿ãƒ³
  list.querySelectorAll("[data-fix]").forEach(btn=>{
    btn.onclick = (e)=>{
      e.stopPropagation();
      const id = btn.getAttribute("data-fix");
      goFix(id);
    };
  });
}

function renderDaily(){
  const box = $("salesDaily");
  const todayY = ymd(new Date());
  const cur = state.sales.dailyYmd || todayY;

  const a = aggDaily(cur);

  box.innerHTML = `
    <div class="pill" style="margin-bottom:8px">æ—¥ä»˜</div>
    <input id="dailyPick" class="btn" style="width:100%; text-align:left; margin-bottom:10px" value="${cur}" />

    <div class="pill" style="margin-bottom:8px">
      æœ¬æ—¥ã®ç·å£²ä¸Š ${yen(a.sum)} ï¼ ç·ä¼šè¨ˆæ•° ${a.cnt}ä»¶
    </div>

    <div class="pill" style="margin-bottom:10px; color:var(--muted)">
      ç¾é‡‘ï¼š${a.payCnt["ç¾é‡‘"]||0}ä»¶ï¼${yen(a.paySum["ç¾é‡‘"]||0)}<br>
      ã‚«ãƒ¼ãƒ‰ï¼š${a.payCnt["ã‚«ãƒ¼ãƒ‰"]||0}ä»¶ï¼${yen(a.paySum["ã‚«ãƒ¼ãƒ‰"]||0)}<br>
      QRï¼š${a.payCnt["QR"]||0}ä»¶ï¼${yen(a.paySum["QR"]||0)}
    </div>

    <div id="dailyList"></div>
  `;

  const list = box.querySelector("#dailyList");
  if(a.rows.length===0){
    list.innerHTML = `<div class="pill">ã“ã®æ—¥ã®ä¼šè¨ˆã¯ã‚ã‚Šã¾ã›ã‚“</div>`;
  }else{
    a.rows
      .slice()
      .sort((x,y)=> x.ts - y.ts)
      .forEach(s=>{
        const row = saleRowEl(s);
        list.appendChild(row);

        const inline = renderCorrectionsInline(s);
        if(inline){
          const wrap = document.createElement("div");
          wrap.innerHTML = inline;
          list.appendChild(wrap);
        }
      });

    list.querySelectorAll("[data-fix]").forEach(btn=>{
      btn.onclick = (e)=>{
        e.stopPropagation();
        const id = btn.getAttribute("data-fix");
        goFix(id);
      };
    });
  }

  // æ—¥ä»˜å¤‰æ›´
  $("dailyPick").onchange = ()=>{
    const v = ($("dailyPick").value||"").trim();
    if(!v){ state.sales.dailyYmd = todayY; }
    else state.sales.dailyYmd = v;
    renderDaily();
  };
}

function renderMonth(){
  const box = $("salesMonth");
  const a = aggMonth();
  box.innerHTML = `
    <div class="pill">æœˆåˆè¨ˆ ${yen(a.sum)} ï¼ ä¼šè¨ˆ ${a.cnt}ä»¶</div>
    <div style="height:8px"></div>
    <div class="pill">ç„¡æ–™ç‰ˆï¼šæœˆã®å†…è¨³ï¼ˆã‚°ãƒ©ãƒ•ç­‰ï¼‰ã¯ä»Šå¾Œã®æœ‰æ–™ç‰ˆã§å¼·åŒ–</div>
  `;
}

function renderYear(){
  const box = $("salesYear");
  const a = aggYear();
  box.innerHTML = `
    <div class="pill">å¹´åˆè¨ˆ ${yen(a.sum)} ï¼ ä¼šè¨ˆ ${a.cnt}ä»¶</div>
    <div style="height:8px"></div>
    <div class="pill">ç„¡æ–™ç‰ˆï¼šå¹´ã®å†…è¨³ï¼ˆã‚°ãƒ©ãƒ•ç­‰ï¼‰ã¯ä»Šå¾Œã®æœ‰æ–™ç‰ˆã§å¼·åŒ–</div>
  `;
}

/* ===== Detailï¼ˆä¿®æ­£ã¯PART5ã¸ï¼‰ ===== */
function openSaleDetail(s){
  const items = (s.items||[]).map(it=>`${it.name} Ã—${it.qty}`).join("<br>");
  openModal(
    "ä¼šè¨ˆè©³ç´°",
    `
      <div>å…¥åº—ï¼š${fmtHM(s.inTs)}</div>
      <div>é€€åº—ï¼š${fmtHM(s.outTs)}</div>
      <div>å¸­ï¼š${s.seatId}${s.name?`ï¼ˆ${s.name}ï¼‰`:""}</div>
      <div>æ”¯æ‰•ï¼š${s.pay}</div>
      <div style="margin-top:8px">${items}</div>
      <div style="margin-top:8px;font-weight:900">${yen(s.amount)}</div>
    `,
    [
      {label:"ä¿®æ­£", primary:true, onClick:()=>{ closeModal(); goFix(s.saleId); }},
      {label:"æˆ»ã‚‹", onClick:()=> closeModal()},
    ]
  );
}

/* ===== Tabs ===== */
function setTab(t){
  state.sales.tab = t;

  $("tabToday").classList.toggle("primary", t==="today");
  $("tabDaily").classList.toggle("primary", t==="daily");
  $("tabMonth").classList.toggle("primary", t==="month");
  $("tabYear").classList.toggle("primary", t==="year");

  renderSales();
}

$("tabToday").onclick=()=> setTab("today");
$("tabDaily").onclick=()=> setTab("daily");
$("tabMonth").onclick=()=> setTab("month");
$("tabYear").onclick =()=> setTab("year");

/* ===== showScreenæ‹¡å¼µ ===== */
(function hookShowScreenForSales(){
  if(showScreen._sHooked2) return;
  const _show = showScreen;
  showScreen = function(id){
    _show(id);
    if(id==="scrSales") renderSales();
  };
  showScreen._sHooked2 = true;
})();

/* åˆæœŸæç”» */
renderSales();

/* =========================
  ã“ã“ã‹ã‚‰å…ˆã¯ PART5 ã§ç¶šã
========================= */
/* =========================
  PART5ï¼šå£²ä¸Šç®¡ç†ãƒ»è¨‚æ­£ä¼ç¥¨ï¼ˆæœ¬æ—¥ï¼æ—¥åˆ¥ã®ä¿®æ­£ï¼‰
  å½¹å‰²ï¼šä¼šè¨ˆç¢ºå®šå¾Œã®ä¿®æ­£ï¼ˆå·®åˆ†ã‚¤ãƒ™ãƒ³ãƒˆã®ã¿ï¼‰
  æ–¹é‡ï¼šæ¶ˆã•ãªã„ï¼ä¸Šæ›¸ãã—ãªã„ï¼å±¥æ­´ã‚’æ®‹ã™ï¼ˆè¨‚æ­£ä¼ç¥¨æ–¹å¼ï¼‰
  ä¿®æ­£å¯¾è±¡ï¼ˆç¢ºå®šï¼‰ï¼š
    â‘  æ³¨æ–‡å•†å“æ•°ï¼ˆ0ä»¥ä¸‹ä¸å¯ï¼‰
    â‘¡ æ”¯æ‰•ã„æ–¹æ³•
  ä¿®æ­£æ™‚ å¿…é ˆï¼š
    ãƒ»ä¿®æ­£è€…åï¼ˆå¿…é ˆï¼‰
    ãƒ»ä¿®æ­£ç†ç”±ï¼ˆå¿…é ˆï¼‰
  è¡¨ç¤ºï¼š
    ãƒ»ä¿®æ­£å·®åˆ†ã¯ã€Œå¯¾è±¡è¡Œã®ç›´ä¸‹ã€ã«è¿½åŠ è¡¨ç¤ºï¼ˆå…ƒã¯æ®‹ã™ï¼‰
========================= */

/* ===== UIå·®ã—æ›¿ãˆï¼ˆãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ç½®æ›ï¼‰ ===== */
(function buildFixUI(){
  const scr = $("scrFix");
  scr.innerHTML = `
    <div class="pill" style="margin-bottom:10px">ä¿®æ­£ï¼ˆè¨‚æ­£ä¼ç¥¨æ–¹å¼ï¼‰</div>
    <div id="fixBody"></div>
  `;
})();

/* ===== PART5 State ===== */
state.fix = state.fix || {
  targetId: null,      // saleId
  draft: null,         // ç·¨é›†ä¸­ã®ãƒ‰ãƒ©ãƒ•ãƒˆ
  stage: "edit",       // "edit" | "confirm"
};

/* =========================================================
  Saleãƒ‡ãƒ¼ã‚¿æƒ³å®šï¼ˆæ—¢å­˜ã‚’å£Šã•ãªã„ãŸã‚ã®äº’æ›ï¼‰
  - state.sales.list ã®å„è¦ç´ ï¼ˆsaleï¼‰ã¯æœ€ä½é™:
    {
      saleId, ts,
      seatId, name, pay, amount,
      items:[{name, qty, price, tax}],
      inTs?, outTs?,
      corrections?: [
        {
          corrId, ts,
          who, why,
          payBefore, payAfter,
          itemsBefore:[{name, qty}], itemsAfter:[{name, qty}]
        }
      ]
    }
========================================================= */

function getSaleById(id){
  return (state.sales && Array.isArray(state.sales.list))
    ? state.sales.list.find(s => s.saleId === id)
    : null;
}

function safeNum(n){ n = Number(n); return Number.isFinite(n) ? n : 0; }

function calcAmountFromItems(items){
  // ç¨è¨ˆç®—ã¯ç„¡æ–™ç‰ˆã¯â€œç·é¡ã®æ•´åˆå„ªå…ˆâ€ã§ç°¡æ˜“ï¼ˆã“ã“ã¯å¾Œã§ç²¾å¯†åŒ–ã§ãã‚‹ï¼‰
  // ç¾çŠ¶ï¼šprice * qty ã®åˆè¨ˆ
  return (items||[]).reduce((sum, it)=> sum + safeNum(it.price) * safeNum(it.qty), 0);
}

function cloneItemsForEdit(items){
  return (items||[]).map(it=> ({
    name: it.name || "",
    qty: Math.max(0, safeNum(it.qty)),
    price: safeNum(it.price),
    tax: safeNum(it.tax),
  }));
}

function itemsToNameQty(items){
  return (items||[]).map(it=> ({ name: it.name || "", qty: Math.max(0, safeNum(it.qty)) }));
}

function fmtHM(ts){
  if(!ts) return "--:--";
  const d = new Date(ts);
  return `${pad2(d.getHours())}:${pad2(d.getMinutes())}`;
}

function payOptionsHtml(sel){
  const opts = ["ç¾é‡‘","ã‚«ãƒ¼ãƒ‰","QR"];
  return opts.map(p=> `<option ${p===sel?"selected":""}>${p}</option>`).join("");
}

function diffNameQty(before, after){
  // è¡¨ç¤ºç”¨ï¼šå·¦å³ã«åŒã˜é †ã§ä¸¦ã¹ãŸã„
  // â€œåå‰é›†åˆâ€ã§ã¾ã¨ã‚ã‚‹
  const map = new Map();
  (before||[]).forEach(it=>{
    const k = it.name || "";
    if(!map.has(k)) map.set(k, {name:k, b:0, a:0});
    map.get(k).b += safeNum(it.qty);
  });
  (after||[]).forEach(it=>{
    const k = it.name || "";
    if(!map.has(k)) map.set(k, {name:k, b:0, a:0});
    map.get(k).a += safeNum(it.qty);
  });
  return Array.from(map.values()).filter(x=> x.name).sort((x,y)=> x.name.localeCompare(y.name, "ja"));
}

/* =========================================================
  PART4ã‹ã‚‰ã®å…¥å£ï¼ˆä¿®æ­£ãƒœã‚¿ãƒ³ â†’ scrFixï¼‰
  æ—¢å­˜ openSaleDetail(s) ã‚’å£Šã•ãš â€œä¿®æ­£å¯¾è±¡ã‚’ä¿æŒâ€ã™ã‚‹
========================================================= */
(function hookFixEntry(){
  // PART4ã® openSaleDetail ãŒã‚ã‚‹å‰æã§ãƒ•ãƒƒã‚¯ï¼ˆç„¡ãã¦ã‚‚å‹•ãï¼‰
  if(typeof openSaleDetail !== "function") return;
  if(openSaleDetail._p5Hooked) return;

  const _open = openSaleDetail;
  openSaleDetail = function(sale){
    _open(sale);
    // ä¿®æ­£ãƒœã‚¿ãƒ³æŠ¼ä¸‹æ™‚ã«å¯¾è±¡ãŒå¿…è¦ãªã®ã§ä¿æŒ
    state.fix.targetId = sale && sale.saleId ? sale.saleId : null;
  };

  openSaleDetail._p5Hooked = true;
})();

/* =========================================================
  â€œä¿®æ­£â€ç”»é¢ã‚’é–‹ãå…±é€šé–¢æ•°ï¼ˆä»Šæ—¥/æ—¥åˆ¥ã®ä¸€è¦§ã‹ã‚‰å‘¼ã¹ã‚‹ï¼‰
========================================================= */
function openFixForSaleId(saleId){
  const s = getSaleById(saleId);
  if(!s){
    toast("ä¿®æ­£å¯¾è±¡ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");
    return;
  }

  // ãƒ‰ãƒ©ãƒ•ãƒˆä½œæˆï¼ˆç·¨é›†ã¯ items.qty ã¨ pay ã®ã¿ï¼‰
  const baseItems = cloneItemsForEdit(s.items || []);
  const basePay = s.pay || "ç¾é‡‘";

  state.fix.targetId = s.saleId;
  state.fix.stage = "edit";
  state.fix.draft = {
    who: "",
    why: "",
    pay: basePay,
    items: baseItems,          // qtyã‚’ã“ã“ã§å¢—æ¸›
    baseItems: cloneItemsForEdit(s.items || []),
    basePay: basePay,
  };

  showScreen("scrFix");
  renderFix();
}

/* =========================================================
  FIXï¼šç·¨é›†ç”»é¢ â†’ ç¢ºèªç”»é¢ â†’ ã‚¹ãƒ©ã‚¤ãƒ‰ç¢ºå®š
========================================================= */
function renderFix(){
  const box = $("fixBody");
  const s = getSaleById(state.fix.targetId);

  if(!s){
    box.innerHTML = `<div class="pill">ä¿®æ­£å¯¾è±¡ãŒã‚ã‚Šã¾ã›ã‚“</div>`;
    return;
  }

  // in/out ã¯ç„¡ã„å ´åˆã‚‚ã‚ã‚‹ï¼ˆæ—¢å­˜ãƒ‡ãƒ¼ã‚¿äº’æ›ï¼‰
  const inT  = fmtHM(s.inTs || null);
  const outT = fmtHM(s.outTs || null);

  const seatLabel = `${s.seatId || ""}${s.name ? `ï¼ˆ${s.name}ï¼‰` : ""}`;
  const baseAmount = safeNum(s.amount) || calcAmountFromItems(s.items||[]);

  // ãƒ‰ãƒ©ãƒ•ãƒˆãŒç„¡ã„å ´åˆã¯ç”Ÿæˆï¼ˆç›´æ¥scrFixã«æ¥ãŸã‚±ãƒ¼ã‚¹æ•‘æ¸ˆï¼‰
  if(!state.fix.draft){
    state.fix.draft = {
      who:"",
      why:"",
      pay: s.pay || "ç¾é‡‘",
      items: cloneItemsForEdit(s.items || []),
      baseItems: cloneItemsForEdit(s.items || []),
      basePay: s.pay || "ç¾é‡‘",
    };
    state.fix.stage = "edit";
  }

  const d = state.fix.draft;
  const newAmount = calcAmountFromItems(d.items);

  if(state.fix.stage === "edit"){
    const rows = d.items.map((it, idx)=>{
      const qty = Math.max(0, safeNum(it.qty));
      return `
        <div class="kRow" style="align-items:flex-start">
          <div class="kLeft" style="align-items:flex-start">
            <div class="kName">${it.name}</div>
          </div>
          <div class="kSlide" style="flex-direction:column; align-items:flex-end; gap:8px">
            <div class="pill" style="min-width:120px; justify-content:center; font-weight:900">
              ${yen(safeNum(it.price) * qty)}
            </div>
            <div style="display:flex; gap:8px; align-items:center">
              <button class="btn" data-minus="${idx}">âˆ’</button>
              <div class="pill" style="min-width:54px; justify-content:center; font-weight:900">${qty}</div>
              <button class="btn" data-plus="${idx}">ï¼‹</button>
            </div>
          </div>
        </div>
      `;
    }).join("");

    box.innerHTML = `
      <!-- ä¸Šæ®µï¼šç¾çŠ¶ -->
      <div class="pill" style="margin-bottom:8px">ç¾çŠ¶ï¼ˆä¿®æ­£å‰ï¼‰</div>
      <div class="pill" style="margin-bottom:10px; color:var(--muted)">
        å…¥åº— ${inT} / é€€åº— ${outT}<br>
        å¸­ ${seatLabel}<br>
        é‡‘é¡ ${yen(baseAmount)} / æ”¯æ‰• ${s.pay || "ç¾é‡‘"}
      </div>

      <!-- å…¥åŠ› -->
      <div style="display:flex; gap:10px; margin-bottom:10px">
        <button class="btn" id="fixBack" style="flex:1">æˆ»ã‚‹</button>
        <button class="btn primary" id="fixToConfirm" style="flex:1">æ±ºå®š</button>
      </div>

      <div class="pill" style="margin-bottom:6px">ä¿®æ­£è€…åï¼ˆå¿…é ˆï¼‰</div>
      <input id="fixWho" class="btn" style="width:100%; text-align:left; margin-bottom:10px" placeholder="åå‰" value="${(d.who||"").replace(/"/g,"&quot;")}" />

      <div class="pill" style="margin-bottom:6px">ä¿®æ­£ç†ç”±ï¼ˆå¿…é ˆï¼‰</div>
      <input id="fixWhy" class="btn" style="width:100%; text-align:left; margin-bottom:12px" placeholder="ç†ç”±" value="${(d.why||"").replace(/"/g,"&quot;")}" />

      <!-- æ“ä½œåˆ— -->
      <div class="pill" style="margin-bottom:6px">ä¿®æ­£å¾Œ</div>
      <div class="pill" style="margin-bottom:10px">
        ä¿®æ­£å¾Œé‡‘é¡ï¼š<span style="font-weight:900">${yen(newAmount)}</span>
      </div>

      <div class="pill" style="margin-bottom:6px">æ”¯æ‰•ã„æ–¹æ³•</div>
      <select id="fixPay" class="btn" style="width:100%; margin-bottom:12px">
        ${payOptionsHtml(d.pay)}
      </select>

      <!-- æ˜ç´° -->
      <div class="pill" style="margin-bottom:6px">å•†å“æ˜ç´°ï¼ˆæ•°é‡å¤‰æ›´ï¼‰</div>
      ${rows}
    `;

    // æˆ»ã‚‹
    $("fixBack").onclick = ()=> showScreen("scrSales"); // ç¾çŠ¶ã®æ§‹é€ ã«åˆã‚ã›ã¦ã€Œå£²ä¸Šã€ã¸æˆ»ã™ï¼ˆå¾Œã§ç®¡ç†ç”»é¢ãŒå‡ºæ¥ãŸã‚‰å·®ã—æ›¿ãˆOKï¼‰

    // æ±ºå®š â†’ ç¢ºèªã¸
    $("fixToConfirm").onclick = ()=>{
      d.who = ($("fixWho").value||"").trim();
      d.why = ($("fixWhy").value||"").trim();
      d.pay = ($("fixPay").value||"").trim() || d.pay;

      if(!d.who || !d.why){
        toast("ä¿®æ­£è€…åã¨ä¿®æ­£ç†ç”±ã¯å¿…é ˆã§ã™");
        return;
      }
      state.fix.stage = "confirm";
      renderFix();
    };

    // æ”¯æ‰•å¤‰æ›´
    $("fixPay").onchange = ()=> {
      d.pay = ($("fixPay").value||"").trim() || d.pay;
    };

    // æ•°é‡ Â±ï¼ˆ0ä»¥ä¸‹ä¸å¯ï¼‰
    box.querySelectorAll("[data-minus]").forEach(btn=>{
      btn.onclick = ()=>{
        const i = Number(btn.getAttribute("data-minus"));
        const it = d.items[i];
        if(!it) return;
        it.qty = Math.max(0, safeNum(it.qty) - 1);
        renderFix();
      };
    });
    box.querySelectorAll("[data-plus]").forEach(btn=>{
      btn.onclick = ()=>{
        const i = Number(btn.getAttribute("data-plus"));
        const it = d.items[i];
        if(!it) return;
        it.qty = Math.max(0, safeNum(it.qty) + 1);
        renderFix();
      };
    });

    return;
  }

  // ===== confirm =====
  const beforeItems = itemsToNameQty(d.baseItems);
  const afterItems  = itemsToNameQty(d.items);
  const diff = diffNameQty(beforeItems, afterItems);

  const diffRows = diff.map(x=>{
    return `
      <div class="kRow">
        <div class="kLeft">
          <div class="kName">${x.name}</div>
        </div>
        <div class="kSlide" style="justify-content:space-between; width:180px">
          <div style="font-weight:900">${x.b}</div>
          <div style="color:var(--muted)">â†’</div>
          <div style="font-weight:900">${x.a}</div>
        </div>
      </div>
    `;
  }).join("");

  box.innerHTML = `
    <div class="pill" style="margin-bottom:8px">ç¢ºèª</div>

    <div class="pill" style="margin-bottom:8px">ä¿®æ­£å‰</div>
    <div class="pill" style="margin-bottom:10px; color:var(--muted)">
      å…¥åº— ${inT} / é€€åº— ${outT}<br>
      å¸­ ${seatLabel}<br>
      é‡‘é¡ ${yen(baseAmount)} / æ”¯æ‰• ${d.basePay}
    </div>

    <div class="pill" style="margin-bottom:8px">ä¿®æ­£å¾Œ</div>
    <div class="pill" style="margin-bottom:10px; color:var(--muted)">
      å…¥åº— ${inT} / é€€åº— ${outT}<br>
      å¸­ ${seatLabel}<br>
      é‡‘é¡ ${yen(calcAmountFromItems(d.items))} / æ”¯æ‰• ${d.pay}
    </div>

    <div class="pill" style="margin-bottom:6px">æ•°é‡å¤‰æ›´ï¼ˆå·¦ï¼šå‰ / å³ï¼šå¾Œï¼‰</div>
    ${diffRows || `<div class="pill">å¤‰æ›´ãªã—</div>`}

    <div class="pill" style="margin-top:10px; margin-bottom:6px; color:var(--muted)">
      ä¿®æ­£è€…ï¼š${d.who} / ç†ç”±ï¼š${d.why}
    </div>

    <div style="display:flex; gap:10px; margin-top:10px">
      <button class="btn" id="fixBackToEdit" style="flex:1">æˆ»ã‚‹</button>
      <div style="flex:1">
        <div class="pill" style="margin-bottom:6px; text-align:center">å³ã¸ã‚¹ãƒ©ã‚¤ãƒ‰ã§ç¢ºå®š</div>
        <input id="fixSlideOk" class="kRange" type="range" min="0" max="100" value="0"/>
      </div>
    </div>
  `;

  $("fixBackToEdit").onclick = ()=>{
    state.fix.stage = "edit";
    renderFix();
  };

  $("fixSlideOk").onchange = ()=>{
    const v = Number($("fixSlideOk").value||0);
    if(v < 88){
      $("fixSlideOk").value = 0;
      return;
    }
    applyFixAsCorrection();
  };
}

function applyFixAsCorrection(){
  const s = getSaleById(state.fix.targetId);
  const d = state.fix.draft;
  if(!s || !d){
    toast("ä¿®æ­£ã«å¤±æ•—ã—ã¾ã—ãŸ");
    return;
  }

  // å·®åˆ†ï¼ˆè¨‚æ­£ä¼ç¥¨ï¼‰ã‚’è¿½åŠ ï¼šä¸Šæ›¸ãã—ãªã„
  s.corrections = s.corrections || [];
  s.corrections.push({
    corrId: "c_" + Math.random().toString(36).slice(2),
    ts: nowTs(),
    who: d.who,
    why: d.why,
    payBefore: d.basePay,
    payAfter: d.pay,
    itemsBefore: itemsToNameQty(d.baseItems),
    itemsAfter: itemsToNameQty(d.items),
  });

  // â€»å…ƒãƒ‡ãƒ¼ã‚¿ã¯æ®‹ã™æ–¹é‡ã ãŒã€ä¸€è¦§ã§â€œä¿®æ­£å¾Œã®è¦‹ãŸç›®â€ã‚‚å¿…è¦ãªã‚‰ã“ã“ã§æ›´æ–°ã§ãã‚‹ã€‚
  // ä»Šå›ã¯ã€Œè¨‚æ­£ä¼ç¥¨æ–¹å¼ã§å±¥æ­´ã‚’æ®‹ã™ã€ã‚’å„ªå…ˆã—ã€å…ƒã® s.items / s.pay / s.amount ã¯ç¶­æŒã€‚
  // ãŸã ã—â€œä¿®æ­£å¾Œé‡‘é¡â€ã‚’ä¸€è¦§ã«åæ˜ ã—ãŸã„å ´åˆã¯ã€ä¸‹ã®3è¡Œã‚’ONã«ã™ã‚‹ï¼ˆå¿…è¦ãªã‚‰è¨€ã£ã¦ï¼‰
  // s.items = cloneItemsForEdit(d.items);
  // s.pay = d.pay;
  // s.amount = calcAmountFromItems(d.items);

  // è¡¨ç¤ºæ›´æ–°ï¼ˆPART4ã®ãƒ¬ãƒ³ãƒ€ãƒ©ãŒã‚ã‚‹ãªã‚‰å†æç”»ï¼‰
  state.fix.stage = "edit";
  state.fix.draft = null;

  toast("è¨‚æ­£ä¼ç¥¨ã‚’è¿½åŠ ã—ã¾ã—ãŸ");

  // å£²ä¸Šä¸€è¦§ã¸æˆ»ã™ï¼ˆç¾çŠ¶ã¯scrSalesï¼‰
  showScreen("scrSales");

  // å†æç”»ãƒ•ãƒƒã‚¯ï¼ˆå­˜åœ¨ã™ã‚‹ã‚‚ã®ã ã‘ï¼‰
  try{ if(typeof renderSales === "function") renderSales(); }catch(e){}
}

/* =========================================================
  â€œå¯¾è±¡è¡Œã®ç›´ä¸‹ã«å·®åˆ†ã‚’è¡¨ç¤ºâ€ã™ã‚‹ãŸã‚ã®å¾Œä»˜ã‘ãƒ‘ãƒƒãƒ
  - PART4ã®æœ¬æ—¥ä¸€è¦§ï¼ˆrenderTodayï¼‰ã‚’å£Šã•ãšã€å·®åˆ†è¡¨ç¤ºã‚’è¿½åŠ 
========================================================= */
(function patchRenderTodayList(){
  if(patchRenderTodayList._done) return;
  patchRenderTodayList._done = true;

  // PART4ã® renderToday ãŒå­˜åœ¨ã—ãªã„ãªã‚‰ä½•ã‚‚ã—ãªã„
  if(typeof renderToday !== "function") return;

  const _renderToday = renderToday;
  renderToday = function(){
    _renderToday();

    // todayList ãŒç„¡ã„ãªã‚‰ä½•ã‚‚ã—ãªã„
    const list = document.querySelector("#salesToday #todayList");
    if(!list) return;

    // æ—¢å­˜ã®å„è¡Œï¼ˆkRowï¼‰ã«ã€Œä¿®æ­£ã€ãƒœã‚¿ãƒ³ã‚’è¿½åŠ ã—ã€ç›´ä¸‹ã«å·®åˆ†ã‚’å·®ã—è¾¼ã‚€
    // â€»æ—¢å­˜ã® row.onclick ã¯ç¶­æŒã—ã¤ã¤ã€ãƒœã‚¿ãƒ³ã ã‘æ­¢ã‚ã‚‹
    const rows = Array.from(list.children || []);
    rows.forEach(row=>{
      const seatEl = row.querySelector(".kSeat");
      if(!seatEl) return;

      // kRowå†…ã‹ã‚‰ saleId ã‚’å–ã‚Œãªã„ã®ã§ã€ã‚¯ãƒªãƒƒã‚¯ã§é–‹ãè©³ç´°æ™‚ã® state.fix.targetId ã‚’åˆ©ç”¨ã™ã‚‹
      // â†’ å®‰å®šã•ã›ã‚‹ãŸã‚ã€è¡Œã‚¯ãƒªãƒƒã‚¯æ™‚ã« openSaleDetail(s) ãŒå‘¼ã°ã‚Œã¦ state.fix.targetId ãŒå…¥ã‚‹å‰æ
      // ãŸã ã€ç¢ºå®Ÿã«ã—ãŸã„ã®ã§ â€œè¡Œã‚’ã‚¯ãƒªãƒƒã‚¯â†’ãƒ¢ãƒ¼ãƒ€ãƒ«â†’ä¿®æ­£â€ ã‚’æ¨å¥¨ã€‚
      // ã“ã“ã§ã¯ã€Œå·®åˆ†è¡¨ç¤ºã ã‘ã€ç‹™ã†ã€‚

      // å·®åˆ†ã®è¡¨ç¤ºã¯ â€œå¸­ã¨æ™‚é–“ã¨é‡‘é¡â€ ã ã‘ã§ã¯saleç‰¹å®šã§ããªã„ã®ã§ã€
      // ä»Šå›ã¯ã€Œsale.corrections ã‚’æŒã¤è¡Œã«ã ã‘è¿½åŠ è¡¨ç¤ºã€ã—ãŸã„ãŒã€è¡Œã¨saleã®ç´ä»˜ã‘ãŒå¿…è¦ã€‚
      // â†’ ç¢ºå®ŸåŒ–ã¯æ¬¡ã®æ®µéšï¼ˆPART4æ”¹ä¿®ï¼‰ã§ã‚„ã‚‹ã€‚
    });
  };
})();

/* =========================================================
  ã©ã“ã‹ã‚‰ã§ã‚‚å‘¼ã¹ã‚‹ã‚ˆã†ã« window ã«å…¬é–‹ï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰
========================================================= */
window.ONE_openFixForSaleId = openFixForSaleId;

/* ===== showScreenæ‹¡å¼µï¼šscrFixã«å…¥ã£ãŸã‚‰æç”» ===== */
(function hookShowScreenForFix(){
  if(showScreen._fHooked2) return;
  const _show = showScreen;
  showScreen = function(id){
    _show(id);
    if(id==="scrFix") renderFix();
  };
  showScreen._fHooked2 = true;
})();

/* åˆæœŸæç”»ï¼ˆå®‰å…¨ï¼‰ */
try{ renderFix(); }catch(e){}

/* =========================
  ã“ã“ã‹ã‚‰å…ˆã¯ PART6 ã§ç¶šã
========================= */
/* =========================
  PART6ï¼šå¸­ç™»éŒ²ï¼ˆæœ€æ–°ä»•æ§˜ï¼šâ‘¡ã‚’è§¦ã£ãŸã‚‰å³ç¢ºå®šï¼‰ã€Bãƒ‡ã‚¶ã‚¤ãƒ³UIèª¿æ•´ç‰ˆã€‘
  - ãƒ­ã‚¸ãƒƒã‚¯ã¯ãã®ã¾ã¾
  - UIå¤‰æ›´ç‚¹ï¼š
    1) ã‚¿ã‚¤ãƒˆãƒ«ã‚’ ğŸ”µ ä»˜ãï¼ˆ.titleRowï¼‰
    2) â‘¡ ç·å¸­æ•°/ç·å“æ•° ã‚’ stepperï¼ˆAâ†’Bè¦‹ãŸç›®ï¼‰ã¸
    3) ã‚¹ãƒ©ã‚¤ãƒ‰ã‚’ rangeShortï¼ˆçŸ­ã‚ï¼‰ï¼‹ãƒãƒ¼æ¿ƒãƒ”ãƒ³ã‚¯ï¼‹ä¸¸ãƒœã‚¿ãƒ³æ¿ƒç·‘ï¼ˆæ–‡å­—ãªã—ï¼‰
========================= */

(function ensureSeatSetupSubScreens(){
  const app = document.querySelector("main.app");
  if(!app) return;

  function ensureScreen(id){
    if(document.getElementById(id)) return;
    const sec = document.createElement("section");
    sec.className = "screen";
    sec.id = id;
    sec.innerHTML = `<div style="opacity:.8">ï¼ˆPART6ã§å®Ÿè£…ï¼‰</div>`;
    app.appendChild(sec);
    try{ screens.push(id); }catch(e){}
  }

  ensureScreen("scrNameCreate");
  ensureScreen("scrNameDelete");
})();

(function buildSeatSetupUI(){
  const scr = $("scrSeatSetup");
  scr.innerHTML = `
    <!-- ğŸ”µã‚¿ã‚¤ãƒˆãƒ« -->
    <div class="titleRow"><span class="dot"></span><span>å¸­ç™»éŒ²</span></div>

    <!-- è¿½åŠ ãƒœã‚¿ãƒ³ï¼ˆã‚¿ã‚¤ãƒˆãƒ«ã®ä¸‹ï¼‰ -->
    <div style="display:flex; gap:12px; margin-bottom:14px">
      <button class="btn lime" id="goNameCreate" style="flex:1; font-weight:1000">åç§°ã®ä½œæˆ</button>
      <button class="btn" id="goNameDelete" style="flex:1; font-weight:1000">åç§°ã¨å¸­ã®å‰Šé™¤</button>
    </div>

    <!-- â‘  åç§° -->
    <div class="hintText" style="font-weight:1000; margin-bottom:8px">
      <span style="color:var(--blueDot)">ğŸ”µ</span> â‘  åç§°ï¼ˆã‚¿ãƒƒãƒ—ã§é¸æŠ / è§£é™¤ï¼‰
    </div>
    <div id="ssNameGrid" class="seatGrid" style="margin-bottom:14px"></div>

    <!-- â‘¡ ç·å¸­æ•°ï¼ç·å“æ•°ï¼ˆstepperï¼‰ -->
    <div class="hintText" style="font-weight:1000; margin-bottom:8px">
      <span style="color:var(--blueDot)">ğŸ”µ</span> â‘¡ ç·å¸­æ•° / ç·å“æ•°
    </div>

    <div class="stepper" style="margin-bottom:14px">
      <button class="stepBtn" id="ssCntMinus" aria-label="æ¸›ã‚‰ã™">â—€ï¸</button>
      <div class="stepVal" id="ssCntVal">0</div>
      <button class="stepBtn" id="ssCntPlus" aria-label="å¢—ã‚„ã™">â–¶ï¸</button>
    </div>

    <!-- â‘¢ å¸­ç•ªå· -->
    <div class="hintText" style="font-weight:1000; margin-bottom:8px">
      <span style="color:var(--blueDot)">ğŸ”µ</span> â‘¢ å¸­ç•ªå·ï¼ˆè‡ªå‹•ã§æ¬¡ãŒå…¥ã‚Šã¾ã™ï¼‰
    </div>
    <input class="btn full" id="ssStartLabel" placeholder="é–‹å§‹æ–‡å­—ï¼ˆä¾‹ï¼šA / 1 / ã‚ / ã‚¢ / A1ï¼‰" style="text-align:left; margin-bottom:6px" />
    <div class="descSmall">å…¥åŠ›ãŒ1æ–‡å­—ã®ã¿ã®å ´åˆã¯è‡ªå‹•ã§é€£ç•ªã«ãªã‚Šã¾ã™</div>

    <!-- ä½œæˆäºˆå®šã®å¸­ -->
    <div class="hintText" style="font-weight:1000; margin-bottom:8px">
      <span style="color:var(--blueDot)">ğŸ”µ</span> ä½œæˆäºˆå®šã®å¸­ï¼ˆã‚¿ãƒƒãƒ—ã§ç·¨é›†ï¼‰
    </div>
    <div id="ssPreviewGrid" class="seatGrid" style="margin-bottom:14px"></div>

    <!-- ä¿å­˜ -->
    <button class="btn lime full" id="ssSave" style="padding:16px 12px; font-weight:1000; margin-bottom:14px">ä¿å­˜</button>

    <!-- ä½œã£ãŸå¸­ -->
    <div class="hintText" style="font-weight:1000; margin-bottom:8px">
      <span style="color:var(--blueDot)">ğŸ”µ</span> ä½œã£ãŸå¸­
    </div>
    <div id="ssGroups"></div>
  `;
})();

/* ===== State ===== */
state.seatSetup = state.seatSetup || {
  baseNames: ["ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼","ãƒ†ãƒ¼ãƒ–ãƒ«","åº§æ•·","å€‹å®¤","ç«‹ã¡"],
  customNames: [],
  selectedName: null,      // ã„ã¾é¸æŠä¸­ï¼ˆã‚¿ãƒƒãƒ—çŠ¶æ…‹ï¼‰
  committedName: null,     // ç¢ºå®šæ‰±ã„ï¼ˆã“ã®ä»•æ§˜ã§ã¯ selectedName ã¨åŒç¾©ã§OKï¼‰
  count: 0,
  preview: [],             // ä½œæˆäºˆå®šã®å¸­ï¼ˆæ–‡å­—åˆ—é…åˆ—ï¼‰
  editMap: {},             // {index: "ç·¨é›†å¾Œã®å¸­ç•ªå·"}
  groups: []               // {name, seatIds:[]}
};

function allNameButtons(){
  return state.seatSetup.baseNames.concat(state.seatSetup.customNames);
}

/* ===== â‘  åç§° ===== */
function renderNameGrid(){
  const grid = $("ssNameGrid");
  grid.innerHTML = "";

  allNameButtons().forEach(n=>{
    const b = document.createElement("div");
    b.className = "seatCard in";
    b.style.minHeight="56px";
    b.style.height="auto";
    b.style.display="flex";
    b.style.alignItems="center";
    b.style.justifyContent="center";
    b.style.fontWeight="1000";
    b.textContent = n;

    const on = (state.seatSetup.selectedName===n);
    if(on){
      b.style.outline = "3px solid rgba(11,99,217,0.45)";
      b.style.background = "rgba(11,99,217,0.10)";
    }

    b.onclick = ()=>{
      // ã‚¿ãƒƒãƒ—ã§é¸æŠ/è§£é™¤
      state.seatSetup.selectedName = (state.seatSetup.selectedName===n) ? null : n;
      state.seatSetup.committedName = state.seatSetup.selectedName;

      // åç§°ã«å¿œã˜ã¦ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå¸­æ•°ã‚‚å³é©ç”¨ï¼ˆè§£é™¤ãªã‚‰è§¦ã‚‰ãªã„ï¼‰
      if(state.seatSetup.committedName){
        applyDefaultCountByName(state.seatSetup.committedName);
      }

      renderNameGrid();
      renderSeatPreview();
    };

    grid.appendChild(b);
  });
}

function applyDefaultCountByName(name){
  if(name==="ãƒ†ãƒ¼ãƒ–ãƒ«" || name==="åº§æ•·" || name==="å€‹å®¤"){
    state.seatSetup.count = Math.max(1, Number(state.seatSetup.count||0) || 4);
  }else{
    state.seatSetup.count = Math.max(1, Number(state.seatSetup.count||0) || 1);
  }
  $("ssCntVal").textContent = String(state.seatSetup.count);
}

/* ===== â‘¡ ç·å¸­æ•°ï¼ˆstepperï¼‰ ===== */
function clampCount(n){
  n = Number(n||0);
  if(!Number.isFinite(n)) n = 0;
  return Math.max(0, Math.min(200, n));
}

$("ssCntMinus").onclick = ()=>{
  state.seatSetup.count = clampCount(state.seatSetup.count - 1);
  $("ssCntVal").textContent = String(state.seatSetup.count);
  renderSeatPreview();
};
$("ssCntPlus").onclick = ()=>{
  state.seatSetup.count = clampCount(state.seatSetup.count + 1);
  $("ssCntVal").textContent = String(state.seatSetup.count);
  renderSeatPreview();
};

/* ===== â‘¢ é–‹å§‹æ–‡å­—ï¼ˆå…¥åŠ›ã—ãŸç¬é–“ã«ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ›´æ–°ï¼‰ ===== */
(function hookStartLabelInput(){
  const el = $("ssStartLabel");
  if(!el || el._hooked) return;
  el._hooked = true;

  el.addEventListener("input", ()=>{
    renderSeatPreview();
  });
})();

/* ===== é€£ç•ªï¼ˆå¼·åŒ–ç‰ˆï¼‰ ===== */
function isSingleChar(str){ return (str||"").length===1; }

function nextLabelOneChar(ch){
  if(ch>="0" && ch<="9"){ const n=Number(ch); if(Number.isFinite(n)) return String(n+1); }
  if(ch>="a" && ch<="z"){ return ch==="z" ? "a" : String.fromCharCode(ch.charCodeAt(0)+1); }
  if(ch>="A" && ch<="Z"){ return ch==="Z" ? "A" : String.fromCharCode(ch.charCodeAt(0)+1); }

  const hira = "ã‚ã„ã†ãˆãŠã‹ããã‘ã“ã•ã—ã™ã›ããŸã¡ã¤ã¦ã¨ãªã«ã¬ã­ã®ã¯ã²ãµã¸ã»ã¾ã¿ã‚€ã‚ã‚‚ã‚„ã‚†ã‚ˆã‚‰ã‚Šã‚‹ã‚Œã‚ã‚ã‚’ã‚“";
  const kata = "ã‚¢ã‚¤ã‚¦ã‚¨ã‚ªã‚«ã‚­ã‚¯ã‚±ã‚³ã‚µã‚·ã‚¹ã‚»ã‚½ã‚¿ãƒãƒ„ãƒ†ãƒˆãƒŠãƒ‹ãƒŒãƒãƒãƒãƒ’ãƒ•ãƒ˜ãƒ›ãƒãƒŸãƒ ãƒ¡ãƒ¢ãƒ¤ãƒ¦ãƒ¨ãƒ©ãƒªãƒ«ãƒ¬ãƒ­ãƒ¯ãƒ²ãƒ³";
  const hi = hira.indexOf(ch);
  if(hi!==-1) return hira[(hi+1)%hira.length];
  const ka = kata.indexOf(ch);
  if(ka!==-1) return kata[(ka+1)%kata.length];
  return null;
}

function incTrailingNumber(str){
  const m = String(str||"").match(/^(.*?)(\d+)$/);
  if(!m) return null;
  const pre = m[1];
  const num = m[2];
  const width = num.length;
  const n = Number(num);
  if(!Number.isFinite(n)) return null;
  const nn = String(n+1).padStart(width, "0");
  return pre + nn;
}

function buildSeatIdsSmart(start, count){
  const ids = [];
  const s = (start||"").trim();
  const c = Math.max(0, Number(count||0));
  if(!s || c<=0) return ids;

  if(isSingleChar(s)){
    let cur = s;
    for(let i=0;i<c;i++){
      ids.push(cur);
      const nx = nextLabelOneChar(cur);
      if(!nx && i < c-1){ break; }
      cur = nx || cur;
    }
    return ids;
  }

  const inc = incTrailingNumber(s);
  if(inc){
    let cur = s;
    for(let i=0;i<c;i++){
      ids.push(cur);
      const nx = incTrailingNumber(cur);
      if(!nx && i < c-1) break;
      cur = nx || cur;
    }
    return ids;
  }

  for(let i=0;i<c;i++) ids.push(s);
  return ids;
}

/* ===== ä½œæˆäºˆå®šå¸­ï¼ˆãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼‰ ===== */
function renderSeatPreview(){
  const grid = $("ssPreviewGrid");
  if(!grid) return;

  const cnt = clampCount(state.seatSetup.count);
  const start = ($("ssStartLabel").value||"").trim();

  const base = buildSeatIdsSmart(start, cnt);

  const preview = base.map((v, idx)=>{
    const over = state.seatSetup.editMap?.[idx];
    const ov = (over==null) ? "" : String(over).trim();
    return ov ? ov : v;
  });

  state.seatSetup.preview = preview;

  grid.innerHTML = "";

  if(cnt<=0){
    grid.innerHTML = `<div class="descSmall">â‘¡ã§å¸­æ•°ã‚’æ±ºã‚ã‚‹ã¨ã€ã“ã“ã«å¸­ãŒå‡ºã¾ã™</div>`;
    return;
  }
  if(!start){
    grid.innerHTML = `<div class="descSmall">â‘¢ã«é–‹å§‹æ–‡å­—ã‚’å…¥ã‚Œã‚‹ã¨ã€ã“ã“ã«å¸­ãŒå‡ºã¾ã™</div>`;
    return;
  }
  if(preview.length===0){
    grid.innerHTML = `<div class="descSmall">ä½œæˆäºˆå®šã®å¸­ã‚’ç”Ÿæˆã§ãã¾ã›ã‚“</div>`;
    return;
  }

  preview.forEach((label, idx)=>{
    const c = document.createElement("div");
    c.className = "seatCard in";
    c.style.minHeight="56px";
    c.style.height="auto";
    c.style.display="flex";
    c.style.alignItems="center";
    c.style.justifyContent="center";
    c.style.fontWeight="1000";
    c.textContent = label || "â€”";

    c.onclick = ()=>{
      openModal(
        "å¸­ç•ªå·ã‚’ç·¨é›†",
        `
          <div class="descSmall" style="margin-bottom:10px">å¸­ç•ªå·ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</div>
          <input id="ssEditSeat" class="btn full" style="text-align:left" value="${label||""}" autocomplete="off" />
        `,
        [
          {label:"æˆ»ã‚‹", lime:false, onClick:()=> closeModal()},
          {label:"ä¿å­˜", lime:true, onClick:()=>{
            const v = ($("ssEditSeat").value||"").trim();
            state.seatSetup.editMap[idx] = v;
            closeModal();
            renderSeatPreview();
          }},
        ]
      );
    };

    grid.appendChild(c);
  });
}

/* ===== å¸­ç”Ÿæˆ/ä¿å­˜ ===== */
function ensureSeatExists(id){
  if(state.seats.some(s=> s.id===id)) return;
  state.seats.push({
    id,
    status:"empty",
    people:0,
    name:"",
    total:0,
    bills:0,
    merged:false,
    mergeLabel:"",
    sub:null,
    orders:[],
    orderLog:[]
  });
}

$("ssSave").onclick = ()=>{
  const name = state.seatSetup.committedName;
  const cnt = clampCount(state.seatSetup.count);
  const start = ($("ssStartLabel").value||"").trim();

  if(!name){ toast("åç§°ã‚’é¸æŠã—ã¦ãã ã•ã„"); return; }
  if(cnt<=0){ toast("ç·å¸­/ç·å“æ•°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"); return; }
  if(!start){ toast("é–‹å§‹æ–‡å­—ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"); return; }

  if(!Array.isArray(state.seatSetup.preview) || state.seatSetup.preview.length!==cnt){
    renderSeatPreview();
  }
  const planned = (state.seatSetup.preview||[]).map(x=> String(x||"").trim());

  if(planned.some(x=> !x)){
    toast("ç©ºã®å¸­ç•ªå·ãŒã‚ã‚Šã¾ã™ï¼ˆã‚¿ãƒƒãƒ—ã—ã¦ç·¨é›†ã—ã¦ãã ã•ã„ï¼‰");
    return;
  }

  const set = new Set();
  for(const x of planned){
    if(set.has(x)){
      toast("å¸­ç•ªå·ãŒé‡è¤‡ã—ã¦ã„ã¾ã™ï¼ˆç·¨é›†ã—ã¦ãã ã•ã„ï¼‰");
      return;
    }
    set.add(x);
  }

  const unique = [];
  planned.forEach(id=>{
    if(state.seats.some(s=> s.id===id)) return;
    unique.push(id);
    ensureSeatExists(id);
  });

  if(unique.length===0){
    toast("ä½œæˆã§ãã‚‹å¸­ãŒã‚ã‚Šã¾ã›ã‚“ï¼ˆæ—¢ã«å­˜åœ¨ï¼‰");
    return;
  }

  state.seatSetup.groups.push({ name, seatIds: unique });

  renderSeats();
  renderGroups();

  $("ssStartLabel").value = "";
  state.seatSetup.editMap = {};
  state.seatSetup.preview = [];

  renderSeatPreview();

  if(typeof emitEvent==="function") emitEvent("seat_setup_save", {name, seatIds: unique});
  toast("ä¿å­˜ã—ã¾ã—ãŸ");
};

/* ===== ä½œã£ãŸå¸­ï¼ˆåç§°ã”ã¨ï¼‰ ===== */
function renderGroups(){
  const box = $("ssGroups");
  box.innerHTML = "";
  if(state.seatSetup.groups.length===0){
    box.innerHTML = `<div class="descSmall">ã¾ã ä½œæˆã•ã‚Œã¦ã„ã¾ã›ã‚“</div>`;
    return;
  }

  const byName = {};
  state.seatSetup.groups.forEach(g=>{
    if(!byName[g.name]) byName[g.name]=[];
    byName[g.name].push(g);
  });

  Object.keys(byName).forEach(name=>{
    const wrap = document.createElement("div");
    wrap.style.marginBottom="14px";

    const head = document.createElement("button");
    head.className="btn full";
    head.style.textAlign="left";
    head.style.fontWeight="1000";
    head.textContent=name;
    head.onclick = ()=> toast("åç§°ã®å¤‰æ›´ã¯ã€Œåç§°ã¨å¸­ã®å‰Šé™¤ã€ã‹ã‚‰è¡Œã„ã¾ã™");
    wrap.appendChild(head);

    const grid = document.createElement("div");
    grid.className="seatGrid";
    grid.style.marginTop="10px";

    const ids = byName[name].flatMap(g=> g.seatIds);
    ids.forEach(id=>{
      const c=document.createElement("div");
      c.className="seatCard in";
      c.style.minHeight="56px";
      c.style.height="auto";
      c.style.display="flex";
      c.style.alignItems="center";
      c.style.justifyContent="center";
      c.style.fontWeight="1000";
      c.textContent=id;
      grid.appendChild(c);
    });

    wrap.appendChild(grid);
    box.appendChild(wrap);
  });
}

/* =========================
  åç§°ã®ä½œæˆç”»é¢ï¼ˆscrNameCreateï¼‰
========================= */
function buildNameCreateUI(){
  const scr = $("scrNameCreate");
  scr.innerHTML = `
    <div class="titleRow"><span class="dot"></span><span>åç§°ã®ä½œæˆ</span></div>

    <div class="descSmall">åç§°ã‚’å…¥åŠ›ã—ã¦ä½œæˆã—ã¾ã™</div>
    <input id="ncInput" class="btn full" style="text-align:left; margin-bottom:12px" placeholder="åç§°" />

    <div style="display:flex; gap:12px">
      <button class="btn full" id="ncBack">æˆ»ã‚‹</button>
      <button class="btn lime full" id="ncCreate">ä½œæˆ</button>
    </div>
  `;

  $("ncBack").onclick = ()=> showScreen("scrSeatSetup");
  $("ncCreate").onclick = ()=>{
    const v = ($("ncInput").value||"").trim();
    if(!v){ toast("åç§°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"); return; }
    if(allNameButtons().includes(v)){ toast("åŒã˜åç§°ãŒã‚ã‚Šã¾ã™"); return; }

    state.seatSetup.customNames.push(v);

    state.seatSetup.selectedName = v;
    state.seatSetup.committedName = v;

    if(typeof persistAll==="function") persistAll();
    toast("åç§°ã‚’ä½œæˆã—ã¾ã—ãŸ");
    showScreen("scrSeatSetup");
    renderNameGrid();
    applyDefaultCountByName(v);
    renderSeatPreview();
  };
}

/* =========================
  åç§°ã¨å¸­ã®å‰Šé™¤ç”»é¢ï¼ˆscrNameDeleteï¼‰
  - ã‚¹ãƒ©ã‚¤ãƒ‰ï¼šrangeShortï¼ˆçŸ­ã‚ï¼‰ï¼‹æ–‡å­—ãªã—
========================= */
function buildNameDeleteUI(){
  const scr = $("scrNameDelete");
  scr.innerHTML = `
    <div class="titleRow"><span class="dot"></span><span>åç§°ã¾ãŸã¯å¸­ã‚’å‰Šé™¤ã—ã¾ã™</span></div>

    <div class="hintText" style="font-weight:1000; margin-bottom:8px">
      <span style="color:var(--blueDot)">ğŸ”µ</span> åç§°ä¸€è¦§ï¼ˆã‚¿ãƒƒãƒ—ã§é¸æŠï¼‰
    </div>
    <div id="ndNameGrid" class="seatGrid" style="margin-bottom:10px"></div>

    <div class="hintText" style="font-weight:1000; margin-bottom:8px">
      <span style="color:var(--blueDot)">ğŸ”µ</span> é¸æŠã—ãŸåç§°ã”ã¨å¸­ã‚’å‰Šé™¤
    </div>
    <div class="descSmall" style="margin-bottom:10px">
      åç§°å†…ã®å…¨å¸­ãŒç©ºå¸­ã®å ´åˆã®ã¿å‰Šé™¤ã§ãã¾ã™
    </div>
    <input id="ndDelNameSlide" class="range rangeShort" type="range" min="0" max="100" value="0" />

    <div style="height:18px"></div>

    <div class="hintText" style="font-weight:1000; margin-bottom:8px">
      <span style="color:var(--blueDot)">ğŸ”µ</span> å¸­ä¸€è¦§ï¼ˆè¤‡æ•°é¸æŠï¼‰
    </div>
    <div id="ndSeatGrid" class="seatGrid" style="margin-bottom:10px"></div>

    <input id="ndDelSeatSlide" class="range rangeShort" type="range" min="0" max="100" value="0" />

    <div style="height:14px"></div>
    <button class="btn full" id="ndBack">æˆ»ã‚‹</button>
  `;

  let pickedName = null;
  let pickedSeats = new Set();

  function namesWithSeats(){
    const map = new Map();
    (state.seatSetup.groups||[]).forEach(g=>{
      if(!map.has(g.name)) map.set(g.name, []);
      g.seatIds.forEach(id=> map.get(g.name).push(id));
    });
    allNameButtons().forEach(n=>{
      if(!map.has(n)) map.set(n, []);
    });
    return map;
  }

  function seatIsEmpty(id){
    const s = seatById(id);
    return !s || s.status==="empty";
  }

  function renderNameGrid(){
    const grid = $("ndNameGrid");
    grid.innerHTML = "";
    const map = namesWithSeats();

    Array.from(map.keys()).forEach(n=>{
      const b = document.createElement("div");
      b.className = "seatCard in";
      b.style.minHeight="56px";
      b.style.height="auto";
      b.style.display="flex";
      b.style.alignItems="center";
      b.style.justifyContent="center";
      b.style.fontWeight="1000";
      b.textContent = n;

      const on = (pickedName===n);
      if(on){
        b.style.outline = "3px solid rgba(11,99,217,0.45)";
        b.style.background = "rgba(11,99,217,0.10)";
      }
      b.onclick = ()=>{
        pickedName = (pickedName===n) ? null : n;
        pickedSeats = new Set();
        renderNameGrid();
        renderSeatGrid();
      };
      grid.appendChild(b);
    });
  }

  function renderSeatGrid(){
    const grid = $("ndSeatGrid");
    grid.innerHTML = "";
    if(!pickedName){
      grid.innerHTML = `<div class="descSmall">åç§°ã‚’é¸æŠã—ã¦ãã ã•ã„</div>`;
      return;
    }

    const ids = (state.seatSetup.groups||[])
      .filter(g=> g.name===pickedName)
      .flatMap(g=> g.seatIds);

    if(ids.length===0){
      grid.innerHTML = `<div class="descSmall">ã“ã®åç§°ã«ã¯å¸­ãŒã‚ã‚Šã¾ã›ã‚“</div>`;
      return;
    }

    ids.forEach(id=>{
      const c = document.createElement("div");
      c.className = "seatCard in";
      c.style.minHeight="56px";
      c.style.height="auto";
      c.style.display="flex";
      c.style.alignItems="center";
      c.style.justifyContent="center";
      c.style.fontWeight="1000";
      c.textContent = id;

      const on = pickedSeats.has(id);
      if(on){
        c.style.outline = "3px solid rgba(11,99,217,0.45)";
        c.style.background = "rgba(11,99,217,0.10)";
      }

      if(!seatIsEmpty(id)){
        c.style.opacity = "0.75";
        c.style.borderColor = "rgba(255,107,107,0.55)";
      }

      c.onclick = ()=>{
        if(!seatIsEmpty(id)){
          toast("ä½¿ç”¨ä¸­ã®å¸­ã¯å‰Šé™¤ã§ãã¾ã›ã‚“");
          return;
        }
        if(pickedSeats.has(id)) pickedSeats.delete(id);
        else pickedSeats.add(id);
        renderSeatGrid();
      };

      grid.appendChild(c);
    });
  }

  function deleteNameAllSeats(){
    if(!pickedName){ toast("åç§°ã‚’é¸æŠã—ã¦ãã ã•ã„"); return false; }

    const ids = (state.seatSetup.groups||[])
      .filter(g=> g.name===pickedName)
      .flatMap(g=> g.seatIds);

    const blocked = ids.some(id=> !seatIsEmpty(id));
    if(blocked){
      toast("ä½¿ç”¨ä¸­ã®å¸­ãŒã‚ã‚‹ãŸã‚å‰Šé™¤ã§ãã¾ã›ã‚“");
      return false;
    }

    ids.forEach(id=>{
      state.seats = state.seats.filter(s=> s.id!==id);
    });

    state.seatSetup.groups = (state.seatSetup.groups||[]).filter(g=> g.name!==pickedName);
    state.seatSetup.customNames = (state.seatSetup.customNames||[]).filter(x=> x!==pickedName);

    pickedName = null;
    pickedSeats = new Set();

    renderSeats();
    renderGroups();
    renderNameGrid();
    renderSeatGrid();
    if(typeof persistAll==="function") persistAll();
    toast("åç§°ã”ã¨å‰Šé™¤ã—ã¾ã—ãŸ");
    return true;
  }

  function deletePickedSeats(){
    if(!pickedName){ toast("åç§°ã‚’é¸æŠã—ã¦ãã ã•ã„"); return false; }
    const ids = Array.from(pickedSeats);
    if(ids.length===0){ toast("å¸­ã‚’é¸æŠã—ã¦ãã ã•ã„"); return false; }

    const blocked = ids.some(id=> !seatIsEmpty(id));
    if(blocked){
      toast("ä½¿ç”¨ä¸­ã®å¸­ãŒã‚ã‚‹ãŸã‚å‰Šé™¤ã§ãã¾ã›ã‚“");
      return false;
    }

    ids.forEach(id=>{
      state.seats = state.seats.filter(s=> s.id!==id);
    });

    state.seatSetup.groups.forEach(g=>{
      if(g.name===pickedName){
        g.seatIds = g.seatIds.filter(id=> !pickedSeats.has(id));
      }
    });
    state.seatSetup.groups = state.seatSetup.groups.filter(g=> g.seatIds.length>0);

    pickedSeats = new Set();

    renderSeats();
    renderGroups();
    renderSeatGrid();
    if(typeof persistAll==="function") persistAll();
    toast("å¸­ã‚’å‰Šé™¤ã—ã¾ã—ãŸ");
    return true;
  }

  $("ndDelNameSlide").onchange = ()=>{
    if(Number($("ndDelNameSlide").value||0) < 88){ $("ndDelNameSlide").value=0; return; }
    deleteNameAllSeats();
    $("ndDelNameSlide").value = 0;
  };

  $("ndDelSeatSlide").onchange = ()=>{
    if(Number($("ndDelSeatSlide").value||0) < 88){ $("ndDelSeatSlide").value=0; return; }
    deletePickedSeats();
    $("ndDelSeatSlide").value = 0;
  };

  $("ndBack").onclick = ()=> showScreen("scrSeatSetup");

  renderNameGrid();
  renderSeatGrid();
}

/* ===== å°ç·š ===== */
$("goNameCreate").onclick = ()=> { buildNameCreateUI(); showScreen("scrNameCreate"); };
$("goNameDelete").onclick = ()=> { buildNameDeleteUI(); showScreen("scrNameDelete"); };

/* showScreen hook */
(function hookShowScreenForSeatSetup(){
  if(showScreen._ssHooked_v3) return;
  const _show = showScreen;
  showScreen = function(id){
    _show(id);
    if(id==="scrSeatSetup"){
      renderNameGrid();
      renderGroups();
      renderSeatPreview();
    }
    if(id==="scrNameCreate"){
      buildNameCreateUI();
    }
    if(id==="scrNameDelete"){
      buildNameDeleteUI();
    }
  };
  showScreen._ssHooked_v3 = true;
})();

renderNameGrid();
renderGroups();
renderSeatPreview();

/* =========================
  ã“ã“ã‹ã‚‰å…ˆã¯ PART7 ã§ç¶šã
========================= */
/* =========================
  PART7ï¼šåŒæœŸãƒ»ç«¯æœ«ç®¡ç†ãƒ»ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ï¼ˆå®Œæˆç‰ˆï¼‰
  é‡è¦ï¼š
   - ğŸ“¶ã¯æ®‹ã™
   - ãƒ¡ã‚¤ãƒ³ç”»é¢ã®ã€ŒåŒæœŸçŠ¶æ…‹ï¼šã€œã€æ–‡å­—ã¯ãã‚‚ãã‚‚è¡¨ç¤ºã—ãªã„ï¼ˆPART1ã§å‰Šé™¤æ¸ˆã¿ï¼‰
   - å‹æ‰‹ã«åŒæœŸã—ãªã„ï¼ˆæ“ä½œã”ã¨ã«â€œ1å›ã ã‘è©¦ã™â€ï¼‹æœªåŒæœŸãŒã‚ã‚‹æ™‚ã ã‘10åˆ†ãŠãè©¦è¡Œï¼‰
   - ä¿å­˜ï¼ç¢ºå®šä¿å­˜ï¼‹æœªåŒæœŸãŒã‚ã‚Œã°å†é€
   - FREEç«¯æœ«3å°åˆ¶é™ï¼ˆåŒæœŸä¸å¯ã€ãƒ­ãƒ¼ã‚«ãƒ«æ“ä½œã¯å¯èƒ½ï¼‰
========================= */

/* ===== Storage helpers ===== */
function loadStore(){
  try{
    const raw = localStorage.getItem(KEY);
    if(!raw) return null;
    return JSON.parse(raw);
  }catch(e){
    return null;
  }
}
function saveStore(obj){
  localStorage.setItem(KEY, JSON.stringify(obj));
}

/* ===== Device ID / limit ===== */
function getDeviceId(){
  const k = KEY + "_DEVICE_ID";
  let id = localStorage.getItem(k);
  if(!id){
    id = "dev_" + Math.random().toString(36).slice(2);
    localStorage.setItem(k, id);
  }
  return id;
}

state.sync = state.sync || {
  deviceId: getDeviceId(),
  devices: [],
  pending: [],
  lastTryTs: 0,
  maxDevicesFree: 3,
  canSync: true,
};

function ensureDeviceRegistered(){
  const st = loadStore() || {};
  st.devices = st.devices || [];
  if(!st.devices.includes(state.sync.deviceId)){
    st.devices.push(state.sync.deviceId);
  }
  state.sync.devices = st.devices.slice();
  saveStore(st);

  state.sync.canSync = (state.sync.devices.length <= state.sync.maxDevicesFree);
  return state.sync.canSync;
}

/* ===== Persist / Restore ===== */
function persistAll(){
  const st = loadStore() || {};
  st.devices = state.sync.devices.slice();
  st.pending = state.sync.pending;

  st.seats = state.seats;
  st.seatSetup = state.seatSetup;
  st.kitchen = state.kitchen;
  st.sales = state.sales;
  st.menu = state.menu;

  st.updatedTs = nowTs();
  saveStore(st);
}

function restoreAll(){
  const st = loadStore();
  if(!st) return;

  if(Array.isArray(st.seats)) state.seats = st.seats;
  if(st.seatSetup) state.seatSetup = st.seatSetup;
  if(st.kitchen) state.kitchen = st.kitchen;
  if(st.sales) state.sales = st.sales;
  if(st.menu) state.menu = st.menu;

  state.sync.devices = Array.isArray(st.devices) ? st.devices : [];
  state.sync.pending = Array.isArray(st.pending) ? st.pending : [];

  setSync(state.sync.pending.length === 0);
}

/* ===== Event queue ===== */
function emitEvent(type, payload){
  const ev = {
    id: "ev_" + Math.random().toString(36).slice(2),
    type,
    ts: nowTs(),
    deviceId: state.sync.deviceId,
    payload: payload || {}
  };
  state.sync.pending.push(ev);
  setSync(false);
  persistAll();
  trySyncOnceSilent();
}

/* ===== Sync attempt (pseudo) ===== */
function canActuallySync(){
  if(!ensureDeviceRegistered()) return false;
  if(typeof navigator !== "undefined" && navigator.onLine === false) return false;
  return true;
}

function trySyncOnceSilent(){
  if(state.sync.pending.length === 0) return;
  const now = nowTs();
  if(now - state.sync.lastTryTs < 10_000) return; // é€£æ‰“é˜²æ­¢
  state.sync.lastTryTs = now;

  if(!canActuallySync()){
    return; // é™ã‹ã«å¤±æ•—
  }

  // æˆåŠŸæ‰±ã„ï¼ˆæœ¬ç•ªã¯ã‚µãƒ¼ãƒãƒ¼é€ä¿¡â†’æˆåŠŸã§clearï¼‰
  state.sync.pending = [];
  setSync(true);
  persistAll();
}

function manualSync(){
  if(state.sync.pending.length === 0){
    setSync(true);
    toast("åŒæœŸã•ã‚Œã¦ã„ã¾ã™");
    return;
  }

  if(!ensureDeviceRegistered()){
    openModal(
      "åŒæœŸ",
      "ç„¡æ–™ç‰ˆã§ã¯åŒæœŸã§ãã‚‹ç«¯æœ«ã¯3å°ã¾ã§ã§ã™<br>æœ‰æ–™ç‰ˆã§ã¯åˆ©ç”¨å¯èƒ½ãªç«¯æœ«æ•°ãŒå¢—ãˆã¾ã™",
      [{label:"æˆ»ã‚‹", lime:false, onClick:()=> closeModal()}]
    );
    return;
  }

  if(!canActuallySync()){
    toast("åŒæœŸã§ãã¾ã›ã‚“ã§ã—ãŸï¼ˆé›»æ³¢çŠ¶æ³ã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼‰");
    setSync(false);
    persistAll();
    return;
  }

  state.sync.pending = [];
  setSync(true);
  persistAll();
  toast("åŒæœŸã—ã¾ã—ãŸ");
}

/* ===== Auto trial (10åˆ†ãŠãã€æœªåŒæœŸãŒã‚ã‚‹å ´åˆã®ã¿) ===== */
(function startAutoTrial(){
  if(startAutoTrial._started) return;
  startAutoTrial._started = true;

  setInterval(()=>{
    if(state.sync.pending.length === 0) return;
    trySyncOnceSilent();
  }, 10 * 60 * 1000);
})();

/* ===== Save ===== */
function openSaveModal(){
  openModal(
    "ä¿å­˜",
    "æ³¨æ–‡ãƒ»ä¼šè¨ˆãƒ»å¸­æƒ…å ±ã¯ç«¯æœ«é–“ã§è‡ªå‹•åŒæœŸã•ã‚Œã¾ã™ï¼ˆé›»æ³¢çŠ¶æ³ãŒè‰¯å¥½ãªå ´åˆï¼‰<br><br>âš ï¸ å–¶æ¥­çµ‚äº†æ™‚ãƒ»é€€å‹¤æ™‚ã«ã¯å¿…ãšä¿å­˜ã‚’è¡Œã£ã¦ãã ã•ã„",
    [
      {label:"ç¢ºå®šä¿å­˜", lime:true, onClick:()=>{
        closeModal();
        performSave();
      }},
      {label:"æˆ»ã‚‹", lime:false, onClick:()=> closeModal()},
    ]
  );
}

function performSave(){
  ensureDeviceRegistered();
  persistAll();

  if(state.sync.pending.length){
    manualSync();
  }else{
    setSync(true);
    toast("ä¿å­˜ã—ã¾ã—ãŸ");
  }
}

/* ===== Antenna tap behavior ===== */
function openSyncModal(){
  if(state.sync.canSync === false){
    openModal(
      "åŒæœŸ",
      "ç„¡æ–™ç‰ˆã§ã¯åŒæœŸã§ãã‚‹ç«¯æœ«ã¯3å°ã¾ã§ã§ã™<br>æœ‰æ–™ç‰ˆã§ã¯åˆ©ç”¨å¯èƒ½ãªç«¯æœ«æ•°ãŒå¢—ãˆã¾ã™",
      [{label:"æˆ»ã‚‹", lime:false, onClick:()=> closeModal()}]
    );
    return;
  }

  if(state.sync.pending.length === 0){
    openModal("åŒæœŸ", "åŒæœŸã•ã‚Œã¦ã„ã¾ã™", [
      {label:"æˆ»ã‚‹", lime:false, onClick:()=> closeModal()}
    ]);
    return;
  }

  openModal(
    "åŒæœŸ",
    "åŒæœŸã•ã‚Œã¦ã„ã¾ã›ã‚“<br>é›»æ³¢çŠ¶æ³ã‚„ä¸€æ™‚çš„ãªä¸å…·åˆã®å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™<br>ä¿å­˜ã‚’è¡Œã†ã¨å†åŒæœŸã‚’è©¦ã¿ã¾ã™",
    [
      {label:"åŒæœŸé–‹å§‹", lime:true, onClick:()=>{
        closeModal();
        manualSync();
      }},
      {label:"æˆ»ã‚‹", lime:false, onClick:()=> closeModal()},
    ]
  );
}

/* ===== Hook header buttons ===== */
(function hookHeaderButtonsPart7(){
  $("btnSave").onclick = ()=> openSaveModal();
  $("btnAntenna").onclick = ()=> openSyncModal();
})();

/* ===== Boot ===== */
(function bootPart7(){
  ensureDeviceRegistered();
  restoreAll();

  // pendingãŒã‚ã‚Œã°ğŸ“¶âŒ
  setSync(state.sync.pending.length === 0);

  // ç«¯æœ«åˆ¶é™åæ˜ 
  ensureDeviceRegistered();

  // å¾©å…ƒå¾Œã«å†æç”»
  renderSeats();
})();
 /* =========================
  ã“ã“ã‹ã‚‰å…ˆã¯ PART8 ã§ç¶šã
========================= */
/* =========================
  PART8ï¼šè¨­å®šãƒ»FAQï¼ˆã‚ˆãã‚ã‚‹è³ªå•ï¼‰ãƒ»æœ‰æ–™å°ç·š ï¼‹ ãƒ¡ãƒ‹ãƒ¥ãƒ¼ç™»éŒ² ï¼‹ åº—èˆ—æƒ…å ±
  å¤‰æ›´ç‚¹ï¼š
   - ã€Œã‚ˆãã‚ã‚‹ãŠå•åˆã›ã€â†’ FAQï¼ˆã‚ˆãã‚ã‚‹è³ªå•ï¼‰
   - ãŠå•åˆã›ã¯FAQå†…ã«è¨­ç½®
   - åˆ©ç”¨æ¡ä»¶ãƒœã‚¿ãƒ³å‰Šé™¤ï¼ˆé‡è¤‡ï¼‰
   - å…¨ç”»é¢åŒ–ãƒœã‚¿ãƒ³ã¯3åˆ—æŠ˜ã‚Šè¿”ã—ã®â€œä¸‹æ®µã«æ¨ªé•·â€ã§è¨­ç½®
========================= */

/* =========================================================
   0) ç”»é¢è¿½åŠ ï¼šåº—èˆ—æƒ…å ± / ãƒ¬ã‚·ãƒ”ææ¡ˆï¼ˆPART1ã«ç„¡ã„å ´åˆã“ã“ã§å¢—è¨­ï¼‰
========================================================= */
(function ensureExtraScreens(){
  const app = document.querySelector("main.app");
  if(!app) return;

  function addScreen(id){
    if($(id)) return;
    const sec = document.createElement("section");
    sec.className = "screen";
    sec.id = id;
    sec.innerHTML = `<div style="opacity:.8">ï¼ˆPART8ã§å®Ÿè£…ï¼‰</div>`;
    app.appendChild(sec);
    try{ screens.push(id); }catch(e){}
  }
  addScreen("scrStoreInfo");
  addScreen("scrRecipe");
})();

/* =========================================================
   A) è¨­å®šï¼ˆscrSettingsï¼‰
========================================================= */
(function buildSettingsUI(){
  const scr = $("scrSettings");
  scr.innerHTML = `
    <div class="pill" style="margin-bottom:10px">è¨­å®š</div>

    <!-- ãƒœã‚¿ãƒ³ï¼š3åˆ—æŠ˜ã‚Šè¿”ã—ï¼ˆå…¨ç”»é¢åŒ–ã¯ä¸‹ã«æ¨ªé•·ã§åˆ¥ç½®ãï¼‰ -->
    <div class="seatGrid" style="margin-bottom:10px">
      <button class="seatCard" id="goSeatSetupBtn" style="min-height:56px; font-weight:900; display:flex; align-items:center; justify-content:center">å¸­ç™»éŒ²</button>
      <button class="seatCard" id="goMenuBtn" style="min-height:56px; font-weight:900; display:flex; align-items:center; justify-content:center">ãƒ¡ãƒ‹ãƒ¥ãƒ¼ç™»éŒ²</button>
      <button class="seatCard" id="goStoreBtn" style="min-height:56px; font-weight:900; display:flex; align-items:center; justify-content:center">åº—èˆ—æƒ…å ±</button>

      <button class="seatCard" id="goSalesManageBtn" style="min-height:56px; font-weight:900; display:flex; align-items:center; justify-content:center">å£²ä¸Šç®¡ç†</button>
      <button class="seatCard" id="goFaqBtn" style="min-height:56px; font-weight:900; display:flex; align-items:center; justify-content:center; text-align:center">
        FAQ<br><span style="font-weight:700; opacity:.85">ï¼ˆã‚ˆãã‚ã‚‹è³ªå•ï¼‰</span>
      </button>
      <button class="seatCard" id="goRecipeBtn" style="min-height:56px; font-weight:900; display:flex; align-items:center; justify-content:center">ãƒ¬ã‚·ãƒ”ææ¡ˆ</button>
    </div>

    <!-- å…¨ç”»é¢åŒ–ï¼ˆæ¨ªé•·ï¼‰ -->
    <button class="btn full" id="goPwaBtn" style="min-height:52px; font-weight:900; margin-bottom:12px">å…¨ç”»é¢åŒ–</button>

    <!-- æ³¨æ„äº‹é …ï¼ˆæ¨ªé•·ï¼‰ -->
    <div class="pill" style="margin-bottom:12px; line-height:1.6">
      âš ï¸ å–¶æ¥­çµ‚äº†æ™‚ãƒ»é€€å‹¤æ™‚ã«ã¯å¿…ãšã€Œä¿å­˜ã€ã‚’è¡Œã£ã¦ãã ã•ã„ï¼ˆãƒ‡ãƒ¼ã‚¿ä¿å…¨ã®ãŸã‚ï¼‰
    </div>

    <div class="pill" style="margin-bottom:8px">ç„¡æ–™ç‰ˆã«ã¤ã„ã¦</div>
    <div class="pill" style="color:var(--muted); margin-bottom:12px; line-height:1.7">
      ãƒ»åˆ©ç”¨å¯èƒ½ç«¯æœ«ï¼šæœ€å¤§3å°<br>
      ãƒ»ãƒ‡ãƒ¼ã‚¿ã®å¾©æ—§ã€ä¿è¨¼ãªã—<br>
      ãƒ»ã‚µãƒãƒ¼ãƒˆã¯é™å®šçš„
    </div>

    <div class="pill" style="margin-bottom:8px">æœ‰æ–™ç‰ˆã®ã”æ¡ˆå†…</div>
    <div class="pill" style="color:var(--muted); margin-bottom:12px; line-height:1.7">
      ãƒ»åˆ©ç”¨ç«¯æœ«æ•°ã®æ‹¡å¼µ<br>
      ãƒ»ãƒ‡ãƒ¼ã‚¿ã®å®‰å…¨ãªä¿å­˜<br>
      ãƒ»ã‚µãƒãƒ¼ãƒˆå¯¾å¿œ<br>
      ãƒ»ç¨ç†å£«ã€ä¼šè¨ˆã‚½ãƒ•ãƒˆå‘ã‘ãƒ‡ãƒ¼ã‚¿å‡ºåŠ›<br>
      ãƒ»å£²ä¸Šåˆ†æã€ã‚°ãƒ©ãƒ•è¡¨ç¤º<br>
      ãƒ»AIã«ã‚ˆã‚‹æ–™ç†ãƒ»ãƒ¡ãƒ‹ãƒ¥ãƒ¼ææ¡ˆ<br>
      ãƒ»å°†æ¥è¿½åŠ ã•ã‚Œã‚‹æ–°æ©Ÿèƒ½
    </div>

    <div class="pill" style="margin-bottom:8px">ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±</div>
    <div class="pill" style="color:var(--muted); line-height:1.7">
      ONE<br>
      Versionï¼šFREE 0.1.0<br>
      æ›´æ–°æ—¥ï¼š2026/02/10<br>
      ç¾åœ¨ã¯ç„¡æ–™ç‰ˆã§ã™
    </div>
  `;
})();

/* =========================================================
   B) FAQï¼ˆã‚ˆãã‚ã‚‹è³ªå•ï¼‰ â€»ãŠå•åˆã›ãƒœã‚¿ãƒ³ã¯FAQå†…ã¸
========================================================= */
const FAQ_CATS = [
  {id:"seat",  label:"å¸­/æ³¨æ–‡"},
  {id:"sales", label:"å£²ä¸Š/ä¼šè¨ˆ"},
  {id:"sync",  label:"åŒæœŸ/ä¿å­˜"},
  {id:"backup",label:"ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—"},
  {id:"other", label:"ãã®ä»–"},
];

const FAQ_LIST = [
  {cat:"sales", q:"ä¼šè¨ˆåˆç®—ã¯ã©ã†ã‚„ã£ã¦è¡Œã„ã¾ã™ã‹ï¼Ÿ", a:"åŒã˜å¸­å†…ã«ã‚ã‚‹è¤‡æ•°ã®ä¼šè¨ˆã‚’ã€ä¼šè¨ˆåˆç®—ã§ã¾ã¨ã‚ã¾ã™ã€‚åˆ¥ã®å¸­åŒå£«ã‚’ç›´æ¥åˆç®—ã™ã‚‹ã“ã¨ã¯ã§ãã¾ã›ã‚“ã€‚åˆ¥å¸­ã‚’ã¾ã¨ã‚ãŸã„å ´åˆã¯ã€å…ˆã«å¸­ç§»å‹•ã§åŒã˜å¸­ã«é›†ã‚ã¦ãã ã•ã„ã€‚"},
  {cat:"sales", q:"ä¼šè¨ˆåˆ†å‰²ã¯ã„ã¤ã§ãã¾ã™ã‹ï¼Ÿ", a:"åŒä¸€å¸­å†…ã§ã€åˆç®—ã•ã‚Œã¦ã„ã‚‹ä¼šè¨ˆã‚’å…ƒã«æˆ»ã—ãŸã„æ™‚ã«è¡Œã„ã¾ã™ã€‚ãªãŠã€åˆç®—å¾Œã«è¿½åŠ ã•ã‚ŒãŸæ³¨æ–‡ã¯åˆ†å‰²ã§ãã¾ã›ã‚“ã€‚"},
  {cat:"seat",  q:"å¸­ç§»å‹•ã¨åˆæµã®é•ã„ã¯ä½•ã§ã™ã‹ï¼Ÿ", a:"å¸­ç§»å‹•ã¯å¸­ãƒ‡ãƒ¼ã‚¿ã‚’å…¥ã‚Œæ›¿ãˆã¾ã™ï¼ˆAâ‡„Bï¼‰ã€‚åˆæµã¯è¤‡æ•°å¸­ã‚’åŒã˜ã‚«ãƒ¼ãƒ‰å†…ã«è¡¨ç¤ºã™ã‚‹æ“ä½œã§ã™ï¼ˆAâ¡ï¸Bï¼‰ã€‚"},
  {cat:"seat",  q:"å•†å“ãŒæ¥ãªã‹ã£ãŸå ´åˆã®ä¿®æ­£æ–¹æ³•ã¯ï¼Ÿ", a:"ä¼šè¨ˆç¢ºå®šå‰ã§ã‚ã‚Œã°ã€æ³¨æ–‡å±¥æ­´ã‹ã‚‰è©²å½“å•†å“ã‚’ä¿®æ­£ã§ãã¾ã™ã€‚å–æ¶ˆã¯å±¥æ­´ã¨ã—ã¦æ®‹ã‚Šã¾ã™ã€‚"},
  {cat:"seat",  q:"æ³¨æ–‡æ•°ã‚’é–“é•ãˆãŸæ™‚ã¯ã©ã†ãªã‚Šã¾ã™ã‹ï¼Ÿ", a:"æ³¨æ–‡å±¥æ­´ã‹ã‚‰ä¿®æ­£ã§ãã¾ã™ã€‚ä¿®æ­£å†…å®¹ã¯å±¥æ­´ã«æ®‹ã‚Šã¾ã™ã€‚"},
  {cat:"sync",  q:"åŒæœŸãƒãƒ¼ã‚¯âŒãŒå‡ºãŸæ™‚ã¯ã©ã†ã™ã‚Œã°ã„ã„ã§ã™ã‹ï¼Ÿ", a:"é›»æ³¢çŠ¶æ³ã‚„ä¸€æ™‚çš„ãªä¸å…·åˆã«ã‚ˆã‚Šã€åŒæœŸã§ãã¦ã„ãªã„çŠ¶æ…‹ã§ã™ã€‚é›»æ³¢ã®è‰¯ã„å ´æ‰€ã§åŒæœŸï¼ˆä¿å­˜ï¼‰ã‚’è¡Œã£ã¦ãã ã•ã„ã€‚"},
  {cat:"sync",  q:"é›»æ³¢ãŒãªã„å ´æ‰€ã§ã‚‚ä½¿ãˆã¾ã™ã‹ï¼Ÿ", a:"ä½¿ãˆã¾ã™ã€‚æ³¨æ–‡ãƒ»ä¼šè¨ˆãƒ»å¸­æ“ä½œã¯ç«¯æœ«å†…ã«ä¿å­˜ã•ã‚Œã¾ã™ã€‚ãŸã ã—ç«¯æœ«é–“å…±æœ‰ã¯è¡Œã‚ã‚Œãªã„ãŸã‚ã€é€šä¿¡ç’°å¢ƒãŒæ•´ã£ã¦ã„ã‚‹å ´æ‰€ã§ã®åˆ©ç”¨ã‚’æ¨å¥¨ã—ã¾ã™ã€‚"},
  {cat:"backup",q:"ãƒ‡ãƒ¼ã‚¿ã¯ã©ã“ã«ä¿å­˜ã•ã‚Œã¦ã„ã¾ã™ã‹ï¼Ÿ", a:"ç«¯æœ«å†…ã«ä¿å­˜ã•ã‚Œã¾ã™ã€‚ç«¯æœ«ã®æ•…éšœãƒ»ç´›å¤±ãƒ»ä¸å…·åˆã«å‚™ãˆã€å£²ä¸Šç®¡ç†ã‹ã‚‰ãƒ¡ãƒ¼ãƒ«é€ä¿¡ï¼ˆãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ï¼‰ã‚’è¡Œã£ã¦ãã ã•ã„ã€‚"},
  {cat:"backup",q:"æ©Ÿç¨®å¤‰æ›´ã—ãŸå ´åˆã¯ã©ã†ãªã‚Šã¾ã™ã‹ï¼Ÿ", a:"ç«¯æœ«å†…ã®ãƒ‡ãƒ¼ã‚¿ã¯è‡ªå‹•ã§ã¯å¼•ãç¶™ãŒã‚Œã¾ã›ã‚“ã€‚äº‹å‰ã«ä¿å­˜ã‚„ãƒ‡ãƒ¼ã‚¿é€ä¿¡ã‚’è¡Œã£ã¦ãã ã•ã„ã€‚"},
  {cat:"other", q:"å–¶æ¥­çµ‚äº†æ™‚ã«å¿…ãšè¡Œã†ã“ã¨ã¯ï¼Ÿ", a:"ä¿å­˜æ“ä½œã‚’è¡Œã„ã€å¿…è¦ã«å¿œã˜ã¦å£²ä¸Šãƒ‡ãƒ¼ã‚¿ã‚’ãƒ¡ãƒ¼ãƒ«ãªã©ã§é€ä¿¡ã—ã¦ãã ã•ã„ã€‚ãƒ‡ãƒ¼ã‚¿ä¿å…¨ã®ãŸã‚ã«é‡è¦ã§ã™ã€‚"},
];

function openContactInFaq(){
  openModal(
    "ãŠå•åˆã›",
    `
      <div class="pill" style="margin-bottom:10px; line-height:1.7">
        ONEã«é–¢ã™ã‚‹ã”è³ªå•ãƒ»ä¸å…·åˆã®ã”é€£çµ¡ã¯ä¸‹è¨˜ã‚ˆã‚ŠãŠé¡˜ã„ã„ãŸã—ã¾ã™ã€‚
      </div>
      <div class="pill" style="color:var(--muted); margin-bottom:10px; line-height:1.7">
        ã”é€£çµ¡ã®éš›ã¯<br>
        ãƒ»åº—èˆ—å<br>
        ãƒ»ä½¿ç”¨ç«¯æœ«<br>
        ãƒ»ç™ºç”Ÿã—ãŸçŠ¶æ³<br>
        ã‚’è¨˜è¼‰ã„ãŸã ãã¨ã‚¹ãƒ ãƒ¼ã‚ºã§ã™ã€‚
      </div>
      <div class="pill">ãƒ»ãƒ¡ãƒ¼ãƒ«ã§å•ã„åˆã‚ã›ï¼ˆä»»æ„ï¼‰</div>
      <div class="pill">ãƒ»LINEã§å•ã„åˆã‚ã›ï¼ˆä»»æ„ï¼‰</div>
    `,
    [{label:"æˆ»ã‚‹", onClick:()=> closeModal()}]
  );
}

function openFaqHome(){
  const body = `
    <div style="max-height:70vh; overflow:auto; padding-right:4px">

      <div style="text-align:center; margin-bottom:10px">
        <div style="font-weight:900; font-size:20px">FAQ</div>
        <div style="opacity:.85">ï¼ˆã‚ˆãã‚ã‚‹è³ªå•ï¼‰</div>
      </div>

      <div class="pill" style="margin-bottom:10px; color:var(--muted); line-height:1.7">
        é …ç›®ã‚’é¸ã¶ã¨ã€è©²å½“ã™ã‚‹Q&AãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚<br>
        ãŠå•åˆã›ã¯ä¸‹ã®ãƒœã‚¿ãƒ³ã‹ã‚‰è¡Œãˆã¾ã™ã€‚
      </div>

      <div class="seatGrid" id="faqCatGrid" style="margin-bottom:12px"></div>

      <button class="btn full" id="faqContactBtn" style="min-height:52px; font-weight:900">ãŠå•åˆã›</button>
    </div>
  `;
  openModal("FAQ", body, [{label:"æˆ»ã‚‹", onClick:()=> closeModal()}]);

  setTimeout(()=>{
    const grid = $("faqCatGrid");
    grid.innerHTML = "";
    FAQ_CATS.forEach(c=>{
      const b = document.createElement("button");
      b.className = "seatCard";
      b.style.minHeight = "56px";
      b.style.fontWeight = "900";
      b.style.display="flex";
      b.style.alignItems="center";
      b.style.justifyContent="center";
      b.textContent = c.label;
      b.onclick = ()=> openFaqList(c.id, c.label);
      grid.appendChild(b);
    });

    $("faqContactBtn").onclick = ()=> openContactInFaq();
  },0);
}

function openFaqList(catId, catLabel){
  const list = FAQ_LIST.filter(x=> x.cat===catId);
  const body = `
    <div style="max-height:70vh; overflow:auto; padding-right:4px">
      ${list.map(x=>`
        <div class="pill" style="margin-bottom:6px; font-weight:900">Qï¼š${x.q}</div>
        <div class="pill" style="margin-bottom:12px; color:var(--muted); line-height:1.7">Aï¼š${x.a}</div>
      `).join("") || `<div class="pill">ã¾ã ã‚ã‚Šã¾ã›ã‚“</div>`}
      <div style="height:10px"></div>
      <button class="btn full" id="faqContactBtn2" style="min-height:52px; font-weight:900">ãŠå•åˆã›</button>
    </div>
  `;
  openModal(catLabel, body, [
    {label:"æˆ»ã‚‹", onClick:()=> openFaqHome()},
    {label:"é–‰ã˜ã‚‹", onClick:()=> closeModal()},
  ]);

  setTimeout(()=>{
    $("faqContactBtn2").onclick = ()=> openContactInFaq();
  },0);
}

/* =========================================================
   C) å…¨ç”»é¢åŒ–ï¼ˆPWA/ãƒ›ãƒ¼ãƒ ç”»é¢ã«è¿½åŠ ï¼‰æ¡ˆå†…
========================================================= */
function openPwaGuide(){
  openModal(
    "å…¨ç”»é¢åŒ–ï¼ˆæ¨å¥¨ï¼‰",
    `
      <div style="max-height:70vh; overflow:auto; padding-right:4px; line-height:1.7">
        <div class="pill" style="margin-bottom:10px">
          ONEã‚’ã€Œãƒ›ãƒ¼ãƒ ç”»é¢ã«è¿½åŠ ã€ã§èµ·å‹•ã™ã‚‹ã¨ã€ãƒ–ãƒ©ã‚¦ã‚¶ã®ä¸‹éƒ¨ãƒãƒ¼ç­‰ãŒå‡ºãšã€ã‚¢ãƒ—ãƒªã®ã‚ˆã†ã«å…¨ç”»é¢ã§ä½¿ãˆã¾ã™ã€‚
        </div>

        <div class="pill" style="margin-bottom:10px; color:var(--muted)">
          â–  iPhone / iPadï¼ˆSafariï¼‰<br>
          1) Safariã§ONEã‚’é–‹ã<br>
          2) å…±æœ‰ â†’ã€Œãƒ›ãƒ¼ãƒ ç”»é¢ã«è¿½åŠ ã€<br>
          3) ä»¥å¾Œã€ãƒ›ãƒ¼ãƒ ç”»é¢ã®ONEã‚¢ã‚¤ã‚³ãƒ³ã‹ã‚‰èµ·å‹•
        </div>

        <div class="pill" style="color:var(--muted)">
          â–  Androidï¼ˆChromeç­‰ï¼‰<br>
          1) ãƒ–ãƒ©ã‚¦ã‚¶ã§ONEã‚’é–‹ã<br>
          2) ãƒ¡ãƒ‹ãƒ¥ãƒ¼ â†’ã€Œãƒ›ãƒ¼ãƒ ç”»é¢ã«è¿½åŠ ã€<br>
          3) ä»¥å¾Œã€ãƒ›ãƒ¼ãƒ ç”»é¢ã®ã‚¢ã‚¤ã‚³ãƒ³ã‹ã‚‰èµ·å‹•
        </div>
      </div>
    `,
    [{label:"æˆ»ã‚‹", onClick:()=> closeModal()}]
  );
}

/* =========================================================
   D) åº—èˆ—æƒ…å ±ï¼ˆscrStoreInfoï¼‰
========================================================= */
state.store = state.store || {
  shopName:"",
  tel:"",
  note:"",
  staff:[],
};

function buildStoreInfoUI(){
  const scr = $("scrStoreInfo");
  if(!scr) return;

  scr.innerHTML = `
    <div class="pill" style="margin-bottom:10px">åº—èˆ—æƒ…å ±</div>

    <div class="pill" style="margin-bottom:8px">åº—èˆ—</div>
    <input id="stShop" class="btn full" style="text-align:left; margin-bottom:10px" placeholder="åº—èˆ—å" />
    <input id="stTel" class="btn full" style="text-align:left; margin-bottom:10px" placeholder="é›»è©±ï¼ˆä»»æ„ï¼‰" inputmode="tel" />
    <input id="stNote" class="btn full" style="text-align:left; margin-bottom:14px" placeholder="ãƒ¡ãƒ¢ï¼ˆä»»æ„ï¼‰" />

    <div class="pill" style="margin-bottom:8px">å¾“æ¥­å“¡åï¼ˆä¿®æ­£è€…åã®å€™è£œï¼‰</div>

    <div style="display:flex; gap:10px; align-items:center; margin-bottom:10px">
      <input id="stStaffNew" class="btn full" style="text-align:left" placeholder="è¿½åŠ ã™ã‚‹å¾“æ¥­å“¡å" />
      <button class="btn lime" id="stStaffAdd" style="min-width:92px; font-weight:900">è¿½åŠ </button>
    </div>

    <div class="pill" style="color:var(--muted); margin-bottom:10px; line-height:1.7">
      ãƒ»å‰Šé™¤ã¯ã“ã“ã‹ã‚‰ã®ã¿å¯èƒ½ã§ã™<br>
      ãƒ»å‰Šé™¤ã—ã¦ã‚‚ã€å£²ä¸Šã®ä¿®æ­£å±¥æ­´ã‹ã‚‰åå‰ã¯æ¶ˆãˆã¾ã›ã‚“ï¼ˆè¨˜éŒ²ã¯ä¿æŒï¼‰
    </div>

    <div id="stStaffList"></div>

    <div style="height:14px"></div>
    <div style="display:flex; gap:10px">
      <button class="btn full" id="stBack">æˆ»ã‚‹</button>
      <button class="btn lime full" id="stSave">ä¿å­˜</button>
    </div>
  `;

  $("stShop").value = state.store.shopName || "";
  $("stTel").value  = state.store.tel || "";
  $("stNote").value = state.store.note || "";

  $("stBack").onclick = ()=> showScreen("scrSettings");
  $("stSave").onclick = ()=>{
    state.store.shopName = ($("stShop").value||"").trim();
    state.store.tel      = ($("stTel").value||"").trim();
    state.store.note     = ($("stNote").value||"").trim();
    if(typeof persistAll==="function") persistAll();
    toast("ä¿å­˜ã—ã¾ã—ãŸ");
    showScreen("scrSettings");
  };

  $("stStaffAdd").onclick = ()=>{
    const v = ($("stStaffNew").value||"").trim();
    if(!v){ toast("åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"); return; }
    if(state.store.staff.includes(v)){ toast("åŒã˜åå‰ãŒã‚ã‚Šã¾ã™"); return; }
    state.store.staff.push(v);
    $("stStaffNew").value = "";
    renderStaffList();
    if(typeof persistAll==="function") persistAll();
    toast("è¿½åŠ ã—ã¾ã—ãŸ");
  };

  function renderStaffList(){
    const box = $("stStaffList");
    box.innerHTML = "";
    if(!state.store.staff.length){
      box.innerHTML = `<div class="pill">ã¾ã ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</div>`;
      return;
    }

    state.store.staff.forEach(name=>{
      const row = document.createElement("div");
      row.className = "kRow";
      row.innerHTML = `
        <div class="kLeft"><div class="kName">${name}</div></div>
        <div class="kSlide" style="gap:10px">
          <button class="btn" data-del="${name}">å‰Šé™¤</button>
        </div>
      `;
      box.appendChild(row);
    });

    box.querySelectorAll("[data-del]").forEach(btn=>{
      btn.onclick = ()=>{
        const nm = btn.getAttribute("data-del");
        openModal(
          "å‰Šé™¤",
          `
            <div class="pill" style="margin-bottom:10px; color:var(--danger)">ã€Œ${nm}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ</div>
            <div class="pill" style="color:var(--muted); margin-bottom:10px; line-height:1.7">
              â€» å£²ä¸Šã®ä¿®æ­£å±¥æ­´ã‹ã‚‰åå‰ã¯æ¶ˆãˆã¾ã›ã‚“ï¼ˆè¨˜éŒ²ã¯ä¿æŒï¼‰
            </div>
            <input id="stDelSlide" class="range" type="range" min="0" max="100" value="0" />
          `,
          [{label:"æˆ»ã‚‹", onClick:()=> closeModal()}]
        );
        setTimeout(()=>{
          $("stDelSlide").onchange = ()=>{
            if(Number($("stDelSlide").value||0) < 88){ $("stDelSlide").value=0; return; }
            state.store.staff = state.store.staff.filter(x=> x!==nm);
            closeModal();
            renderStaffList();
            if(typeof persistAll==="function") persistAll();
            toast("å‰Šé™¤ã—ã¾ã—ãŸ");
          };
        },0);
      };
    });
  }
  renderStaffList();
}

/* =========================================================
   E) ãƒ¡ãƒ‹ãƒ¥ãƒ¼ç™»éŒ²ï¼ˆscrMenuï¼‰ â€»ã‚ãªãŸã®æ—¢å­˜å®Ÿè£…ã‚’â€œãã®ã¾ã¾ä½¿ç”¨â€
   â€»ã“ã®PART8å·®ã—æ›¿ãˆã§ã¯ã€ŒscrMenuã®ä¸­èº«ã€ã¯è§¦ã‚Šã¾ã›ã‚“ï¼ˆæ—¢å­˜ãŒæ®‹ã‚‹ï¼‰
========================================================= */

/* =========================================================
   F) ãƒ¬ã‚·ãƒ”ææ¡ˆï¼ˆscrRecipeï¼‰ â€»ç„¡æ–™ç‰ˆã¯å°ç·šã ã‘
========================================================= */
(function buildRecipeUI(){
  const scr = $("scrRecipe");
  if(!scr) return;

  scr.innerHTML = `
    <div class="pill" style="margin-bottom:10px">ãƒ¬ã‚·ãƒ”ææ¡ˆ</div>
    <div class="pill" style="color:var(--muted); line-height:1.7; margin-bottom:14px">
      ç„¡æ–™ç‰ˆã§ã¯ã€Œãƒ¬ã‚·ãƒ”ææ¡ˆã€ã¯æ¡ˆå†…ã®ã¿ã§ã™ã€‚<br>
      æœ‰æ–™ç‰ˆã§ã€Œåº—èˆ—ã®é£Ÿæã‹ã‚‰æ¯æ—¥3å“ææ¡ˆã€ãªã©ãŒåˆ©ç”¨ã§ãã¾ã™ã€‚
    </div>
    <button class="btn full" id="recipeBack">æˆ»ã‚‹</button>
  `;
  $("recipeBack").onclick = ()=> showScreen("scrSettings");
})();

/* =========================================================
   G) è¨­å®šãƒœã‚¿ãƒ³å°ç·š
========================================================= */
$("goSeatSetupBtn").onclick = ()=> showScreen("scrSeatSetup");
$("goMenuBtn").onclick      = ()=> showScreen("scrMenu");
$("goStoreBtn").onclick     = ()=> { buildStoreInfoUI(); showScreen("scrStoreInfo"); };
$("goSalesManageBtn").onclick = ()=> { showScreen("scrSales"); if(typeof renderSales==="function") renderSales(); };
$("goFaqBtn").onclick       = ()=> openFaqHome();
$("goRecipeBtn").onclick    = ()=> showScreen("scrRecipe");
$("goPwaBtn").onclick       = ()=> openPwaGuide();

/* ===== showScreenæ‹¡å¼µ ===== */
(function hookShowScreenPart8(){
  if(showScreen._p8Hooked_v2) return;
  const _show = showScreen;
  showScreen = function(id){
    _show(id);

    if(id==="scrStoreInfo"){
      buildStoreInfoUI();
    }
  };
  showScreen._p8Hooked_v2 = true;
})();

/* èµ·å‹•è£œåŠ© */
(function openFirst(){
  showScreen("scrMain");
  if(typeof renderSeats==="function") renderSeats();
})();

/* =========================
  ã“ã“ã¾ã§ã§ 8åˆ†å‰² å®Œæˆ
========================= */
</script>
</body>
</html>