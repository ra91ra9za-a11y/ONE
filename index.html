<!-- =========================
  ONE ãƒ¬ã‚¸ã‚¢ãƒ—ãƒªï¼ˆç„¡æ–™ç‰ˆï¼‰å®Œæˆç‰ˆï¼šPART1
  å½¹å‰²ï¼šHTMLéª¨æ ¼ / CSS / å…±é€šJSï¼ˆstate, modal, navigation, mainï¼‰
  ä¿å­˜KEYï¼šONE_FREE_FULL_V3
========================= -->
<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>ONE FREE</title>

  <style>
    :root{
      --bg:#0b0f14;
      --text:#e9f1ff;
      --muted:#a9bbd4;
      --line:#233244;

      --header:#0b2a1b;
      --headerLine:rgba(255,255,255,0.10);

      --lime:#7fd36b;
      --accent:#7aa7ff;
      --danger:#ff6b6b;
      --ok:#3ddc97;

      --seatEmpty:#1b2a20;
      --seatReserve:#1b2a4e;
      --seatIn:#121a23;

      --headerH:56px;
      --bottomH:62px;
      --radius:14px;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }

    body{
      margin:0;
      font-family:-apple-system,BlinkMacSystemFont,"Hiragino Sans","Noto Sans JP",system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      background:var(--bg);
      color:var(--text);
      overflow-x:hidden;
      -webkit-font-smoothing:antialiased;
      text-rendering:optimizeLegibility;

      touch-action:pan-y;
      overscroll-behavior-y:contain;
      -webkit-text-size-adjust:100%;
    }

    /* ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤ºä¸­ã«èƒŒæ™¯å›ºå®šï¼ˆå…¥åŠ›ã‚ºãƒ¬é˜²æ­¢ã®æ ¸ï¼‰ */
    body.modalLock{
      position:fixed;
      width:100%;
      overflow:hidden;
    }

    /* iOSæ‹¡å¤§å¯¾ç­–ï¼ˆ16pxï¼‰ */
    input, textarea, select{
      font-size:16px;
      -webkit-appearance:none;
      appearance:none;
    }

    .app{
      min-height:100%;
      padding-top:calc(var(--headerH) + env(safe-area-inset-top));
      padding-bottom:calc(var(--bottomH) + env(safe-area-inset-bottom));
    }

    /* ===== Header ===== */
    .topbar{
      position:fixed;
      left:0; right:0; top:0;
      padding-top:env(safe-area-inset-top);
      height:calc(var(--headerH) + env(safe-area-inset-top));
      background:var(--header);
      border-bottom:1px solid var(--headerLine);
      z-index:50;
      display:flex;
      align-items:flex-end;
    }
    .topbarInner{
      height:var(--headerH);
      width:100%;
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:0 12px 6px;
      gap:10px;
    }
    .brandWrap{
      display:flex;
      align-items:center;
      gap:8px;
      min-width:96px;
    }
    .brand{
      font-weight:900;
      letter-spacing:0.5px;
      font-size:18px;
      line-height:1;
    }

    /* ã‚¢ãƒ³ãƒ†ãƒŠ */
    .antennaWrap{
      position:relative;
      width:44px;
      height:44px;
      display:flex;
      align-items:center;
      justify-content:center;
      background:transparent;
      border:none;
      padding:0;
      margin:0;
      touch-action:manipulation;
    }
    .antennaIcon{ font-size:26px; line-height:1; }
    .antennaX{
      position:absolute;
      top:6px; right:6px;
      font-size:15px;
      line-height:1;
      color:var(--danger);
      display:none;
      font-weight:900;
      text-shadow:0 1px 0 rgba(0,0,0,0.35);
    }
    .antennaWrap.off .antennaX{ display:block; }

    .topCenter{ flex:1; display:flex; justify-content:center; }

    .btn{
      border:1px solid var(--line);
      background:rgba(255,255,255,0.06);
      color:var(--text);
      border-radius:12px;
      padding:10px 14px;
      font-size:14px;
      line-height:1;
      min-height:42px;
      user-select:none;
      -webkit-user-select:none;
      touch-action:manipulation;
    }
    .btn.lime{
      background:var(--lime);
      border-color:rgba(0,0,0,0.15);
      color:#ffffff;
      font-weight:900;
    }
    .btn.ghost{
      background:transparent;
      border-color:transparent;
    }
    .btn.full{ width:100%; }
    .btn.primary{ /* äº’æ›ï¼ˆå£²ä¸Šã‚¿ãƒ–ç­‰ï¼‰ */
      background:var(--lime);
      border-color:rgba(0,0,0,0.15);
      color:#ffffff;
      font-weight:900;
    }

    /* ===== Pill ===== */
    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:10px 12px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,0.12);
      background:rgba(255,255,255,0.05);
      color:var(--text);
    }

    /* ===== Screens ===== */
    .screen{
      display:none;
      padding:12px;
      max-width:980px;
      margin:0 auto;
    }
    .screen.active{ display:block; }

    /* ===== Main ===== */
    .hintText{
      color:#ffffff;
      font-size:14px;
      padding:6px 2px;
      user-select:none;
    }
    .seatGrid{
      display:grid;
      grid-template-columns:repeat(3, minmax(0, 1fr));
      gap:10px;
    }
    .seatCard{
      border:1px solid rgba(255,255,255,0.10);
      border-radius:var(--radius);
      padding:10px;
      min-height:108px;
      display:flex;
      flex-direction:column;
      justify-content:space-between;
      gap:8px;
      touch-action:manipulation;
      overflow:hidden;
      background:rgba(255,255,255,0.04);
    }
    .seatCard.empty{ background:linear-gradient(180deg, rgba(27,42,32,0.98), rgba(27,42,32,0.86)); }
    .seatCard.reserve{ background:linear-gradient(180deg, rgba(27,42,78,0.98), rgba(27,42,78,0.86)); }
    .seatCard.in{ background:linear-gradient(180deg, rgba(18,26,35,0.98), rgba(18,26,35,0.86)); }

    .seatTop{ display:flex; flex-direction:column; gap:6px; min-width:0; }
    .seatNoLine{ display:flex; align-items:baseline; justify-content:space-between; gap:8px; min-width:0; }
    .seatNo{
      font-size:22px;
      font-weight:900;
      letter-spacing:0.5px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .seatPeople{
      font-size:18px;
      font-weight:900;
      white-space:nowrap;
      color:#ffffff;
      opacity:0.95;
    }
    .seatLines{
      font-size:13px;
      color:rgba(255,255,255,0.92);
      display:flex;
      flex-direction:column;
      gap:3px;
      min-width:0;
    }
    .seatLines .muted{ color:rgba(255,255,255,0.75); }
    .seatMoney{
      font-size:16px;
      font-weight:900;
      margin-top:2px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    /* ===== Bottom Bar (Main only) ===== */
    .bottomBar{
      position:fixed;
      left:0; right:0;
      bottom:0;
      padding-bottom:env(safe-area-inset-bottom);
      height:calc(var(--bottomH) + env(safe-area-inset-bottom));
      background:rgba(11,15,20,0.96);
      border-top:1px solid rgba(255,255,255,0.08);
      z-index:45;
      display:flex;
      align-items:center;
    }
    .bottomInner{
      width:100%;
      max-width:980px;
      margin:0 auto;
      padding:0 12px;
      display:grid;
      grid-template-columns:1fr 1fr 1fr;
      gap:10px;
      align-items:center;
      height:var(--bottomH);
    }
    .bottomBtn{
      border-radius:14px;
      min-height:46px;
      font-weight:900;
      border:1px solid rgba(255,255,255,0.14);
      background:rgba(255,255,255,0.05);
      color:var(--text);
      touch-action:manipulation;
    }
    .bottomBtn.move{
      background:rgba(127,211,107,0.22);
      border-color:rgba(127,211,107,0.45);
    }

    /* ===== Modal ===== */
    .backdrop{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,0.58);
      z-index:80;
      display:none;
      align-items:center;
      justify-content:center;
      padding:12px;
      padding-top:calc(12px + env(safe-area-inset-top));
      padding-bottom:calc(12px + env(safe-area-inset-bottom));
    }
    .backdrop.show{ display:flex; }
    .modal{
      width:min(560px, 100%);
      background:#121a23;
      border:1px solid rgba(255,255,255,0.10);
      border-radius:18px;
      overflow:hidden;
      max-height:calc(100vh - 24px - env(safe-area-inset-top) - env(safe-area-inset-bottom));
      display:flex;
      flex-direction:column;
    }
    .modalHead{
      padding:14px 14px 10px;
      border-bottom:1px solid rgba(255,255,255,0.08);
      font-weight:900;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex:0 0 auto;
    }
    .modalTitleL{ display:flex; align-items:center; gap:10px; min-width:0; }
    .modalSeatId{ font-weight:900; font-size:18px; white-space:nowrap; }
    .modalTitleText{
      font-size:16px; font-weight:900;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    .modalBody{
      padding:14px;
      color:var(--text);
      font-size:15px;
      line-height:1.65;
      overflow:auto;
      -webkit-overflow-scrolling:touch;
      flex:1 1 auto;
      min-height:0;
    }
    .modalActions{
      padding:12px 14px 14px;
      display:flex;
      gap:12px;
      justify-content:flex-end;
      flex-wrap:wrap;
      flex:0 0 auto;
    }
    .bigBtn{
      min-height:48px;
      padding:12px 14px;
      font-weight:900;
      border-radius:14px;
    }
    .backdrop.kbOpen{ align-items:flex-start; }

    /* ===== Range ===== */
    .range{ width:100%; accent-color: var(--accent); }

    /* ===== Toast ===== */
    .toast{
      position:fixed;
      left:50%;
      transform:translateX(-50%);
      bottom:calc(var(--bottomH) + 18px + env(safe-area-inset-bottom));
      background:rgba(0,0,0,0.80);
      border:1px solid rgba(255,255,255,0.12);
      color:#fff;
      padding:10px 12px;
      border-radius:999px;
      font-size:13px;
      z-index:90;
      display:none;
      max-width:min(90vw, 860px);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .toast.show{ display:block; }

    @media (max-width: 360px){
      .seatNo{ font-size:20px; }
      .seatPeople{ font-size:16px; }
      .btn{ padding:9px 12px; }
      .antennaIcon{ font-size:24px; }
    }
  </style>
</head>

<body>
  <!-- ===== Header ===== -->
  <header class="topbar" id="topbar">
    <div class="topbarInner">
      <div class="brandWrap">
        <div class="brand">ONE</div>
        <button class="antennaWrap" id="btnAntenna" aria-label="åŒæœŸçŠ¶æ…‹">
          <span class="antennaIcon">ğŸ“¶</span>
          <span class="antennaX">âŒ</span>
        </button>
      </div>

      <div class="topCenter">
        <button class="btn lime" id="navSecond">ã‚­ãƒƒãƒãƒ³</button>
      </div>

      <div style="min-width:96px; display:flex; justify-content:flex-end">
        <button class="btn lime" id="btnSave">ä¿å­˜</button>
      </div>
    </div>
  </header>

  <main class="app">
    <section class="screen active" id="scrMain">
      <div class="hintText" id="mainHint">ç©ºå¸­ã‚’ã‚¿ãƒƒãƒ—ã§ æ¥åº— / äºˆç´„</div>
      <div style="height:10px"></div>
      <div class="seatGrid" id="seatGrid"></div>
    </section>

    <section class="screen" id="scrKitchen"></section>
    <section class="screen" id="scrSales"></section>
    <section class="screen" id="scrFix"></section>
    <section class="screen" id="scrSeatSetup"></section>
    <section class="screen" id="scrSettings"></section>
    <section class="screen" id="scrMenu"></section>
    <section class="screen" id="scrOrder"></section>
    <!-- PART6/8ã§è¿½åŠ ã•ã‚Œã‚‹ç”»é¢ã¯ append ã•ã‚Œã¾ã™ -->
  </main>

  <div class="bottomBar" id="bottomBar">
    <div class="bottomInner">
      <button class="bottomBtn move" id="goMove">å¸­ç§»å‹•</button>
      <button class="bottomBtn" id="goTodaySales">æœ¬æ—¥ã®å£²ä¸Š</button>
      <button class="bottomBtn" id="goSettings">è¨­å®š</button>
    </div>
  </div>

  <div class="backdrop" id="modalBackdrop" role="dialog" aria-modal="true">
    <div class="modal">
      <div class="modalHead">
        <div class="modalTitleL">
          <div class="modalSeatId" id="modalSeatId" style="display:none"></div>
          <div class="modalTitleText" id="modalTitle"></div>
        </div>
        <button class="btn ghost" id="modalClose">é–‰ã˜ã‚‹</button>
      </div>
      <div class="modalBody" id="modalBody"></div>
      <div class="modalActions" id="modalActions"></div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    /* =========================
      Common / Stateï¼ˆPART1ï¼‰
    ========================= */
    const KEY = "ONE_FREE_FULL_V3";
    const $ = (id)=> document.getElementById(id);

    function nowTs(){ return Date.now(); }
    function pad2(n){ return String(n).padStart(2,"0"); }
    function yen(n){
      const x = Number(n||0);
      return "Â¥" + x.toLocaleString("ja-JP");
    }

    /* ã‚ºãƒ¼ãƒ æŠ‘æ­¢ï¼ˆä¿é™ºï¼‰ */
    (function preventZoom(){
      document.addEventListener("dblclick", (e)=>{ e.preventDefault(); }, {passive:false});
      document.addEventListener("gesturestart", (e)=>{ e.preventDefault(); }, {passive:false});
      document.addEventListener("gesturechange", (e)=>{ e.preventDefault(); }, {passive:false});
      document.addEventListener("gestureend", (e)=>{ e.preventDefault(); }, {passive:false});
    })();

    function toast(msg, ms=1800){
      const t = $("toast");
      t.textContent = msg;
      t.classList.add("show");
      clearTimeout(toast._tm);
      toast._tm = setTimeout(()=> t.classList.remove("show"), ms);
    }

    /* ãƒ¢ãƒ¼ãƒ€ãƒ«èƒŒæ™¯å›ºå®šï¼ˆå…¥åŠ›ã‚ºãƒ¬é˜²æ­¢ï¼‰ */
    function lockBody(){
      const y = window.scrollY;
      document.body.dataset.scrollY = String(y);
      document.body.classList.add("modalLock");
      document.body.style.top = `-${y}px`;
    }
    function unlockBody(){
      const y = Number(document.body.dataset.scrollY || "0");
      document.body.classList.remove("modalLock");
      document.body.style.top = "";
      window.scrollTo(0, y);
    }

    (function modalKeyboardAssist(){
      const bd = $("modalBackdrop");
      document.addEventListener("focusin", (e)=>{
        if(!bd.classList.contains("show")) return;
        const t = e.target;
        if(t && (t.tagName==="INPUT" || t.tagName==="TEXTAREA" || t.tagName==="SELECT")){
          bd.classList.add("kbOpen");
        }
      });
      document.addEventListener("focusout", ()=>{
        if(!$("modalBackdrop").classList.contains("show")) return;
        setTimeout(()=> $("modalBackdrop").classList.remove("kbOpen"), 50);
      });
    })();

    function openModal(title, bodyHtml, actions, seatId=null){
      $("modalTitle").textContent = title || "";
      $("modalBody").innerHTML = bodyHtml || "";

      if(seatId){
        $("modalSeatId").style.display = "block";
        $("modalSeatId").textContent = seatId;
      }else{
        $("modalSeatId").style.display = "none";
        $("modalSeatId").textContent = "";
      }

      const box = $("modalActions");
      box.innerHTML = "";
      (actions||[]).forEach(a=>{
        const b = document.createElement("button");
        b.className = "btn bigBtn" + ((a.lime || a.primary) ? " lime" : "");
        b.textContent = a.label;
        b.onclick = ()=> a.onClick && a.onClick();
        box.appendChild(b);
      });

      $("modalBackdrop").classList.add("show");
      lockBody();
    }
    function closeModal(){
      $("modalBackdrop").classList.remove("show");
      $("modalBackdrop").classList.remove("kbOpen");
      unlockBody();
    }

    $("modalClose").onclick = ()=> closeModal();
    $("modalBackdrop").addEventListener("click", (e)=>{
      if(e.target === $("modalBackdrop")) closeModal();
    });

    /* ===== Screens ===== */
    const screens = ["scrMain","scrKitchen","scrSales","scrFix","scrSeatSetup","scrSettings","scrMenu","scrOrder"];
    function showScreen(id){
      screens.forEach(s=> $(s).classList.toggle("active", s===id));

      if(id==="scrMain") $("navSecond").textContent = "ã‚­ãƒƒãƒãƒ³";
      else if(id==="scrKitchen") $("navSecond").textContent = "ãƒ›ãƒ¼ãƒ«";
      else $("navSecond").textContent = "ãƒ¡ã‚¤ãƒ³";

      $("bottomBar").style.display = (id==="scrMain") ? "flex" : "none";
      window.scrollTo(0,0);
    }

    /* ===== State ===== */
    const state = {
      syncOk: true,
      seats: [],
      order: { seatId:null, subId:null, cat:null, genre:null },
      sales: { list:[], tab:"today", dailyYmd:null },
      kitchen: { showDone:false, showFood:true, showDrink:true, items:[] },
      fix: { targetId:null, draft:null, stage:"edit" },
      seatSetup: null,
      sync: null,
      menu: null,
      store: null,
    };

    function setSync(ok){
      state.syncOk = !!ok;
      $("btnAntenna").classList.toggle("off", !ok);
    }

    /* ===== Seat helpers ===== */
    function seatById(id){ return state.seats.find(s=> s.id===id); }
    function ensureSub(seat, subId){
      seat.sub = seat.sub || {};
      if(!seat.sub[subId]){
        seat.sub[subId] = { seatId: subId, people:0, name:"", total:0, orders:[], orderLog:[], reserve:null };
      }
      return seat.sub[subId];
    }
    function calcSeatTotal(seat){
      if(!seat.merged) return Number(seat.total||0);
      const subs = Object.values(seat.sub||{});
      return subs.reduce((a,b)=> a + Number(b.total||0), 0);
    }
    function calcOrdersTotal(orders){
      return (orders||[]).reduce((sum, o)=> sum + (Number(o.price||0) * Number(o.qty||0)), 0);
    }

    /* ===== åˆæœŸå¸­ï¼ˆç©ºãªã‚‰æœ€ä½é™ï¼‰ ===== */
    function seedSeatsIfEmpty(){
      if(state.seats.length) return;
      state.seats = [
        {id:"A", status:"empty"},
        {id:"B", status:"empty"},
        {id:"C", status:"empty"},
      ].map(s=>({
        id:s.id,
        status:s.status,
        people:0, name:"",
        total:0, bills:0,
        merged:false, mergeLabel:"",
        sub:null, orders:[], orderLog:[],
        reserve:null
      }));
    }

    function renderSeats(){
      const grid = $("seatGrid");
      grid.innerHTML = "";

      state.seats.forEach(seat=>{
        const card = document.createElement("div");
        card.className = "seatCard " + (seat.status==="empty" ? "empty" : seat.status==="reserve" ? "reserve" : "in");
        card.dataset.seatId = seat.id;

        const seatLabel = seat.merged ? (seat.mergeLabel || seat.id) : seat.id;
        const people = (seat.status==="in" || seat.status==="reserve") ? Number(seat.people||0) : 0;

        const bills = Number(seat.bills||0);
        const billsLine = (seat.status==="in" && bills>=2) ? `åˆ¥ä¼šè¨ˆ${bills}ä»¶` : "";

        let nameLine = "";
        if(seat.merged){
          nameLine = `<span style="font-weight:900">${seat.mergeLabel || "â¡ï¸"}</span>`;
        }else if(seat.status==="in" && seat.name){
          nameLine = seat.name;
        }else if(seat.status==="reserve"){
          nameLine = "äºˆç´„";
        }else{
          nameLine = "ç©ºå¸­";
        }

        const money = (seat.status==="in") ? yen(calcSeatTotal(seat)) : "";

        card.innerHTML = `
          <div class="seatTop">
            <div class="seatNoLine">
              <div class="seatNo">${seatLabel}</div>
              <div class="seatPeople">${(seat.status==="in"||seat.status==="reserve") ? `${people}å` : ""}</div>
            </div>
            <div class="seatLines">
              ${billsLine ? `<div class="muted">${billsLine}</div>` : ``}
              <div>${nameLine}</div>
            </div>
          </div>
          <div class="seatMoney">${money}</div>
        `;

        card.onclick = ()=> onSeatTap(seat.id);
        grid.appendChild(card);
      });
    }

    /* å¸­ã‚¿ãƒƒãƒ—ã¯PART2ã§å®Ÿè£…ï¼ˆé–¢æ•°ã¯ä¸Šæ›¸ãã•ã‚Œã‚‹ï¼‰ */
    function onSeatTap(seatId){ toast("èª­ã¿è¾¼ã¿ä¸­â€¦"); }

    /* Header center button */
    $("navSecond").onclick = ()=>{
      const current = screens.find(s=> $(s).classList.contains("active")) || "scrMain";
      if(current==="scrMain") showScreen("scrKitchen");
      else if(current==="scrKitchen") showScreen("scrMain");
      else showScreen("scrMain");
    };

    /* Bottom buttons */
    $("goMove").onclick = ()=> openMoveHome();           // PART2
    $("goTodaySales").onclick = ()=> showScreen("scrSales"); // PART4
    $("goSettings").onclick = ()=> showScreen("scrSettings"); // PART8

    function openMoveHome(){ toast("å¸­ç§»å‹•ï¼ˆPART2ï¼‰"); }

    /* èµ·å‹• */
    (function init(){
      seedSeatsIfEmpty();
      setSync(true);
      renderSeats();
      showScreen("scrMain");
    })();

    /* =========================
      ã“ã“ã‹ã‚‰å…ˆã¯ PART2 ã§ç¶šã
    ========================= */
   /* =========================
  ONE ãƒ¬ã‚¸ã‚¢ãƒ—ãƒªï¼ˆç„¡æ–™ç‰ˆï¼‰å®Œæˆç‰ˆï¼šPART2
  å½¹å‰²ï¼šå¸­ã‚¿ãƒƒãƒ—ï¼ˆæ¥åº—/äºˆç´„ï¼‰/ äººæ•°UIï¼ˆã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ç„¡ã—ï¼‰/ å¸­æ“ä½œ / å¸­ç§»å‹•ï¼ˆã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼ï¼‰/ ä¼šè¨ˆã‚¹ãƒ©ã‚¤ãƒ‰
========================= */

/* ===== LocalStorage ===== */
function saveAll(silent=false){
  try{
    const data = JSON.stringify(state);
    localStorage.setItem(KEY, data);
    setSync(true);
    if(!silent) toast("ä¿å­˜ã—ã¾ã—ãŸ");
  }catch(e){
    setSync(false);
    if(!silent) toast("ä¿å­˜ã§ãã¾ã›ã‚“");
  }
}
function loadAll(){
  try{
    const raw = localStorage.getItem(KEY);
    if(!raw) return false;
    const obj = JSON.parse(raw);

    // å®‰å…¨ã«ãƒãƒ¼ã‚¸
    Object.assign(state, obj||{});
    state.seats = Array.isArray(state.seats) ? state.seats : [];
    state.kitchen = state.kitchen || { showDone:false, showFood:true, showDrink:true, items:[] };
    state.sales   = state.sales   || { list:[], tab:"today", dailyYmd:null };
    state.order   = state.order   || { seatId:null, subId:null, cat:null, genre:null };
    state.fix     = state.fix     || { targetId:null, draft:null, stage:"edit" };

    setSync(true);
    return true;
  }catch(e){
    setSync(false);
    return false;
  }
}

$("btnSave").onclick = ()=> saveAll(false);

/* èµ·å‹•æ™‚ãƒ­ãƒ¼ãƒ‰ï¼ˆseedã‚ˆã‚Šå…ˆã«ï¼‰ */
(function bootLoad(){
  const ok = loadAll();
  if(!ok){
    seedSeatsIfEmpty();
  }else{
    // ä¸‡ä¸€ç©ºãªã‚‰è£œå……
    if(!state.seats.length) seedSeatsIfEmpty();
  }
  renderSeats();
  showScreen("scrMain");
})();

/* ===== â€œã‚¢ãƒ³ãƒ†ãƒŠâŒâ€ã®æš´ç™ºã‚’æ¸›ã‚‰ã™ï¼šé™ã‹ã«åˆ¤å®š =====
   â€»ã‚ªãƒ•ãƒ©ã‚¤ãƒ³æ¤œçŸ¥ã¯å¸¸æ™‚âŒã«ã—ãªã„ï¼ˆèª¤åˆ¤å®šãŒå¤šã„ï¼‰
   ãƒ»ä¿å­˜/åŒæœŸå¤±æ•—æ™‚ã ã‘ âŒ ã‚’å‡ºã™
   ãƒ»ã‚ªãƒ³ãƒ©ã‚¤ãƒ³å¾©å¸°/ä¿å­˜æˆåŠŸã§æ¶ˆã™
*/
window.addEventListener("online", ()=> setSync(true));
window.addEventListener("offline", ()=> {/* ä½•ã‚‚ã—ãªã„ï¼ˆèª¤åˆ¤å®šã®æ¸©åºŠï¼‰ */});

/* ===== People Stepperï¼ˆã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ãªã—ï¼‰ ===== */
function peopleStepperHtml(value=1){
  const v = Math.max(1, Math.min(99, Number(value||1)));
  return `
    <div class="pill" style="justify-content:center; width:100%">
      <button class="btn" id="pDec" style="min-width:56px">â—€ï¸</button>
      <button class="btn" id="pDown" style="min-width:56px">â–¼</button>
      <div style="font-weight:900; font-size:22px; min-width:90px; text-align:center" id="pVal">${v}</div>
      <button class="btn" id="pUp" style="min-width:56px">â–²</button>
      <button class="btn" id="pInc" style="min-width:56px">â–¶ï¸</button>
    </div>
    <div style="height:10px"></div>
    <div style="color:var(--muted); font-size:13px">â€»ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã¯å‡ºã—ã¾ã›ã‚“</div>
  `;
}
function bindPeopleStepper(init=1, onChange){
  let val = Math.max(1, Math.min(99, Number(init||1)));
  const show = ()=> { $("pVal").textContent = String(val); onChange && onChange(val); };
  $("pDec").onclick = ()=> { val = Math.max(1, val-10); show(); };
  $("pDown").onclick= ()=> { val = Math.max(1, val-1); show(); };
  $("pUp").onclick  = ()=> { val = Math.min(99, val+1); show(); };
  $("pInc").onclick = ()=> { val = Math.min(99, val+10); show(); };
  show();
}

/* ===== Seat tap flow ===== */
function onSeatTap(seatId){
  const seat = seatById(seatId);
  if(!seat) return;

  // ç©ºå¸­ï¼šæ¥åº—/äºˆç´„
  if(seat.status==="empty"){
    openModal(
      "ç©ºå¸­",
      `<div style="font-weight:900; font-size:16px; margin-bottom:10px">${seatId}</div>
       <div style="color:var(--muted); font-size:13px; margin-bottom:10px">æ¥åº— or äºˆç´„ ã‚’é¸æŠ</div>`,
      [
        {label:"æ¥åº—", lime:true, onClick:()=> openVisitModal(seatId)},
        {label:"äºˆç´„", onClick:()=> openReserveModal(seatId)},
      ],
      seatId
    );
    return;
  }

  // äºˆç´„ï¼šæ¥åº—ã¸ or è§£é™¤
  if(seat.status==="reserve"){
    openModal(
      "äºˆç´„å¸­",
      `<div style="font-weight:900; font-size:16px; margin-bottom:8px">${seatId}</div>
       <div style="color:rgba(255,255,255,0.9)">äºˆç´„</div>
       <div style="color:var(--muted); font-size:13px; margin-top:6px">æ¥åº—ã«åˆ‡æ›¿ã§ãã¾ã™</div>`,
      [
        {label:"æ¥åº—ã«ã™ã‚‹", lime:true, onClick:()=> openVisitModal(seatId, true)},
        {label:"äºˆç´„è§£é™¤", onClick:()=> { seat.status="empty"; seat.people=0; seat.reserve=null; seat.name=""; seat.total=0; seat.orders=[]; seat.orderLog=[]; seat.bills=0; seat.merged=false; seat.mergeLabel=""; seat.sub=null; closeModal(); renderSeats(); saveAll(true); }},
      ],
      seatId
    );
    return;
  }

  // ç€å¸­ï¼šæ³¨æ–‡ã¸ï¼ˆç„¡æ–™ç‰ˆã¯æœ€çŸ­å°ç·šï¼‰
  if(seat.status==="in"){
    state.order.seatId = seatId;
    closeModal();
    // æ³¨æ–‡ç”»é¢ã¯PART6ã§å®Œæˆã€‚ä»Šã¯ã‚­ãƒƒãƒãƒ³/ä¼šè¨ˆã¸èª˜å°ã€‚
    openModal(
      "ç€å¸­ä¸­",
      `<div style="font-weight:900; font-size:16px; margin-bottom:6px">${seatId}</div>
       <div style="margin-bottom:10px">åˆè¨ˆï¼š<span style="font-weight:900">${yen(calcSeatTotal(seat))}</span></div>
       <div style="color:var(--muted); font-size:13px">ç„¡æ–™ç‰ˆï¼šæ³¨æ–‡ç”»é¢ã¯ã“ã®å¾Œã®PARTã§æœ‰åŠ¹åŒ–</div>`,
      [
        {label:"ä¼šè¨ˆ", lime:true, onClick:()=> openCheckout(seatId)},
        {label:"ã‚­ãƒƒãƒãƒ³", onClick:()=> { closeModal(); showScreen("scrKitchen"); }},
      ],
      seatId
    );
    return;
  }
}

/* ===== æ¥åº— ===== */
function openVisitModal(seatId, fromReserve=false){
  const seat = seatById(seatId);
  if(!seat) return;

  let peopleDraft = Math.max(1, Number(seat.people||1));
  openModal(
    fromReserve ? "æ¥åº—ï¼ˆäºˆç´„ã‹ã‚‰ï¼‰" : "æ¥åº—",
    `<div style="font-weight:900; font-size:16px; margin-bottom:10px">${seatId}</div>
     ${peopleStepperHtml(peopleDraft)}`,
    [
      {label:"ç¢ºå®š", lime:true, onClick:()=> {
        seat.status = "in";
        seat.people = peopleDraft;
        seat.reserve = null;
        // â€œæ¥åº—ã—ãŸã®ã«ç©ºå¸­ã®ã¾ã¾â€å¯¾ç­–ï¼šã“ã“ã§ç¢ºå®Ÿã«inã«ã™ã‚‹
        closeModal();
        renderSeats();
        saveAll(true);
        toast("æ¥åº—ã‚’ç¢ºå®š");
      }},
      {label:"ã‚­ãƒ£ãƒ³ã‚»ãƒ«", onClick:()=> closeModal()},
    ],
    seatId
  );

  bindPeopleStepper(peopleDraft, (v)=> peopleDraft=v);
}

/* ===== äºˆç´„ ===== */
function openReserveModal(seatId){
  const seat = seatById(seatId);
  if(!seat) return;

  let peopleDraft = 2; // äºˆç´„ã¯2ã‚’ä»®ã§ï¼ˆå¾Œã§å¤‰æ›´å¯ï¼‰
  openModal(
    "äºˆç´„",
    `<div style="font-weight:900; font-size:16px; margin-bottom:10px">${seatId}</div>
     ${peopleStepperHtml(peopleDraft)}
     <div style="height:10px"></div>
     <div style="color:var(--muted); font-size:13px">â€»äºˆç´„æ™‚åˆ»å…¥åŠ›ã¯ç„¡æ–™ç‰ˆã§ã¯çœç•¥ï¼ˆå°†æ¥æœ‰æ–™ç‰ˆï¼‰</div>`,
    [
      {label:"ç¢ºå®š", lime:true, onClick:()=> {
        seat.status="reserve";
        seat.people=peopleDraft;
        seat.reserve = { ts: nowTs(), people: peopleDraft };
        seat.total=0; seat.orders=[]; seat.orderLog=[];
        seat.bills=0; seat.merged=false; seat.mergeLabel=""; seat.sub=null;
        closeModal();
        renderSeats();
        saveAll(true);
        toast("äºˆç´„ã‚’ç¢ºå®š");
      }},
      {label:"ã‚­ãƒ£ãƒ³ã‚»ãƒ«", onClick:()=> closeModal()},
    ],
    seatId
  );

  bindPeopleStepper(peopleDraft, (v)=> peopleDraft=v);
}

/* ===== å¸­ç§»å‹•ï¼ˆã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼æ–¹å¼ï¼šã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ç„¡ã—ï¼‰ =====
   ãƒ»ã€Œã©ã“ã‹ã‚‰ / ã©ã“ã¸ã€ã‚’å¸­ä¸€è¦§ã‹ã‚‰é¸æŠ
   ãƒ»æœªä¼šè¨ˆæ³¨æ–‡ãŒã‚ã‚‹å ´åˆã¯ç§»å‹•ã®ã¿ï¼ˆåˆæµã¯PART7ã§æ‹¡å¼µï¼‰
*/
function openMoveHome(){
  const ids = state.seats.map(s=> s.id);

  function optHtml(list){
    return list.map(v=> `<option value="${v}">${v}</option>`).join("");
  }

  // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼šç€å¸­ä¸­ã®å…ˆé ­ã‚’fromã«
  const fromDefault = (state.seats.find(s=> s.status==="in")||state.seats[0]).id;
  const toDefault   = (state.seats.find(s=> s.status==="empty")||state.seats[0]).id;

  openModal(
    "å¸­ç§»å‹•",
    `
      <div style="display:grid; gap:12px">
        <div>
          <div style="color:var(--muted); font-size:13px; margin-bottom:6px">ã©ã“ã‹ã‚‰</div>
          <select class="btn full" id="mvFrom" style="text-align:left">
            ${optHtml(ids)}
          </select>
        </div>
        <div>
          <div style="color:var(--muted); font-size:13px; margin-bottom:6px">ã©ã“ã¸</div>
          <select class="btn full" id="mvTo" style="text-align:left">
            ${optHtml(ids)}
          </select>
        </div>
        <div style="color:var(--muted); font-size:13px">
          â€»ç„¡æ–™ç‰ˆã¯ã€Œç§»å‹•ã€ã®ã¿ï¼ˆåˆæµ/åˆ†å‰²ã¯å¾Œã§ï¼‰
        </div>
      </div>
    `,
    [
      {label:"ç§»å‹•ã™ã‚‹", lime:true, onClick:()=> {
        const from = $("mvFrom").value;
        const to = $("mvTo").value;
        if(from===to){ toast("åŒã˜å¸­ã§ã™"); return; }
        moveSeatData(from, to);
      }},
      {label:"æˆ»ã‚‹", onClick:()=> closeModal()},
    ]
  );

  $("mvFrom").value = fromDefault;
  $("mvTo").value = toDefault;
}

function moveSeatData(fromId, toId){
  const from = seatById(fromId);
  const to = seatById(toId);
  if(!from || !to) return;

  if(from.status!=="in" && from.status!=="reserve"){
    toast("ç§»å‹•å…ƒãŒç©ºå¸­ã§ã™");
    return;
  }
  if(to.status!=="empty"){
    toast("ç§»å‹•å…ˆãŒç©ºå¸­ã§ã¯ã‚ã‚Šã¾ã›ã‚“");
    return;
  }

  // ã¾ã‚‹ã”ã¨ç§»å‹•
  const moved = JSON.parse(JSON.stringify(from));
  // ç§»å‹•å…ˆã®idã«åˆã‚ã›ã‚‹
  moved.id = to.id;

  // fromã‚’ç©ºå¸­åŒ–
  from.status="empty";
  from.people=0; from.name=""; from.total=0; from.bills=0;
  from.orders=[]; from.orderLog=[];
  from.reserve=null;
  from.merged=false; from.mergeLabel=""; from.sub=null;

  // toã¸åæ˜ 
  Object.assign(to, moved);

  closeModal();
  renderSeats();
  saveAll(true);
  toast(`${fromId} â†’ ${toId} ã«ç§»å‹•`);
}

/* ===== ä¼šè¨ˆã‚¹ãƒ©ã‚¤ãƒ‰ï¼ˆæ´ã¿ã‚„ã™ã•ï¼šè¦ªæŒ‡å¹…ï¼‰ ===== */
function openCheckout(seatId){
  const seat = seatById(seatId);
  if(!seat || seat.status!=="in"){
    toast("ä¼šè¨ˆã§ãã¾ã›ã‚“");
    return;
  }

  let method = "ç¾é‡‘";
  let slider = 0;

  openModal(
    "ä¼šè¨ˆ",
    `
      <div style="font-weight:900; font-size:16px; margin-bottom:6px">${seatId}</div>
      <div style="margin-bottom:10px">åˆè¨ˆï¼š<span style="font-weight:900; font-size:18px">${yen(calcSeatTotal(seat))}</span></div>

      <div style="display:flex; gap:10px; margin:12px 0">
        <button class="btn full" id="payCash">ç¾é‡‘</button>
        <button class="btn full" id="payCard">ã‚«ãƒ¼ãƒ‰</button>
        <button class="btn full" id="payQR">QR</button>
      </div>

      <div style="color:var(--muted); font-size:13px; margin:10px 0 6px">å³ã¸ã‚¹ãƒ©ã‚¤ãƒ‰ã—ã¦ä¼šè¨ˆç¢ºå®š</div>
      <input type="range" min="0" max="100" value="0" class="range" id="chkRange" style="height:44px">
      <div style="display:flex; justify-content:space-between; font-size:12px; color:var(--muted); margin-top:4px">
        <span>0%</span><span id="chkPct">0%</span><span>100%</span>
      </div>
      <div style="height:10px"></div>
      <div style="color:var(--muted); font-size:13px">
        â€»æ´ã¿ã‚„ã™ã•å„ªå…ˆï¼šã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã‚’å¤ªããƒ»é•·ã•ã¯ã“ã®æ å†…ã§å›ºå®š
      </div>
    `,
    [
      {label:"ã‚­ãƒ£ãƒ³ã‚»ãƒ«", onClick:()=> closeModal()},
    ],
    seatId
  );

  function setPayUI(){
    const map = { "ç¾é‡‘":"payCash", "ã‚«ãƒ¼ãƒ‰":"payCard", "QR":"payQR" };
    Object.entries(map).forEach(([k,id])=>{
      const b = $(id);
      const on = (k===method);
      b.style.background = on ? "rgba(127,211,107,0.28)" : "rgba(255,255,255,0.06)";
      b.style.borderColor = on ? "rgba(127,211,107,0.55)" : "rgba(255,255,255,0.14)";
      b.style.fontWeight = on ? "900" : "700";
    });
  }
  $("payCash").onclick = ()=> { method="ç¾é‡‘"; setPayUI(); };
  $("payCard").onclick = ()=> { method="ã‚«ãƒ¼ãƒ‰"; setPayUI(); };
  $("payQR").onclick   = ()=> { method="QR"; setPayUI(); };
  setPayUI();

  const r = $("chkRange");
  const pct = $("chkPct");
  r.oninput = ()=>{
    slider = Number(r.value||0);
    pct.textContent = `${slider}%`;
  };
  r.onchange = ()=>{
    slider = Number(r.value||0);
    if(slider>=95){
      // ç¢ºå®š
      finalizeCheckout(seatId, method);
    }else{
      // æˆ»ã™
      r.value = 0; slider=0; pct.textContent="0%";
    }
  };
}

function finalizeCheckout(seatId, method){
  const seat = seatById(seatId);
  if(!seat) return;

  // å£²ä¸Šã¯PART4ã§é›†è¨ˆã€‚ã“ã“ã§ã¯æœ€ä½é™ãƒ­ã‚°ã ã‘ç©ã‚€
  state.sales = state.sales || { list:[], tab:"today", dailyYmd:null };
  state.sales.list = state.sales.list || [];
  state.sales.list.push({
    ts: nowTs(),
    seatId,
    method,
    people: Number(seat.people||0),
    total: Number(calcSeatTotal(seat)||0),
    note: ""
  });

  // ä¼šè¨ˆå¾Œã¯è‡ªå‹•ç©ºå¸­
  seat.status="empty";
  seat.people=0; seat.name=""; seat.total=0; seat.bills=0;
  seat.orders=[]; seat.orderLog=[];
  seat.reserve=null;
  seat.merged=false; seat.mergeLabel=""; seat.sub=null;

  closeModal();
  renderSeats();
  saveAll(true);
  toast("ä¼šè¨ˆã‚’ç¢ºå®šã—ã¾ã—ãŸ");
}

/* =========================
  ã“ã“ã‹ã‚‰å…ˆã¯ PART3 ã§ç¶šã
========================= */
/* =========================
  ONE ãƒ¬ã‚¸ã‚¢ãƒ—ãƒªï¼ˆç„¡æ–™ç‰ˆï¼‰å®Œæˆç‰ˆï¼šPART3
  å½¹å‰²ï¼šã‚­ãƒƒãƒãƒ³ç”»é¢ï¼ˆæä¾›æ¸ˆãƒˆã‚°ãƒ«ç‚¹ç¯/æ–‡è¨€çŸ­ç¸®ï¼‰/ ã‚­ãƒƒãƒãƒ³ãƒ‡ãƒ¼ã‚¿ã®æœ€ä½é™ç®¡ç†
========================= */

/* ===== Kitchen Screen DOMï¼ˆæœ€å°ï¼‰ ===== */
(function buildKitchenScreen(){
  const el = $("scrKitchen");
  if(!el) return;

  el.innerHTML = `
    <div style="display:flex; align-items:center; justify-content:space-between; gap:10px">
      <div style="font-weight:900; font-size:18px">ã‚­ãƒƒãƒãƒ³</div>
      <button class="btn" id="kToMain">ãƒ¡ã‚¤ãƒ³</button>
    </div>
    <div style="height:10px"></div>

    <div style="display:flex; gap:10px; flex-wrap:wrap">
      <button class="btn" id="kToggleDone">æä¾›æ¸ˆ</button>
      <button class="btn" id="kToggleFood">æ–™ç†</button>
      <button class="btn" id="kToggleDrink">ãƒ‰ãƒªãƒ³ã‚¯</button>
    </div>

    <div style="height:12px"></div>
    <div id="kList" style="display:grid; gap:10px"></div>

    <div style="height:12px"></div>
    <div style="color:var(--muted); font-size:13px">
      â€»ç„¡æ–™ç‰ˆï¼šæ³¨æ–‡ã®æŠ•å…¥ã¯ã“ã®å¾Œã®PARTã§æœ‰åŠ¹åŒ–ã—ã¾ã™ï¼ˆä»Šã¯è¦‹ãŸç›®ã¨æä¾›æ¸ˆãƒˆã‚°ãƒ«ã ã‘å…ˆã«å®Œæˆï¼‰
    </div>
  `;

  $("kToMain").onclick = ()=> showScreen("scrMain");
})();

function kBtnActive(btn, on){
  btn.style.background = on ? "rgba(127,211,107,0.28)" : "rgba(255,255,255,0.06)";
  btn.style.borderColor = on ? "rgba(127,211,107,0.55)" : "rgba(255,255,255,0.14)";
  btn.style.fontWeight = on ? "900" : "700";
}

/* ===== Kitchen State ===== */
function ensureKitchen(){
  state.kitchen = state.kitchen || {};
  state.kitchen.items = Array.isArray(state.kitchen.items) ? state.kitchen.items : [];
  state.kitchen.showDone = !!state.kitchen.showDone;   // true=æä¾›æ¸ˆã‚‚è¡¨ç¤ºï¼ˆãƒœã‚¿ãƒ³ç‚¹ç¯ï¼‰
  state.kitchen.showFood = (state.kitchen.showFood!==false);
  state.kitchen.showDrink = (state.kitchen.showDrink!==false);
}

function renderKitchen(){
  ensureKitchen();
  const box = $("kList");
  if(!box) return;

  const btnDone = $("kToggleDone");
  const btnFood = $("kToggleFood");
  const btnDrink = $("kToggleDrink");
  if(btnDone){
    // ã€Œæä¾›æ¸ˆã€ONã®ã¨ãç‚¹ç¯ / OFFã®ã¨ãéç‚¹ç¯ï¼ˆä»•æ§˜ï¼‰
    kBtnActive(btnDone, state.kitchen.showDone);
  }
  if(btnFood)  kBtnActive(btnFood, state.kitchen.showFood);
  if(btnDrink) kBtnActive(btnDrink, state.kitchen.showDrink);

  const list = state.kitchen.items.slice();

  const filtered = list.filter(it=>{
    if(!state.kitchen.showDone && it.done) return false;
    if(it.type==="food" && !state.kitchen.showFood) return false;
    if(it.type==="drink" && !state.kitchen.showDrink) return false;
    return true;
  });

  box.innerHTML = "";

  if(!filtered.length){
    box.innerHTML = `<div style="color:var(--muted); font-size:14px; padding:12px; border:1px dashed rgba(255,255,255,0.14); border-radius:14px">
      è¡¨ç¤ºã™ã‚‹æ³¨æ–‡ãŒã‚ã‚Šã¾ã›ã‚“
    </div>`;
    return;
  }

  filtered.forEach(it=>{
    const row = document.createElement("div");
    row.style.border = "1px solid rgba(255,255,255,0.10)";
    row.style.borderRadius = "14px";
    row.style.background = "rgba(255,255,255,0.04)";
    row.style.padding = "12px";
    row.style.display = "grid";
    row.style.gap = "6px";

    const title = `${it.name || "ï¼ˆæœªè¨­å®šï¼‰"} Ã—${Number(it.qty||1)}`;
    const sub = `${it.seatId || ""}${it.seatId ? " / " : ""}${it.type==="drink" ? "ãƒ‰ãƒªãƒ³ã‚¯" : "æ–™ç†"}`;

    row.innerHTML = `
      <div style="display:flex; align-items:center; justify-content:space-between; gap:10px">
        <div style="min-width:0">
          <div style="font-weight:900; white-space:nowrap; overflow:hidden; text-overflow:ellipsis">${title}</div>
          <div style="color:var(--muted); font-size:12px">${sub}</div>
        </div>
        <button class="btn" style="min-width:92px" data-kid="${it.id}">
          ${it.done ? "æˆ»ã™" : "æä¾›æ¸ˆ"}
        </button>
      </div>
    `;

    const b = row.querySelector("button");
    b.onclick = ()=>{
      it.done = !it.done;
      saveAll(true);
      renderKitchen();
    };

    box.appendChild(row);
  });
}

/* ãƒœã‚¿ãƒ³å‹•ä½œ */
(function bindKitchenButtons(){
  const bd = $("scrKitchen");
  if(!bd) return;

  const done = $("kToggleDone");
  const food = $("kToggleFood");
  const drink = $("kToggleDrink");

  if(done) done.onclick = ()=>{
    ensureKitchen();
    state.kitchen.showDone = !state.kitchen.showDone;
    saveAll(true);
    renderKitchen();
  };
  if(food) food.onclick = ()=>{
    ensureKitchen();
    state.kitchen.showFood = !state.kitchen.showFood;
    saveAll(true);
    renderKitchen();
  };
  if(drink) drink.onclick = ()=>{
    ensureKitchen();
    state.kitchen.showDrink = !state.kitchen.showDrink;
    saveAll(true);
    renderKitchen();
  };
})();

/* ç”»é¢åˆ‡æ›¿æ™‚ã«ãƒ¬ãƒ³ãƒ€ */
(function hookKitchenRender(){
  const _show = showScreen;
  showScreen = function(id){
    _show(id);
    if(id==="scrKitchen") renderKitchen();
  };
})();

/* =========================
  ã“ã“ã‹ã‚‰å…ˆã¯ PART4 ã§ç¶šã
========================= */
/* =========================
  ONE ãƒ¬ã‚¸ã‚¢ãƒ—ãƒªï¼ˆç„¡æ–™ç‰ˆï¼‰å®Œæˆç‰ˆï¼šPART4
  å½¹å‰²ï¼šå£²ä¸Šï¼ˆæœ¬æ—¥ï¼æœˆï¼å¹´ï¼‰ï¼‹è¨‚æ­£ä¼ç¥¨ï¼ˆå‰Šé™¤ã§ã¯ãªãè¿½åŠ ï¼‰ï¼‹CSVå‡ºåŠ›
========================= */

/* ===== Sales State ===== */
function ensureSales(){
  state.sales = state.sales || {};
  state.sales.list = Array.isArray(state.sales.list) ? state.sales.list : [];
  // è¨‚æ­£ç†ç”±ã®å®šå‹ï¼ˆï¼‹è‡ªç”±å…¥åŠ›ï¼‰
  state.sales.reasonPresets = state.sales.reasonPresets || [
    "é‡‘é¡å…¥åŠ›ãƒŸã‚¹","ãƒ¡ãƒ‹ãƒ¥ãƒ¼é¸æŠãƒŸã‚¹","å‰²å¼•é©ç”¨æ¼ã‚Œ","å‰²å¼•é©ç”¨éå¤š","äºŒé‡ä¼šè¨ˆ","ãã®ä»–"
  ];
}
function genId(prefix="id"){
  return prefix + "_" + Math.random().toString(16).slice(2) + "_" + Date.now().toString(16);
}
function ymdKey(ts){
  const d = new Date(ts);
  return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
}
function ymKey(ts){
  const d = new Date(ts);
  return `${d.getFullYear()}-${pad2(d.getMonth()+1)}`;
}
function yKey(ts){
  const d = new Date(ts);
  return `${d.getFullYear()}`;
}
function sum(nums){
  return nums.reduce((a,b)=> a + (Number(b)||0), 0);
}
function salesNetTotalForYmd(ymd){
  ensureSales();
  const xs = state.sales.list.filter(x=> ymdKey(x.ts)===ymd);
  // type: "sale" ã¯ +totalã€"fix" ã¯ deltaï¼ˆÂ±ï¼‰
  return sum(xs.map(x=>{
    if(x.type==="sale") return Number(x.total||0);
    if(x.type==="fix")  return Number(x.delta||0);
    return 0;
  }));
}

/* ===== Sales Entry Add (ä¼šè¨ˆç¢ºå®šæ™‚ã«å‘¼ã°ã‚Œã‚‹) ===== */
function addSaleEntry({ts, seatId, method, people, total}){
  ensureSales();
  state.sales.list.push({
    id: genId("sale"),
    type: "sale",
    ts: ts || nowTs(),
    seatId: seatId || "",
    method: method || "ç¾é‡‘",
    people: Number(people||0),
    total: Number(total||0),
    note: ""
  });
}

/* finalizeCheckout ã‚’ä¸Šæ›¸ãï¼ˆPART2ã®æœ€ä½ãƒ­ã‚°â†’æ­£å¼ãƒ­ã‚°ã¸ï¼‰ */
(function patchFinalizeCheckout(){
  const old = finalizeCheckout;
  finalizeCheckout = function(seatId, method){
    const seat = seatById(seatId);
    if(!seat) return;

    const total = Number(calcSeatTotal(seat)||0);
    addSaleEntry({
      ts: nowTs(),
      seatId,
      method,
      people: Number(seat.people||0),
      total
    });

    // ä¼šè¨ˆå¾Œã¯è‡ªå‹•ç©ºå¸­
    seat.status="empty";
    seat.people=0; seat.name=""; seat.total=0; seat.bills=0;
    seat.orders=[]; seat.orderLog=[];
    seat.reserve=null;
    seat.merged=false; seat.mergeLabel=""; seat.sub=null;

    closeModal();
    renderSeats();
    saveAll(true);
    toast("ä¼šè¨ˆã‚’ç¢ºå®šã—ã¾ã—ãŸ");
  };
})();

/* ===== Screens: Sales ===== */
(function buildSalesScreens(){
  // scrSalesï¼ˆãƒãƒ–ï¼‰
  if($("scrSales")){
    $("scrSales").innerHTML = `
      <div style="display:flex; align-items:center; justify-content:space-between; gap:10px">
        <div style="font-weight:900; font-size:18px">å£²ä¸Š</div>
        <button class="btn" id="salesToMain">ãƒ¡ã‚¤ãƒ³</button>
      </div>
      <div style="height:10px"></div>

      <div style="display:grid; gap:10px">
        <button class="btn full" id="goTodaySales">æœ¬æ—¥ã®å£²ä¸Š</button>
        <button class="btn full" id="goMonthSales">æœˆå£²ä¸Š</button>
        <button class="btn full" id="goYearSales">å¹´é–“å£²ä¸Š</button>
        <button class="btn full" id="goSalesManage">å£²ä¸Šç®¡ç†</button>
      </div>

      <div style="height:14px"></div>
      <div style="color:var(--muted); font-size:13px">
        â€»å‰Šé™¤ã¯ã—ã¾ã›ã‚“ã€‚é–“é•ã„ã¯ã€Œè¨‚æ­£ä¼ç¥¨ã€ã‚’è¿½åŠ ã—ã¦å¸³å°»ã‚’åˆã‚ã›ã¾ã™ã€‚
      </div>
    `;
  }

  // scrTodaySales
  if($("scrTodaySales")){
    $("scrTodaySales").innerHTML = `
      <div style="display:flex; align-items:center; justify-content:space-between; gap:10px">
        <div style="font-weight:900; font-size:18px">æœ¬æ—¥ã®å£²ä¸Š</div>
        <button class="btn" id="todayToSales">æˆ»ã‚‹</button>
      </div>
      <div style="height:10px"></div>
      <div class="pill" style="justify-content:space-between">
        <div style="color:var(--muted); font-size:12px">åˆè¨ˆï¼ˆè¨‚æ­£åæ˜ å¾Œï¼‰</div>
        <div style="font-weight:900; font-size:18px" id="todayTotal">0å††</div>
      </div>
      <div style="height:10px"></div>
      <div id="todaySalesList" style="display:grid; gap:10px"></div>
    `;
  }

  // scrMonth
  if($("scrMonth")){
    $("scrMonth").innerHTML = `
      <div style="display:flex; align-items:center; justify-content:space-between; gap:10px">
        <div style="font-weight:900; font-size:18px">æœˆå£²ä¸Š</div>
        <button class="btn" id="monthToSales">æˆ»ã‚‹</button>
      </div>
      <div style="height:10px"></div>
      <div id="monthList" style="display:grid; gap:10px"></div>
    `;
  }

  // scrYear
  if($("scrYear")){
    $("scrYear").innerHTML = `
      <div style="display:flex; align-items:center; justify-content:space-between; gap:10px">
        <div style="font-weight:900; font-size:18px">å¹´é–“å£²ä¸Š</div>
        <button class="btn" id="yearToSales">æˆ»ã‚‹</button>
      </div>
      <div style="height:10px"></div>
      <div id="yearList" style="display:grid; gap:10px"></div>
    `;
  }

  // scrSalesManage
  if($("scrSalesManage")){
    $("scrSalesManage").innerHTML = `
      <div style="display:flex; align-items:center; justify-content:space-between; gap:10px">
        <div style="font-weight:900; font-size:18px">å£²ä¸Šç®¡ç†</div>
        <button class="btn" id="manageToSales">æˆ»ã‚‹</button>
      </div>
      <div style="height:10px"></div>

      <div class="pill" style="justify-content:space-between">
        <div style="color:var(--muted); font-size:12px">å¯¾è±¡æ—¥</div>
        <div style="font-weight:900" id="manageYmd">-</div>
      </div>

      <div style="height:10px"></div>
      <button class="btn full" id="btnExportCsv">CSVå‡ºåŠ›ï¼ˆæœ¬æ—¥ï¼‰</button>
      <div style="height:10px"></div>

      <div style="color:var(--muted); font-size:13px; margin:8px 0 6px">
        â€»è¨‚æ­£ã—ãŸã„ä¼ç¥¨ã‚’ã‚¿ãƒƒãƒ— â†’ è¨‚æ­£ä¼ç¥¨ã‚’è¿½åŠ 
      </div>
      <div id="manageList" style="display:grid; gap:10px"></div>
    `;
  }

  // bind nav
  if($("salesToMain")) $("salesToMain").onclick = ()=> showScreen("scrMain");
  if($("goTodaySales")) $("goTodaySales").onclick = ()=> { showScreen("scrTodaySales"); renderTodaySales(); };
  if($("goMonthSales")) $("goMonthSales").onclick = ()=> { showScreen("scrMonth"); renderMonthSales(); };
  if($("goYearSales")) $("goYearSales").onclick = ()=> { showScreen("scrYear"); renderYearSales(); };
  if($("goSalesManage")) $("goSalesManage").onclick = ()=> { showScreen("scrSalesManage"); renderSalesManage(); };

  if($("todayToSales")) $("todayToSales").onclick = ()=> showScreen("scrSales");
  if($("monthToSales")) $("monthToSales").onclick = ()=> showScreen("scrSales");
  if($("yearToSales")) $("yearToSales").onclick = ()=> showScreen("scrSales");
  if($("manageToSales")) $("manageToSales").onclick = ()=> showScreen("scrSales");

  if($("btnExportCsv")) $("btnExportCsv").onclick = ()=> exportTodayCsv();
})();

/* ===== Render: Today ===== */
function renderTodaySales(){
  ensureSales();
  const listBox = $("todaySalesList");
  if(!listBox) return;

  const today = ymdKey(nowTs());
  const total = salesNetTotalForYmd(today);
  if($("todayTotal")) $("todayTotal").textContent = yen(total);

  const xs = state.sales.list
    .filter(x=> ymdKey(x.ts)===today)
    .sort((a,b)=> Number(b.ts||0) - Number(a.ts||0));

  listBox.innerHTML = "";
  if(!xs.length){
    listBox.innerHTML = `<div style="color:var(--muted); padding:12px; border:1px dashed rgba(255,255,255,0.14); border-radius:14px">
      ã¾ã å£²ä¸ŠãŒã‚ã‚Šã¾ã›ã‚“
    </div>`;
    return;
  }

  xs.forEach(x=>{
    const row = document.createElement("div");
    row.style.border = "1px solid rgba(255,255,255,0.10)";
    row.style.borderRadius = "14px";
    row.style.background = "rgba(255,255,255,0.04)";
    row.style.padding = "12px";
    row.style.display = "grid";
    row.style.gap = "6px";

    const t = new Date(x.ts);
    const hh = pad2(t.getHours()), mm = pad2(t.getMinutes());
    const label = x.type==="sale" ? "ä¼šè¨ˆ" : "è¨‚æ­£";
    const amt = x.type==="sale" ? Number(x.total||0) : Number(x.delta||0);
    const amtStr = (amt>=0? "" : "âˆ’") + yen(Math.abs(amt));
    const sub = x.type==="sale"
      ? `${x.seatId||""}${x.seatId?" / ":""}${x.method||""}${x.people?` / ${x.people}å`: ""}`
      : `å‚ç…§: ${x.refId||"-"} / ${x.reason||""}${x.free?`ï¼ˆ${x.free}ï¼‰`:""}`;

    row.innerHTML = `
      <div style="display:flex; align-items:center; justify-content:space-between; gap:10px">
        <div style="min-width:0">
          <div style="font-weight:900; white-space:nowrap; overflow:hidden; text-overflow:ellipsis">
            ${hh}:${mm} / ${label}
          </div>
          <div style="color:var(--muted); font-size:12px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis">${sub}</div>
        </div>
        <div style="font-weight:900">${amtStr}</div>
      </div>
    `;
    listBox.appendChild(row);
  });
}

/* ===== Render: Month ===== */
function renderMonthSales(){
  ensureSales();
  const box = $("monthList");
  if(!box) return;

  const groups = {};
  state.sales.list.forEach(x=>{
    const k = ymKey(x.ts);
    groups[k] = groups[k] || [];
    groups[k].push(x);
  });

  const keys = Object.keys(groups).sort((a,b)=> (a<b?1:-1));
  box.innerHTML = "";
  if(!keys.length){
    box.innerHTML = `<div style="color:var(--muted); padding:12px; border:1px dashed rgba(255,255,255,0.14); border-radius:14px">
      ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“
    </div>`;
    return;
  }

  keys.forEach(k=>{
    const xs = groups[k];
    const total = sum(xs.map(x=>{
      if(x.type==="sale") return Number(x.total||0);
      if(x.type==="fix")  return Number(x.delta||0);
      return 0;
    }));
    const card = document.createElement("div");
    card.style.border = "1px solid rgba(255,255,255,0.10)";
    card.style.borderRadius = "14px";
    card.style.background = "rgba(255,255,255,0.04)";
    card.style.padding = "12px";
    card.style.display = "flex";
    card.style.alignItems = "center";
    card.style.justifyContent = "space-between";
    card.innerHTML = `<div style="font-weight:900">${k}</div><div style="font-weight:900">${yen(total)}</div>`;
    box.appendChild(card);
  });
}

/* ===== Render: Year ===== */
function renderYearSales(){
  ensureSales();
  const box = $("yearList");
  if(!box) return;

  const groups = {};
  state.sales.list.forEach(x=>{
    const k = yKey(x.ts);
    groups[k] = groups[k] || [];
    groups[k].push(x);
  });

  const keys = Object.keys(groups).sort((a,b)=> (a<b?1:-1));
  box.innerHTML = "";
  if(!keys.length){
    box.innerHTML = `<div style="color:var(--muted); padding:12px; border:1px dashed rgba(255,255,255,0.14); border-radius:14px">
      ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“
    </div>`;
    return;
  }

  keys.forEach(k=>{
    const xs = groups[k];
    const total = sum(xs.map(x=>{
      if(x.type==="sale") return Number(x.total||0);
      if(x.type==="fix")  return Number(x.delta||0);
      return 0;
    }));
    const card = document.createElement("div");
    card.style.border = "1px solid rgba(255,255,255,0.10)";
    card.style.borderRadius = "14px";
    card.style.background = "rgba(255,255,255,0.04)";
    card.style.padding = "12px";
    card.style.display = "flex";
    card.style.alignItems = "center";
    card.style.justifyContent = "space-between";
    card.innerHTML = `<div style="font-weight:900">${k}å¹´</div><div style="font-weight:900">${yen(total)}</div>`;
    box.appendChild(card);
  });
}

/* ===== Manage (Today list with correction) ===== */
function renderSalesManage(){
  ensureSales();
  const today = ymdKey(nowTs());
  if($("manageYmd")) $("manageYmd").textContent = today;

  const box = $("manageList");
  if(!box) return;

  const xs = state.sales.list
    .filter(x=> ymdKey(x.ts)===today)
    .sort((a,b)=> Number(b.ts||0) - Number(a.ts||0));

  box.innerHTML = "";
  if(!xs.length){
    box.innerHTML = `<div style="color:var(--muted); padding:12px; border:1px dashed rgba(255,255,255,0.14); border-radius:14px">
      æœ¬æ—¥ã®ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“
    </div>`;
    return;
  }

  xs.forEach(x=>{
    const row = document.createElement("div");
    row.style.border = "1px solid rgba(255,255,255,0.10)";
    row.style.borderRadius = "14px";
    row.style.background = "rgba(255,255,255,0.04)";
    row.style.padding = "12px";
    row.style.display = "grid";
    row.style.gap = "6px";

    const t = new Date(x.ts);
    const hh = pad2(t.getHours()), mm = pad2(t.getMinutes());
    const label = x.type==="sale" ? "ä¼šè¨ˆ" : "è¨‚æ­£";
    const amt = x.type==="sale" ? Number(x.total||0) : Number(x.delta||0);
    const amtStr = (amt>=0? "" : "âˆ’") + yen(Math.abs(amt));
    const sub = x.type==="sale"
      ? `${x.seatId||""}${x.seatId?" / ":""}${x.method||""}${x.people?` / ${x.people}å`: ""}`
      : `å‚ç…§: ${x.refId||"-"} / ${x.reason||""}${x.free?`ï¼ˆ${x.free}ï¼‰`:""}`;

    row.innerHTML = `
      <div style="display:flex; align-items:center; justify-content:space-between; gap:10px">
        <div style="min-width:0">
          <div style="font-weight:900; white-space:nowrap; overflow:hidden; text-overflow:ellipsis">
            ${hh}:${mm} / ${label}
          </div>
          <div style="color:var(--muted); font-size:12px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis">${sub}</div>
        </div>
        <div style="font-weight:900">${amtStr}</div>
      </div>
      ${x.type==="sale"
        ? `<button class="btn full" data-fix="${x.id}">ã“ã®ä¼ç¥¨ã‚’è¨‚æ­£</button>`
        : `<div style="color:var(--muted); font-size:12px">â€»è¨‚æ­£ä¼ç¥¨ã¯ã•ã‚‰ã«è¨‚æ­£ã§ãã¾ã™ï¼ˆå¿…è¦ãªã‚‰ï¼‰</div>`
      }
    `;

    const b = row.querySelector("button[data-fix]");
    if(b){
      b.onclick = ()=> openFixModal(x.id);
    }
    box.appendChild(row);
  });
}

/* ===== Fix Modal ===== */
function openFixModal(refId){
  ensureSales();
  const ref = state.sales.list.find(x=> x.id===refId);
  if(!ref){ toast("å‚ç…§ä¼ç¥¨ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"); return; }
  if(ref.type!=="sale"){ toast("ä¼šè¨ˆä¼ç¥¨ã‚’é¸ã‚“ã§ãã ã•ã„"); return; }

  let chosen = state.sales.reasonPresets[0] || "ãã®ä»–";
  let free = "";

  // é‡‘é¡å·®åˆ†ã¯â€œãƒœã‚¿ãƒ³â€ã§ï¼ˆã‚­ãƒ¼ãƒœãƒ¼ãƒ‰æŠ‘åˆ¶ï¼‰
  // ä¾‹ï¼š-500 / -100 / -50 / +50 / +100 / +500 / å…¨é¡å–æ¶ˆ
  let delta = 0;

  const presetBtns = state.sales.reasonPresets.map(r=> `<button class="btn" data-reason="${esc(r)}">${esc(r)}</button>`).join("");

  openModal(
    "è¨‚æ­£ä¼ç¥¨",
    `
      <div style="font-weight:900; margin-bottom:6px">å‚ç…§ï¼š${ref.id}</div>
      <div style="color:var(--muted); font-size:12px; margin-bottom:10px">
        å…ƒã®é‡‘é¡ï¼š${yen(ref.total)} / ${ref.method||""} / ${ref.seatId||""}
      </div>

      <div style="color:var(--muted); font-size:13px; margin-bottom:6px">è¨‚æ­£ç†ç”±</div>
      <div style="display:flex; gap:8px; flex-wrap:wrap; margin-bottom:10px" id="fixReasons">
        ${presetBtns}
      </div>
      <div class="pill" style="justify-content:space-between">
        <div style="color:var(--muted); font-size:12px">é¸æŠä¸­</div>
        <div style="font-weight:900" id="fixChosen">${esc(chosen)}</div>
      </div>

      <div style="height:12px"></div>
      <div style="color:var(--muted); font-size:13px; margin-bottom:6px">è¨‚æ­£é‡‘é¡ï¼ˆå·®åˆ†ï¼‰</div>
      <div style="display:grid; gap:8px">
        <div style="display:flex; gap:8px; flex-wrap:wrap">
          <button class="btn" id="dNeg500">-500</button>
          <button class="btn" id="dNeg100">-100</button>
          <button class="btn" id="dNeg50">-50</button>
          <button class="btn" id="dPos50">+50</button>
          <button class="btn" id="dPos100">+100</button>
          <button class="btn" id="dPos500">+500</button>
        </div>
        <button class="btn full" id="dCancelAll  ">å…¨é¡å–æ¶ˆï¼ˆ-å…ƒé‡‘é¡ï¼‰</button>
        <button class="btn full" id="dReset">å·®åˆ†ã‚’0ã«æˆ»ã™</button>
        <div class="pill" style="justify-content:space-between">
          <div style="color:var(--muted); font-size:12px">å·®åˆ†</div>
          <div style="font-weight:900; font-size:18px" id="dShow">0å††</div>
        </div>
      </div>

      <div style="height:12px"></div>
      <div style="color:var(--muted); font-size:13px; margin-bottom:6px">è‡ªç”±å…¥åŠ›ï¼ˆä»»æ„ï¼‰</div>
      <input class="input" id="fixFree" placeholder="ä¾‹ï¼šç¾é‡‘200å††ä¸è¶³" inputmode="text" autocomplete="off">
      <div style="height:6px"></div>
      <div style="color:var(--muted); font-size:12px">â€»ä»»æ„ã€‚å¿…è¦ãªæ™‚ã ã‘ä½¿ã£ã¦OK</div>
    `,
    [
      {label:"è¨‚æ­£ã‚’è¿½åŠ ", lime:true, onClick:()=> {
        free = ($("fixFree")?.value||"").trim();
        if(delta===0){
          toast("å·®åˆ†ãŒ0ã§ã™ï¼ˆè¨‚æ­£ä¸è¦ï¼‰");
          return;
        }
        ensureSales();
        state.sales.list.push({
          id: genId("fix"),
          type: "fix",
          ts: nowTs(),
          refId: ref.id,
          reason: chosen,
          free,
          delta: Number(delta)
        });
        closeModal();
        saveAll(true);
        renderTodaySales();
        renderSalesManage();
        toast("è¨‚æ­£ä¼ç¥¨ã‚’è¿½åŠ ã—ã¾ã—ãŸ");
      }},
      {label:"ã‚­ãƒ£ãƒ³ã‚»ãƒ«", onClick:()=> closeModal()}
    ]
  );

  // bind reasons
  const wrap = $("fixReasons");
  if(wrap){
    wrap.querySelectorAll("button[data-reason]").forEach(b=>{
      b.onclick = ()=>{
        chosen = b.getAttribute("data-reason");
        if($("fixChosen")) $("fixChosen").textContent = chosen;
      };
    });
  }

  const showDelta = ()=>{
    if($("dShow")) $("dShow").textContent = (delta>=0? "" : "âˆ’") + yen(Math.abs(delta));
  };
  const addD = (v)=>{ delta = Number(delta||0) + Number(v||0); showDelta(); };

  $("dNeg500").onclick = ()=> addD(-500);
  $("dNeg100").onclick = ()=> addD(-100);
  $("dNeg50").onclick  = ()=> addD(-50);
  $("dPos50").onclick  = ()=> addD(50);
  $("dPos100").onclick = ()=> addD(100);
  $("dPos500").onclick = ()=> addD(500);
  $("dCancelAll  ").onclick = ()=> { delta = -Number(ref.total||0); showDelta(); };
  $("dReset").onclick = ()=> { delta = 0; showDelta(); };

  showDelta();
}

/* ===== CSV Export (today) ===== */
function exportTodayCsv(){
  ensureSales();
  const today = ymdKey(nowTs());
  const xs = state.sales.list
    .filter(x=> ymdKey(x.ts)===today)
    .sort((a,b)=> Number(a.ts||0)-Number(b.ts||0));

  // CSV columns
  const rows = [];
  rows.push(["type","id","ts","seatId","method","people","total","refId","reason","free","delta"].join(","));

  xs.forEach(x=>{
    const ts = new Date(x.ts);
    const iso = ts.toISOString();
    rows.push([
      csvCell(x.type||""),
      csvCell(x.id||""),
      csvCell(iso),
      csvCell(x.seatId||""),
      csvCell(x.method||""),
      csvCell(x.people!=null? String(x.people):""),
      csvCell(x.total!=null? String(x.total):""),
      csvCell(x.refId||""),
      csvCell(x.reason||""),
      csvCell(x.free||""),
      csvCell(x.delta!=null? String(x.delta):"")
    ].join(","));
  });

  const csv = rows.join("\n");
  downloadTextFile(`sales_${today}.csv`, csv);
  toast("CSVã‚’ä½œæˆã—ã¾ã—ãŸ");
}

function csvCell(s){
  const t = String(s??"");
  const need = /[,"\n]/.test(t);
  return need ? `"${t.replace(/"/g,'""')}"` : t;
}
function downloadTextFile(filename, text){
  const blob = new Blob([text], {type:"text/csv;charset=utf-8"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
  setTimeout(()=> URL.revokeObjectURL(url), 5000);
}

/* =========================
  ã“ã“ã‹ã‚‰å…ˆã¯ PART5 ã§ç¶šã
========================= */
/* =========================
  ONE ãƒ¬ã‚¸ã‚¢ãƒ—ãƒªï¼ˆç„¡æ–™ç‰ˆï¼‰å®Œæˆç‰ˆï¼šPART5
  å½¹å‰²ï¼šåº—èˆ—æƒ…å ±ï¼ãŠå•åˆã›ï¼ˆãƒ¡ãƒ¼ãƒ«ãƒ»LINEï¼‰ï¼è¨­å®šï¼ˆæœ€ä½é™ï¼‰
========================= */

/* ===== Shop State ===== */
function ensureShop(){
  state.shop = state.shop || {};
  state.shop.name = state.shop.name || "ONE";
  state.shop.contactEmail = state.shop.contactEmail || "";
  state.shop.contactLine  = state.shop.contactLine  || "";
  // ç„¡æ–™ç‰ˆï¼šé›»å­ãƒ¬ã‚·ãƒ¼ãƒˆã€Œé€ã‚‹ã€ã¯æœ‰æ–™æ¡ˆå†…ï¼ˆä»•æ§˜ï¼‰
  state.shop.receiptEnabled = false;
}

/* ===== Screens ===== */
(function buildShopScreens(){
  if($("scrShop")){
    $("scrShop").innerHTML = `
      <div style="display:flex; align-items:center; justify-content:space-between; gap:10px">
        <div style="font-weight:900; font-size:18px">åº—èˆ—æƒ…å ±</div>
        <button class="btn" id="shopToMain">ãƒ¡ã‚¤ãƒ³</button>
      </div>
      <div style="height:12px"></div>

      <div style="display:grid; gap:10px">
        <div>
          <div style="color:var(--muted); font-size:13px; margin-bottom:6px">åº—å</div>
          <input class="input" id="shopName" placeholder="ä¾‹ï¼šå±…é…’å±‹ONE" autocomplete="off">
        </div>

        <div class="pill" style="justify-content:space-between">
          <div style="color:var(--muted); font-size:12px">é›»å­ãƒ¬ã‚·ãƒ¼ãƒˆ</div>
          <div style="font-weight:900">ç„¡æ–™ç‰ˆï¼šé€ä¿¡ä¸å¯</div>
        </div>

        <button class="btn full" id="shopSave">ä¿å­˜</button>
      </div>

      <div style="height:12px"></div>
      <div style="color:var(--muted); font-size:13px">
        â€»é›»å­ãƒ¬ã‚·ãƒ¼ãƒˆã«ã¯ã€Œå¸­ç•ªå·ã€ã€Œäººæ•°ã€ã¯è¨˜è¼‰ã—ã¾ã›ã‚“ï¼ˆå†…éƒ¨ä¿æŒã®ã¿ï¼‰
      </div>
    `;
  }

  if($("scrContact")){
    $("scrContact").innerHTML = `
      <div style="display:flex; align-items:center; justify-content:space-between; gap:10px">
        <div style="font-weight:900; font-size:18px">ãŠå•åˆã›</div>
        <button class="btn" id="contactToMain">ãƒ¡ã‚¤ãƒ³</button>
      </div>
      <div style="height:12px"></div>

      <div style="display:grid; gap:10px">
        <div class="pill" style="justify-content:space-between">
          <div style="color:var(--muted); font-size:12px">ã‚¢ãƒ—ãƒªå†…ãŠå•åˆã›å…ˆ</div>
          <div style="font-weight:900">åº—èˆ—å´ãŒè¨­å®š</div>
        </div>

        <div>
          <div style="color:var(--muted); font-size:13px; margin-bottom:6px">ãƒ¡ãƒ¼ãƒ«</div>
          <input class="input" id="contactEmail" placeholder="ä¾‹ï¼šone@example.com" inputmode="email" autocomplete="off">
        </div>
        <div>
          <div style="color:var(--muted); font-size:13px; margin-bottom:6px">LINEï¼ˆä»»æ„ï¼‰</div>
          <input class="input" id="contactLine" placeholder="ä¾‹ï¼š@one_support" autocomplete="off">
        </div>

        <button class="btn full" id="contactSave">ä¿å­˜</button>
      </div>

      <div style="height:12px"></div>
      <div style="color:var(--muted); font-size:13px">
        â€»ã“ã®ç”»é¢ã¯ã€ŒãŠåº—ã®é‹ç”¨é€£çµ¡å…ˆã€ã‚’æ®‹ã™ç”¨é€”ï¼ˆé¡§å®¢æƒ…å ±ã¯æ‰±ã„ã¾ã›ã‚“ï¼‰
      </div>
    `;
  }

  if($("scrSettings")){
    $("scrSettings").innerHTML = `
      <div style="display:flex; align-items:center; justify-content:space-between; gap:10px">
        <div style="font-weight:900; font-size:18px">è¨­å®š</div>
        <button class="btn" id="settingsToMain">ãƒ¡ã‚¤ãƒ³</button>
      </div>
      <div style="height:12px"></div>

      <div style="display:grid; gap:10px">
        <button class="btn full" id="btnGoShop">åº—èˆ—æƒ…å ±</button>
        <button class="btn full" id="btnGoContact">ãŠå•åˆã›</button>
        <button class="btn full" id="btnGoSales">å£²ä¸Š</button>
      </div>

      <div style="height:12px"></div>
      <div style="color:var(--muted); font-size:13px">
        â€»ç„¡æ–™ç‰ˆï¼šè¨­å®šã¯æœ€ä½é™ã€‚ç¾å ´å°ç·šã‚’å„ªå…ˆã—ã¾ã™ã€‚
      </div>
    `;
  }

  // binds
  if($("shopToMain")) $("shopToMain").onclick = ()=> showScreen("scrMain");
  if($("contactToMain")) $("contactToMain").onclick = ()=> showScreen("scrMain");
  if($("settingsToMain")) $("settingsToMain").onclick = ()=> showScreen("scrMain");

  if($("btnGoShop")) $("btnGoShop").onclick = ()=> { showScreen("scrShop"); renderShop(); };
  if($("btnGoContact")) $("btnGoContact").onclick = ()=> { showScreen("scrContact"); renderContact(); };
  if($("btnGoSales")) $("btnGoSales").onclick = ()=> showScreen("scrSales");

  if($("shopSave")) $("shopSave").onclick = ()=> {
    ensureShop();
    state.shop.name = ($("shopName")?.value||"").trim() || "ONE";
    saveAll(true);
    toast("ä¿å­˜ã—ã¾ã—ãŸ");
  };

  if($("contactSave")) $("contactSave").onclick = ()=> {
    ensureShop();
    state.shop.contactEmail = ($("contactEmail")?.value||"").trim();
    state.shop.contactLine  = ($("contactLine")?.value||"").trim();
    saveAll(true);
    toast("ä¿å­˜ã—ã¾ã—ãŸ");
  };
})();

function renderShop(){
  ensureShop();
  if($("shopName")) $("shopName").value = state.shop.name || "ONE";
}

function renderContact(){
  ensureShop();
  if($("contactEmail")) $("contactEmail").value = state.shop.contactEmail || "";
  if($("contactLine"))  $("contactLine").value  = state.shop.contactLine  || "";
}

/* =========================
  ã“ã“ã‹ã‚‰å…ˆã¯ PART6 ã§ç¶šã
========================= */
/* =========================
  ONE ãƒ¬ã‚¸ã‚¢ãƒ—ãƒªï¼ˆç„¡æ–™ç‰ˆï¼‰å®Œæˆç‰ˆï¼šPART6
  å½¹å‰²ï¼šæ³¨æ–‡ç”»é¢ï¼ˆæœ€ä½é™ï¼‰ï¼‹è¦‹å‡ºã—ä¿®æ­£ï¼‹æˆ»ã‚‹æ–‡è¨€ä¿®æ­£
  â€»é‡è¤‡åˆ¤å®šã¯ã€Œå†™çœŸèª­ã¿å–ã‚Šãƒ¡ãƒ‹ãƒ¥ãƒ¼ç™»éŒ²ã€ã®ã¿ï¼ˆæ³¨æ–‡ã§ã¯ã‚„ã‚‰ãªã„ï¼‰
========================= */

/* ===== Menu State (æœ€å°) ===== */
function ensureMenu(){
  state.menu = state.menu || {};
  state.menu.items = Array.isArray(state.menu.items) ? state.menu.items : [];
  state.menu.genres = Array.isArray(state.menu.genres) ? state.menu.genres : ["æ–™ç†","ãƒ‰ãƒªãƒ³ã‚¯"];
}

/* ===== Order State ===== */
function ensureOrder(){
  state.order = state.order || {};
  state.order.seatId = state.order.seatId || null;
  state.order.genre = state.order.genre || null;
}

/* ===== Screen: Order ===== */
(function buildOrderScreen(){
  if(!$("scrOrder")) return;

  $("scrOrder").innerHTML = `
    <div style="display:flex; align-items:center; justify-content:space-between; gap:10px">
      <div style="font-weight:900; font-size:18px">æ³¨æ–‡</div>
      <button class="btn" id="orderToMain">ãƒ¡ã‚¤ãƒ³</button>
    </div>
    <div style="height:10px"></div>

    <div class="pill" style="justify-content:space-between">
      <div style="color:var(--muted); font-size:12px">å¸­</div>
      <div style="font-weight:900" id="orderSeatLabel">-</div>
    </div>

    <div style="height:10px"></div>
    <div id="orderGenres" style="display:flex; gap:8px; flex-wrap:wrap"></div>

    <div style="height:10px"></div>
    <div id="orderMenuList" style="display:grid; gap:10px"></div>

    <div style="height:12px"></div>
    <button class="btn full" id="orderBackToMain">ãƒ¡ã‚¤ãƒ³</button>
  `;

  $("orderToMain").onclick = ()=> showScreen("scrMain");
  $("orderBackToMain").onclick = ()=> showScreen("scrMain");
})();

function openOrderForSeat(seatId){
  const seat = seatById(seatId);
  if(!seat || seat.status!=="in"){ toast("ç€å¸­ä¸­ã®å¸­ã‚’é¸ã‚“ã§ãã ã•ã„"); return; }
  ensureOrder();
  state.order.seatId = seatId;
  showScreen("scrOrder");
  renderOrder();
}

function renderOrder(){
  ensureMenu(); ensureOrder();
  const seatId = state.order.seatId;
  if($("orderSeatLabel")) $("orderSeatLabel").textContent = seatId || "-";

  // genre tabs
  const gBox = $("orderGenres");
  if(gBox){
    gBox.innerHTML = "";
    state.menu.genres.forEach(g=>{
      const b = document.createElement("button");
      b.className = "btn";
      b.textContent = g;
      const on = (state.order.genre===g) || (!state.order.genre && g===state.menu.genres[0]);
      b.style.background = on ? "rgba(127,211,107,0.28)" : "rgba(255,255,255,0.06)";
      b.style.borderColor = on ? "rgba(127,211,107,0.55)" : "rgba(255,255,255,0.14)";
      b.style.fontWeight = on ? "900" : "700";
      b.onclick = ()=> { state.order.genre = g; saveAll(true); renderOrder(); };
      gBox.appendChild(b);
    });
  }
  if(!state.order.genre) state.order.genre = state.menu.genres[0];

  // menu list
  const list = $("orderMenuList");
  if(!list) return;

  const items = state.menu.items.filter(m=> (m.genre||"") === state.order.genre);
  list.innerHTML = "";
  if(!items.length){
    list.innerHTML = `<div style="color:var(--muted); padding:12px; border:1px dashed rgba(255,255,255,0.14); border-radius:14px">
      ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãŒã‚ã‚Šã¾ã›ã‚“ï¼ˆãƒ¡ãƒ‹ãƒ¥ãƒ¼ç™»éŒ²ã§è¿½åŠ ã—ã¦ãã ã•ã„ï¼‰
    </div>`;
    return;
  }

  items.forEach(m=>{
    const card = document.createElement("div");
    card.style.border = "1px solid rgba(255,255,255,0.10)";
    card.style.borderRadius = "14px";
    card.style.background = "rgba(255,255,255,0.04)";
    card.style.padding = "12px";
    card.style.display = "grid";
    card.style.gap = "8px";

    const price = Number(m.price||0);
    card.innerHTML = `
      <div style="display:flex; align-items:center; justify-content:space-between; gap:10px">
        <div style="min-width:0">
          <div style="font-weight:900; white-space:nowrap; overflow:hidden; text-overflow:ellipsis">${esc(m.name||"")}</div>
          <div style="color:var(--muted); font-size:12px">${esc(m.genre||"")}</div>
        </div>
        <div style="font-weight:900">${yen(price)}</div>
      </div>
      <div style="display:flex; gap:10px">
        <button class="btn full" data-add="1">ï¼‹1</button>
        <button class="btn full" data-add="2">ï¼‹2</button>
        <button class="btn full" data-add="3">ï¼‹3</button>
      </div>
    `;

    card.querySelectorAll("button[data-add]").forEach(b=>{
      b.onclick = ()=>{
        const q = Number(b.getAttribute("data-add")||1);
        addOrderLine(state.order.seatId, m, q);
      };
    });

    list.appendChild(card);
  });
}

function addOrderLine(seatId, menuItem, qty){
  const seat = seatById(seatId);
  if(!seat) return;
  seat.orders = Array.isArray(seat.orders) ? seat.orders : [];
  const line = {
    id: genId("od"),
    ts: nowTs(),
    menuId: menuItem.id || "",
    name: menuItem.name || "",
    genre: menuItem.genre || "",
    price: Number(menuItem.price||0),
    tax: Number(menuItem.tax||10),
    qty: Number(qty||1),
    done: false
  };
  seat.orders.push(line);

  // seat total cacheï¼ˆè¡¨ç¤ºç”¨ï¼‰
  seat.total = Number(calcSeatTotal(seat)||0);

  // kitchenã¸ã‚‚æŠ•å…¥ï¼ˆè¦‹ãŸç›®ã ã‘ã§ã‚‚å‹•ãï¼‰
  ensureKitchen();
  state.kitchen.items.push({
    id: genId("k"),
    ts: nowTs(),
    seatId,
    name: line.name,
    qty: line.qty,
    type: (line.genre==="ãƒ‰ãƒªãƒ³ã‚¯" ? "drink" : "food"),
    done: false
  });

  saveAll(true);
  renderSeats();
  toast("æ³¨æ–‡ã‚’è¿½åŠ ");
}

/* =========================
  ã“ã“ã‹ã‚‰å…ˆã¯ PART7 ã§ç¶šã
========================= */
/* =========================
  ONE ãƒ¬ã‚¸ã‚¢ãƒ—ãƒªï¼ˆç„¡æ–™ç‰ˆï¼‰å®Œæˆç‰ˆï¼šPART7
  å½¹å‰²ï¼šãƒ¡ãƒ‹ãƒ¥ãƒ¼ç™»éŒ²ï¼ˆæ‰‹å…¥åŠ›ã®æœ€ä½é™ï¼‰ï¼‹å†™çœŸèª­ã¿å–ã‚Šå°ç·šï¼ˆã‚«ãƒ¡ãƒ©ãƒãƒ¼ã‚¯ï¼šå®Ÿè£…ã¯å°†æ¥AIé€£æºï¼‰
  â€»å†™çœŸèª­ã¿å–ã‚Šã®ä»•æ§˜ã¯ã€Œäººã®ç¢ºèªå¿…é ˆã€ã€Œ1ä»¶ãšã¤ç™»éŒ²ã€ã€Œä¾¡æ ¼ãªã—ã¯ç™»éŒ²ä¸å¯ã€
========================= */

/* ===== Screen: Menu Register ===== */
(function buildMenuRegScreen(){
  if(!$("scrMenuReg")) return;

  $("scrMenuReg").innerHTML = `
    <div style="display:flex; align-items:center; justify-content:space-between; gap:10px">
      <div style="font-weight:900; font-size:18px">ãƒ¡ãƒ‹ãƒ¥ãƒ¼ç™»éŒ²</div>
      <button class="btn" id="menuRegToMain">ãƒ¡ã‚¤ãƒ³</button>
    </div>

    <div style="height:10px"></div>

    <div style="display:flex; align-items:center; justify-content:space-between; gap:10px">
      <div style="color:var(--muted); font-size:13px">æ‰‹å…¥åŠ›ï¼ˆæœ€ä½é™ï¼‰</div>
      <button class="btn" id="menuCameraBtn">ğŸ“·</button>
    </div>

    <div style="height:10px"></div>

    <div style="display:grid; gap:10px">
      <div>
        <div style="color:var(--muted); font-size:13px; margin-bottom:6px">ã‚¸ãƒ£ãƒ³ãƒ«</div>
        <select class="btn full" id="mGenre" style="text-align:left"></select>
      </div>
      <div>
        <div style="color:var(--muted); font-size:13px; margin-bottom:6px">å•†å“å</div>
        <input class="input" id="mName" placeholder="ä¾‹ï¼šç”Ÿãƒ“ãƒ¼ãƒ«" autocomplete="off">
      </div>
      <div>
        <div style="color:var(--muted); font-size:13px; margin-bottom:6px">ä¾¡æ ¼ï¼ˆå††ï¼‰</div>
        <input class="input" id="mPrice" placeholder="ä¾‹ï¼š700" inputmode="numeric" autocomplete="off">
      </div>
      <div>
        <div style="color:var(--muted); font-size:13px; margin-bottom:6px">ç¨ç‡</div>
        <div style="display:flex; gap:10px">
          <button class="btn full" id="tax8">8%</button>
          <button class="btn full" id="tax10">10%</button>
        </div>
      </div>

      <button class="btn full" id="mAdd">è¿½åŠ </button>
    </div>

    <div style="height:12px"></div>
    <div style="color:var(--muted); font-size:13px; margin:8px 0 6px">ç™»éŒ²æ¸ˆã¿</div>
    <div id="mList" style="display:grid; gap:10px"></div>
  `;

  $("menuRegToMain").onclick = ()=> showScreen("scrMain");

  $("menuCameraBtn").onclick = ()=>{
    // ä»•æ§˜ï¼šã‚«ãƒ¡ãƒ©ãƒãƒ¼ã‚¯â†’å†™çœŸâ†’AIæŠ½å‡ºâ†’1ä»¶ãšã¤ç¢ºèªã—ã¦ç™»éŒ²
    // ç„¡æ–™ç‰ˆHTMLå˜ä½“ã§ã¯AI/OCRã‚’æŒã¦ãªã„ã®ã§ã€å°ç·šã ã‘å›ºå®š
    openModal(
      "å†™çœŸèª­ã¿å–ã‚Šï¼ˆå°†æ¥AIé€£æºï¼‰",
      `
        <div style="color:rgba(255,255,255,0.9); font-weight:900; margin-bottom:6px">ä»•æ§˜ã¯ç¢ºå®šæ¸ˆã¿</div>
        <div style="color:var(--muted); font-size:13px; line-height:1.6">
          ãƒ»å†™çœŸã‹ã‚‰ã€Œã‚¸ãƒ£ãƒ³ãƒ«/å•†å“å/ä¾¡æ ¼/ç¨ç‡ã€ã‚’æŠ½å‡º<br>
          ãƒ»è¤‡æ•°ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã¯1ä»¶ãšã¤ä¸€è¦§è¡¨ç¤º<br>
          ãƒ»ä¾¡æ ¼ãªã—ã¯èµ¤æ–‡å­—ã§ç™»éŒ²ä¸å¯ï¼ˆä¿®æ­£å¿…é ˆï¼‰<br>
          ãƒ»é‡è¤‡ã¯ã€Œå¯èƒ½æ€§æœ‰ã€ã¨è¡¨ç¤ºï¼ˆæ–­å®šã—ãªã„ï¼‰<br>
          ãƒ»å¿…ãšäººã®ç¢ºèªã‚’é€šã™ï¼ä¸€æ‹¬ç™»éŒ²ãªã—<br>
        </div>
      `,
      [{label:"OK", lime:true, onClick:()=> closeModal()}]
    );
  };

  // bind tax
  let tax = 10;
  const paintTax = ()=>{
    const on8 = (tax===8);
    $("tax8").style.background = on8 ? "rgba(127,211,107,0.28)" : "rgba(255,255,255,0.06)";
    $("tax8").style.borderColor= on8 ? "rgba(127,211,107,0.55)" : "rgba(255,255,255,0.14)";
    $("tax8").style.fontWeight = on8 ? "900":"700";

    const on10 = (tax===10);
    $("tax10").style.background = on10 ? "rgba(127,211,107,0.28)" : "rgba(255,255,255,0.06)";
    $("tax10").style.borderColor= on10 ? "rgba(127,211,107,0.55)" : "rgba(255,255,255,0.14)";
    $("tax10").style.fontWeight = on10 ? "900":"700";
  };
  $("tax8").onclick = ()=> { tax=8; paintTax(); };
  $("tax10").onclick= ()=> { tax=10; paintTax(); };
  paintTax();

  $("mAdd").onclick = ()=>{
    ensureMenu();
    const genre = $("mGenre").value;
    const name = ($("mName").value||"").trim();
    const price = Number(($("mPrice").value||"").replace(/[^\d]/g,"")||0);

    if(!name){ toast("å•†å“åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"); return; }
    if(!price){ toast("ä¾¡æ ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"); return; }

    state.menu.items.push({
      id: genId("m"),
      genre,
      name,
      price,
      tax
    });

    $("mName").value = "";
    $("mPrice").value = "";
    saveAll(true);
    renderMenuReg();
    toast("ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’è¿½åŠ ");
  };
})();

function renderMenuReg(){
  ensureMenu();
  const sel = $("mGenre");
  if(sel){
    sel.innerHTML = state.menu.genres.map(g=> `<option value="${esc(g)}">${esc(g)}</option>`).join("");
  }

  const list = $("mList");
  if(!list) return;

  const items = state.menu.items.slice();
  list.innerHTML = "";
  if(!items.length){
    list.innerHTML = `<div style="color:var(--muted); padding:12px; border:1px dashed rgba(255,255,255,0.14); border-radius:14px">
      ã¾ã ã‚ã‚Šã¾ã›ã‚“
    </div>`;
    return;
  }

  items.forEach(m=>{
    const card = document.createElement("div");
    card.style.border = "1px solid rgba(255,255,255,0.10)";
    card.style.borderRadius = "14px";
    card.style.background = "rgba(255,255,255,0.04)";
    card.style.padding = "12px";
    card.style.display = "flex";
    card.style.alignItems = "center";
    card.style.justifyContent = "space-between";
    card.style.gap = "10px";
    card.innerHTML = `
      <div style="min-width:0">
        <div style="font-weight:900; white-space:nowrap; overflow:hidden; text-overflow:ellipsis">${esc(m.genre||"")}ï½œ${esc(m.name||"")}</div>
        <div style="color:var(--muted); font-size:12px">${yen(Number(m.price||0))} / ${Number(m.tax||10)}%</div>
      </div>
      <button class="btn" data-del="${m.id}" style="min-width:92px">å‰Šé™¤</button>
    `;
    const b = card.querySelector("button[data-del]");
    b.onclick = ()=>{
      state.menu.items = state.menu.items.filter(x=> x.id!==m.id);
      saveAll(true);
      renderMenuReg();
      toast("å‰Šé™¤ã—ã¾ã—ãŸ");
    };
    list.appendChild(card);
  });
}

/* =========================
  ã“ã“ã‹ã‚‰å…ˆã¯ PART8 ã§ç¶šã
========================= */
/* =========================
  ONE ãƒ¬ã‚¸ã‚¢ãƒ—ãƒªï¼ˆç„¡æ–™ç‰ˆï¼‰å®Œæˆç‰ˆï¼šPART8
  å½¹å‰²ï¼šãƒ¡ã‚¤ãƒ³å°ç·šã®æ¥ç¶šï¼ˆãƒœã‚¿ãƒ³â†’å„ç”»é¢ï¼‰ï¼‹è¡¨ç¤ºã‚¿ã‚¤ãƒŸãƒ³ã‚°ã®ãƒ¬ãƒ³ãƒ€çµ±ä¸€
========================= */

/* ===== Main button bindsï¼ˆå­˜åœ¨ã™ã‚‹IDã ã‘å®‰å…¨ã«çµã¶ï¼‰ ===== */
(function bindMainNav(){
  // ãƒ¡ã‚¤ãƒ³å´ã«ã€ã™ã§ã«ãƒœã‚¿ãƒ³ãŒã‚ã‚‹å‰æï¼ˆPART1ã§é…ç½®æ¸ˆã¿ï¼‰
  // ä¾‹ï¼šgoOrder / goMenuReg / goKitchen / goSales / goSettings ãªã©
  safeOn("goKitchen", ()=> showScreen("scrKitchen"));
  safeOn("goSales",   ()=> showScreen("scrSales"));
  safeOn("goSettings",()=> showScreen("scrSettings"));
  safeOn("goShop",    ()=> { showScreen("scrShop"); renderShop(); });
  safeOn("goContact", ()=> { showScreen("scrContact"); renderContact(); });
  safeOn("goMenuReg", ()=> { showScreen("scrMenuReg"); renderMenuReg(); });

  // â€œæ³¨æ–‡â€ã¯ï¼šã¾ãšå¸­ã‚’é¸ã‚“ã§ã‹ã‚‰å…¥ã‚‹ï¼ˆãƒŸã‚¹é˜²æ­¢ï¼‰
  safeOn("goOrder", ()=> {
    openModal(
      "æ³¨æ–‡",
      `<div style="color:var(--muted); font-size:13px; line-height:1.6">
        å…ˆã«ã€Œç€å¸­ä¸­ã®å¸­ã€ã‚’ã‚¿ãƒƒãƒ—ã—ã¦ã‹ã‚‰å…¥ã‚Šã¾ã™ã€‚<br>
        ï¼ˆèª¤å…¥åŠ›é˜²æ­¢ï¼‰
      </div>`,
      [{label:"OK", lime:true, onClick:()=> closeModal()}]
    );
  });
})();

function safeOn(id, fn){
  const el = document.getElementById(id);
  if(el) el.onclick = fn;
}

/* ===== Seat card long-press / tap already handled in PART1/PART2
   - ç€å¸­ä¸­å¸­ã‚’ã‚¿ãƒƒãƒ— â†’ ãƒ¢ãƒ¼ãƒ€ãƒ« â†’ ã€Œæ³¨æ–‡ã€ãƒœã‚¿ãƒ³ã‚’è¿½åŠ ï¼ˆã“ã“ã§å·®ã—è¾¼ã¿ï¼‰
*/
(function patchInSeatModalToOrder(){
  const _onSeatTap = onSeatTap;
  onSeatTap = function(seatId){
    const seat = seatById(seatId);
    if(seat && seat.status==="in"){
      openModal(
        "ç€å¸­ä¸­",
        `<div style="font-weight:900; font-size:16px; margin-bottom:6px">${seatId}</div>
         <div style="margin-bottom:10px">åˆè¨ˆï¼š<span style="font-weight:900">${yen(calcSeatTotal(seat))}</span></div>`,
        [
          {label:"æ³¨æ–‡", lime:true, onClick:()=> { closeModal(); openOrderForSeat(seatId); }},
          {label:"ä¼šè¨ˆ", onClick:()=> openCheckout(seatId)},
          {label:"ã‚­ãƒƒãƒãƒ³", onClick:()=> { closeModal(); showScreen("scrKitchen"); }},
        ],
        seatId
      );
      return;
    }
    _onSeatTap(seatId);
  };
})();

/* ===== Screen render hooks ===== */
(function patchShowScreenRender(){
  const _show = showScreen;
  showScreen = function(id){
    _show(id);
    if(id==="scrKitchen") renderKitchen();
    if(id==="scrTodaySales") renderTodaySales();
    if(id==="scrSalesManage") renderSalesManage();
    if(id==="scrMonth") renderMonthSales();
    if(id==="scrYear") renderYearSales();
    if(id==="scrShop") renderShop();
    if(id==="scrContact") renderContact();
    if(id==="scrMenuReg") renderMenuReg();
    if(id==="scrOrder") renderOrder();
  };
})();

/* ===== Boot ensure states ===== */
(function ensureAllOnBoot(){
  ensureShop();
  ensureMenu();
  ensureKitchen();
  ensureSales();
  ensureOrder();
})();

/* =========================
  å®Œæˆï¼šPART1ã€œPART8 ã‚’è²¼ã‚Šæ›¿ãˆã‚Œã°å‹•ä½œã—ã¾ã™
========================= */